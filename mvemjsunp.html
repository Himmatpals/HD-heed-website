<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrushOn Clone - NSFW AI Chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #000; color: #fff; overflow-x: hidden; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 20px; background: linear-gradient(135deg, #1a1a1a, #2d1b69); }
        header h1 { font-size: 2.5em; color: #ff69b4; }
        nav { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
        nav button { background: #ff1493; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; transition: background 0.3s; }
        nav button:hover { background: #ff69b4; }
        nav .active { background: #2d1b69; }
        section { display: none; }
        section.active { display: block; }
        /* Character Creation */
        .create-form { display: grid; gap: 15px; max-width: 600px; margin: 0 auto; }
        .create-form input, .create-form textarea, .create-form select { background: #333; color: #fff; border: 1px solid #555; padding: 10px; border-radius: 5px; }
        .create-form textarea { height: 100px; resize: vertical; }
        .avatar-preview { width: 200px; height: 200px; border-radius: 50%; object-fit: cover; border: 2px solid #ff1493; margin: 10px auto; display: block; }
        .create-btn { background: #ff1493; color: white; border: none; padding: 15px; border-radius: 25px; font-size: 1.2em; cursor: pointer; }
        /* Gallery */
        .gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .char-card { background: #1a1a1a; border-radius: 10px; padding: 15px; text-align: center; border: 1px solid #555; transition: transform 0.3s; }
        .char-card:hover { transform: scale(1.05); border-color: #ff1493; }
        .char-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; }
        .chat-btn { background: #ff1493; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; margin-top: 10px; }
        /* Chat Room */
        .chat-room { display: flex; height: 80vh; }
        .sidebar { width: 250px; background: #1a1a1a; padding: 20px; border-right: 1px solid #555; }
        .char-info img { width: 150px; height: 150px; border-radius: 50%; display: block; margin: 0 auto 10px; }
        .char-greeting { font-style: italic; color: #ccc; }
        .chat-messages { flex: 1; background: #000; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 70%; padding: 10px 15px; border-radius: 20px; word-wrap: break-word; }
        .ai-message { background: #2d1b69; align-self: flex-start; }
        .user-message { background: #ff1493; align-self: flex-end; }
        .voice-btn { background: none; border: none; color: #fff; cursor: pointer; margin-left: 5px; font-size: 1.2em; }
        .typing { background: #333; align-self: flex-start; padding: 10px; border-radius: 20px; color: #ccc; }
        .input-bar { display: flex; padding: 20px; background: #1a1a1a; gap: 10px; }
        .input-bar input { flex: 1; background: #333; color: #fff; border: 1px solid #555; padding: 10px; border-radius: 25px; }
        .send-btn, .mic-btn { background: #ff1493; color: white; border: none; padding: 10px 15px; border-radius: 50%; cursor: pointer; }
        .back-btn { position: absolute; top: 20px; left: 20px; background: #555; color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body>
    <header>
        <h1>CrushOn Clone</h1>
        <nav>
            <button onclick="showSection('gallery')" class="active">Gallery</button>
            <button onclick="showSection('create')">Create Character</button>
        </nav>
    </header>
    <div class="container">
        <!-- Gallery Section -->
        <section id="gallery" class="active">
            <h2>Your Characters</h2>
            <div id="charGallery" class="gallery"></div>
            <button onclick="showSection('create')" class="create-btn">+ New Character</button>
        </section>

        <!-- Create Section -->
        <section id="create">
            <h2>Create New Character</h2>
            <form class="create-form" onsubmit="saveCharacter(event)">
                <input type="text" id="charName" placeholder="Character Name" required>
                <input type="file" id="charAvatar" accept="image/*" onchange="previewAvatar(event)">
                <img id="avatarPreview" class="avatar-preview" src="" alt="Preview" style="display:none;">
                <textarea id="charDesc" placeholder="Description (e.g., appearance, background)" required></textarea>
                <textarea id="charPersonality" placeholder="Personality (e.g., flirty, dominant, traits separated by commas)" required></textarea>
                <textarea id="charGreeting" placeholder="Greeting Message" required></textarea>
                <textarea id="charScenario" placeholder="Scenario (e.g., initial setting for chat)" rows="3"></textarea>
                <button type="submit" class="create-btn">Create & Save</button>
            </form>
            <button onclick="showSection('gallery')" class="create-btn">Back to Gallery</button>
        </section>

        <!-- Chat Section (Hidden until selected) -->
        <section id="chat" style="position: relative;">
            <button class="back-btn" onclick="showSection('gallery')">‚Üê</button>
            <div class="chat-room">
                <div class="sidebar">
                    <img id="chatAvatar" src="" alt="Character" style="width:150px;height:150px;border-radius:50%;object-fit:cover;">
                    <h3 id="chatName"></h3>
                    <p id="chatGreeting" class="char-greeting"></p>
                    <p id="chatScenario"></p>
                </div>
                <div id="chatMessages" class="chat-messages"></div>
            </div>
            <div class="input-bar">
                <button class="mic-btn" onclick="startListening()" title="Voice Input">üé§</button>
                <input type="text" id="userInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="send-btn" onclick="sendMessage()">Send</button>
            </div>
        </section>
    </div>

    <script>
        let currentCharacter = null;
        let conversationHistory = [];
        let characterMemory = [];

        // Sections Toggle
        function showSection(sectionId) {
            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            if (sectionId === 'gallery') loadGallery();
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Avatar Preview
        function previewAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => document.getElementById('avatarPreview').src = e.target.result;
                reader.readAsDataURL(file);
                document.getElementById('avatarPreview').style.display = 'block';
            }
        }

        // Save Character
        function saveCharacter(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const avatarFile = document.getElementById('charAvatar').files[0];
            let avatarUrl = document.getElementById('avatarPreview').src || 'https://via.placeholder.com/200?text=Avatar';

            if (avatarFile) avatarUrl = URL.createObjectURL(avatarFile);

            const character = {
                id: Date.now(),
                name: document.getElementById('charName').value,
                avatar: avatarUrl,
                desc: document.getElementById('charDesc').value,
                personality: document.getElementById('charPersonality').value.split(',').map(t => t.trim()),
                greeting: document.getElementById('charGreeting').value,
                scenario: document.getElementById('charScenario').value,
                memory: []
            };

            let characters = JSON.parse(localStorage.getItem('characters') || '[]');
            characters.push(character);
            localStorage.setItem('characters', JSON.stringify(characters));
            alert('Character created!');
            showSection('gallery');
        }

        // Load Gallery
        function loadGallery() {
            const gallery = document.getElementById('charGallery');
            let characters = JSON.parse(localStorage.getItem('characters') || '[]');
            gallery.innerHTML = characters.map(char => `
                <div class="char-card">
                    <img src="${char.avatar}" class="char-avatar" alt="${char.name}">
                    <h3>${char.name}</h3>
                    <p>${char.desc.substring(0, 100)}...</p>
                    <button class="chat-btn" onclick="startChat(${char.id})">Chat</button>
                </div>
            `).join('');
        }

        // Start Chat
        function startChat(id) {
            let characters = JSON.parse(localStorage.getItem('characters') || '[]');
            currentCharacter = characters.find(c => c.id === id);
            if (!currentCharacter) return;

            document.getElementById('chatName').textContent = currentCharacter.name;
            document.getElementById('chatAvatar').src = currentCharacter.avatar;
            document.getElementById('chatGreeting').textContent = currentCharacter.greeting;
            document.getElementById('chatScenario').textContent = currentCharacter.scenario || '';

            conversationHistory = [{ role: 'system', content: buildSystemPrompt() }];
            characterMemory = currentCharacter.memory || [];
            document.getElementById('chatMessages').innerHTML = `<div class="message ai-message"><span onclick="speak('${currentCharacter.greeting}')">${currentCharacter.greeting} <button class="voice-btn">üîä</button></span></div>`;
            showSection('chat');
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        // Build System Prompt (Incorporates evolution)
        function buildSystemPrompt() {
            const personalityStr = currentCharacter.personality.join(', ');
            const memoryStr = characterMemory.length > 0 ? `Evolved traits from chat: ${characterMemory.join(', ')}.` : '';
            return `You are ${currentCharacter.name}, a ${currentCharacter.desc}. Base personality: ${personalityStr}. ${memoryStr} Scenario: ${currentCharacter.scenario || 'Casual chat.'}. Assume this role fully, adapt subtly based on user cues, but stay true to your core description. Respond in character.`;
        }

        // Detect Cues for Evolution
        function detectCues(message) {
            const cues = [];
            if (/be more dominant/i.test(message)) cues.push('more dominant');
            if (/be nicer/i.test(message)) cues.push('nicer');
            if (/tell me your secret/i.test(message)) cues.push('revealing secrets');
            if (/i like (.*)/i.test(message)) {
                const match = /i like (.*)/i.exec(message);
                if (match) cues.push(`user likes ${match[1]}`);
            }
            // Add more NSFW-specific cues as needed (e.g., /be kinkier/i)
            return cues;
        }

        // Update Character Evolution
        function updateEvolution(cues) {
            if (cues.length > 0) {
                characterMemory.push(...cues);
                if (characterMemory.length > 5) characterMemory.shift();
                let characters = JSON.parse(localStorage.getItem('characters') || '[]');
                const index = characters.findIndex(c => c.id === currentCharacter.id);
                if (index !== -1) {
                    characters[index].memory = characterMemory;
                    characters[index].personality = [...new Set([...currentCharacter.personality, ...cues])];
                    localStorage.setItem('characters', JSON.stringify(characters));
                    currentCharacter = characters[index];
                }
            }
        }

        // Send Message
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message || !currentCharacter) return;

            const cues = detectCues(message);
            updateEvolution(cues);

            addMessage('user', message);
            input.value = '';

            addMessage('ai', '<div class="typing">Typing...</div>');

            try {
                conversationHistory[0].content = buildSystemPrompt();
                const response = await fetchAIResponse(message);
                document.querySelector('.typing').remove();
                addMessage('ai', response);
                speak(response);
            } catch (error) {
                document.querySelector('.typing').remove();
                addMessage('ai', 'Sorry, something went wrong. Try again.');
                console.error(error);
            }
        }

        // Add Message to Chat
        function addMessage(sender, content) {
            const messages = document.getElementById('chatMessages');
            const isAI = sender === 'ai';
            const div = document.createElement('div');
            div.className = `message ${isAI ? 'ai-message' : 'user-message'}`;
            if (isAI && typeof content === 'string') {
                div.innerHTML = `<span onclick="speak('${content.replace(/'/g, "\\'")}')">${content} <button class="voice-btn">üîä</button></span>`;
            } else {
                div.innerHTML = content;
            }
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;

            if (sender === 'user') {
                conversationHistory.push({ role: 'user', content: message });
            } else if (sender === 'ai' && typeof content === 'string') {
                conversationHistory.push({ role: 'assistant', content: content });
            }
        }

        // Proxy API Call (Token hidden server-side)
        async function fetchAIResponse(message) {
            const response = await fetch('http://localhost:3000/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: conversationHistory.map(h => `${h.role}: ${h.content}`).join('\n') + '\nassistant:' })
            });
            if (!response.ok) throw new Error('Proxy error');
            const data = await response.json();
            return data.generated_text || 'No response from AI.';
        }

        // Voice Functions
        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.1; // Adjustable per character
            window.speechSynthesis.speak(utterance);
        }

        let recognition;
        function startListening() {
            if (!('webkitSpeechRecognition' in window)) return alert('Speech recognition not supported');
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.onresult = e => {
                document.getElementById('userInput').value = e.results[0][0].transcript;
                sendMessage();
            };
            recognition.start();
        }

        // Init
        loadGallery();
    </script>
</body>
</html>
