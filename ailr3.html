<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AILR ‚Äî Advanced Intake & Long-form Registration | HD HeeD</title>
<meta name="theme-color" content="#0b0f1a" />

<style>
  /* ===========================
     THEME ‚Äî offline, no deps
     =========================== */
  :root{
    --al-ink:#0a0e1f; --al-bg:#0b0f1a; --al-panel:#121a32; --al-line:#2a3a5e;
    --al-text:#f0f4ff; --al-a1:#4f46e5; --al-a2:#ec4899; --al-a3:#06b6d4; --al-a4:#3b82f6;
    --al-ok:#10b981; --al-warn:#fbbf24; --al-danger:#ef4444;
    --glow: 0 0 24px rgba(236,72,153,.35);
    --mx: 50%; --my: 50%; /* mouse position (for parallax glow) */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--al-text);
    background:
      radial-gradient(1200px 600px at 15% -10%, rgba(79,70,229,.20), transparent 60%),
      radial-gradient(1200px 600px at 85% -10%, rgba(236,72,153,.20), transparent 60%),
      linear-gradient(180deg, #0b0f1a 0%, #141a36 50%, #1c1330 100%);
    overflow-x:hidden;
  }
  a{color:#9ec1ff; text-decoration:none} a:hover{color:#d4d4ff}

  .glass{
    background:
      radial-gradient(600px 300px at var(--mx) var(--my), rgba(236,72,153,.10), transparent 35%),
      linear-gradient(180deg, rgba(18,26,50,.78), rgba(12,19,38,.78));
    border:1px solid rgba(155,179,255,.16);
    backdrop-filter: blur(12px);
  }
  .card-shadow{ box-shadow: 0 24px 60px rgba(0,0,0,.55), inset 0 0 16px rgba(255,255,255,.04); }

  /* ===========================
     HEADER
     =========================== */
  header{
    position:sticky; top:0; z-index:50;
    background: linear-gradient(135deg, #0a0e1f, #1a1f3a);
    border-bottom:1px solid var(--al-line);
    box-shadow: 0 8px 24px rgba(0,0,0,.45);
  }
  header .bar{
    display:flex; align-items:center; gap:12px; padding:12px 16px;
    max-width:1180px; margin:0 auto;
  }
  .brand{display:flex; align-items:center; gap:12px}
  .brand .name{font-weight:900; letter-spacing:.2px}
  .brand .tag{font-size:12px; color:#b6c8ff}
  .badge-hint{ margin-left:auto; font-size:12px; color:#9fb4ff; opacity:.95 }

  /* ===========================
     HERO
     =========================== */
  .hero{ max-width:1180px; margin:16px auto 0; padding:16px; }
  .hero .card{ border-radius:24px; padding:24px; animation: fadeIn .6s ease both; }
  .hero h1{
    margin:0; font-size:clamp(24px,4.8vw,36px); font-weight:900;
    background: linear-gradient(135deg, var(--al-a1), var(--al-a2));
    -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
  }
  .hero p{ margin:6px 0 0; color:#cfe0ff; opacity:.95; line-height:1.6 }
  .meta{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  .pill{
    border:1px solid var(--al-line);
    background: linear-gradient(135deg, #0f1937, #1a2345);
    border-radius:999px; padding:8px 12px; color:#cfe0ff; font-size:13px;
    box-shadow: 0 2px 10px rgba(0,0,0,.35);
  }
  .notice{font-size:14px; color:#99adff; font-style:italic; margin-top:6px}

  /* ===========================
     LAYOUT
     =========================== */
  .wrap{
    max-width:1180px; margin:14px auto 28px; padding:0 16px; display:grid; gap:16px;
    grid-template-columns: 1fr;
  }
  @media (min-width:980px){ .wrap{ grid-template-columns: 300px 1fr; } }

  /* Sidebar Nav */
  .nav{
    position:sticky; top:96px; align-self:start; display:none;
    border-radius:20px; padding:16px; max-height:calc(100vh - 130px); overflow:auto;
    animation: floatIn .5s ease both .1s;
  }
  @media (min-width:980px){ .nav{ display:block } }
  .nav h3{
    margin:0 0 12px; font-size:18px; font-weight:800;
    background: linear-gradient(135deg, var(--al-a1), var(--al-a2));
    -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
  }
  .nav-list{ list-style:none; margin:0; padding:0; display:grid; gap:8px }
  .nav-item{
    padding:10px 12px; border-radius:12px; cursor:pointer; font-size:14px; color:#cfe0ff;
    border:1px solid transparent; position:relative;
    transition: transform .2s ease, box-shadow .2s ease, background .3s ease;
  }
  .nav-item:hover{ background:linear-gradient(135deg,#121a3a,#1a2345); border-color:var(--al-line); }
  .nav-item.completed{ color:var(--al-ok); border-left:3px solid var(--al-ok); }
  .nav-item.current{
    background: linear-gradient(135deg, var(--al-a1), var(--al-a2));
    color:#fff; box-shadow: var(--glow);
  }
  .nav-item.locked{ opacity:.6; cursor:not-allowed; filter:grayscale(.3); }
  .nav-item .lock{ position:absolute; right:10px; top:10px; font-size:12px; opacity:.9; }

  /* Stage */
  .stage{
    border-radius:24px; padding:20px; position:relative; overflow:hidden;
    animation: fadeIn .5s ease both;
  }
  .stage.card-shadow{ border:1px solid rgba(155,179,255,.16) }

  /* Slide transitions */
  .stage-inner{ position:relative; }
  .slide-out-left{ animation: slideOutLeft .24s ease forwards; }
  .slide-out-right{ animation: slideOutRight .24s ease forwards; }
  .slide-in-left{ animation: slideInLeft .34s ease forwards; }
  .slide-in-right{ animation: slideInRight .34s ease forwards; }

  @keyframes slideOutLeft{ from{opacity:1; transform:translateX(0)} to{opacity:.2; transform:translateX(-28px)} }
  @keyframes slideOutRight{ from{opacity:1; transform:translateX(0)} to{opacity:.2; transform:translateX(28px)} }
  @keyframes slideInLeft{ from{opacity:.2; transform:translateX(-28px)} to{opacity:1; transform:translateX(0)} }
  @keyframes slideInRight{ from{opacity:.2; transform:translateX(28px)} to{opacity:1; transform:translateX(0)} }

  .head{ display:flex; align-items:center; gap:12px; margin-bottom:8px }
  .head .step{
    font-weight:900;
    background: linear-gradient(135deg,var(--al-a3),var(--al-a4));
    -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
  }
  .meter{
    height:10px; flex:1; border-radius:999px; overflow:hidden; border:1px solid var(--al-line);
    background: linear-gradient(90deg, #101838, #1a2345);
    box-shadow: inset 0 1px 2px rgba(0,0,0,.5);
  }
  .meter>div{
    height:100%; width:0%;
    background: linear-gradient(135deg, var(--al-a1), var(--al-a2));
    box-shadow: var(--glow);
    transition: width .5s ease;
  }

  .q{
    font-size:clamp(20px,4vw,24px); font-weight:900; line-height:1.35; margin:12px 0;
    background: linear-gradient(135deg, var(--al-a3), var(--al-a4));
    -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
  }
  .sub{ font-size:15px; color:#cfe0ff; margin:0 0 8px; line-height:1.6 }
  .sub .consent-box{
    border:1px dashed var(--al-line);
    background: linear-gradient(135deg, #0e162e, #1a223f);
    border-radius:12px; padding:12px; margin-top:10px; box-shadow: 0 8px 20px rgba(0,0,0,.35);
  }
  .sub ul{ margin:10px 0 0 20px; list-style:disc; color:#d1e7ff }

  .opts{ display:grid; gap:12px }
  .inlinebox{
    border:1px solid var(--al-line);
    background:
      radial-gradient(300px 180px at var(--mx) var(--my), rgba(79,70,229,.10), transparent 40%),
      linear-gradient(135deg, #0e162e, #1a223f);
    border-radius:16px; padding:14px; display:grid; gap:12px;
    box-shadow: 0 8px 24px rgba(0,0,0,.32);
    animation: floatIn .45s ease both;
  }
  .inlinebox input,.inlinebox select,.inlinebox textarea{
    width:100%; padding:14px; border-radius:12px; border:1px solid #2a3b68;
    background: linear-gradient(135deg, #0f1b3b, #1a2748); color:#e7ebff; font-size:16px;
    box-shadow: inset 0 2px 4px rgba(0,0,0,.4);
    transition:border-color .25s ease, box-shadow .25s ease, transform .06s ease;
  }
  .inlinebox input:focus,.inlinebox select:focus,.inlinebox textarea:focus{
    border-color: #ec4899; box-shadow: 0 0 0 4px rgba(236,72,153,.15);
    outline:none; transform: translateY(-1px);
  }
  .row{ display:grid; gap:12px }
  @media (min-width:680px){
    .row.two{ grid-template-columns: repeat(2,minmax(0,1fr)) }
    .row.three{ grid-template-columns: repeat(3,minmax(0,1fr)) }
  }

  /* Chips with 3D tilt & parallax glow */
  .al-chip{
    border:1px solid var(--al-line);
    background:
      radial-gradient(220px 120px at var(--mx) var(--my), rgba(236,72,153,.10), transparent 38%),
      linear-gradient(180deg,#121a3a,#0f172f);
    color:#e7ebff; border-radius:16px; padding:16px; text-align:left; cursor:pointer; font-size:1.05rem;
    box-shadow: 0 6px 16px rgba(0,0,0,.34);
    transition: transform .12s ease, box-shadow .25s ease, border-color .25s ease;
    transform-style: preserve-3d; perspective: 600px;
  }
  .al-chip:hover{ transform: translateY(-2px) scale(1.01); box-shadow: 0 18px 36px rgba(0,0,0,.4), var(--glow); }
  .al-chip[aria-pressed="true"]{
    border-color: transparent;
    background:
      radial-gradient(260px 140px at var(--mx) var(--my), rgba(79,70,229,.16), transparent 42%),
      linear-gradient(135deg, rgba(79,70,229,.18), rgba(236,72,153,.18));
    box-shadow: 0 0 0 4px rgba(236,72,153,.25), var(--glow);
  }

  .foot{
    position:sticky; bottom:0; left:0; right:0; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    margin-top:14px; padding-top:12px; border-top:1px dashed var(--al-line); background:transparent;
  }
  .btn{
    border:0; border-radius:16px; padding:14px 18px; font-weight:900; cursor:pointer; min-height:48px;
    box-shadow: 0 10px 24px rgba(0,0,0,.45); transition: transform .12s ease, box-shadow .2s ease;
  }
  .btn:hover{ transform: translateY(-1px); box-shadow: 0 18px 36px rgba(0,0,0,.5) }
  .btn.primary{ background: linear-gradient(135deg, var(--al-a1), var(--al-a2)); color:#fff }
  .btn.ghost{ background: linear-gradient(135deg,#121a3a,#1a2345); color:#e7ebff; border:1px solid var(--al-line) }
  .btn.warn{ background: linear-gradient(135deg,#173155,#334c85); color:#ffd95c; border:1px solid #334c85 }

  .hint{ font-size:13px; color:#9fb4ff; opacity:.9 }
  .ok{ color:var(--al-ok) } .warntext{ color:var(--al-warn) } .danger{ color:var(--al-danger) }

  /* Review */
  .review{ display:grid; gap:12px }
  details.card{ border:1px solid var(--al-line); background: linear-gradient(135deg,#0f1731,#1a223f); border-radius:16px; padding:12px; box-shadow: 0 8px 20px rgba(0,0,0,.35) }
  summary{ cursor:pointer; font-weight:900; background: linear-gradient(135deg,var(--al-a3),var(--al-a4)); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent }
  .kv{ display:grid; gap:6px; margin-top:10px }
  .kv div{ display:flex; gap:12px; font-size:15px; color:#cedaff }
  .kv div b{ min-width:220px; font-weight:800; background: linear-gradient(135deg,var(--al-a1),var(--al-a2)); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent }
  @media (max-width:520px){ .kv div{ flex-direction:column } .kv div b{ min-width:unset } }

  /* Modal for docs */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.7); z-index:1000; backdrop-filter: blur(6px) }
  .modal.open{ display:flex; animation: fadeIn .35s ease both }
  .modal .panel{
    width:min(1000px,96vw); height:min(88vh,1000px);
    background: linear-gradient(135deg,#0b1226,#1a1f3a);
    border:1px solid var(--al-line); border-radius:18px; overflow:hidden; display:flex; flex-direction:column;
    box-shadow: 0 28px 70px rgba(0,0,0,.6), var(--glow);
  }
  .modal .head{ display:flex; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid var(--al-line) }
  .modal .ttl{ font-weight:900; background: linear-gradient(135deg, var(--al-a1), var(--al-a2)); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent }
  .modal .body{ flex:1; background: linear-gradient(135deg,#0e162e,#1a223f) }
  .modal embed{ width:100%; height:100% }
  .modal .foot{ padding:12px; border-top:1px solid var(--al-line); display:flex; gap:10px; justify-content:flex-end }

  /* ======= CHECKBOX REDESIGN ======= */
  .ck-list{ list-style:none; margin:0; padding:0; display:grid; gap:10px }
  .ck-row{ display:flex; align-items:center; gap:12px; position:relative }
  .ck-row input[type="checkbox"]{
    /* keep in DOM for a11y, but visually hidden; we'll render a big custom box */
    position:absolute; left:10px; width:20px; height:20px; opacity:0; z-index:2;
  }
  .ck-row label{
    display:flex; align-items:center; gap:12px; width:100%;
    padding:12px 14px 12px 44px; border-radius:14px;
    border:1px solid var(--al-line);
    background:
      radial-gradient(200px 100px at var(--mx) var(--my), rgba(6,182,212,.10), transparent 40%),
      linear-gradient(135deg,#0f1731,#1a223f);
    cursor:pointer; user-select:none;
    transition: box-shadow .2s ease, transform .06s ease, border-color .2s ease, background .3s ease;
  }
  .ck-row label::before{
    content:"";
    position:absolute; left:14px; top:50%; transform:translateY(-50%);
    width:22px; height:22px; border-radius:6px;
    border:2px solid #6b7bb5; background:#0f1b3b;
    box-shadow: inset 0 2px 4px rgba(0,0,0,.35);
  }
  .ck-row input[type="checkbox"]:focus-visible + label{
    outline: 3px solid rgba(236,72,153,.35);
    outline-offset: 2px;
  }
  .ck-row input[type="checkbox"]:checked + label{
    border-color: transparent;
    box-shadow: 0 0 0 4px rgba(79,70,229,.22), var(--glow);
    background:
      radial-gradient(220px 110px at var(--mx) var(--my), rgba(79,70,229,.12), transparent 42%),
      linear-gradient(135deg, rgba(79,70,229,.18), rgba(236,72,153,.18));
    transform: translateY(-1px);
  }
  .ck-row input[type="checkbox"]:checked + label::before{
    background: linear-gradient(135deg, var(--al-a1), var(--al-a2));
    border-color: transparent;
    box-shadow: 0 0 0 3px rgba(236,72,153,.25);
    /* tick */
    mask:
      conic-gradient(from 90deg at 35% 60%, transparent 0 25%, #000 0 30%, transparent 0) ,
      conic-gradient(from -45deg at 60% 60%, transparent 0 55%, #000 0 60%, transparent 0);
    -webkit-mask:
      conic-gradient(from 90deg at 35% 60%, transparent 0 25%, #000 0 30%, transparent 0) ,
      conic-gradient(from -45deg at 60% 60%, transparent 0 55%, #000 0 60%, transparent 0);
  }

  /* Uploads helper */
  .doc-list{ margin:10px 0 0 20px; color:#cfe0ff }
  .doc-list li{ margin:8px 0 }
  .doc-list b{ background: linear-gradient(135deg,var(--al-a3),var(--al-a4)); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent }
  .doc-privacy{ margin-top:10px; font-size:13px; color:#9fb4ff }

  /* Key animations */
  @keyframes fadeIn{ from{ opacity:0; transform: translateY(8px) } to{ opacity:1; transform:none } }
  @keyframes floatIn{ from{ opacity:0; transform: translateY(8px) scale(.98) } to{ opacity:1; transform:none } }

  /* ===== CONFETTI CANVAS ===== */
  #confetti {
    position: fixed; inset: 0; pointer-events: none; z-index: 2000; display:none;
  }
</style>
</head>
<body>

<header>
  <div class="bar">
    <div class="brand">
      <div class="name">HD HeeD</div>
      <div class="tag">AILR ‚Äî Advanced Intake & Long-form Registration</div>
    </div>
    <div class="badge-hint">Desktop-first ‚Ä¢ Autosaves ‚Ä¢ You can pause and return anytime</div>
  </div>
</header>

<section class="hero">
  <div class="card glass card-shadow">
    <h1>Let‚Äôs get you set up ‚Äî thoroughly and simply</h1>
    <p>Answer clear, step-by-step questions. Pick a card, or type your own answer. Choose <em>Not sure</em> or <em>Prefer not to say</em> whenever you like ‚Äî you can finish later. We‚Äôll only need an <strong>email or phone</strong> at the end to submit.</p>
    <div class="meta">
      <span class="pill">NDIS participant onboarding</span>
      <span class="pill">Consents & risks included</span>
    </div>
    <p class="notice">Tip: On mobile, you‚Äôll see one focused screen at a time with large tap targets.</p>
  </div>
</section>

<div class="wrap" id="app">
  <!-- Sidebar NAV -->
  <nav class="nav glass card-shadow" aria-label="Form navigation">
    <h3>Form Progress</h3>
    <ul id="navList" class="nav-list"></ul>
  </nav>

  <!-- Main Stage -->
  <main id="stage" class="stage glass card-shadow" role="region" aria-live="polite">
    <div class="head">
      <span id="stepTxt" class="step">Step 1/99</span>
      <div class="meter" aria-label="Progress"><div id="bar"></div></div>
    </div>

    <div id="stageInner" class="stage-inner">
      <div id="q" class="q">‚Ä¶</div>
      <p id="sub" class="sub"></p>
      <div id="opts" class="opts"></div>
    </div>

    <div class="foot">
      <div class="hint" id="saveHint">Draft saved</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn ghost" id="backBtn" type="button">‚Üê Back</button>
        <button class="btn warn" id="saveExitBtn" type="button">Save & Exit</button>
        <button class="btn primary" id="nextBtn" type="button">Next ‚Üí</button>
      </div>
    </div>
  </main>
</div>

<!-- Document Modal -->
<div id="docModal" class="modal" aria-hidden="true">
  <div class="panel">
    <div class="head">
      <div class="ttl" id="docTitle">Document</div>
      <button id="docClose" class="btn ghost">Close</button>
    </div>
    <div class="body"><embed id="docViewer" src="" type="application/pdf" /></div>
    <div class="foot">
      <a id="docDownload" class="btn primary" href="#" download>Download PDF</a>
    </div>
  </div>
</div>

<!-- Confetti canvas -->
<canvas id="confetti"></canvas>

<script>
/* ===========================================================
   FULL APP ‚Äî content preserved, visuals upgraded, strict consent
   =========================================================== */
window.addEventListener('DOMContentLoaded', function(){

  /* ====== Config (links kept EXACTLY) ====== */
  var GS_WEBAPP   = "https://script.google.com/macros/s/AKfycbyj9VvLh26csmc0bEry3cfeRzGxmZZJx5HNptkZGvcVzqTfmnO9fSsvhwF9YgCwfM5ALw/exec";
  var STORAGE_KEY = "hdheed_ailr_v16";

  /* === Your 11 PDFs (links kept EXACTLY) === */
  var DOCS = [
    { id:"handbook", title:"Client Handbook", requiresConsent:false,
      fileId:"https://drive.google.com/file/d/1Du5TxEIgD9n--Gw5vkkkFXEij_SaLwLE/view?usp=sharing" },
    { id:"privacy", title:"Privacy and Confidentiality Agreement", requiresConsent:true,
      fileId:"https://drive.google.com/file/d/16qAcoUWtXC57hCg-B2atxpQRfDr53jKK3/view?usp=sharing".replace("K3","K3") },
    { id:"money_property", title:"Participant Money and Property Consent Form", requiresConsent:true,
      fileId:"https://drive.google.com/file/d/1OymxyfOYxtaqW2keNrRB_kmW8JmfP6vz/view?usp=sharing" },
    { id:"incident_ack", title:"Incident Management Acknowledgement Form", requiresConsent:false,
      fileId:"https://drive.google.com/file/d/1EYfi-4SoOxk8y70PNc2Fw70RiO7yxZ8a/view?usp=sharing" },
    { id:"share_ndis_plan", title:"Consent to Share NDIS Plan", requiresConsent:true,
      fileId:"https://drive.google.com/file/d/10j5FmZg1zfKeE9XrclmFZFY3BaGQj-mo/view?usp=sharing" },
    { id:"share_info", title:"Consent to Share Information", requiresConsent:true,
      fileId:"https://drive.google.com/file/d/1uJ3XCrdms2yHdnnDvXyaCEgUu91fZ1ip/view?usp=sharing" },
    { id:"media_photos", title:"Consent for Media and Photographs", requiresConsent:true,
      fileId:"https://drive.google.com/file/d/1UuNf69LxSLTOZNhwvi-17d3SeRRjik3t/view?usp=sharing" },
    { id:"emergency_med", title:"Consent for Emergency Medical Treatment", requiresConsent:true,
      fileId:"https://drive.google.com/file/d/1mGUnc7z9gVkYw3KEC6qiEhBxOUrB_zIx/view?usp=sharing" },
    { id:"complaints_feedback", title:"Complaints and Feedback Form", requiresConsent:false,
      fileId:"https://drive.google.com/file/d/12fK9zFbu0SnXyJ0Zs77hOvdXp-D9bwDU/view?usp=sharing" },
    { id:"advocacy_auth", title:"Authority to Act as an Advocate", requiresConsent:true,
      fileId:"https://drive.google.com/file/d/1Ips2uYAXgsg_35ATUJzsWpad4haMlAtD/view?usp=sharing" },
    { id:"key_authority", title:"Authority to Hold a Key", requiresConsent:true,
      fileId:"https://drive.google.com/file/d/1sBNptUA3mTu55NdDPNUAexqLOjfPmPQ-/view?usp=sharing" }
  ];
  function driveUrl(idOrUrl){
    if(!idOrUrl) return "#";
    if(/^https?:\/\//i.test(idOrUrl)) return idOrUrl;
    return "https://drive.google.com/uc?export=download&id="+encodeURIComponent(idOrUrl);
  }

  /* ====== Helpers ====== */
  function $(s,r){ return (r||document).querySelector(s); }
  function setSaveHint(t){ var el=$("#saveHint"); if(el) el.textContent=t; }
  function cloneSafe(obj){
    try{ if (typeof structuredClone==="function") return structuredClone(obj); }catch(e){}
    try{ return JSON.parse(JSON.stringify(obj)); }catch(e){ return obj; }
  }

  /* ====== State ====== */
  var S = {
    i: 0,
    caller: { role:null, name:null, relationship:null, consent:null },
    participant: {
      legal_name:null, preferred_name:null, pronouns:null, dob:null, ndis_number:null,
      address:{ line1:null, line2:null, suburb:null, postcode:null, state:null },
      plan_mgmt:null, plan_manager:{ org:null, contact:null, email:null, phone:null },
      plan_dates:{ start:null, end:null }
    },
    contacts:{
      email:null, phone:null,
      emergency:{ name:null, relationship:null, phone:null },
      support_coordinator:{ name:null, org:null, email:null, phone:null },
      gp:{ name:null, practice:null, email:null, phone:null }
    },
    comms:{
      primary_language:null, interpreter:null, interpreter_language:null,
      cultural_considerations:null,
      preferences:{ worker_gender:null, worker_gender_other:null, transport_required:null }
    },
    living:{
      residence_type:null, lives_with:null, entry_notes:null, keysafe:null, smoking_on_premises:null, hazards:null
    },
    clinical:{
      primary_diagnoses:null, other_diagnoses:null, allergies:"",
      mobility:null, equipment:null, continence:null, cognition:null, pressure_injury_risk:null,
      seizures:{ has:null, plan:null, frequency:null }, falls_risk:null, diet_notes:null,
      stoma_care:null
    },
    medications:{
      has_meds:null, method:"Not sure", storage:null, webster_pack:null, self_admin:null, staff_admin:null, notes:null
    },
    risks:{
      behavioural:{ present:null, notes:null },
      clinical:{ wounds:false, diabetes:false, tracheostomy:false, tube_feeding:false, mental_health:false, stoma_care:false, other:null },
      environmental:{ animals:false, hoarding:false, weapons:false, other:null },
      home_checklist:{ trip_hazards:false, smoke_alarms:false, lighting:false, bathroom_safety:false, notes:null },
      other_notes:null,
      overall_rating:"Not sure"
    },
    bsp:{ has_bsp:null, provider:null, restrictive_practices:null, notes:null },
    supports:{
      required:[], required_other:null, details_text:null,
      core:[], capacity:[], core_other:null, capacity_other:null,
      goals:null, outcomes:null
    },
    schedule:{ windows:[], days:[], start_preference:null, hours_per_week:null, urgency:"Not sure" },
    policy_ack:{ handbook:false, incident:false, complaints:false },
    emergency_advocacy:null,
    uploads:{ files:[] },
    submitter:{ name:null, email:null, phone:null },
    acks:{},
    notes:[]
  };

  /* restore draft */
  try{
    var prev = JSON.parse(localStorage.getItem(STORAGE_KEY)||"null");
    if (prev && typeof prev==="object") Object.assign(S, prev);
  }catch(e){}

  function save(){
    try{
      var clone = cloneSafe(S);
      if (clone.uploads) clone.uploads = { files: [] };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(clone));
      setSaveHint("Draft saved");
    }catch(e){}
  }

  /* ====== DOM refs ====== */
  var qEl = document.getElementById("q");
  var subEl = document.getElementById("sub");
  var optsEl = document.getElementById("opts");
  var stepTxt = document.getElementById("stepTxt");
  var barEl = document.getElementById("bar");
  var backBtn = document.getElementById("backBtn");
  var nextBtn = document.getElementById("nextBtn");
  var saveExitBtn = document.getElementById("saveExitBtn");
  var navList = document.getElementById("navList");
  var stage = document.getElementById("stage");
  var stageInner = document.getElementById("stageInner");

  /* ====== Steps (content preserved) ====== */
  var Steps = [
    { key:"intro", title:"Welcome ‚Äî let‚Äôs begin", sub:"Pick a card or type. You can choose Not sure or Prefer not to say anywhere.",
      build:function(m){
        m.appendChild(radioChips("Who is completing this form?", S.caller, "role", [
          ["I‚Äôm the participant","Participant"],
          ["Family / Carer","Carer"],
          ["Support Coordinator","Support Coordinator"],
          ["Health Professional","Health Professional"],
          ["Prefer not to say","Prefer not to say"]
        ]));
        m.appendChild(row("two",[ input("Your name (optional)", S.caller, "name"), input("Relationship (if any)", S.caller, "relationship") ]));
      }
    },
    { key:"caller", title:"Consent to proceed (read carefully)", sub:'<div class="consent-box"><b>What you are consenting to</b><ul><li>HD HeeD may collect the personal and health information you provide here for the purpose of coordinating and delivering NDIS supports you request.</li><li>We will store your information securely and keep it confidential. We will only share it with others where you agree (e.g., your Support Coordinator, Plan Manager, or health professionals) or where required by law.</li><li>You can withdraw consent at any time. If you do, we may be unable to continue onboarding or provide services.</li><li>With your permission, we may contact your Plan Manager or Support Coordinator to confirm funding details and coordinate services.</li><li>Emergency: if there is a serious risk to you or others, we may share relevant information to keep people safe.</li></ul><div class="hint" style="margin-top:8px">By selecting <b>Yes</b> below, you confirm you understand and agree to the above.</div></div><div class="hint" style="margin-top:8px">Privacy: Please see the Privacy & Confidentiality form in the policy section below. A signed Service Agreement will be required before supports commence.</div>',
      build:function(m){
        m.appendChild(radioChips("Do you give consent to collect your details and, if needed, liaise with your Support Coordinator/Plan Manager?", S.caller, "consent", [
          ["Yes, I consent","Yes"],["Not yet","Not yet"],["No","No"],["Not sure","Not sure"]
        ]));
        var warn = document.createElement('div'); warn.className="hint";
        warn.innerHTML = "Note: If you select <b>Not yet</b> or <b>No</b>, you won‚Äôt be able to continue.";
        m.appendChild(warn);
      }
    },
    { key:"participant", title:"Participant ‚Äî legal details", sub:"Legal name is required for service setup later; preferred name helps our team address the participant correctly.",
      build:function(m){
        m.appendChild(row("two",[ input("Legal name", S.participant, "legal_name"), input("Preferred name (optional)", S.participant, "preferred_name") ]));
        m.appendChild(row("three",[ input("Pronouns (optional)", S.participant, "pronouns"), input("Date of birth", S.participant, "dob","date"), input("NDIS number (optional)", S.participant, "ndis_number") ]));
        m.appendChild(divider("Address"));
        m.appendChild(row("two",[ input("Address line 1", S.participant.address, "line1"), input("Address line 2 (optional)", S.participant.address, "line2") ]));
        m.appendChild(row("three",[ input("Suburb", S.participant.address, "suburb"), input("Postcode", S.participant.address, "postcode"), input("State", S.participant.address, "state") ]));
        m.appendChild(divider("Plan management"));
        m.appendChild(radioChips("Plan management", S.participant, "plan_mgmt", [
          ["NDIA-managed","NDIA-managed"],["Plan-managed","Plan-managed"],["Self-managed","Self-managed"],["Not sure","Not sure"],["Prefer not to say","Prefer not to say"],
        ]));
        m.appendChild(typeBox("Plan manager (org & contact; optional)", "Org & name (if applicable)", function(v){ S.participant.plan_manager.org=v; save(); }));
        m.appendChild(row("three",[ input("Plan manager contact name", S.participant.plan_manager, "contact"), input("Plan manager email", S.participant.plan_manager, "email","email"), input("Plan manager phone", S.participant.plan_manager, "phone","tel") ]));
        m.appendChild(row("two",[ input("Plan start date", S.participant.plan_dates, "start","date"), input("Plan end date", S.participant.plan_dates, "end","date") ]));
      }
    },
    { key:"contacts", title:"Contacts ‚Äî how we reach you", sub:"Provide at least one method ‚Äî email or phone is required at submission.",
      build:function(m){
        m.appendChild(row("two",[ input("Participant email", S.contacts, "email","email"), input("Participant phone", S.contacts, "phone","tel") ]));
        m.appendChild(divider("Emergency contact"));
        m.appendChild(row("three",[ input("Name", S.contacts.emergency, "name"), input("Relationship", S.contacts.emergency, "relationship"), input("Phone", S.contacts.emergency, "phone","tel") ]));
        m.appendChild(divider("Support Coordinator (if any)"));
        m.appendChild(row("two",[ input("Name", S.contacts.support_coordinator, "name"), input("Organisation", S.contacts.support_coordinator, "org") ]));
        m.appendChild(row("two",[ input("Email", S.contacts.support_coordinator, "email","email"), input("Phone", S.contacts.support_coordinator, "phone","tel") ]));
        m.appendChild(divider("GP / Primary care"));
        m.appendChild(row("three",[ input("GP name", S.contacts.gp, "name"), input("Practice", S.contacts.gp, "practice"), input("Phone", S.contacts.gp, "phone","tel") ]));
        m.appendChild(input("GP email (optional)", S.contacts.gp, "email","email"));
      }
    },
    { key:"comms", title:"Communication & preferences", sub:"Tell us what helps the participant feel comfortable and understood.",
      build:function(m){
        m.appendChild(row("two",[ input("Primary language", S.comms, "primary_language"), input("Interpreter language (if needed)", S.comms, "interpreter_language") ]));
        m.appendChild(radioChips("Interpreter", S.comms, "interpreter", [
          ["Interpreter required","Yes"],["Interpreter not required","No"],["Not sure","Not sure"],["Prefer not to say","Prefer not to say"]
        ]));
        m.appendChild(typeBox("Cultural / religious considerations (optional)", "Anything to respect (optional)", function(v){ S.comms.cultural_considerations=v; save(); }));
        m.appendChild(row("two",[ select("Worker gender preference", S.comms.preferences, "worker_gender", ["No preference","Female","Male","Other / type below"]), input("Other preference (type if selected)", S.comms.preferences, "worker_gender_other") ]));
        m.appendChild(radioChips("Transport required?", S.comms.preferences, "transport_required", [ ["Yes","Yes"],["No","No"],["Not sure","Not sure"] ]));
      }
    },
    { key:"living", title:"Living situation & access", sub:"This helps us plan safe, respectful visits.",
      build:function(m){
        m.appendChild(select("Residence type", S.living, "residence_type", ["Private home","Unit/Apartment","Group home","Supported accommodation","Other","Prefer not to say"]));
        m.appendChild(input("Lives with (names or relationships)", S.living, "lives_with"));
        m.appendChild(input("Entry notes (e.g., gate, pets, parking)", S.living, "entry_notes"));
        m.appendChild(radioChips("Keysafe available?", S.living, "keysafe", [ ["Yes","Yes"],["No","No"],["Not sure","Not sure"] ]));
        m.appendChild(radioChips("Smoking on premises?", S.living, "smoking_on_premises", [ ["Yes","Yes"],["No","No"],["Prefer not to say","Prefer not to say"] ]));
        m.appendChild(typeBox("Any hazards we should know about?", "e.g., steep stairs, loose rugs, reactive pets", function(v){ S.living.hazards=v; save(); }));
      }
    },
    { key:"clinical", title:"Health & clinical summary", sub:"Share as much as you‚Äôre comfortable with now; we can confirm details later. <b>Allergies is required</b> (write ‚ÄúNo known allergies‚Äù if none).",
      build:function(m){
        m.appendChild(typeBox("Primary diagnoses", "e.g., Autism Spectrum Disorder, MS", function(v){ S.clinical.primary_diagnoses=v; save(); }));
        m.appendChild(typeBox("Other diagnoses (optional)", "Type here", function(v){ S.clinical.other_diagnoses=v; save(); }));
        m.appendChild(input("Allergies (required ‚Äî write ‚ÄúNo known allergies‚Äù if none)", S.clinical, "allergies"));
        m.appendChild(row("two",[ select("Mobility", S.clinical, "mobility", ["Independent","With aid","Requires transfer","Bed-bound","Prefer not to say"]), input("Equipment / aids (optional)", S.clinical, "equipment") ]));
        m.appendChild(row("two",[ select("Continence", S.clinical, "continence", ["Independent","Needs prompting","Incontinent","Catheter / stoma","Prefer not to say"]), select("Cognition", S.clinical, "cognition", ["Clear","Mild impairment","Moderate","Severe","Prefer not to say"]) ]));
        m.appendChild(row("two",[ select("Pressure injury risk", S.clinical, "pressure_injury_risk", ["Low","Medium","High","Not sure"]), select("Falls risk", S.clinical, "falls_risk", ["Low","Medium","High","Not sure"]) ]));
        m.appendChild(row("three",[ radioChipsInline("Seizures?", S.clinical.seizures, "has", [ ["No",false],["Yes",true],["Not sure",null] ]), input("Seizure plan (if any)", S.clinical.seizures, "plan"), input("Frequency (if applicable)", S.clinical.seizures, "frequency") ]));
        m.appendChild(radioChipsInline("Stoma/ostomy care required?", S.clinical, "stoma_care", [ ["Yes",true],["No",false],["Not sure",null] ]));
        m.appendChild(input("Diet / swallowing notes (optional)", S.clinical, "diet_notes"));
      }
    },
    { key:"medications", title:"Medication management", sub:"Tell us if medications are part of daily support.",
      build:function(m){
        m.appendChild(radioChips("Participant has medications?", S.medications, "has_meds", [ ["Yes",true],["No",false],["Not sure",null] ]));
        m.appendChild(select("How are meds managed?", S.medications, "method", ["Self-administered","Prompting only","Staff administer","Family administers","Not sure"]));
        m.appendChild(row("two",[ radioChipsInline("Webster pack?", S.medications, "webster_pack", [["Yes",true],["No",false],["Not sure",null]]), input("Storage location (optional)", S.medications, "storage") ]));
        m.appendChild(row("two",[ radioChipsInline("Self-admin?", S.medications, "self_admin", [["Yes",true],["No",false],["Not sure",null]]), radioChipsInline("Staff admin?", S.medications, "staff_admin", [["Yes",true],["No",false],["Not sure",null]]) ]));
        m.appendChild(typeBox("Medication notes (optional)", "List regular and PRN meds if you like", function(v){ S.medications.notes=v; save(); }));
      }
    },
    { key:"risks", title:"Risk assessment ‚Äî quick overview", sub:"We‚Äôll use this to plan safe, appropriate supports.",
      build:function(m){
        m.appendChild(divider("Behavioural"));
        m.appendChild(radioChips("Behaviours of concern present?", S.risks.behavioural, "present", [ ["None","None"],["Present","Present"],["Not sure","Not sure"],["Prefer not to say","Prefer not to say"] ]));
        m.appendChild(typeBox("Behaviour notes (optional)", "Triggers / strategies / Behaviour Support Plan provider", function(v){ S.risks.behavioural.notes=v; save(); }));

        m.appendChild(divider("Clinical"));
        m.appendChild(checks("Select applicable", S.risks.clinical, {
          wounds:"Wounds / dressings",
          diabetes:"Diabetes",
          tracheostomy:"Tracheostomy",
          tube_feeding:"Enteral tube feeding",
          mental_health:"Significant mental health needs",
          stoma_care:"Stoma care"
        }));
        m.appendChild(typeBox("Other clinical concerns (optional)", "Type here", function(v){ S.risks.clinical.other=v; save(); }));

        m.appendChild(divider("Environmental"));
        m.appendChild(checks("Select applicable", S.risks.environmental, {
          animals:"Reactive animals",
          hoarding:"Hoarding / clutter",
          weapons:"Weapons on site"
        }));
        m.appendChild(typeBox("Other environmental concerns (optional)", "Type here", function(v){ S.risks.environmental.other=v; save(); }));

        m.appendChild(divider("Home risk checklist (quick)"));
        m.appendChild(checks("Tick any present", S.risks.home_checklist, {
          trip_hazards:"Trip hazards",
          smoke_alarms:"No working smoke alarms",
          lighting:"Poor lighting",
          bathroom_safety:"Bathroom lacks safety rails / mats"
        }));
        m.appendChild(input("Home risk notes (optional)", S.risks.home_checklist, "notes"));

        m.appendChild(typeBox("Other risk notes (optional)", "Anything else we should consider", function(v){ S.risks.other_notes=v; save(); }));

        m.appendChild(select("Overall risk rating (your view)", S.risks, "overall_rating", ["Low","Medium","High","Not sure"]));
      }
    },
    { key:"bsp", title:"Behaviour Support Plan (if applicable)", sub:"Always shown, only fill if required.",
      build:function(m){
        m.appendChild(radioChips("Behaviour Support Plan in place?", S.bsp, "has_bsp", [ ["Yes",true],["No",false],["Not sure",null] ]));
        m.appendChild(radioChipsInline("Restrictive practices involved?", S.bsp, "restrictive_practices", [ ["Yes",true],["No",false],["Not sure",null] ]));
        m.appendChild(row("two",[ input("Behaviour Support Plan provider (if any)", S.bsp, "provider"), input("Notes (optional)", S.bsp, "notes") ]));
      }
    },
    { key:"supports", title:"Which supports are required? (select one or more)", sub:"Pick all that apply, then press Next. You can also type specifics if helpful.",
      build:function(m){
        var options = {
          personal_care:"Personal care (showering / dressing / toileting / meal prep / prompting)",
          high_intensity:"High-intensity personal care (wound care / medications / stoma care / PEG feeds / catheter care / bowel care / pressure care)",
          household_tasks:"Household tasks (domestic help / cleaning / laundry / meal prep)",
          life_skills:"Development of life skills (cooking / budgeting / travel training / daily routines)",
          community_participation:"Community participation (appointments / shopping / social & community activities / outings)",
          group_centre:"Group or centre-based activities (programs / day activities)",
          travel_transport:"Assist with travel & transport (support worker transport / escorted travel)",
          daily_tasks_sil:"Daily tasks & shared living (support in SIL / morning‚Äìevening routines / overnight assistance)",
          not_sure:"Not sure ‚Äî please guide me"
        };
        m.appendChild(checks("Select supports", S.supports, options, "required"));
        m.appendChild(typeBox("Something else ‚Äî I‚Äôll type it (optional)", "Describe any other support", function(v){ S.supports.required_other=v; save(); }));
        m.appendChild(typeBox("Want to type a specific support detail? (optional)", "e.g., wound dressing frequency; Webster pack; bowel care plan; shopping day", function(v){ S.supports.details_text=v; save(); }));

        m.appendChild(divider("<b>Goals & outcomes</b> (optional but recommended)"));
        m.appendChild(typeBox("Goals (participant‚Äôs goals)", "Type goals or outcomes in the plan", function(v){ S.supports.goals=v; save(); }));
        m.appendChild(typeBox("Preferred outcomes / focus areas", "What does success look like?", function(v){ S.supports.outcomes=v; save(); }));
      }
    },
    { key:"schedule", title:"Schedule & urgency", sub:"Tell us the visit windows that suit, and how soon you‚Äôd like to begin.",
      build:function(m){
        m.appendChild(checks("Time windows", S.schedule, {
          w1:"Weekday mornings (7‚Äì11am)",
          w2:"Weekday afternoons (12‚Äì4pm)",
          w3:"Evenings (5‚Äì9pm)",
          w4:"Weekends"
        }, "windows"));
        m.appendChild(checks("Days", S.schedule, { d1:"Mon", d2:"Tue", d3:"Wed", d4:"Thu", d5:"Fri", d6:"Sat", d7:"Sun" }, "days"));
        m.appendChild(row("two",[ input("Approx. hours per week", S.schedule, "hours_per_week","number"), select("Urgency", S.schedule, "urgency", ["Urgent (24‚Äì72h)","Soon (1‚Äì2 weeks)","Exploring options","Not sure"]) ]));
        m.appendChild(input("Start preference / date (optional)", S.schedule, "start_preference"));
      }
    },
    { key:"policies", title:"Client Handbook, Consents & Service Agreement", sub:"Please confirm you‚Äôve received & read the documents below. For forms requiring consent, tick to confirm you consent and will sign the PDF and email it to info@hdheed.com.au. <br><br><b>Service Agreement:</b> Using the information you provide, we will prepare a Service Agreement that must be reviewed and signed before supports commence.",
      build:function(m){
        DOCS.forEach(function(d){ if(!S.acks[d.id]) S.acks[d.id] = { read:false, consent:false }; });
        DOCS.forEach(function(d){
          var card = document.createElement('div'); card.className="inlinebox";
          card.innerHTML = '<div style="font-weight:800">'+d.title+'</div>';
          var actions = document.createElement('div'); actions.style="display:flex; gap:8px; flex-wrap:wrap; align-items:center";
          var a = document.createElement('a'); a.className="btn primary"; a.textContent="Download PDF"; a.href=driveUrl(d.fileId); a.download="";
          actions.appendChild(a);
          var hint = document.createElement('div'); hint.className="hint";
          hint.textContent = d.requiresConsent ? "Please sign the PDF and email it to info@hdheed.com.au."
                                               : "Please read this document before proceeding.";
          actions.appendChild(hint);
          card.appendChild(actions);

          var row1 = document.createElement('div'); row1.className="ck-row";
          var c1 = document.createElement('input'); c1.type="checkbox"; c1.id="ack_read_"+d.id; c1.checked = !!S.acks[d.id].read;
          var l1 = document.createElement('label'); l1.htmlFor=c1.id; l1.textContent = "I have received & read this document.";
          c1.addEventListener('change', function(){ S.acks[d.id].read = c1.checked; save(); });
          row1.appendChild(c1); row1.appendChild(l1); card.appendChild(row1);

          if (d.requiresConsent){
            var row2 = document.createElement('div'); row2.className="ck-row";
            var c2 = document.createElement('input'); c2.type="checkbox"; c2.id="ack_con_"+d.id; c2.checked = !!S.acks[d.id].consent;
            var l2 = document.createElement('label'); l2.htmlFor=c2.id; l2.textContent = "I consent to the terms in this form.";
            c2.addEventListener('change', function(){ S.acks[d.id].consent = c2.checked; save(); });
            row2.appendChild(c2); row2.appendChild(l2); card.appendChild(row2);
          }
          m.appendChild(card);
        });

        var sum = document.createElement('div'); sum.className="hint"; sum.style.marginTop="6px";
        var total=DOCS.length, readCt=0, needCon=DOCS.filter(d=>d.requiresConsent).length, conCt=0;
        DOCS.forEach(function(d){ if(S.acks[d.id].read) readCt++; if(d.requiresConsent && S.acks[d.id].consent) conCt++; });
        sum.textContent = "Acknowledged: "+readCt+"/"+total+" read ‚Ä¢ Consents: "+conCt+"/"+needCon;
        m.appendChild(sum);
      }
    },
    { key:"uploads", title:"Documents ‚Äî please email them", sub:'You can proceed without attachments. Email documents to <a href="mailto:info@hdheed.com.au?subject=Onboarding%20documents&body=Please%20include%20participant%20name%20and%20NDIS%20number%20if%20available.">info@hdheed.com.au</a>\
          <div class="consent-box" style="margin-top:10px">\
            <b>What to send (simple reminder)</b>\
            <ul>\
              <li>Photo ID (e.g., driver licence or passport)</li>\
              <li>Medicare card (optional, for GP/pharmacy liaison or emergencies)</li>\
              <li>NDIS plan (latest)</li>\
              <li>Care plans (e.g., BSP, diabetes plan, seizure plan)</li>\
              <li>Medication chart / current medication list (if any)</li>\
              <li>Signed consent forms ‚Äî Refer to step 13.</li>\
            </ul>\
          </div>',
      build:function(m){ S.uploads.files = []; save(); }
    },
    { key:"review", title:"Review your answers", sub:"Check the sections below. You can go back to edit anything.",
      build:function(m){ m.appendChild(renderReview()); }
    },
    { key:"submit", title:"Submit your onboarding", sub:"Provide a contact. At least an email or phone is required to submit. <br><br><b>Next steps:</b> We‚Äôll review, prepare your Service Agreement for e-signature, and contact you to schedule supports.",
      build:function(m){
        m.appendChild(row("two",[ input("Your name (submitter)", S.submitter, "name"), input("Email (required if no phone)", S.submitter, "email","email") ]));
        m.appendChild(input("Phone (required if no email)", S.submitter, "phone","tel"));

        var actions = document.createElement('div'); actions.style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px";
        var btnSend = button("Send now","primary", function(){
          if (!hasConsentYes()){
            alert("We‚Äôre unable to proceed without consent. Please return to Step 2 and select ‚ÄúYes‚Äù.");
            transitionTo(1); return;
          }
          if (!canSubmitContacts()){
            alert("Please provide at least an email or a phone number to submit.");
            return;
          }

          btnSend.disabled = true;
          var oldTxt = btnSend.textContent;
          btnSend.textContent = "Sending‚Ä¶";

          sendToFormspree().then(function(j){
            confettiBurst(); // üéâ
            var pdfMsg = j && j.fileUrl ? ("\nPDF saved to Drive.\nView: " + j.fileUrl) : "";
            alert("All done ‚Äî we‚Äôve received your onboarding." + pdfMsg);

            try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
            var container = document.querySelector("main.stage");
            if (container){
              container.innerHTML = '<div class="head"><span class="step">Done</span><div class="meter"><div style="width:100%"></div></div></div>\
                <div class="q">Thank you for your submission</div>\
                <p class="sub">We‚Äôve received your referral and will be in touch soon.</p>\
                <div class="foot"><button class="btn ghost" onclick="location.reload()">Start a new referral</button></div>';
            }
          }).catch(function(e){
            alert("Couldn‚Äôt send right now. Please email info@hdheed.com.au or try again.\n\n" + (e && e.message ? e.message : e));
            btnSend.disabled = false;
            btnSend.textContent = oldTxt;
          });
        });

        var btnPdf = button("Print / Save summary as PDF","ghost", function(){ openPrintableSummary(); });
        actions.appendChild(btnSend); actions.appendChild(btnPdf);
        m.appendChild(actions);
        var hint = document.createElement('div'); hint.className="hint";
        hint.innerHTML = "We‚Äôll contact you from <b>info@hdheed.com.au</b> or <b>02 8630 5500</b>. <br>By submitting, you confirm the on-screen consent above and understand a Service Agreement must be signed before supports commence.";
        m.appendChild(hint);
      }
    }
  ];

  /* ====== UI helper controls ====== */
  function button(txt,variant,onClick){
    var b = document.createElement('button');
    b.className = "btn " + (variant||"ghost");
    b.type="button"; b.textContent = txt;
    b.addEventListener('click',onClick);
    return b;
  }
  function divider(txt){ var d=document.createElement('div'); d.className="hint"; d.style.margin="8px 0 4px"; d.innerHTML=txt; return d; }
  function row(cols, children){ var r=document.createElement('div'); r.className="row "+(cols||""); children.forEach(c=>r.appendChild(c)); return r; }
  function input(label, obj, key, type){
    var box = document.createElement('div'); box.className="inlinebox";
    var id = "in_"+key+"_"+Math.random().toString(36).slice(2,7);
    box.innerHTML = '<label for="'+id+'" style="font-weight:800">'+label+'</label>';
    var i = document.createElement('input');
    i.id=id; i.type=type||"text"; i.value=obj[key]||""; i.placeholder="";
    i.addEventListener('input', function(){ obj[key] = i.value || null; save(); });
    box.appendChild(i); return box;
  }
  function select(label, obj, key, options){
    var box = document.createElement('div'); box.className="inlinebox";
    var id = "sel_"+key+"_"+Math.random().toString(36).slice(2,7);
    box.innerHTML = '<label for="'+id+'" style="font-weight:800">'+label+'</label>';
    var s = document.createElement('select'); s.id=id;
    var html = '<option value="">Select‚Ä¶</option>';
    options.forEach(function(o){ html += '<option value="'+o+'">'+o+'</option>'; });
    s.innerHTML = html;
    if (obj[key]!==null && obj[key]!==undefined) s.value = obj[key];
    s.addEventListener('change', function(){ obj[key] = s.value || null; save(); });
    box.appendChild(s); return box;
  }
  function radioChips(label, obj, key, items){
    var wrap = document.createElement('div'); wrap.className="inlinebox";
    wrap.innerHTML = '<label style="font-weight:800">'+label+'</label>';
    var roww = document.createElement('div'); roww.style="display:flex; gap:8px; flex-wrap:wrap";
    var buttons = [];
    items.forEach(function(pair){
      var txt = pair[0], val = pair[1];
      var b = document.createElement('button'); b.type="button"; b.className="al-chip"; b.textContent = txt;
      if (obj[key]===val) b.setAttribute("aria-pressed","true");
      // tilt effect on move
      b.addEventListener('mousemove', function(e){ tiltCard(b,e); });
      b.addEventListener('mouseleave', function(){ b.style.transform = ""; });
      b.addEventListener('click', function(){
        obj[key] = val;
        buttons.forEach(function(x){ x.removeAttribute("aria-pressed"); });
        b.setAttribute("aria-pressed","true");
        save();
        if (key === 'consent') updateNavigationLocks();
      });
      buttons.push(b); roww.appendChild(b);
    });
    wrap.appendChild(roww);
    return wrap;
  }
  function radioChipsInline(label, obj, key, items){ return radioChips(label, obj, key, items); }

  function checks(label, targetObj, map, arrayKey){
    var box = document.createElement('div'); box.className="inlinebox";
    box.innerHTML = '<label style="font-weight:800">'+label+'</label>';
    var list = document.createElement('ul'); list.className="ck-list";
    if (arrayKey){
      if (!Array.isArray(targetObj[arrayKey])) targetObj[arrayKey] = [];
      Object.keys(map).forEach(function(k){
        var txt = map[k];
        var id = "ck_"+k+"_"+Math.random().toString(36).slice(2,7);
        var li = document.createElement('li'); li.className="ck-row";
        var c = document.createElement('input'); c.type="checkbox"; c.id=id; c.checked = targetObj[arrayKey].indexOf(k)!==-1;
        var lab = document.createElement('label'); lab.htmlFor=id; lab.textContent = txt;
        c.addEventListener('change', function(){
          var arr = targetObj[arrayKey];
          if (c.checked){ if (arr.indexOf(k)===-1) arr.push(k); }
          else { targetObj[arrayKey] = arr.filter(function(x){ return x!==k; }); }
          save();
        });
        li.appendChild(c); li.appendChild(lab); list.appendChild(li);
      });
    } else {
      Object.keys(map).forEach(function(k){
        var txt = map[k];
        var id = "ck_"+k+"_"+Math.random().toString(36).slice(2,7);
        var li = document.createElement('li'); li.className="ck-row";
        var c = document.createElement('input'); c.type="checkbox"; c.id=id; c.checked = !!targetObj[k];
        var lab = document.createElement('label'); lab.htmlFor=id; lab.textContent = txt;
        c.addEventListener('change', function(){ targetObj[k] = c.checked; save(); });
        li.appendChild(c); li.appendChild(lab); list.appendChild(li);
      });
    }
    box.appendChild(list); return box;
  }

  function typeBox(label, placeholder, onSave){
    var box = document.createElement('div'); box.className="inlinebox";
    var id = "tb_"+Math.random().toString(36).slice(2,7);
    box.innerHTML = '<label for="'+id+'" style="font-weight:800">'+label+'</label>';
    var i = document.createElement('input');
    i.id=id; i.placeholder = placeholder||"Type here";
    i.addEventListener('input', function(){
      var v = (i.value||"");
      try{ if (typeof onSave === "function") onSave(v); } finally { setSaveHint("Draft saved"); }
    });
    box.appendChild(i);
    return box;
  }

  function renderReview(){
    var wrap = document.createElement('div'); wrap.className="review";
    function sect(title, pairs){
      var d = document.createElement('details'); d.className="card"; d.open = true;
      var s = document.createElement('summary'); s.textContent = title; d.appendChild(s);
      var kv = document.createElement('div'); kv.className="kv";
      pairs.forEach(function(pair){
        var k=pair[0], v=pair[1];
        var row = document.createElement('div'); var b = document.createElement('b'); b.textContent = k;
        var span = document.createElement('span'); span.textContent = (v===null||v===undefined||v==="")?"‚Äî":v;
        row.appendChild(b); row.appendChild(span); kv.appendChild(row);
      });
      d.appendChild(kv); return d;
    }
    function mapRequired(arr, other){
      var map = { personal_care:"Personal care", high_intensity:"High-intensity personal care", household_tasks:"Household tasks",
                  life_skills:"Development of life skills", community_participation:"Community participation", group_centre:"Group/centre-based activities",
                  travel_transport:"Assist with travel & transport", daily_tasks_sil:"Daily tasks & shared living", not_sure:"Not sure ‚Äî guide me" };
      var list = (arr||[]).map(function(k){ return map[k]||k; }).filter(Boolean);
      if (other) list.push("Other: "+other);
      return list.length ? list.join(", ") : "‚Äî";
    }
    function listTrue(obj, keys){
      var map = {wounds:"Wounds/dressings", diabetes:"Diabetes", tracheostomy:"Tracheostomy", tube_feeding:"Enteral feeding", mental_health:"Mental health", stoma_care:"Stoma care",
                 animals:"Reactive animals", hoarding:"Hoarding", weapons:"Weapons"};
      var list = keys.filter(function(k){ return obj[k]===true; }).map(function(k){ return map[k]||k; });
      return list.length? list.join(", ") : "‚Äî";
    }
    function mapWindows(arr){ var m={w1:"Weekday AM",w2:"Weekday PM",w3:"Evenings",w4:"Weekends"}; return (arr||[]).map(function(k){return m[k];}).filter(Boolean).join(", ")||"‚Äî"; }
    function mapDays(arr){ var m={d1:"Mon",d2:"Tue",d3:"Wed",d4:"Thu",d5:"Fri",d6:"Sat",d7:"Sun"}; return (arr||[]).map(function(k){return m[k];}).filter(Boolean).join(", ")||"‚Äî"; }

    wrap.appendChild(sect("Who is completing", [
      ["Role", S.caller.role],["Name", S.caller.name],["Relationship", S.caller.relationship],["Consent", S.caller.consent]
    ]));
    wrap.appendChild(sect("Participant", [
      ["Legal name", S.participant.legal_name],["Preferred name", S.participant.preferred_name],["Pronouns", S.participant.pronouns],["DOB", S.participant.dob],["NDIS number", S.participant.ndis_number],
      ["Address", [S.participant.address.line1,S.participant.address.line2,S.participant.address.suburb,S.participant.address.state,S.participant.address.postcode].filter(Boolean).join(", ")||"‚Äî"],
      ["Plan management", S.participant.plan_mgmt],
      ["Plan manager", [S.participant.plan_manager.org,S.participant.plan_manager.contact,S.participant.plan_manager.email,S.participant.plan_manager.phone].filter(Boolean).join(" ‚Ä¢ ")||"‚Äî"],
      ["Plan dates", [S.participant.plan_dates.start,S.participant.plan_dates.end].filter(Boolean).join(" ‚Üí ")||"‚Äî"]
    ]));
    wrap.appendChild(sect("Supports (required)", [
      ["Selected", mapRequired(S.supports.required, S.supports.required_other)],
      ["Specific support details", S.supports.details_text],
      ["Goals", S.supports.goals],
      ["Preferred outcomes", S.supports.outcomes]
    ]));
    wrap.appendChild(sect("Communication & preferences", [
      ["Language", S.comms.primary_language],["Interpreter", S.comms.interpreter],["Interpreter language", S.comms.interpreter_language],
      ["Cultural considerations", S.comms.cultural_considerations],
      ["Worker gender pref.", S.comms.preferences.worker_gender || S.comms.preferences.worker_gender_other || "‚Äî"],
      ["Transport required", S.comms.preferences.transport_required||"‚Äî"]
    ]));
    wrap.appendChild(sect("Contacts", [
      ["Email", S.contacts.email],["Phone", S.contacts.phone],
      ["Emergency contact", [S.contacts.emergency.name,S.contacts.emergency.relationship,S.contacts.emergency.phone].filter(Boolean).join(" ‚Ä¢ ")||"‚Äî"],
      ["Support Coordinator", [S.contacts.support_coordinator.name,S.contacts.support_coordinator.org,S.contacts.support_coordinator.email,S.contacts.support_coordinator.phone].filter(Boolean).join(" ‚Ä¢ ")||"‚Äî"],
      ["GP", [S.contacts.gp.name,S.contacts.gp.practice,S.contacts.gp.phone,S.contacts.gp.email].filter(Boolean).join(" ‚Ä¢ ")||"‚Äî"]
    ]));
    wrap.appendChild(sect("Living & access", [
      ["Residence type", S.living.residence_type],["Lives with", S.living.lives_with],["Entry notes", S.living.entry_notes],
      ["Keysafe", S.living.keysafe],["Smoking", S.living.smoking_on_premises],["Hazards", S.living.hazards]
    ]));
    wrap.appendChild(sect("Health & clinical", [
      ["Primary diagnoses", S.clinical.primary_diagnoses],["Other diagnoses", S.clinical.other_diagnoses],["Allergies", S.clinical.allergies],
      ["Mobility", S.clinical.mobility],["Equipment", S.clinical.equipment],["Continence", S.clinical.continence],["Cognition", S.clinical.cognition],
      ["Pressure injury risk", S.clinical.pressure_injury_risk],["Falls risk", S.clinical.falls_risk],
      ["Seizures", S.clinical.seizures.has===true?"Yes":S.clinical.seizures.has===false?"No":(S.clinical.seizures.has===null?"Not sure":"‚Äî")],
      ["Seizure plan", S.clinical.seizures.plan],["Seizure frequency", S.clinical.seizures.frequency],
      ["Stoma/ostomy care", (S.clinical.stoma_care===true?"Yes":S.clinical.stoma_care===false?"No":(S.clinical.stoma_care||"‚Äî"))],
      ["Diet / swallowing", S.clinical.diet_notes]
    ]));
    wrap.appendChild(sect("Risks", [
      ["Behavioural", S.risks.behavioural.present],["Behaviour notes", S.risks.behavioural.notes],
      ["Clinical concerns", listTrue(S.risks.clinical, ["wounds","diabetes","tracheostomy","tube_feeding","mental_health","stoma_care"])],
      ["Clinical other", S.risks.clinical.other],
      ["Environmental", listTrue(S.risks.environmental, ["animals","hoarding","weapons"])],
      ["Environmental other", S.risks.environmental.other],
      ["Home risks", listTrue(S.risks.home_checklist, ["trip_hazards","smoke_alarms","lighting","bathroom_safety"])],
      ["Home notes", S.risks.home_checklist.notes],
      ["Other risk notes", S.risks.other_notes],["Overall rating", S.risks.overall_rating]
    ]));
    function mapWindows(arr){ var m={w1:"Weekday AM",w2:"Weekday PM",w3:"Evenings",w4:"Weekends"}; return (arr||[]).map(function(k){return m[k];}).filter(Boolean).join(", ")||"‚Äî"; }
    function mapDays(arr){ var m={d1:"Mon",d2:"Tue",d3:"Wed",d4:"Thu",d5:"Fri",d6:"Sat",d7:"Sun"}; return (arr||[]).map(function(k){return m[k];}).filter(Boolean).join(", ")||"‚Äî"; }
    wrap.appendChild(sect("Supports & schedule", [
      ["Windows", mapWindows(S.schedule.windows)],["Days", mapDays(S.schedule.days)],
      ["Hours/week", S.schedule.hours_per_week],["Urgency", S.schedule.urgency],["Start pref.", S.schedule.start_preference]
    ]));
    var cons = (S.emergency_advocacy===undefined||S.emergency_advocacy===null||S.emergency_advocacy==="") ? "‚Äî" : (S.emergency_advocacy==="Yes"?"Yes":S.emergency_advocacy==="No"?"No":"Not sure");
    wrap.appendChild(sect("Consents", [["Emergency advocacy consent", cons]]));
    wrap.appendChild(sect("Uploads", [["Files selected", (S.uploads.files||[]).map(function(f){return f.name;}).join(" ‚Ä¢ ") || "‚Äî"]]));
    return wrap;
  }

  /* ===== Document modal ===== */
  function openDoc(title, href){
    var modal = document.getElementById('docModal');
    var docTitle = document.getElementById('docTitle');
    var docViewer = document.getElementById('docViewer');
    var docDownload = document.getElementById('docDownload');
    docTitle.textContent = title;
    docViewer.src = href;
    docDownload.href = href;
    modal.classList.add('open');
    modal.setAttribute('aria-hidden','false');
    document.getElementById('docClose').addEventListener('click', closeDoc);
    modal.addEventListener('click', function(e){ if (e.target===modal) closeDoc(); });
    function closeDoc(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
      docViewer.src = "";
    }
  }

  function buildPayload(){ var p = cloneSafe(S); p.timestamp = new Date().toISOString(); return p; }
  function openPrintableSummary(){ /* optional */ }

  function mapRequiredForSummary(arr, other){
    var map = { personal_care:"Personal care", high_intensity:"High-intensity personal care", household_tasks:"Household tasks",
                life_skills:"Development of life skills", community_participation:"Community participation",
                group_centre:"Group/centre-based activities", travel_transport:"Assist with travel & transport",
                daily_tasks_sil:"Daily tasks & shared living", not_sure:"Not sure ‚Äî guide me" };
    var list = (arr||[]).map(function(k){ return map[k]||k; }).filter(Boolean);
    if (other) list.push("Other: "+other);
    return list.length ? list.join(", ") : "";
  }
  function mapWindowsSummary(arr){ var m={w1:"Weekday AM",w2:"Weekday PM",w3:"Evenings",w4:"Weekends"}; return (arr||[]).map(function(k){return m[k];}).filter(Boolean).join(", "); }
  function mapDaysSummary(arr){ var m={d1:"Mon",d2:"Tue",d3:"Wed",d4:"Thu",d5:"Fri",d6:"Sat",d7:"Sun"}; return (arr||[]).map(function(k){return m[k];}).filter(Boolean).join(", "); }

  function canSubmitContacts(){
    var hasEmail = S.submitter.email && S.submitter.email.trim();
    var hasPhone = S.submitter.phone && S.submitter.phone.trim();
    return !!(hasEmail || hasPhone);
  }

  function sendToFormspree(){
    var policyAck = {
      handbook:  !!(S.acks && S.acks.handbook && S.acks.handbook.read),
      incident:  !!(S.acks && S.acks.incident_ack && S.acks.incident_ack.read),
      complaints:!!(S.acks && S.acks.complaints_feedback && S.acks.complaints_feedback.read)
    };
    var payload = {
      caller:S.caller, participant:S.participant, contacts:S.contacts, comms:S.comms,
      living:S.living, clinical:S.clinical, medications:S.medications, risks:S.risks,
      bsp:S.bsp, supports:S.supports, schedule:S.schedule,
      policy_ack: policyAck,
      acks:S.acks, emergency_advocacy:S.emergency_advocacy,
      submitter:S.submitter, notes:S.notes, timestamp:new Date().toISOString(),
      _meta:{ app:"AILR", version:"v16" }
    };
    try{
      var addr = S.participant && S.participant.address ? [
        S.participant.address.line1, S.participant.address.line2,
        S.participant.address.suburb, S.participant.address.state, S.participant.address.postcode
      ].filter(Boolean).join(", ") : "";
      var contactSummary = [(S.contacts.email||""),(S.contacts.phone?(" ‚Ä¢ "+S.contacts.phone):"")].join("");
      payload.supports.required_summary   = mapRequiredForSummary(S.supports.required, S.supports.required_other);
      payload.supports.details_text       = S.supports.details_text || "";
      payload.schedule.windows_summary    = mapWindowsSummary(S.schedule.windows);
      payload.schedule.days_summary       = mapDaysSummary(S.schedule.days);
      payload.participant.address_summary = addr;
      payload.contacts.contact_summary    = contactSummary;
    }catch(e){}

    return fetch(GS_WEBAPP, {
      method: "POST", headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    }).then(async function(r){
      var j = await r.json().catch(()=>({}));
      if (!r.ok || j.status!=='ok') throw new Error(j && j.message ? j.message : "Server error");
      return j;
    }).catch(function(){
      return fetch(GS_WEBAPP, { method:"POST", mode:"no-cors", body: JSON.stringify(payload) })
        .then(function(){ return { status:'ok', fileUrl:null, _opaque:true }; });
    });
  }

  /* =======================
     NAVIGATION + TRANSITIONS
     ======================= */
  function hasConsentYes(){ return S.caller && S.caller.consent === "Yes"; }
  function clampIndexByConsent(idx){ return (!hasConsentYes() && idx > 1) ? 1 : idx; }
  function transitionTo(target){
    target = clampIndexByConsent(target);
    var dir = target > S.i ? 'forward' : 'back';
    stageInner.classList.remove('slide-in-left','slide-in-right');
    stageInner.classList.add(dir==='forward'?'slide-out-left':'slide-out-right');
    setTimeout(function(){
      S.i = target;
      render(); // re-render content
      stageInner.classList.remove('slide-out-left','slide-out-right');
      stageInner.classList.add(dir==='forward'?'slide-in-right':'slide-in-left');
      setTimeout(function(){
        stageInner.classList.remove('slide-in-left','slide-in-right');
      }, 360);
    }, 220);
  }

  function buildNavigation(){
    navList.innerHTML = "";
    Steps.forEach(function(step, index){
      var li = document.createElement('li');
      li.className = 'nav-item';
      li.setAttribute('data-step', index);
      li.textContent = (index + 1) + '. ' + step.title;
      li.addEventListener('click', function(){
        if (!hasConsentYes() && index > 1){
          alert('Please complete Step 2 (Consent) with "Yes" before proceeding.');
          transitionTo(1);
          return;
        }
        transitionTo(index);
      });
      navList.appendChild(li);
    });
    updateNavigationUI();
  }

  function updateNavigationUI(){
    var items = navList.querySelectorAll('.nav-item');
    items.forEach(function(item){
      var idx = parseInt(item.getAttribute('data-step'),10);
      item.classList.remove('current','completed','locked');
      if (!hasConsentYes() && idx > 1){
        item.classList.add('locked');
        if (!item.querySelector('.lock')){
          var lock = document.createElement('span');
          lock.className = 'lock';
          lock.textContent = 'üîí';
          item.appendChild(lock);
        }
      }else{
        var lk = item.querySelector('.lock'); if (lk) lk.remove();
      }
      if (idx === S.i) item.classList.add('current');
      else if (idx < S.i) item.classList.add('completed');
    });
  }
  function updateNavigationLocks(){ updateNavigationUI(); }

  function render(){
    var total = Steps.length;
    if (S.i<0) S.i=0; if (S.i>=total) S.i = total-1; S.i = clampIndexByConsent(S.i);

    var step = Steps[S.i];
    stepTxt.textContent = "Step " + (S.i+1) + "/" + total;
    barEl.style.width = Math.round((S.i)/(total-1)*100) + "%";

    qEl.innerHTML = step.title;
    subEl.innerHTML = step.sub || "";
    optsEl.innerHTML = "";
    try { step.build(optsEl); } catch(e){ optsEl.innerHTML = "<div class='inlinebox'><div class='danger'>There was an error rendering this step.</div></div>"; }

    nextBtn.style.display = (S.i === total-1) ? "none" : "inline-block";

    save();
    updateNavigationUI();
  }

  /* ======= Validation & Buttons ======= */
  function canProceed(idx){
    var key = Steps[idx].key;
    if (key==="caller"){
      if (S.caller.consent!=="Yes"){ alert("We‚Äôre unable to proceed without consent. Please select ‚ÄúYes‚Äù to continue."); return false; }
    }
    if (key==="participant"){
      var p=S.participant, a=p.address;
      if (!has(p.legal_name)){ alert("Please enter the participant‚Äôs Legal name."); return false; }
      if (!has(p.dob)){ alert("Please add Date of birth."); return false; }
      if (!has(a.line1)||!has(a.suburb)||!has(a.postcode)||!has(a.state)){
        alert("Please complete Address line 1, Suburb, Postcode, and State."); return false;
      }
    }
    if (key==="contacts"){
      if (!has(S.contacts.email) && !has(S.contacts.phone)){
        alert("Please provide at least one contact method: Email or Phone."); return false;
      }
    }
    if (key==="clinical"){
      if (!has(S.clinical.allergies)){
        alert("Allergies is required. If none, please write ‚ÄúNo known allergies‚Äù.");
        return false;
      }
    }
    if (key==="supports"){
      var anyReq=(S.supports.required||[]).length>0 || has(S.supports.required_other) || has(S.supports.details_text);
      if (!anyReq){ alert("Please select at least one required support or type a specific support detail."); return false; }
    }
    if (key==="schedule"){
      var someWindow=(S.schedule.windows||[]).length>0, someDay=(S.schedule.days||[]).length>0, hours=Number(S.schedule.hours_per_week||0);
      if (!someWindow && !someDay && !(hours>0)){ alert("Please select at least one time window or day, or provide Hours per week."); return false; }
    }
    if (key==="policies"){
      for (var i=0;i<DOCS.length;i++){
        var d = DOCS[i], ack = S.acks[d.id]||{};
        if (!ack.read){ alert("Please tick that you have received & read: " + d.title); return false; }
        if (d.requiresConsent && !ack.consent){ alert("Please tick consent for: " + d.title); return false; }
      }
    }
    return true;
  }
  function str(v){ return (v||"").toString().trim(); }
  function has(v){ return str(v).length>0; }

  backBtn.addEventListener('click', function(){
    var target = S.i - 1; if (target < 0) return; transitionTo(target);
  });
  nextBtn.addEventListener('click', function(){
    if (Steps[S.i].key === "caller" && S.caller.consent !== "Yes"){
      alert('We‚Äôre unable to proceed without consent. Please select ‚ÄúYes‚Äù to continue.'); return;
    }
    if (!canProceed(S.i)) return;
    transitionTo(S.i + 1);
  });
  saveExitBtn.addEventListener('click', function(){ save(); alert("Saved. You can close this page and return later on the same device."); });

  /* ===== Parallax glow for container ===== */
  document.addEventListener('mousemove', function(e){
    // set CSS vars for glow center
    var x = (e.clientX / window.innerWidth) * 100;
    var y = (e.clientY / window.innerHeight) * 100;
    document.documentElement.style.setProperty('--mx', x + '%');
    document.documentElement.style.setProperty('--my', y + '%');
  });
  function tiltCard(el, e){
    var r = el.getBoundingClientRect();
    var dx = (e.clientX - (r.left + r.width/2)) / r.width;
    var dy = (e.clientY - (r.top + r.height/2)) / r.height;
    el.style.transform = 'rotateX(' + (-dy*6) + 'deg) rotateY(' + (dx*6) + 'deg) translateY(-2px)';
  }

  /* ===== Confetti ===== */
  var confettiCanvas = document.getElementById('confetti');
  var ctx = confettiCanvas.getContext('2d');
  var confettiParticles = [];
  function resizeConfetti(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
  window.addEventListener('resize', resizeConfetti); resizeConfetti();

  function confettiBurst(){
    confettiCanvas.style.display = 'block';
    confettiParticles = [];
    var count = 240;
    for (var i=0;i<count;i++){
      confettiParticles.push({
        x: Math.random()*confettiCanvas.width,
        y: -20 - Math.random()*confettiCanvas.height*0.4,
        r: 3 + Math.random()*5,
        vx: -2 + Math.random()*4,
        vy: 2 + Math.random()*3,
        a: Math.random()*360,
        va: -6 + Math.random()*12,
        color: i%5===0 ? '#ec4899' : i%5===1 ? '#4f46e5' : i%5===2 ? '#06b6d4' : i%5===3 ? '#fbbf24' : '#3b82f6',
        life: 180 + Math.random()*60
      });
    }
    requestAnimationFrame(drawConfetti);
    setTimeout(function(){ confettiCanvas.style.display='none'; }, 2500);
  }
  function drawConfetti(){
    ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    confettiParticles.forEach(function(p){
      p.x += p.vx; p.y += p.vy; p.a += p.va; p.vy += 0.03; p.life--;
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.a * Math.PI/180);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
      ctx.restore();
    });
    confettiParticles = confettiParticles.filter(p=>p.life>0 && p.y < confettiCanvas.height+40);
    if (confettiParticles.length>0) requestAnimationFrame(drawConfetti);
  }

  /* ===== Build nav + initial render ===== */
  buildNavigation();
  try{ render(); }
  catch(e){
    var stage = document.querySelector("main.stage");
    if (stage){
      stage.innerHTML = '<div class="q">There was an error initialising the form.</div><p class="sub">If this persists, please open the page in a modern browser (Chrome/Edge/Safari ‚â• 13).</p>';
    }
  }
}); // DOMContentLoaded
</script>
</body>
</html>
