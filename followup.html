<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HD HeeD â€” NDIS Weekly Follow-up Board</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet"/>
<style>
  :root{
    --ink:#0c1226; --bg:#0b0f1a; --panel:#10172a; --line:#243153; --text:#e8edff; --muted:#a8b6e8; --accent:#ffc107;
    --good:#31d0aa; --warn:#ffd95c; --danger:#ff5d5d;
  }
  * { box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0; font-family:Inter,system-ui,Arial,sans-serif;
    color:var(--text); background:radial-gradient(1200px 1200px at 80% -200px,#122048 0%,#0b0f1a 42%,#0b0f1a 100%);
    padding:24px;
  }
  .shell{
    max-width:1200px; margin:0 auto; background:linear-gradient(180deg,#10172a,#0b0f1a);
    border:1px solid var(--line); border-radius:18px; box-shadow:0 28px 110px rgba(0,0,0,.55);
    overflow:hidden;
  }
  .head{
    display:flex; align-items:center; gap:12px; padding:16px 18px;
    border-bottom:1px solid var(--line); background:linear-gradient(180deg,#0e162f,#0c1329);
    position:sticky; top:0; z-index:2;
  }
  .badge{
    width:42px;height:42px;border-radius:10px;display:grid;place-items:center;
    font-weight:900; color:#2a2100; background:linear-gradient(135deg,#ffd95c,#ffe78f);
    box-shadow:0 8px 24px rgba(0,0,0,.35);
  }
  .title{ font-weight:900; font-size:1.15rem; letter-spacing:.2px; }
  .sub{ font-size:.88rem; color:var(--muted); }
  .toolbar{ margin-left:auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .pill{ border:1px solid var(--line); background:#0f1937; border-radius:999px; padding:6px 10px; font-size:.78rem; color:#cfe0ff; }
  .btn{
    border:1px solid var(--line); background:#0f1b3b; color:var(--text);
    border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer;
  }
  .btn.primary{ background:var(--accent); color:#2a2100; border-color:#e0b200; box-shadow:0 12px 34px rgba(0,0,0,.35); }
  .btn.warn{ background:#351616; border-color:#6e1c1c; color:#ffdcdc; }
  .btn.ghost{ background:#0f1937; }
  .btn:disabled{ opacity:.55; cursor:not-allowed; }
  .status{ font-size:.8rem; color:var(--muted); }
  .wrap{ padding:16px; }
  .board{ border:1px solid var(--line); background:#0e162e; border-radius:16px; overflow:auto; }
  table{ border-collapse:separate; border-spacing:0; width:100%; min-width:1100px; }
  th,td{ border-bottom:1px solid var(--line); border-right:1px solid var(--line); padding:10px; vertical-align:top; }
  th:first-child, td:first-child{ border-left:1px solid var(--line); }
  thead th{
    position:sticky; top:0; background:#0d1428; color:#fff; font-weight:900; font-size:.96rem; z-index:1;
  }
  tbody th{
    background:linear-gradient(180deg,#101a3c,#0e162f); text-align:left; font-weight:800; white-space:nowrap; min-width:380px;
  }
  /* Lead cell */
  .lead{ display:flex; flex-direction:column; gap:6px; }
  .lead .name{ font-weight:900; color:#ffe28f; }
  .lead .meta{ display:flex; gap:12px; flex-wrap:wrap; font-size:.85rem; color:#cfe0ff; }
  .lead .meta a{ color:#aee6ff; text-decoration:none; border-bottom:1px dotted rgba(174,230,255,.35); padding-bottom:1px; }
  .lead .meta a:hover{ color:#fff; border-bottom-color:#fff; }
  /* Compact day cell (no distortion) */
  .cell{
    background:#0f1b3b; border:1px solid #2a3b68; border-radius:10px; padding:8px;
    min-height:48px; display:flex; align-items:center; justify-content:space-between; gap:8px; cursor:pointer;
  }
  .cell .preview{ flex:1; max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#d8e2ff; opacity:.95; }
  .cell .badge{ font-size:12px; border:1px solid #35508a; background:#0f254f; color:#cfe0ff; border-radius:999px; padding:4px 8px; }
  .cell.empty .badge{ opacity:.6 }
  .cell.empty .preview{ color:#9fb0e6; opacity:.7 }
  .cell:hover{ box-shadow:0 0 0 2px rgba(255,209,64,.25); }
  /* Modal */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(2,6,22,.58); backdrop-filter: blur(2px);
    display:none; align-items:center; justify-content:center; z-index:1000;
  }
  .modal{
    width:min(900px, 94vw); max-height:85vh; background:linear-gradient(180deg,#10172a,#0b0f1a);
    border:1px solid var(--line); border-radius:16px; box-shadow:0 28px 110px rgba(0,0,0,.6); display:flex; flex-direction:column;
  }
  .modal-head{ display:flex; gap:10px; align-items:center; padding:12px 14px; border-bottom:1px solid var(--line); }
  .modal-title{ font-weight:900; }
  .modal-close{ margin-left:auto; border:1px solid var(--line); background:#0f1b3b; color:#fff; border-radius:999px; padding:6px 10px; cursor:pointer; }
  .modal-body{ padding:12px 14px; }
  .modal-body textarea{ width:100%; min-height:44vh; border:1px solid #2a3b68; border-radius:10px; padding:10px; background:#0f1b3b; color:#e8edff; resize:vertical; font-family:inherit; font-size:1rem; }
  .modal-foot{ padding:12px 14px; border-top:1px dashed var(--line); display:flex; gap:8px; justify-content:flex-end; }
  .kbd{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:.82rem; padding:2px 6px; border:1px solid #344; border-radius:6px; background:#0f1b3b; color:#cfe0ff; }
  @media (max-width:820px){
    .title{ font-size:1rem; }
    tbody th{ min-width:300px; }
  }
  @media print{ .toolbar, .foot, .modal-backdrop{ display:none !important; } }
  /* Cleaner buttons at far right */
  .foot{ border-top:1px dashed var(--line); padding:12px 18px; display:flex; gap:10px; align-items:center; justify-content:space-between; }
  .cleaner{ margin-left:auto; display:flex; gap:8px; align-items:center; }
</style>
</head>
<body>
  <div class="shell">
    <div class="head">
      <div class="badge">HD</div>
      <div>
        <div class="title">HD HeeD â€” NDIS Weekly Follow-up Board</div>
        <div class="sub">Support Coordinators & Plan Managers â€¢ Blacktown & Western Sydney</div>
      </div>
      <div class="toolbar">
        <button id="btnRefresh" class="btn">ðŸ”„ Refresh</button>
        <button id="btnSave" class="btn primary">ðŸ’¾ Save changes</button>
        <span id="status" class="status"></span>
        <span class="pill">Shared â€¢ Live</span>
      </div>
    </div>

    <div class="wrap">
      <div class="board">
        <table id="board">
          <thead>
            <tr>
              <th style="width:380px">Lead (SC/PM)</th>
              <th>Monday</th><th>Tuesday</th><th>Wednesday</th>
              <th>Thursday</th><th>Friday</th><th>Saturday</th><th>Sunday</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="hint">Click a day cell to open the full note. Press <span class="kbd">Esc</span> or click outside to close. Click <strong>Save changes</strong> to sync with the Sheet.</div>
    </div>

    <div class="foot">
      <div class="status" id="footStatus">Ready.</div>
      <div class="cleaner">
        <span class="status">Fresh week reset:</span>
        <button id="btnArmClean" class="btn ghost">1) Arm</button>
        <button id="btnDoClean" class="btn warn" disabled>2) Confirm &amp; wipe</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div id="modalTitle" class="modal-title">Edit note</div>
        <button id="modalClose" class="modal-close">âœ• Close</button>
      </div>
      <div class="modal-body">
        <textarea id="modalTextarea" placeholder="Type your noteâ€¦"></textarea>
      </div>
      <div class="modal-foot">
        <button id="modalSave" class="btn primary">ðŸ’¾ Apply to cell</button>
      </div>
    </div>
  </div>

<script>
  // === Your Apps Script Web App (/exec) ===
  const API = "https://script.google.com/macros/s/AKfycbzwXW3Aabus6brnuawF9QvXX4dpq3MM03jmi4e9rkpiJUs2B9Vo_Qp36ht5BZ7bgbM/exec";

  // === Contact details shown in the first column (names must match Sheet col A) ===
  const CONTACTS = {
    "Taylor McGuiness â€” Interaction": {
      phone: "1300 668 123", email: "info@interactionservices.org", website: "https://interactionservices.org"
    },
    "Assist Disability Services â€” SSC": {
      phone: "1800 955 806", email: "enquiries@assistservices.com.au", website: "https://assistservices.com.au"
    },
    "Triniti Care â€” Support Coord": { phone: "(02) 8319 9433", website: "https://triniticare.com.au" },
    "MD Home Care â€” SSC": { phone: "08 6386 9999", website: "https://mdhomecare.com.au" },
    "Claremont Care â€” SC/PM": { phone: "0416 873 319", website: "https://claremontcare.com.au" },
    "BRK Plan Management": { phone: "0414 704 279", email: "meet@brkpm.com.au", website: "http://brkpm.com.au" },
    "Axial Plan Management": { phone: "0416 428 261", email: "hello@axialplanmanagement.com.au", website: "https://axialplanmanagement.com.au" },
    "NADO Plan Management": { phone: "1300 738 229", website: "https://nado.org.au" },
    "Yahweh Care â€” PM": { phone: "(02) 8325 1616", email: "info@yahwehcare.com.au", website: "https://yahwehcare.com.au" }
  };

  let ROWS = [];              // [["Lead","Mon","Tue",...], ...]
  let edits = new Map();      // key "r_c" â†’ value string
  let activeCellId = null;    // which cell is open in modal

  function $(id){ return document.getElementById(id); }
  function setStatus(msg, dim=false){ $("status").textContent = msg||""; $("status").classList.toggle("dim", !!dim); $("footStatus").textContent = msg||"Ready."; }

  function mail(link){ const a=document.createElement("a"); a.href="mailto:"+link; a.textContent="ðŸ“§ "+link; return a; }
  function tel(link){ const a=document.createElement("a"); a.href="tel:"+(link||"").replace(/[^0-9+]/g,""); a.textContent="â˜Ž "+link; return a; }

  function formatLeadCell(name){
    const wrap = document.createElement("div"); wrap.className="lead";
    const nm = document.createElement("div"); nm.className="name"; nm.textContent = name||"â€”"; wrap.appendChild(nm);
    const info = CONTACTS[name];
    if (info){
      const meta = document.createElement("div"); meta.className="meta";
      if (info.email) meta.appendChild(mail(info.email));
      if (info.phone) meta.appendChild(tel(info.phone));
      if (info.website){ const w=document.createElement("a"); w.href=info.website; w.target="_blank"; w.rel="noopener"; w.textContent="ðŸŒ Website"; meta.appendChild(w); }
      wrap.appendChild(meta);
    }
    return wrap;
  }

  // === Modal control ===
  const modal = $("modalBackdrop");
  const modalTA = $("modalTextarea");
  function openModal(id, title, initial){
    activeCellId = id;
    $("modalTitle").textContent = title || "Edit note";
    modalTA.value = initial || "";
    modal.style.display = "flex";
    modal.setAttribute("aria-hidden","false");
    modalTA.focus();
  }
  function closeModal(){
    modal.style.display = "none";
    modal.setAttribute("aria-hidden","true");
    activeCellId = null;
  }
  $("modalClose").addEventListener("click", closeModal);
  modal.addEventListener("click", (e)=>{ if (e.target===modal) closeModal(); });
  document.addEventListener("keydown", (e)=>{ if (e.key==="Escape" && modal.getAttribute("aria-hidden")==="false") closeModal(); });
  $("modalSave").addEventListener("click", ()=>{
    if (!activeCellId) return;
    const v = modalTA.value || "";
    const el = document.getElementById("cell-"+activeCellId);
    const ta = document.getElementById("ta-"+activeCellId);
    if (ta) ta.value = v;
    const pv = el.querySelector(".preview");
    const bd = el.querySelector(".badge");
    pv.textContent = v ? v.replace(/\s+/g,' ').trim() : "Empty";
    el.classList.toggle("empty", !v);
    bd.textContent = v ? "Filled" : "Empty";
    edits.set(activeCellId, v);
    setStatus("Unsaved changesâ€¦");
    closeModal();
  });

  // === Load & Build ===
  async function load(){
    try{
      setStatus("Loadingâ€¦");
      const r = await fetch(API, { method:"GET" });
      if (!r.ok) throw new Error("Could not load. Check the API URL and deployment access is set to 'Anyone'.");
      const data = await r.json();
      ROWS = data;
      buildTable();
      setStatus("Loaded.", true);
    }catch(err){
      console.error(err);
      setStatus(err.message || "Load failed.");
      alert(err.message || "Load failed. In Apps Script: Deploy â†’ Web app â†’ Who has access = 'Anyone'.");
    }
  }

  function buildTable(){
    const tb = $("tbody");
    tb.innerHTML = "";
    edits.clear();
    for (let r=1; r<ROWS.length; r++){ // skip header
      const row = ROWS[r];
      const lead = row[0] || "";
      const tr = document.createElement("tr");

      const th = document.createElement("th");
      th.appendChild(formatLeadCell(lead));
      tr.appendChild(th);

      for (let c=0; c<7; c++){ // Mon..Sun
        const id = `${r-1}_${c}`;
        const td = document.createElement("td");

        // Hidden store
        const ta = document.createElement("textarea");
        ta.id = "ta-"+id;
        ta.style.display = "none";
        ta.value = row[c+1] || "";

        // Compact UI
        const cell = document.createElement("div");
        cell.className = "cell";
        if (!ta.value) cell.classList.add("empty");
        cell.id = "cell-"+id;
        const preview = document.createElement("div");
        preview.className = "preview";
        preview.textContent = ta.value ? ta.value.replace(/\s+/g,' ').trim() : "Empty";
        const badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent = ta.value ? "Filled" : "Empty";

        cell.appendChild(preview);
        cell.appendChild(badge);

        cell.addEventListener("click", ()=>{
          const day = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][c];
          openModal(id, `${lead} â€” ${day}`, ta.value);
        });

        td.appendChild(cell);
        td.appendChild(ta);
        tr.appendChild(td);
      }
      tb.appendChild(tr);
    }
  }

  // === Save to Sheet (CORS-safe: text/plain) ===
  async function save(){
    if (edits.size===0) { setStatus("No changes to save.", true); return; }
    try{
      setStatus("Savingâ€¦");
      const rows = [];
      edits.forEach((value, key)=>{ const [ri, ci] = key.split("_").map(Number); rows.push({ rowIndex: ri, colIndex: ci, value }); });
      const resp = await fetch(API, { method:"POST", headers:{"Content-Type":"text/plain"}, body: JSON.stringify({rows}) });
      const txt = await resp.text();
      let ok = null; try { ok = JSON.parse(txt); } catch(e) {}
      if (!resp.ok || !ok || !ok.ok) throw new Error(`Save failed (status ${resp.status}): ${txt.substring(0,200)}`);
      setStatus("Saved.", true);
      edits.clear();
    }catch(err){
      console.error(err);
      setStatus("Save failed.");
      alert(err.message || "Save failed. In Apps Script: Deploy â†’ Web app â†’ set 'Who has access' to 'Anyone' and use the /exec URL.");
    }
  }

  $("btnRefresh").addEventListener("click", load);
  $("btnSave").addEventListener("click", save);

  // === Dual-button cleanup (Arm + Confirm within 8s) ===
  let armTimeout = null;
  $("btnArmClean").addEventListener("click", ()=>{
    if (armTimeout) clearTimeout(armTimeout);
    $("btnDoClean").disabled = false;
    $("btnArmClean").textContent = "Armed (8s)â€¦";
    setStatus("Cleanup armed â€” press Confirm to wipe all notes (names stay).");
    armTimeout = setTimeout(()=>{
      $("btnDoClean").disabled = true;
      $("btnArmClean").textContent = "1) Arm";
      setStatus("Cleanup disarmed.", true);
    }, 8000);
  });

  $("btnDoClean").addEventListener("click", async ()=>{
    if ($("btnDoClean").disabled) return;
    const updates = [];
    for (let r=1; r<ROWS.length; r++){ // skip header
      for (let c=0; c<7; c++){ // Mon..Sun
        const id = `${r-1}_${c}`;
        const el = document.getElementById("cell-"+id);
        const ta = document.getElementById("ta-"+id);
        if (ta && (ta.value!=="" || el.classList.contains("empty")===false)) {
          ta.value = "";
          if (el) {
            el.classList.add("empty");
            const pv = el.querySelector(".preview"); if (pv) pv.textContent = "Empty";
            const bd = el.querySelector(".badge"); if (bd) bd.textContent = "Empty";
          }
          edits.set(id, "");
          updates.push({ rowIndex: r-1, colIndex: c, value: "" });
        }
      }
    }
    if (armTimeout) clearTimeout(armTimeout);
    $("btnDoClean").disabled = true;
    $("btnArmClean").textContent = "1) Arm";

    if (updates.length===0) { setStatus("Nothing to clear.", true); return; }

    try {
      setStatus("Wiping all notes for a fresh weekâ€¦");
      const resp = await fetch(API, { method:"POST", headers:{"Content-Type":"text/plain"}, body: JSON.stringify({ rows: updates }) });
      const txt2 = await resp.text();
      let ok2 = null; try { ok2 = JSON.parse(txt2); } catch(e) {}
      if (!resp.ok || !ok2 || !ok2.ok) throw new Error(`Cleanup save failed (status ${resp.status}): ${txt2.substring(0,200)}`);
      edits.clear();
      setStatus("All notes cleared. Fresh week ready âœ…", true);
    } catch(err) {
      console.error(err);
      setStatus("Cleanup failed.");
      alert(err.message || "Cleanup failed. Check Web App permissions or try again.");
    }
  });

  // Boot
  load();
</script>
</body>
</html>
