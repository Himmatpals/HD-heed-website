<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NDIS Comprehensive Care Plan ‚Äî Pro Edition</title>
<meta name="theme-color" content="#0b1420" />
<style>
  :root{
    /* Palette (distinct from AILR: cooler teal/indigo, high contrast) */
    --ink:#0b1420; --bg:#0a0f16; --panel:#0f1722; --line:#253247;
    --text:#e9f3ff; --muted:#b9c8de;
    --a1:#0ea5a5; --a2:#4f46e5; --accent: linear-gradient(135deg, var(--a1), var(--a2));
    --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;

    /* Focus ring */
    --ring: 0 0 0 3px rgba(79,70,229,.35), 0 0 0 5px rgba(14,165,165,.2);
  }
  *{ box-sizing:border-box }
  html,body{height:100%}
  body{
    margin:0; font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 15% -10%, rgba(14,165,165,.18), transparent 60%),
      radial-gradient(1200px 600px at 85% 0%, rgba(79,70,229,.18), transparent 60%),
      linear-gradient(180deg, #0a0f16 0%, #0b1420 45%, #08101a 100%);
  }
  a{color:#a9d3ff;text-decoration:none} a:hover{color:#d6e7ff}

  /* Header */
  header{
    position:sticky; top:0; z-index:60;
    background: linear-gradient(135deg,#0a111b,#0d1725);
    border-bottom:1px solid var(--line);
    box-shadow: 0 8px 30px rgba(0,0,0,.55);
    backdrop-filter: blur(6px);
  }
  .bar{ max-width:1200px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; gap:12px }
  .brand{ font-weight:900; letter-spacing:.2px; background:var(--accent); -webkit-background-clip:text; -webkit-text-fill-color:transparent }
  .tag{ font-size:12px; color:#9fb7d8 }
  .hint{ color:#9fb7d8; font-size:12px }

  /* Layout */
  .wrap{ max-width:1200px; margin:16px auto 24px; padding:0 16px; display:grid; gap:16px; grid-template-columns: 300px 1fr }
  @media (max-width:980px){ .wrap{ grid-template-columns: 1fr } }

  /* Sidebar */
  .nav{
    position:sticky; top:76px; align-self:start; background:linear-gradient(180deg,#0d1623,#0a1220);
    border:1px solid var(--line); border-radius:18px; padding:14px; box-shadow:0 18px 60px rgba(0,0,0,.55)
  }
  .nav h3{ margin:0 0 8px; font-size:16px; font-weight:900 }
  .toc{ list-style:none; padding:0; margin:0; display:grid; gap:8px; max-height: calc(100vh - 140px); overflow:auto }
  .toc a{
    display:flex; gap:8px; align-items:center; border:1px solid transparent; border-radius:12px; padding:10px 12px; color:#cfe0ff;
    background:linear-gradient(135deg,#0e1725,#0d1422); transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease
  }
  .toc a:hover{ transform: translateY(-1px); box-shadow:0 10px 24px rgba(0,0,0,.4); border-color:var(--line) }
  .badge{ margin-left:auto; font-size:11px; color:#a7ffcf }

  /* Main */
  main{
    border:1px solid var(--line); border-radius:22px; background:linear-gradient(180deg,#0e1826,#0b1420);
    box-shadow:0 24px 70px rgba(0,0,0,.55), inset 0 0 14px rgba(255,255,255,.04);
    padding:18px;
  }
  .headerRow{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap }
  .controls{ display:flex; gap:8px; flex-wrap:wrap }
  .btn{
    border:0; border-radius:14px; padding:12px 14px; font-weight:800; cursor:pointer; min-height:46px;
    background:linear-gradient(135deg,#121f33,#0f192a); color:#e9f3ff; border:1px solid var(--line);
    transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
  }
  .btn:hover{ transform: translateY(-1px); box-shadow:0 12px 28px rgba(0,0,0,.5) }
  .btn.primary{ background:var(--accent); color:#fff; border-color:transparent }
  .btn.warn{ background: linear-gradient(135deg,#1e3350,#344d82); color:#ffd86a; border-color:#314976 }
  .btn.ghost{ background: linear-gradient(135deg,#102034,#0e1a2c) }

  /* Sections */
  details.section{
    border:1px solid var(--line); border-radius:16px; background:linear-gradient(180deg,#0f1a2b,#0c1626);
    padding:10px 12px; margin:12px 0; box-shadow:0 6px 18px rgba(0,0,0,.4)
  }
  details[open].section{ box-shadow:0 14px 40px rgba(0,0,0,.55) }
  summary{
    cursor:pointer; list-style:none; display:flex; gap:10px; align-items:center; font-weight:900;
    background:var(--accent); -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  .sect-meta{ margin-left:auto; display:flex; gap:10px; align-items:center }
  .na{
    display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#cfe0ff; opacity:.95;
    border:1px solid var(--line); border-radius:999px; padding:6px 10px; background:linear-gradient(135deg,#0e1a2d,#0b1626);
  }
  .na input{ width:16px; height:16px }

  /* Grid + inputs */
  .grid{ display:grid; gap:12px }
  .two{ grid-template-columns: repeat(2,minmax(0,1fr)) } .three{ grid-template-columns: repeat(3,minmax(0,1fr)) }
  @media (max-width:900px){ .two,.three{ grid-template-columns:1fr } }
  .box{
    border:1px solid #2a3b57; border-radius:14px; padding:12px; background:linear-gradient(135deg,#102039,#0e1b32);
    box-shadow: inset 0 2px 4px rgba(0,0,0,.35)
  }
  .box label{ font-weight:800; display:block; margin-bottom:6px }
  input[type="text"],input[type="email"],input[type="tel"],input[type="date"],input[type="number"],textarea,select{
    width:100%; padding:12px; border-radius:12px; border:1px solid #314767; background:linear-gradient(135deg,#0f203b,#0d1a31);
    color:#e9f3ff; font-size:15px; outline:none; transition:border-color .2s ease, box-shadow .2s ease
  }
  textarea{ min-height:96px; resize:vertical }
  input:focus, textarea:focus, select:focus{ border-color:#4f46e5; box-shadow:var(--ring) }

  /* mic buttons for dictation */
  .mic{
    position:relative; margin-top:6px; display:inline-flex; align-items:center; gap:6px; font-size:12px;
    padding:6px 8px; border:1px solid var(--line); border-radius:999px; background:linear-gradient(135deg,#0f1f36,#0d1b2e);
    cursor:pointer; user-select:none;
  }
  .mic[data-live="true"]{ box-shadow:0 0 0 4px rgba(239,68,68,.2); border-color:#7b3140 }
  .mic i{ width:8px; height:8px; border-radius:50%; background:#7aa1ff }
  .mic[data-live="true"] i{ background:#ef4444; box-shadow:0 0 8px rgba(239,68,68,.6) }

  /* checklists */
  .ck-list{ list-style:none; padding:0; margin:0; display:grid; gap:8px }
  .ck-row{ display:flex; gap:10px; align-items:center }
  .ck-row input{ width:18px; height:18px }

  /* pills */
  .pill{ display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--line); background:linear-gradient(135deg,#0f1e33,#0e1a2c); font-size:12px; color:#bfe0ff }

  /* signature pad */
  .sigpad{ border:1px dashed #496082; border-radius:10px; background:#0b1628; height:140px; position:relative }
  .sigpad canvas{ width:100%; height:100%; display:block }
  .sig-tools{ display:flex; gap:8px; margin-top:6px }

  /* small helpers */
  .muted{ color:#9fb7d8; font-size:13px }
  .right{ margin-left:auto }
  .sr{ position:absolute; width:1px; height:1px; clip:rect(1px,1px,1px,1px); overflow:hidden } /* screen reader only */

  /* print styles for PDF export */
  @media print{
    header, .nav, .controls .btn.warn, .controls .btn.ghost, .mic, .sig-tools{ display:none !important }
    body{ background:#fff; color:#111 }
    main{ box-shadow:none; background:#fff; border-color:#ddd }
    details.section{ background:#fff; border-color:#ddd }
    summary{ -webkit-text-fill-color:initial; color:#0f172a }
  }
</style>

<!-- PDF.js for robust PDF text extraction -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.worker.min.js";
  }
</script>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">NDIS Comprehensive Care Plan</div>
    <div class="tag">Person-centred ‚Ä¢ Speech-to-fill ‚Ä¢ PDF/RTF export ‚Ä¢ Client-side autofill</div>
    <div class="right hint">Autosaves locally ‚Ä¢ Works offline</div>
  </div>
</header>

<div class="wrap">
  <!-- Sidebar -->
  <aside class="nav" aria-label="Sections">
    <h3>Sections</h3>
    <ul class="toc" id="toc"></ul>
  </aside>

  <!-- Main -->
  <main id="app" role="region" aria-live="polite">
    <div class="headerRow">
      <div class="pill">Status: <span id="statusTxt">Draft saved</span></div>
      <div class="controls">
        <button class="btn ghost" id="dictationToggle" type="button">üéôÔ∏è Dictation: Off</button>
        <label class="btn ghost" for="fileInput">üì§ Upload PDF/RTF to auto-fill</label>
        <input id="fileInput" type="file" accept=".pdf,.rtf,.txt" class="sr" />
        <button class="btn warn" id="resetBtn" type="button">‚Ü∫ Reset</button>
        <button class="btn" id="rtfBtn" type="button">‚¨áÔ∏è Download .RTF</button>
        <button class="btn primary" id="pdfBtn" type="button">üñ®Ô∏è Generate PDF</button>
      </div>
    </div>

    <!-- Sections (details/summary accordions). Each has a "Not required" toggle. -->
    <!-- 1. Participant -->
    <details class="section" id="sec-participant" open>
      <summary>
        1) Participant ‚Äî Personal & NDIS identifiers
        <span class="sect-meta">
          <span class="pill">Required</span>
          <label class="na"><input type="checkbox" data-na="participant"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Legal name</label><input data-field="participant.legal_name" type="text" placeholder="e.g., Jane A. Citizen"><div class="mic" data-mic="participant.legal_name"><i></i>Dictate</div></div>
        <div class="box"><label>Preferred name</label><input data-field="participant.preferred_name" type="text"><div class="mic" data-mic="participant.preferred_name"><i></i>Dictate</div></div>
        <div class="box"><label>Date of birth</label><input data-field="participant.dob" type="date"></div>
        <div class="box"><label>NDIS number</label><input data-field="participant.ndis_number" type="text"></div>
        <div class="box"><label>Address line 1</label><input data-field="participant.address.line1" type="text"><div class="mic" data-mic="participant.address.line1"><i></i>Dictate</div></div>
        <div class="box"><label>Address line 2</label><input data-field="participant.address.line2" type="text"></div>
        <div class="box"><label>Suburb</label><input data-field="participant.address.suburb" type="text"></div>
        <div class="box"><label>State</label><input data-field="participant.address.state" type="text" placeholder="e.g., VIC"></div>
        <div class="box"><label>Postcode</label><input data-field="participant.address.postcode" type="text"></div>
        <div class="box"><label>Plan management</label>
          <select data-field="participant.plan_mgmt">
            <option value="">Select‚Ä¶</option>
            <option>NDIA-managed</option><option>Plan-managed</option><option>Self-managed</option><option>Not sure</option>
          </select>
        </div>
        <div class="box"><label>Plan dates ‚Äî start</label><input data-field="participant.plan_dates.start" type="date"></div>
        <div class="box"><label>Plan dates ‚Äî end</label><input data-field="participant.plan_dates.end" type="date"></div>
        <div class="box"><label>Plan manager ‚Äî org</label><input data-field="participant.pm.org" type="text"></div>
        <div class="box"><label>Plan manager ‚Äî contact</label><input data-field="participant.pm.contact" type="text"></div>
        <div class="box"><label>Plan manager ‚Äî email</label><input data-field="participant.pm.email" type="email"></div>
        <div class="box"><label>Plan manager ‚Äî phone</label><input data-field="participant.pm.phone" type="tel"></div>
      </div>
      <div class="grid two" style="margin-top:10px">
        <div class="box"><label>Participant email</label><input data-field="contacts.email" type="email"></div>
        <div class="box"><label>Participant phone</label><input data-field="contacts.phone" type="tel"></div>
      </div>
      <div class="muted" style="margin-top:6px">At least email or phone will be required at submission/export.</div>
    </details>

    <!-- 2. Health & Medical -->
    <details class="section" id="sec-health">
      <summary>
        2) Health & Medical (diagnoses, allergies, mobility, cognition)
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="health"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Primary diagnoses</label><textarea data-field="health.primary_diagnoses" placeholder="e.g., Cerebral palsy GMFCS III; Epilepsy"></textarea><div class="mic" data-mic="health.primary_diagnoses"><i></i>Dictate</div></div>
        <div class="box"><label>Other diagnoses</label><textarea data-field="health.other_diagnoses"></textarea></div>
        <div class="box"><label>Allergies <span class="pill">required</span></label><input data-field="health.allergies" type="text" placeholder="Write ‚ÄúNo known allergies‚Äù if none"></div>
        <div class="box"><label>Equipment / aids</label><input data-field="health.equipment" type="text" placeholder="e.g., wheelchair, hoist, comms device"></div>
        <div class="box"><label>Mobility</label>
          <select data-field="health.mobility">
            <option value="">Select‚Ä¶</option><option>Independent</option><option>With aid</option><option>Requires transfer</option><option>Bed-bound</option><option>Prefer not to say</option>
          </select>
        </div>
        <div class="box"><label>Continence</label>
          <select data-field="health.continence">
            <option value="">Select‚Ä¶</option><option>Independent</option><option>Needs prompting</option><option>Incontinent</option><option>Catheter / stoma</option><option>Prefer not to say</option>
          </select>
        </div>
        <div class="box"><label>Cognition</label>
          <select data-field="health.cognition">
            <option value="">Select‚Ä¶</option><option>Clear</option><option>Mild impairment</option><option>Moderate</option><option>Severe</option><option>Prefer not to say</option>
          </select>
        </div>
        <div class="box"><label>Diet / swallowing notes</label><textarea data-field="health.diet_notes"></textarea></div>
        <div class="box"><label>Pressure injury risk</label>
          <select data-field="health.pressure_risk">
            <option value="">Select‚Ä¶</option><option>Low</option><option>Medium</option><option>High</option><option>Not sure</option>
          </select>
        </div>
        <div class="box"><label>Falls risk</label>
          <select data-field="health.falls_risk">
            <option value="">Select‚Ä¶</option><option>Low</option><option>Medium</option><option>High</option><option>Not sure</option>
          </select>
        </div>
      </div>
      <div class="grid three" style="margin-top:10px">
        <div class="box"><label>Seizures?</label>
          <select data-field="health.seizures.has"><option value="">Select‚Ä¶</option><option>No</option><option>Yes</option><option>Not sure</option></select>
        </div>
        <div class="box"><label>Seizure plan</label><input data-field="health.seizures.plan" type="text"></div>
        <div class="box"><label>Seizure frequency</label><input data-field="health.seizures.frequency" type="text"></div>
      </div>
    </details>

    <!-- 3. Daily Living & Personal Care -->
    <details class="section" id="sec-adl">
      <summary>
        3) Daily Living & Personal Care (ADLs)
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="adl"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Bathing / showering</label><textarea data-field="adl.bathing" placeholder="Level of support, time of day preference, equipment (shower chair), temperature preferences, dignity notes"></textarea></div>
        <div class="box"><label>Dressing / grooming</label><textarea data-field="adl.dressing"></textarea></div>
        <div class="box"><label>Toileting / continence care</label><textarea data-field="adl.toileting"></textarea></div>
        <div class="box"><label>Meal prep / feeding</label><textarea data-field="adl.meals"></textarea></div>
        <div class="box"><label>Mobility & transfers</label><textarea data-field="adl.mobility"></textarea></div>
        <div class="box"><label>Household tasks (cleaning, laundry)</label><textarea data-field="adl.household"></textarea></div>
        <div class="box"><label>Transport / community access</label><textarea data-field="adl.transport"></textarea></div>
        <div class="box"><label>Routines & preferences</label><textarea data-field="adl.routines"></textarea></div>
      </div>
    </details>

    <!-- 4. Communication & Sensory -->
    <details class="section" id="sec-comms">
      <summary>
        4) Communication & Sensory
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="comms"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Primary language</label><input data-field="comms.language" type="text"></div>
        <div class="box"><label>Interpreter</label>
          <select data-field="comms.interpreter"><option value="">Select‚Ä¶</option><option>Required</option><option>Not required</option><option>Not sure</option></select>
        </div>
        <div class="box"><label>Communication methods</label><textarea data-field="comms.methods" placeholder="Verbal, sign, AAC device; how to present info; decision-making support"></textarea></div>
        <div class="box"><label>Sensory considerations</label><textarea data-field="comms.sensory" placeholder="Noise/light sensitivities; calming strategies"></textarea></div>
        <div class="box"><label>Worker preferences</label><textarea data-field="comms.worker_prefs" placeholder="Gender preference; cultural considerations; continuity"></textarea></div>
      </div>
    </details>

    <!-- 5. Social & Lifestyle -->
    <details class="section" id="sec-social">
      <summary>
        5) Social & Lifestyle
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="social"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Living situation</label><textarea data-field="social.living" placeholder="Who lives at home; access/parking notes"></textarea></div>
        <div class="box"><label>Support network</label><textarea data-field="social.network" placeholder="Family/friends involved; key contacts"></textarea></div>
        <div class="box"><label>Interests & activities</label><textarea data-field="social.interests" placeholder="Hobbies; community activities; meaningful engagement"></textarea></div>
        <div class="box"><label>Typical routine</label><textarea data-field="social.routine"></textarea></div>
      </div>
    </details>

    <!-- 6. Behaviour Management -->
    <details class="section" id="sec-behaviour">
      <summary>
        6) Behaviour Management (BSP, triggers, proactive & response strategies)
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="behaviour"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Behaviours of concern ‚Äî description</label><textarea data-field="behaviour.description" placeholder="Topography: what it looks like, frequency, intensity, duration"></textarea></div>
        <div class="box"><label>Known triggers / antecedents</label><textarea data-field="behaviour.triggers" placeholder="Noise, transitions, demands, sensory overload, pain, hunger"></textarea></div>
        <div class="box"><label>Preventative strategies</label><textarea data-field="behaviour.prevent" placeholder="Predictable routines, visual schedules, choices, skill building, environment changes"></textarea></div>
        <div class="box"><label>De-escalation strategies</label><textarea data-field="behaviour.deescalate" placeholder="Calm voice, space, preferred activity, sensory tools, time-away"></textarea></div>
        <div class="box"><label>Post-incident support / review</label><textarea data-field="behaviour.post" placeholder="Debrief, data capture, adapt strategies, communication with stakeholders"></textarea></div>
        <div class="box"><label>BSP in place?</label>
          <select data-field="behaviour.bsp"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option><option>Not sure</option></select>
        </div>
        <div class="box"><label>Restrictive practices involved?</label>
          <select data-field="behaviour.restrictive"><option value="">Select‚Ä¶</option><option>No</option><option>Chemical</option><option>Physical</option><option>Mechanical</option><option>Seclusion</option></select>
        </div>
        <div class="box"><label>Authorisations & review cycle</label><textarea data-field="behaviour.authorisations" placeholder="Authorising body, expiry, reduction plan, safeguards"></textarea></div>
      </div>
    </details>

    <!-- 7. Medication Management -->
    <details class="section" id="sec-meds">
      <summary>
        7) Medication Management (full list, schedules, storage, PRN, emergencies)
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="meds"> Not required</label>
        </span>
      </summary>
      <div class="box">
        <label>Medication table</label>
        <div class="muted">Add all regular and PRN medications (name, dose, route, times, purpose). Use the + button to add rows. Consider side-effects monitoring.</div>
        <table id="medTable" style="width:100%; border-collapse:separate; border-spacing:0 8px; margin-top:8px">
          <thead>
            <tr style="font-size:12px;color:#cfe0ff">
              <th align="left">Name</th><th align="left">Dose</th><th align="left">Route</th><th align="left">Times</th><th align="left">Purpose</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button class="btn ghost" id="addMed">Ôºã Add medication</button>
      </div>
      <div class="grid two" style="margin-top:10px">
        <div class="box"><label>Self-administration ability</label><textarea data-field="meds.self" placeholder="Independent vs prompting vs staff administer; capacity notes"></textarea></div>
        <div class="box"><label>Webster / blister pack</label><select data-field="meds.webster"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option><option>Not sure</option></select></div>
        <div class="box"><label>Storage & access control</label><textarea data-field="meds.storage" placeholder="Locked cupboard; temperature; keys held by‚Ä¶"></textarea></div>
        <div class="box"><label>Consent for administration</label><select data-field="meds.consent"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option><option>Not applicable</option></select></div>
        <div class="box"><label>Side-effects to monitor</label><textarea data-field="meds.sidefx" placeholder="By medication (e.g., dizziness, GI upset), what to do, who to inform"></textarea></div>
        <div class="box"><label>Emergency meds & protocol</label><textarea data-field="meds.emergency" placeholder="e.g., EpiPen, midazolam: indications, steps, escalation"></textarea></div>
        <div class="box"><label>Missed dose protocol</label><textarea data-field="meds.missed" placeholder="Do not double dose; contact GP if‚Ä¶; document/refuse protocol"></textarea></div>
        <div class="box"><label>Recent changes / upcoming reviews</label><textarea data-field="meds.changes"></textarea></div>
      </div>
    </details>

    <!-- 8. Risk & Safety -->
    <details class="section" id="sec-risk">
      <summary>
        8) Risk & Safety (home, falls, pressure, wandering, transport)
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="risk"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Home safety checklist</label>
          <ul class="ck-list">
            <li class="ck-row"><input type="checkbox" data-field="risk.home.trip"> <span>Trip hazards present</span></li>
            <li class="ck-row"><input type="checkbox" data-field="risk.home.smoke"> <span>No working smoke alarms</span></li>
            <li class="ck-row"><input type="checkbox" data-field="risk.home.light"> <span>Poor lighting</span></li>
            <li class="ck-row"><input type="checkbox" data-field="risk.home.bath"> <span>Bathroom lacks rails / mats</span></li>
          </ul>
        </div>
        <div class="box"><label>Notes / mitigations</label><textarea data-field="risk.home.notes"></textarea></div>
        <div class="box"><label>Wandering / elopement risk</label>
          <select data-field="risk.wander"><option value="">Select‚Ä¶</option><option>None</option><option>Low</option><option>Medium</option><option>High</option></select>
        </div>
        <div class="box"><label>Smoking / alcohol / substances</label><textarea data-field="risk.substances"></textarea></div>
        <div class="box"><label>Transport safety</label><textarea data-field="risk.transport" placeholder="Wheelchair accessible vehicle, restraints, escort"></textarea></div>
        <div class="box"><label>Emergency plan</label><textarea data-field="risk.emergency" placeholder="Evacuation, who to contact first, hospital preferences"></textarea></div>
      </div>
    </details>

    <!-- 9. Goals & Outcomes -->
    <details class="section" id="sec-goals">
      <summary>
        9) Goals & Outcomes (link supports to participant goals)
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="goals"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Participant goals</label><textarea data-field="goals.list" placeholder="List goals (from NDIS plan or personal)"></textarea></div>
        <div class="box"><label>Success indicators / outcomes</label><textarea data-field="goals.outcomes" placeholder="What does success look like? (measurable if possible)"></textarea></div>
        <div class="box"><label>Support strategies to reach goals</label><textarea data-field="goals.supports" placeholder="How supports delivered will help achieve goals"></textarea></div>
        <div class="box"><label>Scheduling / frequency notes</label><textarea data-field="goals.schedule"></textarea></div>
      </div>
    </details>

    <!-- 10. Consents & Attachments -->
    <details class="section" id="sec-consents">
      <summary>
        10) Consents & Attachments (info sharing; uploaded files)
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="consents"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Consent to share plan</label>
          <select data-field="consents.share"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option><option>Not sure</option></select>
        </div>
        <div class="box"><label>Consent notes</label><textarea data-field="consents.notes"></textarea></div>
        <div class="box"><label>Emergency contact</label><input data-field="contacts.emer.name" type="text" placeholder="Name"> <div style="height:8px"></div>
          <input data-field="contacts.emer.rel" type="text" placeholder="Relationship" style="margin-top:6px">
          <input data-field="contacts.emer.phone" type="tel" placeholder="Phone" style="margin-top:6px">
        </div>
        <div class="box"><label>Support coordinator</label><input data-field="contacts.sc.name" type="text" placeholder="Name">
          <input data-field="contacts.sc.org" type="text" placeholder="Organisation" style="margin-top:6px">
          <input data-field="contacts.sc.email" type="email" placeholder="Email" style="margin-top:6px">
        </div>
        <div class="box"><label>GP / Practice</label><input data-field="contacts.gp.name" type="text" placeholder="GP name">
          <input data-field="contacts.gp.practice" type="text" placeholder="Practice" style="margin-top:6px">
          <input data-field="contacts.gp.phone" type="tel" placeholder="Phone" style="margin-top:6px">
          <input data-field="contacts.gp.email" type="email" placeholder="Email" style="margin-top:6px">
        </div>
        <div class="box"><label>Uploaded files (auto-fill source)</label>
          <ul id="uploadList" class="ck-list"></ul>
          <div class="muted">Use the ‚ÄúUpload PDF/RTF‚Äù button at the top to add documents that will be parsed and mapped into fields.</div>
        </div>
      </div>
    </details>

    <!-- 11. Signatures & Authorisation -->
    <details class="section" id="sec-sign">
      <summary>
        11) Signatures & Authorisation
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="sign"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box">
          <label>Participant / Representative ‚Äî type name</label>
          <input data-field="sign.participant_name" type="text" placeholder="Printed name">
          <div class="sigpad" data-sig="participant"><canvas></canvas></div>
          <div class="sig-tools">
            <button class="btn ghost" data-sig-clear="participant" type="button">Clear</button>
            <button class="btn ghost" data-sig-undo="participant" type="button">Undo</button>
          </div>
          <div class="box" style="margin-top:10px"><label>Date</label><input data-field="sign.participant_date" type="date"></div>
        </div>
        <div class="box">
          <label>Provider Representative ‚Äî name & title</label>
          <input data-field="sign.provider_name" type="text" placeholder="Name">
          <input data-field="sign.provider_title" type="text" placeholder="Title/Role" style="margin-top:6px">
          <div class="sigpad" data-sig="provider"><canvas></canvas></div>
          <div class="sig-tools">
            <button class="btn ghost" data-sig-clear="provider" type="button">Clear</button>
            <button class="btn ghost" data-sig-undo="provider" type="button">Undo</button>
          </div>
          <div class="box" style="margin-top:10px"><label>Date</label><input data-field="sign.provider_date" type="date"></div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">Signature blocks capture drawn signatures and embed them into the exported PDF and .RTF (as text reference). If left blank, outputs will show a signing line.</div>
    </details>
  </main>
</div>

<script>
/* ============================================================
   Data model & utilities
============================================================ */
const STORAGE_KEY = "ndis_care_plan_pro_v1";

/* App state */
let S = {
  participant:{ legal_name:"", preferred_name:"", dob:"", ndis_number:"",
    address:{line1:"",line2:"",suburb:"",state:"",postcode:""},
    plan_mgmt:"", plan_dates:{start:"",end:""}, pm:{org:"",contact:"",email:"",phone:""} },
  contacts:{ email:"", phone:"",
    emer:{name:"",rel:"",phone:""},
    sc:{name:"",org:"",email:""},
    gp:{name:"",practice:"",phone:"",email:""} },
  health:{ primary_diagnoses:"", other_diagnoses:"", allergies:"", equipment:"",
    mobility:"", continence:"", cognition:"", diet_notes:"", pressure_risk:"", falls_risk:"",
    seizures:{has:"",plan:"",frequency:""} },
  adl:{ bathing:"", dressing:"", toileting:"", meals:"", mobility:"", household:"", transport:"", routines:"" },
  comms:{ language:"", interpreter:"", methods:"", sensory:"", worker_prefs:"" },
  social:{ living:"", network:"", interests:"", routine:"" },
  behaviour:{ description:"", triggers:"", prevent:"", deescalate:"", post:"", bsp:"", restrictive:"", authorisations:"" },
  meds:{ list:[], self:"", webster:"", storage:"", consent:"", sidefx:"", emergency:"", missed:"", changes:"" },
  risk:{ home:{trip:false,smoke:false,light:false,bath:false,notes:""}, wander:"", substances:"", transport:"", emergency:"" },
  goals:{ list:"", outcomes:"", supports:"", schedule:"" },
  consents:{ share:"", notes:"" },
  sign:{ participant_name:"", participant_date:"", provider_name:"", provider_title:"", provider_date:"", sigs:{} },
  uploads:[],
  na:{ participant:false, health:false, adl:false, comms:false, social:false, behaviour:false, meds:false, risk:false, goals:false, consents:false, sign:false },
  dictation:false
};

/* Save/restore */
function save(){
  try{
    const serial = JSON.stringify(S);
    localStorage.setItem(STORAGE_KEY, serial);
    setStatus("Draft saved");
  }catch(e){ console.warn("save failed", e); }
}
function restore(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const prev = JSON.parse(raw);
    if (prev && typeof prev === "object") S = Object.assign(S, prev);
  }catch(e){ console.warn("restore failed", e); }
}
function setStatus(t){ document.getElementById('statusTxt').textContent = t; }

/* Field binding */
function bindAll(){
  // inputs/selects/textarea
  document.querySelectorAll('[data-field]').forEach(node=>{
    const path = node.getAttribute('data-field');
    // set initial
    const v = get(S, path);
    if (node.type === 'checkbox') node.checked = !!v; else if (v!=null) node.value = v;
    // listen
    node.addEventListener('input', ()=>{
      set(S, path, node.type==='checkbox'? node.checked : node.value);
      save();
    });
  });
  // NA toggles
  document.querySelectorAll('input[data-na]').forEach(cb=>{
    const key = cb.getAttribute('data-na');
    cb.checked = !!S.na[key];
    applyNA(key, cb.checked);
    cb.addEventListener('change', ()=>{
      S.na[key] = cb.checked; applyNA(key, cb.checked); save();
    });
  });
}

/* Enable/disable subsection */
function applyNA(key, val){
  const section = document.querySelector(`#sec-${key}`) || document.querySelector(`[id="sec-${key}"]`);
  if (!section) return;
  section.querySelectorAll('input,select,textarea,button').forEach(el=>{
    if (el.closest('summary') || el.hasAttribute('data-na') || el.id==='addMed') return; // keep toggles active
    el.disabled = !!val;
  });
  section.style.opacity = val ? .55 : 1;
}

/* Deep get/set helpers */
function get(obj, path){
  return path.split('.').reduce((o,k)=> (o ? o[k] : undefined), obj);
}
function set(obj, path, val){
  const parts = path.split('.');
  const last = parts.pop();
  const parent = parts.reduce((o,k)=> (o[k]??(o[k]={})), obj);
  parent[last] = val;
}

/* Table: medications */
const medTableBody = ()=> document.querySelector('#medTable tbody');
function addMedRow(item={name:"",dose:"",route:"",times:"",purpose:""}){
  S.meds.list.push(item);
  renderMedRows();
  save();
}
function removeMedRow(ix){
  S.meds.list.splice(ix,1);
  renderMedRows();
  save();
}
function renderMedRows(){
  const tb = medTableBody();
  tb.innerHTML = "";
  S.meds.list.forEach((m,ix)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" value="${m.name||""}" data-med="${ix}.name"></td>
      <td><input type="text" value="${m.dose||""}" data-med="${ix}.dose"></td>
      <td><input type="text" value="${m.route||""}" data-med="${ix}.route"></td>
      <td><input type="text" value="${m.times||""}" data-med="${ix}.times"></td>
      <td><input type="text" value="${m.purpose||""}" data-med="${ix}.purpose"></td>
      <td><button class="btn ghost" data-med-del="${ix}" type="button">‚úï</button></td>
    `;
    tb.appendChild(tr);
  });
  // bind
  tb.querySelectorAll('[data-med]').forEach(inp=>{
    const p = inp.getAttribute('data-med');
    inp.addEventListener('input', ()=>{
      const [i, key] = p.split('.');
      S.meds.list[+i][key] = inp.value;
      save();
    });
  });
  tb.querySelectorAll('[data-med-del]').forEach(btn=>{
    btn.addEventListener('click', ()=> removeMedRow(+btn.getAttribute('data-med-del')));
  });
}

/* Upload & autofill ‚Äî PDF.js + RTF */
function addUploadTag(name){ 
  const li=document.createElement('li'); li.textContent = name; 
  document.getElementById('uploadList').appendChild(li);
}
async function extractPdfText(file){
  if (!window.pdfjsLib) throw new Error("PDF.js not loaded");
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
  let full = "";
  for (let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const c = await page.getTextContent();
    full += c.items.map(it=>it.str).join(" ") + "\n\n";
  }
  return full.trim();
}
function rtfToText(rtf){
  // very lightweight: strips {\control} and \'xx hex codes into unicode
  let t = rtf.replace(/\\'([0-9a-fA-F]{2})/g, (_,h)=> String.fromCharCode(parseInt(h,16)));
  t = t.replace(/\\par[d]?/g,"\n");
  t = t.replace(/\\[a-z]+\d* ?/g,""); // control words
  t = t.replace(/[{}]/g,"");
  return t.replace(/\n{3,}/g,"\n\n").trim();
}
function mapTextToFields(text){
  // heuristic keyword mapping ‚Äî extend as necessary
  const map = [
    { re:/\b(Allerg(?:y|ies)|Allergic to)\s*[:\-]\s*([^\n]+)/i, field:"health.allergies" },
    { re:/\bDiagnoses?\s*[:\-]\s*([^\n]+)/i, field:"health.primary_diagnoses" },
    { re:/\bOther diagnoses?\s*[:\-]\s*([^\n]+)/i, field:"health.other_diagnoses" },
    { re:/\bNDIS\s*(No|Number)\s*[:\-]\s*([0-9\s]+)/i, field:"participant.ndis_number" },
    { re:/\bAddress\s*[:\-]\s*([^\n]+)/i, field:"participant.address.line1" },
    { re:/\bPlan\s*management\s*[:\-]\s*([^\n]+)/i, field:"participant.plan_mgmt" },
    { re:/\bGP\s*(?:Name)?\s*[:\-]\s*([^\n]+)/i, field:"contacts.gp.name" },
    { re:/\bEmergency\s*Contact\s*[:\-]\s*([^\n]+)/i, field:"contacts.emer.name" },
    { re:/\bMedication(?:s)?\s*[:\-]\s*([^\n]+)/i, field:"meds.changes" }, // catch-all
  ];
  map.forEach(m=>{
    const hit = text.match(m.re);
    if (hit){ set(S, m.field, (hit[2]||hit[1]).trim()); }
  });

  // crude medication line detection
  const medLines = text.split(/\n/).filter(l=>/\b(mg|mcg|ml)\b/i.test(l) && /\b(am|pm|daily|noon|night|prn)\b/i.test(l));
  medLines.forEach(l=>{
    const m = { name:"", dose:"", route:"", times:"", purpose:"" };
    const dose = l.match(/\b\d+(\.\d+)?\s*(mg|mcg|ml)\b/i); if (dose) m.dose = dose[0];
    const route = l.match(/\b(oral|po|inhaled|neb|patch|sc|im|iv)\b/i); if (route) m.route = route[0].toUpperCase();
    const times = l.match(/\b(morning|noon|evening|night|am|pm|daily|bd|tds|qds|prn)\b/gi); if (times) m.times = Array.from(new Set(times)).join(", ");
    m.name = l.split(/[:\-]/)[0].trim();
    S.meds.list.push(m);
  });
}

/* Dictation */
let recognizer=null, recField=null, globalDictation=false;
function initSpeech(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return null;
  const r = new SR();
  r.continuous = true; r.interimResults = true; r.lang = "en-AU";
  r.onresult = (evt)=>{
    let transcript = "";
    for (let i=evt.resultIndex; i<evt.results.length; i++){
      transcript += evt.results[i][0].transcript;
    }
    if (recField){
      const el = document.querySelector(`[data-field="${recField}"]`);
      if (el){
        el.value = transcript.trim();
        set(S, recField, el.value); save();
      }
    }
  };
  r.onerror = (e)=>{ console.warn("speech error", e); stopSpeech(); };
  r.onend = ()=>{ if (globalDictation && recField) startSpeech(recField); }; // auto-restart when global on
  return r;
}
function startSpeech(field){
  if (!recognizer) recognizer = initSpeech();
  if (!recognizer) { alert("Speech recognition not supported in this browser."); return; }
  recField = field;
  document.querySelectorAll('.mic').forEach(m=>m.dataset.live="false");
  const m = document.querySelector(`.mic[data-mic="${field}"]`);
  if (m) m.dataset.live="true";
  try{ recognizer.start(); }catch{}
}
function stopSpeech(){
  if (recognizer){ try{ recognizer.stop(); }catch{} }
  document.querySelectorAll('.mic').forEach(m=>m.dataset.live="false");
  recField = null;
}

/* Signature pad (simple canvas freehand with undo) */
const sigPads = {};
function initSigPads(){
  document.querySelectorAll('.sigpad').forEach(wrap=>{
    const key = wrap.getAttribute('data-sig');
    const canvas = wrap.querySelector('canvas');
    const ctx = canvas.getContext('2d');
    const strokes = []; let drawing=false; let current=[];

    function resize(){
      const r = wrap.getBoundingClientRect();
      const tmp = document.createElement('canvas');
      tmp.width = r.width; tmp.height = r.height;
      tmp.getContext('2d').drawImage(canvas,0,0);
      canvas.width = r.width; canvas.height = r.height;
      ctx.drawImage(tmp,0,0);
    }
    const ro = new ResizeObserver(resize); ro.observe(wrap); resize();

    canvas.addEventListener('pointerdown', e=>{ drawing=true; current=[{x:e.offsetX,y:e.offsetY}]; });
    canvas.addEventListener('pointermove', e=>{
      if (!drawing) return; current.push({x:e.offsetX,y:e.offsetY}); redraw();
    });
    window.addEventListener('pointerup', ()=>{
      if (drawing){ drawing=false; if (current.length>0){ strokes.push(current); current=[]; saveSig(); } }
    });

    function redraw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.lineWidth = 2; ctx.lineJoin="round"; ctx.lineCap="round"; ctx.strokeStyle="#9ed0ff";
      [...strokes, current].forEach(st=>{
        if (!st || st.length<2) return;
        ctx.beginPath();
        ctx.moveTo(st[0].x, st[0].y);
        for (let i=1;i<st.length;i++) ctx.lineTo(st[i].x, st[i].y);
        ctx.stroke();
      });
    }
    function toDataURL(){ return canvas.toDataURL("image/png"); }
    function clear(){ strokes.length=0; current=[]; redraw(); saveSig(); }
    function undo(){ strokes.pop(); redraw(); saveSig(); }
    function saveSig(){ S.sign.sigs[key] = strokes.length? toDataURL(): ""; save(); }

    sigPads[key] = { clear, undo, data:()=>S.sign.sigs[key]||"" };
  });

  document.querySelectorAll('[data-sig-clear]').forEach(b=>{
    b.addEventListener('click', ()=>{ const k=b.getAttribute('data-sig-clear'); sigPads[k]?.clear(); });
  });
  document.querySelectorAll('[data-sig-undo]').forEach(b=>{
    b.addEventListener('click', ()=>{ const k=b.getAttribute('data-sig-undo'); sigPads[k]?.undo(); });
  });
}

/* Export: PDF (print) */
function openPDF(){
  // Build a clean print view in a new window using current state.
  const w = window.open('', '_blank');
  const safe = v => (v===undefined||v===null||v===""?"‚Äî":String(v));
  const yes = v => v===true ? "Yes" : v===false ? "No" : (v||"‚Äî");
  const fmtAddr = a => [a.line1,a.line2,a.suburb,a.state,a.postcode].filter(Boolean).join(", ");

  function section(title, rows){
    return `<section style="page-break-inside:avoid;margin:14px 0;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fafafa">
      <h2 style="margin:0 0 6px;font-size:16px;color:#0f172a">${title}</h2>
      <table style="width:100%;border-collapse:separate;border-spacing:0 6px;font-size:13px">
        ${rows.map(([k,v])=>`<tr><th style="width:240px;text-align:left;padding:6px 8px;background:#eef2ff;border-radius:8px;font-weight:700;color:#1e3a8a">${k}</th><td style="padding:6px 8px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;color:#0f172a">${v}</td></tr>`).join("")}
      </table>
    </section>`;
  }

  let html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>NDIS Care Plan ‚Äî PDF</title>
  <style>@page{size:A4;margin:16mm} body{font-family:Inter,Arial,sans-serif;color:#111;margin:0} header,footer{position:fixed;left:0;right:0}
  header{top:0;height:38px;border-bottom:1px solid #e5e7eb} footer{bottom:0;height:28px;border-top:1px solid #e5e7eb;font-size:11px;color:#475569}
  .container{margin:52px 16mm 34px} .pnum:after{counter-increment:page;content:"Page " counter(page)}
  </style></head><body><header><div style="display:flex;justify-content:space-between;align-items:center;padding:8px 16mm;font-weight:800;font-size:12px;color:#334155">NDIS Comprehensive Care Plan<span>${new Date().toLocaleDateString('en-AU',{day:'numeric',month:'long',year:'numeric'})}</span></div></header>
  <footer><div style="display:flex;justify-content:space-between;align-items:center;padding:6px 16mm"><span>Generated from in-browser form</span><span class="pnum"></span></div></footer>
  <div class="container">`;

  // participant
  if (!S.na.participant) html += section("Participant", [
    ["Legal name", safe(S.participant.legal_name)],
    ["Preferred name", safe(S.participant.preferred_name)],
    ["DOB", safe(S.participant.dob)],
    ["NDIS number", safe(S.participant.ndis_number)],
    ["Address", safe(fmtAddr(S.participant.address))],
    ["Plan management", safe(S.participant.plan_mgmt)],
    ["Plan dates", safe([S.participant.plan_dates.start,S.participant.plan_dates.end].filter(Boolean).join(" ‚Üí "))],
    ["Plan manager", safe([S.participant.pm.org,S.participant.pm.contact].filter(Boolean).join(" ‚Ä¢ "))],
    ["Plan manager contact", safe([S.participant.pm.email,S.participant.pm.phone].filter(Boolean).join(" ‚Ä¢ "))],
    ["Contact", safe([S.contacts.email,S.contacts.phone].filter(Boolean).join(" ‚Ä¢ "))]
  ]);

  if (!S.na.health) html += section("Health & Medical", [
    ["Primary diagnoses", safe(S.health.primary_diagnoses)],
    ["Other diagnoses", safe(S.health.other_diagnoses)],
    ["Allergies", safe(S.health.allergies)],
    ["Equipment / aids", safe(S.health.equipment)],
    ["Mobility", safe(S.health.mobility)],
    ["Continence", safe(S.health.continence)],
    ["Cognition", safe(S.health.cognition)],
    ["Diet / swallowing", safe(S.health.diet_notes)],
    ["Pressure injury risk", safe(S.health.pressure_risk)],
    ["Falls risk", safe(S.health.falls_risk)],
    ["Seizures", safe(S.health.seizures.has)],
    ["Seizure plan", safe(S.health.seizures.plan)],
    ["Seizure frequency", safe(S.health.seizures.frequency)],
  ]);

  if (!S.na.adl) html += section("Daily Living & Personal Care", [
    ["Bathing / showering", safe(S.adl.bathing)],
    ["Dressing / grooming", safe(S.adl.dressing)],
    ["Toileting / continence", safe(S.adl.toileting)],
    ["Meal prep / feeding", safe(S.adl.meals)],
    ["Mobility & transfers", safe(S.adl.mobility)],
    ["Household tasks", safe(S.adl.household)],
    ["Transport / community", safe(S.adl.transport)],
    ["Routines & preferences", safe(S.adl.routines)],
  ]);

  if (!S.na.comms) html += section("Communication & Sensory", [
    ["Primary language", safe(S.comms.language)],
    ["Interpreter", safe(S.comms.interpreter)],
    ["Communication methods", safe(S.comms.methods)],
    ["Sensory considerations", safe(S.comms.sensory)],
    ["Worker preferences", safe(S.comms.worker_prefs)],
  ]);

  if (!S.na.social) html += section("Social & Lifestyle", [
    ["Living situation", safe(S.social.living)],
    ["Support network", safe(S.social.network)],
    ["Interests & activities", safe(S.social.interests)],
    ["Typical routine", safe(S.social.routine)],
  ]);

  if (!S.na.behaviour) html += section("Behaviour Management", [
    ["Behaviours of concern", safe(S.behaviour.description)],
    ["Triggers / antecedents", safe(S.behaviour.triggers)],
    ["Preventative strategies", safe(S.behaviour.prevent)],
    ["De-escalation strategies", safe(S.behaviour.deescalate)],
    ["Post-incident support / review", safe(S.behaviour.post)],
    ["BSP in place", safe(S.behaviour.bsp)],
    ["Restrictive practices", safe(S.behaviour.restrictive)],
    ["Authorisations / review", safe(S.behaviour.authorisations)],
  ]);

  if (!S.na.meds){
    const medHTML = (S.meds.list||[]).length
      ? `<table style="width:100%;border-collapse:collapse;border:1px solid #e5e7eb"><thead><tr style="background:#f8fafc">
          <th align="left" style="padding:6px;border-bottom:1px solid #e5e7eb">Name</th>
          <th align="left" style="padding:6px;border-bottom:1px solid #e5e7eb">Dose</th>
          <th align="left" style="padding:6px;border-bottom:1px solid #e5e7eb">Route</th>
          <th align="left" style="padding:6px;border-bottom:1px solid #e5e7eb">Times</th>
          <th align="left" style="padding:6px;border-bottom:1px solid #e5e7eb">Purpose</th>
        </tr></thead><tbody>${
          S.meds.list.map(m=>`<tr>
            <td style="padding:6px;border-top:1px solid #eef2f7">${safe(m.name)}</td>
            <td style="padding:6px;border-top:1px solid #eef2f7">${safe(m.dose)}</td>
            <td style="padding:6px;border-top:1px solid #eef2f7">${safe(m.route)}</td>
            <td style="padding:6px;border-top:1px solid #eef2f7">${safe(m.times)}</td>
            <td style="padding:6px;border-top:1px solid #eef2f7">${safe(m.purpose)}</td>
          </tr>`).join("")
        }</tbody></table>`
      : "‚Äî";
    html += section("Medication Management", [
      ["Medication list", medHTML],
      ["Self-administration", safe(S.meds.self)],
      ["Webster / blister", safe(S.meds.webster)],
      ["Storage & access", safe(S.meds.storage)],
      ["Consent", safe(S.meds.consent)],
      ["Side-effects to monitor", safe(S.meds.sidefx)],
      ["Emergency meds & protocol", safe(S.meds.emergency)],
      ["Missed dose protocol", safe(S.meds.missed)],
      ["Recent changes / reviews", safe(S.meds.changes)],
    ]);
  }

  if (!S.na.risk) html += section("Risk & Safety", [
    ["Home safety", ["trip","smoke","light","bath"].filter(k=>S.risk.home[k]).map(k=>({trip:"Trip hazards",smoke:"No smoke alarms",light:"Poor lighting",bath:"Bathroom safety"}[k])).join(", ") || "‚Äî"],
    ["Home notes", safe(S.risk.home.notes)],
    ["Wandering / elopement", safe(S.risk.wander)],
    ["Substances", safe(S.risk.substances)],
    ["Transport safety", safe(S.risk.transport)],
    ["Emergency plan", safe(S.risk.emergency)],
  ]);

  if (!S.na.goals) html += section("Goals & Outcomes", [
    ["Goals", safe(S.goals.list)],
    ["Success indicators", safe(S.goals.outcomes)],
    ["Support strategies", safe(S.goals.supports)],
    ["Scheduling / frequency", safe(S.goals.schedule)],
  ]);

  if (!S.na.consents) html += section("Consents & Attachments", [
    ["Consent to share", safe(S.consents.share)],
    ["Consent notes", safe(S.consents.notes)],
    ["Emergency contact", safe([S.contacts.emer.name,S.contacts.emer.rel,S.contacts.emer.phone].filter(Boolean).join(" ‚Ä¢ "))],
    ["Support coordinator", safe([S.contacts.sc.name,S.contacts.sc.org,S.contacts.sc.email].filter(Boolean).join(" ‚Ä¢ "))],
    ["GP / Practice", safe([S.contacts.gp.name,S.contacts.gp.practice].filter(Boolean).join(" ‚Ä¢ "))],
    ["GP contact", safe([S.contacts.gp.phone,S.contacts.gp.email].filter(Boolean).join(" ‚Ä¢ "))],
    ["Uploads", (S.uploads||[]).map(u=>u.name).join(" ‚Ä¢ ") || "‚Äî"],
  ]);

  if (!S.na.sign){
    const sigP = S.sign.sigs?.participant ? `<img src="${S.sign.sigs.participant}" style="max-height:80px">` : `<div style="height:80px;border:1px dashed #cbd5e1;border-radius:8px"></div>`;
    const sigR = S.sign.sigs?.provider ? `<img src="${S.sign.sigs.provider}" style="max-height:80px">` : `<div style="height:80px;border:1px dashed #cbd5e1;border-radius:8px"></div>`;
    html += section("Signatures", [
      ["Participant/Representative ‚Äî Name", safe(S.sign.participant_name)],
      ["Signature", sigP],
      ["Date", safe(S.sign.participant_date)],
      ["Provider ‚Äî Name/Title", safe([S.sign.provider_name,S.sign.provider_title].filter(Boolean).join(" ‚Ä¢ "))],
      ["Signature", sigR],
      ["Date", safe(S.sign.provider_date)],
    ]);
  }

  html += `</div></body></html>`;
  w.document.write(html); w.document.close();
  setTimeout(()=>{ try{ w.focus(); }catch{} }, 200);
}
/* Export: RTF */
function downloadRTF(){
  function esc(s){ return (s||"").toString().replace(/[\\{}]/g, m=>"\\"+m).replace(/\n/g,"\\par "); }
  function line(k,v){ return `\\b ${esc(k)}:\\b0\\tab ${esc(v||"‚Äî")}\\par `; }
  function block(title, rows){ return `{\\pard\\sa180\\b\\ul ${esc(title)}\\ul0\\b0\\par }{${rows.join("")}}`; }

  // Helper for address
  const addr = [S?.participant?.address,S?.participant?.suburb,S?.participant?.state,S?.participant?.postcode]
               .filter(Boolean).join(", ");

  // Helper to flatten meds
  const medsFlat = (S?.meds?.list||[])
    .map(m=>[m.name,m.dose,m.route,m.when,m.purpose].filter(Boolean).join(" ‚Ä¢ "))
    .join("\\par ");

  const parts = [];

  // 1) Participant
  parts.push(block("Participant", [
    line("Legal name", S?.participant?.legal_name),
    line("Preferred name", S?.participant?.preferred_name),
    line("Pronouns", S?.participant?.pronouns),
    line("DOB", S?.participant?.dob),
    line("Age", S?.participant?.age),
    line("NDIS number", S?.participant?.ndis),
    line("Plan management", S?.participant?.plan_mgmt),
    line("Plan dates", ((S?.participant?.plan_start||"") + (S?.participant?.plan_end ? (" ‚Üí " + S.participant.plan_end) : ""))),
    line("Phone", S?.participant?.phone),
    line("Email", S?.participant?.email),
    line("Address", addr),
    line("Emergency contact", [S?.emergency?.name,S?.emergency?.rel,S?.emergency?.phone].filter(Boolean).join(" ‚Ä¢ ")),
    line("Support Coordinator", [S?.team?.sc_name,S?.team?.sc_org,S?.team?.sc_email,S?.team?.sc_phone].filter(Boolean).join(" ‚Ä¢ ")),
    line("Plan Manager", [S?.team?.pm_name,S?.team?.pm_org,S?.team?.pm_email,S?.team?.pm_phone].filter(Boolean).join(" ‚Ä¢ ")),
    line("GP", [S?.team?.gp_name,S?.team?.gp_practice,S?.team?.gp_phone,S?.team?.gp_email].filter(Boolean).join(" ‚Ä¢ "))
  ]));

  // 2) Health & Medical
  parts.push(block("Health & Medical", [
    line("Primary diagnoses", S?.health?.primary_dx),
    line("Other diagnoses", S?.health?.other_dx),
    line("Allergies", S?.health?.allergies),
    line("Equipment / aids", S?.health?.equipment),
    line("Cognition / capacity", S?.health?.cognition),
    line("Vision / Hearing", S?.health?.vision_hearing),
    line("Mental health notes", S?.health?.mental_health),
    line("Nutrition / diet", S?.health?.diet)
  ]));

  // 3) Daily Living & Personal Care
  parts.push(block("Daily Living & Personal Care", [
    line("Bathing support", S?.daily?.bathing),
    line("Bathing preferences", S?.daily?.bathing_prefs),
    line("Dressing support", S?.daily?.dressing),
    line("Grooming / oral care", S?.daily?.grooming),
    line("Toileting", S?.daily?.toileting),
    line("Continence management", S?.daily?.continence),
    line("Mobility status", S?.daily?.mobility),
    line("Transfers / hoist", S?.daily?.transfers),
    line("Assistive aids", S?.daily?.aids),
    line("Important routines", S?.daily?.routines),
    line("Home environment / access", S?.daily?.environment),
    line("Home safety notes", S?.risk?.home_check?.notes)
  ]));

  // 4) Communication & Sensory
  parts.push(block("Communication & Sensory", [
    line("Primary language", S?.comms?.language),
    line("Communication method", S?.comms?.method),
    line("Interpreter required", S?.comms?.interpreter),
    line("Interpreter language", S?.comms?.interpreter_lang),
    line("Decision-making support", S?.comms?.decision_support),
    line("Behavioural cues", S?.comms?.cues),
    line("Sensory considerations", S?.comms?.sensory)
  ]));

  // 5) Social & Lifestyle
  parts.push(block("Social & Lifestyle", [
    line("Living situation", S?.social?.living),
    line("Household members", S?.social?.household),
    line("Key supports", S?.social?.supports),
    line("Interests & activities", S?.social?.interests),
    line("Typical routine", S?.social?.routine)
  ]));

  // 6) Behaviour Management
  parts.push(block("Behaviour Management", [
    line("Behaviour(s) of concern", S?.behaviour?.description),
    line("Known triggers / antecedents", S?.behaviour?.triggers),
    line("Early warning signs", S?.behaviour?.early_signs),
    line("Preventative strategies", S?.behaviour?.prevention),
    line("Preferred de-escalation", S?.behaviour?.deescalation),
    line("Post-incident response", S?.behaviour?.post_incident),
    line("BSP in place", (S?.behaviour?.bsp===true?"Yes":S?.behaviour?.bsp===false?"No":(S?.behaviour?.bsp||"‚Äî"))),
    line("Restrictive practices", (S?.behaviour?.restrictive===true?"Yes":S?.behaviour?.restrictive===false?"No":(S?.behaviour?.restrictive||"‚Äî"))),
    line("Restrictive practice notes", S?.behaviour?.restrictive_notes),
    line("Reporting & communication", S?.behaviour?.reporting)
  ]));

  // 7) Medication Management
  parts.push(block("Medication Management", [
    line("Medication list", medsFlat || "‚Äî"),
    line("Self-administration ability", S?.meds?.self_admin),
    line("Webster / blister pack", S?.meds?.webster),
    line("Storage location", S?.meds?.storage),
    line("Access / keys", S?.meds?.access),
    line("Consent to administer", S?.meds?.consent),
    line("Side effects to monitor", S?.meds?.side_effects),
    line("Required monitoring", S?.meds?.monitoring),
    line("Emergency medication plan", S?.meds?.emergency_plan),
    line("Missed / refused dose protocol", S?.meds?.missed),
    line("Recent changes / reviews", S?.meds?.changes)
  ]));

  // 8) Risk & Safety
  parts.push(block("Risk & Safety", [
    line("Falls risk", S?.risk?.falls),
    line("Falls prevention strategies", S?.risk?.falls_strat),
    line("Pressure injury risk", S?.risk?.pressure),
    line("Pressure care strategies", S?.risk?.pressure_strat),
    line("Wandering / elopement risk", S?.risk?.wandering),
    line("Wandering safeguards", S?.risk?.wandering_strat),
    line("Smoking / alcohol / substances", S?.risk?.substances),
    line("Transport & vehicle safety", S?.risk?.transport),
    line("Emergency plan", S?.risk?.emergency_plan)
  ]));

  // 9) Goals & Outcomes
  parts.push(block("Goals & Outcomes", [
    line("Participant goals", S?.goals?.items),
    line("Desired outcomes", S?.goals?.outcomes),
    line("Strategies / supports", S?.goals?.strategies)
  ]));

  // 10) Consents
  parts.push(block("Consents", [
    line("Consent to share plan", (S?.consent?.share_info===true||S?.consent?.share_info==="Yes")?"Yes":(S?.consent?.share_info===false||S?.consent?.share_info==="No")?"No":"‚Äî"),
    line("Consent notes / scope", S?.consent?.share_notes)
  ]));

  // 11) Signatures
  parts.push(block("Signatures", [
    line("Participant / Representative ‚Äî name", S?.signatures?.client_name),
    line("Date", S?.signatures?.client_date),
    line("Provider representative ‚Äî name", S?.signatures?.provider_name),
    line("Role / title", S?.signatures?.provider_role),
    line("Date", S?.signatures?.provider_date)
  ]));

  // Assemble RTF doc
  const rtf = `{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Arial;}}\\fs22 ${parts.join(" ")} }`;

  // Download
const blob = new Blob([rtf], {type:"application/rtf"});
const a = document.createElement("a");
a.href = URL.createObjectURL(blob);
a.download = "NDIS_Care_Plan_Editable.rtf";
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
} // <-- end of downloadRTF()

/* ===========================
   Wire up buttons & voice fill
   =========================== */

// Hook the RTF export button to the new function
(function wireActions(){
  const rtfBtn = document.getElementById("genRTF");
  if (rtfBtn) {
    // Ensure no double-binding
    rtfBtn.replaceWith(rtfBtn.cloneNode(true));
    document.getElementById("genRTF").addEventListener("click", downloadRTF);
  }

  // Add a Mic button (Talk-to-Fill) if not present
  const actions = document.querySelector("header .actions");
  if (actions && !document.getElementById("micBtn")) {
    const mic = document.createElement("button");
    mic.className = "btn";
    mic.type = "button";
    mic.id = "micBtn";
    mic.innerHTML = "üé§ Talk-to-Fill";
    mic.title = "Dictate values like: ‚ÄúSet allergies to no known allergies‚Äù";
    actions.insertBefore(mic, actions.firstChild);
  }
})();

/* ===========================
   Talk-to-Fill (Web Speech API)
   - Say things like:
     ‚ÄúSet name to John Smith‚Äù
     ‚ÄúNDIS number 123456789‚Äù
     ‚ÄúAllergies no known allergies‚Äù
     ‚ÄúAddress 12 River Road‚Äù
   - Then edit manually if needed.
   =========================== */

(function voiceFill(){
  const micBtn = document.getElementById("micBtn");
  if (!micBtn) return;

  // Live transcript HUD
  const hud = document.createElement("div");
  hud.style.cssText = "position:fixed;left:12px;bottom:12px;max-width:520px;padding:10px 12px;border:1px solid #234;color:#dff; background:rgba(4,14,22,.9);border-radius:12px;box-shadow:0 6px 22px rgba(0,0,0,.45);font-size:14px;z-index:9999;display:none";
  hud.id = "speechHud";
  hud.innerHTML = "<b>Listening‚Ä¶</b> <span id='speechText' style='opacity:.9'></span>";
  document.body.appendChild(hud);
  const hudText = document.getElementById("speechText");

  // Map common spoken labels ‚Üí state paths
  const FIELD_MAP = [
    // Participant core
    {k:["name","legal name","participant name"], p:"participant.legal_name", lbl:"Legal name"},
    {k:["preferred name","nickname"], p:"participant.preferred_name", lbl:"Preferred name"},
    {k:["pronouns"], p:"participant.pronouns", lbl:"Pronouns"},
    {k:["dob","date of birth","birth date"], p:"participant.dob", lbl:"Date of birth"},
    {k:["age"], p:"participant.age", lbl:"Age"},
    {k:["ndis","ndis number"], p:"participant.ndis", lbl:"NDIS number"},
    {k:["phone","mobile"], p:"participant.phone", lbl:"Phone"},
    {k:["email","mail"], p:"participant.email", lbl:"Email"},
    {k:["address","street"], p:"participant.address", lbl:"Address (street)"},
    {k:["suburb","town"], p:"participant.suburb", lbl:"Suburb"},
    {k:["state"], p:"participant.state", lbl:"State"},
    {k:["postcode","post code","zip"], p:"participant.postcode", lbl:"Postcode"},
    {k:["plan management","plan manager type","management type"], p:"participant.plan_mgmt", lbl:"Plan management"},
    {k:["plan start","start date"], p:"participant.plan_start", lbl:"Plan start"},
    {k:["plan end","end date"], p:"participant.plan_end", lbl:"Plan end"},

    // Contacts
    {k:["emergency name","emergency contact name"], p:"emergency.name", lbl:"Emergency contact ‚Äî name"},
    {k:["emergency relationship","emergency relation"], p:"emergency.rel", lbl:"Relationship"},
    {k:["emergency phone"], p:"emergency.phone", lbl:"Phone"},

    // Team (SC / PM / GP)
    {k:["support coordinator name","sc name"], p:"team.sc_name", lbl:"Support Coordinator ‚Äî name"},
    {k:["support coordinator organisation","sc organisation","sc organization"], p:"team.sc_org", lbl:"Organisation"},
    {k:["support coordinator email","sc email"], p:"team.sc_email", lbl:"SC email"},
    {k:["support coordinator phone","sc phone"], p:"team.sc_phone", lbl:"SC phone"},
    {k:["plan manager name","pm name"], p:"team.pm_name", lbl:"Plan Manager ‚Äî name"},
    {k:["plan manager organisation","pm organisation","pm organization"], p:"team.pm_org", lbl:"Organisation"},
    {k:["plan manager email","pm email"], p:"team.pm_email", lbl:"PM email"},
    {k:["plan manager phone","pm phone"], p:"team.pm_phone", lbl:"PM phone"},
    {k:["gp name","doctor name"], p:"team.gp_name", lbl:"GP name"},
    {k:["gp practice","doctor practice"], p:"team.gp_practice", lbl:"GP practice"},
    {k:["gp phone","doctor phone"], p:"team.gp_phone", lbl:"GP phone"},
    {k:["gp email","doctor email"], p:"team.gp_email", lbl:"GP email"},

    // Health
    {k:["primary diagnosis","diagnosis","diagnoses"], p:"health.primary_dx", lbl:"Primary diagnoses"},
    {k:["other diagnosis","other diagnoses"], p:"health.other_dx", lbl:"Other diagnoses"},
    {k:["allergy","allergies"], p:"health.allergies", lbl:"Allergies"},
    {k:["equipment","aids"], p:"health.equipment", lbl:"Equipment / aids (mobility, comms)"},
    {k:["cognition","capacity"], p:"health.cognition", lbl:"Cognition / capacity"},
    {k:["vision","hearing"], p:"health.vision_hearing", lbl:"Vision/Hearing considerations"},
    {k:["mental health"], p:"health.mental_health", lbl:"Mental health notes"},
    {k:["diet","nutrition"], p:"health.diet", lbl:"Nutrition / diet"},

    // Daily
    {k:["bathing"], p:"daily.bathing", lbl:"Bathing support level"},
    {k:["bathing preferences"], p:"daily.bathing_prefs", lbl:"Bathing preferences (time, products)"},
    {k:["dressing"], p:"daily.dressing", lbl:"Dressing support"},
    {k:["grooming","oral care"], p:"daily.grooming", lbl:"Grooming/oral care"},
    {k:["toileting"], p:"daily.toileting", lbl:"Toileting"},
    {k:["continence"], p:"daily.continence", lbl:"Continence management (aids/schedule)"},
    {k:["mobility"], p:"daily.mobility", lbl:"Mobility status"},
    {k:["transfers","hoist"], p:"daily.transfers", lbl:"Transfers / hoist"},
    {k:["assistive aids","home aids"], p:"daily.aids", lbl:"Assistive aids in home"},
    {k:["routines"], p:"daily.routines", lbl:"Important routines to maintain"},
    {k:["home environment","access notes","entry notes"], p:"daily.environment", lbl:"Home environment / access notes (parking, pets, keysafe)"},

    // Comms
    {k:["language"], p:"comms.language", lbl:"Primary language"},
    {k:["communication method","comms method"], p:"comms.method", lbl:"Communication method (verbal, AAC, sign, device)"},
    {k:["interpreter required"], p:"comms.interpreter", lbl:"Interpreter required? (Yes/No/Not sure)"},
    {k:["interpreter language"], p:"comms.interpreter_lang", lbl:"Interpreter language"},
    {k:["decision support","guardian","nominee"], p:"comms.decision_support", lbl:"Decision-making support / guardian/nominee"},
    {k:["cues","behaviour cues","behavior cues"], p:"comms.cues", lbl:"Behavioural cues (if non-verbal)"},
    {k:["sensory"], p:"comms.sensory", lbl:"Sensory considerations (noise, lights, textures)"},

    // Social
    {k:["living situation","housing"], p:"social.living", lbl:"Living situation (home type)"},
    {k:["household","family"], p:"social.household", lbl:"Household members / relationships"},
    {k:["supports involved"], p:"social.supports", lbl:"Key family/friends/supports involved"},
    {k:["interests","activities"], p:"social.interests", lbl:"Interests & activities (motivators, community)"},
    {k:["routine"], p:"social.routine", lbl:"Typical daily/weekly routine"},

    // Behaviour
    {k:["behaviour description","behavior description","behaviours of concern"], p:"behaviour.description", lbl:"Behaviour(s) of concern ‚Äî description"},
    {k:["triggers","antecedents"], p:"behaviour.triggers", lbl:"Known triggers / antecedents"},
    {k:["early signs","warning signs"], p:"behaviour.early_signs", lbl:"Early warning signs"},
    {k:["prevention","preventative strategies"], p:"behaviour.prevention", lbl:"Preventative strategies (proactive)"},
    {k:["de escalation","de-escalation"], p:"behaviour.deescalation", lbl:"Preferred de-escalation techniques"},
    {k:["post incident","post-incident"], p:"behaviour.post_incident", lbl:"Post-incident response / debrief / recovery"},

    // Meds (summary fields)
    {k:["self administration","self-admin"], p:"meds.self_admin", lbl:"Self-administration ability"},
    {k:["webster","blister pack"], p:"meds.webster", lbl:"Webster/blister pack"},
    {k:["medication storage","meds storage","storage"], p:"meds.storage", lbl:"Storage location (locked cupboard etc.)"},
    {k:["access keys","keys"], p:"meds.access", lbl:"Access/keys (who holds)"},
    {k:["consent to administer","medication consent"], p:"meds.consent", lbl:"Consent to administer (form, scope)"},
    {k:["side effects"], p:"meds.side_effects", lbl:"Common side effects to monitor & responses"},
    {k:["monitoring required","observations"], p:"meds.monitoring", lbl:"Required monitoring (e.g., BP weekly, BSL before meals)"},
    {k:["emergency medication plan","emergency plan"], p:"meds.emergency_plan", lbl:"Emergency medication plan (EpiPen, midazolam ‚Äî triggers, steps, who to call)"},
    {k:["missed dose","refused dose","missed/refused"], p:"meds.missed", lbl:"Missed/refused dose protocol"},
    {k:["recent changes","medication review"], p:"meds.changes", lbl:"Recent changes / upcoming reviews"},

    // Risk
    {k:["falls risk"], p:"risk.falls", lbl:"Falls risk"},
    {k:["falls strategy","falls prevention"], p:"risk.falls_strat", lbl:"Falls ‚Äî prevention strategies"},
    {k:["pressure injury risk"], p:"risk.pressure", lbl:"Pressure injury risk"},
    {k:["pressure strategy","pressure care"], p:"risk.pressure_strat", lbl:"Pressure care strategies"},
    {k:["wandering risk","elopement risk"], p:"risk.wandering", lbl:"Wandering / elopement risk"},
    {k:["wandering safeguards"], p:"risk.wandering_strat", lbl:"Wandering safeguards (supervision, alarms)"},
    {k:["substances","smoking alcohol"], p:"risk.substances", lbl:"Smoking / alcohol / substances (notes)"},
    {k:["transport safety"], p:"risk.transport", lbl:"Transport & vehicle safety (seating, restraints, WAV)"},
    {k:["emergency plan"], p:"risk.emergency_plan", lbl:"Emergency plan (evac, hospital preferences, contact order)"},

    // Goals & Consents
    {k:["goals"], p:"goals.items", lbl:"Participant goals (from plan / aspirations)"},
    {k:["outcomes"], p:"goals.outcomes", lbl:"Desired outcomes (what success looks like)"},
    {k:["strategies"], p:"goals.strategies", lbl:"Strategies / supports to achieve goals"},
    {k:["consent to share","share plan"], p:"consent.share_info", lbl:"Consent to share plan with relevant parties"},
    {k:["consent notes"], p:"consent.share_notes", lbl:"Consent notes / scope / limits"},

    // Signatures
    {k:["participant name for signature","sign name","signature name"], p:"signatures.client_name", lbl:"Participant / Representative ‚Äî printed name"},
    {k:["signature date","participant date"], p:"signatures.client_date", lbl:"Date"},
    {k:["provider name"], p:"signatures.provider_name", lbl:"Provider representative ‚Äî name"},
    {k:["provider role","title"], p:"signatures.provider_role", lbl:"Role / title"},
    {k:["provider date"], p:"signatures.provider_date", lbl:"Date"}
  ];

  // Try to locate an input/textarea by its label text (best effort)
  function findFieldByLabelText(lbl){
    const labs = document.querySelectorAll(".field > label");
    lbl = (lbl||"").toLowerCase();
    for (const L of labs){
      const t = (L.textContent||"").trim().toLowerCase();
      if (t.includes(lbl)) {
        const holder = L.parentElement;
        const inp = holder.querySelector("input,textarea,select");
        if (inp) return inp;
      }
    }
    return null;
  }

  // Visual flash to show what was updated
  function flash(elm){
    if (!elm) return;
    const old = elm.style.boxShadow;
    elm.style.boxShadow = "0 0 0 3px rgba(34,211,238,.35)";
    setTimeout(()=>{ elm.style.boxShadow = old || ""; }, 800);
  }

  function setPathFromSpeech(path, value, labelForFind){
    // Persist state (uses helpers defined earlier in the app)
    try { set(path, value); persist(); } catch(e){}
    // Try to update visible input if present
    const input = findFieldByLabelText(labelForFind || "");
    if (input) { input.value = value; flash(input); }
  }

  function parseAndApply(transcript){
    const t = transcript.trim();
    hudText.textContent = " ‚Äú" + t + "‚Äù";
    const lower = t.toLowerCase();

    // Try commands like "set allergies to no known allergies"
    const SET_RE = /^(?:set\s+)?(.+?)\s+(?:to|is|:)\s+(.+)$/i;
    let m = lower.match(SET_RE);
    let label, value;
    if (m) { label = m[1].trim(); value = t.slice(t.toLowerCase().indexOf(m[2])).trim(); }
    else {
      // Fallback: "allergies no known allergies"
      const parts = t.split(/[:\-‚Äì]\s*/);
      if (parts.length >= 2){ label = parts[0].trim().toLowerCase(); value = parts.slice(1).join(": ").trim(); }
      else {
        // Heuristic: take first word(s) as label until we hit a number or next uppercase? Keep it simple:
        const firstWord = t.split(/\s+/)[0];
        label = firstWord.toLowerCase();
        value = t.replace(new RegExp("^"+firstWord+"\\s*","i"), "");
      }
    }

    if (!label || !value) return;

    // Match against FIELD_MAP
    let best = null;
    for (const f of FIELD_MAP){
      if (f.k.some(k => label.includes(k))) { best = f; break; }
    }
    if (!best) return;

    // Normalise booleans for certain fields
    if (/^(yes|no|not sure|unknown)$/i.test(value)){
      const norm = value.toLowerCase();
      if (["consent.share_info","behaviour.bsp","behaviour.restrictive"].includes(best.p)) {
        value = (norm==="yes") ? "Yes" : (norm==="no" ? "No" : "Not sure");
      }
    }

    setPathFromSpeech(best.p, value, best.lbl);
  }

  // SpeechRecognition setup
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;
  let listening = false;

  function ensureSR(){
    if (!SR) {
      alert("Speech recognition is not supported in this browser. Try Chrome on desktop.");
      return null;
    }
    const rec = new SR();
    rec.lang = "en-AU";
    rec.interimResults = true;
    rec.continuous = true;
    rec.maxAlternatives = 1;
    return rec;
  }

  function startListening(){
    if (listening) return;
    recognition = ensureSR();
    if (!recognition) return;

    listening = true;
    micBtn.classList.add("primary");
    micBtn.textContent = "üõë Stop Talking";
    hud.style.display = "block";
    hudText.textContent = "";

    recognition.onresult = (ev)=>{
      const r = ev.results;
      let finalTxt = "";
      for (let i=ev.resultIndex; i<r.length; i++){
        const alt = r[i][0]?.transcript || "";
        if (r[i].isFinal) finalTxt += alt + " ";
        else hudText.textContent = " ‚Äú" + alt + "‚Äù (‚Ä¶)";
      }
      if (finalTxt.trim()) {
        parseAndApply(finalTxt.trim());
      }
    };
    recognition.onerror = (e)=>{ console.warn("Speech error:", e.error); };
    recognition.onend = ()=>{ // auto-restart unless stopped
      if (listening) { try { recognition.start(); } catch(e){} }
    };

    try { recognition.start(); } catch(e) { console.error(e); }
  }

  function stopListening(){
    listening = false;
    if (recognition) {
      try { recognition.stop(); } catch(e){}
      recognition = null;
    }
    micBtn.classList.remove("primary");
    micBtn.textContent = "üé§ Talk-to-Fill";
    hud.style.display = "none";
  }

  micBtn.addEventListener("click", ()=>{
    if (!listening) startListening(); else stopListening();
  });

  // Stop listening when navigating away
  window.addEventListener("beforeunload", ()=>{ if (listening) stopListening(); });
})();

/* ===========================
   Optional: small utility to
   open all sections for review
   =========================== */
(function reviewHelper(){
  const btn = document.getElementById("reviewBtn");
  if (!btn) return;
  btn.addEventListener("click", ()=>{
    document.querySelectorAll("details[id^='sec_']").forEach(d=>{
      const key = d.id.replace(/^sec_/,"");
      const disabled = (S && S._nr && S._nr[key]===true);
      d.open = !disabled;
    });
  });
})();

/* ===========================
   Safety: keyboard shortcuts
   - Ctrl/Cmd + S : export RTF
   - Ctrl/Cmd + P : print to PDF
   =========================== */
document.addEventListener("keydown", (e)=>{
  const isMac = navigator.platform.toUpperCase().indexOf("MAC")>=0;
  const mod = isMac ? e.metaKey : e.ctrlKey;
  if (!mod) return;
  if (e.key.toLowerCase() === "s"){
    e.preventDefault();
    if (typeof downloadRTF === "function") downloadRTF();
  }
  // Let Ctrl/Cmd+P fall through to browser print for PDF generation
});


/* ===========================
   End of script
   =========================== */
</script>

<!-- Optional: graceful fallback for users without JS -->
<noscript>
  <div style="max-width:860px;margin:24px auto;padding:12px 16px;border:1px solid #334c85;border-radius:12px;background:#0e1836;color:#e8edff;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif">
    <b>JavaScript is disabled.</b> This care plan requires JavaScript for saving drafts, voice input, file parsing, and exports.
    Please enable JavaScript and reload this page.
  </div>
</noscript>

</body>
</html>


