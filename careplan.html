<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NDIS Comprehensive Care Plan ‚Äî Pro Edition</title>
<meta name="theme-color" content="#0b1420" />
<style>
  :root{
    /* Palette (distinct from AILR: cooler teal/indigo, high contrast) */
    --ink:#0b1420; --bg:#0a0f16; --panel:#0f1722; --line:#253247;
    --text:#e9f3ff; --muted:#b9c8de;
    --a1:#0ea5a5; --a2:#4f46e5; --accent: linear-gradient(135deg, var(--a1), var(--a2));
    --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;

    /* Focus ring */
    --ring: 0 0 0 3px rgba(79,70,229,.35), 0 0 0 5px rgba(14,165,165,.2);
  }
  *{ box-sizing:border-box }
  html,body{height:100%}
  body{
    margin:0; font-family: Inter, system-ui, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at 15% -10%, rgba(14,165,165,.18), transparent 60%),
      radial-gradient(1200px 600px at 85% 0%, rgba(79,70,229,.18), transparent 60%),
      linear-gradient(180deg, #0a0f16 0%, #0b1420 45%, #08101a 100%);
  }
  a{color:#a9d3ff;text-decoration:none} a:hover{color:#d6e7ff}

  /* Header */
  header{
    position:sticky; top:0; z-index:60;
    background: linear-gradient(135deg,#0a111b,#0d1725);
    border-bottom:1px solid var(--line);
    box-shadow: 0 8px 30px rgba(0,0,0,.55);
    backdrop-filter: blur(6px);
  }
  .bar{ max-width:1200px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; gap:12px }
  .brand{ font-weight:900; letter-spacing:.2px; background:var(--accent); -webkit-background-clip:text; -webkit-text-fill-color:transparent }
  .tag{ font-size:12px; color:#9fb7d8 }
  .hint{ color:#9fb7d8; font-size:12px }

  /* Layout */
  .wrap{ max-width:1200px; margin:16px auto 24px; padding:0 16px; display:grid; gap:16px; grid-template-columns: 300px 1fr }
  @media (max-width:980px){ .wrap{ grid-template-columns: 1fr } }

  /* Sidebar */
  .nav{
    position:sticky; top:76px; align-self:start; background:linear-gradient(180deg,#0d1623,#0a1220);
    border:1px solid var(--line); border-radius:18px; padding:14px; box-shadow:0 18px 60px rgba(0,0,0,.55)
  }
  .nav h3{ margin:0 0 8px; font-size:16px; font-weight:900 }
  .toc{ list-style:none; padding:0; margin:0; display:grid; gap:8px; max-height: calc(100vh - 140px); overflow:auto }
  .toc a{
    display:flex; gap:8px; align-items:center; border:1px solid transparent; border-radius:12px; padding:10px 12px; color:#cfe0ff;
    background:linear-gradient(135deg,#0e1725,#0d1422); transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease
  }
  .toc a:hover{ transform: translateY(-1px); box-shadow:0 10px 24px rgba(0,0,0,.4); border-color:var(--line) }
  .badge{ margin-left:auto; font-size:11px; color:#a7ffcf }

  /* Main */
  main{
    border:1px solid var(--line); border-radius:22px; background:linear-gradient(180deg,#0e1826,#0b1420);
    box-shadow:0 24px 70px rgba(0,0,0,.55), inset 0 0 14px rgba(255,255,255,.04);
    padding:18px;
  }
  .headerRow{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap }
  .controls{ display:flex; gap:8px; flex-wrap:wrap }
  .btn{
    border:0; border-radius:14px; padding:12px 14px; font-weight:800; cursor:pointer; min-height:46px;
    background:linear-gradient(135deg,#121f33,#0f192a); color:#e9f3ff; border:1px solid var(--line);
    transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
  }
  .btn:hover{ transform: translateY(-1px); box-shadow:0 12px 28px rgba(0,0,0,.5) }
  .btn.primary{ background:var(--accent); color:#fff; border-color:transparent }
  .btn.warn{ background: linear-gradient(135deg,#1e3350,#344d82); color:#ffd86a; border-color:#314976 }
  .btn.ghost{ background: linear-gradient(135deg,#102034,#0e1a2c) }

  /* Sections */
  details.section{
    border:1px solid var(--line); border-radius:16px; background:linear-gradient(180deg,#0f1a2b,#0c1626);
    padding:10px 12px; margin:12px 0; box-shadow:0 6px 18px rgba(0,0,0,.4)
  }
  details[open].section{ box-shadow:0 14px 40px rgba(0,0,0,.55) }
  summary{
    cursor:pointer; list-style:none; display:flex; gap:10px; align-items:center; font-weight:900;
    background:var(--accent); -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  .sect-meta{ margin-left:auto; display:flex; gap:10px; align-items:center }
  .na{
    display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#cfe0ff; opacity:.95;
    border:1px solid var(--line); border-radius:999px; padding:6px 10px; background:linear-gradient(135deg,#0e1a2d,#0b1626);
  }
  .na input{ width:16px; height:16px }

  /* Grid + inputs */
  .grid{ display:grid; gap:12px }
  .two{ grid-template-columns: repeat(2,minmax(0,1fr)) } .three{ grid-template-columns: repeat(3,minmax(0,1fr)) }
  @media (max-width:900px){ .two,.three{ grid-template-columns:1fr } }
  .box{
    border:1px solid #2a3b57; border-radius:14px; padding:12px; background:linear-gradient(135deg,#102039,#0e1b32);
    box-shadow: inset 0 2px 4px rgba(0,0,0,.35)
  }
  .box label{ font-weight:800; display:block; margin-bottom:6px }
  input[type="text"],input[type="email"],input[type="tel"],input[type="date"],input[type="number"],textarea,select{
    width:100%; padding:12px; border-radius:12px; border:1px solid #314767; background:linear-gradient(135deg,#0f203b,#0d1a31);
    color:#e9f3ff; font-size:15px; outline:none; transition:border-color .2s ease, box-shadow .2s ease
  }
  textarea{ min-height:96px; resize:vertical }
  input:focus, textarea:focus, select:focus{ border-color:#4f46e5; box-shadow:var(--ring) }

  /* mic buttons for dictation */
  .mic{
    position:relative; margin-top:6px; display:inline-flex; align-items:center; gap:6px; font-size:12px;
    padding:6px 8px; border:1px solid var(--line); border-radius:999px; background:linear-gradient(135deg,#0f1f36,#0d1b2e);
    cursor:pointer; user-select:none;
  }
  .mic[data-live="true"]{ box-shadow:0 0 0 4px rgba(239,68,68,.2); border-color:#7b3140 }
  .mic i{ width:8px; height:8px; border-radius:50%; background:#7aa1ff }
  .mic[data-live="true"] i{ background:#ef4444; box-shadow:0 0 8px rgba(239,68,68,.6) }

  /* checklists */
  .ck-list{ list-style:none; padding:0; margin:0; display:grid; gap:8px }
  .ck-row{ display:flex; gap:10px; align-items:center }
  .ck-row input{ width:18px; height:18px }

  /* pills */
  .pill{ display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--line); background:linear-gradient(135deg,#0f1e33,#0e1a2c); font-size:12px; color:#bfe0ff }

  /* signature pad */
  .sigpad{ border:1px dashed #496082; border-radius:10px; background:#0b1628; height:140px; position:relative }
  .sigpad canvas{ width:100%; height:100%; display:block }
  .sig-tools{ display:flex; gap:8px; margin-top:6px }

  /* small helpers */
  .muted{ color:#9fb7d8; font-size:13px }
  .right{ margin-left:auto }
  .sr{ position:absolute; width:1px; height:1px; clip:rect(1px,1px,1px,1px); overflow:hidden } /* screen reader only */

  /* print styles for PDF export */
  @media print{
    header, .nav, .controls .btn.warn, .controls .btn.ghost, .mic, .sig-tools{ display:none !important }
    body{ background:#fff; color:#111 }
    main{ box-shadow:none; background:#fff; border-color:#ddd }
    details.section{ background:#fff; border-color:#ddd }
    summary{ -webkit-text-fill-color:initial; color:#0f172a }
  }
</style>

<!-- PDF.js for robust PDF text extraction -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.worker.min.js";
  }
</script>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">NDIS Comprehensive Care Plan</div>
    <div class="tag">Person-centred ‚Ä¢ Speech-to-fill ‚Ä¢ PDF/RTF export ‚Ä¢ Client-side autofill</div>
    <div class="right hint">Autosaves locally ‚Ä¢ Works offline</div>
  </div>
</header>

<div class="wrap">
  <!-- Sidebar -->
  <aside class="nav" aria-label="Sections">
    <h3>Sections</h3>
    <ul class="toc" id="toc"></ul>
  </aside>

  <!-- Main -->
  <main id="app" role="region" aria-live="polite">
    <div class="headerRow">
      <div class="pill">Status: <span id="statusTxt">Draft saved</span></div>
      <div class="controls">
        <button class="btn ghost" id="dictationToggle" type="button">üéôÔ∏è Dictation: Off</button>
        <label class="btn ghost" for="fileInput">üì§ Upload PDF/RTF to auto-fill</label>
        <input id="fileInput" type="file" accept=".pdf,.rtf,.txt" class="sr" />
        <button class="btn warn" id="resetBtn" type="button">‚Ü∫ Reset</button>
        <button class="btn" id="rtfBtn" type="button">‚¨áÔ∏è Download .RTF</button>
        <button class="btn primary" id="pdfBtn" type="button">üñ®Ô∏è Generate PDF</button>
      </div>
    </div>

    <!-- Sections (details/summary accordions). Each has a "Not required" toggle. -->
    <!-- 1. Participant -->
    <details class="section" id="sec-participant" open>
      <summary>
        1) Participant ‚Äî Personal & NDIS identifiers
        <span class="sect-meta">
          <span class="pill">Required</span>
          <label class="na"><input type="checkbox" data-na="participant"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Legal name</label><input data-field="participant.legal_name" type="text" placeholder="e.g., Jane A. Citizen"><div class="mic" data-mic="participant.legal_name"><i></i>Dictate</div></div>
        <div class="box"><label>Preferred name</label><input data-field="participant.preferred_name" type="text"><div class="mic" data-mic="participant.preferred_name"><i></i>Dictate</div></div>
        <div class="box"><label>Date of birth</label><input data-field="participant.dob" type="date"></div>
        <div class="box"><label>NDIS number</label><input data-field="participant.ndis_number" type="text"></div>
        <div class="box"><label>Address line 1</label><input data-field="participant.address.line1" type="text"><div class="mic" data-mic="participant.address.line1"><i></i>Dictate</div></div>
        <div class="box"><label>Address line 2</label><input data-field="participant.address.line2" type="text"></div>
        <div class="box"><label>Suburb</label><input data-field="participant.address.suburb" type="text"></div>
        <div class="box"><label>State</label><input data-field="participant.address.state" type="text" placeholder="e.g., VIC"></div>
        <div class="box"><label>Postcode</label><input data-field="participant.address.postcode" type="text"></div>
        <div class="box"><label>Plan management</label>
          <select data-field="participant.plan_mgmt">
            <option value="">Select‚Ä¶</option>
            <option>NDIA-managed</option><option>Plan-managed</option><option>Self-managed</option><option>Not sure</option>
          </select>
        </div>
        <div class="box"><label>Plan dates ‚Äî start</label><input data-field="participant.plan_dates.start" type="date"></div>
        <div class="box"><label>Plan dates ‚Äî end</label><input data-field="participant.plan_dates.end" type="date"></div>
        <div class="box"><label>Plan manager ‚Äî org</label><input data-field="participant.pm.org" type="text"></div>
        <div class="box"><label>Plan manager ‚Äî contact</label><input data-field="participant.pm.contact" type="text"></div>
        <div class="box"><label>Plan manager ‚Äî email</label><input data-field="participant.pm.email" type="email"></div>
        <div class="box"><label>Plan manager ‚Äî phone</label><input data-field="participant.pm.phone" type="tel"></div>
      </div>
      <div class="grid two" style="margin-top:10px">
        <div class="box"><label>Participant email</label><input data-field="contacts.email" type="email"></div>
        <div class="box"><label>Participant phone</label><input data-field="contacts.phone" type="tel"></div>
      </div>
      <div class="muted" style="margin-top:6px">At least email or phone will be required at submission/export.</div>
    </details>

    <!-- 2. Health & Medical -->
    <details class="section" id="sec-health">
      <summary>
        2) Health & Medical (diagnoses, allergies, mobility, cognition)
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="health"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Primary diagnoses</label><textarea data-field="health.primary_diagnoses" placeholder="e.g., Cerebral palsy GMFCS III; Epilepsy"></textarea><div class="mic" data-mic="health.primary_diagnoses"><i></i>Dictate</div></div>
        <div class="box"><label>Other diagnoses</label><textarea data-field="health.other_diagnoses"></textarea><div class="mic" data-mic="health.other_diagnoses"><i></i>Dictate</div></div>
        <div class="box"><label>Allergies <span class="pill">required</span></label><input data-field="health.allergies" type="text" placeholder="Write ‚ÄúNo known allergies‚Äù if none"><div class="mic" data-mic="health.allergies"><i></i>Dictate</div></div>
        <div class="box"><label>Equipment / aids</label><input data-field="health.equipment" type="text" placeholder="e.g., wheelchair, hoist, comms device"><div class="mic" data-mic="health.equipment"><i></i>Dictate</div></div>
        <div class="box"><label>Mobility</label>
          <select data-field="health.mobility">
            <option value="">Select‚Ä¶</option><option>Independent</option><option>With aid</option><option>Requires transfer</option><option>Bed-bound</option><option>Prefer not to say</option>
          </select>
        </div>
        <div class="box"><label>Continence</label>
          <select data-field="health.continence">
            <option value="">Select‚Ä¶</option><option>Independent</option><option>Needs prompting</option><option>Incontinent</option><option>Catheter / stoma</option><option>Prefer not to say</option>
          </select>
        </div>
        <div class="box"><label>Cognition</label>
          <select data-field="health.cognition">
            <option value="">Select‚Ä¶</option><option>Clear</option><option>Mild impairment</option><option>Moderate</option><option>Severe</option><option>Prefer not to say</option>
          </select>
        </div>
        <div class="box"><label>Diet / swallowing notes</label><textarea data-field="health.diet_notes"></textarea><div class="mic" data-mic="health.diet_notes"><i></i>Dictate</div></div>
        <div class="box"><label>Pressure injury risk</label>
          <select data-field="health.pressure_risk">
            <option value="">Select‚Ä¶</option><option>Low</option><option>Medium</option><option>High</option><option>Not sure</option>
          </select>
        </div>
        <div class="box"><label>Falls risk</label>
          <select data-field="health.falls_risk">
            <option value="">Select‚Ä¶</option><option>Low</option><option>Medium</option><option>High</option><option>Not sure</option>
          </select>
        </div>
      </div>
      <div class="grid three" style="margin-top:10px">
        <div class="box"><label>Seizures?</label>
          <select data-field="health.seizures.has"><option value="">Select‚Ä¶</option><option>No</option><option>Yes</option><option>Not sure</option></select>
        </div>
        <div class="box"><label>Seizure plan</label><input data-field="health.seizures.plan" type="text"><div class="mic" data-mic="health.seizures.plan"><i></i>Dictate</div></div>
        <div class="box"><label>Seizure frequency</label><input data-field="health.seizures.frequency" type="text"><div class="mic" data-mic="health.seizures.frequency"><i></i>Dictate</div></div>
      </div>
    </details>

    <!-- 3. Daily Living & Personal Care -->
    <details class="section" id="sec-adl">
      <summary>
        3) Daily Living & Personal Care (ADLs)
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="adl"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Bathing / showering</label><textarea data-field="adl.bathing" placeholder="Level of support, time of day preference, equipment (shower chair), temperature preferences, dignity notes"></textarea><div class="mic" data-mic="adl.bathing"><i></i>Dictate</div></div>
        <div class="box"><label>Dressing / grooming</label><textarea data-field="adl.dressing"></textarea><div class="mic" data-mic="adl.dressing"><i></i>Dictate</div></div>
        <div class="box"><label>Toileting / continence care</label><textarea data-field="adl.toileting"></textarea><div class="mic" data-mic="adl.toileting"><i></i>Dictate</div></div>
        <div class="box"><label>Meal prep / feeding</label><textarea data-field="adl.meals"></textarea><div class="mic" data-mic="adl.meals"><i></i>Dictate</div></div>
        <div class="box"><label>Mobility & transfers</label><textarea data-field="adl.mobility"></textarea><div class="mic" data-mic="adl.mobility"><i></i>Dictate</div></div>
        <div class="box"><label>Household tasks (cleaning, laundry)</label><textarea data-field="adl.household"></textarea><div class="mic" data-mic="adl.household"><i></i>Dictate</div></div>
        <div class="box"><label>Transport / community access</label><textarea data-field="adl.transport"></textarea><div class="mic" data-mic="adl.transport"><i></i>Dictate</div></div>
        <div class="box"><label>Routines & preferences</label><textarea data-field="adl.routines"></textarea><div class="mic" data-mic="adl.routines"><i></i>Dictate</div></div>
      </div>
    </details>

    <!-- 4. Communication & Sensory -->
    <details class="section" id="sec-comms">
      <summary>
        4) Communication & Sensory
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="comms"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Primary language</label><input data-field="comms.language" type="text"><div class="mic" data-mic="comms.language"><i></i>Dictate</div></div>
        <div class="box"><label>Interpreter</label>
          <select data-field="comms.interpreter"><option value="">Select‚Ä¶</option><option>Required</option><option>Not required</option><option>Not sure</option></select>
        </div>
        <div class="box"><label>Communication methods</label><textarea data-field="comms.methods" placeholder="Verbal, sign, AAC device; how to present info; decision-making support"></textarea><div class="mic" data-mic="comms.methods"><i></i>Dictate</div></div>
        <div class="box"><label>Sensory considerations</label><textarea data-field="comms.sensory" placeholder="Noise/light sensitivities; calming strategies"></textarea><div class="mic" data-mic="comms.sensory"><i></i>Dictate</div></div>
        <div class="box"><label>Worker preferences</label><textarea data-field="comms.worker_prefs" placeholder="Gender preference; cultural considerations; continuity"></textarea><div class="mic" data-mic="comms.worker_prefs"><i></i>Dictate</div></div>
      </div>
    </details>

    <!-- 5. Social & Lifestyle -->
    <details class="section" id="sec-social">
      <summary>
        5) Social & Lifestyle
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="social"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Living situation</label><textarea data-field="social.living" placeholder="Who lives at home; access/parking notes"></textarea><div class="mic" data-mic="social.living"><i></i>Dictate</div></div>
        <div class="box"><label>Support network</label><textarea data-field="social.network" placeholder="Family/friends involved; key contacts"></textarea><div class="mic" data-mic="social.network"><i></i>Dictate</div></div>
        <div class="box"><label>Interests & activities</label><textarea data-field="social.interests" placeholder="Hobbies; community activities; meaningful engagement"></textarea><div class="mic" data-mic="social.interests"><i></i>Dictate</div></div>
        <div class="box"><label>Typical routine</label><textarea data-field="social.routine"></textarea><div class="mic" data-mic="social.routine"><i></i>Dictate</div></div>
      </div>
    </details>

    <!-- 6. Behaviour Management -->
    <details class="section" id="sec-behaviour">
      <summary>
        6) Behaviour Management (BSP, triggers, proactive & response strategies)
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="behaviour"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Behaviours of concern ‚Äî description</label><textarea data-field="behaviour.description" placeholder="Topography: what it looks like, frequency, intensity, duration"></textarea><div class="mic" data-mic="behaviour.description"><i></i>Dictate</div></div>
        <div class="box"><label>Known triggers / antecedents</label><textarea data-field="behaviour.triggers" placeholder="Noise, transitions, demands, sensory overload, pain, hunger"></textarea><div class="mic" data-mic="behaviour.triggers"><i></i>Dictate</div></div>
        <div class="box"><label>Preventative strategies</label><textarea data-field="behaviour.prevent" placeholder="Predictable routines, visual schedules, choices, skill building, environment changes"></textarea><div class="mic" data-mic="behaviour.prevent"><i></i>Dictate</div></div>
        <div class="box"><label>De-escalation strategies</label><textarea data-field="behaviour.deescalate" placeholder="Calm voice, space, preferred activity, sensory tools, time-away"></textarea><div class="mic" data-mic="behaviour.deescalate"><i></i>Dictate</div></div>
        <div class="box"><label>Post-incident support / review</label><textarea data-field="behaviour.post" placeholder="Debrief, data capture, adapt strategies, communication with stakeholders"></textarea><div class="mic" data-mic="behaviour.post"><i></i>Dictate</div></div>
        <div class="box"><label>BSP in place?</label>
          <select data-field="behaviour.bsp"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option><option>Not sure</option></select>
        </div>
        <div class="box"><label>Restrictive practices involved?</label>
          <select data-field="behaviour.restrictive"><option value="">Select‚Ä¶</option><option>No</option><option>Chemical</option><option>Physical</option><option>Mechanical</option><option>Seclusion</option></select>
        </div>
        <div class="box"><label>Authorisations & review cycle</label><textarea data-field="behaviour.authorisations" placeholder="Authorising body, expiry, reduction plan, safeguards"></textarea><div class="mic" data-mic="behaviour.authorisations"><i></i>Dictate</div></div>
      </div>
    </details>

    <!-- 7. Medication Management -->
    <details class="section" id="sec-meds">
      <summary>
        7) Medication Management (full list, schedules, storage, PRN, emergencies)
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="meds"> Not required</label>
        </span>
      </summary>
      <div class="box">
        <label>Medication table</label>
        <div class="muted">Add all regular and PRN medications (name, dose, route, times, purpose). Use the + button to add rows. Consider side-effects monitoring.</div>
        <table id="medTable" style="width:100%; border-collapse:separate; border-spacing:0 8px; margin-top:8px">
          <thead>
            <tr style="font-size:12px;color:#cfe0ff">
              <th align="left">Name</th><th align="left">Dose</th><th align="left">Route</th><th align="left">Times</th><th align="left">Purpose</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button class="btn ghost" id="addMed">Ôºã Add medication</button>
      </div>
      <div class="grid two" style="margin-top:10px">
        <div class="box"><label>Self-administration ability</label><textarea data-field="meds.self" placeholder="Independent vs prompting vs staff administer; capacity notes"></textarea><div class="mic" data-mic="meds.self"><i></i>Dictate</div></div>
        <div class="box"><label>Webster / blister pack</label><select data-field="meds.webster"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option><option>Not sure</option></select></div>
        <div class="box"><label>Storage & access control</label><textarea data-field="meds.storage" placeholder="Locked cupboard; temperature; keys held by‚Ä¶"></textarea><div class="mic" data-mic="meds.storage"><i></i>Dictate</div></div>
        <div class="box"><label>Consent for administration</label><select data-field="meds.consent"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option><option>Not applicable</option></select></div>
        <div class="box"><label>Side-effects to monitor</label><textarea data-field="meds.sidefx" placeholder="By medication (e.g., dizziness, GI upset), what to do, who to inform"></textarea><div class="mic" data-mic="meds.sidefx"><i></i>Dictate</div></div>
        <div class="box"><label>Emergency meds & protocol</label><textarea data-field="meds.emergency" placeholder="e.g., EpiPen, midazolam: indications, steps, escalation"></textarea><div class="mic" data-mic="meds.emergency"><i></i>Dictate</div></div>
        <div class="box"><label>Missed dose protocol</label><textarea data-field="meds.missed" placeholder="Do not double dose; contact GP if‚Ä¶; document/refuse protocol"></textarea><div class="mic" data-mic="meds.missed"><i></i>Dictate</div></div>
        <div class="box"><label>Recent changes / upcoming reviews</label><textarea data-field="meds.changes"></textarea><div class="mic" data-mic="meds.changes"><i></i>Dictate</div></div>
      </div>
    </details>

    <!-- 8. Risk & Safety -->
    <details class="section" id="sec-risk">
      <summary>
        8) Risk & Safety (home, falls, pressure, wandering, transport)
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="risk"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Home safety checklist</label>
          <ul class="ck-list">
            <li class="ck-row"><input type="checkbox" data-field="risk.home.trip"> <span>Trip hazards present</span></li>
            <li class="ck-row"><input type="checkbox" data-field="risk.home.smoke"> <span>No working smoke alarms</span></li>
            <li class="ck-row"><input type="checkbox" data-field="risk.home.light"> <span>Poor lighting</span></li>
            <li class="ck-row"><input type="checkbox" data-field="risk.home.bath"> <span>Bathroom lacks rails / mats</span></li>
          </ul>
        </div>
        <div class="box"><label>Notes / mitigations</label><textarea data-field="risk.home.notes"></textarea><div class="mic" data-mic="risk.home.notes"><i></i>Dictate</div></div>
        <div class="box"><label>Wandering / elopement risk</label>
          <select data-field="risk.wander"><option value="">Select‚Ä¶</option><option>None</option><option>Low</option><option>Medium</option><option>High</option></select>
        </div>
        <div class="box"><label>Smoking / alcohol / substances</label><textarea data-field="risk.substances"></textarea><div class="mic" data-mic="risk.substances"><i></i>Dictate</div></div>
        <div class="box"><label>Transport safety</label><textarea data-field="risk.transport" placeholder="Wheelchair accessible vehicle, restraints, escort"></textarea><div class="mic" data-mic="risk.transport"><i></i>Dictate</div></div>
        <div class="box"><label>Emergency plan</label><textarea data-field="risk.emergency" placeholder="Evacuation, who to contact first, hospital preferences"></textarea><div class="mic" data-mic="risk.emergency"><i></i>Dictate</div></div>
      </div>
    </details>

    <!-- 9. Goals & Outcomes -->
    <details class="section" id="sec-goals">
      <summary>
        9) Goals & Outcomes (link supports to participant goals)
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="goals"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Participant goals</label><textarea data-field="goals.list" placeholder="List goals (from NDIS plan or personal)"></textarea><div class="mic" data-mic="goals.list"><i></i>Dictate</div></div>
        <div class="box"><label>Success indicators / outcomes</label><textarea data-field="goals.outcomes" placeholder="What does success look like? (measurable if possible)"></textarea><div class="mic" data-mic="goals.outcomes"><i></i>Dictate</div></div>
        <div class="box"><label>Support strategies to reach goals</label><textarea data-field="goals.supports" placeholder="How supports delivered will help achieve goals"></textarea><div class="mic" data-mic="goals.supports"><i></i>Dictate</div></div>
        <div class="box"><label>Scheduling / frequency notes</label><textarea data-field="goals.schedule"></textarea><div class="mic" data-mic="goals.schedule"><i></i>Dictate</div></div>
      </div>
    </details>

    <!-- 10. Consents & Attachments -->
    <details class="section" id="sec-consents">
      <summary>
        10) Consents & Attachments (info sharing; uploaded files)
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="consents"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box"><label>Consent to share plan</label>
          <select data-field="consents.share"><option value="">Select‚Ä¶</option><option>Yes</option><option>No</option><option>Not sure</option></select>
        </div>
        <div class="box"><label>Consent notes</label><textarea data-field="consents.notes"></textarea><div class="mic" data-mic="consents.notes"><i></i>Dictate</div></div>
        <div class="box"><label>Emergency contact</label><input data-field="contacts.emer.name" type="text" placeholder="Name"> <div style="height:8px"></div>
          <input data-field="contacts.emer.rel" type="text" placeholder="Relationship" style="margin-top:6px">
          <input data-field="contacts.emer.phone" type="tel" placeholder="Phone" style="margin-top:6px">
        </div>
        <div class="box"><label>Support coordinator</label><input data-field="contacts.sc.name" type="text" placeholder="Name">
          <input data-field="contacts.sc.org" type="text" placeholder="Organisation" style="margin-top:6px">
          <input data-field="contacts.sc.email" type="email" placeholder="Email" style="margin-top:6px">
        </div>
        <div class="box"><label>GP / Practice</label><input data-field="contacts.gp.name" type="text" placeholder="GP name">
          <input data-field="contacts.gp.practice" type="text" placeholder="Practice" style="margin-top:6px">
          <input data-field="contacts.gp.phone" type="tel" placeholder="Phone" style="margin-top:6px">
          <input data-field="contacts.gp.email" type="email" placeholder="Email" style="margin-top:6px">
        </div>
        <div class="box"><label>Uploaded files (auto-fill source)</label>
          <ul id="uploadList" class="ck-list"></ul>
          <div class="muted">Use the ‚ÄúUpload PDF/RTF‚Äù button at the top to add documents that will be parsed and mapped into fields.</div>
        </div>
      </div>
    </details>

    <!-- 11. Signatures & Authorisation -->
    <details class="section" id="sec-sign">
      <summary>
        11) Signatures & Authorisation
        <span class="sect-meta">
          <label class="na"><input type="checkbox" data-na="sign"> Not required</label>
        </span>
      </summary>
      <div class="grid two">
        <div class="box">
          <label>Participant / Representative ‚Äî type name</label>
          <input data-field="sign.participant_name" type="text" placeholder="Printed name">
          <div class="sigpad" data-sig="participant"><canvas></canvas></div>
          <div class="sig-tools">
            <button class="btn ghost" data-sig-clear="participant" type="button">Clear</button>
            <button class="btn ghost" data-sig-undo="participant" type="button">Undo</button>
          </div>
          <div class="box" style="margin-top:10px"><label>Date</label><input data-field="sign.participant_date" type="date"></div>
        </div>
        <div class="box">
          <label>Provider Representative ‚Äî name & title</label>
          <input data-field="sign.provider_name" type="text" placeholder="Name">
          <input data-field="sign.provider_title" type="text" placeholder="Title/Role" style="margin-top:6px">
          <div class="sigpad" data-sig="provider"><canvas></canvas></div>
          <div class="sig-tools">
            <button class="btn ghost" data-sig-clear="provider" type="button">Clear</button>
            <button class="btn ghost" data-sig-undo="provider" type="button">Undo</button>
          </div>
          <div class="box" style="margin-top:10px"><label>Date</label><input data-field="sign.provider_date" type="date"></div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">Signature blocks capture drawn signatures and embed them into the exported PDF and .RTF (as text reference). If left blank, outputs will show a signing line.</div>
    </details>
  </main>
</div>

<script>
/* ============================================================
   Data model & utilities
============================================================ */
const STORAGE_KEY = "ndis_care_plan_pro_v1";

/* App state */
let S = {
  participant:{ legal_name:"", preferred_name:"", dob:"", ndis_number:"",
    address:{line1:"",line2:"",suburb:"",state:"",postcode:""},
    plan_mgmt:"", plan_dates:{start:"",end:""}, pm:{org:"",contact:"",email:"",phone:""} },
  contacts:{ email:"", phone:"",
    emer:{name:"",rel:"",phone:""},
    sc:{name:"",org:"",email:""},
    gp:{name:"",practice:"",phone:"",email:""} },
  health:{ primary_diagnoses:"", other_diagnoses:"", allergies:"", equipment:"",
    mobility:"", continence:"", cognition:"", diet_notes:"", pressure_risk:"", falls_risk:"",
    seizures:{has:"",plan:"",frequency:""} },
  adl:{ bathing:"", dressing:"", toileting:"", meals:"", mobility:"", household:"", transport:"", routines:"" },
  comms:{ language:"", interpreter:"", methods:"", sensory:"", worker_prefs:"" },
  social:{ living:"", network:"", interests:"", routine:"" },
  behaviour:{ description:"", triggers:"", prevent:"", deescalate:"", post:"", bsp:"", restrictive:"", authorisations:"" },
  meds:{ list:[], self:"", webster:"", storage:"", consent:"", sidefx:"", emergency:"", missed:"", changes:"" },
  risk:{ home:{trip:false,smoke:false,light:false,bath:false,notes:""}, wander:"", substances:"", transport:"", emergency:"" },
  goals:{ list:"", outcomes:"", supports:"", schedule:"" },
  consents:{ share:"", notes:"" },
  sign:{ participant_name:"", participant_date:"", provider_name:"", provider_title:"", provider_date:"", sigs:{} },
  uploads:[],
  na:{ participant:false, health:false, adl:false, comms:false, social:false, behaviour:false, meds:false, risk:false, goals:false, consents:false, sign:false },
  dictation:false
};

/* Save/restore */
function save(){
  try{
    const serial = JSON.stringify(S);
    localStorage.setItem(STORAGE_KEY, serial);
    setStatus("Draft saved");
  }catch(e){ console.warn("save failed", e); }
}
function restore(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const prev = JSON.parse(raw);
    if (prev && typeof prev === "object") S = Object.assign(S, prev);
  }catch(e){ console.warn("restore failed", e); }
}
function setStatus(t){ document.getElementById('statusTxt').textContent = t; }

/* Field binding */
function bindAll(){
  // inputs/selects/textarea
  document.querySelectorAll('[data-field]').forEach(node=>{
    const path = node.getAttribute('data-field');
    // set initial
    const v = get(S, path);
    if (node.type === 'checkbox') node.checked = !!v; else if (v!=null) node.value = v;
    // listen
    node.addEventListener('input', ()=>{
      set(S, path, node.type==='checkbox'? node.checked : node.value);
      save();
    });
  });
  // NA toggles
  document.querySelectorAll('input[data-na]').forEach(cb=>{
    const key = cb.getAttribute('data-na');
    cb.checked = !!S.na[key];
    applyNA(key, cb.checked);
    cb.addEventListener('change', ()=>{
      S.na[key] = cb.checked; applyNA(key, cb.checked); save();
    });
  });
}

/* Enable/disable subsection */
function applyNA(key, val){
  const section = document.querySelector(`#sec-${key}`) || document.querySelector(`[id="sec-${key}"]`);
  if (!section) return;
  section.querySelectorAll('input,select,textarea,button').forEach(el=>{
    if (el.closest('summary') || el.hasAttribute('data-na') || el.id==='addMed') return; // keep toggles active
    el.disabled = !!val;
  });
  section.style.opacity = val ? .55 : 1;
}

/* Deep get/set helpers */
function get(obj, path){
  return path.split('.').reduce((o,k)=> (o ? o[k] : undefined), obj);
}
function set(obj, path, val){
  const parts = path.split('.');
  const last = parts.pop();
  const parent = parts.reduce((o,k)=> (o[k]??(o[k]={})), obj);
  parent[last] = val;
}

/* Table: medications */
const medTableBody = ()=> document.querySelector('#medTable tbody');
function addMedRow(item={name:"",dose:"",route:"",times:"",purpose:""}){
  S.meds.list.push(item);
  renderMedRows();
  save();
}
function removeMedRow(ix){
  S.meds.list.splice(ix,1);
  renderMedRows();
  save();
}
function renderMedRows(){
  const tb = medTableBody();
  tb.innerHTML = "";
  S.meds.list.forEach((m,ix)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" value="${m.name||""}" data-med="${ix}.name"></td>
      <td><input type="text" value="${m.dose||""}" data-med="${ix}.dose"></td>
      <td><input type="text" value="${m.route||""}" data-med="${ix}.route"></td>
      <td><input type="text" value="${m.times||""}" data-med="${ix}.times"></td>
      <td><input type="text" value="${m.purpose||""}" data-med="${ix}.purpose"></td>
      <td><button class="btn ghost" data-med-del="${ix}" type="button">‚úï</button></td>
    `;
    tb.appendChild(tr);
  });
  // bind
  tb.querySelectorAll('[data-med]').forEach(inp=>{
    const p = inp.getAttribute('data-med');
    inp.addEventListener('input', ()=>{
      const [i, key] = p.split('.');
      S.meds.list[+i][key] = inp.value;
      save();
    });
  });
  tb.querySelectorAll('[data-med-del]').forEach(btn=>{
    btn.addEventListener('click', ()=> removeMedRow(+btn.getAttribute('data-med-del')));
  });
}

/* Upload & autofill ‚Äî PDF.js + RTF */
function addUploadTag(name){ 
  const li=document.createElement('li'); li.textContent = name; 
  document.getElementById('uploadList').appendChild(li);
}
async function extractPdfText(file){
  if (!window.pdfjsLib) throw new Error("PDF.js not loaded");
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
  let full = "";
  for (let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p);
    const c = await page.getTextContent();
    full += c.items.map(it=>it.str).join(" ") + "\n\n";
  }
  return full.trim();
}
function rtfToText(rtf){
  // very lightweight: strips {\control} and \'xx hex codes into unicode
  let t = rtf.replace(/\\'([0-9a-fA-F]{2})/g, (_,h)=> String.fromCharCode(parseInt(h,16)));
  t = t.replace(/\\par[d]?/g,"\n");
  t = t.replace(/\\[a-z]+\d* ?/g,""); // control words
  t = t.replace(/[{}]/g,"");
  return t.replace(/\n{3,}/g,"\n\n").trim();
}
function mapTextToFields(text){
  // heuristic keyword mapping ‚Äî extend as necessary
  const map = [
    { re:/\b(Allerg(?:y|ies)|Allergic to)\s*[:\-]\s*([^\n]+)/i, field:"health.allergies" },
    { re:/\bDiagnoses?\s*[:\-]\s*([^\n]+)/i, field:"health.primary_diagnoses" },
    { re:/\bOther diagnoses?\s*[:\-]\s*([^\n]+)/i, field:"health.other_diagnoses" },
    { re:/\bNDIS\s*(No|Number)\s*[:\-]\s*([0-9\s]+)/i, field:"participant.ndis_number" },
    { re:/\bAddress\s*[:\-]\s*([^\n]+)/i, field:"participant.address.line1" },
    { re:/\bPlan\s*management\s*[:\-]\s*([^\n]+)/i, field:"participant.plan_mgmt" },
    { re:/\bGP\s*(?:Name)?\s*[:\-]\s*([^\n]+)/i, field:"contacts.gp.name" },
    { re:/\bEmergency\s*Contact\s*[:\-]\s*([^\n]+)/i, field:"contacts.emer.name" },
    { re:/\bMedication(?:s)?\s*[:\-]\s*([^\n]+)/i, field:"meds.changes" }, // catch-all
  ];
  map.forEach(m=>{
    const hit = text.match(m.re);
    if (hit){ set(S, m.field, (hit[2]||hit[1]).trim()); }
  });

  // crude medication line detection
  const medLines = text.split(/\n/).filter(l=>/\b(mg|mcg|ml)\b/i.test(l) && /\b(am|pm|daily|noon|night|prn)\b/i.test(l));
  medLines.forEach(l=>{
    const m = { name:"", dose:"", route:"", times:"", purpose:"" };
    const dose = l.match(/\b\d+(\.\d+)?\s*(mg|mcg|ml)\b/i); if (dose) m.dose = dose[0];
    const route = l.match(/\b(oral|po|inhaled|neb|patch|sc|im|iv)\b/i); if (route) m.route = route[0].toUpperCase();
    const times = l.match(/\b(morning|noon|evening|night|am|pm|daily|bd|tds|qds|prn)\b/gi); if (times) m.times = Array.from(new Set(times)).join(", ");
    m.name = l.split(/[:\-]/)[0].trim();
    S.meds.list.push(m);
  });
}

/* Dictation */
let recognizer=null, recField=null, globalDictation=false;
function initSpeech(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return null;
  const r = new SR();
  r.continuous = true; r.interimResults = true; r.lang = "en-AU";
  r.onresult = (evt)=>{
    let transcript = "";
    for (let i=evt.resultIndex; i<evt.results.length; i++){
      transcript += evt.results[i][0].transcript;
    }
    if (recField){
      const el = document.querySelector(`[data-field="${recField}"]`);
      if (el){
        el.value = transcript.trim();
        set(S, recField, el.value); save();
      }
    }
  };
  r.onerror = (e)=>{ console.warn("speech error", e); stopSpeech(); };
  r.onend = ()=>{ if (globalDictation && recField) startSpeech(recField); }; // auto-restart when global on
  return r;
}
function startSpeech(field){
  if (!recognizer) recognizer = initSpeech();
  if (!recognizer) { alert("Speech recognition not supported in this browser."); return; }
  recField = field;
  document.querySelectorAll('.mic').forEach(m=>m.dataset.live="false");
  const m = document.querySelector(`.mic[data-mic="${field}"]`);
  if (m) m.dataset.live="true";
  try{ recognizer.start(); }catch{}
}
function stopSpeech(){
  if (recognizer){ try{ recognizer.stop(); }catch{} }
  document.querySelectorAll('.mic').forEach(m=>m.dataset.live="false");
  recField = null;
}

/* Signature pad (simple canvas freehand with undo) */
const sigPads = {};
function initSigPads(){
  document.querySelectorAll('.sigpad').forEach(wrap=>{
    const key = wrap.getAttribute('data-sig');
    const canvas = wrap.querySelector('canvas');
    const ctx = canvas.getContext('2d');
    const strokes = []; let drawing=false; let current=[];

    function resize(){
      const r = wrap.getBoundingClientRect();
      const tmp = document.createElement('canvas');
      tmp.width = r.width; tmp.height = r.height;
      tmp.getContext('2d').drawImage(canvas,0,0);
      canvas.width = r.width; canvas.height = r.height;
      ctx.drawImage(tmp,0,0);
    }
    const ro = new ResizeObserver(resize); ro.observe(wrap); resize();

    canvas.addEventListener('pointerdown', e=>{ drawing=true; current=[{x:e.offsetX,y:e.offsetY}]; });
    canvas.addEventListener('pointermove', e=>{
      if (!drawing) return; current.push({x:e.offsetX,y:e.offsetY}); redraw();
    });
    window.addEventListener('pointerup', ()=>{
      if (drawing){ drawing=false; if (current.length>0){ strokes.push(current); current=[]; saveSig(); } }
    });

    function redraw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.lineWidth = 2; ctx.lineJoin="round"; ctx.lineCap="round"; ctx.strokeStyle="#9ed0ff";
      [...strokes, current].forEach(st=>{
        if (!st || st.length<2) return;
        ctx.beginPath();
        ctx.moveTo(st[0].x, st[0].y);
        for (let i=1;i<st.length;i++) ctx.lineTo(st[i].x, st[i].y);
        ctx.stroke();
      });
    }
    function toDataURL(){ return canvas.toDataURL("image/png"); }
    function clear(){ strokes.length=0; current=[]; redraw(); saveSig(); }
    function undo(){ strokes.pop(); redraw(); saveSig(); }
    function saveSig(){ S.sign.sigs[key] = strokes.length? toDataURL(): ""; save(); }

    sigPads[key] = { clear, undo, data:()=>S.sign.sigs[key]||"" };
  });

  document.querySelectorAll('[data-sig-clear]').forEach(b=>{
    b.addEventListener('click', ()=>{ const k=b.getAttribute('data-sig-clear'); sigPads[k]?.clear(); });
  });
  document.querySelectorAll('[data-sig-undo]').forEach(b=>{
    b.addEventListener('click', ()=>{ const k=b.getAttribute('data-sig-undo'); sigPads[k]?.undo(); });
  });
}

/* Export: PDF (print) */
function openPDF(){
  // Build a clean print view in a new window using current state.
  const w = window.open('', '_blank');
  const safe = v => (v===undefined||v===null||v===""?"‚Äî":String(v));
  const yes = v => v===true ? "Yes" : v===false ? "No" : (v||"‚Äî");
  const fmtAddr = a => [a.line1,a.line2,a.suburb,a.state,a.postcode].filter(Boolean).join(", ");

  function section(title, rows){
    return `<section style="page-break-inside:avoid;margin:14px 0;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fafafa">
      <h2 style="margin:0 0 6px;font-size:16px;color:#0f172a">${title}</h2>
      <table style="width:100%;border-collapse:separate;border-spacing:0 6px;font-size:13px">
        ${rows.map(([k,v])=>`<tr><th style="width:240px;text-align:left;padding:6px 8px;background:#eef2ff;border-radius:8px;font-weight:700;color:#1e3a8a">${k}</th><td style="padding:6px 8px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;color:#0f172a">${v}</td></tr>`).join("")}
      </table>
    </section>`;
  }

  let html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>NDIS Care Plan ‚Äî PDF</title>
  <style>@page{size:A4;margin:16mm} body{font-family:Inter,Arial,sans-serif;color:#111;margin:0} header,footer{position:fixed;left:0;right:0}
  header{top:0;height:38px;border-bottom:1px solid #e5e7eb} footer{bottom:0;height:28px;border-top:1px solid #e5e7eb;font-size:11px;color:#475569}
  .container{margin:52px 16mm 34px} .pnum:after{counter-increment:page;content:"Page " counter(page)}
  </style></head><body><header><div style="display:flex;justify-content:space-between;align-items:center;padding:8px 16mm;font-weight:800;font-size:12px;color:#334155">NDIS Comprehensive Care Plan<span>${new Date().toLocaleDateString('en-AU',{day:'numeric',month:'long',year:'numeric'})}</span></div></header>
  <footer><div style="display:flex;justify-content:space-between;align-items:center;padding:6px 16mm"><span>Generated from in-browser form</span><span class="pnum"></span></div></footer>
  <div class="container">`;

  // participant
  if (!S.na.participant) html += section("Participant", [
    ["Legal name", safe(S.participant.legal_name)],
    ["Preferred name", safe(S.participant.preferred_name)],
    ["DOB", safe(S.participant.dob)],
    ["NDIS number", safe(S.participant.ndis_number)],
    ["Address", safe(fmtAddr(S.participant.address))],
    ["Plan management", safe(S.participant.plan_mgmt)],
    ["Plan dates", safe([S.participant.plan_dates.start,S.participant.plan_dates.end].filter(Boolean).join(" ‚Üí "))],
    ["Plan manager", safe([S.participant.pm.org,S.participant.pm.contact].filter(Boolean).join(" ‚Ä¢ "))],
    ["Plan manager contact", safe([S.participant.pm.email,S.participant.pm.phone].filter(Boolean).join(" ‚Ä¢ "))],
    ["Contact", safe([S.contacts.email,S.contacts.phone].filter(Boolean).join(" ‚Ä¢ "))]
  ]);

  if (!S.na.health) html += section("Health & Medical", [
    ["Primary diagnoses", safe(S.health.primary_diagnoses)],
    ["Other diagnoses", safe(S.health.other_diagnoses)],
    ["Allergies", safe(S.health.allergies)],
    ["Equipment / aids", safe(S.health.equipment)],
    ["Mobility", safe(S.health.mobility)],
    ["Continence", safe(S.health.continence)],
    ["Cognition", safe(S.health.cognition)],
    ["Diet / swallowing", safe(S.health.diet_notes)],
    ["Pressure injury risk", safe(S.health.pressure_risk)],
    ["Falls risk", safe(S.health.falls_risk)],
    ["Seizures", safe(S.health.seizures.has)],
    ["Seizure plan", safe(S.health.seizures.plan)],
    ["Seizure frequency", safe(S.health.seizures.frequency)],
  ]);

  if (!S.na.adl) html += section("Daily Living & Personal Care", [
    ["Bathing / showering", safe(S.adl.bathing)],
    ["Dressing / grooming", safe(S.adl.dressing)],
    ["Toileting / continence", safe(S.adl.toileting)],
    ["Meal prep / feeding", safe(S.adl.meals)],
    ["Mobility & transfers", safe(S.adl.mobility)],
    ["Household tasks", safe(S.adl.household)],
    ["Transport / community", safe(S.adl.transport)],
    ["Routines & preferences", safe(S.adl.routines)],
  ]);

  if (!S.na.comms) html += section("Communication & Sensory", [
    ["Primary language", safe(S.comms.language)],
    ["Interpreter", safe(S.comms.interpreter)],
    ["Communication methods", safe(S.comms.methods)],
    ["Sensory considerations", safe(S.comms.sensory)],
    ["Worker preferences", safe(S.comms.worker_prefs)],
  ]);

  if (!S.na.social) html += section("Social & Lifestyle", [
    ["Living situation", safe(S.social.living)],
    ["Support network", safe(S.social.network)],
    ["Interests & activities", safe(S.social.interests)],
    ["Typical routine", safe(S.social.routine)],
  ]);

  if (!S.na.behaviour) html += section("Behaviour Management", [
    ["Behaviours of concern", safe(S.behaviour.description)],
    ["Triggers / antecedents", safe(S.behaviour.triggers)],
    ["Preventative strategies", safe(S.behaviour.prevent)],
    ["De-escalation strategies", safe(S.behaviour.deescalate)],
    ["Post-incident support / review", safe(S.behaviour.post)],
    ["BSP in place", safe(S.behaviour.bsp)],
    ["Restrictive practices", safe(S.behaviour.restrictive)],
    ["Authorisations / review", safe(S.behaviour.authorisations)],
  ]);

  if (!S.na.meds){
    const medHTML = (S.meds.list||[]).length
      ? `<table style="width:100%;border-collapse:collapse;border:1px solid #e5e7eb"><thead><tr style="background:#f8fafc">
          <th align="left" style="padding:6px;border-bottom:1px solid #e5e7eb">Name</th>
          <th align="left" style="padding:6px;border-bottom:1px solid #e5e7eb">Dose</th>
          <th align="left" style="padding:6px;border-bottom:1px solid #e5e7eb">Route</th>
          <th align="left" style="padding:6px;border-bottom:1px solid #e5e7eb">Times</th>
          <th align="left" style="padding:6px;border-bottom:1px solid #e5e7eb">Purpose</th>
        </tr></thead><tbody>${
          S.meds.list.map(m=>`<tr>
            <td style="padding:6px;border-top:1px solid #eef2f7">${safe(m.name)}</td>
            <td style="padding:6px;border-top:1px solid #eef2f7">${safe(m.dose)}</td>
            <td style="padding:6px;border-top:1px solid #eef2f7">${safe(m.route)}</td>
            <td style="padding:6px;border-top:1px solid #eef2f7">${safe(m.times)}</td>
            <td style="padding:6px;border-top:1px solid #eef2f7">${safe(m.purpose)}</td>
          </tr>`).join("")
        }</tbody></table>`
      : "‚Äî";
    html += section("Medication Management", [
      ["Medication list", medHTML],
      ["Self-administration", safe(S.meds.self)],
      ["Webster / blister", safe(S.meds.webster)],
      ["Storage & access", safe(S.meds.storage)],
      ["Consent", safe(S.meds.consent)],
      ["Side-effects to monitor", safe(S.meds.sidefx)],
      ["Emergency meds & protocol", safe(S.meds.emergency)],
      ["Missed dose protocol", safe(S.meds.missed)],
      ["Recent changes / reviews", safe(S.meds.changes)],
    ]);
  }

  if (!S.na.risk) html += section("Risk & Safety", [
    ["Home safety", ["trip","smoke","light","bath"].filter(k=>S.risk.home[k]).map(k=>({trip:"Trip hazards",smoke:"No smoke alarms",light:"Poor lighting",bath:"Bathroom safety"}[k])).join(", ") || "‚Äî"],
    ["Home notes", safe(S.risk.home.notes)],
    ["Wandering / elopement", safe(S.risk.wander)],
    ["Substances", safe(S.risk.substances)],
    ["Transport safety", safe(S.risk.transport)],
    ["Emergency plan", safe(S.risk.emergency)],
  ]);

  if (!S.na.goals) html += section("Goals & Outcomes", [
    ["Goals", safe(S.goals.list)],
    ["Success indicators", safe(S.goals.outcomes)],
    ["Support strategies", safe(S.goals.supports)],
    ["Scheduling / frequency", safe(S.goals.schedule)],
  ]);

  if (!S.na.consents) html += section("Consents & Attachments", [
    ["Consent to share", safe(S.consents.share)],
    ["Consent notes", safe(S.consents.notes)],
    ["Emergency contact", safe([S.contacts.emer.name,S.contacts.emer.rel,S.contacts.emer.phone].filter(Boolean).join(" ‚Ä¢ "))],
    ["Support coordinator", safe([S.contacts.sc.name,S.contacts.sc.org,S.contacts.sc.email].filter(Boolean).join(" ‚Ä¢ "))],
    ["GP / Practice", safe([S.contacts.gp.name,S.contacts.gp.practice].filter(Boolean).join(" ‚Ä¢ "))],
    ["GP contact", safe([S.contacts.gp.phone,S.contacts.gp.email].filter(Boolean).join(" ‚Ä¢ "))],
    ["Uploads", (S.uploads||[]).map(u=>u.name).join(" ‚Ä¢ ") || "‚Äî"],
  ]);

  if (!S.na.sign){
    const sigP = S.sign.sigs?.participant ? `<img src="${S.sign.sigs.participant}" style="max-height:80px">` : `<div style="height:80px;border:1px dashed #cbd5e1;border-radius:8px"></div>`;
    const sigR = S.sign.sigs?.provider ? `<img src="${S.sign.sigs.provider}" style="max-height:80px">` : `<div style="height:80px;border:1px dashed #cbd5e1;border-radius:8px"></div>`;
    html += section("Signatures", [
      ["Participant/Representative ‚Äî Name", safe(S.sign.participant_name)],
      ["Signature", sigP],
      ["Date", safe(S.sign.participant_date)],
      ["Provider ‚Äî Name/Title", safe([S.sign.provider_name,S.sign.provider_title].filter(Boolean).join(" ‚Ä¢ "))],
      ["Signature", sigR],
      ["Date", safe(S.sign.provider_date)],
    ]);
  }

  html += `</div></body></html>`;
  w.document.write(html); w.document.close();
  setTimeout(()=>{ try{ w.focus(); }catch{} }, 200);
}
/* Export: RTF */
function downloadRTF(){
  function esc(s){ return (s||"").toString().replace(/[\\{}]/g, m=>"\\"+m).replace(/\n/g,"\\par "); }
  function line(k,v){ return `\\b ${esc(k)}:\\b0\\tab ${esc(v||"‚Äî")}\\par `; }
  function block(title, rows){ return `{\\pard\\sa180\\b\\ul ${esc(title)}\\ul0\\b0\\par }{${rows.join("")}}`; }

  const safe = v => (v===undefined||v===null||v===""?"‚Äî":String(v));
  const fmtAddr = a => [a.line1,a.line2,a.suburb,a.state,a.postcode].filter(Boolean).join(", ");

  const parts = [];

  if (!S.na.participant) {
    parts.push(block("1) Participant", [
      line("Legal name", safe(S.participant.legal_name)),
      line("Preferred name", safe(S.participant.preferred_name)),
      line("Date of birth", safe(S.participant.dob)),
      line("NDIS number", safe(S.participant.ndis_number)),
      line("Address", safe(fmtAddr(S.participant.address))),
      line("Plan management", safe(S.participant.plan_mgmt)),
      line("Plan dates", safe([S.participant.plan_dates.start,S.participant.plan_dates.end].filter(Boolean).join(" ‚Üí "))),
      line("Plan manager", safe([S.participant.pm.org,S.participant.pm.contact].filter(Boolean).join(" ‚Ä¢ "))),
      line("Plan manager contact", safe([S.participant.pm.email,S.participant.pm.phone].filter(Boolean).join(" ‚Ä¢ "))),
      line("Contact", safe([S.contacts.email,S.contacts.phone].filter(Boolean).join(" ‚Ä¢ ")))
    ]));
  }

  if (!S.na.health) {
    parts.push(block("2) Health & Medical", [
      line("Primary diagnoses", safe(S.health.primary_diagnoses)),
      line("Other diagnoses", safe(S.health.other_diagnoses)),
      line("Allergies", safe(S.health.allergies)),
      line("Equipment / aids", safe(S.health.equipment)),
      line("Mobility", safe(S.health.mobility)),
      line("Continence", safe(S.health.continence)),
      line("Cognition", safe(S.health.cognition)),
      line("Diet / swallowing notes", safe(S.health.diet_notes)),
      line("Pressure injury risk", safe(S.health.pressure_risk)),
      line("Falls risk", safe(S.health.falls_risk)),
      line("Seizures", safe(S.health.seizures.has)),
      line("Seizure plan", safe(S.health.seizures.plan)),
      line("Seizure frequency", safe(S.health.seizures.frequency))
    ]));
  }

  if (!S.na.adl) {
    parts.push(block("3) Daily Living & Personal Care (ADLs)", [
      line("Bathing / showering", safe(S.adl.bathing)),
      line("Dressing / grooming", safe(S.adl.dressing)),
      line("Toileting / continence care", safe(S.adl.toileting)),
      line("Meal prep / feeding", safe(S.adl.meals)),
      line("Mobility & transfers", safe(S.adl.mobility)),
      line("Household tasks (cleaning, laundry)", safe(S.adl.household)),
      line("Transport / community access", safe(S.adl.transport)),
      line("Routines & preferences", safe(S.adl.routines))
    ]));
  }

  if (!S.na.comms) {
    parts.push(block("4) Communication & Sensory", [
      line("Primary language", safe(S.comms.language)),
      line("Interpreter", safe(S.comms.interpreter)),
      line("Communication methods", safe(S.comms.methods)),
      line("Sensory considerations", safe(S.comms.sensory)),
      line("Worker preferences", safe(S.comms.worker_prefs))
    ]));
  }

  if (!S.na.social) {
    parts.push(block("5) Social & Lifestyle", [
      line("Living situation", safe(S.social.living)),
      line("Support network", safe(S.social.network)),
      line("Interests & activities", safe(S.social.interests)),
      line("Typical routine", safe(S.social.routine))
    ]));
  }

  if (!S.na.behaviour) {
    parts.push(block("6) Behaviour Management", [
      line("Behaviours of concern ‚Äî description", safe(S.behaviour.description)),
      line("Known triggers / antecedents", safe(S.behaviour.triggers)),
      line("Preventative strategies", safe(S.behaviour.prevent)),
      line("De-escalation strategies", safe(S.behaviour.deescalate)),
      line("Post-incident support / review", safe(S.behaviour.post)),
      line("BSP in place?", safe(S.behaviour.bsp)),
      line("Restrictive practices involved?", safe(S.behaviour.restrictive)),
      line("Authorisations & review cycle", safe(S.behaviour.authorisations))
    ]));
  }

  if (!S.na.meds) {
    const medsFlat = S.meds.list.map(m => [m.name, m.dose, m.route, m.times, m.purpose].filter(Boolean).join(" ‚Ä¢ ")).join("\\par ");
    parts.push(block("7) Medication Management", [
      line("Medication list", medsFlat || "‚Äî"),
      line("Self-administration ability", safe(S.meds.self)),
      line("Webster / blister pack", safe(S.meds.webster)),
      line("Storage & access control", safe(S.meds.storage)),
      line("Consent for administration", safe(S.meds.consent)),
      line("Side-effects to monitor", safe(S.meds.sidefx)),
      line("Emergency meds & protocol", safe(S.meds.emergency)),
      line("Missed dose protocol", safe(S.meds.missed)),
      line("Recent changes / upcoming reviews", safe(S.meds.changes))
    ]));
  }

  if (!S.na.risk) {
    const homeIssues = ["trip","smoke","light","bath"].filter(k=>S.risk.home[k]).map(k=>({trip:"Trip hazards present",smoke:"No working smoke alarms",light:"Poor lighting",bath:"Bathroom lacks rails / mats"}[k])).join(", ") || "‚Äî";
    parts.push(block("8) Risk & Safety", [
      line("Home safety checklist", homeIssues),
      line("Notes / mitigations", safe(S.risk.home.notes)),
      line("Wandering / elopement risk", safe(S.risk.wander)),
      line("Smoking / alcohol / substances", safe(S.risk.substances)),
      line("Transport safety", safe(S.risk.transport)),
      line("Emergency plan", safe(S.risk.emergency))
    ]));
  }

  if (!S.na.goals) {
    parts.push(block("9) Goals & Outcomes", [
      line("Participant goals", safe(S.goals.list)),
      line("Success indicators / outcomes", safe(S.goals.outcomes)),
      line("Support strategies to reach goals", safe(S.goals.supports)),
      line("Scheduling / frequency notes", safe(S.goals.schedule))
    ]));
  }

  if (!S.na.consents) {
    parts.push(block("10) Consents & Attachments", [
      line("Consent to share plan", safe(S.consents.share)),
      line("Consent notes", safe(S.consents.notes)),
      line("Emergency contact", safe([S.contacts.emer.name,S.contacts.emer.rel,S.contacts.emer.phone].filter(Boolean).join(" ‚Ä¢ "))),
      line("Support coordinator", safe([S.contacts.sc.name,S.contacts.sc.org,S.contacts.sc.email].filter(Boolean).join(" ‚Ä¢ "))),
      line("GP / Practice", safe([S.contacts.gp.name,S.contacts.gp.practice,S.contacts.gp.phone,S.contacts.gp.email].filter(Boolean).join(" ‚Ä¢ "))),
      line("Uploaded files", S.uploads.map(u=>u.name).join(" ‚Ä¢ ") || "‚Äî")
    ]));
  }

  if (!S.na.sign) {
    const sigP = S.sign.sigs?.participant ? "[Signed digitally]" : "[Signature line]";
    const sigR = S.sign.sigs?.provider ? "[Signed digitally]" : "[Signature line]";
    parts.push(block("11) Signatures & Authorisation", [
      line("Participant / Representative ‚Äî type name", safe(S.sign.participant_name)),
      line("Signature", sigP),
      line("Date", safe(S.sign.participant_date)),
      line("Provider Representative ‚Äî name & title", safe([S.sign.provider_name,S.sign.provider_title].filter(Boolean).join(" ‚Ä¢ "))),
      line("Signature", sigR),
      line("Date", safe(S.sign.provider_date))
    ]));
  }

  // Assemble RTF doc
  const rtf = `{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Arial;}}\\fs22 ${parts.join(" ")} }`;

  // Download
  const blob = new Blob([rtf], {type:"application/rtf"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "NDIS_Comprehensive_Care_Plan.rtf";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

/* Init */
(function init(){
  restore();
  bindAll();
  renderMedRows();
  initSigPads();

  // Populate TOC
  const toc = document.getElementById('toc');
  document.querySelectorAll('details.section').forEach(sec=>{
    const sum = sec.querySelector('summary');
    const txt = sum.firstChild.textContent.trim(); // Get text before sect-meta
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = `#${sec.id}`;
    a.textContent = txt;
    li.appendChild(a);
    toc.appendChild(li);
  });

  // Wire buttons
  document.getElementById('addMed').addEventListener('click', ()=>addMedRow());
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    if (confirm('Reset all fields and clear local storage?')) {
      localStorage.removeItem(STORAGE_KEY);
      location.reload();
    }
  });
  document.getElementById('rtfBtn').addEventListener('click', downloadRTF);
  document.getElementById('pdfBtn').addEventListener('click', openPDF);

  // Wire dictation toggle (global continuous mode)
  const dictationToggle = document.getElementById('dictationToggle');
  dictationToggle.addEventListener('click', ()=>{
    globalDictation = !globalDictation;
    dictationToggle.textContent = `üéôÔ∏è Dictation: ${globalDictation ? 'On' : 'Off'}`;
    if (!globalDictation) stopSpeech();
  });

  // Wire per-field mic buttons
  document.querySelectorAll('.mic').forEach(m=>{
    m.addEventListener('click', ()=>{
      const field = m.getAttribute('data-mic');
      if (m.dataset.live === 'true') {
        stopSpeech();
      } else {
        startSpeech(field);
      }
    });
  });

  // Wire file upload
  const fileInput = document.getElementById('fileInput');
  fileInput.addEventListener('change', async e=>{
    const file = e.target.files[0];
    if (!file) return;
    let text = '';
    try {
      if (file.name.endsWith('.pdf')) {
        text = await extractPdfText(file);
      } else if (file.name.endsWith('.rtf')) {
        text = await file.text();
        text = rtfToText(text);
      } else if (file.name.endsWith('.txt')) {
        text = await file.text();
      }
      if (text) {
        mapTextToFields(text);
        bindAll(); // Update UI
        renderMedRows();
        addUploadTag(file.name);
        S.uploads.push({name: file.name});
        save();
        setStatus("Auto-filled from upload");
      }
    } catch (err) {
      console.error('Upload processing failed:', err);
      alert('Error processing file: ' + err.message);
    }
  });

  // Restore uploads to list
  S.uploads.forEach(u=>addUploadTag(u.name));
})();
</script>

<!-- Optional: graceful fallback for users without JS -->
<noscript>
  <div style="max-width:860px;margin:24px auto;padding:12px 16px;border:1px solid #334c85;border-radius:12px;background:#0e1836;color:#e8edff;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif">
    <b>JavaScript is disabled.</b> This care plan requires JavaScript for saving drafts, voice input, file parsing, and exports.
    Please enable JavaScript and reload this page.
  </div>
</noscript>

</body>
</html>
