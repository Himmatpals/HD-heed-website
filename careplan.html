<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NDIS Comprehensive Care Plan — All-in-One</title>

<!-- ===== THEME (different to AILR: teal/emerald + slate) ===== -->
<style>
  :root{
    --ink:#0b1220; --bg:#0a0f15; --panel:#0f1720; --line:#223244;
    --text:#eaf6ff; --muted:#b9d2e6;
    --a1:#10b981; /* emerald */
    --a2:#22d3ee; /* cyan */
    --warn:#f59e0b; --danger:#ef4444; --ok:#22c55e;
    --grad: linear-gradient(135deg, var(--a1), var(--a2));
    --soft: linear-gradient(135deg, #0f1720, #111b27);
    --glow: rgba(34, 211, 238, .45);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial, sans-serif;
    background:
      radial-gradient(1200px 600px at 12% -10%, rgba(16,185,129,.22), transparent 60%),
      radial-gradient(1200px 600px at 88% 10%, rgba(34,211,238,.18), transparent 60%),
      linear-gradient(180deg,#091018 0%, #0c1520 45%, #081019 100%);
    color:var(--text);
  }
  a{ color:#8fe9ff; text-decoration:none } a:hover{ color:#c8f6ff }
  .wrap{max-width:1180px;margin:20px auto 40px;padding:0 16px;display:grid;gap:16px;grid-template-columns: 300px 1fr}
  @media (max-width:980px){ .wrap{ grid-template-columns:1fr } }

  /* Header */
  header{
    position:sticky; top:0; z-index:50;
    background: linear-gradient(135deg, #0a131b, #0f1a24);
    border-bottom:1px solid var(--line);
    box-shadow: 0 6px 24px rgba(0,0,0,.55); backdrop-filter: blur(6px);
  }
  header .bar{max-width:1180px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
  .brand{font-weight:900; letter-spacing:.2px}
  .tag{font-size:12px;color:#9bd0e9;margin-left:6px}
  .actions{margin-left:auto; display:flex; gap:8px; flex-wrap:wrap}
  .btn{
    border:0; border-radius:14px; padding:12px 14px; font-weight:800; cursor:pointer; min-height:44px;
    background:var(--soft); color:var(--text); border:1px solid var(--line);
    box-shadow:0 6px 18px rgba(0,0,0,.35)
  }
  .btn.primary{ background:var(--grad); color:#00151a; border-color:transparent }
  .btn.warn{ background:linear-gradient(135deg,#1a2533,#203044); color:#ffe69a; border-color:#2a4059 }
  .btn:hover{ transform: translateY(-1px); box-shadow:0 10px 26px rgba(0,0,0,.45) }

  /* Sidebar */
  .side{
    position:sticky; top:74px; align-self:start; background:var(--soft); border:1px solid var(--line);
    border-radius:18px; padding:12px; box-shadow:0 18px 50px rgba(0,0,0,.55), 0 0 14px var(--glow)
  }
  .side h3{margin:0 0 10px; font-size:16px; font-weight:900; background:var(--grad); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
  .toc{ list-style:none; padding:0; margin:0; display:grid; gap:6px; max-height:70vh; overflow:auto }
  .toc button{
    width:100%; text-align:left; padding:10px 12px; border-radius:12px; border:1px solid transparent;
    background:transparent; color:#d6efff; cursor:pointer
  }
  .toc button:hover{ background:linear-gradient(135deg,#0d1822,#0f1c27); border-color:#24394f }
  .toc .current{ background:var(--grad); color:#062229; border-color:transparent; box-shadow:0 0 10px var(--glow) }

  /* Stage */
  main.stage{
    background: linear-gradient(180deg, rgba(10,18,28,.92), rgba(9,16,25,.92));
    border:1px solid var(--line); border-radius:22px; padding:16px;
    box-shadow:0 22px 60px rgba(0,0,0,.5), inset 0 0 14px rgba(255,255,255,.04)
  }
  .hint{font-size:12px; color:#a8cbe3}
  .section{
    border:1px solid var(--line); border-radius:16px; background:linear-gradient(135deg,#0d1721,#0c1520);
    box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:hidden
  }
  .section details{ border-top:1px dashed #203347 }
  .section details:first-of-type{ border-top:0 }
  summary{
    list-style:none; cursor:pointer; padding:14px 14px; font-weight:900; display:flex; align-items:center; gap:10px;
    background:linear-gradient(135deg,#0d1824,#0f1b27); position:sticky; top:0
  }
  summary::-webkit-details-marker{display:none}
  .badge{ font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #2a3f56; background:#0e1a26; color:#bdefff }
  .nr{ margin-left:auto; display:flex; align-items:center; gap:8px; font-size:13px; color:#d5f8ff }
  .panel{ padding:14px; display:grid; gap:12px }
  .grid.two{ display:grid; gap:12px }
  .grid.three{ display:grid; gap:12px }
  @media (min-width:720px){ .grid.two{ grid-template-columns:repeat(2,minmax(0,1fr)) } .grid.three{ grid-template-columns:repeat(3,minmax(0,1fr)) } }

  .field{
    border:1px solid #25405a; background:linear-gradient(135deg,#0b1420,#0e1926);
    border-radius:14px; padding:10px; display:grid; gap:8px
  }
  .field label{ font-weight:800; color:#cfeaff }
  .field input,.field select,.field textarea{
    width:100%; padding:12px; border-radius:10px; border:1px solid #2a4a66;
    background:linear-gradient(135deg,#0e1b29,#112034); color:#e8f8ff; font-size:15px; outline:none
  }
  .field textarea{ min-height:96px; resize:vertical }
  .disabled{ opacity:.45; filter:saturate(.6) }
  .chipset{ display:flex; gap:8px; flex-wrap:wrap }
  .chip{ border:1px solid #2a4a66; background:linear-gradient(135deg,#0e1b29,#112034); color:#dff6ff; padding:10px 12px; border-radius:999px; cursor:pointer }
  .chip[aria-pressed="true"]{ box-shadow:0 0 0 3px rgba(34,211,238,.28); border-image: var(--grad) 1 }

  /* Footer actions */
  .foot{ display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end; margin-top:14px; padding-top:12px; border-top:1px dashed var(--line) }

  /* Modal viewer */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.72); z-index:1000; backdrop-filter: blur(5px) }
  .modal.open{ display:flex }
  .modal .panel{ width:min(960px,96vw); height:min(88vh,1000px); background: linear-gradient(135deg,#0b1420,#0f1b27); border:1px solid var(--line); border-radius:18px; overflow:hidden; display:flex; flex-direction:column; box-shadow: 0 20px 60px rgba(0,0,0,.6), 0 0 20px var(--glow) }
  .modal .head{ display:flex; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid var(--line) }
  .modal .body{ flex:1; background: linear-gradient(135deg,#0e1a26,#0f1c2a) }
  .modal embed{ width:100%; height:100% }
</style>
</head>
<body>

<header>
  <div class="bar">
    <div class="brand">NDIS Comprehensive Care Plan</div>
    <div class="tag">Collapsible • “Not required” anywhere • Upload→Auto-fill • PDF/RTF export</div>
    <div class="actions">
      <button class="btn warn" id="resetBtn" type="button">Reset for next client</button>
      <button class="btn" id="genRTF" type="button">Download RTF</button>
      <button class="btn primary" id="genPDF" type="button">Generate PDF</button>
    </div>
  </div>
</header>

<div class="wrap" id="app">
  <!-- SIDEBAR -->
  <aside class="side">
    <h3>Sections</h3>
    <ul class="toc" id="tocList"></ul>
    <div class="hint" id="saveHint" style="margin-top:8px">Draft saved</div>
    <div class="field" style="margin-top:10px">
      <label>Upload existing plan (PDF/RTF) → auto-fill</label>
      <input id="fileInput" type="file" accept=".pdf,.rtf,application/pdf,application/rtf,text/rtf" />
      <small class="hint">Best with RTF or text-based PDFs (scans won’t parse).</small>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="stage">
    <div class="section" id="sections">
      <!-- Sections are injected by JS -->
    </div>
    <div class="foot">
      <button class="btn" id="jumpTop" type="button">↑ Top</button>
      <button class="btn primary" id="reviewBtn" type="button">Review & Finish</button>
    </div>
  </main>
</div>

<!-- DOC VIEWER (optional future use) -->
<div id="docModal" class="modal" aria-hidden="true">
  <div class="panel">
    <div class="head">
      <div class="ttl" id="docTitle">Document</div>
      <button id="docClose" class="btn">Close</button>
    </div>
    <div class="body"><embed id="docViewer" src="" type="application/pdf" /></div>
  </div>
</div>

<script>
(function(){
  /* ===== State & Storage ===== */
  const STORAGE_KEY = "ndis_careplan_v1";
  const $ = (s,r=document)=>r.querySelector(s);
  const el = (t,c,h)=>{ const e=document.createElement(t); if(c) e.className=c; if(h!=null) e.innerHTML=h; return e; };
  const saveHint = t => { const h=$("#saveHint"); if(h) h.textContent=t||"Draft saved"; };

  const S = JSON.parse(localStorage.getItem(STORAGE_KEY)||"null") || {
    participant:{ legal_name:"", preferred_name:"", pronouns:"", dob:"", age:"", ndis:"", address:"", suburb:"", state:"", postcode:"", phone:"", email:"", plan_mgmt:"", plan_start:"", plan_end:"" },
    emergency:{ name:"", rel:"", phone:"" },
    team:{ sc_name:"", sc_org:"", sc_email:"", sc_phone:"", pm_name:"", pm_org:"", pm_email:"", pm_phone:"", gp_name:"", gp_practice:"", gp_email:"", gp_phone:"" },
    health:{ primary_dx:"", other_dx:"", allergies:"", equipment:"", cognition:"", vision_hearing:"", mental_health:"", diet:"" },
    daily:{ bathing:"", bathing_prefs:"", dressing:"", grooming:"", toileting:"", continence:"", mobility:"", transfers:"", aids:"", routines:"", environment:"", home_risks:[] },
    comms:{ language:"", method:"", interpreter:"", interpreter_lang:"", decision_support:"", cues:"", sensory:"" },
    social:{ living:"", household:"", supports:"", interests:"", routine:"" },
    behaviour:{ applicable:true, description:"", triggers:"", early_signs:"", prevention:"", deescalation:"", post_incident:"", bsp:false, restrictive:false, restrictive_notes:"", reporting:"" },
    meds:{
      applicable:true, list:[], self_admin:"Not sure", webster:"Not sure", storage:"", access:"", consent:"", side_effects:"", monitoring:"", missed:"", emergency_plan:"", changes:""
    },
    risk:{ falls:"Not sure", falls_strat:"", pressure:"Not sure", pressure_strat:"", wandering:"Not sure", wandering_strat:"", substances:"", transport:"", emergency_plan:"", home_check:{ smoke:false, lighting:false, rails:false, trip:false, notes:"" } },
    goals:{ items:"", outcomes:"", strategies:"" },
    consent:{ share_info:false, share_notes:"" },
    signatures:{ client_name:"", client_date:"", provider_name:"", provider_role:"", provider_date:"" },
    _nr:{}, // not-required map per section key
  };

  function persist(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(S));
    saveHint("Draft saved");
  }

  /* ===== Helpers ===== */
  function field(label, path, type="text", attrs={}){
    const box = el('div','field');
    const id = "f_"+Math.random().toString(36).slice(2,8);
    const labelEl = el('label',null,label); labelEl.setAttribute('for',id);
    let input;
    if (type==="textarea"){ input = el('textarea'); input.value = get(path)||""; }
    else if (type==="select"){
      input = el('select'); (attrs.options||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; input.appendChild(o); });
      input.value = get(path)||"";
    } else {
      input = el('input'); input.type = type; input.value = get(path)||"";
      if (attrs.placeholder) input.placeholder = attrs.placeholder;
    }
    input.id = id;
    input.addEventListener('input', ()=>{ set(path, input.value); persist(); });
    box.append(labelEl, input);
    return box;
  }
  function chips(label, path, options){
    const wrap = el('div','field'); wrap.appendChild(el('label',null,label));
    const row = el('div','chipset');
    const cur = get(path);
    options.forEach(v=>{
      const b = el('button','chip',v); b.type="button";
      if (v===cur) b.setAttribute('aria-pressed','true');
      b.addEventListener('click',()=>{
        row.querySelectorAll('.chip').forEach(x=>x.removeAttribute('aria-pressed'));
        b.setAttribute('aria-pressed','true'); set(path,v); persist();
      });
      row.appendChild(b);
    });
    wrap.appendChild(row); return wrap;
  }
  function checklist(label, objPath, map){
    const wrap = el('div','field'); wrap.appendChild(el('label',null,label));
    const list = el('div','chipset');
    const cur = get(objPath) || {};
    Object.keys(map).forEach(k=>{
      const id="ck_"+k+"_"+Math.random().toString(36).slice(2,6);
      const c = el('input'); c.type="checkbox"; c.id=id; c.checked = !!cur[k];
      c.addEventListener('change',()=>{ const o=get(objPath)||{}; o[k]=c.checked; set(objPath,o); persist(); });
      const lab = el('label',null,map[k]); lab.setAttribute('for',id); lab.style.marginRight="10px";
      const row = el('div',null); row.append(c,lab); list.appendChild(row);
    });
    wrap.appendChild(list); return wrap;
  }
  function nrToggle(sectionKey, container){
    const chk = el('input'); chk.type='checkbox';
    chk.checked = S._nr[sectionKey]===true;
    const lbl = el('label',null,'Not required for this participant');
    lbl.style.cursor='pointer';
    const id = "nr_"+sectionKey; chk.id=id; lbl.setAttribute('for',id);
    const holder = el('div','nr'); holder.append(chk,lbl);
    function apply(){
      const disabled = chk.checked;
      S._nr[sectionKey]=disabled; persist();
      container.classList.toggle('disabled', disabled);
      container.querySelectorAll('input,select,textarea,button').forEach(n=>{
        if(n===chk) return;
        if(n.closest('.nr')) return;
        n.disabled = disabled;
      });
    }
    chk.addEventListener('change',apply);
    setTimeout(apply,0);
    return holder;
  }
  function get(path){
    const keys=path.split('.'); let cur=S;
    for(const k of keys){ if(cur==null) return undefined; cur=cur[k]; }
    return cur;
  }
  function set(path, val){
    const keys=path.split('.'); let cur=S;
    for(let i=0;i<keys.length-1;i++){ const k=keys[i]; if(typeof cur[k]!=='object'||cur[k]==null) cur[k]={}; cur=cur[k]; }
    cur[keys[keys.length-1]] = val;
  }

  /* ===== Sections builder ===== */
  const container = $("#sections");
  const TOC = $("#tocList");
  const SECTIONS = [
    { key:"intro", title:"Overview & quick guidance", build(buildPanel){
        const p = buildPanel();
        p.append(
          el('div','hint', 'Complete any sections that apply. Tick “Not required” to skip irrelevant sections. Use Upload to auto-fill from an existing plan.'),
          el('div','hint','Export to PDF for signing, or download an editable RTF.')
        );
      }
    },
    { key:"participant", title:"1) Participant — personal & NDIS details", build(buildPanel){
        const p = buildPanel();
        p.append(
          el('div','grid.two',[
            field("Legal name","participant.legal_name"),
            field("Preferred name","participant.preferred_name")
          ]),
          el('div','grid.three',[
            field("Pronouns","participant.pronouns"),
            field("Date of birth","participant.dob","date"),
            field("Age","participant.age","number")
          ]),
          el('div','grid.two',[
            field("NDIS number","participant.ndis"),
            field("Plan management","participant.plan_mgmt","select",{options:["NDIA-managed","Plan-managed","Self-managed","Not sure"]})
          ]),
          el('div','grid.three',[
            field("Plan start","participant.plan_start","date"),
            field("Plan end","participant.plan_end","date"),
            field("Phone","participant.phone","tel")
          ]),
          el('div','grid.two',[
            field("Email","participant.email","email"),
            field("Address (street)","participant.address")
          ]),
          el('div','grid.three',[
            field("Suburb","participant.suburb"),
            field("State","participant.state"),
            field("Postcode","participant.postcode")
          ]),
          el('div','grid.three',[
            field("Emergency contact — name","emergency.name"),
            field("Relationship","emergency.rel"),
            field("Phone","emergency.phone","tel")
          ]),
          el('div','grid.two',[
            field("Support Coordinator — name","team.sc_name"),
            field("Organisation","team.sc_org")
          ]),
          el('div','grid.two',[
            field("SC email","team.sc_email","email"),
            field("SC phone","team.sc_phone","tel")
          ]),
          el('div','grid.two',[
            field("Plan Manager — name","team.pm_name"),
            field("Organisation","team.pm_org")
          ]),
          el('div','grid.two',[
            field("PM email","team.pm_email","email"),
            field("PM phone","team.pm_phone","tel")
          ]),
          el('div','grid.three',[
            field("GP name","team.gp_name"),
            field("GP practice","team.gp_practice"),
            field("GP phone","team.gp_phone","tel")
          ]),
          field("GP email","team.gp_email","email")
        );
      }
    },
    { key:"health", title:"2) Health & medical (diagnoses, allergies, equipment, diet)", build(buildPanel){
        const p = buildPanel();
        p.append(
          field("Primary diagnoses","health.primary_dx","textarea",{placeholder:"e.g., Autism Spectrum Disorder; Multiple Sclerosis"}),
          field("Other diagnoses (optional)","health.other_dx","textarea"),
          field("Allergies (write “No known allergies” if none)","health.allergies"),
          el('div','grid.two',[
            field("Equipment / aids (mobility, comms)","health.equipment"),
            field("Cognition / capacity","health.cognition","select",{options:["Clear","Mild impairment","Moderate","Severe","Prefer not to say"]})
          ]),
          el('div','grid.two',[
            field("Vision/Hearing considerations","health.vision_hearing"),
            field("Mental health notes","health.mental_health","textarea")
          ]),
          field("Nutrition / diet (texture, restrictions, supplements)","health.diet","textarea")
        );
      }
    },
    { key:"daily", title:"3) Daily living & personal care (ADLs + preferences)", build(buildPanel){
        const p = buildPanel();
        p.append(
          el('div','grid.two',[
            field("Bathing support level","daily.bathing","select",{options:["Independent","Prompting","Partial assist","Full assist","Not required"]}),
            field("Bathing preferences (time, products)","daily.bathing_prefs","textarea")
          ]),
          el('div','grid.three',[
            field("Dressing support","daily.dressing","select",{options:["Independent","Prompting","Partial assist","Full assist","Not required"]}),
            field("Grooming/oral care","daily.grooming","select",{options:["Independent","Prompting","Partial assist","Full assist","Not required"]}),
            field("Toileting","daily.toileting","select",{options:["Independent","Prompting","Assistance","Incontinent","Catheter/stoma"]})
          ]),
          el('div','grid.three',[
            field("Continence management (aids/schedule)","daily.continence","textarea"),
            field("Mobility status","daily.mobility","select",{options:["Independent","With aid","Requires transfer","Bed-bound"]}),
            field("Transfers / hoist","daily.transfers")
          ]),
          el('div','grid.two',[
            field("Assistive aids in home","daily.aids"),
            field("Important routines to maintain","daily.routines","textarea")
          ]),
          field("Home environment / access notes (parking, pets, keysafe)","daily.environment","textarea"),
          checklist("Quick home safety risks","risk.home_check",{
            smoke:"No working smoke alarms",
            lighting:"Poor lighting",
            rails:"No grab rails / mats",
            trip:"Trip hazards"
          }),
          field("Home risks — notes","risk.home_check.notes","textarea")
        );
      }
    },
    { key:"comms", title:"4) Communication & sensory needs", build(buildPanel){
        const p = buildPanel();
        p.append(
          el('div','grid.two',[
            field("Primary language","comms.language"),
            field("Communication method (verbal, AAC, sign, device)","comms.method")
          ]),
          el('div','grid.two',[
            field("Interpreter required? (Yes/No/Not sure)","comms.interpreter"),
            field("Interpreter language","comms.interpreter_lang")
          ]),
          field("Decision-making support / guardian/nominee","comms.decision_support","textarea"),
          field("Behavioural cues (if non-verbal)","comms.cues","textarea"),
          field("Sensory considerations (noise, lights, textures)","comms.sensory","textarea")
        );
      }
    },
    { key:"social", title:"5) Social & lifestyle", build(buildPanel){
        const p = buildPanel();
        p.append(
          el('div','grid.two',[
            field("Living situation (home type)","social.living"),
            field("Household members / relationships","social.household")
          ]),
          field("Key family/friends/supports involved","social.supports","textarea"),
          field("Interests & activities (motivators, community)","social.interests","textarea"),
          field("Typical daily/weekly routine","social.routine","textarea")
        );
      }
    },
    { key:"behaviour", title:"6) Behaviour management plan (detailed)", build(buildPanel, key){
        const p = buildPanel(key);
        p.append(
          field("Behaviour(s) of concern — description","behaviour.description","textarea"),
          field("Known triggers / antecedents","behaviour.triggers","textarea"),
          field("Early warning signs","behaviour.early_signs","textarea"),
          field("Preventative strategies (proactive)","behaviour.prevention","textarea"),
          field("Preferred de-escalation techniques","behaviour.deescalation","textarea"),
          field("Post-incident response / debrief / recovery","behaviour.post_incident","textarea"),
          chips("Behaviour Support Plan (BSP) in place?","behaviour.bsp",["Yes","No","Not sure"]),
          chips("Restrictive practices authorized?","behaviour.restrictive",["Yes","No","Not sure"]),
          field("If restrictive practices: rationale, approvals, reduction plan, monitoring","behaviour.restrictive_notes","textarea"),
          field("Reporting & communication (who to notify, timeframes)","behaviour.reporting","textarea")
        );
      }
    },
    { key:"meds", title:"7) Medication management plan (very detailed)", build(buildPanel, key){
        const p = buildPanel(key);

        /* Medication list table (dynamic) */
        const medsWrap = el('div','field');
        medsWrap.appendChild(el('label',null,'Medication list (add rows as needed)'));
        const tbl = el('table'); tbl.style.width="100%"; tbl.style.borderSpacing="0 6px";
        tbl.innerHTML = `
          <thead>
            <tr>
              <th style="text-align:left">Name</th>
              <th style="text-align:left">Dose</th>
              <th style="text-align:left">Route</th>
              <th style="text-align:left">When / Frequency</th>
              <th style="text-align:left">Purpose</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="medRows"></tbody>
        `;
        const tbody = tbl.querySelector('#medRows');
        function renderMeds(){
          tbody.innerHTML="";
          (S.meds.list||[]).forEach((m,idx)=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><input data-k="name" value="${m.name||''}"></td>
              <td><input data-k="dose" value="${m.dose||''}"></td>
              <td><input data-k="route" value="${m.route||''}"></td>
              <td><input data-k="when" value="${m.when||''}"></td>
              <td><input data-k="purpose" value="${m.purpose||''}"></td>
              <td><button class="btn" data-del="${idx}" type="button">✕</button></td>
            `;
            tr.querySelectorAll('input').forEach(inp=>{
              inp.addEventListener('input',()=>{
                const k = inp.getAttribute('data-k'); S.meds.list[idx][k]=inp.value; persist();
              });
            });
            tr.querySelector('button[data-del]').addEventListener('click',()=>{
              S.meds.list.splice(idx,1); persist(); renderMeds();
            });
            tbody.appendChild(tr);
          });
        }
        const addBtn = el('button','btn'); addBtn.type='button'; addBtn.textContent='Add medication';
        addBtn.addEventListener('click',()=>{ S.meds.list.push({name:"",dose:"",route:"",when:"",purpose:""}); persist(); renderMeds(); });
        medsWrap.append(tbl, addBtn);
        p.append(medsWrap);

        p.append(
          chips("Self-administration ability","meds.self_admin",["Independent","Prompting only","Partial assist","Staff administer","Not sure"]),
          chips("Webster/blister pack","meds.webster",["Yes","No","Not sure"]),
          el('div','grid.two',[
            field("Storage location (locked cupboard etc.)","meds.storage"),
            field("Access/keys (who holds)","meds.access")
          ]),
          field("Consent to administer (form, scope)","meds.consent","textarea"),
          field("Common side effects to monitor & responses","meds.side_effects","textarea"),
          field("Required monitoring (e.g., BP weekly, BSL before meals)","meds.monitoring","textarea"),
          field("Emergency medication plan (EpiPen, midazolam — triggers, steps, who to call)","meds.emergency_plan","textarea"),
          field("Missed/refused dose protocol","meds.missed","textarea"),
          field("Recent changes / upcoming reviews","meds.changes","textarea")
        );
      }
    },
    { key:"risk", title:"8) Risk assessment & safety", build(buildPanel){
        const p = buildPanel();
        p.append(
          el('div','grid.two',[
            chips("Falls risk","risk.falls",["Low","Medium","High","Not sure"]),
            field("Falls — prevention strategies","risk.falls_strat","textarea")
          ]),
          el('div','grid.two',[
            chips("Pressure injury risk","risk.pressure",["Low","Medium","High","Not sure"]),
            field("Pressure care strategies","risk.pressure_strat","textarea")
          ]),
          el('div','grid.two',[
            chips("Wandering / elopement risk","risk.wandering",["No","Sometimes","Yes","Not sure"]),
            field("Wandering safeguards (supervision, alarms)","risk.wandering_strat","textarea")
          ]),
          field("Smoking / alcohol / substances (notes)","risk.substances","textarea"),
          field("Transport & vehicle safety (seating, restraints, WAV)","risk.transport","textarea"),
          field("Emergency plan (evac, hospital preferences, contact order)","risk.emergency_plan","textarea")
        );
      }
    },
    { key:"goals", title:"9) Goals & outcomes (person-centred)", build(buildPanel){
        const p = buildPanel();
        p.append(
          field("Participant goals (from plan / aspirations)","goals.items","textarea"),
          field("Desired outcomes (what success looks like)","goals.outcomes","textarea"),
          field("Strategies / supports to achieve goals","goals.strategies","textarea")
        );
      }
    },
    { key:"consent", title:"10) Additional consents & attachments", build(buildPanel){
        const p = buildPanel();
        p.append(
          chips("Consent to share plan with relevant parties","consent.share_info",["Yes","No"]),
          field("Consent notes / scope / limits","consent.share_notes","textarea")
        );
      }
    },
    { key:"sign", title:"11) Signatures (sign-off)", build(buildPanel){
        const p = buildPanel();
        p.append(
          el('div','grid.two',[
            field("Participant / Representative — printed name","signatures.client_name"),
            field("Date","signatures.client_date","date")
          ]),
          el('div','field',`<label>Signature (to sign after PDF print, or integrate e-signature later)</label>
            <div style="height:90px;border:1px dashed #2a4a66;border-radius:10px;background:#0e1b29"></div>`),
          el('div','grid.three',[
            field("Provider representative — name","signatures.provider_name"),
            field("Role / title","signatures.provider_role"),
            field("Date","signatures.provider_date","date")
          ])
        );
      }
    }
  ];

  function buildPanelWrapper(title, key){
    const det = document.createElement('details');
    det.id = "sec_"+key;
    det.open = (S._nr[key]!==true); // open unless marked not required
    const sum = document.createElement('summary');
    sum.innerHTML = `<span>${title}</span> <span class="badge" id="badge_${key}">Section</span>`;
    sum.appendChild(nrToggle(key, det));
    const panel = el('div','panel');
    det.append(sum, panel);
    return { det, panel };
  }

  function buildAll(){
    container.innerHTML="";
    TOC.innerHTML="";
    SECTIONS.forEach((s,idx)=>{
      const {det,panel} = buildPanelWrapper(s.title, s.key);
      function buildPanel(){ return panel; }
      s.build(buildPanel, s.key);
      container.appendChild(det);

      const tocBtn = document.createElement('button');
      tocBtn.textContent = (idx+1)+". "+s.title.replace(/^\d+\)\s*/,'');
      tocBtn.addEventListener('click',()=>{ document.getElementById('sec_'+s.key).scrollIntoView({behavior:'smooth', block:'start'}); highlightTOC(idx); });
      TOC.appendChild(tocBtn);
    });
    highlightTOC(0);
    persist();
  }

  function highlightTOC(i){
    TOC.querySelectorAll('button').forEach((b,idx)=>{ b.classList.toggle('current', idx===i); });
  }

  /* ===== Upload & Auto-fill ===== */
  $("#fileInput").addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0]; if(!f) return;
    try{
      if (/\.(rtf)$/i.test(f.name)) {
        const txt = await f.text();
        const plain = rtfToText(txt);
        autofillFromText(plain);
      } else if (/\.(pdf)$/i.test(f.name)) {
        // Best-effort: some browsers expose text via .text() for simple PDFs; otherwise this will fail silently.
        // For production, wire in PDF.js.
        if (f.text) {
          const maybe = await f.text();
          autofillFromText(maybe);
        } else {
          alert("PDF text extraction needs PDF.js for reliable results. Please upload RTF or a text-based PDF.");
        }
      } else {
        const text = await f.text();
        autofillFromText(text);
      }
      persist();
      alert("Auto-fill complete. Please review and adjust any fields.");
    } catch(err){
      console.error(err);
      alert("Couldn’t read that file. For best results, upload RTF or a text-based PDF.");
    } finally {
      e.target.value = "";
    }
  });

  function rtfToText(rtf){
    // Very lightweight RTF → text: strip control words, braces, hex escapes.
    return rtf
      .replace(/\\par[d]?/g, "\n")
      .replace(/\\'[0-9a-fA-F]{2}/g, m=>String.fromCharCode(parseInt(m.slice(2),16)))
      .replace(/\\[a-z]+-?\d* ?/g, "")
      .replace(/[{}]/g,"")
      .replace(/\n{3,}/g,"\n\n");
  }

  function pick(text,label){
    const re = new RegExp(String(label).replace(/[-\/\\^$*+?.()|[\]{}]/g,'\\$&')+`\\s*[:\\-]?\\s*(.+)`, 'i');
    const m = text.match(re); return m ? m[1].trim().split(/\r?\n/)[0] : "";
  }

  function autofillFromText(t){
    // Map common labels → fields (extend as needed)
    set("participant.legal_name", pick(t,"Name") || pick(t,"Participant Name"));
    set("participant.dob", (pick(t,"DOB")||"").replace(/[^0-9\-\/]/g,""));
    set("participant.ndis", pick(t,"NDIS") || pick(t,"NDIS Number"));
    set("health.allergies", pick(t,"Allergies"));
    set("health.primary_dx", pick(t,"Diagnosis") || pick(t,"Primary Diagnoses"));
    set("team.gp_name", pick(t,"GP") || pick(t,"General Practitioner"));
    // very simple meds parse
    const meds = [];
    const medsSec = t.split(/Medications?:/i)[1] || "";
    medsSec.split(/\n/).slice(0,20).forEach(line=>{
      const m = line.match(/^([\w\- ()\/]+)\s+(\d[^\s]*)\s+(.+?)\s+@\s+(.+?)\s*-\s*(.+)$/i);
      if(m) meds.push({name:m[1], dose:m[2], route:m[3], when:m[4], purpose:m[5]});
    });
    if (meds.length) S.meds.list = meds;
    persist(); buildAll(); // re-render to show updates
  }

  /* ===== Export: PDF & RTF ===== */
  $("#genPDF").addEventListener('click', ()=>{
    const w = window.open('', '_blank');
    w.document.write(buildPrintHTML());
    w.document.close();
    setTimeout(()=>{ try{ w.focus(); }catch(e){} }, 100);
  });

  $("#genRTF").addEventListener('click', ()=>{
    const rtf = buildRTF();
    const blob = new Blob([rtf], {type:'application/rtf'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "NDIS_Care_Plan_Editable.rtf";
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  });

  function safe(v){ return (v==null||v==="") ? "—" : String(v); }
  function yesno(v){ if(v===true||v==="Yes") return "Yes"; if(v===false||v==="No") return "No"; return v||"—"; }
  function addrLine(){ return [S.participant.address,S.participant.suburb,S.participant.state,S.participant.postcode].filter(Boolean).join(", "); }

  function buildPrintHTML(){
    const today = new Date().toLocaleDateString('en-AU',{day:'numeric',month:'long',year:'numeric'});
    function row(k,v){ return `<tr><th>${k}</th><td>${safe(v)}</td></tr>`; }
    function tblStart(t){ return `<section class="section"><h2>${t}</h2><table class="kv">`; }
    function tblEnd(){ return `</table></section>`; }

    let html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>NDIS Care Plan — Print</title>
      <style>
        html,body{margin:0;padding:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#111}
        @page{size:A4;margin:16mm 14mm}
        h1{margin:0 0 6px;font-size:24px}
        .container{margin:10px 0}
        .section{page-break-inside:avoid;margin:12px 0;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fafafa}
        h2{font-size:16px;margin:0 0 8px}
        table.kv{width:100%;border-collapse:separate;border-spacing:0 6px}
        th{width:220px;text-align:left;padding:6px 8px;background:#e6fffb;border-radius:8px;font-weight:700;color:#065f46}
        td{padding:6px 8px;background:#fff;border-radius:8px;border:1px solid #e5e7eb}
      </style></head><body>
      <h1>NDIS Comprehensive Care Plan</h1>
      <div class="container">`;

    // Participant
    html += tblStart("Participant");
    html += row("Legal name",S.participant.legal_name) + row("Preferred name",S.participant.preferred_name) + row("DOB",S.participant.dob) + row("NDIS number",S.participant.ndis) + row("Address",addrLine()) + row("Plan mgmt",S.participant.plan_mgmt) + row("Plan dates",(S.participant.plan_start||"")+" → "+(S.participant.plan_end||"")) + row("Phone",S.participant.phone) + row("Email",S.participant.email);
    html += row("Emergency contact",[S.emergency.name,S.emergency.rel,S.emergency.phone].filter(Boolean).join(" • "));
    html += row("Support Coordinator",[S.team.sc_name,S.team.sc_org,S.team.sc_email,S.team.sc_phone].filter(Boolean).join(" • "));
    html += row("Plan Manager",[S.team.pm_name,S.team.pm_org,S.team.pm_email,S.team.pm_phone].filter(Boolean).join(" • "));
    html += row("GP",[S.team.gp_name,S.team.gp_practice,S.team.gp_phone,S.team.gp_email].filter(Boolean).join(" • "));
    html += tblEnd();

    // Health
    html += tblStart("Health & medical");
    html += row("Primary diagnoses",S.health.primary_dx) + row("Other diagnoses",S.health.other_dx) + row("Allergies",S.health.allergies) + row("Equipment / aids",S.health.equipment) + row("Cognition",S.health.cognition) + row("Vision/Hearing",S.health.vision_hearing) + row("Mental health",S.health.mental_health) + row("Diet / nutrition",S.health.diet);
    html += tblEnd();

    // Daily living
    html += tblStart("Daily living & personal care");
    html += row("Bathing",S.daily.bathing) + row("Bathing preferences",S.daily.bathing_prefs) + row("Dressing",S.daily.dressing) + row("Grooming/oral care",S.daily.grooming) + row("Toileting",S.daily.toileting) + row("Continence",S.daily.continence) + row("Mobility",S.daily.mobility) + row("Transfers/hoist",S.daily.transfers) + row("Home aids",S.daily.aids) + row("Important routines",S.daily.routines) + row("Home env./access",S.daily.environment) + row("Home safety notes", (S.risk.home_check && S.risk.home_check.notes)||"—");
    html += tblEnd();

    // Comms
    html += tblStart("Communication & sensory");
    html += row("Language",S.comms.language) + row("Method",S.comms.method) + row("Interpreter",S.comms.interpreter + (S.comms.interpreter_lang?(" ("+S.comms.interpreter_lang+")"):"")) + row("Decision support",S.comms.decision_support) + row("Behavioural cues",S.comms.cues) + row("Sensory",S.comms.sensory);
    html += tblEnd();

    // Social
    html += tblStart("Social & lifestyle");
    html += row("Living situation",S.social.living) + row("Household",S.social.household) + row("Supports",S.social.supports) + row("Interests/activities",S.social.interests) + row("Routine",S.social.routine);
    html += tblEnd();

    // Behaviour
    html += tblStart("Behaviour management");
    html += row("Description",S.behaviour.description) + row("Triggers",S.behaviour.triggers) + row("Early signs",S.behaviour.early_signs) + row("Prevention",S.behaviour.prevention) + row("De-escalation",S.behaviour.deescalation) + row("Post-incident",S.behaviour.post_incident) + row("BSP in place", yesno(S.behaviour.bsp)) + row("Restrictive practices", yesno(S.behaviour.restrictive)) + row("Restrictive practice notes",S.behaviour.restrictive_notes) + row("Reporting/communication",S.behaviour.reporting);
    html += tblEnd();

    // Meds
    html += tblStart("Medication management");
    const meds = (S.meds.list||[]).map(m=>[m.name,m.dose,m.route,m.when,m.purpose].filter(Boolean).join(" • ")).join("<br>");
    html += row("Medication list", meds||"—") + row("Self-admin",S.meds.self_admin) + row("Webster pack",S.meds.webster) + row("Storage",S.meds.storage) + row("Access/keys",S.meds.access) + row("Consent",S.meds.consent) + row("Side effects (monitor/response)",S.meds.side_effects) + row("Monitoring required",S.meds.monitoring) + row("Emergency medication plan",S.meds.emergency_plan) + row("Missed/refused protocol",S.meds.missed) + row("Recent changes/reviews",S.meds.changes);
    html += tblEnd();

    // Risk
    html += tblStart("Risk & safety");
    html += row("Falls risk",S.risk.falls) + row("Falls strategies",S.risk.falls_strat) + row("Pressure injury risk",S.risk.pressure) + row("Pressure strategies",S.risk.pressure_strat) + row("Wandering risk",S.risk.wandering) + row("Wandering safeguards",S.risk.wandering_strat) + row("Smoking/alcohol/substances",S.risk.substances) + row("Transport safety",S.risk.transport) + row("Emergency plan",S.risk.emergency_plan);
    html += tblEnd();

    // Goals
    html += tblStart("Goals & outcomes");
    html += row("Goals",S.goals.items) + row("Outcomes",S.goals.outcomes) + row("Strategies",S.goals.strategies);
    html += tblEnd();

    // Consents
    html += tblStart("Additional consents");
    html += row("Consent to share plan", yesno(S.consent.share_info)) + row("Consent notes",S.consent.share_notes);
    html += tblEnd();

    // Signatures
    html += tblStart("Signatures");
    html += row("Participant / Representative (name)",S.signatures.client_name) + row("Date",S.signatures.client_date);
    html += `<tr><th>Signature (sign after printing)</th><td><div style="height:80px;border:1px dashed #cbd5e1;border-radius:8px"></div></td></tr>`;
    html += row("Provider rep (name)",S.signatures.provider_name) + row("Role/title",S.signatures.provider_role) + row("Date",S.signatures.provider_date);
    html += `<tr><th>Signature (provider)</th><td><div style="height:80px;border:1px dashed #cbd5e1;border-radius:8px"></div></td></tr>`;
    html += tblEnd();

    html += `</div><script>window.print()<\/script></body></html>`;
    return html;
  }

  function buildRTF(){
    function esc(s){ return (s||'').toString().replace(/[\\{}]/g, m=>'\\'+m).replace(/\n/g,'\\par '); }
    function line(k,v){ return '\\b '+esc(k)+':\\b0\\tab '+esc(v||'—')+'\\par '; }
    function block(title, lines){ return '{\\pard\\sa140\\b\\ul '+esc(title)+'\\ul0\\b0\\par }{\\pard\\sa80 '+lines.join('')+'}'; }
    const addr = [S.participant.address,S.participant.suburb,S.participant.state,S.participant.postcode].filter(Boolean).join(', ');
    const meds = (S.meds.list||[]).map(m=>[m.name,m.dose,m.route,m.when,m.purpose].filter(Boolean).join(' • ')).join('\\par ');
    const parts = [];
    parts.push(block('Participant',[
      line('Legal name',S.participant.legal_name), line('Preferred name',S.participant.preferred_name),
      line('DOB',S.participant.dob), line('NDIS number',S.participant.ndis),
      line('Address',addr), line('Plan mgmt',S.participant.plan_mgmt),
      line('Plan dates',(S.participant.plan_start||'')+' → '+(S.participant.plan_end||'')),
      line('Phone',S.participant.phone), line('Email',S.participant.email),
      line('Emergency contact',[S.emergency.name,S.emergency.rel,S.emergency.phone].filter(Boolean).join(' • ')),
      line('Support Coordinator',[S.team.sc_name,S.team.sc_org,S.team.sc_email,S.team.sc_phone].filter(Boolean).join(' • ')),
      line('Plan Manager',[S.team.pm_name,S.team.pm_org,S.team.pm_email,S.team.pm_phone].filter(Boolean).join(' • ')),
      line('GP',[S.team.gp_name,S.team.gp_practice,S.team.gp_phone,S.team.gp_email].filter(Boolean).join(' • '))
    ]));
    parts.push(block('Health & medical',[
      line('Primary diagnoses',S.health.primary_dx), line('Other diagnoses',S.health.other_dx),
      line('Allergies',S.health.allergies), line('Equipment / aids',S.health.equipment),
      line('Cognition',S.health.cognition), line('Vision/Hearing',S.health.vision_hearing),
      line('Mental health',S.health.mental_health), line('Diet',S.health.diet)
    ]));
    parts.push(block('Daily living',[
      line('Bathing',S.daily.bathing), line('Bathing prefs',S.daily.bathing_prefs),
      line('Dressing',S.daily.dressing), line('Grooming/oral',S.daily.grooming),
      line('Toileting',S.daily.toileting), line('Continence',S.daily.continence),
      line('Mobility',S.daily.mobility), line('Transfers/hoist',S.daily.transfers),
      line('Home aids',S.daily.aids), line('Routines',S.daily.routines),
      line('Home env/access',S.daily.environment), line('Home safety notes', (S.risk.home_check && S.risk.home_check.notes)||'—')
    ]));
    parts.push(block('Communication & sensory',[
      line('Language',S.comms.language), line('Method',S.comms.method),
      line('Interpreter',S.comms.interpreter + (S.comms.interpreter_lang?(' ('+S.comms.interpreter_lang+')'):'') ),
      line('Decision support',S.comms.decision_support), line('Cues',S.comms.cues), line('Sensory',S.comms.sensory)
    ]));
    parts.push(block('Social & lifestyle',[
      line('Living',S.social.living), line('Household',S.social.household),
      line('Supports',S.social.supports), line('Interests',S.social.interests), line('Routine',S.social.routine)
    ]));
    parts.push(block('Behaviour management',[
      line('Description',S.behaviour.description), line('Triggers',S.behaviour.triggers),
      line('Early signs',S.behaviour.early_signs), line('Prevention',S.behaviour.prevention),
      line('De-escalation',S.behaviour.deescalation), line('Post-incident',S.behaviour.post_incident),
      line('BSP in place', S.behaviour.bsp===true?'Yes':S.behaviour.bsp===false?'No':(S.behaviour.bsp||'—')),
      line('Restrictive practices', S.behaviour.restrictive===true?'Yes':S.behaviour.restrictive===false?'No':(S.behaviour.restrictive||'—')),
      line('Restrictive notes',S.behaviour.restrictive_notes), line('Reporting',S.behaviour.reporting)
    ]));
    parts.push(block('Medication management',[
      line('Medication list', meds||'—'),
      line('Self-admin',S.meds.self_admin), line('Webster',S.meds.webster),
      line('Storage',S.meds.storage), line('Access/keys',S.meds.access),
      line('Consent',S.meds.consent), line('Side effects',S.meds.side_effects),
      line('Monitoring',S.meds.monitoring), line('Emergency med plan',S.meds.emergency_plan),
      line('Missed/refused protocol',S.meds.missed), line('Recent changes/reviews',S.meds.changes)
    ]));
    parts.push(block('Risk & safety',[
      line('Falls risk',S.risk.falls), line('Falls strategies',S.risk.falls_strat),
      line('Pressure risk',S.risk.pressure), line('Pressure strategies',S.risk.pressure_strat),
      line('Wandering risk',S.risk.wandering), line('Wandering safeguards',S.risk.wandering_strat),
      line('Smoking/alcohol/substances',S.risk.substances),
      line('Transport safety',S.risk.transport), line('Emergency plan',S.risk.emergency_plan)
    ]));
    parts.push(block('Goals & outcomes',[
      line('Goals',S.goals.items), line('Outcomes',S.goals.outcomes), line('Strategies',S.goals.strategies)
    ]));
    parts.push(block('Consents',[
      line('Share plan', (S.consent.share_info===true||S.consent.share_info==="Yes")?"Yes":(S.consent.share_info===false||S.consent.share_info==="No")?"No":"—"),
      line('Consent notes',S.consent.share_notes)
    ]));
    parts.push(block('Signatures',[
      line('Participant/Representative — name',S.signatures.client_name), line('Date',S.signatures.client_date),
      line('Provider representative — name',S.signatures.provider_name), line('Role/title',S.signatures.provider_role), line('Date',S.signatures.provider_date)
    ]));
    return '{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Arial;}}\\fs22 '+parts.join(' ')+' }';
  }

  /* ===== Review jump, Reset, Top ===== */
  $("#reviewBtn").addEventListener('click', ()=>{
    // open all sections not marked NR for a quick scan
    SECTIONS.forEach(s=>{
      const det = document.getElementById('sec_'+s.key); if(!det) return;
      det.open = (S._nr[s.key]!==true);
    });
    window.scrollTo({top:0, behavior:'smooth'});
    alert("Review opened. Scroll to verify details, then export PDF or RTF.");
  });

  $("#resetBtn").addEventListener('click', ()=>{
    if(!confirm("This will clear all data for a fresh client. Continue?")) return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  });

  $("#jumpTop").addEventListener('click', ()=>window.scrollTo({top:0, behavior:'smooth'}));

  /* ===== Init ===== */
  buildAll();

  // Highlight TOC based on scroll
  const secEls = SECTIONS.map(s=>document.getElementById('sec_'+s.key));
  document.addEventListener('scroll', ()=>{
    let idx = 0;
    for (let i=0;i<secEls.length;i++){
      const r = secEls[i].getBoundingClientRect();
      if (r.top < 140) idx = i;
    }
    highlightTOC(idx);
  });

})();
</script>

</body>
</html>
