<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AILR ‚Äî Comprehensive Onboarding (HD HeeD)</title>
  <meta name="theme-color" content="#0b0f1a">

  <!--
    Paths to confirm on your server:
    - Client Handbook PDF:   /docs/Client-Handbook.pdf
    - Client Handbook DOCX:  /docs/Client-Handbook.docx  (optional)
    - Ella portraits:        /images/ella/ella-default.png (and others listed below)
  -->

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Brand + AILR */
      --ink:#0c1226; --bg:#0b0f1a; --panel:#0f172a; --line:#1e2a4a; --soft:#111a33;
      --text:#e8edff; --muted:#a4b4e6; --accent:#ffc107; --blue:#2563eb; --ring:#93c5fd;
      --danger:#ef4444; --success:#22c55e; --chip:#121a3a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#0b0f1a,#0a1224 40%, #0b0f1a);
      color:var(--text);
    }
    img{max-width:100%; display:block}
    a{color:var(--accent); text-decoration:none}
    a:focus-visible,button:focus-visible,input:focus-visible,select:focus-visible,textarea:focus-visible{
      outline:2px solid var(--ring); outline-offset:2px; border-radius:10px;
    }

    /* Page shell (kept lean but consistent) */
    header.site{position:sticky;top:0;z-index:40;background:#0e1428;border-bottom:1px solid var(--line)}
    header .inner{max-width:1120px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:40px;height:40px;border-radius:10px}
    .brand .title{font-weight:900}
    .brand .tag{font-size:12px;color:#c8d5ff}

    main{max-width:1120px;margin:0 auto;padding:16px}
    .wrap{
      background:linear-gradient(180deg,#10172a,#0b1124);
      border:1px solid var(--line); border-radius:18px; box-shadow:0 28px 110px rgba(0,0,0,.5);
      overflow:hidden;
    }

    /* Layout: portrait left (desktop), single column on mobile */
    .flow{
      display:grid; grid-template-columns:260px 1fr; gap:0; min-height:calc(100vh - 160px);
    }
    @media (max-width: 980px){
      .flow{ grid-template-columns:1fr }
    }

    /* Left portrait column (Ella vibe) */
    .aside{
      background:radial-gradient(80% 60% at 120% 0%, rgba(255,255,255,.06), transparent 60%), #0f1327;
      border-right:1px solid var(--line);
      padding:18px; position:relative;
    }
    .aside .portrait{
      position:sticky; top:16px;
      display:grid; gap:10px; align-content:start;
    }
    .portrait img{
      width:100%; border-radius:16px; filter:drop-shadow(0 18px 36px rgba(0,0,0,.35));
      background:transparent; border:none;
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line); background:#0f1937; color:#cfe0ff;
      border-radius:999px; padding:6px 10px; font-size:12px;
    }

    /* Right main column */
    .content{padding:18px}
    .head{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:8px;
    }
    .head .ttl{font-weight:900; font-size:clamp(18px,4.6vw,26px)}
    .progress{display:flex; align-items:center; gap:10px}
    .meter{width:180px; height:8px; background:#101838; border:1px solid var(--line); border-radius:999px; overflow:hidden}
    .meter>div{height:100%; background:linear-gradient(90deg,#ffd95c,#ffe78f); width:0%}

    /* Cards / sections */
    .card{
      background:var(--panel); border:1px solid var(--line); border-radius:16px;
      padding:16px; display:grid; gap:12px;
    }
    .subttl{font-weight:900; color:#fff; margin:0}
    .muted{color:var(--muted)}

    /* Form grid */
    .grid{display:grid; gap:12px}
    .g-two{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g-three{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:980px){ .g-two,.g-three{grid-template-columns:1fr} }

    label{font-weight:700; display:block; margin-bottom:6px}
    .hint{font-size:12px; color:#b7c6ff}

    input[type="text"],input[type="email"],input[type="tel"],input[type="date"],
    input[type="number"],select,textarea{
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid #2a3b68; background:#0f1b3b; color:#e7ebff; font-size:15px;
    }
    textarea{min-height:110px; resize:vertical}
    input[type="file"]{color:#cfe0ff}

    /* Option rows: aligned labels + inputs */
    .opt-row{display:flex; align-items:center; gap:10px}
    .opt-row .opt-label{min-width:220px; font-weight:800}
    @media (max-width:640px){ .opt-row{flex-direction:column; align-items:flex-start} .opt-row .opt-label{min-width:auto} }

    /* Exclusive choices styled as chips */
    .chips{display:flex; flex-wrap:wrap; gap:10px}
    .chip{
      border:1px solid var(--line); background:linear-gradient(180deg,#121a3a,#0f172f);
      color:#e7ebff; border-radius:12px; padding:12px 14px; cursor:pointer;
      font-weight:800; min-height:44px; display:inline-flex; align-items:center; gap:10px;
    }
    .chip[aria-pressed="true"]{
      border-color:var(--blue); box-shadow:0 0 0 3px rgba(37,99,235,.25);
    }

    /* Buttons */
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; padding-top:6px}
    .btn{
      border:1px solid var(--line); background:#121a3a; color:#e7ebff;
      padding:12px 16px; border-radius:12px; font-weight:900; cursor:pointer; min-height:44px;
    }
    .btn.primary{ background:var(--accent); color:#2a2100; box-shadow:0 12px 34px rgba(0,0,0,.35) }
    .btn.solid{ background:#1642aa }
    .btn.ghost{ background:#101938 }
    .btn.danger{ background:#2a1320; border-color:#472235; color:#ffd0db }
    .btn:active{ transform: translateY(1px) }

    .error{color:#ffb3bf; font-size:13px}

    /* Review box */
    .review{white-space:pre-wrap; background:#0e162e; border:1px dashed #2a3b68; border-radius:12px; padding:12px}

    /* Handbook viewer */
    .handbook-view{ width:100%; height:420px; border:1px solid var(--line); border-radius:12px; background:#0d1428 }

    /* Sticky footer for mobile primary action */
    .sticky{
      position:sticky; bottom:0; z-index:30; padding:10px 0; margin-top:8px;
      background:linear-gradient(180deg,transparent,rgba(11,15,26,.75) 40%, rgba(11,15,26,.95));
      display:flex; justify-content:flex-end;
    }

    /* Bigger on mobile */
    @media (max-width:640px){
      .btn, .chip{ font-size:1rem; padding:14px 16px }
      input,select,textarea{ font-size:16px; padding:14px }
      .opt-row .opt-label{ font-size:1rem }
    }
  </style>
</head>
<body>
  <header class="site" aria-label="Header">
    <div class="inner">
      <div class="brand">
        <img src="/images/logo.png" alt="HD HeeD"/>
        <div>
          <div class="title" style="font-weight:900">HD HeeD ‚Äî AILR Onboarding</div>
          <div class="tag">NDIS Registered ‚Ä¢ Clinically led ‚Ä¢ Person-centred</div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="flow">
        <!-- Left: Ella portrait & quick status -->
        <aside class="aside">
          <div class="portrait">
            <img id="ellaPortrait" src="/images/ella/ella-default.png" alt="Ella ‚Äî friendly assistant portrait">
            <span class="pill" id="progressBadge">Step 1/12</span>
            <span class="pill">Voice tips: Speak answers or tap choices</span>
          </div>
        </aside>

        <!-- Right: Content -->
        <section class="content">
          <div class="head">
            <div class="ttl" id="stepTitle">Welcome to onboarding</div>
            <div class="progress" style="margin-left:auto">
              <div class="meter" aria-label="Progress"><div id="bar"></div></div>
            </div>
          </div>

          <!-- STEP CONTAINER -->
          <form id="ailrForm" class="grid" novalidate>
            <!-- Steps are injected here -->
            <div id="stepRoot" class="grid"></div>

            <!-- Review + Submit (injected on final step) -->
          </form>

          <!-- Nav buttons -->
          <div class="actions">
            <div style="display:flex; gap:8px">
              <button id="btnPrev" class="btn ghost" type="button">‚Üê Previous</button>
              <button id="btnSave" class="btn" type="button" title="Save progress locally">üíæ Save</button>
              <button id="btnLoad" class="btn" type="button" title="Load saved progress">‚Ü∫ Load</button>
            </div>
            <div class="sticky" style="gap:8px">
              <button id="btnNext" class="btn primary" type="button">Next ‚Üí</button>
              <button id="btnSubmit" class="btn solid" type="button" style="display:none">Submit ‚úì</button>
            </div>
          </div>

          <p class="hint" id="stepHint"></p>
          <p class="error" id="stepError" role="alert"></p>
        </section>
      </div>
    </div>
  </main>

  <script>
  (function(){
    /* ====== Config ====== */
    const FS_ENDPOINT = "https://formspree.io/f/xvgrkkjn"; // Formspree endpoint (supports files via FormData)
    const FALLBACK_MAIL = "info@hdheed.com.au";

    const IMG = {
      default: "/images/ella/ella-default.png",
      consent: "/images/ella/ella-consent.png",
      profile: "/images/ella/ella-service.png",
      plan: "/images/ella/ella-management.png",
      risk: "/images/ella/ella-risk-med.png",
      home: "/images/ella/ella-location.png",
      beh: "/images/ella/ella-risk-beh.png",
      medical: "/images/ella/ella-hours.png",
      meds: "/images/ella/ella-rostering.png",
      interpreter: "/images/ella/ella-interpreter.png",
      files: "/images/ella/ella-dates.png",
      review: "/images/ella/ella-summary.png",
    };

    /* ====== State ====== */
    const SKEY = "ailr_state_v12";
    let S = {
      i: 0,
      introShown: false,
      data: {}
    };
    // Load any saved state on init
    try{
      const prev = JSON.parse(localStorage.getItem(SKEY) || "null");
      if (prev) S = prev;
    }catch{}

    const form = document.getElementById("ailrForm");
    const root = document.getElementById("stepRoot");
    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");
    const btnSubmit = document.getElementById("btnSubmit");
    const btnSave = document.getElementById("btnSave");
    const btnLoad = document.getElementById("btnLoad");
    const stepTitle = document.getElementById("stepTitle");
    const stepHint = document.getElementById("stepHint");
    const stepError = document.getElementById("stepError");
    const bar = document.getElementById("bar");
    const progressBadge = document.getElementById("progressBadge");
    const portrait = document.getElementById("ellaPortrait");

    /* ====== Utilities ====== */
    const save = ()=>{ try{ localStorage.setItem(SKEY, JSON.stringify(S)); }catch{} };
    const get = (k, d="") => (S.data?.[k] ?? d);
    const set = (k, v) => { S.data[k] = v; save(); };
    const setMany = (obj)=>{ Object.assign(S.data, obj||{}); save(); };

    // Enforce that "None" / "Prefer not to say" (or similar) deselect others in a group
    function bindExclusiveCheckboxes(container, noneValues = ["none","prefer_not_to_say"]){
      const boxes = container.querySelectorAll('input[type="checkbox"][data-group]');
      const byGroup = {};
      boxes.forEach(b=>{
        const g = b.dataset.group;
        byGroup[g] = byGroup[g] || [];
        byGroup[g].push(b);
      });
      Object.values(byGroup).forEach(groupBoxes=>{
        groupBoxes.forEach(box=>{
          box.addEventListener('change', ()=>{
            const isNone = noneValues.includes(box.value);
            if (isNone && box.checked){
              groupBoxes.forEach(other=>{
                if (other !== box){ other.checked = false; other.disabled = true; }
              });
            } else if (isNone && !box.checked){
              groupBoxes.forEach(other=>{
                if (other !== box){ other.disabled = false; }
              });
            } else if (box.checked){
              // If any regular is checked, ensure "none" is unchecked & enabled
              groupBoxes.forEach(other=>{
                if (noneValues.includes(other.value)){ other.checked = false; other.disabled = false; }
              });
            }
          });
        });
      });
    }

    // For obvious binary decisions (consents): radios only (mutually exclusive)
    function radioRow(name, labelText, options){
      // options: [{v:"yes", t:"Yes"}, {v:"no", t:"No"}]
      const row = document.createElement('div');
      row.className = "opt-row";
      row.innerHTML = \`
        <div class="opt-label">\${labelText}</div>
        <div class="chips" role="group" aria-label="\${labelText}">
          \${options.map(o => \`
            <button type="button" class="chip" data-role="radio" data-name="\${name}" data-value="\${o.v}">\${o.t}</button>
          \`).join('')}
        </div>\`;
      return row;
    }

    function bindChipsRadio(section){
      section.querySelectorAll('[data-role="radio"]').forEach(btn=>{
        const name = btn.dataset.name;
        btn.addEventListener('click', ()=>{
          section.querySelectorAll('[data-role="radio"][data-name="'+name+'"]').forEach(b=> b.setAttribute('aria-pressed','false'));
          btn.setAttribute('aria-pressed','true');
          set(name, btn.dataset.value);
        });
        // prefill
        if (get(btn.dataset.name) === btn.dataset.value){
          btn.setAttribute('aria-pressed','true');
        }
      });
    }

    // Chip multiselect with None/Prefer-not logic
    function chipMulti(name, labelText, choices, noneValues = []){
      const row = document.createElement('div');
      row.className = "opt-row";
      row.innerHTML = \`
        <div class="opt-label">\${labelText}</div>
        <div class="chips" role="group" aria-label="\${labelText}">
          \${choices.map(c => \`
            <button type="button" class="chip" data-role="multi" data-name="\${name}" data-value="\${c.v}" \${c.title?('title="'+c.title+'"'):''}>\${c.t}</button>
          \`).join('')}
        </div>\`;
      row.dataset.noneValues = JSON.stringify(noneValues);
      return row;
    }

    function bindChipsMulti(section){
      const groups = {};
      section.querySelectorAll('[data-role="multi"]').forEach(btn=>{
        const name = btn.dataset.name;
        groups[name] = groups[name] || [];
        groups[name].push(btn);
      });
      Object.entries(groups).forEach(([name, list])=>{
        const noneValues = JSON.parse(list[0].closest('.opt-row').dataset.noneValues || "[]");
        // Prefill
        const chosen = new Set(Array.isArray(get(name)) ? get(name) : []);
        list.forEach(b=>{
          if (chosen.has(b.dataset.value)) b.setAttribute('aria-pressed','true');
        });
        // Handler
        list.forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const v = btn.dataset.value;
            const sel = new Set(Array.isArray(get(name)) ? get(name) : []);
            const isOn = btn.getAttribute('aria-pressed') === 'true';
            if (isOn){ sel.delete(v); btn.setAttribute('aria-pressed','false'); }
            else{
              // If selecting a "none" value, clear others
              if (noneValues.includes(v)){
                sel.clear();
                list.forEach(b=> b.setAttribute('aria-pressed','false'));
                sel.add(v);
              } else {
                // Selecting regular -> remove any none values
                noneValues.forEach(nv=> sel.delete(nv));
                list.forEach(b=> { if (noneValues.includes(b.dataset.value)) b.setAttribute('aria-pressed','false'); });
                sel.add(v);
              }
              btn.setAttribute('aria-pressed','true');
            }
            set(name, Array.from(sel));
          });
        });
      });
    }

    function textRow(name, labelText, placeholder="", type="text"){
      const wrap = document.createElement('div');
      wrap.className = "grid";
      wrap.innerHTML = \`
        <label for="\${name}">\${labelText}</label>
        <input id="\${name}" name="\${name}" type="\${type}" placeholder="\${placeholder}">
      \`;
      return wrap;
    }

    function fileRow(name, labelText, accept, multiple=false){
      const wrap = document.createElement('div');
      wrap.className = "grid";
      wrap.innerHTML = \`
        <label for="\${name}">\${labelText}</label>
        <input id="\${name}" name="\${name}" type="file" \${accept?('accept="'+accept+'"'):''} \${multiple?'multiple':''}>
      \`;
      return wrap;
    }

    function areaRow(name, labelText, placeholder=""){
      const wrap = document.createElement('div');
      wrap.className = "grid";
      wrap.innerHTML = \`
        <label for="\${name}">\${labelText}</label>
        <textarea id="\${name}" name="\${name}" placeholder="\${placeholder}"></textarea>
      \`;
      return wrap;
    }

    function section(title, hint="", imgKey="default"){
      const sec = document.createElement('div');
      sec.className = "card";
      sec.dataset.imgKey = imgKey;
      if (title){
        const h = document.createElement('h2');
        h.className = "subttl";
        h.textContent = title;
        sec.appendChild(h);
      }
      if (hint){
        const p = document.createElement('p');
        p.className = "muted";
        p.textContent = hint;
        sec.appendChild(p);
      }
      return sec;
    }

    function requireIf(condition, msg){
      if (!condition){ throw new Error(msg || "Please complete this step before continuing."); }
    }

    /* ====== Steps (12 sections) ====== */
    // NOTE: Each step renderer returns a section node. Validation performed by the "validate" function.
    const steps = [
      // 0. Intro
      {
        title: "Welcome ‚Äî let‚Äôs get you onboarded",
        hint: "You can choose answers, type details, or say 'Not sure'. Nothing is final until you submit.",
        img: "default",
        render(sec){
          sec.appendChild(areaRow("intro_notes", "Any quick context to start with? (optional)", "E.g., hospital discharge next week; seeking personal care AM visits"));
          // Handbook preview + downloads
          const handbook = document.createElement('div');
          handbook.className = "grid";
          handbook.innerHTML = \`
            <label>Client Handbook</label>
            <object class="handbook-view" data="/docs/Client-Handbook.pdf" type="application/pdf">
              <div class="muted" style="padding:12px">
                PDF preview not available on this device. 
                <a href="/docs/Client-Handbook.pdf" target="_blank" rel="noopener">Download the Handbook (PDF)</a>.
              </div>
            </object>
            <div class="chips">
              <a class="chip" href="/docs/Client-Handbook.pdf" target="_blank" rel="noopener">‚¨á Download PDF</a>
              <a class="chip" href="/docs/Client-Handbook.docx" target="_blank" rel="noopener">‚¨á Download DOCX</a>
            </div>
          \`;
          sec.appendChild(handbook);
          return sec;
        },
        validate(){ return true; }
      },

      // 1. Participant profile
      {
        title: "Participant profile",
        hint: "Basic info from Participant Registration & Profile forms.",
        img: "profile",
        render(sec){
          const grid = document.createElement('div');
          grid.className = "grid g-two";
          grid.appendChild(textRow("full_name","Full name",""));
          grid.appendChild(textRow("known_as","Preferred / Known as",""));
          grid.appendChild(textRow("dob","Date of birth","", "date"));
          grid.appendChild(textRow("ndis_number","NDIS number (if known)",""));
          grid.appendChild(textRow("email","Email","name@example.com","email"));
          grid.appendChild(textRow("phone","Phone","+61‚Ä¶","tel"));
          grid.appendChild(textRow("address","Home address","Street, suburb, postcode"));
          grid.appendChild(textRow("emergency_contact","Emergency contact (name + phone)",""));
          grid.appendChild(textRow("cultural_background","Cultural background / preferred pronouns (optional)",""));
          grid.appendChild(textRow("support_coord","Support Coordinator (name, org, contact)",""));
          grid.appendChild(textRow("plan_manager","Plan Manager (name, org, contact)",""));
          sec.appendChild(grid);

          // Plan management radios (exclusive)
          sec.appendChild(radioRow("plan_mgmt","Plan management",[
            {v:"ndia", t:"NDIA-managed"},
            {v:"plan", t:"Plan-managed"},
            {v:"self", t:"Self-managed"},
            {v:"unsure", t:"Not sure"},
          ]));

          // Communication preferences
          sec.appendChild(chipMulti("comm_prefs","Preferred contact",[
            {v:"call", t:"Phone call"},
            {v:"sms", t:"SMS"},
            {v:"email", t:"Email"},
            {v:"none", t:"Prefer not to say"},
          ], ["none"]));

          return sec;
        },
        validate(){
          requireIf(get("full_name"), "Please add the participant‚Äôs full name.");
          requireIf(get("dob"), "Please add date of birth.");
          requireIf(get("phone") || get("email"), "Please add at least a phone or an email.");
          return true;
        }
      },

      // 2. Location & service windows
      {
        title: "Location & preferred visit windows",
        hint: "Where support is needed and when.",
        img: "home",
        render(sec){
          const grid = document.createElement('div');
          grid.className = "grid g-two";
          grid.appendChild(textRow("service_suburb","Service suburb",""));
          grid.appendChild(textRow("service_postcode","Postcode",""));
          grid.appendChild(chipMulti("visit_windows","Preferred visit windows",[
            {v:"weekday_am", t:"Weekday AM (7‚Äì11)"},
            {v:"weekday_pm", t:"Weekday PM (12‚Äì4)"},
            {v:"evenings", t:"Evenings (5‚Äì9)"},
            {v:"weekends", t:"Weekends"},
            {v:"flex", t:"Flexible"},
            {v:"prefer_not_to_say", t:"Prefer not to say"},
          ], ["prefer_not_to_say"]));
          sec.appendChild(grid);
          return sec;
        },
        validate(){
          requireIf(get("service_suburb") && get("service_postcode"), "Please add suburb and postcode.");
          return true;
        }
      },

      // 3. Services requested
      {
        title: "Services requested",
        hint: "Select all that apply. Choose ‚ÄúNone/Not sure‚Äù if you‚Äôre unsure.",
        img: "plan",
        render(sec){
          // Multi with None
          const row = chipMulti("services_requested","Supports",[
            {v:"personal_care", t:"Personal care"},
            {v:"community_participation", t:"Community participation"},
            {v:"domestic_assistance", t:"Domestic assistance"},
            {v:"daily_living_skills", t:"Daily living skills"},
            {v:"nursing_care", t:"Nursing care"},
            {v:"respite", t:"Respite / carer relief"},
            {v:"none", t:"Not sure yet"},
          ], ["none"]);
          sec.appendChild(row);
          sec.appendChild(areaRow("service_notes","Anything specific you‚Äôd like help with? (optional)","E.g., morning showering Tue/Thu; community activity Saturdays"));
          return sec;
        },
        validate(){ return true; }
      },

      // 4. Consents (binary radios, no contradiction)
      {
        title: "Consents",
        hint: "These are mutually exclusive (Yes/No). No contradictions possible.",
        img: "consent",
        render(sec){
          sec.appendChild(radioRow("consent_info_share","Consent to share info with relevant providers (as needed)?",[
            {v:"yes", t:"Yes"}, {v:"no", t:"No"}
          ]));
          sec.appendChild(radioRow("consent_emergency","Consent for emergency treatment if required?",[
            {v:"yes", t:"Yes"}, {v:"no", t:"No"}
          ]));
          sec.appendChild(radioRow("consent_media","Consent for media/photos?",[
            {v:"yes", t:"Yes"}, {v:"no", t:"No"}
          ]));
          sec.appendChild(radioRow("consent_plan_share","Consent to view/share NDIS plan details?",[
            {v:"yes", t:"Yes"}, {v:"no", t:"No"}
          ]));
          sec.appendChild(radioRow("consent_money_property","Consent for assistance with money/property (if support requires)?",[
            {v:"yes", t:"Yes"}, {v:"no", t:"No"}
          ]));

          // Interpreter (with conditional text)
          sec.appendChild(radioRow("need_interpreter","Do you need an interpreter?",[
            {v:"yes", t:"Yes"}, {v:"no", t:"No"}, {v:"unsure", t:"Not sure"}
          ]));
          const lang = textRow("interpreter_language","If Yes, which language?","");
          lang.id = "langWrap";
          if ((get("need_interpreter")||"")!=="yes") lang.style.display="none";
          sec.appendChild(lang);

          return sec;
        },
        afterMount(sec){
          bindChipsRadio(sec);
          // Interpreter language toggle
          sec.querySelectorAll('[data-role="radio"][data-name="need_interpreter"]').forEach(btn=>{
            btn.addEventListener('click', ()=>{
              const v = btn.dataset.value;
              const wrap = document.getElementById("langWrap");
              wrap.style.display = (v === "yes") ? "block" : "none";
            });
          });
        },
        validate(){
          const v = get("need_interpreter");
          if (v === "yes") requireIf(get("interpreter_language"), "Please add interpreter language.");
          return true;
        }
      },

      // 5. Risks & behaviours
      {
        title: "Risks & behaviours",
        hint: "Complete only what applies. ‚ÄòNone/Prefer not to say‚Äô will disable other choices to avoid contradictions.",
        img: "risk",
        render(sec){
          sec.appendChild(chipMulti("risks_behaviours","Behaviours of concern",[
            {v:"history_absconding", t:"Absconding"},
            {v:"aggression", t:"Aggression"},
            {v:"property_damage", t:"Property damage"},
            {v:"self_harm", t:"Self-harm"},
            {v:"none", t:"None known"},
            {v:"prefer_not_to_say", t:"Prefer not to say"},
          ], ["none","prefer_not_to_say"]));

          sec.appendChild(areaRow("behaviour_triggers","Known triggers & strategies (optional)",""));
          sec.appendChild(radioRow("bsp_in_place","Behaviour Support Plan in place?",[
            {v:"yes", t:"Yes"}, {v:"no", t:"No"}, {v:"unsure", t:"Not sure"}
          ]));

          // Home risks
          sec.appendChild(chipMulti("home_risks","Home environment risks",[
            {v:"pets", t:"Pets"},
            {v:"smoking", t:"Smoking"},
            {v:"stairs", t:"Stairs"},
            {v:"limited_access", t:"Limited access"},
            {v:"none", t:"None known"},
            {v:"prefer_not_to_say", t:"Prefer not to say"},
          ], ["none","prefer_not_to_say"]));

          // Access / keys
          sec.appendChild(radioRow("key_holding","May a support worker / service hold a key for access?",[
            {v:"yes", t:"Yes"}, {v:"no", t:"No"}, {v:"unsure", t:"Not sure"}
          ]));

          return sec;
        },
        afterMount(sec){
          bindChipsRadio(sec);
          bindChipsMulti(sec);
        },
        validate(){ return true; }
      },

      // 6. Medical needs
      {
        title: "Medical summary",
        hint: "From the Participant Medical Summary & Clinical Care Plan: conditions, allergies, alerts.",
        img: "medical",
        render(sec){
          const grid = document.createElement('div'); grid.className="grid g-two";
          grid.appendChild(areaRow("medical_conditions","Diagnoses / significant conditions",""));
          grid.appendChild(areaRow("allergies","Allergies / anaphylaxis",""));
          grid.appendChild(areaRow("mobility","Mobility & transfers",""));
          grid.appendChild(areaRow("communication","Communication / cognition notes",""));
          grid.appendChild(areaRow("seizure_plan","Seizure / clinical plans (if any)",""));
          grid.appendChild(areaRow("equipment","Equipment (hoist, wheelchair, etc.)",""));
          sec.appendChild(grid);
          sec.appendChild(areaRow("clinical_alerts","Critical clinical alerts (if any)",""));
          return sec;
        },
        validate(){ return true; }
      },

      // 7. Medications
      {
        title: "Medication management",
        hint: "If medication support is required, add details. Otherwise select ‚ÄòNo support needed‚Äô.",
        img: "meds",
        render(sec){
          sec.appendChild(radioRow("med_support","Medication support needed?",[
            {v:"yes", t:"Yes"}, {v:"no", t:"No"}, {v:"unsure", t:"Not sure"}
          ]));
          const meds = areaRow("med_list","Medication list / Webster pack details","Name, dose, time; attach photo below if helpful");
          meds.id = "medsWrap";
          if ((get("med_support")||"")!=="yes") meds.style.display="none";
          sec.appendChild(meds);
          sec.appendChild(fileRow("med_files","Upload med chart / Webster pack photo (optional)","image/*,application/pdf", true));
          return sec;
        },
        afterMount(sec){
          bindChipsRadio(sec);
          sec.querySelectorAll('[data-role="radio"][data-name="med_support"]').forEach(btn=>{
            btn.addEventListener('click', ()=>{
              const v = btn.dataset.value;
              const wrap = document.getElementById("medsWrap");
              wrap.style.display = (v === "yes") ? "block" : "none";
            });
          });
        },
        validate(){ return true; }
      },

      // 8. Preferences
      {
        title: "Preferences",
        hint: "Worker preferences & logistics help us match the right team.",
        img: "profile",
        render(sec){
          sec.appendChild(chipMulti("worker_prefs","Worker preferences",[
            {v:"gender_pref", t:"Gender preference"},
            {v:"driver_required", t:"Driver required"},
            {v:"pet_comfortable", t:"Comfortable with pets"},
            {v:"none", t:"No preferences"},
          ], ["none"]));
          sec.appendChild(textRow("access_notes","Access details (keysafe code, someone home, etc.)",""));
          sec.appendChild(areaRow("participant_goals","Participant goals (short/long term)",""));
          return sec;
        },
        afterMount(sec){ bindChipsMulti(sec); },
        validate(){ return true; }
      },

      // 9. Files / uploads
      {
        title: "Upload helpful docs",
        hint: "Optional: NDIS plan, BSP, clinical summaries, risk plans, ID (if needed for safer care).",
        img: "files",
        render(sec){
          sec.appendChild(fileRow("upload_plan","NDIS Plan (PDF)",".pdf", false));
          sec.appendChild(fileRow("upload_bsp","Behaviour Support Plan (PDF)",".pdf", false));
          sec.appendChild(fileRow("upload_clinical","Clinical Care Plan (PDF)",".pdf", false));
          sec.appendChild(fileRow("upload_id","ID / other docs (PDF/JPG/PNG)",".pdf,.jpg,.jpeg,.png", true));
          sec.appendChild(areaRow("upload_notes","Notes about uploads (optional)",""));
          return sec;
        },
        validate(){ return true; }
      },

      // 10. Booking details
      {
        title: "Booking details",
        hint: "Preferred start timing and hours per week help us schedule.",
        img: "plan",
        render(sec){
          sec.appendChild(radioRow("start_timing","When would you like to start?",[
            {v:"urgent", t:"Urgent (24‚Äì72h)"},
            {v:"soon", t:"Soon (1‚Äì2 weeks)"},
            {v:"exploring", t:"Exploring options"},
            {v:"unsure", t:"Not sure"}
          ]));
          sec.appendChild(radioRow("hours_per_week","Approx. hours per week",[
            {v:"2_4", t:"2‚Äì4 hrs"},
            {v:"5_10", t:"5‚Äì10 hrs"},
            {v:"10_plus", t:"10+ hrs"},
            {v:"unsure", t:"Not sure"}
          ]));
          return sec;
        },
        afterMount(sec){ bindChipsRadio(sec); },
        validate(){ return true; }
      },

      // 11. Review & submit
      {
        title: "Review & submit",
        hint: "Double-check, then submit securely. We‚Äôll contact you soon.",
        img: "review",
        render(sec){
          const rev = document.createElement('div');
          rev.className = "review";
          rev.id = "reviewBox";
          rev.textContent = "Generating summary‚Ä¶";
          sec.appendChild(rev);

          const contact = document.createElement('div');
          contact.className = "grid g-two";
          contact.appendChild(textRow("contact_name","Your name (optional)",""));
          contact.appendChild(textRow("contact_pref_time","Best time to contact (optional)","E.g., weekdays 1‚Äì4pm"));
          sec.appendChild(contact);

          // Submit button visibility handled outside
          return sec;
        },
        afterMount(){
          // Fill review text
          const lines = [];
          const p = (k)=>get(k) || "‚Äî";
          const arr = (k)=> (get(k)||[]).join(", ") || "‚Äî";

          lines.push("Participant:");
          lines.push(`‚Ä¢ Name: ${p("full_name")} (DOB: ${p("dob")})`);
          lines.push(`‚Ä¢ Email: ${p("email")} | Phone: ${p("phone")}`);
          lines.push(`‚Ä¢ NDIS #: ${p("ndis_number")} | Plan mgmt: ${p("plan_mgmt")}`);
          lines.push(`‚Ä¢ Address: ${p("address")}`);
          lines.push("");
          lines.push("Location & visits:");
          lines.push(`‚Ä¢ Suburb/Postcode: ${p("service_suburb")} ${p("service_postcode")}`);
          lines.push(`‚Ä¢ Windows: ${arr("visit_windows")}`);
          lines.push("");
          lines.push("Services:");
          lines.push(`‚Ä¢ Requested: ${arr("services_requested")}`);
          lines.push(`‚Ä¢ Notes: ${p("service_notes")}`);
          lines.push("");
          lines.push("Consents:");
          lines.push(`‚Ä¢ Info share: ${p("consent_info_share")} | Emergency: ${p("consent_emergency")}`);
          lines.push(`‚Ä¢ Media: ${p("consent_media")} | Plan share: ${p("consent_plan_share")}`);
          lines.push(`‚Ä¢ Money/Property: ${p("consent_money_property")}`);
          lines.push(`‚Ä¢ Interpreter: ${p("need_interpreter")} ${p("interpreter_language")}`);
          lines.push("");
          lines.push("Risks & behaviours:");
          lines.push(`‚Ä¢ Behaviours: ${arr("risks_behaviours")}`);
          lines.push(`‚Ä¢ BSP in place: ${p("bsp_in_place")}`);
          lines.push(`‚Ä¢ Triggers/strategies: ${p("behaviour_triggers")}`);
          lines.push(`‚Ä¢ Home risks: ${arr("home_risks")} | Key holding: ${p("key_holding")}`);
          lines.push("");
          lines.push("Medical:");
          lines.push(`‚Ä¢ Conditions: ${p("medical_conditions")}`);
          lines.push(`‚Ä¢ Allergies: ${p("allergies")} | Alerts: ${p("clinical_alerts")}`);
          lines.push(`‚Ä¢ Mobility: ${p("mobility")} | Communication: ${p("communication")}`);
          lines.push(`‚Ä¢ Seizure plan: ${p("seizure_plan")} | Equipment: ${p("equipment")}`);
          lines.push("");
          lines.push("Preferences:");
          lines.push(`‚Ä¢ Worker prefs: ${arr("worker_prefs")}`);
          lines.push(`‚Ä¢ Access: ${p("access_notes")} | Goals: ${p("participant_goals")}`);
          lines.push("");
          lines.push("Booking:");
          lines.push(`‚Ä¢ Start: ${p("start_timing")} | Hours/week: ${p("hours_per_week")}`);
          lines.push("");
          lines.push("Intro notes:");
          lines.push(`‚Ä¢ ${p("intro_notes")}`);

          document.getElementById("reviewBox").textContent = lines.join("\n");
        },
        validate(){
          requireIf(get("phone") || get("email"), "Please add at least a phone or an email earlier.");
          return true;
        }
      }
    ];

    /* ====== Render & Navigation ====== */
    function setPortraitFor(sec){
      const key = sec?.dataset?.imgKey || "default";
      portrait.src = IMG[key] || IMG.default;
    }

    function renderStep(i){
      stepError.textContent = "";
      root.innerHTML = "";
      const st = steps[i];
      const sec = section(st.title, st.hint, st.img);
      root.appendChild(sec);
      const rendered = st.render(sec);
      if (st.afterMount) st.afterMount(sec);
      stepTitle.textContent = st.title || "Onboarding";
      setPortraitFor(sec);

      // Bind radios/multis in this section
      bindChipsRadio(sec);
      bindChipsMulti(sec);

      // Prefill simple inputs
      root.querySelectorAll('input[type="text"],input[type="email"],input[type="tel"],input[type="date"],input[type="number"],textarea,select').forEach(el=>{
        if (el.type !== "file" && get(el.name) != null) el.value = get(el.name);
        el.addEventListener('input', ()=> set(el.name, el.value));
      });

      // Files not persisted to localStorage for privacy.

      // Progress
      const total = steps.length;
      bar.style.width = Math.round((i)/(total-1)*100) + "%";
      progressBadge.textContent = "Step " + (i+1) + "/" + total;

      // Buttons
      btnPrev.style.visibility = i===0 ? "hidden" : "visible";
      btnNext.style.display = (i === total-1) ? "none" : "inline-block";
      btnSubmit.style.display = (i === total-1) ? "inline-block" : "none";
      S.i = i; save();
    }

    function next(){
      try{
        if (steps[S.i].validate) steps[S.i].validate();
      }catch(e){
        stepError.textContent = e.message || "Please complete required fields.";
        return;
      }
      if (S.i < steps.length-1) renderStep(S.i+1);
    }
    function prev(){ if (S.i>0) renderStep(S.i-1); }

    btnNext.addEventListener("click", next);
    btnPrev.addEventListener("click", prev);

    btnSave.addEventListener("click", ()=>{ save(); stepHint.textContent = "Saved locally."; setTimeout(()=> stepHint.textContent="", 1500); });
    btnLoad.addEventListener("click", ()=>{
      try{
        const prev = JSON.parse(localStorage.getItem(SKEY) || "null");
        if (prev){ S = prev; renderStep(S.i||0); stepHint.textContent="Loaded saved progress."; setTimeout(()=> stepHint.textContent="", 1500); }
        else { stepHint.textContent="No saved progress found."; setTimeout(()=> stepHint.textContent="", 1500); }
      }catch{}
    });

    /* ====== Submit (FormData + files) ====== */
    async function submit(){
      try{
        if (steps[S.i].validate) steps[S.i].validate();
      }catch(e){
        stepError.textContent = e.message || "Please complete required fields.";
        return;
      }

      // Build FormData for Formspree
      const fd = new FormData();
      fd.append("_subject", "HD HeeD AILR ‚Äî New Onboarding");
      fd.append("source", "ailr.html v12");
      fd.append("timestamp", new Date().toISOString());

      // Append JSON payload
      const payload = JSON.stringify(S.data);
      fd.append("payload", payload);

      // Append files if present
      ["med_files","upload_plan","upload_bsp","upload_clinical","upload_id"].forEach(id=>{
        const input = document.getElementById(id);
        if (input && input.files && input.files.length){
          Array.from(input.files).forEach((file, idx)=>{
            fd.append(id + "["+idx+"]", file, file.name);
          });
        }
      });

      // POST
      let ok = false;
      try{
        const r = await fetch(FS_ENDPOINT, { method:"POST", body: fd, headers: { "Accept":"application/json" }});
        ok = r.ok;
      }catch(e){ ok = false; }

      if (ok){
        alert("Thanks ‚Äî we‚Äôve received your onboarding. We‚Äôll be in touch shortly.");
        // Clear local storage if you want:
        // localStorage.removeItem(SKEY);
      }else{
        // Mailto fallback (no files)
        const b = encodeURIComponent(
          "HD HeeD AILR ‚Äî Onboarding:\n\n" + payload +
          "\n\n(Attachments were not sent. If needed, please reply with files.)"
        );
        window.location.href = "mailto:"+FALLBACK_MAIL+"?subject="+encodeURIComponent("HD HeeD AILR ‚Äî New Onboarding")+"&body="+b;
      }
    }
    btnSubmit.addEventListener("click", submit);

    // Start
    renderStep(S.i || 0);
  })();
  </script>
</body>
</html>
