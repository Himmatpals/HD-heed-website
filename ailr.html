<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AILR — Advanced Intake & Long-form Registration | HD HeeD</title>
<link rel="icon" href="images/favicon.ico" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />
<meta name="theme-color" content="#0b0f1a" />

<style>
  :root{
    --al-ink:#0c1226; --al-bg:#0b0f1a; --al-panel:#10172a; --al-line:#243153;
    --al-text:#e8edff; --al-accent:#ffc107; --al-ok:#22c55e; --al-warn:#f59e0b; --al-danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:linear-gradient(180deg,#0b0f1a,#0b0f1a 240px,#0d1428); color:var(--al-text);
  }
  a{color:#9ec1ff; text-decoration:none}
  img{max-width:100%; height:auto; display:block}

  /* Page shell */
  header{
    position:sticky; top:0; z-index:50; background:#0b1226;
    border-bottom:1px solid var(--al-line);
  }
  header .bar{
    display:flex; align-items:center; gap:12px; padding:10px 16px;
    max-width:1120px; margin:0 auto;
  }
  .brand{display:flex; align-items:center; gap:10px}
  .brand img{width:40px;height:40px;border-radius:10px;object-fit:cover}
  .brand .name{font-weight:900}
  .brand .tag{font-size:12px;color:#b6c8ff}

  /* Hero */
  .hero{ max-width:1120px; margin:14px auto 0; padding:16px; }
  .hero .card{
    background:linear-gradient(180deg,#10172a,#0c1326);
    border:1px solid var(--al-line); border-radius:18px; padding:18px;
    display:grid; gap:10px; box-shadow:0 18px 60px rgba(0,0,0,.45);
  }
  .hero h1{margin:0; font-size:clamp(22px,4.4vw,34px); font-weight:900}
  .hero p{margin:0; color:#cfe0ff; opacity:.95}
  .hero .meta{display:flex; gap:8px; flex-wrap:wrap}
  .pill{border:1px solid var(--al-line); background:#0f1937; border-radius:999px; padding:6px 10px; color:#cfe0ff; font-size:12px}
  .notice{font-size:13px; color:#99adff}

  /* Wizard layout */
  .wrap{
    max-width:1120px; margin:12px auto 24px; padding:0 16px; display:grid; gap:14px;
    grid-template-columns: 1fr;
  }
  @media (min-width:980px){
    .wrap{grid-template-columns: 260px 1fr;}
  }

  /* Portrait column */
  .portrait{ position:sticky; top:88px; align-self:start; display:none; }
  @media (min-width:980px){ .portrait{ display:block } }
  .portrait .box{
    border:1px solid var(--al-line); border-radius:16px; overflow:hidden;
    background:linear-gradient(180deg,#0f1630,#0b1026); padding:12px;
    box-shadow:0 18px 50px rgba(0,0,0,.45);
  }
  .portrait .box img{border-radius:12px; filter: drop-shadow(0 12px 28px rgba(0,0,0,.35));}
  .legend{margin-top:10px; display:grid; gap:6px; font-size:13px; color:#b6c8ff}
  .legend b{color:#ffe28f}

  /* Step card */
  .stage{
    border:1px solid var(--al-line); border-radius:18px; padding:16px;
    background:linear-gradient(180deg,#10172a,#0c1326);
    box-shadow:0 18px 60px rgba(0,0,0,.45);
  }
  .head{ display:flex; align-items:center; gap:10px; margin-bottom:6px; }
  .head .step{font-weight:900}
  .meter{height:8px; background:#101838; border:1px solid var(--al-line);
    border-radius:999px; overflow:hidden; flex:1}
  .meter>div{height:100%; width:0%; background:linear-gradient(90deg,#ffd95c,#ffe78f)}

  .q{font-size:clamp(18px,3.8vw,22px); font-weight:900; line-height:1.35; margin:10px 0}
  .sub{font-size:14px; color:#cfe0ff; margin:0 0 6px}

  .opts{display:grid; gap:10px}

  /* Chips (buttons) */
  .al-chip{
    border:1px solid var(--al-line); background:linear-gradient(180deg,#121a3a,#0f172f);
    color:#e7ebff; border-radius:12px; padding:14px; text-align:left; cursor:pointer; font-size:1.04rem;
  }
  .al-chip:hover{box-shadow:0 12px 34px rgba(0,0,0,.28)}
  .al-chip[aria-pressed="true"]{box-shadow:0 0 0 3px rgba(255,217,92,.25); border-color:#ffd95c}

  /* Inline field boxes */
  .inlinebox{
    border:1px solid var(--al-line); background:#0e162e; border-radius:12px; padding:12px; display:grid; gap:10px
  }
  .inlinebox input,.inlinebox select,.inlinebox textarea{
    width:100%; padding:12px; border-radius:10px; border:1px solid #2a3b68; background:#0f1b3b; color:#e7ebff; font-size:16px
  }

  .row{display:grid; gap:10px}
  @media (min-width:680px){ .row.two{grid-template-columns:repeat(2,minmax(0,1fr))} .row.three{grid-template-columns:repeat(3,minmax(0,1fr))} }

  /* Tick list alignment */
  .ticklist{display:grid; gap:8px}
  .tickrow{display:flex; align-items:center; gap:10px}
  .tickrow input[type="checkbox"]{ width:18px; height:18px; flex:0 0 18px }
  @media (max-width:520px){ .tickrow{align-items:flex-start} }

  /* Handbook viewer */
  .handbook{display:grid; gap:8px}
  .handbook object{ width:100%; height:420px; border:1px solid var(--al-line); border-radius:12px; background:#0d1428 }

  .foot{
    position:sticky; bottom:0; left:0; right:0;
    display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    margin-top:12px; padding-top:10px; border-top:1px dashed var(--al-line); background:transparent;
  }
  .btn{border:0; border-radius:12px; padding:12px 16px; font-weight:900; cursor:pointer; min-height:44px}
  .btn.primary{background:var(--al-accent); color:#2a2100; box-shadow:0 12px 34px rgba(0,0,0,.35)}
  .btn.ghost{background:#121a3a; color:#e7ebff; border:1px solid var(--al-line)}
  .btn.warn{background:#173155; color:#ffd95c; border:1px solid #334c85}
  .hint{font-size:12px; color:#9fb4ff}
  .ok{color:var(--al-ok)} .warntext{color:var(--al-warn)} .danger{color:var(--al-danger)}
</style>
</head>
<body>

<header>
  <div class="bar">
    <div class="brand">
      <img src="images/logo.png" alt="HD HeeD logo">
      <div>
        <div class="name">HD HeeD</div>
        <div class="tag">AILR — Advanced Intake & Long-form Registration</div>
      </div>
    </div>
    <div style="margin-left:auto" class="hint">Mobile-first • Autosaves • You can pause and return anytime</div>
  </div>
</header>

<section class="hero">
  <div class="card">
    <h1>Let’s get you set up — thoroughly and simply</h1>
    <p>Answer clear, step-by-step questions. Pick a button, or type your own answer. Choose <em>Not sure</em> or <em>Prefer not to say</em> whenever you like — you can finish later. We’ll only need an <strong>email or phone</strong> at the end to submit.</p>
    <div class="meta">
      <span class="pill">NDIS participant onboarding</span>
      <span class="pill">Consents & risks included</span>
      <span class="pill">Upload documents (optional)</span>
    </div>
    <p class="notice">Tip: On mobile, you’ll see one focused screen at a time with large tap targets.</p>
  </div>
</section>

<div class="wrap" id="app">
  <!-- Portrait column -->
  <aside class="portrait">
    <div class="box">
      <img id="portrait" src="images/ella/ella-default.png" alt="Assistant portrait">
      <div class="legend">
        <div><b>Hi, I’m Ella.</b> I’ll guide you through a complete onboarding.</div>
        <div>Tap a card to answer, or type your own.</div>
      </div>
    </div>
  </aside>

  <!-- Stage / Wizard -->
  <main class="stage" role="region" aria-live="polite">
    <div class="head">
      <span id="stepTxt" class="step">Step 1/20</span>
      <div class="meter" aria-label="Progress"><div id="bar"></div></div>
    </div>

    <div id="q" class="q">…</div>
    <p id="sub" class="sub"></p>

    <div id="opts" class="opts"><!-- dynamic --></div>

    <div class="foot">
      <div class="hint" id="saveHint">Draft saved</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn ghost" id="backBtn" type="button">← Back</button>
        <button class="btn warn" id="saveExitBtn" type="button">Save & Exit</button>
        <button class="btn primary" id="nextBtn" type="button">Next →</button>
      </div>
    </div>
  </main>
</div>

<script>
(function(){
  /* ====== Config ====== */
  const FS_ENDPOINT = "https://formspree.io/f/xvgrkkjn"; // your Formspree endpoint
  const STORAGE_KEY = "hdheed_ailr_v12"; // bumped version after upgrades

  // Portrait per step (reusing your ELLA set)
  const AILR_IMAGES = {
    intro: "images/ella/ella-default.png",
    caller: "images/ella/ella-caller.png",
    participant: "images/ella/ella-service.png",
    contacts: "images/ella/ella-contact-window.png",
    comms: "images/ella/ella-interpreter.png",
    living: "images/ella/ella-location.png",
    risks: "images/ella/ella-risk-beh.png",
    clinical: "images/ella/ella-hours.png",
    medications: "images/ella/ella-urgency.png",
    supports: "images/ella/ella-rostering.png",
    schedule: "images/ella/ella-rostering.png",
    consents: "images/ella/ella-consent.png",
    money: "images/ella/ella-management.png",
    keys: "images/ella/ella-rostering.png",
    advocacy: "images/ella/ella-preferences.png",
    home: "images/ella/ella-location.png",
    bsp: "images/ella/ella-risk-beh.png",
    privacy: "images/ella/ella-summary.png",
    uploads: "images/ella/ella-dates.png",
    review: "images/ella/ella-summary.png",
    submit: "images/ella/ella-summary.png"
  };

  /* ====== State ====== */
  let S = {
    i: 0,
    caller: { role:null, name:null, relationship:null, consent:"Not sure" },

    participant: {
      legal_name:null, preferred_name:null, pronouns:null, dob:null, ndis_number:null,
      address:{ line1:null, line2:null, suburb:null, postcode:null, state:null },
      plan_mgmt:null, plan_manager:{ org:null, contact:null, email:null, phone:null },
      plan_dates:{ start:null, end:null }
    },

    contacts:{
      email:null, phone:null,
      emergency:{ name:null, relationship:null, phone:null },
      support_coordinator:{ name:null, org:null, email:null, phone:null },
      gp:{ name:null, practice:null, email:null, phone:null }
    },

    comms:{
      primary_language:null, interpreter:null, interpreter_language:null,
      cultural_considerations:null,
      preferences:{ worker_gender:null, worker_gender_other:null, transport_required:null }
    },

    living:{
      residence_type:null, lives_with:null, entry_notes:null, keysafe:null, smoking_on_premises:null, hazards:null
    },

    clinical:{
      primary_diagnoses:null, other_diagnoses:null, allergies:null,
      mobility:null, equipment:null, continence:null, cognition:null, pressure_injury_risk:null,
      seizures:{ has:null, plan:null, frequency:null }, falls_risk:null, diet_notes:null
    },

    medications:{
      has_meds:null, method:"Not sure", storage:null, webster_pack:null, self_admin:null, staff_admin:null, notes:null
    },

    risks:{
      behavioural:{ present:null, notes:null },
      clinical:{ wounds:false, diabetes:false, tracheostomy:false, tube_feeding:false, mental_health:false, other:null },
      environmental:{ animals:false, hoarding:false, weapons:false, other:null },
      home_checklist:{ trip_hazards:false, smoke_alarms:false, lighting:false, bathroom_safety:false, notes:null },
      overall_rating:"Not sure"
    },

    supports:{ types:[], goals:null, outcomes:null },
    schedule:{ windows:[], days:[], start_preference:null, hours_per_week:null, urgency:"Not sure" },

    money_property:{ consent:null, details:null },
    keys:{ allow_hold_key:null, location:null, code:null },
    advocacy:{ has_advocate:null, name:null, organisation:null, phone:null, email:null },

    bsp:{ has_bsp:null, restrictive_practices:null, provider:null, notes:null },

    consents:{
      info_sharing:false, emergency_treatment:false, media:false, plan_sharing:false,
      privacy_ack:false, handbook_ack:false, incident_ack:false, complaints_info_ack:false
    },

    uploads:{ files:[] },
    submitter:{ name:null, email:null, phone:null },

    notes:[]
  };

  // Restore draft if present
  try{
    const prev = JSON.parse(localStorage.getItem(STORAGE_KEY)||"null");
    if (prev && typeof prev === "object") Object.assign(S, prev);
  }catch{}

  const save = ()=>{ try{
    const clone = structuredClone(S);
    clone.uploads = { files: [] }; // don't persist actual files
    localStorage.setItem(STORAGE_KEY, JSON.stringify(clone));
    setSaveHint("Draft saved");
  }catch{} };

  /* ====== DOM ====== */
  const qEl = document.getElementById("q");
  const subEl = document.getElementById("sub");
  const optsEl = document.getElementById("opts");
  const stepTxt = document.getElementById("stepTxt");
  const barEl = document.getElementById("bar");
  const backBtn = document.getElementById("backBtn");
  const nextBtn = document.getElementById("nextBtn");
  const saveExitBtn = document.getElementById("saveExitBtn");
  const portrait = document.getElementById("portrait");
  const saveHint = document.getElementById("saveHint");
  function setSaveHint(t){ saveHint.textContent = t; }
  function setPortrait(key){ portrait.src = AILR_IMAGES[key] || AILR_IMAGES.intro; portrait.alt = "Assistant — " + (key||""); }

  /* ========= UI helpers (with exclusivity baked-in) ========= */

  // Radio-style chips (mutually exclusive, prevents contradictions)
  function chipRadio(label, obj, key, choices){
    const box = document.createElement('div'); box.className='inlinebox';
    if (label){ const lab=document.createElement('label'); lab.style.fontWeight='800'; lab.textContent=label; box.append(lab); }
    const row = document.createElement('div'); row.style='display:flex; gap:8px; flex-wrap:wrap';
    const name = 'grp_' + Math.random().toString(36).slice(2,8);
    choices.forEach(([text, value])=>{
      const b = document.createElement('button');
      b.type='button'; b.className='al-chip'; b.textContent=text;
      if (obj[key] === value) b.setAttribute('aria-pressed','true');
      b.addEventListener('click', ()=>{
        // clear group
        row.querySelectorAll('.al-chip').forEach(x=> x.removeAttribute('aria-pressed'));
        // set this
        obj[key] = value;
        b.setAttribute('aria-pressed','true');
        save();
      });
      row.append(b);
    });
    box.append(row);
    return box;
  }

  // Chip row (non-exclusive list of “quick pick” answers)
  function chips(items){
    const wrap = document.createElement('div'); wrap.className="opts";
    items.forEach(([txt,fn])=>{
      const b = document.createElement('button');
      b.className="al-chip"; b.type="button"; b.textContent = txt;
      b.addEventListener('click', ()=>{
        // Clear siblings’ pressed state (treat as radio within this row)
        wrap.querySelectorAll('.al-chip').forEach(x=> x.removeAttribute('aria-pressed'));
        fn(); save(); b.setAttribute("aria-pressed","true");
      });
      wrap.append(b);
    });
    // Default helpers
    const ns = document.createElement('div'); ns.style = "display:flex; gap:8px; flex-wrap:wrap";
    const b1 = button("Not sure","ghost", ()=>{}); const b2 = button("Prefer not to say","ghost", ()=>{});
    ns.append(b1,b2); wrap.append(ns);
    return wrap;
  }

  // Inline radio chips (label + exclusive chips)
  function chipsInline(label, obj, key, items){
    return chipRadio(label, obj, key, items);
  }

  // Text input
  function input(label, obj, key, type="text"){
    const box = document.createElement('div'); box.className="inlinebox";
    box.innerHTML = `<label style="font-weight:800">${label}</label>`;
    const i = document.createElement('input');
    i.type = type; i.value = obj[key]??""; i.placeholder = "";
    i.addEventListener('input', ()=>{ obj[key] = i.value || null; save(); });
    box.append(i); return box;
  }
  // Select
  function select(label, obj, key, options){
    const box = document.createElement('div'); box.className = "inlinebox";
    box.innerHTML = `<label style="font-weight:800">${label}</label>`;
    const s = document.createElement('select');
    s.innerHTML = `<option value="">Select…</option>` + options.map(o=> `<option value="${o}">${o}</option>`).join("");
    if (obj[key]) s.value = obj[key];
    s.addEventListener('change', ()=>{ obj[key] = s.value || null; save(); });
    box.append(s); return box;
  }
  // Type + Save box
  function typeBox(label, placeholder, onSave){
    const box = document.createElement('div'); box.className="inlinebox";
    box.innerHTML = `<label style="font-weight:800">${label}</label>`;
    const i = document.createElement('input'); i.placeholder = placeholder||"Type here";
    const btn = document.createElement('button'); btn.type="button"; btn.className="btn ghost"; btn.textContent = "Save";
    btn.addEventListener('click', ()=>{ const v=(i.value||"").trim(); if (v){ onSave(v); i.value=""; save(); setSaveHint("Saved"); } else { alert("Please type something or use the cards."); } });
    box.append(i, btn); return box;
  }
  // Checkbox list (aligned)
  function checks(label, targetObj, map, arrayKey){
    const box = document.createElement('div'); box.className="inlinebox";
    box.innerHTML = `<label style="font-weight:800">${label}</label>`;
    const list = document.createElement('div'); list.className="ticklist";

    const setRow = (row, pressed)=>{ /* visual space for future enhancements */ };

    if (arrayKey){
      if (!Array.isArray(targetObj[arrayKey])) targetObj[arrayKey] = [];
      Object.entries(map).forEach(([k,txt])=>{
        const id = `ck_${k}_${Math.random().toString(36).slice(2,7)}`;
        const row = document.createElement('label'); row.className="tickrow"; row.setAttribute("for", id);
        const c = document.createElement('input'); c.type="checkbox"; c.id=id; c.checked = targetObj[arrayKey].includes(k);
        c.addEventListener('change', ()=>{
          const arr = targetObj[arrayKey];
          if (c.checked){ if (!arr.includes(k)) arr.push(k); }
          else { targetObj[arrayKey] = arr.filter(x=>x!==k); }
          setRow(row, c.checked); save();
        });
        row.append(c, document.createTextNode(txt)); list.append(row);
      });
    } else {
      Object.entries(map).forEach(([k,txt])=>{
        const id = `ck_${k}_${Math.random().toString(36).slice(2,7)}`;
        const row = document.createElement('label'); row.className="tickrow"; row.setAttribute("for", id);
        const c = document.createElement('input'); c.type="checkbox"; c.id=id; c.checked = !!targetObj[k];
        c.addEventListener('change', ()=>{ targetObj[k] = c.checked; setRow(row, c.checked); save(); });
        row.append(c, document.createTextNode(txt)); list.append(row);
      });
    }
    box.append(list); return box;
  }

  function button(txt,variant="ghost",onClick){
    const b = document.createElement('button');
    b.className = "btn " + variant; b.type="button"; b.textContent = txt;
    b.addEventListener('click',onClick);
    return b;
  }
  function row(cols, children){
    const r = document.createElement('div'); r.className = "row " + (cols||"");
    children.forEach(ch=> r.append(ch));
    return r;
  }
  function divider(txt){ const d=document.createElement('div'); d.className="hint"; d.style.margin="8px 0 4px"; d.textContent=txt; return d; }

  /* ========= Steps ========= */
  const Steps = [
    {
      key:"intro",
      title:"Welcome — let’s begin",
      sub:"Pick a card or type. You can choose Not sure or Prefer not to say anywhere.",
      build(m){
        m.append(chips([
          ["I’m the participant", ()=> S.caller.role="Participant"],
          ["I’m a family member / carer", ()=> S.caller.role="Carer"],
          ["I’m a Support Coordinator", ()=> S.caller.role="Support Coordinator"],
          ["I’m a Health Professional", ()=> S.caller.role="Health Professional"],
          ["Prefer not to say", ()=> S.caller.role="Prefer not to say"]
        ]));
        m.append(typeBox("Want to type who you are?", "e.g., Participant / Mum / Support Coordinator Jane", (v)=>{ S.caller.role = v; S.notes.push(`[caller.role] ${v}`); }));
      }
    },

    {
      key:"caller",
      title:"Your details (person completing this form)",
      sub:"These help us contact you about this onboarding.",
      build(m){
        m.append(row("two",[ input("Your name", S.caller, "name"), input("Relationship to participant (if any)", S.caller, "relationship") ]));
        m.append(chipRadio("Verbal consent to collect details?", S.caller, "consent", [
          ["Yes", "Yes"], ["Not yet", "Not yet"], ["Not sure", "Not sure"], ["Prefer not to say", "Prefer not to say"]
        ]));
      }
    },

    {
      key:"participant",
      title:"Participant — legal details",
      sub:"Legal name is required for service setup later; preferred name helps our team address the participant correctly.",
      build(m){
        m.append(row("two",[ input("Legal name", S.participant, "legal_name"), input("Preferred name (optional)", S.participant, "preferred_name") ]));
        m.append(row("three",[ input("Pronouns (optional)", S.participant, "pronouns"), input("Date of birth", S.participant, "dob","date"), input("NDIS number (optional)", S.participant, "ndis_number") ]));
        m.append(divider("Address"));
        m.append(row("two",[ input("Address line 1", S.participant.address, "line1"), input("Address line 2 (optional)", S.participant.address, "line2") ]));
        m.append(row("three",[ input("Suburb", S.participant.address, "suburb"), input("Postcode", S.participant.address, "postcode"), input("State", S.participant.address, "state") ]));
        m.append(divider("Plan management"));
        m.append(chipRadio(null, S.participant, "plan_mgmt", [
          ["NDIA-managed","NDIA-managed"],["Plan-managed","Plan-managed"],["Self-managed","Self-managed"],["Not sure","Not sure"],["Prefer not to say","Prefer not to say"]
        ]));
        m.append(typeBox("Want to type plan manager details?", "Org & contact (if applicable)", (v)=>{ S.participant.plan_manager.org = v; }));
        m.append(row("three",[ input("Plan manager contact name", S.participant.plan_manager, "contact"), input("Plan manager email", S.participant.plan_manager, "email","email"), input("Plan manager phone", S.participant.plan_manager, "phone","tel") ]));
        m.append(row("two",[ input("Plan start date", S.participant.plan_dates, "start","date"), input("Plan end date", S.participant.plan_dates, "end","date") ]));
      }
    },

    {
      key:"contacts",
      title:"Contacts — how we reach you",
      sub:"Provide at least one method — email or phone is required at submission.",
      build(m){
        m.append(row("two",[ input("Participant email", S.contacts, "email","email"), input("Participant phone", S.contacts, "phone","tel") ]));
        m.append(divider("Emergency contact"));
        m.append(row("three",[ input("Name", S.contacts.emergency, "name"), input("Relationship", S.contacts.emergency, "relationship"), input("Phone", S.contacts.emergency, "phone","tel") ]));
        m.append(divider("Support Coordinator (if any)"));
        m.append(row("two",[ input("Name", S.contacts.support_coordinator, "name"), input("Organisation", S.contacts.support_coordinator, "org") ]));
        m.append(row("two",[ input("Email", S.contacts.support_coordinator, "email","email"), input("Phone", S.contacts.support_coordinator, "phone","tel") ]));
        m.append(divider("GP / Primary care"));
        m.append(row("three",[ input("GP name", S.contacts.gp, "name"), input("Practice", S.contacts.gp, "practice"), input("Phone", S.contacts.gp, "phone","tel") ]));
        m.append(input("GP email (optional)", S.contacts.gp, "email","email"));
      }
    },

    {
      key:"comms",
      title:"Communication & preferences",
      sub:"Tell us what helps the participant feel comfortable and understood.",
      build(m){
        m.append(row("two",[ input("Primary language", S.comms, "primary_language"), input("Interpreter language (if needed)", S.comms, "interpreter_language") ]));
        m.append(chipRadio("Interpreter needed?", S.comms, "interpreter", [
          ["Yes", true], ["No", false], ["Not sure","Not sure"], ["Prefer not to say","Prefer not to say"]
        ]));
        m.append(typeBox("Cultural / religious considerations (optional)", "Anything to respect (optional)", (v)=> S.comms.cultural_considerations = v));
        m.append(row("two",[ select("Worker gender preference", S.comms.preferences, "worker_gender", ["No preference","Female","Male","Other / type below"]), input("Other preference (type if selected)", S.comms.preferences, "worker_gender_other") ]));
        m.append(chipRadio("Transport required?", S.comms.preferences, "transport_required", [
          ["Yes","Yes"], ["No","No"], ["Not sure","Not sure"]
        ]));
      }
    },

    {
      key:"living",
      title:"Living situation & access",
      sub:"This helps us plan safe, respectful visits.",
      build(m){
        m.append(select("Residence type", S.living, "residence_type", ["Private home","Unit/Apartment","Group home","Supported accommodation","Other","Prefer not to say"]));
        m.append(input("Lives with (names or relationships)", S.living, "lives_with"));
        m.append(input("Entry notes (e.g., gate, pets, parking)", S.living, "entry_notes"));
        m.append(chipRadio("Keysafe available?", S.living, "keysafe", [
          ["Yes","Yes"], ["No","No"], ["Not sure","Not sure"]
        ]));
        m.append(chipRadio("Smoking on premises?", S.living, "smoking_on_premises", [
          ["Yes","Yes"], ["No","No"], ["Prefer not to say","Prefer not to say"]
        ]));
        m.append(typeBox("Any hazards we should know about?", "e.g., steep stairs, loose rugs, reactive pets", (v)=> S.living.hazards = v));
      }
    },

    {
      key:"clinical",
      title:"Health & clinical summary",
      sub:"Share as much as you’re comfortable with now; we can confirm details later.",
      build(m){
        m.append(typeBox("Primary diagnoses", "e.g., Autism Spectrum Disorder, MS", (v)=> S.clinical.primary_diagnoses = v));
        m.append(typeBox("Other diagnoses (optional)", "Type here", (v)=> S.clinical.other_diagnoses = v));
        m.append(typeBox("Allergies / reactions", "Food, medication, environmental", (v)=> S.clinical.allergies = v));
        m.append(row("two",[ select("Mobility", S.clinical, "mobility", ["Independent","With aid","Requires transfer","Bed-bound","Prefer not to say"]), input("Equipment / aids (optional)", S.clinical, "equipment") ]));
        m.append(row("two",[ select("Continence", S.clinical, "continence", ["Independent","Needs prompting","Incontinent","Catheter / stoma","Prefer not to say"]), select("Cognition", S.clinical, "cognition", ["Clear","Mild impairment","Moderate","Severe","Prefer not to say"]) ]));
        m.append(row("two",[ select("Pressure injury risk", S.clinical, "pressure_injury_risk", ["Low","Medium","High","Not sure"]), select("Falls risk", S.clinical, "falls_risk", ["Low","Medium","High","Not sure"]) ]));
        m.append(row("three",[
          chipsInline("Seizures?", S.clinical.seizures, "has", [["No", false], ["Yes", true], ["Not sure", "Not sure"]]),
          input("Seizure plan (if any)", S.clinical.seizures, "plan"),
          input("Frequency (if applicable)", S.clinical.seizures, "frequency")
        ]));
        m.append(input("Diet / swallowing notes (optional)", S.clinical, "diet_notes"));
      }
    },

    {
      key:"medications",
      title:"Medication management",
      sub:"Tell us if medications are part of daily support.",
      build(m){
        m.append(chipRadio("Participant has medications?", S.medications, "has_meds", [
          ["Yes", true], ["No", false], ["Not sure","Not sure"]
        ]));
        m.append(select("How are meds managed?", S.medications, "method", ["Self-administered","Prompting only","Staff administer","Family administers","Not sure"]));
        m.append(row("two",[
          chipsInline("Webster pack?", S.medications, "webster_pack", [["Yes", true], ["No", false], ["Not sure","Not sure"]]),
          input("Storage location (optional)", S.medications, "storage")
        ]));
        m.append(row("two",[
          chipsInline("Self-admin?", S.medications, "self_admin", [["Yes", true], ["No", false], ["Not sure","Not sure"]]),
          chipsInline("Staff admin?", S.medications, "staff_admin", [["Yes", true], ["No", false], ["Not sure","Not sure"]])
        ]));
        m.append(typeBox("Medication notes (optional)", "List regular and PRN meds if you like", (v)=> S.medications.notes = v));
      }
    },

    {
      key:"risks",
      title:"Risk assessment — quick overview",
      sub:"We’ll use this to plan safe, appropriate supports.",
      build(m){
        m.append(divider("Behavioural"));
        m.append(chipRadio(null, S.risks.behavioural, "present", [
          ["No behaviours of concern", false], ["Behaviours present", true], ["Not sure","Not sure"], ["Prefer not to say","Prefer not to say"]
        ]));
        m.append(typeBox("Behaviour notes (optional)", "Triggers / strategies / BSP provider", (v)=> S.risks.behavioural.notes = v));

        m.append(divider("Clinical"));
        m.append(checks("Select applicable", S.risks.clinical, {
          wounds:"Wounds / dressings",
          diabetes:"Diabetes",
          tracheostomy:"Tracheostomy",
          tube_feeding:"Enteral tube feeding",
          mental_health:"Significant mental health needs"
        }));
        m.append(typeBox("Other clinical concerns (optional)", "Type here", (v)=> S.risks.clinical.other = v));

        m.append(divider("Environmental"));
        m.append(checks("Select applicable", S.risks.environmental, {
          animals:"Reactive animals",
          hoarding:"Hoarding / clutter",
          weapons:"Weapons on site"
        }));
        m.append(typeBox("Other environmental concerns (optional)", "Type here", (v)=> S.risks.environmental.other = v));

        m.append(divider("Home risk checklist (quick)"));
        m.append(checks("Tick any present", S.risks.home_checklist, {
          trip_hazards:"Trip hazards",
          smoke_alarms:"No working smoke alarms",
          lighting:"Poor lighting",
          bathroom_safety:"Bathroom lacks safety rails / mats"
        }));
        m.append(typeBox("Home risk notes (optional)", "Type here", (v)=> S.risks.home_checklist.notes = v));

        m.append(select("Overall risk rating (your view)", S.risks, "overall_rating", ["Low","Medium","High","Not sure"]));
      }
    },

    {
      key:"supports",
      title:"Supports requested & goals",
      sub:"Choose the support types and share goals/outcomes.",
      build(m){
        m.append(checks("Support types", S.supports, {
          t1:"Personal care",
          t2:"Domestic assistance",
          t3:"Community participation",
          t4:"Nursing care at home",
          t5:"Daily living skills",
          t6:"Respite / carer relief"
        }, "types"));
        m.append(typeBox("Goals (participant’s goals)", "Type goals or outcomes in the plan", (v)=> S.supports.goals = v));
        m.append(typeBox("Preferred outcomes / focus areas", "What does success look like?", (v)=> S.supports.outcomes = v));
      }
    },

    {
      key:"schedule",
      title:"Schedule & urgency",
      sub:"Tell us the visit windows that suit, and how soon you’d like to begin.",
      build(m){
        m.append(checks("Time windows", S.schedule, {
          w1:"Weekday mornings (7–11am)",
          w2:"Weekday afternoons (12–4pm)",
          w3:"Evenings (5–9pm)",
          w4:"Weekends"
        }, "windows"));
        m.append(checks("Days", S.schedule, { d1:"Mon", d2:"Tue", d3:"Wed", d4:"Thu", d5:"Fri", d6:"Sat", d7:"Sun" }, "days"));
        m.append(row("two",[ input("Approx. hours per week", S.schedule, "hours_per_week","number"), select("Urgency", S.schedule, "urgency", ["Urgent (24–72h)","Soon (1–2 weeks)","Exploring options","Not sure"]) ]));
        m.append(input("Start preference / date (optional)", S.schedule, "start_preference"));
      }
    },

    {
      key:"money",
      title:"Money & property consent",
      sub:"Only if relevant to supports. You can decide this later.",
      build(m){
        m.append(chipRadio(null, S.money_property, "consent", [
          ["I consent", true], ["I do not consent", false], ["Not sure","Not sure"]
        ]));
        m.append(typeBox("Details / limits (optional)", "E.g., petty cash for groceries, limits, oversight", (v)=> S.money_property.details = v));
      }
    },

    {
      key:"keys",
      title:"Authority to hold a key (optional)",
      sub:"If you’d like us to hold a key for access.",
      build(m){
        m.append(chipRadio(null, S.keys, "allow_hold_key", [
          ["Allow", true], ["Do not allow", false], ["Not sure","Not sure"]
        ]));
        m.append(row("two",[ input("Key location / notes (optional)", S.keys, "location"), input("Keysafe code (optional)", S.keys, "code") ]));
      }
    },

    {
      key:"advocacy",
      title:"Authority to act as advocate (optional)",
      sub:"Provide details if an advocate is appointed.",
      build(m){
        m.append(chipRadio(null, S.advocacy, "has_advocate", [
          ["Advocate appointed", true], ["No advocate", false], ["Not sure","Not sure"]
        ]));
        m.append(row("two",[ input("Advocate name", S.advocacy, "name"), input("Organisation (optional)", S.advocacy, "organisation") ]));
        m.append(row("two",[ input("Phone", S.advocacy, "phone","tel"), input("Email", S.advocacy, "email","email") ]));
      }
    },

    {
      key:"bsp",
      title:"Behaviour support (optional)",
      sub:"If a Behaviour Support Plan (BSP) exists or is being developed.",
      build(m){
        m.append(chipRadio(null, S.bsp, "has_bsp", [
          ["BSP in place", true], ["No BSP", false], ["Not sure","Not sure"]
        ]));
        m.append(chipRadio("Restrictive practices?", S.bsp, "restrictive_practices", [
          ["Yes", true], ["No", false], ["Not sure","Not sure"]
        ]));
        m.append(row("two",[ input("BSP provider (if any)", S.bsp, "provider"), input("Notes (optional)", S.bsp, "notes") ]));
      }
    },

    {
      key:"home",
      title:"Home risk checklist (extended)",
      sub:"We’ll confirm during onboarding, this helps us prepare.",
      build(m){
        m.append(checks("Check all that apply", S.risks.home_checklist, {
          trip_hazards:"Trip hazards",
          smoke_alarms:"No / faulty smoke alarms",
          lighting:"Poor lighting",
          bathroom_safety:"Bathroom lacks safety rails / mats",
        }));
        m.append(typeBox("Anything else for home safety (optional)", "Type here", (v)=> S.risks.home_checklist.notes = v));
      }
    },

    {
      key:"consents",
      title:"Consents & acknowledgements",
      sub:"You can adjust any of these later with our team.",
      build(m){
        m.append(checks("Tick to consent/acknowledge", S.consents, {
          info_sharing:"Consent to information sharing (where needed to coordinate supports)",
          emergency_treatment:"Consent for emergency treatment (where appropriate)",
          media:"Consent for media & images (optional / can limit usage)",
          plan_sharing:"Consent to share NDIS plan with HD HeeD",
          privacy_ack:"Privacy & Confidentiality Agreement — acknowledged",
          handbook_ack:"Client Handbook — received & acknowledged (download below)",
          incident_ack:"Incident Management Acknowledgement — understood",
          complaints_info_ack:"Complaints & Feedback — information received"
        }));
      }
    },

    {
      key:"uploads",
      title:"Upload documents (optional)",
      sub:"Examples: NDIS plan, ID, BSP, care plans, GP letters. You can also send them later.",
      build(m){
        const box = document.createElement('div'); box.className = "inlinebox";
        box.innerHTML = `
          <label style="font-weight:800">Attach files (optional)</label>
          <div class="handbook" style="display:block">
            <input id="fileInput" type="file" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.heic,.rtf,.txt,.xlsx,.xls" />
            <div id="fileList" class="hint">No files selected</div>
          </div>
        `;
        m.append(box);
        box.querySelector("#fileInput").addEventListener("change", (e)=>{
          const files = Array.from(e.target.files||[]);
          S.uploads.files = files;
          const names = files.map(f=> f.name + (f.size?` (${Math.round(f.size/1024)} KB)`:"")).join(" • ");
          box.querySelector("#fileList").textContent = files.length ? names : "No files selected";
          save();
        });
      }
    },

    {
      key:"privacy",
      title:"Client Handbook & info",
      sub:"Read online or download a copy.",
      build(m){
        const box = document.createElement('div'); box.className="inlinebox handbook";
        box.innerHTML = `
          <label style="font-weight:800">Client Handbook</label>
          <object data="/docs/Client-Handbook.pdf" type="application/pdf">
            <div class="hint" style="padding:12px">
              PDF preview not available on this device.
              <a href="/docs/Client-Handbook.pdf" target="_blank" rel="noopener">Download the Handbook (PDF)</a>.
            </div>
          </object>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <a class="al-chip" href="/docs/Client-Handbook.pdf" target="_blank" rel="noopener">⬇ Download PDF</a>
            <a class="al-chip" href="/docs/Client-Handbook.docx" target="_blank" rel="noopener">⬇ Download DOCX</a>
          </div>
        `;
        m.append(box);
      }
    },

    {
      key:"review",
      title:"Review your answers",
      sub:"Check the sections below. You can go back to edit anything.",
      build(m){ m.append(renderReview()); }
    },

    {
      key:"submit",
      title:"Submit your onboarding",
      sub:"Provide a contact. At least an email or phone is required to submit.",
      build(m){
        m.append(row("two",[ input("Your name (submitter)", S.submitter, "name"), input("Email (required if no phone)", S.submitter, "email","email") ]));
        m.append(input("Phone (required if no email)", S.submitter, "phone","tel"));
        const actions = document.createElement('div'); actions.style = "display:flex; gap:8px; flex-wrap:wrap; margin-top:10px";
        const btnSend = button("Send now","primary", async ()=>{
          if (!((S.submitter.email && S.submitter.email.trim()) || (S.submitter.phone && S.submitter.phone.trim()))){
            alert("Please provide at least an email or a phone number to submit."); return;
          }
          try{ await sendToFormspree(); alert("All done — we’ve received your onboarding. We’ll be in touch shortly."); }
          catch(e){ alert("Couldn’t send right now. Please email info@hdheed.com.au or try again.\n\n" + (e?.message||e)); }
        });
        const btnDownload = button("Download summary (JSON)","ghost", ()=>{
          const payload = buildPayload(true);
          const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
          const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:'hdheed-ailr-summary.json'});
          document.body.appendChild(a); a.click(); a.remove();
        });
        actions.append(btnSend, btnDownload);
        m.append(actions);
        const hint = document.createElement('div'); hint.className="hint"; hint.textContent = "We’ll contact you from info@hdheed.com.au or 02 8630 5500."; m.append(hint);
      }
    }
  ];

  /* ====== Review renderer ====== */
  function renderReview(){
    const wrap = document.createElement('div'); wrap.className = "inlinebox";
    const pre = document.createElement('pre'); pre.style.whiteSpace='pre-wrap'; pre.style.margin=0;
    const p = (v)=> v ?? "—";
    const boolText = (v)=> v===true?"Yes":v===false?"No":(v??"—");
    const listTrue = (obj, keys, map)=>{ const arr=keys.filter(k=>obj[k]===true).map(k=>map[k]||k); return arr.length?arr.join(", "):"—"; };
    const mapTypes = (arr)=>{ const m={t1:"Personal care",t2:"Domestic assistance",t3:"Community participation",t4:"Nursing care at home",t5:"Daily living skills",t6:"Respite / carer relief"}; return (arr||[]).map(k=>m[k]).filter(Boolean).join(", ")||"—"; };
    const mapWindows = (arr)=>{ const m={w1:"Weekday AM",w2:"Weekday PM",w3:"Evenings",w4:"Weekends"}; return (arr||[]).map(k=>m[k]).filter(Boolean).join(", ")||"—"; };
    const mapDays = (arr)=>{ const m={d1:"Mon",d2:"Tue",d3:"Wed",d4:"Thu",d5:"Fri",d6:"Sat",d7:"Sun"}; return (arr||[]).map(k=>m[k]).filter(Boolean).join(", ")||"—"; };

    const lines = [];
    lines.push("Who is completing:");
    lines.push(`• Role: ${p(S.caller.role)} • Name: ${p(S.caller.name)} • Relationship: ${p(S.caller.relationship)} • Consent: ${p(S.caller.consent)}`);
    lines.push("");
    lines.push("Participant:");
    lines.push(`• Legal: ${p(S.participant.legal_name)} | Preferred: ${p(S.participant.preferred_name)} | Pronouns: ${p(S.participant.pronouns)}`);
    lines.push(`• DOB: ${p(S.participant.dob)} | NDIS: ${p(S.participant.ndis_number)}`);
    lines.push(`• Address: ${[S.participant.address.line1,S.participant.address.line2,S.participant.address.suburb,S.participant.address.state,S.participant.address.postcode].filter(Boolean).join(", ")||"—"}`);
    lines.push(`• Plan mgmt: ${p(S.participant.plan_mgmt)} | Plan mgr: ${[S.participant.plan_manager.org,S.participant.plan_manager.contact,S.participant.plan_manager.email,S.participant.plan_manager.phone].filter(Boolean).join(" • ")||"—"}`);
    lines.push(`• Plan dates: ${[S.participant.plan_dates.start,S.participant.plan_dates.end].filter(Boolean).join(" → ")||"—"}`);
    lines.push("");
    lines.push("Contacts:");
    lines.push(`• Email: ${p(S.contacts.email)} | Phone: ${p(S.contacts.phone)}`);
    lines.push(`• Emergency: ${[S.contacts.emergency.name,S.contacts.emergency.relationship,S.contacts.emergency.phone].filter(Boolean).join(" • ")||"—"}`);
    lines.push(`• Support Coordinator: ${[S.contacts.support_coordinator.name,S.contacts.support_coordinator.org,S.contacts.support_coordinator.email,S.contacts.support_coordinator.phone].filter(Boolean).join(" • ")||"—"}`);
    lines.push(`• GP: ${[S.contacts.gp.name,S.contacts.gp.practice,S.contacts.gp.phone,S.contacts.gp.email].filter(Boolean).join(" • ")||"—"}`);
    lines.push("");
    lines.push("Communication & preferences:");
    lines.push(`• Language: ${p(S.comms.primary_language)} | Interpreter: ${p(S.comms.interpreter)} ${p(S.comms.interpreter_language)}`);
    lines.push(`• Worker gender pref.: ${p(S.comms.preferences.worker_gender || S.comms.preferences.worker_gender_other)} | Transport: ${p(S.comms.preferences.transport_required)}`);
    lines.push("");
    lines.push("Living & access:");
    lines.push(`• Residence: ${p(S.living.residence_type)} | Lives with: ${p(S.living.lives_with)}`);
    lines.push(`• Entry notes: ${p(S.living.entry_notes)} | Keysafe: ${p(S.living.keysafe)} | Smoking: ${p(S.living.smoking_on_premises)}`);
    lines.push(`• Hazards: ${p(S.living.hazards)}`);
    lines.push("");
    lines.push("Clinical:");
    lines.push(`• Diagnoses: ${p(S.clinical.primary_diagnoses)} | Other: ${p(S.clinical.other_diagnoses)}`);
    lines.push(`• Allergies: ${p(S.clinical.allergies)} | Mobility: ${p(S.clinical.mobility)} | Equipment: ${p(S.clinical.equipment)}`);
    lines.push(`• Continence: ${p(S.clinical.continence)} | Cognition: ${p(S.clinical.cognition)} | Pressure risk: ${p(S.clinical.pressure_injury_risk)} | Falls: ${p(S.clinical.falls_risk)}`);
    lines.push(`• Seizures: ${p(S.clinical.seizures.has)} | Plan: ${p(S.clinical.seizures.plan)} | Freq: ${p(S.clinical.seizures.frequency)}`);
    lines.push(`• Diet: ${p(S.clinical.diet_notes)}`);
    lines.push("");
    lines.push("Medications:");
    lines.push(`• Has meds: ${p(S.medications.has_meds)} | Method: ${p(S.medications.method)} | Webster: ${p(S.medications.webster_pack)} | Storage: ${p(S.medications.storage)}`);
    lines.push(`• Self-admin: ${p(S.medications.self_admin)} | Staff-admin: ${p(S.medications.staff_admin)} | Notes: ${p(S.medications.notes)}`);
    lines.push("");
    lines.push("Risks:");
    lines.push(`• Behavioural: ${p(S.risks.behavioural.present)} | Notes: ${p(S.risks.behavioural.notes)}`);
    lines.push(`• Clinical: ${listTrue(S.risks.clinical, ["wounds","diabetes","tracheostomy","tube_feeding","mental_health"], {wounds:"Wounds",diabetes:"Diabetes",tracheostomy:"Tracheostomy",tube_feeding:"Enteral feeding",mental_health:"Mental health"})} | Other: ${p(S.risks.clinical.other)}`);
    lines.push(`• Environmental: ${listTrue(S.risks.environmental, ["animals","hoarding","weapons"], {animals:"Reactive animals",hoarding:"Hoarding",weapons:"Weapons"})} | Other: ${p(S.risks.environmental.other)}`);
    lines.push(`• Home risks: ${listTrue(S.risks.home_checklist, ["trip_hazards","smoke_alarms","lighting","bathroom_safety"], {trip_hazards:"Trip hazards",smoke_alarms:"No smoke alarms",lighting:"Poor lighting",bathroom_safety:"Bathroom safety"})} | Notes: ${p(S.risks.home_checklist.notes)}`);
    lines.push(`• Overall: ${p(S.risks.overall_rating)}`);
    lines.push("");
    lines.push("Supports & schedule:");
    lines.push(`• Types: ${mapTypes(S.supports.types)} | Goals: ${p(S.supports.goals)} | Outcomes: ${p(S.supports.outcomes)}`);
    lines.push(`• Windows: ${mapWindows(S.schedule.windows)} | Days: ${mapDays(S.schedule.days)} | Hours/week: ${p(S.schedule.hours_per_week)}`);
    lines.push(`• Urgency: ${p(S.schedule.urgency)} | Start: ${p(S.schedule.start_preference)}`);
    lines.push("");
    lines.push("Money / Keys / Advocacy:");
    lines.push(`• Money/property consent: ${p(S.money_property.consent)} | Details: ${p(S.money_property.details)}`);
    lines.push(`• Hold key: ${p(S.keys.allow_hold_key)} | Location: ${p(S.keys.location)} | Code: ${p(S.keys.code)}`);
    lines.push(`• Advocate: ${p(S.advocacy.has_advocate)} | ${[S.advocacy.name,S.advocacy.organisation,S.advocacy.phone,S.advocacy.email].filter(Boolean).join(" • ")||"—"}`);
    lines.push("");
    lines.push("BSP:");
    lines.push(`• BSP in place: ${p(S.bsp.has_bsp)} | Restrictive practices: ${p(S.bsp.restrictive_practices)} | Provider: ${p(S.bsp.provider)} | Notes: ${p(S.bsp.notes)}`);
    lines.push("");
    lines.push("Consents:");
    lines.push(`• Info sharing: ${p(S.consents.info_sharing)} • Emergency: ${p(S.consents.emergency_treatment)} • Media: ${p(S.consents.media)} • Plan sharing: ${p(S.consents.plan_sharing)}`);
    lines.push(`• Privacy ack: ${p(S.consents.privacy_ack)} • Handbook ack: ${p(S.consents.handbook_ack)} • Incident ack: ${p(S.consents.incident_ack)} • Complaints info: ${p(S.consents.complaints_info_ack)}`);

    pre.textContent = lines.join("\n");
    wrap.append(pre);
    return wrap;
  }

  /* ====== Send / payload ====== */
  async function sendToFormspree(){
    const hasFiles = (S.uploads.files||[]).length>0;
    if (hasFiles){
      const fd = new FormData();
      fd.append("_subject", "HD HeeD — AILR onboarding submission");
      fd.append("source", "ailr-v12");
      fd.append("summary", JSON.stringify(buildPayload(true)));
      (S.uploads.files||[]).forEach((f,idx)=> fd.append("file"+(idx+1), f, f.name));
      const r = await fetch(FS_ENDPOINT, { method:"POST", body: fd, headers:{ "Accept":"application/json" }});
      if (!r.ok) throw new Error("Network / server error");
      return;
    } else {
      const payload = buildPayload(true);
      const r = await fetch(FS_ENDPOINT, {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Accept":"application/json" },
        body: JSON.stringify(payload)
      });
      if (!r.ok) throw new Error("Network / server error");
      return;
    }
  }

  function buildPayload(includeNotes){
    return {
      _subject:"HD HeeD — AILR onboarding submission",
      source:"ailr-v12",
      caller:S.caller, participant:S.participant, contacts:S.contacts, comms:S.comms,
      living:S.living, clinical:S.clinical, medications:S.medications, risks:S.risks,
      supports:S.supports, schedule:S.schedule, money_property:S.money_property,
      keys:S.keys, advocacy:S.advocacy, bsp:S.bsp, consents:S.consents,
      uploads:(S.uploads.files||[]).map(f=>({name:f.name,size:f.size,type:f.type})),
      submitter:S.submitter, notes: includeNotes ? S.notes : [],
      timestamp:new Date().toISOString()
    };
  }

  /* ====== Nav & render ====== */
  function render(){
    const total = Steps.length;
    const step = Steps[S.i];
    stepTxt.textContent = `Step ${S.i+1}/${total}`;
    barEl.style.width = Math.round((S.i)/(total-1)*100) + "%";
    setPortrait(step.key);
    qEl.textContent = step.title;
    subEl.textContent = step.sub || "";
    optsEl.innerHTML = "";
    step.build(optsEl);
    save();
    window.scrollTo({top:0,behavior:"smooth"});
  }

  document.getElementById('backBtn').addEventListener('click', ()=>{ S.i = Math.max(0, S.i-1); render(); });
  document.getElementById('nextBtn').addEventListener('click', ()=>{ S.i = Math.min(Steps.length-1, S.i+1); render(); });
  document.getElementById('saveExitBtn').addEventListener('click', ()=>{ save(); alert("Saved. You can close this page and return later on the same device."); });

  // Initial render
  render();
})();
</script>
</body>
</html>
