<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HD HeeD — Simple Referral</title>
  <meta name="description" content="Ultra-simple HD HeeD referral. Clean email summary + downloadable summary. Auto-CC to info@hdheed.com.au and ndis@hdheed.com.au."/>
  <style>
    :root{
      /* Dark Purple & Yellow palette */
      --bg:#0f0a1f;           /* deep purple backdrop */
      --ink:#0b0a18;          /* dark ink on white cards */
      --card:#ffffff;         /* keep cards white for readability */
      --muted:#6b7280;
      --ring:#fde68a;         /* yellow focus ring */

      /* Brand accents */
      --brand:#7c3aed;        /* purple */
      --brand2:#8b5cf6;       /* lighter purple */
      --brand3:#facc15;       /* yellow */
      --brand4:#4c1d95;       /* deep violet */

      --danger:#ef4444;
    }

    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 800px at 10% -10%, #1f1440 0%, transparent 60%),
        radial-gradient(900px 700px at 100% 10%, #140b2c 0%, transparent 55%),
        linear-gradient(135deg,#0f0a1f,#1a1036 60%);
      color:#e5e7eb;display:flex;justify-content:center;padding:24px
    }

    .shell{width:100%;max-width:1100px}
    .card{background:var(--card);color:var(--ink);border-radius:22px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.45);position:relative}

    header{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:20px 22px;border-bottom:1px solid #e5e7eb;position:relative}
    header:before{content:"";position:absolute;inset:0 0 auto 0;height:6px;background:linear-gradient(90deg,var(--brand),var(--brand2),var(--brand3),var(--brand4));}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:10px;background:var(--brand) url('https://www.hdheed.com.au/images/logo.png') center/cover no-repeat;box-shadow:inset 0 0 18px rgba(255,255,255,.2)}
    .title{font-weight:800;letter-spacing:.2px}
    .subtitle{color:#475569;font-size:.95rem}

    .progress{height:12px;background:#eef2f7;border-radius:999px;overflow:hidden;width:340px}
    .progress>div{height:100%;width:0%;background:linear-gradient(90deg,var(--brand2),var(--brand3));box-shadow:0 0 12px rgba(250,204,21,.45);transition:width .35s ease}

    main{display:grid;grid-template-columns:280px 1fr;min-height:640px}
    @media (max-width:920px){main{grid-template-columns:1fr}}

    /* Sidebar */
    nav{
      background:linear-gradient(180deg,#f5f3ff,#fffbeb);
      border-right:1px solid #e5e7eb;
      padding:18px;display:flex;flex-direction:column;gap:8px
    }
    .step-link{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:12px;cursor:pointer;color:#111827;text-decoration:none;border:1px solid #e2e8f0;background:#ffffff}
    .step-link .dot{width:10px;height:10px;border-radius:50%;background:#cbd5e1;box-shadow:inset 0 0 0 2px #e2e8f0}
    .step-link.active{background:linear-gradient(180deg,#fef9c3,#ffffff);border-color:#fde68a;box-shadow:0 4px 14px rgba(124,58,237,.15)}
    .step-link.active .dot{background:var(--brand3);box-shadow:0 0 0 2px #fef9c3 inset}
    .step-link.done{background:linear-gradient(180deg,#fefce8,#ffffff);border-color:#fde68a}
    .step-link.done .dot{background:var(--brand2)}
    .badge{margin-left:auto;font-size:.75rem;color:#475569}

    .pane{padding:24px 24px 28px}
    .block{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:18px;margin-bottom:16px;box-shadow:0 6px 22px rgba(2,6,23,.04)}

    h2{margin:.25rem 0 .75rem 0;position:relative;padding-left:12px}
    h2:before{content:"";position:absolute;left:0;top:.1rem;bottom:.1rem;width:6px;border-radius:999px;background:linear-gradient(180deg,var(--brand2),var(--brand3))}
    .muted{color:#64748b}

    .grid{display:grid;gap:14px}.two{grid-template-columns:repeat(2,minmax(0,1fr))}.three{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:720px){.two,.three{grid-template-columns:1fr}}

    label{font-weight:700;font-size:.95rem;color:#111827}
    input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #e5e7eb;outline:none;background:#fff;transition:box-shadow .15s, border-color .15s}
    input:focus,select:focus,textarea:focus{box-shadow:0 0 0 4px var(--ring); border-color:#fcd34d}
    textarea{min-height:110px}

    /* Yes/No/Unsure pills */
    .yn3{display:grid;grid-template-columns:1fr 1fr 1fr;background:#f8fafc;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb}
    .yn3 button{appearance:none;padding:12px 14px;border:none;background:transparent;cursor:pointer;font-weight:700;transition:background .15s, transform .03s}
    .yn3 button:active{transform:scale(.99)}
    .yn3 button[data-v="yes"][aria-pressed="true"]{background:rgba(250,204,21,.18)}   /* yellow */
    .yn3 button[data-v="no"][aria-pressed="true"]{background:rgba(239,68,68,.12)}    /* red */
    .yn3 button[data-v="unsure"][aria-pressed="true"]{background:rgba(124,58,237,.15)}/* purple */

    .btn-row{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
    .btn{appearance:none;border:none;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer;transition:filter .15s, transform .03s}
    .btn:active{transform:translateY(1px)}
    .primary{background:linear-gradient(90deg,var(--brand2),var(--brand3));color:#fff;box-shadow:0 8px 18px rgba(124,58,237,.25)}
    .ghost{background:linear-gradient(180deg,#f8fafc,#ffffff);border:1px solid #e5e7eb}
    .danger{background:linear-gradient(90deg,#ef4444,#f97316);color:#fff;box-shadow:0 8px 18px rgba(239,68,68,.25)}
    .primary:hover,.danger:hover{filter:brightness(1.03)}

    .hint{font-size:.85rem;color:#64748b}

    .review{
      background:linear-gradient(180deg,#f5f3ff,#fffbeb);
      border:1px dashed #cbd5e1;border-radius:14px;padding:16px
    }

    pre{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px;max-height:300px;overflow:auto}

    .toast{position:fixed;inset:auto 20px 20px auto;background:linear-gradient(90deg,#111827,#1a1036);color:#fff;padding:12px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:.2s;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .toast.show{opacity:1}

    .pill{display:flex;align-items:center;gap:8px;background:#f1f5f9;border:1px solid #e5e7eb;border-radius:999px;padding:10px 12px;transition:background .15s,border-color .15s, box-shadow .15s}
    .pill input{width:auto}
    .pill span{font-weight:600}
    .pill:hover{box-shadow:0 6px 16px rgba(2,6,23,.06)}
    .pill:has(input:checked){background:linear-gradient(90deg,#fef3c7,#f5f3ff);border-color:#fde68a}
    .pill:has(input:checked) span{color:#4c1d95}

    .pill-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:720px){.pill-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="shell">
    <div class="card" role="form" aria-labelledby="form-title">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <div id="form-title" class="title">HD HeeD — Super-Simple Referral</div>
            <div class="subtitle">Everything optional — only consent is required.</div>
          </div>
        </div>
        <div class="progress" aria-label="Progress"><div id="bar"></div></div>
      </header>
      <main>
        <nav id="steps"></nav>
        <section class="pane" id="pane"></section>
      </main>
    </div>
  </div>

  <!-- Hidden native form post (no branding shown) -->
  <form id="silentPost" action="https://formspree.io/f/xvgrkkjn" method="POST" enctype="multipart/form-data" style="display:none;">
    <input type="hidden" name="_subject" value="">
    <input type="hidden" name="_redirect" value="https://himmatpals.github.io/hd-heed-website/thankyou.html">
    <input type="text" name="_gotcha" value="">
  </form>

  <div class="toast" id="toast">Saved</div>

  <script>
    const AUTOSAVE_KEY  = "hdheed_referral_simple_teal_v1";

    const state = JSON.parse(localStorage.getItem(AUTOSAVE_KEY) || "{}");
    const $ = (s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const save = ()=>{ localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(state)); flash("Saved"); };
    const flash = (m)=>{ const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1200); };

    const Steps = [
      {id:"consent",     label:"Consent",                render:rConsent},
      {id:"referrer",    label:"Person Making Referral", render:rReferrer},
      {id:"participant", label:"Participant Details",    render:rParticipant},
      {id:"carer",       label:"Primary Carer (NOK)",    render:rCarer},
      {id:"safety",      label:"Safety & Risks",         render:rSafety},
      {id:"supports",    label:"Supports",               render:rSupports},
      {id:"funding",     label:"Funding & Plan",         render:rFunding},
      {id:"review",      label:"Review & Consent",       render:rReview},
      {id:"submit",      label:"Submit",                 render:rSubmit},
    ];
    let current = 0;

    function init(){ renderNav(); go(0); }
    function renderNav(){
      const nav=$("#steps"); nav.innerHTML="";
      Steps.forEach((s,i)=>{ const a=document.createElement("a");
        a.className="step-link";
        a.innerHTML=`<span class="dot"></span><span>${i+1}. ${s.label}</span><span class="badge" id="b-${s.id}"></span>`;
        a.href="#";
        a.onclick=e=>{ e.preventDefault(); if(i>0 && state.consent!=="yes"){ alert("Consent is required to proceed."); return; } go(i); };
        nav.appendChild(a);
      });
    }
    function setActive(){ $$(".step-link").forEach((el,i)=>{ el.classList.toggle("active",i===current); el.classList.toggle("done",i<current); }); $("#bar").style.width = Math.round((current)/(Steps.length-1)*100)+"%"; }
    function go(i){ current=Math.max(0,Math.min(Steps.length-1,i)); setActive(); const pane=$("#pane"); pane.innerHTML=""; Steps[current].render(pane); window.scrollTo({top:0,behavior:"smooth"}); }

    function input(id,label,o={}){const{type="text",placeholder="",hint=""}=o; const v = state[id]??"";
      return `<div><label for="${id}">${label}</label>
      <input id="${id}" name="${id}" type="${type}" placeholder="${placeholder}" value="${v??""}"/>
      ${hint?`<div class="hint">${hint}</div>`:""}</div>`}
    function select(id,label,opts){const v=state[id]??""; return `<div><label for="${id}">${label}</label>
      <select id="${id}">${["<option value=''>Not sure / discuss later</option>",...opts.map(x=>`<option ${v===x?"selected":""}>${x}</option>`)].join("")}</select></div>`}
    function yn3(id,label){const v=state[id]; return `<div><label>${label}</label>
      <div class="yn3"><button type="button" data-yn3="${id}" data-v="yes" aria-pressed="${v==='yes'}">Yes</button>
      <button type="button" data-yn3="${id}" data-v="no" aria-pressed="${v==='no'}">No</button>
      <button type="button" data-yn3="${id}" data-v="unsure" aria-pressed="${v==='unsure'}">Not sure</button></div></div>`}
    function bindModel(root){ $$("input,select,textarea",root).forEach(el=>{const k=el.id;if(!k)return; el.value=state[k]??""; el.addEventListener("input",()=>{ state[k]=el.type==="checkbox"?el.checked:el.value; save(); }); el.addEventListener("change",()=>{ state[k]=el.type==="checkbox"?el.checked:el.value; save(); }); }); }
    function bindYN3(root){ $$("[data-yn3]",root).forEach(btn=>btn.addEventListener("click",()=>{const k=btn.dataset.yn3; state[k]=btn.dataset.v; save(); $$("[data-yn3='"+k+"']",root).forEach(b=>b.setAttribute("aria-pressed", String(b===btn))); })); }

    function rConsent(p){ p.innerHTML = `<div class="block">
      <h2>Consent <span class="muted">(required)</span></h2>
      ${yn3("consent","Has the Participant or Primary Carer consented to this referral?")}
      <div class="hint">Consent is required to proceed.</div>
      <div class="btn-row"><button class="btn primary" id="next">Next</button></div></div>`;
      $("#next",p).onclick=e=>{ e.preventDefault(); if(state.consent!=="yes"){ alert("Please select Yes to consent before continuing."); return; } go(1); };
      bindYN3(p);
    }

    function rReferrer(p){ p.innerHTML = `<div class="block">
      <h2>Person Making Referral</h2>
      ${input("referrer_name","Full Name")}
      ${input("relationship","Relationship to Participant")}
      <div class="grid two">${input("phone","Phone",{type:"tel"})}${input("mobile","Mobile",{type:"tel"})}</div>
      ${input("email","Email",{type:"email",hint:"We'll send a confirmation"})}
      <div class="btn-row"><button class="btn ghost" id="back">Back</button><button class="btn primary" id="next">Next</button></div></div>`;
      $("#back",p).onclick=e=>{e.preventDefault(); go(0)}; $("#next",p).onclick=e=>{e.preventDefault(); go(2)};
      bindModel(p);
    }

    function rParticipant(p){
      p.innerHTML = `<div class="block"><h2>Participant Details</h2>
        <div class="grid two">${input("participant_fname","First Name")}${input("participant_lname","Last Name")}</div>
        <div class="grid two">${input("title","Title")}${input("dob","Date of Birth",{type:"date"})}</div>
        <div class="grid two">${input("ndis_number","NDIS Number")}${input("marital_status","Marital Status")}</div>
        <div class="grid two"><div><label>Gender</label>
          <div class="yn3"><button type="button" data-yn3="gender" data-v="male" aria-pressed="${state.gender==='male'}">Male</button>
          <button type="button" data-yn3="gender" data-v="female" aria-pressed="${state.gender==='female'}">Female</button>
          <button type="button" data-yn3="gender" data-v="unsure" aria-pressed="${state.gender==='unsure'}">Not sure</button></div></div>
          ${input("language","Language")}</div>
        <div class="grid two">${input("street","Street Address")}${input("suburb","Suburb")}</div>
        <div class="grid three">${input("city","City")}${input("postcode","Postcode",{hint:"4-digit"})}${input("home_phone","Home Phone",{type:"tel"})}</div>
        <div class="grid two">${input("participant_mobile","Mobile",{type:"tel"})}${input("participant_email","Email",{type:"email"})}</div>
        ${yn3("interpreter","Is Interpreter Required?")}
        ${input("interpreter_type","If yes, which language / type?")}
        <div class="btn-row"><button class="btn ghost" id="back">Back</button><button class="btn primary" id="next">Next</button></div></div>`;
      $("#back",p).onclick=e=>{e.preventDefault(); go(1)}; $("#next",p).onclick=e=>{e.preventDefault(); go(3)};
      bindModel(p); bindYN3(p);
    }

    function rCarer(p){
      p.innerHTML = `<div class="block"><h2>Primary Carer (Next of Kin)</h2>
        <div class="grid two">${input("carer_fname","First Name")}${input("carer_lname","Last Name")}</div>
        ${input("carer_relationship","Relationship")}
        <div class="grid two">${input("carer_street","Street Address")}${input("carer_suburb","Suburb")}</div>
        <div class="grid three">${input("carer_city","City")}${input("carer_postcode","Postcode")}${input("carer_home","Home Phone",{type:"tel"})}</div>
        <div class="grid two">${input("carer_mobile","Mobile",{type:"tel"})}${input("carer_email","Email",{type:"email"})}</div>
        ${yn3("custody","Shared Care / Custody Arrangement?")}
        <div class="btn-row"><button class="btn ghost" id="back">Back</button><button class="btn primary" id="next">Next</button></div></div>`;
      $("#back",p).onclick=e=>{e.preventDefault(); go(2)}; $("#next",p).onclick=e=>{e.preventDefault(); go(4)};
      bindModel(p); bindYN3(p);
    }

    function rSafety(p){
      p.innerHTML = `<div class="block"><h2>Safety & Immediate Risks</h2>
        ${yn3("recent_fall","Has the participant had a recent fall?")}
        ${yn3("wound","Is there a wound / post-op site requiring care?")}
        ${yn3("uncontrolled_pain","Uncontrolled pain?")}
        ${yn3("pressure_risk","At risk of pressure injury?")}
        ${yn3("behaviour_risk","Any behaviours of concern?")}
        ${input("risk_notes","Risk details (optional)",{placeholder:"Brief notes, dates, locations…"})}
        <div class="btn-row"><button class="btn ghost" id="back">Back</button><button class="btn primary" id="next">Next</button></div></div>`;
      $("#back",p).onclick=e=>{e.preventDefault(); go(3)}; $("#next",p).onclick=e=>{e.preventDefault(); go(5)};
      bindModel(p); bindYN3(p);
    }

    function rSupports(p){
      const opts = [
        "Personal care (shower, dressing)",
        "Medication support",
        "Nursing (wounds / catheter / stoma)",
        "Community access / transport",
        "Cleaning / household tasks",
        "Meal prep / feeding",
        "Therapy assistance (per plan)",
        "Overnight support / respite"
      ];
      p.innerHTML = `<div class="block"><h2>Support from HD HeeD</h2>
        <div class="grid two">
          ${input("key_area","Main reason for referral (optional)",{placeholder:"e.g., personal care, wound dressings"})}
          ${input("service_location","Service suburb / postcode (optional)")}
        </div>
        <label style="margin-top:10px;">Tick supports needed (choose any):</label>
        <div class="pill-grid">
          ${opts.map((t,i)=>`
            <label class="pill"><input type="checkbox" id="sup_${i}" ${state["sup_"+i]?"checked":""}/> <span>${t}</span></label>
          `).join("")}
        </div>
        ${yn3("allergies","Any allergies?")}
        ${input("allergy_list","If yes, list allergies")}
        <div class="btn-row"><button class="btn ghost" id="back">Back</button><button class="btn primary" id="next">Next</button></div></div>`;
      $("#back",p).onclick=e=>{e.preventDefault(); go(4)}; $("#next",p).onclick=e=>{e.preventDefault(); go(6)};
      bindModel(p); bindYN3(p);
      $$(".pill input",p).forEach((el,idx)=>{ el.addEventListener("change",()=>{ state["sup_"+idx]=el.checked; save(); }); });
    }

    function rFunding(p){
      p.innerHTML = `<div class="block"><h2>Funding & Plan</h2>
        <div><label>How is your NDIS plan managed?</label>
          <div class="yn3">
            <button type="button" data-yn3="plan_managed" data-v="ndia"   aria-pressed="${state.plan_managed==='ndia'}">NDIA Managed</button>
            <button type="button" data-yn3="plan_managed" data-v="plan"   aria-pressed="${state.plan_managed==='plan'}">Plan Managed</button>
            <button type="button" data-yn3="plan_managed" data-v="self"   aria-pressed="${state.plan_managed==='self'}">Self Managed</button>
          </div>
        </div>
        ${input("funding_area","Funding notes (optional)")}
        <div class="btn-row"><button class="btn ghost" id="back">Back</button><button class="btn primary" id="next">Next</button></div></div>`;
      $("#back",p).onclick=e=>{e.preventDefault(); go(5)}; $("#next",p).onclick=e=>{e.preventDefault(); go(7)};
      bindModel(p); bindYN3(p);
    }

    function rReview(p){
      p.innerHTML = `<div class="block"><h2>Review & Final Consent <span class="muted">(required)</span></h2>
        <div class="review"><h3>Summary</h3><pre>${buildSummaryPlain()}</pre></div>
        <div><label><input id="referral_consent" type="checkbox" ${state.referral_consent?"checked":""}/> I confirm the person being referred has consented.</label></div>
        <div class="hint" style="margin-top:8px">A polished HTML summary will also be sent and can be downloaded next.</div>
        <div class="btn-row"><button class="btn ghost" id="back">Back</button><button class="btn primary" id="next">Looks good</button></div></div>`;
      $("#back",p).onclick=e=>{e.preventDefault(); go(6)};
      $("#next",p).onclick=e=>{
        e.preventDefault();
        if(state.consent!=="yes"){ alert("Initial consent (Step 1) must be Yes to proceed."); go(0); return; }
        const checked = $("#referral_consent").checked;
        if(!checked){ alert("Please tick the final consent box to continue."); return; }
        state.referral_consent = checked; save(); go(8);
      };
      bindModel(p);
    }

    function rSubmit(p){
      p.innerHTML = `<div class="block"><h2>Submit Referral</h2>
        <p class="muted">Submit online now, or download a formatted copy and email later. <br/>A copy will be auto-CC'd to <b>info@hdheed.com.au</b> and <b>ndis@hdheed.com.au</b>.</p>
        <div class="btn-row">
          <button class="btn primary" id="submitOnline">Submit online</button>
          <button class="btn ghost" id="download">Download formatted summary</button>
          <button class="btn danger" id="reset">Reset form</button>
        </div>
        <div class="hint" style="margin-top:10px">After submission, you'll be redirected to our thank-you page.</div>
        <div class="review" style="margin-top:12px"><h3>Preview</h3><pre>${buildSummaryPlain()}</pre></div></div>`;
      $("#submitOnline",p).onclick=submitOnline;
      $("#download",p).onclick=downloadReportHTML;
      $("#reset",p).onclick=()=>{ if(confirm("Clear all answers?")){ localStorage.removeItem(AUTOSAVE_KEY); location.reload(); } };
    }

    function pickSupports(){
      const labels = [
        "Personal care (shower, dressing)",
        "Medication support",
        "Nursing (wounds / catheter / stoma)",
        "Community access / transport",
        "Cleaning / household tasks",
        "Meal prep / feeding",
        "Therapy assistance (per plan)",
        "Overnight support / respite"
      ];
      return labels.filter((_,i)=>state["sup_"+i]).join(", ");
    }

    function ynu(k){ return state[k]==="yes"?"Yes": state[k]==="no"?"No": state[k]==="unsure"?"Not sure": (state[k]||""); }

    function buildSummaryPlain(){
      const L=[];
      L.push("HD HeeD — Referral Summary","");
      L.push(`Consent: ${ynu("consent")} | Final consent: ${state.referral_consent?"Yes":"No"}`,"");
      L.push(`Referrer: ${state.referrer_name||""} (${state.relationship||""})`);
      L.push(`Contact: ${state.email||""} | Phone: ${state.phone||""} | Mobile: ${state.mobile||""}`,"");
      L.push(`Participant: ${state.participant_fname||""} ${state.participant_lname||""} | DOB: ${state.dob||""}`);
      L.push(`NDIS: ${state.ndis_number||""} | Gender: ${ynu("gender")} | Marital: ${state.marital_status||""}`);
      L.push(`Address: ${[state.street,state.suburb,state.city,state.postcode].filter(Boolean).join(", ")}`);
      L.push(`Phone: ${state.home_phone||""} | Mobile: ${state.participant_mobile||""} | Email: ${state.participant_email||""}`);
      L.push(`Language: ${state.language||""} | Interpreter: ${ynu("interpreter")} ${state.interpreter_type?`(${state.interpreter_type})`:""}`,"");
      L.push(`Primary Carer: ${state.carer_fname||""} ${state.carer_lname||""} (${state.carer_relationship||""}) | ${state.carer_email||""}`);
      L.push(`Shared care / custody: ${ynu("custody")}`,"");
      L.push(`Safety: Fall ${ynu("recent_fall")} | Wound ${ynu("wound")} | Pain ${ynu("uncontrolled_pain")} | Pressure ${ynu("pressure_risk")} | Behaviour ${ynu("behaviour_risk")}`);
      if(state.risk_notes) L.push(`Risk notes: ${state.risk_notes}`);
      L.push("");
      if(state.key_area) L.push(`Main reason: ${state.key_area}`);
      const sup = pickSupports(); if(sup) L.push(`Supports requested: ${sup}`);
      if(state.allergies) L.push(`Allergies: ${ynu("allergies")} ${state.allergy_list?`– ${state.allergy_list}`:""}`);
      if(state.service_location) L.push(`Service location: ${state.service_location}`);
      L.push("");
      L.push(`Plan management: ${ynu("plan_managed")} | Funding notes: ${state.funding_area||""}`);
      return L.join("\n");
    }

    function buildSummaryHTML(){
  const esc = s => (s||"").toString().replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  const yn  = (k)=> ynu(k) || "—";
  const v   = (x)=> esc(x || "—");
  const addr = [state.street,state.suburb,state.city,state.postcode].filter(Boolean).join(", ");
  const sup  = pickSupports();
  const dt   = new Date().toLocaleString();

  const pill = (txt)=>{
    const t = (txt||"").toLowerCase();
    let cls = "pill gray";
    if (t==="yes") cls="pill green";
    else if (t==="no") cls="pill red";
    else if (t==="not sure") cls="pill amber";
    return `<span class="${cls}">${esc(txt||"—")}</span>`;
  };

  const chips = (csv)=> {
    if (!csv) return `<span class="muted">None selected</span>`;
    return csv.split(",").map(s=>`<span class="chip">${esc(s.trim())}</span>`).join("");
  };

  return `<!doctype html><html><head><meta charset="utf-8">
  <title>HD HeeD — Referral Summary</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Dark-purple & yellow identity */
      --ink:#0b1020; --ink-2:#1b2340; --muted:#6b7280; --line:#e5e7eb; --soft:#f4f6fb;
      --brand:#6d28d9; --brand-2:#8b5cf6; --accent:#f59e0b; --accent-2:#facc15;
      --ok:#16a34a; --warn:#d97706; --no:#dc2626;
      --chip:#f1f5f9; --chip-text:#0f172a;
      --card:#ffffff; --bg:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 "Plus Jakarta Sans",Inter,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:980px;margin:40px auto;padding:0 24px}
    .doc{background:var(--card);border:1px solid var(--line);border-radius:20px;overflow:hidden;box-shadow:0 12px 40px rgba(2,6,23,.08)}
    .head{position:relative;padding:22px 24px;border-bottom:1px solid var(--line);display:grid;grid-template-columns:1fr auto;align-items:center;gap:18px}
    .head::before{content:"";position:absolute;left:0;right:0;top:0;height:8px;background:
      linear-gradient(90deg,var(--brand),var(--brand-2),var(--accent),var(--accent-2))}
    .logo{width:52px;height:52px;border-radius:14px;background:var(--brand) url('https://www.hdheed.com.au/images/logo.png') center/cover no-repeat;box-shadow:inset 0 0 18px rgba(255,255,255,.35)}
    .brand{display:flex;align-items:center;gap:14px}
    .title{font-weight:800;font-size:1.4rem;letter-spacing:.2px}
    .subtitle{color:#475569;font-size:.95rem;margin-top:2px}
    .meta{ text-align:right}
    .meta .k{color:#64748b;font-size:.85rem}
    .meta .v{font-weight:800;color:var(--ink-2)}

    .body{padding:22px 24px}
    h3.sec{margin:18px 0 10px;font-size:1.05rem;color:var(--ink-2);letter-spacing:.2px}
    .divider{height:1px;background:var(--line);margin:16px 0}

    /* Section cards */
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 6px 22px rgba(2,6,23,.05)}
    .card.headed{padding:0}
    .card.headed .card-h{padding:12px 16px;background:linear-gradient(180deg,#faf5ff,#fffbeb);border-bottom:1px solid var(--line);
      display:flex;align-items:center;gap:10px}
    .card.headed .card-h .dot{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    .card.headed .card-b{padding:16px}

    /* Key-value grid */
    .grid{display:grid;gap:12px}
    .two{grid-template-columns:repeat(2,minmax(0,1fr))}
    .three{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:760px){.two,.three{grid-template-columns:1fr}}
    .kv{display:grid;grid-template-columns:220px 1fr;gap:10px;align-items:start}
    .k{color:#64748b;font-weight:700}
    .v{font-weight:700;color:var(--ink)}

    /* Pills & chips */
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:800;font-size:.85rem;
      border:1px solid var(--line)}
    .pill.green{background:#ecfdf5;color:#065f46;border-color:#a7f3d0}
    .pill.red{background:#fef2f2;color:#7f1d1d;border-color:#fecaca}
    .pill.amber{background:#fffbeb;color:#7c2d12;border-color:#fde68a}
    .pill.gray{background:#f3f4f6;color:#374151}

    .chip{display:inline-block;background:var(--chip);color:var(--chip-text);border:1px solid var(--line);border-radius:999px;
      padding:6px 10px;margin:6px 8px 0 0;font-weight:700;font-size:.88rem}

    /* Table */
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    th,td{padding:12px 14px;border-bottom:1px solid var(--line);vertical-align:top}
    th{background:#fafafa;color:#0f172a;font-weight:800}
    tr:nth-child(even) td{background:#fbfcff}
    tr:last-child td{border-bottom:none}

    /* Badges */
    .badge{display:inline-flex;align-items:center;gap:10px;border-radius:12px;padding:10px 12px;
      background:linear-gradient(180deg,#f5f3ff,#fffbeb);border:1px solid #e9d5ff;font-weight:800}
    .badge .s{color:#6b21a8}
    .badge .v{color:#92400e}

    /* Notes */
    .note{background:var(--soft);border:1px dashed var(--line);border-radius:12px;padding:12px;margin-top:12px;color:#334155}
    .muted{color:#6b7280}

    /* Footer */
    .foot{padding:14px 24px;border-top:1px solid var(--line);display:flex;justify-content:space-between;color:#6b7280;font-size:.9rem}

    /* Print */
    @media print{
      body{background:#fff}
      .wrap{margin:0;padding:0}
      .doc{box-shadow:none;border:none}
      .head::before{height:6px}
      .badge{filter:grayscale(.1)}
    }
  </style>
  </head>
  <body>
    <div class="wrap">
      <div class="doc">
        <div class="head">
          <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div>
              <div class="title">HD HeeD — Referral Summary</div>
              <div class="subtitle">Structured overview for triage & onboarding</div>
            </div>
          </div>
          <div class="meta">
            <div class="k">Generated</div>
            <div class="v">${esc(dt)}</div>
          </div>
        </div>

        <div class="body">
          <!-- Consent banner -->
          <div class="badge">
            <span class="s">Initial consent:</span> <span class="v">${esc(yn("consent"))}</span>
            <span class="s" style="margin-left:10px">Final consent:</span>
            <span class="v">${state.referral_consent?"Ticked":"Not ticked"}</span>
          </div>

          <!-- Participant -->
          <h3 class="sec">Participant</h3>
          <div class="card">
            <div class="grid two">
              <div class="kv"><div class="k">Name / DOB</div><div class="v">${v((state.participant_fname||"")+" "+(state.participant_lname||""))} · ${v(state.dob)}</div></div>
              <div class="kv"><div class="k">NDIS / Gender</div><div class="v">${v(state.ndis_number)} · ${v(yn("gender"))}</div></div>
              <div class="kv"><div class="k">Address</div><div class="v">${v(addr)}</div></div>
              <div class="kv"><div class="k">Contacts</div><div class="v">${v(state.home_phone)}${state.home_phone&&state.participant_mobile?" · ":""}${v(state.participant_mobile)}${state.participant_email?" · ":""}${v(state.participant_email)}</div></div>
              <div class="kv"><div class="k">Language / Interpreter</div><div class="v">${v(state.language)} · ${v(yn("interpreter"))}${state.interpreter_type?` · ${v(state.interpreter_type)}`:""}</div></div>
            </div>
          </div>

          <!-- Referrer & NOK -->
          <div class="divider"></div>
          <div class="grid two">
            <div class="card headed">
              <div class="card-h"><span class="dot"></span><strong>Referrer</strong></div>
              <div class="card-b">
                <div class="grid">
                  <div class="kv"><div class="k">Name / Relationship</div><div class="v">${v(state.referrer_name)}${state.relationship?" · "+v(state.relationship):""}</div></div>
                  <div class="kv"><div class="k">Contact</div><div class="v">${v(state.email)}${state.phone?" · ":""}${v(state.phone)}${state.mobile?" · ":""}${v(state.mobile)}</div></div>
                </div>
              </div>
            </div>
            <div class="card headed">
              <div class="card-h"><span class="dot"></span><strong>Primary Carer (NOK)</strong></div>
              <div class="card-b">
                <div class="grid">
                  <div class="kv"><div class="k">Name / Relationship</div><div class="v">${v(state.carer_fname)} ${v(state.carer_lname)}${state.carer_relationship?" · "+v(state.carer_relationship):""}</div></div>
                  <div class="kv"><div class="k">Contacts</div><div class="v">${v(state.carer_home)}${state.carer_mobile?" · ":""}${v(state.carer_mobile)}${state.carer_email?" · ":""}${v(state.carer_email)}</div></div>
                  <div class="kv"><div class="k">Shared care / custody</div><div class="v">${v(yn("custody"))}</div></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Risks -->
          <div class="divider"></div>
          <h3 class="sec">Safety & Immediate Risks</h3>
          <div class="card">
            <table>
              <thead><tr><th style="width:40%">Domain</th><th style="width:25%">Status</th><th>Notes</th></tr></thead>
              <tbody>
                <tr><td>Recent fall</td><td>${pill(yn("recent_fall"))}</td><td rowspan="5">${v(state.risk_notes)}</td></tr>
                <tr><td>Wound / post-op care</td><td>${pill(yn("wound"))}</td></tr>
                <tr><td>Uncontrolled pain</td><td>${pill(yn("uncontrolled_pain"))}</td></tr>
                <tr><td>Pressure injury risk</td><td>${pill(yn("pressure_risk"))}</td></tr>
                <tr><td>Behaviours of concern</td><td>${pill(yn("behaviour_risk"))}</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Supports -->
          <div class="divider"></div>
          <h3 class="sec">Supports Requested</h3>
          <div class="card">
            <div class="grid two">
              <div class="kv"><div class="k">Main reason</div><div class="v">${v(state.key_area)}</div></div>
              <div class="kv"><div class="k">Service location</div><div class="v">${v(state.service_location)}</div></div>
            </div>
            <div style="margin-top:10px">
              <div class="k" style="margin-bottom:6px">Support list</div>
              ${chips(sup)}
            </div>
            <div style="margin-top:10px">
              <div class="k" style="margin-bottom:6px">Allergies</div>
              <div class="v">${v(yn("allergies"))}${state.allergy_list?` · ${v(state.allergy_list)}`:""}</div>
            </div>
          </div>

          <!-- Funding -->
          <div class="divider"></div>
          <h3 class="sec">Funding & Plan</h3>
          <div class="card">
            <div class="grid two">
              <div class="kv"><div class="k">Plan management</div><div class="v">${v(yn("plan_managed"))}</div></div>
              <div class="kv"><div class="k">Funding notes</div><div class="v">${v(state.funding_area)}</div></div>
            </div>
            <div class="note">This summary is auto-generated from the referral form for intake triage. Confirm details at first contact and update in ShiftCare / EHR accordingly.</div>
          </div>
        </div>

        <div class="foot">
          <div>HD HeeD Pty Ltd · ABN 47 665 228 768</div>
          <div>info@hdheed.com.au · ndis@hdheed.com.au</div>
        </div>
      </div>
    </div>
  </body></html>`;
}



    function submitOnline(){
      if(state.consent!=="yes"){ alert("Consent (Step 1) is required to submit."); go(0); return; }
      if(!state.referral_consent){ alert("Please tick the final consent box on the Review step before submitting."); go(7); return; }

      const form = document.getElementById('silentPost');
      if(!form){ alert("Submit form not found."); return; }

      Array.from(form.querySelectorAll('input[name]:not([type=hidden]), textarea, select')).forEach(el => el.remove());

      const add = (name, value) => { const i=document.createElement('input'); i.type='hidden'; i.name=name; i.value=(value==null?'':String(value)); form.appendChild(i); };

      form.querySelector('input[name="_subject"]').value =
        `HD HeeD Referral — ${(state.participant_fname||'').trim()} ${(state.participant_lname||'').trim()}`;

      add('_cc', 'info@hdheed.com.au,ndis@hdheed.com.au');

      add('summary', buildSummaryPlain());
      add('summary_html', buildSummaryHTML());

      const names=[
        'referrer_name','relationship','email','phone','mobile',
        'participant_fname','participant_lname','dob','ndis_number',
        'street','suburb','city','postcode','participant_mobile','participant_email',
        'language','interpreter','interpreter_type',
        'carer_fname','carer_lname','carer_relationship','carer_mobile','carer_email',
        'recent_fall','wound','uncontrolled_pain','pressure_risk','behaviour_risk','risk_notes',
        'key_area','service_location','allergies','allergy_list',
        'plan_managed','funding_area','referral_consent'
      ];
      names.forEach(n=> add(n, state[n]));

      add('supports_selected', pickSupports());

      form.submit();
    }

    function downloadReportHTML(){
      const blob = new Blob([buildSummaryHTML()], {type:"text/html"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `HDHeeD_Referral_${(state.participant_fname||'')}_${(state.participant_lname||'')}.html`.replace(/\s+/g,'');
      a.click();
    }

    init();
  </script>
</body>
</html>
