<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>HD HeeD • Mat’s Intake Trainer (Training)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#0b0f1a">
<style>
  :root{
    --bg:#0b0f1a; --panel:#10172a; --panel2:#0d1428; --ink:#e7ebff; --muted:#a9b4d1;
    --brand:#6d5bff; --accent:#ffcc33; --ok:#22c55e; --info:#38bdf8; --line:#243153;
    --good:#1ad1a5; --select:#2b3c6b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 800px at 80% -20%,#1b2350,transparent),var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  a{color:#a7c5ff;text-decoration:none}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0d1324,#0b0f1a);border-bottom:1px solid #18203a}
  header .inner{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,#5f4bff,#7f6cff);display:grid;place-items:center;color:#fff;font-weight:900}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{appearance:none;border:none;border-radius:999px;padding:10px 14px;min-height:40px;font-weight:800;cursor:pointer}
  .btn.primary{background:var(--accent);color:#0b0f1a;box-shadow:0 6px 18px rgba(255,204,51,.25)}
  .btn.ghost{background:#141c36;color:#e7ebff;border:1px solid #27335a}
  .btn.success{background:var(--good);color:#062a22}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  main{max-width:1200px;margin:0 auto;padding:18px;display:grid;gap:18px;grid-template-columns:2fr 1fr}
  @media (max-width:960px){ main{grid-template-columns:1fr} }
  .card{background:linear-gradient(180deg,var(--panel),#0b0f1a);border:1px solid #18203a;border-radius:18px;box-shadow:0 30px 100px rgba(0,0,0,.35)}
  .stage-head{padding:12px 14px;border-bottom:1px solid #18203a;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid #2a3b68;background:#101a3a;padding:8px 12px;border-radius:999px;color:#c9d4ff;min-height:36px}
  .meter{height:12px;background:#141a2e;border-radius:999px;border:1px solid #223059;overflow:hidden;flex:1;min-width:160px}
  .meter>div{height:100%;background:linear-gradient(90deg,#ffcc33,#ffd95c);width:0%;transition:width .4s ease}
  .lifelines{display:flex;gap:8px}
  .stage-body{padding:16px;display:grid;gap:14px}
  .host{display:flex;gap:12px;align-items:flex-start}
  .avatar{width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,#5f4bff,#8a79ff);display:grid;place-items:center;font-weight:900;color:#fff;box-shadow:0 8px 28px rgba(109,91,255,.35)}
  .bubble{flex:1;background:var(--panel2);border:1px solid #27335a;border-radius:14px;padding:14px;line-height:1.55}
  .question{font-size:19px;font-weight:900}
  .whyneed{display:grid;gap:10px}
  .why, .need{border-left:3px solid var(--info);background:#0f1937;border:1px solid #243153;border-radius:8px;padding:10px}
  .why strong,.need strong{color:#9bd4ff}
  .choices{display:grid;gap:12px}
  .choice{border:1px solid #2a3b68;background:linear-gradient(180deg,#121a3a,#0e1530);color:#e7ebff;border-radius:14px;padding:14px;cursor:pointer;text-align:left;position:relative}
  .choice:hover{box-shadow:0 10px 30px rgba(109,91,255,.18)}
  .choice .tag{position:absolute;right:12px;top:10px;font-size:12px;background:#0f254e;border:1px solid #2a3b68;color:#b9c9ff;border-radius:999px;padding:2px 8px}
  .choice.selected{outline:2px solid #ffd95c;box-shadow:0 0 0 6px rgba(255,217,92,.12)}
  .choice.recommended{border-color:#2e7a57}
  .coach{border:1px dashed #2a3b68;background:#0d1531;color:#bcd0ff;border-radius:12px;padding:12px}
  .sidebar{padding:14px;display:flex;flex-direction:column;gap:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .divider{height:1px;background:#27335a;margin:6px 0}
  .toast{position:fixed;right:16px;bottom:16px;background:#0b1220;color:#fff;padding:12px;border-radius:10px;box-shadow:0 18px 50px rgba(2,6,23,.4);display:none;z-index:20}
  .toast.show{display:block}
  .modal{position:fixed;inset:40px auto auto 50%;transform:translateX(-50%);max-width:920px;width:94%;background:#0b1022;border:1px solid #27335a;border-radius:16px;box-shadow:0 40px 120px rgba(0,0,0,.5);display:none;z-index:30}
  .modal .head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #27335a}
  .modal .body{padding:14px;max-height:70vh;overflow:auto;color:#e7ebff}
  .summary{display:none}
  @media print{
    header, .lifelines, .toolbar, .toast, .modal{display:none!important}
    main{grid-template-columns:1fr}
    .summary{display:block}
  }
  /* tiny debug overlay */
  .errorlog{position:fixed;left:16px;right:16px;bottom:16px;background:#2b0b0b;color:#fff;border:2px solid #ff6b6b;border-radius:10px;padding:12px;box-shadow:0 18px 50px rgba(2,6,23,.4);display:none;z-index:9999;white-space:pre-wrap}
</style>
</head>
<body>
<header>
  <div class="inner">
    <div class="brand">
      <div class="logo">HD</div>
      <div>
        <div style="font-weight:900;color:#e7ebff">Mat’s Intake Trainer — Intake & Funding Discovery</div>
        <div style="color:#9aa3bc;font-size:12px">KBC-style • No wrong answers • Coaching for every choice</div>
      </div>
    </div>
    <div class="toolbar">
      <button id="btnCoach" class="btn ghost" aria-pressed="true">Coach mode: On</button>
      <button id="btnPlan" class="btn ghost">Open mock plan</button>
      <button id="btnExportJSON" class="btn ghost">Export JSON</button>
      <button id="btnExportCSV" class="btn primary">Export CSV</button>
      <button id="btnPrint" class="btn success">Print Summary</button>
      <button id="btnReset" class="btn ghost">Reset</button>
    </div>
  </div>
</header>

<main>
  <!-- Stage -->
  <section class="card">
    <div class="stage-head">
      <div class="pill">XP: <span id="score">0</span></div>
      <div class="meter" aria-label="progress"><div id="bar"></div></div>
      <div class="lifelines">
        <button id="ll5050" class="btn ghost" title="Hide two non-recommended options">50:50</button>
        <button id="llHint" class="btn ghost" title="Show hint (why/what)">Hint</button>
      </div>
    </div>
    <div class="stage-body">
      <div class="host">
        <div class="avatar">M</div>
        <div class="bubble" id="matLine">
          Hello, this is <strong>Mat</strong> from <strong>HD HeeD</strong>, a registered NDIS provider. You’re in the right place — I’ll guide everything. You’ll see why I ask each question and exactly what I need. If you’re unsure, pick “Not sure” and I’ll handle the admin.
        </div>
      </div>

      <div class="whyneed" id="whyneedBox">
        <div class="why"><strong>Why I’m asking:</strong> To tailor the call and capture the right details without overwhelming the caller.</div>
        <div class="need"><strong>What I need:</strong> Caller type, their role with the participant, and whether they can provide consent.</div>
      </div>

      <div class="question" id="questionText">Who’s calling today?</div>
      <div class="choices" id="choices"></div>
      <div class="coach" id="coachBox" style="display:none"></div>
    </div>
  </section>

  <!-- Sidebar -->
  <aside class="card sidebar" aria-label="Live intake snapshot">
    <div class="row">
      <div class="pill">Caller: <span id="bCaller">—</span></div>
      <div class="pill">Consent: <span id="bConsent">?</span></div>
    </div>
    <div class="row">
      <div class="pill">Mgmt: <span id="bMgmt">—</span></div>
      <div class="pill">Plan dates: <span id="bDates">—</span></div>
    </div>
    <div class="row">
      <div class="pill">Category: <span id="bCat">—</span></div>
      <div class="pill">Urgency: <span id="bUrgency">—</span></div>
    </div>
    <div class="row">
      <div class="pill">Service: <span id="bService">—</span></div>
    </div>
    <div class="divider"></div>
    <div style="font-weight:900">Quick actions Mat will take</div>
    <ul id="actions" style="margin:0;padding-left:18px;line-height:1.5">
      <li>Draft short consent note (if needed)</li>
      <li>Confirm funding with PM/SC (if applicable)</li>
      <li>Propose roster windows that fit</li>
    </ul>
  </aside>
</main>

<!-- Mock plan modal -->
<div id="planModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="planTitle">
  <div class="head">
    <h3 id="planTitle" style="margin:0">Mock plan</h3>
    <button id="closePlan" class="btn ghost">Close</button>
  </div>
  <div class="body" id="planBody"></div>
</div>

<!-- Print Summary (auto-filled) -->
<section id="printable" class="summary card" style="padding:16px;margin:18px auto;max-width:900px">
  <h2 style="margin:6px 0 12px 0">HD HeeD — Intake Training Summary</h2>
  <div id="summaryBody" style="display:grid;gap:10px"></div>
</section>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
<div id="err" class="errorlog" role="alert"></div>

<script>
/* ===== Error overlay so any issue is visible ===== */
(function(){
  const box=document.getElementById('err');
  function show(msg){ box.textContent=msg; box.style.display='block'; }
  window.addEventListener('error', e=> show("Error: "+e.message+" @ "+(e.filename||'inline')+":"+e.lineno));
  window.addEventListener('unhandledrejection', e=> show("Promise rejection: "+(e.reason && e.reason.message ? e.reason.message : e.reason)));
})();

/* ===== State ===== */
const storeKey='hdheed_training_plus_v1';
let S = {
  i:0, xp:0, used5050:false, usedHint:false, coach:true,
  a:{ caller:null, consent:null, service:null, mgmt:null, dates:null, cat:null,
      risks:{beh:null, med:null, int:null}, urgency:null, contacts:null, rostering:null },
  transcript:[]
};
try{ const prev=JSON.parse(localStorage.getItem(storeKey)||'null'); if(prev) S=prev; }catch{}

/* ===== DOM ===== */
const matLine = document.getElementById('matLine');
const whyneedBox = document.getElementById('whyneedBox');
const questionText = document.getElementById('questionText');
const choicesEl = document.getElementById('choices');
const coachBox = document.getElementById('coachBox');
const scoreEl = document.getElementById('score');
const bar = document.getElementById('bar');
const toast = document.getElementById('toast');

const bCaller = document.getElementById('bCaller'), bConsent = document.getElementById('bConsent');
const bMgmt = document.getElementById('bMgmt'), bDates = document.getElementById('bDates');
const bCat = document.getElementById('bCat'), bUrgency = document.getElementById('bUrgency');
const bService = document.getElementById('bService');
const actionsEl = document.getElementById('actions');

/* ===== Utils ===== */
const save=()=>{ try{ localStorage.setItem(storeKey, JSON.stringify(S)); }catch{} };
const say=(t)=>{ S.transcript.push({t,ts:Date.now()}); save(); };
const flash=(m)=>{ toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1400); };
const pct=(n,d)=> Math.round((n/d)*100);
const o=(k,t,{set=()=>{},rec=false,coach=""}={})=>({k,t,set,rec,coach});
const ns=()=>o('NS','Not sure — please guide me',{coach:"Totally fine — I’ll mark this as TBC and handle the follow-up."});
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

/* ===== Copy blocks for WHY/NEED per step ===== */
const WHYNEED = {
  caller:  {why:"To tailor tone, authority to give consent, and next steps.", need:"Caller role (Participant/Carer/SC/PM/Clinician) so I know who I can email and what to confirm."},
  consent: {why:"So I can legally contact PM/SC and view plan/budget details.", need:"Verbal consent status (Yes/No/Not yet) and who gave it."},
  service: {why:"Maps to funding categories and worker skill mix.", need:"Primary support area now; we can refine later."},
  mgmt:   {why:"Determines who pays invoices and who I email first.", need:"NDIA-managed / Plan-managed / Self-managed / Not sure."},
  dates:  {why:"Avoid planning beyond plan end; time reviews.", need:"Approx dates or if expiring soon/expired."},
  cat:    {why:"Pick most likely budget; we’ll verify before rostering.", need:"Initial category guess (Core/Capacity/Capital)."},
  risk_beh:{why:"Safety and staffing (e.g., 2:1, BSP strategies).", need:"Any behaviours of concern/BSP info."},
  risk_med:{why:"Clinical safety and RN oversight.", need:"Meds/clinical tasks (charts/authorisations)."},
  risk_int:{why:"Comfortable communication.", need:"Interpreter need/preferred language."},
  urgency:{why:"Capacity and start planning.", need:"How soon to commence."},
  contacts:{why:"Faster funding confirmation.", need:"Have SC/PM contact now or later?"},
  rostering:{why:"Match worker availability.", need:"General windows (AM/PM/Evening, weekdays/weekends)."},
  next:{why:"Convert intake to action.", need:"Pick the immediate admin step I’ll take."}
};

/* ===== Coach responses for choices (Mat explains each answer) ===== */
const FOLLOWUP = {
  caller: {
    A:"Great — I’ll keep admin light and do the lifting for you.",
    B:"Thanks — I’ll keep it simple and note anything you’re unsure of.",
    C:"Perfect — I’ll capture essentials aligned to goals and documentation.",
    D:"Thanks — I’ll request a budget snapshot and check PO needs.",
    E:"Appreciated — I’ll note clinical context and RN oversight.",
    NS:"No stress — I’ll guide you, and we can fill gaps later."
  },
  consent: {
    A:"Consent noted — I can now confirm budgets with PM/SC.",
    B:"All good — I’ll proceed with basics and send a consent prompt.",
    C:"We’ll keep going and park external contacts for now.",
    D:"Understood — I’ll stay within what you’re comfortable sharing.",
    NS:"I’ll treat it as ‘not yet’ and keep next steps internal."
  },
  service: {
    A:"Personal care typically maps to Core: ADL. We’ll tailor routines.",
    B:"Community access fits Core: Social & Community Participation.",
    C:"Clinical tasks align to Core: Community Nursing Care with RN input.",
    D:"Skill-building maps to Capacity: Improved Daily Living.",
    E:"Carer relief often funded from Core.",
    NS:"I’ll propose a safe start and verify funding fit."
  },
  mgmt: {
    A:"NDIA — I’ll confirm category/balance via SC/LAC.",
    B:"Plan-managed — I’ll request snapshot and PO requirements.",
    C:"Self-managed — I’ll confirm billing email/reference.",
    NS:"We’ll verify management by email on your behalf."
  },
  dates: {
    A:"Great — we’ll set a review reminder before expiry.",
    B:"Expiring soon — we’ll propose a short start plan now.",
    C:"I’ll confirm exact dates with your SC/PM.",
    D:"If expired, we’ll prep a plan-ready proposal while awaiting renewal.",
    NS:"We’ll mark dates TBC and proceed cautiously."
  },
  cat: {
    A:"ADL fits personal care/respite; we’ll keep notes clear.",
    B:"SCP suits outings/appointments and engagement.",
    C:"CNC covers clinical tasks; RN oversight as needed.",
    D:"IDL funds learning/assessment/training.",
    E:"Capital is AT/mods (not support hours) — noted.",
    NS:"We’ll verify the category before any roster starts."
  },
  risk_beh: {
    A:"We’ll follow BSP strategies and consider staffing levels.",
    B:"No behaviours flagged — we’ll still safety-check first visit.",
    C:"We’ll proceed cautiously and seek SC input.",
    D:"We can revisit later; initial roster stays conservative.",
    NS:"Recorded for follow-up; we’ll start safely."
  },
  risk_med: {
    A:"We’ll confirm charts/authorisations and RN oversight.",
    B:"Noted — update us if that changes.",
    C:"We’ll clarify before rostering clinical tasks.",
    D:"We can reassess later.",
    NS:"We’ll start with non-clinical tasks until confirmed."
  },
  risk_int: {
    A:"We’ll arrange an interpreter in your preferred language.",
    B:"Okay — confirm preferred communication channel.",
    C:"We’ll keep it TBC; interpreter available if helpful.",
    D:"We’ll check back later if needed.",
    NS:"Options kept open; comfort first."
  },
  urgency: {
    A:"Urgent start — we’ll propose an interim roster within 24–72h.",
    B:"Soon — plan start in 1–2 weeks; confirm team.",
    C:"Exploring options — I’ll outline choices and costs.",
    D:"Flexible — I’ll check back at a time that suits.",
    NS:"Timing TBC — we’ll try to hold a slot."
  },
  contacts: {
    A:"Excellent — that speeds budget confirmation.",
    B:"No problem — I’ll share a short email you can forward.",
    C:"Understood — I’ll proceed with what we have and circle back."
  },
  rostering: {
    A:"Morning windows noted — I’ll match suitable workers.",
    B:"Afternoons — I’ll look for consistent PM availability.",
    C:"Evenings — we’ll factor fatigue and night routines.",
    D:"Weekends only — we’ll check penalty rates/budget impact.",
    E:"Flexible — that increases match speed.",
    NS:"We’ll propose practical windows after checking capacity."
  },
  next: {
    A:"I’ll email the Plan Manager for a snapshot and PO details.",
    B:"I’ll email the Support Coordinator for funding confirmation.",
    C:"I’ll confirm billing details for self-managed.",
    D:"Let’s review the mock plan together.",
    E:"I’ll draft a start plan and follow up shortly.",
    NS:"I’ll handle the right admin step and loop you in."
  }
};

/* ===== Steps: each with Mat line, WHY/NEED, options (no wrong answers) ===== */
function stepCaller(){ return {
  id:'caller',
  mat:"Who am I speaking with today? I’ll tailor the admin to your role and keep this simple.",
  q:"Who’s calling today?",
  why:WHYNEED.caller.why, need:WHYNEED.caller.need,
  options:[
    o('A',"Participant",{set:()=>S.a.caller='Participant',rec:true,coach:FOLLOWUP.caller.A}),
    o('B',"Family member / Carer",{set:()=>S.a.caller='Carer',coach:FOLLOWUP.caller.B}),
    o('C',"Support Coordinator",{set:()=>S.a.caller='Support Coordinator',rec:true,coach:FOLLOWUP.caller.C}),
    o('D',"Plan Manager",{set:()=>S.a.caller='Plan Manager',coach:FOLLOWUP.caller.D}),
    o('E',"Health Professional",{set:()=>S.a.caller='Health Professional',coach:FOLLOWUP.caller.E}),
    ns()
  ], next:'consent'
};}
function stepConsent(){ return {
  id:'consent',
  mat:"Before I contact any PM/SC, can I note verbal consent? You can say not yet — I’ll adapt.",
  q:"Consent to collect details and contact PM/SC if needed?",
  why:WHYNEED.consent.why, need:WHYNEED.consent.need,
  options:[
    o('A',"Yes, verbal consent",{set:()=>S.a.consent='Yes',rec:true,coach:FOLLOWUP.consent.A}),
    o('B',"Not yet",{set:()=>S.a.consent='Not yet',coach:FOLLOWUP.consent.B}),
    o('C',"Not sure",{set:()=>S.a.consent='Not sure',coach:FOLLOWUP.consent.C}),
    o('D',"No",{set:()=>S.a.consent='No',coach:FOLLOWUP.consent.D}),
    ns()
  ], next:'service'
};}
function stepService(){ return {
  id:'service',
  mat:"Which support fits best right now? If you’re unsure, I’ll suggest a safe starting point.",
  q:"Support area needed now:",
  why:WHYNEED.service.why, need:WHYNEED.service.need,
  options:[
    o('A',"Personal care (morning/evening)",{set:()=>S.a.service='Personal care',rec:true,coach:FOLLOWUP.service.A}),
    o('B',"Community participation (outings/appointments)",{set:()=>S.a.service='Community participation',rec:true,coach:FOLLOWUP.service.B}),
    o('C',"Nursing care (wound/medication/health)",{set:()=>S.a.service='Nursing care',rec:true,coach:FOLLOWUP.service.C}),
    o('D',"Daily living skills (cooking/budgeting)",{set:()=>S.a.service='Daily living skills',rec:true,coach:FOLLOWUP.service.D}),
    o('E',"Respite / carer relief",{set:()=>S.a.service='Respite',rec:true,coach:FOLLOWUP.service.E}),
    ns()
  ], next:'mgmt'
};}
function stepMgmt(){ return {
  id:'mgmt',
  mat:"How is the NDIS plan managed? This only changes who I email first — not the support itself.",
  q:"Plan management type:",
  why:WHYNEED.mgmt.why, need:WHYNEED.mgmt.need,
  options:[
    o('A',"NDIA-managed",{set:()=>S.a.mgmt='NDIA-managed',rec:true,coach:FOLLOWUP.mgmt.A}),
    o('B',"Plan-managed",{set:()=>S.a.mgmt='Plan-managed',rec:true,coach:FOLLOWUP.mgmt.B}),
    o('C',"Self-managed",{set:()=>S.a.mgmt='Self-managed',rec:true,coach:FOLLOWUP.mgmt.C}),
    o('D',"Not sure",{set:()=>S.a.mgmt='Not sure',coach:FOLLOWUP.mgmt.NS}),
    ns()
  ], next:'dates'
};}
function stepDates(){ return {
  id:'dates',
  mat:"Do you know plan dates? Month/year is fine — I just avoid planning past the end date.",
  q:"Plan dates known?",
  why:WHYNEED.dates.why, need:WHYNEED.dates.need,
  options:[
    o('A',"Yes — active ~12 months",{set:()=>S.a.dates='Active 12m',rec:true,coach:FOLLOWUP.dates.A}),
    o('B',"Yes — expiring in 1–2 months",{set:()=>S.a.dates='Expiring soon',rec:true,coach:FOLLOWUP.dates.B}),
    o('C',"Not sure",{set:()=>S.a.dates='Not sure',coach:FOLLOWUP.dates.C}),
    o('D',"Plan has expired",{set:()=>S.a.dates='Expired',coach:FOLLOWUP.dates.D}),
    ns()
  ], next:'cat'
};}
function stepCategory(){
  const s=S.a.service||'';
  let recKey='A';
  if(/community/i.test(s)) recKey='B';
  if(/nursing/i.test(s)) recKey='C';
  if(/daily living/i.test(s)) recKey='D';
  return {
    id:'cat',
    mat:"Let’s pick the most likely budget category. We’ll verify with PM/SC before any roster.",
    q:"Likely funding category:",
    why:WHYNEED.cat.why, need:WHYNEED.cat.need,
    options:[
      o('A',"Core – Assistance with Daily Life",{set:()=>S.a.cat="Core – Assistance with Daily Life",rec:recKey==='A',coach:FOLLOWUP.cat.A}),
      o('B',"Core – Social & Community Participation",{set:()=>S.a.cat="Core – Social & Community Participation",rec:recKey==='B',coach:FOLLOWUP.cat.B}),
      o('C',"Core – Community Nursing Care",{set:()=>S.a.cat="Core – Community Nursing Care",rec:recKey==='C',coach:FOLLOWUP.cat.C}),
      o('D',"Capacity – Improved Daily Living",{set:()=>S.a.cat="Capacity – Improved Daily Living",rec:recKey==='D',coach:FOLLOWUP.cat.D}),
      o('E',"Capital (AT/Home Mods)",{set:()=>S.a.cat="Capital (AT/Home Mods)",coach:FOLLOWUP.cat.E}),
      ns()
    ], next:'risk_beh'
  };
}
function stepRisk(key,label,block){ return {
  id:block,
  mat:"Quick safety check so we roster safely. Answer what you can — I’ll do the rest.",
  q: label,
  why:WHYNEED[block].why, need:WHYNEED[block].need,
  options:[
    o('A',"Yes",{set:()=>S.a.risks[key]=true,rec:true,coach:FOLLOWUP[block].A}),
    o('B',"No",{set:()=>S.a.risks[key]=false,coach:FOLLOWUP[block].B}),
    o('C',"Not sure",{set:()=>S.a.risks[key]=null,coach:FOLLOWUP[block].C}),
    o('D',"Prefer not to say",{set:()=>S.a.risks[key]=null,coach:FOLLOWUP[block].D}),
    ns()
  ], next: block==='risk_beh' ? 'risk_med' : block==='risk_med' ? 'risk_int' : 'urgency'
};}
function stepUrgency(){ return {
  id:'urgency',
  mat:"How quickly would you like to start? I’ll be upfront about capacity and keep you updated.",
  q:"Start urgency:",
  why:WHYNEED.urgency.why, need:WHYNEED.urgency.need,
  options:[
    o('A',"Urgent (24–72h)",{set:()=>S.a.urgency='Urgent',rec:true,coach:FOLLOWUP.urgency.A}),
    o('B',"Soon (1–2 weeks)",{set:()=>S.a.urgency='Soon',rec:true,coach:FOLLOWUP.urgency.B}),
    o('C',"Exploring options",{set:()=>S.a.urgency='Exploring',coach:FOLLOWUP.urgency.C}),
    o('D',"Not sure",{set:()=>S.a.urgency='Not sure',coach:FOLLOWUP.urgency.D}),
    ns()
  ], next:'contacts'
};}
function stepContacts(){ return {
  id:'contacts',
  mat:"Do you have your Support Coordinator or Plan Manager’s contact? If not, I’ll give you a short email to forward.",
  q:"SC/PM contact details:",
  why:WHYNEED.contacts.why, need:WHYNEED.contacts.need,
  options:[
    o('A',"Yes — I have their email/phone",{set:()=>S.a.contacts='Have details now',rec:true,coach:FOLLOWUP.contacts.A}),
    o('B',"Not with me — send me a template to forward",{set:()=>S.a.contacts='Will forward template',coach:FOLLOWUP.contacts.B}),
    o('C',"No SC/PM / Not applicable",{set:()=>S.a.contacts='No SC/PM',coach:FOLLOWUP.contacts.C}),
    ns()
  ], next:'rostering'
};}
function stepRostering(){ return {
  id:'rostering',
  mat:"Let’s sketch preferred windows so I can match the right worker quickly.",
  q:"Preferred rostering windows:",
  why:WHYNEED.rostering.why, need:WHYNEED.rostering.need,
  options:[
    o('A',"Weekday mornings (7–11am)",{set:()=>S.a.rostering='Weekday AM',rec:true,coach:FOLLOWUP.rostering.A}),
    o('B',"Weekday afternoons (12–4pm)",{set:()=>S.a.rostering='Weekday PM',coach:FOLLOWUP.rostering.B}),
    o('C',"Evenings (5–9pm)",{set:()=>S.a.rostering='Evenings',coach:FOLLOWUP.rostering.C}),
    o('D',"Weekends only",{set:()=>S.a.rostering='Weekends',coach:FOLLOWUP.rostering.D}),
    o('E',"Flexible windows",{set:()=>S.a.rostering='Flexible',rec:true,coach:FOLLOWUP.rostering.E}),
    ns()
  ], next:'next'
};}
function stepNext(){
  const m=S.a.mgmt||''; let rec='A';
  if(/NDIA/i.test(m)) rec='B'; if(/Self/i.test(m)) rec='C';
  return {
    id:'next',
    mat:"Great — I’ll take the next admin step so you don’t have to chase anything.",
    q:"Best next action:",
    why:WHYNEED.next.why, need:WHYNEED.next.need,
    options:[
      o('A',"Email Plan Manager for budget snapshot/PO",{rec:rec==='A',coach:FOLLOWUP.next.A, set:()=>{}}),
      o('B',"Email Support Coordinator for category & balance",{rec:rec==='B',coach:FOLLOWUP.next.B, set:()=>{}}),
      o('C',"Confirm billing details (self-managed)",{rec:rec==='C',coach:FOLLOWUP.next.C, set:()=>{}}),
      o('D',"Open mock plan to review",{coach:FOLLOWUP.next.D, set:()=>openPlan()}),
      o('E',"Draft start plan & follow-up",{coach:FOLLOWUP.next.E, set:()=>{} }),
      ns()
    ], next:'wrap'
  };
}
function stepWrap(){ return {
  id:'wrap',
  mat:"That’s the initial intake complete — nice work. You can export or print your training run, then try another pathway.",
  q:"What next?",
  why:"Lock the learning with a tangible summary.", need:"Choose how you want to save or repeat.",
  options:[
    {k:'A',t:"Export JSON",set:()=>exportJSON(),rec:true,coach:"JSON includes all answers with timestamps."},
    {k:'B',t:"Export CSV",set:()=>exportCSV(),coach:"CSV is easy to review in Excel/Sheets."},
    {k:'C',t:"Print summary",set:()=>printSummary(),coach:"Creates a printable intake snapshot."},
    {k:'D',t:"Open mock plan again",set:()=>openPlan(),coach:"Reinforce category/budget understanding."},
    {k:'E',t:"Restart training",set:()=>{localStorage.removeItem(storeKey); location.reload();},coach:"Start fresh with a new path."}
  ]
};}

/* ===== Build flow ===== */
const STEPS = [
  stepCaller(), stepConsent(), stepService(), stepMgmt(),
  stepDates(), stepCategory(),
  stepRisk('beh','Behaviours of concern / BSP?','risk_beh'),
  stepRisk('med','Medications or clinical tasks?','risk_med'),
  stepRisk('int','Interpreter required?','risk_int'),
  stepUrgency(), stepContacts(), stepRostering(),
  stepNext(), stepWrap()
];

/* ===== Rendering ===== */
function updateBadges(){
  bCaller.textContent = S.a.caller || '—';
  bConsent.textContent = S.a.consent || '?';
  bMgmt.textContent = S.a.mgmt || '—';
  bDates.textContent = S.a.dates || '—';
  bCat.textContent = S.a.cat || '—';
  bUrgency.textContent = S.a.urgency || '—';
  bService.textContent = S.a.service || '—';

  // dynamic quick actions
  const acts = [];
  if (S.a.consent!=='Yes') acts.push('Send consent template to caller');
  if (/Plan-managed/i.test(S.a.mgmt||'')) acts.push('Email Plan Manager for budget snapshot & PO');
  if (/NDIA/i.test(S.a.mgmt||'')) acts.push('Email Support Coordinator to confirm category/balance');
  if (/Self-managed/i.test(S.a.mgmt||'')) acts.push('Confirm billing email/reference with participant');
  if (S.a.rostering) acts.push('Propose roster windows: '+S.a.rostering);
  actionsEl.innerHTML = acts.length ? acts.map(a=>`<li>${a}</li>`).join('') : '<li>Review details and send next steps</li>';
}
function renderStep(){
  const step = STEPS[S.i] || STEPS[STEPS.length-1];
  matLine.innerHTML = step.mat;
  questionText.textContent = step.q;
  whyneedBox.innerHTML = `
    <div class="why"><strong>Why I’m asking:</strong> ${step.why||''}</div>
    <div class="need"><strong>What I need:</strong> ${step.need||''}</div>`;
  choicesEl.innerHTML = '';
  (step.options||[]).forEach(opt=>{
    const b = document.createElement('button');
    b.className='choice'+(opt.rec?' recommended':'');
    b.innerHTML = `<strong>${opt.k}.</strong> ${opt.t||opt.text||''}${opt.rec?'<span class="tag">Recommended</span>':''}`;
    b.addEventListener('click',()=>choose(opt, step, b));
    choicesEl.appendChild(b);
  });
  coachBox.style.display = S.coach ? 'block' : 'none';
  coachBox.innerHTML = S.coach ? '<em>Select an option to see Mat’s coaching.</em>' : '';
  scoreEl.textContent = S.xp;
  bar.style.width = pct(S.i, STEPS.length-1) + '%';
  updateBadges();
  save();
}
function choose(opt, step, btn){
  if (opt.set) opt.set();
  // select style (no wrong answers)
  [...choicesEl.children].forEach(el=>{ el.disabled=true; if (el===btn) el.classList.add('selected'); });
  // XP: recommended +10, else +8, Not sure +6
  const gain = opt.k==='NS' ? 6 : (opt.rec?10:8);
  S.xp += gain; scoreEl.textContent = S.xp;

  // Coaching text for this pick
  if (S.coach){
    coachBox.style.display='block';
    coachBox.innerHTML = opt.coach ? opt.coach : "Good pick — I’ll carry that forward.";
  } else {
    coachBox.style.display='none';
  }

  updateBadges(); save();

  // advance
  setTimeout(()=>{
    const nextId = step.next;
    const idx = STEPS.findIndex(s=>s.id===nextId);
    S.i = idx>=0 ? idx : Math.min(S.i+1, STEPS.length-1);
    renderStep();
  }, 950);
}

/* ===== Lifelines ===== */
let usedThisQ5050=false;
document.getElementById('ll5050').addEventListener('click', ()=>{
  if (S.used5050 || usedThisQ5050) return;
  const step = STEPS[S.i]; if (!step) return;
  const btns = Array.from(choicesEl.children);
  const nonRec = btns.filter((_,i)=>!step.options[i].rec && step.options[i].k!=='NS');
  shuffle(nonRec).slice(0, Math.max(0, nonRec.length-1)).forEach(el=> el.style.display='none');
  S.used5050 = true; usedThisQ5050 = true; save(); flash('50:50 used');
});
document.getElementById('llHint').addEventListener('click', ()=>{
  flash('Hint shown');
  if (!S.coach){ S.coach = true; document.getElementById('btnCoach').setAttribute('aria-pressed','true'); document.getElementById('btnCoach').textContent='Coach mode: On'; }
  coachBox.style.display='block';
  coachBox.innerHTML = "<strong>Hint:</strong> Consent → Management → Category. ‘Not sure’ is safe — I’ll confirm the rest by email.";
  S.usedHint = true; save();
});

/* ===== Toolbar ===== */
document.getElementById('btnCoach').addEventListener('click', (e)=>{
  S.coach = !S.coach; e.currentTarget.setAttribute('aria-pressed', S.coach?'true':'false');
  e.currentTarget.textContent = S.coach ? 'Coach mode: On' : 'Coach mode: Off';
  coachBox.style.display = S.coach ? 'block' : 'none';
  save();
});
document.getElementById('btnReset').addEventListener('click', ()=>{ localStorage.removeItem(storeKey); location.reload(); });
document.getElementById('btnPrint').addEventListener('click', ()=> printSummary());

/* ===== Mock Plan Viewer ===== */
function planHTML({participant,dates,mgmt,contacts,budgets,goals,notes}){
  const rows = budgets.map(([label,total,used])=>{
    const avail=total-used, p=Math.round(avail/total*100);
    return `<tr><td>${label}</td><td>$${total.toLocaleString()}</td><td>$${used.toLocaleString()}</td><td>$${avail.toLocaleString()} <span style="color:#9aa3bc">(${p}% left)</span></td></tr>`;
  }).join('');
  return `
    <div><strong>Participant:</strong> ${participant}</div>
    <div><strong>Dates:</strong> ${dates}</div>
    <div><strong>Managed:</strong> ${mgmt}</}</div>
    <div><strong>Contacts:</strong> ${contacts}</div>
    <div style="height:1px;background:#27335a;margin:10px 0"></div>
    <table style="width:100%;border-collapse:collapse;color:#e7ebff">
      <thead><tr style="background:#0f1630"><th style="text-align:left;padding:10px">Category</th><th style="text-align:left;padding:10px">Total</th><th style="text-align:left;padding:10px">Used</th><th style="text-align:left;padding:10px">Available</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    <div style="height:1px;background:#27335a;margin:10px 0"></div>
    <div><strong>Goals:</strong> ${goals.join('; ')}</div>
    <div><strong>Notes:</strong> ${notes}</div>`;
}
const plans = {
  pm_core: {title:"Plan-managed • Core ADL", body: planHTML({
    participant:"A. T. • Parramatta NSW • NDIS 43…812",
    dates:"2025-03-01 → 2026-02-28",
    mgmt:"Plan-managed (BlueLeaf PM)",
    contacts:"PM: pm@blueleafpm.com.au • SC: sc@helpco.org.au",
    budgets:[["Core – Assistance with Daily Life",32000,9000],["Core – Social & Community Participation",8000,1000],["Capacity – Improved Daily Living",5000,500]],
    goals:["Live safely at home","Build routines and confidence"],
    notes:"Prefers female workers; mornings best."
  })},
  ndia_nursing: {title:"NDIA-managed • Community Nursing Care", body: planHTML({
    participant:"B. K. • Blacktown NSW • NDIS 10…553",
    dates:"2025-01-10 → 2025-12-31",
    mgmt:"NDIA-managed",
    contacts:"SC: case.manager@lwb.org.au",
    budgets:[["Core – Community Nursing Care",12000,4000],["Capacity – Improved Daily Living",6000,2500]],
    goals:["Manage health at home","Avoid readmissions"],
    notes:"Pressure injury history; RN oversight required."
  })},
  self_comm: {title:"Self-managed • Community Participation", body: planHTML({
    participant:"J. S. • Auburn NSW • NDIS 72…904",
    dates:"2025-06-01 → 2026-05-31",
    mgmt:"Self-managed",
    contacts:"Billing: js.bills@example.com",
    budgets:[["Core – Social & Community Participation",9000,1200]],
    goals:["Increase community engagement","Build transport confidence"],
    notes:"Prefers SMS; mornings due to anxiety."
  })}
};
function openPlan(){
  const planModal=document.getElementById('planModal'), planBody=document.getElementById('planBody');
  let p=plans.pm_core;
  if (/NDIA/i.test(S.a.mgmt||'')) p=plans.ndia_nursing;
  if (/Self/i.test(S.a.mgmt||'')) p=plans.self_comm;
  planBody.innerHTML = `<h3 style="margin-top:0;color:#e7ebff">${p.title}</h3>${p.body}`;
  planModal.style.display='block';
}
document.getElementById('btnPlan').addEventListener('click', openPlan);
document.getElementById('closePlan').addEventListener('click', ()=> document.getElementById('planModal').style.display='none');
window.addEventListener('keydown', e=>{ if (e.key==='Escape') document.getElementById('planModal').style.display='none'; });

/* ===== Export & Print ===== */
document.getElementById('btnExportJSON').addEventListener('click', exportJSON);
document.getElementById('btnExportCSV').addEventListener('click', exportCSV);
function exportJSON(){
  const payload = {xp:S.xp, answers:S.a, transcript:S.transcript, exportedAt:new Date().toISOString()};
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const a = Object.assign(document.createElement('a'), {href:URL.createObjectURL(blob), download:'hdheed-training.json'});
  document.body.appendChild(a); a.click(); a.remove();
}
function exportCSV(){
  const rows = [
    ['xp',S.xp],
    ['caller',S.a.caller||''],
    ['consent',S.a.consent||''],
    ['service',S.a.service||''],
    ['mgmt',S.a.mgmt||''],
    ['dates',S.a.dates||''],
    ['category',S.a.cat||''],
    ['risk_beh',S.a.risks.beh],
    ['risk_med',S.a.risks.med],
    ['risk_int',S.a.risks.int],
    ['urgency',S.a.urgency||''],
    ['contacts',S.a.contacts||''],
    ['rostering',S.a.rostering||'']
  ];
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:"text/csv"});
  const a = Object.assign(document.createElement('a'), {href:URL.createObjectURL(blob), download:'hdheed-training.csv'});
  document.body.appendChild(a); a.click(); a.remove();
}
function printSummary(){
  const body = document.getElementById('summaryBody');
  const yesNo = v => (v===true?'Yes':v===false?'No':(v??'—'));
  body.innerHTML = `
    <div><strong>Date:</strong> ${new Date().toLocaleString()}</div>
    <div style="height:1px;background:#27335a;margin:10px 0"></div>
    <div><strong>Caller:</strong> ${S.a.caller||'—'}</div>
    <div><strong>Consent:</strong> ${S.a.consent||'—'}</div>
    <div><strong>Service:</strong> ${S.a.service||'—'}</div>
    <div><strong>Management:</strong> ${S.a.mgmt||'—'}</div>
    <div><strong>Plan dates:</strong> ${S.a.dates||'—'}</div>
    <div><strong>Category (initial):</strong> ${S.a.cat||'—'}</div>
    <div><strong>Risks:</strong> Behaviours: ${yesNo(S.a.risks.beh)} • Clinical: ${yesNo(S.a.risks.med)} • Interpreter: ${yesNo(S.a.risks.int)}</div>
    <div><strong>Urgency:</strong> ${S.a.urgency||'—'}</div>
    <div><strong>Contacts:</strong> ${S.a.contacts||'—'}</div>
    <div><strong>Rostering windows:</strong> ${S.a.rostering||'—'}</div>
    <div style="height:1px;background:#27335a;margin:10px 0"></div>
    <div><strong>Next actions suggested:</strong>
      <ul>${actionsEl.innerHTML}</ul>
    </div>
  `;
  window.print();
}

/* ===== Boot ===== */
renderStep();
</script>
</body>
</html>
