<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>HD HeeD – Admin Training Simulator (NDIS intake & funding)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#512b8a">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="manifest" href="/site.webmanifest">
<style>
  :root{
    --bg:#f6f7fb; --ink:#0f172a; --muted:#64748b; --brand:#512b8a; --accent:#ffc107;
    --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --panel:#ffffff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
  a{color:#2563eb;text-decoration:none}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;z-index:3;background:#fff;border-bottom:1px solid #e5e7eb}
  header .inner{display:flex;align-items:center;justify-content:space-between;padding:10px 16px}
  .brand{display:flex;gap:10px;align-items:center}
  .brand .logo{width:36px;height:36px;border-radius:10px;background:#512b8a;color:#fff;font-weight:900;display:grid;place-items:center}
  .tag{display:inline-flex;gap:8px;align-items:center;background:#eaf2ff;border:1px solid #bfdbfe;color:#1e40af;border-radius:999px;padding:6px 10px;font-weight:800;font-size:12px}
  .grid{display:grid;gap:16px}
  .two{grid-template-columns:2fr 1fr}
  @media (max-width: 960px){.two{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid #e5e7eb;border-radius:16px;padding:16px}
  h1{font-size:clamp(20px,3.5vw,28px);margin:8px 0}
  h2{font-size:clamp(18px,3vw,24px);margin:10px 0}
  .muted{color:var(--muted)}
  .scenario-list{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (max-width:720px){.scenario-list{grid-template-columns:1fr}}
  .scenario{border:1px solid #e5e7eb;border-radius:14px;padding:12px;cursor:pointer;background:#fff}
  .scenario:hover{box-shadow:0 18px 40px rgba(2,6,23,.08);transform:translateY(-2px)}
  .scenario h3{margin:4px 0;color:var(--brand)}
  .scenario .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
  .chip{background:#f1f5f9;border:1px solid #e2e8f0;color:#0f172a;border-radius:999px;padding:3px 8px;font-size:12px}
  .btn{appearance:none;border:none;background:#512b8a;color:#fff;font-weight:900;padding:12px 16px;border-radius:10px;cursor:pointer;min-height:44px}
  .btn.secondary{background:#0b1220}
  .btn.ghost{background:#eef2f7;color:#0f172a}
  .btn.warn{background:#f59e0b}
  .btn.ok{background:#22c55e}
  .btn-row{display:flex;gap:10px;flex-wrap:wrap}
  .step{display:none}
  .step.active{display:block;animation:fade .25s ease}
  @keyframes fade{from{opacity:.4;transform:translateY(6px)}to{opacity:1;transform:none}}
  .q{font-weight:900}
  .options{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
  .opt{padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;cursor:pointer}
  .opt[aria-pressed="true"]{border-color:#2563eb;box-shadow:0 0 0 4px #dbeafe}
  .inline{display:flex;gap:8px;flex-wrap:wrap}
  .field{display:flex;flex-direction:column;gap:6px;margin:6px 0}
  input,textarea,select{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
  textarea{min-height:100px}
  .hint{background:#f8fafc;border:1px dashed #e5e7eb;color:#334155;border-radius:12px;padding:12px;margin-top:12px}
  .hint strong{color:#0f172a}
  .inline-badges{display:flex;gap:8px;flex-wrap:wrap}
  .badge{display:inline-flex;gap:6px;align-items:center;border-radius:999px;padding:4px 10px;border:1px solid #e5e7eb}
  .badge.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
  .badge.warn{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
  .badge.danger{background:#fef2f2;border-color:#fecaca;color:#991b1b}
  .sticky-bottom{position:sticky;bottom:8px;z-index:2}
  .score{font-weight:900}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .small{font-size:12px;color:#64748b}
  .kvd{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .pill{padding:8px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff}
  .right{justify-self:end}
  .divider{height:1px;background:#e5e7eb;margin:10px 0}
  .toast{position:fixed;right:16px;bottom:16px;background:#0b1220;color:#fff;padding:10px 12px;border-radius:8px;box-shadow:0 12px 30px rgba(2,6,23,.35);display:none}
  .toast.show{display:block;animation:fade .25s ease}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
<header>
  <div class="inner container">
    <div class="brand">
      <div class="logo">HD</div>
      <div>
        <div style="font-weight:900">HD HeeD – Admin Training Simulator</div>
        <div class="small">NDIS intake, plan review, and funding checks • Practice mode</div>
      </div>
    </div>
    <div class="inline">
      <button id="btnReset" class="btn ghost">Reset progress</button>
      <button id="btnExportJSON" class="btn secondary">Export JSON</button>
      <button id="btnExportCSV" class="btn">Export CSV</button>
    </div>
  </div>
</header>

<main class="container grid two">
  <!-- LEFT: Training flow -->
  <section class="card">
    <div id="introStep" class="step active">
      <h1>Pick a scenario to start</h1>
      <p class="muted">Each pathway asks one question at a time and adapts based on your answers. Use “Not sure” to keep momentum—just like a real intake.</p>

      <div id="scenarioList" class="scenario-list"></div>
      <div class="hint">
        <strong>Tip:</strong> You can open the <em>mock plan</em> at any time during a scenario to check dates, budgets, and goals (like a real call).
      </div>
    </div>

    <!-- Dynamic stepper goes here -->
    <div id="stepper"></div>

    <div class="sticky-bottom">
      <div id="navBar" class="btn-row" style="display:none">
        <button id="prevBtn" class="btn ghost">Back</button>
        <button id="nextBtn" class="btn">Next</button>
        <button id="viewPlanBtn" class="btn warn right">View mock plan</button>
      </div>
    </div>
  </section>

  <!-- RIGHT: Guidance / tools -->
  <aside class="card" id="guide">
    <div class="kvd">
      <h2>Guidance & tools</h2>
      <button id="copyTemplateBtn" class="btn ghost right">Copy email template</button>
    </div>
    <div class="divider"></div>

    <div class="inline-badges" id="statusBadges">
      <!-- dynamic badges -->
    </div>

    <div id="guideBody" class="hint" style="margin-top:12px">
      Pick a scenario on the left to see step-by-step help, answer scripts, funding rules of thumb, and email templates to plan managers/support coordinators.
    </div>

    <div class="divider"></div>

    <h3>Quick email templates</h3>
    <details>
      <summary><strong>Plan manager – Budget snapshot request</strong></summary>
      <pre class="mono" id="tplPlanManager" style="white-space:pre-wrap">
Subject: Budget snapshot – [Initials, last 3 of NDIS]
Hi [Name],
With consent from [Participant], can you confirm available balance by category and whether a PO is needed?
We plan to commence [service] from [date] in [suburb].
Thanks, HD HeeD | 02 8630 5500 | info@hdheed.com.au
      </pre>
    </details>

    <details>
      <summary><strong>Support Coordinator / LAC – Funding confirmation</strong></summary>
      <pre class="mono" id="tplSC" style="white-space:pre-wrap">
Subject: Funding confirmation – [Participant]
With [Participant]’s consent, can you confirm active plan dates and the category/balance to fund [service] from [date]?
Thanks, HD HeeD
      </pre>
    </details>

    <details>
      <summary><strong>Self-managed – Invoice details confirmation</strong></summary>
      <pre class="mono" id="tplSM" style="white-space:pre-wrap">
Subject: Invoice details – [Participant]
Could you confirm the billing email, reference/PO (if any), and which category (e.g., Core – Assistance with Daily Life) you prefer us to use? We’ll invoice at/under NDIS limits.
Thanks, HD HeeD
      </pre>
    </details>
  </aside>
</main>

<!-- Mock Plan Modal -->
<div id="planModal" class="card" role="dialog" aria-modal="true" aria-labelledby="planTitle" style="display:none;position:fixed;inset:40px auto auto 50%;transform:translateX(-50%);max-width:860px;width:92%;z-index:4">
  <div class="kvd">
    <h2 id="planTitle">Mock Plan</h2>
    <button id="closePlanBtn" class="btn ghost right">Close</button>
  </div>
  <div class="divider"></div>
  <div id="planBody"></div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ===============================
   DATA: Scenarios & Mock Plans
================================*/
const scenarios = [
  {
    id: "pm_core_adl",
    title: "Plan-managed • Personal care (Core ADL) • Western Sydney",
    chips: ["Plan-managed","Core – ADL","Personal care","Capacity this week"],
    mockPlan: {
      participant: { name: "A. T.", dob: "1992-05-08", ndis: "43…812", address: "Parramatta NSW" },
      dates: { start: "2025-03-01", end: "2026-02-28" },
      management: "Plan-managed (BlueLeaf PM)",
      contacts: { planManager: "pm@blueleafpm.com.au", sc: "sc@helpco.org.au" },
      budgets: {
        core_adl: { label: "Core – Assistance with Daily Life", total: 32000, used: 9000 },
        core_scp: { label: "Core – Social & Community Participation", total: 8000, used: 1000 },
        cb_idl:   { label: "Capacity – Improved Daily Living", total: 5000, used: 500 }
      },
      goals: [
        "Live independently and safely at home",
        "Build daily routines and confidence"
      ],
      notes: "No allergies reported. Falls risk: low. Prefers female workers, morning shifts."
    },
    steps: [
      { key:"consent",   q:"Do you have verbal consent to collect details and contact the plan manager/support coordinator?", type:"choice",
        options:["Yes (verbal)","Not yet","Not sure – will confirm"], tip:"Always get verbal consent first. Note who gave it and when.",
        score:{yes:2,no:0} },
      { key:"mgmt",      q:"How is the plan managed?", type:"choice",
        options:["NDIA-managed","Plan-managed","Self-managed","Not sure"], tip:"Plan-managed → ask PM for budget snapshot; NDIA → ask SC/LAC; Self → confirm billing email and category.",
        correct:"Plan-managed" },
      { key:"dates",     q:"Plan dates?", type:"free",
        placeholder:"Start–End (rough is ok). E.g., Mar 2025 – Feb 2026",
        tip:"Don’t roster beyond the end date. You can proceed with month/year if exact dates unknown." },
      { key:"service",   q:"Primary support requested?", type:"choice",
        options:["Personal care – morning routines","Community access","Nursing (wound care)","Not sure"],
        tip:"For this scenario, personal care maps to Core – ADL." },
      { key:"category",  q:"Pick the likely funding category to start with", type:"choice",
        options:["Core – Assistance with Daily Life","Core – Social & Community Participation","Capacity – Improved Daily Living","Capital"],
        correct:"Core – Assistance with Daily Life",
        tip:"Personal care typically draws from Core – ADL. Confirm with PM and capture their email reply." },
      { key:"pm-email",  q:"Send the PM a budget snapshot request?", type:"choice",
        options:["Yes – send now","No – later","Not needed"], tip:"Ask for available balance and if a PO is required. Attach rough weekly hours." },
      { key:"risks",     q:"Any risks or alerts mentioned?", type:"multi",
        options:["Falls","Behaviours of concern","Allergies","Medications","Interpreter needed","None noted","Not sure"],
        tip:"Capture risks early. If complex, flag to clinical lead before rostering." },
      { key:"summary",   q:"Ready to propose a start plan?", type:"text",
        placeholder:"Draft a one-liner: what, how often, from when (e.g., 6h/week AM).",
        tip:"Mirror a goal from the plan in your summary to keep alignment clear." }
    ]
  },
  {
    id: "ndia_nursing",
    title: "NDIA-managed • Community nursing (wound care) • Blacktown",
    chips: ["NDIA-managed","Clinical","Wound care"],
    mockPlan: {
      participant: { name: "B. K.", dob: "1961-11-22", ndis: "10…553", address: "Blacktown NSW" },
      dates: { start: "2025-01-10", end: "2025-12-31" },
      management: "NDIA-managed",
      contacts: { sc: "case.manager@lwb.org.au" },
      budgets: {
        core_cnc: { label: "Core – Community Nursing Care", total: 12000, used: 4000 },
        cb_idl:   { label: "Capacity – Improved Daily Living", total: 6000, used: 2500 }
      },
      goals: ["Manage health safely at home", "Avoid hospital readmissions"],
      notes: "Pressure injury stage 2 history. RN oversight required. GP review monthly."
    },
    steps: [
      { key:"consent", q:"Consent to contact SC/LAC and view plan details?", type:"choice",
        options:["Yes (verbal)","Not yet","Not sure"], tip:"Record who gave consent and date/time." },
      { key:"mgmt", q:"Management type?", type:"choice",
        options:["NDIA-managed","Plan-managed","Self-managed","Not sure"], correct:"NDIA-managed",
        tip:"For NDIA-managed, confirm with SC/LAC before rostering." },
      { key:"service", q:"Requested service?", type:"choice",
        options:["Community nursing – wound care","Personal care","Community participation","Not sure"], correct:"Community nursing – wound care" },
      { key:"category", q:"Best initial category?", type:"choice",
        options:["Core – Community Nursing Care","Capacity – Improved Daily Living","Core – ADL","Capital"],
        correct:"Core – Community Nursing Care",
        tip:"Some plans use Capacity (IDL) for clinical assessment/training; ongoing wound care often from Core – CNC." },
      { key:"escalation", q:"Risk level & actions?", type:"multi",
        options:["RN oversight needed","Medication reconciliation","Manual handling plan","Infection prevention supplies","None","Not sure"],
        tip:"High clinical risk? Confirm RN cover and escalation path before start." },
      { key:"sc-email", q:"Send SC funding confirmation now?", type:"choice",
        options:["Yes – send now","No – later"], tip:"Ask for category/balance and note their reply in the file." },
      { key:"start", q:"Proposed start?", type:"text",
        placeholder:"E.g., RN wound care 2×/wk for 4 weeks, review in week 5.",
        tip:"Tie to goals: ‘Manage health safely at home; avoid readmissions.’" }
    ]
  },
  {
    id: "self_comm_access",
    title: "Self-managed • Community participation • Auburn",
    chips: ["Self-managed","Community","Transport"],
    mockPlan: {
      participant: { name: "J. S.", dob: "1999-09-06", ndis: "72…904", address: "Auburn NSW" },
      dates: { start: "2025-06-01", end: "2026-05-31" },
      management: "Self-managed",
      contacts: { billingEmail: "js.bills@example.com" },
      budgets: {
        core_scp: { label: "Core – Social & Community Participation", total: 9000, used: 1200 }
      },
      goals: ["Increase community engagement", "Build confidence in public transport"],
      notes: "Prefers SMS. Anxiety in busy places; morning outings better."
    },
    steps: [
      { key:"consent", q:"Consent to collect details and invoice directly?", type:"choice",
        options:["Yes (verbal)","Not yet","Not sure"], tip:"Confirm billing email and any invoice reference up front." },
      { key:"mgmt", q:"Management type?", type:"choice",
        options:["NDIA-managed","Plan-managed","Self-managed","Not sure"], correct:"Self-managed" },
      { key:"service", q:"Requested support?", type:"choice",
        options:["Community participation – outings","Personal care","Nursing","Not sure"], correct:"Community participation – outings" },
      { key:"category", q:"Likely category?", type:"choice",
        options:["Core – Social & Community Participation","Core – ADL","Capacity – IDL","Capital"],
        correct:"Core – Social & Community Participation",
        tip:"Self-managed can choose, but SCP is typical for outings." },
      { key:"billing", q:"Billing details captured?", type:"multi",
        options:["Billing email","Invoice reference/PO","Rates acknowledged (≤ NDIS limits)","Not sure"], tip:"Keep invoices simple and timely." },
      { key:"start", q:"Proposed start?", type:"text",
        placeholder:"E.g., 3h/week community outings; review at 4 weeks.",
        tip:"Confirm travel rules if transport involved." }
    ]
  },
  {
    id: "pm_behaviour_complex",
    title: "Plan-managed • Personal care + behaviours of concern • Penrith",
    chips: ["Plan-managed","Complex","Behaviour support"],
    mockPlan: {
      participant: { name: "K. R.", dob: "1988-02-17", ndis: "55…221", address: "Penrith NSW" },
      dates: { start: "2025-04-15", end: "2026-04-14" },
      management: "Plan-managed (CareFlow PM)",
      contacts: { planManager: "claims@careflowpm.com", sc: "sc@connectsc.org" },
      budgets: {
        core_adl: { label: "Core – Assistance with Daily Life", total: 38000, used: 7000 },
        cb_bsp:   { label: "Capacity – Behaviour Support", total: 5000, used: 1000 }
      },
      goals: ["Safer routines at home", "Reduce incidents during morning care"],
      notes: "Behaviour Support Plan in place. Two-worker mornings recommended."
    },
    steps: [
      { key:"consent", q:"Consent logged?", type:"choice",
        options:["Yes (verbal)","Not yet","Not sure"] },
      { key:"service", q:"Requested support?", type:"choice",
        options:["Personal care – two workers AM","Behaviour support practitioner","Community access","Not sure"], correct:"Personal care – two workers AM" },
      { key:"category", q:"Likely category for personal care?", type:"choice",
        options:["Core – Assistance with Daily Life","Capacity – Behaviour Support","Capacity – IDL","Capital"],
        correct:"Core – Assistance with Daily Life",
        tip:"Note BSP exists; care plan must reflect strategies; may require 2:1 ratio approval from PM." },
      { key:"risks", q:"Risk controls to line up before start?", type:"multi",
        options:["Two-worker roster","BSP reviewed with team","Incident reporting process","Escalation contact set","Not sure"] },
      { key:"pm-email", q:"Ask PM to confirm 2:1 coverage and budget?", type:"choice",
        options:["Yes – send now","No – later"] },
      { key:"start", q:"Proposed start?", type:"text",
        placeholder:"E.g., 2 workers x 1.5h each weekday mornings (trial 2 weeks), then review.",
        tip:"Tie to goal: safer routines; reduce incidents during morning care." }
    ]
  }
];

/* Utility: format money */
const money = n => "$" + Number(n).toLocaleString("en-AU", {maximumFractionDigits:0});

/* ===============================
   STATE
================================*/
const stateKey = "hdheed_admin_training_v1";
let state = {
  scenarioId: null,
  answers: {},   // { stepKey: value }
  history: [],   // step indices for back nav
  currentStep: 0
};

/* Restore from localStorage */
try{
  const prev = JSON.parse(localStorage.getItem(stateKey) || "{}");
  if (prev && prev.scenarioId) state = prev;
}catch{}

/* ===============================
   RENDER: Scenario list
================================*/
const scenarioList = document.getElementById("scenarioList");
function renderScenarios(){
  scenarioList.innerHTML = scenarios.map(s => `
    <button class="scenario" data-id="${s.id}">
      <h3>${s.title}</h3>
      <div class="chips">
        ${s.chips.map(c => `<span class="chip">${c}</span>`).join("")}
      </div>
      <div class="small" style="margin-top:6px">Includes mock plan, budgets & goals</div>
    </button>
  `).join("");
  scenarioList.querySelectorAll(".scenario").forEach(btn=>{
    btn.addEventListener("click",()=>{
      state.scenarioId = btn.dataset.id;
      state.answers = {};
      state.history = [];
      state.currentStep = 0;
      saveState();
      document.getElementById("introStep").style.display="none";
      renderStepper();
      updateGuide();
      flash("Scenario loaded. Work through the questions.");
    });
  });
}
renderScenarios();

/* ===============================
   RENDER: Stepper
================================*/
const stepper = document.getElementById("stepper");
const navBar = document.getElementById("navBar");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const viewPlanBtn = document.getElementById("viewPlanBtn");

function activeScenario(){
  return scenarios.find(s => s.id === state.scenarioId);
}
function currentSteps(){ return activeScenario()?.steps || []; }
function currentStepObj(){ return currentSteps()[state.currentStep]; }

function renderStepper(){
  const sc = activeScenario();
  if (!sc) return;
  navBar.style.display = "flex";
  stepper.innerHTML = "";
  const step = currentStepObj();
  if (!step) { renderComplete(); return; }

  const wrap = document.createElement("div");
  wrap.className = "step active";

  // Question
  const q = document.createElement("div");
  q.className = "q";
  q.textContent = step.q;
  wrap.appendChild(q);

  // Inputs
  const saved = state.answers[step.key];

  if (step.type === "choice"){
    const ops = document.createElement("div");
    ops.className = "options";
    step.options.forEach(opt=>{
      const b = document.createElement("button");
      b.className = "opt";
      b.type = "button";
      b.textContent = opt;
      if (saved === opt) b.setAttribute("aria-pressed","true");
      b.addEventListener("click",()=>{
        // toggle select
        state.answers[step.key] = opt;
        saveState();
        renderStepper();
        updateGuide();
      });
      ops.appendChild(b);
    });
    wrap.appendChild(ops);
  }

  if (step.type === "multi"){
    const ops = document.createElement("div");
    ops.className = "options";
    const current = Array.isArray(saved) ? new Set(saved) : new Set();
    step.options.forEach(opt=>{
      const b = document.createElement("button");
      b.className = "opt";
      b.type = "button";
      b.textContent = opt;
      if (current.has(opt)) b.setAttribute("aria-pressed","true");
      b.addEventListener("click",()=>{
        if (current.has(opt)) current.delete(opt); else current.add(opt);
        state.answers[step.key] = Array.from(current);
        saveState();
        renderStepper();
        updateGuide();
      });
      ops.appendChild(b);
    });
    wrap.appendChild(ops);
  }

  if (step.type === "text" || step.type === "free"){
    const field = document.createElement("div");
    field.className = "field";
    const ta = document.createElement(step.type === "text" ? "textarea" : "input");
    ta.placeholder = step.placeholder || "";
    ta.value = saved || "";
    ta.addEventListener("input",()=>{
      state.answers[step.key] = ta.value;
      saveState();
    });
    field.appendChild(ta);
    wrap.appendChild(field);
  }

  // Tip box
  if (step.tip){
    const tip = document.createElement("div");
    tip.className = "hint";
    tip.innerHTML = `<strong>Tip:</strong> ${step.tip}`;
    wrap.appendChild(tip);
  }

  // Correctness feedback (if defined)
  if (step.correct && saved){
    const ok = saved === step.correct;
    const fb = document.createElement("div");
    fb.className = "hint";
    fb.innerHTML = ok
      ? `<span class="badge ok">✔ Correct</span> Good pick for this scenario.`
      : `<span class="badge warn">⚠ Not ideal</span> In this scenario, <strong>${step.correct}</strong> fits best.`;
    wrap.appendChild(fb);
  }

  stepper.appendChild(wrap);

  // Nav buttons
  prevBtn.disabled = state.currentStep === 0;
  nextBtn.textContent = state.currentStep >= currentSteps().length - 1 ? "Finish" : "Next";
}
function renderComplete(){
  stepper.innerHTML = `
    <div class="step active">
      <h2>Great work — scenario completed</h2>
      <p class="muted">You can export your responses, switch scenarios, or reset and try again.</p>
      <div class="hint">
        <strong>Summary:</strong>
        <div id="summaryList" style="margin-top:8px"></div>
      </div>
      <div class="btn-row" style="margin-top:10px">
        <button id="btnSwitch" class="btn ghost">Switch scenario</button>
        <button id="btnRestart" class="btn">Restart scenario</button>
      </div>
    </div>
  `;
  const sl = document.getElementById("summaryList");
  sl.innerHTML = Object.entries(state.answers).map(([k,v])=>{
    const val = Array.isArray(v) ? v.join(", ") : v || "(blank)";
    return `<div><span class="mono">${k}</span>: ${val}</div>`;
  }).join("");
  document.getElementById("btnSwitch").addEventListener("click",()=>{
    document.getElementById("introStep").style.display="block";
    navBar.style.display="none";
    stepper.innerHTML = "";
  });
  document.getElementById("btnRestart").addEventListener("click",()=>{
    state.answers = {}; state.history = []; state.currentStep = 0; saveState(); renderStepper(); updateGuide();
  });
}

/* ===============================
   NAV
================================*/
prevBtn.addEventListener("click",()=>{
  if (state.currentStep>0){ state.currentStep--; saveState(); renderStepper(); updateGuide(); }
});
nextBtn.addEventListener("click",()=>{
  const steps = currentSteps();
  if (!steps.length) return;
  if (state.currentStep < steps.length - 1){
    state.currentStep++;
    saveState();
    renderStepper();
    updateGuide();
  } else {
    renderComplete();
    updateGuide();
  }
});

/* ===============================
   GUIDE PANE (dynamic tips/badges)
================================*/
const guideBody = document.getElementById("guideBody");
const statusBadges = document.getElementById("statusBadges");

function updateGuide(){
  const sc = activeScenario();
  statusBadges.innerHTML = "";
  if (!sc){ guideBody.textContent = "Pick a scenario to begin."; return; }

  // Status badges (consent, mgmt, category chosen)
  const a = state.answers;
  const badge = (txt, cls="") => `<span class="badge ${cls}">${txt}</span>`;
  if (a.consent?.startsWith("Yes")) statusBadges.innerHTML += badge("Consent ✔","ok");
  else statusBadges.innerHTML += badge("Consent?","warn");
  if (a.mgmt) statusBadges.innerHTML += badge("Mgmt: "+a.mgmt);
  if (a.category) statusBadges.innerHTML += badge("Category: "+a.category);

  // Contextual guidance text
  const step = currentStepObj();
  if (!step){ guideBody.innerHTML = `
    <div><strong>Scenario complete.</strong> Export your responses with the buttons above and debrief as a team.</div>
    <div class="divider"></div>
    <div><strong>Pro tips:</strong><ul>
      <li>Always keep the PM/SC email confirmation as budget proof.</li>
      <li>Tie your start plan to the participant’s goal wording.</li>
      <li>Don’t roster past the plan end date without assurance.</li>
    </ul></div>`; return; }

  // General guidance by step key
  const maps = {
    consent: `<strong>Consent:</strong> log who gave it, date/time. Without consent, restrict contacts to public information.`,
    mgmt: `<strong>Management type:</strong> Plan-managed → email PM for balance/PO; NDIA → ask SC/LAC; Self → confirm billing email and category.`,
    dates: `<strong>Plan dates:</strong> capture at least month/year. Set a reminder 4–6 weeks before expiry.`,
    service: `<strong>Service mapping:</strong> choose a plain-English label the caller used, then map to NDIS categories.`,
    category: `<strong>Funding category:</strong> Core (ADL/SCP) funds daily living & community; Capacity (IDL) funds assessments/therapy/training; Capital funds AT/home mods.`,
    "pm-email": `<strong>PM email:</strong> attach your proposed hours/frequency. Ask if PO needed.`,
    sc-email: `<strong>SC email:</strong> request category + balance confirmation for the start plan.`,
    risks: `<strong>Risks:</strong> falls/behaviour/allergies/meds/interpreter. Pull BSP or med charts if relevant before start.`,
    escalation: `<strong>Escalation:</strong> set RN cover, incident reporting flow, and contact numbers.`,
    billing: `<strong>Billing:</strong> for self-managed, confirm billing email and any reference; keep invoices simple & timely.`,
    summary: `<strong>Start plan:</strong> one line is enough: what, how often, from when, and which goal it serves.`,
    start: `<strong>Start plan:</strong> write a crisp proposal; book a review date in 4–6 weeks.`
  };
  guideBody.innerHTML = maps[step.key] || "Follow the prompt on the left and use the mock plan when needed.";

  // Add quick links to email templates depending on mgmt
  if (a.mgmt?.includes("Plan-managed")){
    guideBody.innerHTML += `<div class="divider"></div><div>Use the <em>Plan manager – Budget snapshot</em> template below.</div>`;
  }else if (a.mgmt?.includes("NDIA")){
    guideBody.innerHTML += `<div class="divider"></div><div>Use the <em>Support Coordinator – Funding confirmation</em> template below.</div>`;
  }else if (a.mgmt?.includes("Self")){
    guideBody.innerHTML += `<div class="divider"></div><div>Use the <em>Self-managed – Invoice details</em> template below.</div>`;
  }
}

/* ===============================
   PLAN MODAL
================================*/
const planModal = document.getElementById("planModal");
const planBody  = document.getElementById("planBody");
const viewPlanBtnEl = document.getElementById("viewPlanBtn");
const closePlanBtn = document.getElementById("closePlanBtn");
viewPlanBtnEl.addEventListener("click", ()=>{
  const sc = activeScenario(); if (!sc) return;
  const b = sc.mockPlan.budgets;
  const budgetRows = Object.values(b).map(v=>{
    const avail = v.total - v.used;
    const pct = Math.round(avail / v.total * 100);
    return `<tr><td>${v.label}</td><td>${money(v.total)}</td><td>${money(v.used)}</td><td>${money(avail)} <span class="small">(${pct}% left)</span></td></tr>`;
  }).join("");
  planBody.innerHTML = `
    <div class="grid" style="gap:8px">
      <div><strong>Participant:</strong> ${sc.mockPlan.participant.name} • ${sc.mockPlan.participant.address}</div>
      <div><strong>Dates:</strong> ${sc.mockPlan.dates.start} → ${sc.mockPlan.dates.end}</div>
      <div><strong>Managed:</strong> ${sc.mockPlan.management}</div>
      <div><strong>Contacts:</strong> ${Object.entries(sc.mockPlan.contacts).map(([k,v])=>`${k}: ${v}`).join(" • ")}</div>
    </div>
    <div class="divider"></div>
    <h3>Budgets</h3>
    <div class="card" style="padding:0">
      <table style="width:100%;border-collapse:collapse">
        <thead><tr style="background:#f8fafc"><th style="text-align:left;padding:10px">Category</th><th style="text-align:left;padding:10px">Total</th><th style="text-align:left;padding:10px">Used</th><th style="text-align:left;padding:10px">Available</th></tr></thead>
        <tbody>
          ${budgetRows}
        </tbody>
      </table>
    </div>
    <div class="divider"></div>
    <h3>Goals</h3>
    <ul>${sc.mockPlan.goals.map(g=>`<li>${g}</li>`).join("")}</ul>
    <div class="divider"></div>
    <h3>Notes</h3>
    <div class="hint">${sc.mockPlan.notes || "—"}</div>
  `;
  planModal.style.display="block";
});
closePlanBtn.addEventListener("click", ()=> planModal.style.display="none");

/* ===============================
   EXPORT & RESET
================================*/
function saveState(){ localStorage.setItem(stateKey, JSON.stringify(state)); }
function flash(msg){
  const t = document.getElementById("toast"); t.textContent = msg; t.classList.add("show");
  setTimeout(()=> t.classList.remove("show"), 1600);
}

document.getElementById("btnReset").addEventListener("click",()=>{
  localStorage.removeItem(stateKey);
  state = { scenarioId:null, answers:{}, history:[], currentStep:0 };
  stepper.innerHTML=""; document.getElementById("introStep").style.display="block"; navBar.style.display="none";
  updateGuide(); flash("Progress reset.");
});

function exportJSON(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = Object.assign(document.createElement("a"), { href: URL.createObjectURL(blob), download: "hdheed-training.json" });
  document.body.appendChild(a); a.click(); a.remove();
}
function toCSV(obj){
  const rows = Object.entries(obj.answers || {}).map(([k,v])=>{
    const val = Array.isArray(v) ? v.join("; ") : (v ?? "");
    return `"${obj.scenarioId}","${k}","${String(val).replace(/"/g,'""')}"`;
  });
  return "scenario,field,value\n" + rows.join("\n");
}
function exportCSV(){
  const blob = new Blob([toCSV(state)], {type:"text/csv"});
  const a = Object.assign(document.createElement("a"), { href: URL.createObjectURL(blob), download: "hdheed-training.csv" });
  document.body.appendChild(a); a.click(); a.remove();
}
document.getElementById("btnExportJSON").addEventListener("click", exportJSON);
document.getElementById("btnExportCSV").addEventListener("click", exportCSV);

/* Copy active template quick */
document.getElementById("copyTemplateBtn").addEventListener("click",()=>{
  const a = state.answers || {};
  let el = null;
  if (a.mgmt?.includes("Plan-managed")) el = document.getElementById("tplPlanManager");
  else if (a.mgmt?.includes("NDIA")) el = document.getElementById("tplSC");
  else if (a.mgmt?.includes("Self")) el = document.getElementById("tplSM");
  else el = document.getElementById("tplPlanManager");
  navigator.clipboard.writeText(el.textContent.trim()).then(()=> flash("Template copied"));
});

/* Init if a previous scenario existed */
if (state.scenarioId){
  document.getElementById("introStep").style.display="none";
  renderStepper();
  updateGuide();
}

/* Close modal on Escape */
window.addEventListener("keydown", e=>{ if (e.key==="Escape") planModal.style.display="none"; });
</script>
</body>
</html>
