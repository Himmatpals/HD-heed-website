<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>HD HeeD • Admin Conversation Simulator (NDIS Intake & Funding)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#512b8a">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="manifest" href="/site.webmanifest">
<style>
  :root{
    --bg:#f6f7fb; --panel:#ffffff; --ink:#0f172a; --muted:#64748b;
    --brand:#512b8a; --accent:#ffc107; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --bubble:#fff; --bubble2:#ebf5ff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
  a{color:#2563eb;text-decoration:none}
  header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid #e5e7eb}
  header .inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 16px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:36px;height:36px;border-radius:9px;background:#512b8a;color:#fff;display:grid;place-items:center;font-weight:900}
  .small{color:var(--muted);font-size:12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;font-weight:900;cursor:pointer;min-height:40px}
  .btn.primary{background:#512b8a;color:#fff}
  .btn.ghost{background:#edf2f7}
  .btn.warn{background:#f59e0b;color:#1f2937}
  .btn.ok{background:#22c55e;color:#062e12}
  main{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:16px;grid-template-columns:2fr 1fr}
  @media (max-width:960px){ main{grid-template-columns:1fr} }
  .card{background:var(--panel);border:1px solid #e5e7eb;border-radius:16px}
  .chat{display:flex;flex-direction:column;height:70vh;min-height:560px}
  .chat-head{padding:12px 14px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
  .chat-body{padding:16px;overflow:auto;display:flex;flex-direction:column;gap:10px}
  .chat-foot{padding:12px;border-top:1px solid #e5e7eb}
  .row{display:flex;gap:10px;align-items:flex-end}
  .bubble{max-width:80%;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:var(--bubble)}
  .agent .bubble{background:#f8f8ff;border-color:#e5e7eb}
  .caller{justify-content:flex-end}
  .caller .bubble{background:var(--bubble2);border-color:#cfe3ff}
  .chipbar{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer}
  .chip[aria-pressed="true"]{border-color:#2563eb;box-shadow:0 0 0 3px #dbeafe}
  .hint{background:#f8fafc;border:1px dashed #e5e7eb;border-radius:12px;padding:12px;color:#334155}
  .pane{padding:14px;display:flex;flex-direction:column;gap:12px}
  .badge{display:inline-flex;gap:6px;align-items:center;border:1px solid #e5e7eb;border-radius:999px;padding:4px 10px}
  .badge.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
  .badge.warn{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
  .badge.info{background:#eef2ff;border-color:#c7d2fe;color:#3730a3}
  .grid{display:grid;gap:10px}
  .two{grid-template-columns:1fr 1fr}
  .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
  textarea,input,select{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px}
  .toast{position:fixed;right:16px;bottom:16px;background:#0b1220;color:#fff;padding:10px 12px;border-radius:8px;box-shadow:0 12px 30px rgba(2,6,23,.35);display:none;z-index:10}
  .toast.show{display:block}
  .modal{position:fixed;inset:40px auto auto 50%;transform:translateX(-50%);max-width:920px;width:94%;background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 24px 80px rgba(2,6,23,.25);display:none;z-index:20}
  .modal .head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb}
  .modal .body{padding:14px;max-height:70vh;overflow:auto}
  .divider{height:1px;background:#e5e7eb;margin:10px 0}
</style>
</head>
<body>
<header>
  <div class="inner">
    <div class="brand">
      <div class="logo">HD</div>
      <div>
        <div style="font-weight:900">Admin Conversation Simulator</div>
        <div class="small">NDIS intake • plan review • funding check • consent • scenarios</div>
      </div>
    </div>
    <div class="toolbar">
      <button id="btnReset" class="btn ghost">Reset</button>
      <button id="btnExportJSON" class="btn">Export JSON</button>
      <button id="btnExportCSV" class="btn primary">Export CSV</button>
      <button id="btnPlan" class="btn warn">Open mock plan</button>
    </div>
  </div>
</header>

<main>
  <!-- Conversation / left -->
  <section class="card chat">
    <div class="chat-head">
      <strong>Live practice</strong>
      <span class="small">Tip: use “Not sure” to keep momentum (like real calls)</span>
    </div>
    <div id="chat" class="chat-body"></div>
    <div class="chat-foot">
      <div id="choices" class="chipbar"></div>
    </div>
  </section>

  <!-- Guidance / right -->
  <aside class="card pane">
    <div class="grid two" style="align-items:center">
      <h3 style="margin:0">Guidance</h3>
      <div class="grid" style="justify-items:end">
        <span id="badgeConsent" class="badge warn">Consent?</span>
        <span id="badgeMgmt" class="badge">Mgmt: —</span>
        <span id="badgeCat" class="badge">Category: —</span>
      </div>
    </div>
    <div id="guidance" class="hint">Welcome. You’ll play **Mat** and handle a call from different caller types. Start with the greeting below.</div>
    <div class="divider"></div>

    <h4>Email templates</h4>
    <details open>
      <summary><strong>Plan manager – Budget snapshot</strong></summary>
      <pre id="tplPM" class="mono" style="white-space:pre-wrap">Subject: Budget snapshot – [Initials, last 3 of NDIS]
Hi [Name],
With consent from [Participant], could you confirm available balance by category and if a PO is needed?
We plan to commence [service] from [date] in [suburb].
Thanks, HD HeeD | 02 8630 5500 | info@hdheed.com.au</pre>
    </details>
    <details>
      <summary><strong>Support Coordinator – Funding confirmation</strong></summary>
      <pre id="tplSC" class="mono" style="white-space:pre-wrap">Subject: Funding confirmation – [Participant]
With [Participant]’s consent, can you confirm active plan dates and the category/balance to fund [service] from [date]?
Thanks, HD HeeD</pre>
    </details>
    <details>
      <summary><strong>Self-managed – Invoice details</strong></summary>
      <pre id="tplSM" class="mono" style="white-space:pre-wrap">Subject: Invoice details – [Participant]
Could you confirm the billing email, any reference/PO, and which category (e.g., Core – ADL) you prefer us to use?
We’ll invoice at/under NDIS limits. Thanks!</pre>
    </details>
  </aside>
</main>

<!-- Mock Plan Modal -->
<div id="planModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="planTitle">
  <div class="head">
    <h3 id="planTitle" style="margin:0">Mock plan</h3>
    <button id="closePlan" class="btn ghost">Close</button>
  </div>
  <div class="body" id="planBody"></div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ====================================================================================
   1) Conversation engine
   - One message at a time (agent Mat ↔ caller).
   - Branch by caller type, plan type, and service request.
   ==================================================================================== */

const chatEl = document.getElementById('chat');
const choicesEl = document.getElementById('choices');
const guidanceEl = document.getElementById('guidance');
const toast = document.getElementById('toast');

const badgeConsent = document.getElementById('badgeConsent');
const badgeMgmt = document.getElementById('badgeMgmt');
const badgeCat = document.getElementById('badgeCat');

const planModal = document.getElementById('planModal');
const planBody = document.getElementById('planBody');

/* State kept in localStorage so you can pause/resume */
const storeKey = 'hdheed_admin_conv_v1';
let state = {
  step: 'greet',
  answers: {
    callerType: null,
    consent: null,
    mgmt: null,
    service: null,
    risk: [],
    category: null,
    notes: ''
  },
  transcript: [] // {who:'agent'|'caller', text}
};
try { const prev = JSON.parse(localStorage.getItem(storeKey)||'null'); if (prev) state = prev; } catch(e){}

/* Helper to push messages */
function say(who, text){
  state.transcript.push({who, text});
  renderChat();
  save();
}
function renderChat(){
  chatEl.innerHTML = state.transcript.map(m=>{
    const cls = m.who==='agent'?'row agent':'row caller';
    return `<div class="${cls}"><div class="bubble">${m.text}</div></div>`;
  }).join('');
  chatEl.scrollTop = chatEl.scrollHeight;
}
function setChoices(options){
  choicesEl.innerHTML = options.map(o=>{
    return `<button class="chip" data-val="${o.value}">${o.label}</button>`;
  }).join('');
  choicesEl.querySelectorAll('.chip').forEach(b=>{
    b.addEventListener('click', ()=> pick(b.dataset.val));
  });
}
function save(){ localStorage.setItem(storeKey, JSON.stringify(state)); }
function flash(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1500); }

/* ====================================================================================
   2) Mock plans (varied by caller type and scenario cluster)
   ==================================================================================== */
const mockPlans = {
  // Simple library; we’ll pick one based on early choices.
  pm_core_adl: {
    title: "Plan-managed • Core ADL focus",
    body: planHTML({
      participant: "A. T. • Parramatta NSW • NDIS 43…812",
      dates: "2025-03-01 → 2026-02-28",
      mgmt: "Plan-managed (BlueLeaf PM)",
      contacts: "PM: pm@blueleafpm.com.au • SC: sc@helpco.org.au",
      budgets: [
        ["Core – Assistance with Daily Life", 32000, 9000],
        ["Core – Social & Community Participation", 8000, 1000],
        ["Capacity – Improved Daily Living", 5000, 500]
      ],
      goals: [
        "Live independently and safely at home",
        "Build daily routines and confidence"
      ],
      notes: "No allergies reported. Falls risk: low. Prefers female workers, morning shifts."
    })
  },
  ndia_nursing: {
    title: "NDIA-managed • Community Nursing Care",
    body: planHTML({
      participant: "B. K. • Blacktown NSW • NDIS 10…553",
      dates: "2025-01-10 → 2025-12-31",
      mgmt: "NDIA-managed",
      contacts: "SC: case.manager@lwb.org.au",
      budgets: [
        ["Core – Community Nursing Care", 12000, 4000],
        ["Capacity – Improved Daily Living", 6000, 2500]
      ],
      goals: [
        "Manage health safely at home",
        "Avoid hospital readmissions"
      ],
      notes: "Pressure injury stage 2 history. RN oversight required. GP review monthly."
    })
  },
  self_comm: {
    title: "Self-managed • Community participation",
    body: planHTML({
      participant: "J. S. • Auburn NSW • NDIS 72…904",
      dates: "2025-06-01 → 2026-05-31",
      mgmt: "Self-managed",
      contacts: "Billing: js.bills@example.com",
      budgets: [
        ["Core – Social & Community Participation", 9000, 1200]
      ],
      goals: [
        "Increase community engagement",
        "Build confidence in public transport"
      ],
      notes: "Prefers SMS. Anxiety in busy places; morning outings better."
    })
  },
  complex_behaviour: {
    title: "Plan-managed • Personal care with BSP (2:1)",
    body: planHTML({
      participant: "K. R. • Penrith NSW • NDIS 55…221",
      dates: "2025-04-15 → 2026-04-14",
      mgmt: "Plan-managed (CareFlow PM)",
      contacts: "PM: claims@careflowpm.com • SC: sc@connectsc.org",
      budgets: [
        ["Core – Assistance with Daily Life", 38000, 7000],
        ["Capacity – Behaviour Support", 5000, 1000]
      ],
      goals: [
        "Safer routines at home",
        "Reduce incidents during morning care"
      ],
      notes: "Behaviour Support Plan in place. Two-worker mornings recommended."
    })
  }
};

function planHTML({participant,dates,mgmt,contacts,budgets,goals,notes}){
  const rows = budgets.map(([label,total,used])=>{
    const avail = total-used; const pct = Math.round(avail/total*100);
    return `<tr><td>${label}</td><td>$${total.toLocaleString()}</td><td>$${used.toLocaleString()}</td><td>$${avail.toLocaleString()} <span class="small">(${pct}% left)</span></td></tr>`;
  }).join('');
  return `
    <div><strong>Participant:</strong> ${participant}</div>
    <div><strong>Dates:</strong> ${dates}</div>
    <div><strong>Managed:</strong> ${mgmt}</div>
    <div><strong>Contacts:</strong> ${contacts}</div>
    <div class="divider"></div>
    <h4>Budgets</h4>
    <div class="card" style="padding:0;border-radius:12px;border:1px solid #e5e7eb">
      <table style="width:100%;border-collapse:collapse">
        <thead><tr style="background:#f8fafc">
          <th style="text-align:left;padding:10px">Category</th>
          <th style="text-align:left;padding:10px">Total</th>
          <th style="text-align:left;padding:10px">Used</th>
          <th style="text-align:left;padding:10px">Available</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    <div class="divider"></div>
    <h4>Goals</h4>
    <ul>${goals.map(g=>`<li>${g}</li>`).join('')}</ul>
    <div class="divider"></div>
    <h4>Notes</h4>
    <div class="hint">${notes}</div>
  `;
}

/* ====================================================================================
   3) Dialogue graph
   ==================================================================================== */

const D = {
  greet: {
    agent: "Hello, this is <strong>Mat</strong> from <strong>HD HeeD</strong>, a registered NDIS provider. How can I help you today?",
    options: [
      {label:"I’m a Participant", value:"caller_participant"},
      {label:"I’m a Family member / Carer", value:"caller_carer"},
      {label:"I’m a Support Coordinator", value:"caller_sc"},
      {label:"I’m a Plan Manager", value:"caller_pm"},
      {label:"I’m a Health Professional", value:"caller_hp"}
    ],
    tip: "Start by identifying the caller. You’ll adapt consent, funding checks, and next steps to suit."
  },

  /* Caller type branches */
  caller_participant: {
    callerAck:"I’m a participant looking for support.",
    agent:"Great — I’ll take a few details so we can help quickly. If you’re not sure on anything, just choose “Not sure”. First — is it okay if I note your details and (if needed) contact your plan manager or support coordinator to confirm funding?",
    options: yesNoNotSure('consent_pm_sc','consent_confirmed_participant'),
    tip:"Verbal consent first. Note who gave it and when."
  },
  consent_confirmed_participant: {
    agent:"Thanks. Which type of support are you looking for?",
    options: serviceOptions('service_pick_participant'),
    tip:"Pick the caller’s words, then you’ll map it to an NDIS category."
  },

  caller_carer: {
    callerAck:"I’m a family member/carer calling on behalf of the participant.",
    agent:"Thanks for calling. Do you have consent from the participant for us to collect details and, if needed, contact their plan manager/support coordinator?",
    options: yesNoNotSure('consent_pm_sc','consent_confirmed_carer'),
    tip:"If no consent yet, collect basic info and arrange follow-up — don’t contact third parties."
  },
  consent_confirmed_carer: {
    agent:"Appreciate it. What support is needed?",
    options: serviceOptions('service_pick_carer')
  },

  caller_sc: {
    callerAck:"I’m a Support Coordinator with a participant to refer.",
    agent:"Perfect. With the participant’s consent, let’s capture the key details. How is their plan managed?",
    options: mgmtOptions('mgmt_sc'),
    tip:"SCs usually know plan details. You’ll still confirm category and balance."
  },

  caller_pm: {
    callerAck:"I’m the participant’s Plan Manager.",
    agent:"Thanks for reaching out. Can I confirm the management type is plan-managed and ask for a budget snapshot by category?",
    options: [
      {label:"Yes — plan-managed, I can share balances", value:"mgmt_pm_yes"},
      {label:"Not sure yet", value:"mgmt_pm_notsure"}
    ],
    tip:"If PM is unsure, collect participant details and ask for a later email confirmation."
  },

  caller_hp: {
    callerAck:"I’m a nurse/GP/therapist referring a participant.",
    agent:"Thanks. With the participant’s consent, I’ll confirm funding and next steps. How is their plan managed?",
    options: mgmtOptions('mgmt_hp')
  },

  /* Service paths (participant/carer) */
  service_pick_participant: serviceToMgmt('mgmt_participant'),
  service_pick_carer: serviceToMgmt('mgmt_carer'),

  mgmt_participant: { agent:"How is your plan managed?", options: mgmtOptions('mgmt_selected') },
  mgmt_carer:       { agent:"How is the participant’s plan managed?", options: mgmtOptions('mgmt_selected') },
  mgmt_sc:          { agent:"Thanks. What support are you looking to start?", options: serviceOptions('mgmt_selected') },
  mgmt_hp:          { agent:"Thanks. What support is needed?", options: serviceOptions('mgmt_selected') },

  mgmt_pm_yes: { callerAck:"Yes, it’s plan-managed. I can provide balances.", agent:"Great — which support is being requested?", options: serviceOptions('mgmt_selected') },
  mgmt_pm_notsure: { agent:"No worries. We’ll proceed and confirm by email shortly. Which support is being requested?", options: serviceOptions('mgmt_selected') },

  mgmt_selected: {
    agent:"Thanks. Do you know the plan dates? (Rough month/year is okay.)",
    options: [
      {label:"I know them", value:"dates_known"},
      {label:"Not sure", value:"dates_unknown"}
    ],
    tip:"Never roster beyond the plan end date without assurance."
  },

  dates_known: { agent:"Please capture the plan start and end (free-type).", options: freeType('dates_captured') },
  dates_unknown: { agent:"That’s fine — we can proceed and confirm later.", options: [{label:"Continue", value:"pre_category"}] },
  dates_captured: { agent:"Thanks.", options: [{label:"Continue", value:"pre_category"}] },

  pre_category: {
    agent:"Based on the requested support, which category is the best starting point?",
    options: categoryOptions('category_picked'),
    tip:"Rule of thumb: Personal care → Core ADL; Community access → Core SCP; Nursing assessment/training → Capacity IDL; Ongoing wound care → Core CNC."
  },

  category_picked: {
    agent:"Got it. Any risks or alerts to note?",
    options: multiPick([
      "Falls","Behaviours of concern","Allergies","Medications","Interpreter needed","None","Not sure"
    ], 'risks_captured'),
    tip:"Flag complex risks to the clinical lead before rostering."
  },

  risks_captured: {
    agent:"How soon do you need support?",
    options: [
      {label:"Urgent (24–72h)", value:"urgency_urgent"},
      {label:"Soon (1–2 weeks)", value:"urgency_soon"},
      {label:"Exploring options", value:"urgency_explore"}
    ]
  },

  urgency_urgent: nextSteps(),
  urgency_soon:   nextSteps(),
  urgency_explore:nextSteps(),

  done: {
    agent:"Great work — that’s the initial admin complete. You can export your transcript and answers, or restart with a different caller.",
    options: [
      {label:"Export JSON", value:"export_json"},
      {label:"Export CSV", value:"export_csv"},
      {label:"Restart", value:"restart"}
    ]
  }
};

/* ====================================================================================
   4) Choice builders
   ==================================================================================== */
function yesNoNotSure(key,next){
  return [
    {label:"Yes (verbal consent)", value: next, onPick: ()=> state.answers.consent = 'Yes (verbal)'},
    {label:"Not yet", value: next, onPick: ()=> state.answers.consent = 'Not yet'},
    {label:"Not sure", value: next, onPick: ()=> state.answers.consent = 'Not sure'}
  ];
}
function serviceOptions(next){
  const opts = [
    "Personal care (morning/evening routines)",
    "Community participation (outings/appointments)",
    "Nursing care (wound/meds/health)",
    "Daily living skills (cooking/budgeting)",
    "Respite / carer relief",
    "Not sure"
  ];
  return opts.map(s=> ({label:s, value:next, onPick:()=> state.answers.service = s}));
}
function mgmtOptions(next){
  const opts = [
    "NDIA-managed","Plan-managed","Self-managed","Not sure"
  ];
  return opts.map(m=> ({label:m, value:next, onPick:()=> state.answers.mgmt = m}));
}
function categoryOptions(next){
  const opts = [
    "Core – Assistance with Daily Life",
    "Core – Social & Community Participation",
    "Core – Community Nursing Care",
    "Capacity – Improved Daily Living",
    "Capital (AT/Home Mods)",
    "Not sure"
  ];
  return opts.map(c=> ({label:c, value:next, onPick:()=> state.answers.category = c}));
}
function multiPick(items, next){
  return items.map(i=> ({label:i, value:next, multi:true}));
}
function freeType(next){
  return [{label:"Type dates then Continue", value:next, free:true, placeholder:"e.g., Mar 2025 – Feb 2026"}];
}
function nextSteps(){
  return {
    agent:"Next steps:",
    options:[
      {label:"Send email to Plan Manager (budget snapshot)", value:"done", onPick:()=> flash("Use the PM template on the right")},
      {label:"Send email to Support Coordinator (funding confirm)", value:"done", onPick:()=> flash("Use the SC template on the right")},
      {label:"Confirm billing details (self-managed)", value:"done", onPick:()=> flash("Use the Self-managed template on the right")},
      {label:"Open mock plan", value:"open_plan"}
    ]
  };
}

/* ====================================================================================
   5) Conversation runner
   ==================================================================================== */
function startIfNeeded(){
  if (!state.transcript.length){
    say('agent', D.greet.agent);
    setChoices(D.greet.options);
    guidanceEl.innerHTML = D.greet.tip;
  }else{
    renderChat();
    resumeChoices();
    updateBadges();
  }
}
function pick(val){
  // Handle free-text step
  const currentNode = current();
  const chosen = (choicesEl.querySelector(`[data-val="${val}"]`)||{});
  const label = chosen.textContent || val;

  // Capture caller text mirroring
  say('caller', label);

  // Side effects (onPick)
  const opt = (currentNode.options||[]).find(o=>o.value===val);
  if (opt && typeof opt.onPick==='function'){ opt.onPick(); }

  // Special actions
  if (val==='export_json'){ exportJSON(); return; }
  if (val==='export_csv'){ exportCSV(); return; }
  if (val==='restart'){ localStorage.removeItem(storeKey); location.reload(); return; }
  if (val==='open_plan'){ openPlanForContext(); return; }

  // Multi-select handling
  if (opt && opt.multi){
    // Toggle multi
    state.answers.risk = state.answers.risk || [];
    const idx = state.answers.risk.indexOf(label);
    if (idx>=0) state.answers.risk.splice(idx,1); else state.answers.risk.push(label);
    // Keep options displayed until "Continue" is offered; so re-render a "Continue"
    showContinue(); updateBadges(); save(); return;
  }

  // Free-type handling
  if (opt && opt.free){
    const input = document.createElement('input');
    input.type = "text";
    input.placeholder = opt.placeholder || "Type here…";
    input.style.marginTop = "8px";
    const box = document.createElement('div');
    box.className = "bubble";
    box.appendChild(input);
    const row = document.createElement('div'); row.className = "row caller"; row.appendChild(box);
    chatEl.appendChild(row); chatEl.scrollTop = chatEl.scrollHeight;

    input.addEventListener('keydown', e=>{
      if (e.key==='Enter'){
        state.answers.dates = input.value.trim();
        say('caller', input.value.trim() || "(no dates provided)");
        state.step = val; save(); advance();
      }
    });
    input.focus();
    return;
  }

  // Advance
  state.step = val; save(); advance();
}
function showContinue(){
  setChoices([{label:"Continue", value:"done"}]);
}
function current(){ return D[state.step] || D.greet; }
function advance(){
  const node = D[state.step] || {};
  if (node.callerAck) say('caller', node.callerAck);
  if (node.agent){ say('agent', node.agent); }
  // If node is a ref generated by builder
  if (node.agent && node.options && Array.isArray(node.options)){
    setChoices(node.options);
  } else if (node.options && node.options.agent){ // builder result with agent/options inside
    say('agent', node.options.agent);
    setChoices(node.options.options);
  } else if (node.options){
    setChoices(node.options);
  } else {
    // default
    setChoices([{label:"Continue", value:"done"}]);
  }
  // Guidance
  guidanceEl.innerHTML = node.tip || guidanceForStep(state.step);
  updateBadges();
  save();
}
function resumeChoices(){
  const node = current();
  if (node.options && Array.isArray(node.options)){
    setChoices(node.options);
  } else if (node.options && node.options.options){
    setChoices(node.options.options);
  } else {
    setChoices(D.greet.options);
  }
}

/* ====================================================================================
   6) Guidance badges
   ==================================================================================== */
function updateBadges(){
  // Consent
  const c = state.answers.consent;
  badgeConsent.textContent = c && c.startsWith('Yes') ? 'Consent ✔' : 'Consent?';
  badgeConsent.className = c && c.startsWith('Yes') ? 'badge ok' : 'badge warn';
  // Mgmt
  const m = state.answers.mgmt || '—';
  badgeMgmt.textContent = 'Mgmt: ' + m;
  // Category
  const cat = state.answers.category || '—';
  badgeCat.textContent = 'Category: ' + cat;
}
function guidanceForStep(step){
  const map = {
    caller_participant: "Confirm consent; if not ready, proceed with basics and schedule a follow-up.",
    caller_carer: "Carer calls: verify consent or capture who will provide it.",
    caller_sc: "SCs: confirm category & balance; they often know plan details.",
    caller_pm: "PMs: ask for budget snapshot by category and whether a PO is needed.",
    caller_hp: "Health professionals: capture risks and clinical needs clearly.",
    pre_category: "Map services to funding: Personal care → Core ADL; Community → Core SCP; Nursing ongoing → Core CNC; Assessments/training → Capacity IDL.",
    risks_captured: "Escalate high risks to clinical lead before rostering.",
    done: "Export your transcript to debrief; restart to try a different caller."
  };
  return map[step] || "Follow the prompt and use “Not sure” to keep momentum.";
}

/* ====================================================================================
   7) Mock plan opener (choose plan based on context)
   ==================================================================================== */
function openPlanForContext(){
  let plan = mockPlans.pm_core_adl; // default
  if (state.answers.mgmt?.includes('NDIA')) plan = mockPlans.ndia_nursing;
  if (state.answers.mgmt?.includes('Self')) plan = mockPlans.self_comm;
  if ((state.answers.service||'').toLowerCase().includes('behaviour')) plan = mockPlans.complex_behaviour;
  planBody.innerHTML = `<h3 style="margin-top:0">${plan.title}</h3>${plan.body}`;
  planModal.style.display = 'block';
}
document.getElementById('btnPlan').addEventListener('click', openPlanForContext);
document.getElementById('closePlan').addEventListener('click', ()=> planModal.style.display='none');
window.addEventListener('keydown', e=>{ if (e.key==='Escape') planModal.style.display='none'; });

/* ====================================================================================
   8) Export / Reset
   ==================================================================================== */
document.getElementById('btnReset').addEventListener('click', ()=>{ localStorage.removeItem(storeKey); location.reload(); });

function exportJSON(){
  const payload = {
    answers: state.answers,
    transcript: state.transcript,
    exportedAt: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const a = Object.assign(document.createElement('a'), {href:URL.createObjectURL(blob), download:'hdheed-admin-sim.json'});
  document.body.appendChild(a); a.click(); a.remove();
}
function toCSV(){
  const lines = ['field,value'];
  for (const [k,v] of Object.entries(state.answers)){
    const val = Array.isArray(v) ? v.join('; ') : (v ?? '');
    lines.push(`"${k}","${String(val).replace(/"/g,'""')}"`);
  }
  return lines.join('\n');
}
function exportCSV(){
  const blob = new Blob([toCSV()], {type:"text/csv"});
  const a = Object.assign(document.createElement('a'), {href:URL.createObjectURL(blob), download:'hdheed-admin-sim.csv'});
  document.body.appendChild(a); a.click(); a.remove();
}
document.getElementById('btnExportJSON').addEventListener('click', exportJSON);
document.getElementById('btnExportCSV').addEventListener('click', exportCSV);

/* ====================================================================================
   9) Boot
   ==================================================================================== */
startIfNeeded();
</script>
</body>
</html>
