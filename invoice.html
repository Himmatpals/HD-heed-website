<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HD HeeD — NDIS Invoicing Suite (Personalised)</title>
  <link rel="icon" href="/images/favicon.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />
  <meta name="theme-color" content="#0b0f1a" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#0b0f1a; --panel:#10172a; --line:#243153; --text:#e8edff; --muted:#aab5d1;
      --accent:#7c3aed; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --chip:#1b2540
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Arial}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);position:sticky;top:0;background:linear-gradient(180deg,rgba(11,15,26,.95),rgba(11,15,26,.85));backdrop-filter:blur(6px);z-index:50}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:12px;background:url('hd%20heed.jpg') center/cover no-repeat, conic-gradient(from 160deg,#7c3aed,#10b981,#0ea5e9,#7c3aed);box-shadow:0 4px 24px rgba(124,58,237,.4)}
    .chip{padding:6px 10px;background:var(--chip);border:1px solid var(--line);border-radius:999px;color:#c9d4f3;font-size:12px}
    .container{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;max-width:1360px;margin:0 auto;padding:16px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:18px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h2.title{margin:0 0 10px;font-size:13px;color:var(--muted);letter-spacing:.14em;text-transform:uppercase}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;background:#0d1426;color:var(--text);border:1px solid #1f2b4a;border-radius:10px;padding:10px}
    input:focus,select:focus,textarea:focus{border-color:#3b82f6;box-shadow:0 0 0 4px rgba(59,130,246,.15);outline:none}
    textarea{min-height:90px;resize:vertical}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .btn{appearance:none;border:1px solid var(--line);background:#121a31;color:var(--text);padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn:hover{border-color:#394b79}
    .btn.primary{background:linear-gradient(180deg,#7c3aed,#4f46e5);border-color:transparent}
    .btn.ok{background:linear-gradient(180deg,#22c55e,#16a34a);border-color:transparent}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#ea580c);border-color:transparent}
    .btn.bad{background:linear-gradient(180deg,#ef4444,#dc2626);border-color:transparent}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    th,td{padding:8px;border-bottom:1px solid var(--line);font-size:13px}
    th{background:#0f1730;color:#cfd8f7;text-align:left}
    .num{text-align:right}
    .notice{font-size:12px;color:#9fb0db}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:60}
    .modal .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;max-width:900px;width:96%}
    @media print{header,.no-print{display:none !important} body{background:#fff;color:#000} .container{display:block;max-width:none;padding:0} .panel{border:none;border-radius:0;box-shadow:none} #builder-panel{display:none} @page{size:A4;margin:12mm}}
  </style>
</head>
<body>
<header class="no-print">
  <div class="brand">
    <div class="logo" aria-label="HD HeeD logo"></div>
    <div>
      <div style="font-weight:800">HD HeeD — NDIS Invoicing Suite</div>
      <div class="notice">Personalised to your registration • Local-only • PDF/CSV/XLSX</div>
    </div>
  </div>
  <div class="row">
    <span class="chip">NDIS‑ready • GST handling</span>
    <span class="chip">Invoice # auto from 1100</span>
  </div>
</header>

<main class="container">
  <!-- LEFT: BUILDER -->
  <section id="builder-panel" class="panel">
    <h2 class="title">Invoice Details</h2>
    <div class="grid">
      <div style="grid-column: span 4"><label>Invoice Number</label><input id="invNumber" placeholder="1100"/></div>
      <div style="grid-column: span 4"><label>Invoice Date</label><input id="invDate" type="date"/></div>
      <div style="grid-column: span 4"><label>Payment Terms</label>
        <select id="terms"><option value="7">7 days</option><option value="14" selected>14 days</option><option value="21">21 days</option><option value="30">30 days</option></select>
      </div>
    </div>

    <h2 class="title" style="margin-top:10px">Your Business</h2>
    <div class="grid">
      <div style="grid-column: span 6"><label>Business Name</label><input id="bizName" value="HD HEED PTY LTD"/></div>
      <div style="grid-column: span 6"><label>ABN</label><input id="abn" value="47665228768"/></div>
      <div style="grid-column: span 6"><label>Email</label><input id="email" value="info@hdheed.com.au"/></div>
      <div style="grid-column: span 6"><label>Phone</label><input id="phone" value="02 8630 5500"/></div>
      <div style="grid-column: span 12"><label>Address</label><input id="address" value="3 Turner Street, Blacktown NSW 2148"/></div>
      <div style="grid-column: span 6"><label>NDIS Registration ID</label><input id="ndisRegId" value="4-KUUGCY5"/></div>
      <div style="grid-column: span 6"><label>ACN (optional)</label><input id="acn" value="665228768"/></div>
    </div>

    <h2 class="title" style="margin-top:10px">Bank Details (fillable)</h2>
    <div class="grid">
      <div style="grid-column: span 4"><label>Account Name</label><input id="accName" placeholder="HD HEED PTY LTD"/></div>
      <div style="grid-column: span 4"><label>BSB</label><input id="bsb" placeholder="000-000"/></div>
      <div style="grid-column: span 4"><label>Account Number</label><input id="accNumber" placeholder="00000000"/></div>
    </div>

    <div class="row" style="margin-top:8px">
      <label class="chip"><input type="checkbox" id="gstFreeDefault" checked style="accent-color:#22c55e;margin-right:8px"> Default GST‑free (NDIS)</label>
      <label class="chip"><input type="checkbox" id="showLogo" checked style="accent-color:#22c55e;margin-right:8px"> Show logo on invoice</label>
    </div>

    <h2 class="title" style="margin-top:10px">Bill To</h2>
    <div class="grid">
      <div style="grid-column: span 6"><label>Participant Name</label><input id="pName"/></div>
      <div style="grid-column: span 6"><label>NDIS Number</label><input id="ndisNo"/></div>
      <div style="grid-column: span 6"><label>Bill To (Plan Manager / Self / NDIA)</label><input id="pmName" placeholder="e.g., XYZ Plan Management (on behalf of Participant)"/></div>
      <div style="grid-column: span 6"><label>Billing Email</label><input id="pmEmail" placeholder="accounts@planmanager.com.au"/></div>
      <div style="grid-column: span 12" class="row no-print">
        <button class="btn" onclick="openClients()">Client Manager</button>
        <button class="btn" onclick="saveClientFromForm()">Save/Update Client</button>
        <span class="notice">Tip: Save clients for reuse; one participant per invoice (NDIS rule).</span>
      </div>
    </div>

    <h2 class="title" style="margin-top:10px">Line Items</h2>
    <div class="notice">Add lines with group, code, day type, unit, quantity and rate. Toggle GST per line if needed (most NDIS supports are GST‑free). Use the <em>Timesheet Wizard</em> for quick hour entries.</div>
    <div style="overflow:auto;margin-top:8px">
      <table id="items">
        <thead>
          <tr>
            <th style="width:12ch">Date</th>
            <th style="width:12ch">Group</th>
            <th style="width:20ch">NDIS Item Code</th>
            <th style="width:14ch">Day Type</th>
            <th>Description</th>
            <th style="width:10ch">Unit</th>
            <th class="num" style="width:10ch">Qty</th>
            <th class="num" style="width:12ch">Rate</th>
            <th class="num" style="width:9ch">GST</th>
            <th style="width:12ch">Claim</th>
            <th class="num" style="width:12ch">Amount</th>
            <th class="no-print" style="width:7ch">—</th>
          </tr>
        </thead>
        <tbody id="itemBody"></tbody>
        <tfoot>
          <tr>
            <td colspan="10" class="num">Subtotal</td>
            <td class="num" id="subtotal">$0.00</td>
            <td class="no-print"></td>
          </tr>
          <tr>
            <td colspan="10" class="num">GST (10%)</td>
            <td class="num" id="gst">$0.00</td>
            <td class="no-print"></td>
          </tr>
          <tr>
            <td colspan="10" class="num">Total</td>
            <td class="num" id="grandTotal">$0.00</td>
            <td class="no-print"></td>
          </tr>
        </tfoot>
      </table>
    </div>
    <div class="row no-print" style="margin-top:8px">
      <button class="btn" onclick="addItem()">+ Add Line</button>
      <button class="btn" onclick="addCommon()">+ Add Common Items</button>
      <button class="btn" onclick="openTimesheet()">Timesheet Wizard</button>
      <button class="btn bad" onclick="clearItems()">Clear Lines</button>
    </div>

    <h2 class="title" style="margin-top:10px">Notes (optional)</h2>
    <textarea id="notes" placeholder="Reference, PO, claim type details (e.g. Non face‑to‑face / Travel / Cancellation), timesheet ref, etc."></textarea>

    <h2 class="title" style="margin-top:10px">Recurring (optional)</h2>
    <div class="grid">
      <div style="grid-column: span 4"><label>Frequency</label>
        <select id="recurrence"><option value="none">None</option><option value="weekly">Weekly</option><option value="fortnightly">Fortnightly</option><option value="monthly">Monthly</option></select>
      </div>
      <div style="grid-column: span 4"><label>Occurrences</label><input id="occurrences" type="number" min="1" value="1"/></div>
      <div style="grid-column: span 4"><label>Start From (service date)</label><input id="recurStart" type="date"/></div>
    </div>
    <div class="notice">Generates future‑dated drafts with unique invoice numbers; you still review before printing/emailing.</div>

    <div class="controls no-print" style="margin-top:12px">
      <button class="btn" onclick="saveDraft()">Save Draft</button>
      <button class="btn" onclick="loadNextRecurring()">Load Next Recurrence</button>
      <button class="btn warn" onclick="clearDraft()">Clear Draft</button>
      <button class="btn" onclick="exportCSV()">Export CSV</button>
      <button class="btn" onclick="exportXLSX()">Export XLSX</button>
      <button class="btn ok" onclick="previewInvoice()">Preview</button>
      <button class="btn primary" onclick="printInvoice()">Download PDF</button>
    </div>

    <h2 class="title" style="margin-top:14px">Compliance Checklist</h2>
    <ul class="notice" id="auditList" style="margin:0 0 6px 16px;line-height:1.6">
      <li>Provider name, ABN & NDIS Registration ID present</li>
      <li>Unique invoice number & issue date</li>
      <li>Participant name & NDIS number</li>
      <li>Each line shows service date, group, NDIS item code, description, unit, qty, rate, day type</li>
      <li>GST clearly shown (most NDIS items GST‑free)</li>
      <li>Totals accurate; bank details included</li>
    </ul>

    <h2 class="title" style="margin-top:14px">Your Registered Classes (read‑only)</h2>
    <div class="notice" id="classesBox"></div>
  </section>

  <!-- RIGHT: PREVIEW -->
  <section id="render-panel" class="panel">
    <h2 class="title">Preview</h2>
    <div id="invoice-render" style="background:white;color:#0a0a0a;padding:24px;border-radius:12px">
      <div style="color:#6b7280">Fill the form then click <strong>Preview</strong>.</div>
    </div>
  </section>
</main>

<!-- TIMESHEET MODAL -->
<div id="timesheetModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="tsTitle">
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 id="tsTitle" style="margin:0">Timesheet Wizard</h3>
      <button class="btn bad" onclick="closeTimesheet()">Close</button>
    </div>
    <div class="grid">
      <div style="grid-column: span 3"><label>From Date</label><input id="tsFrom" type="date"/></div>
      <div style="grid-column: span 3"><label>To Date</label><input id="tsTo" type="date"/></div>
      <div style="grid-column: span 3"><label>Start Time</label><input id="tsStart" type="time"/></div>
      <div style="grid-column: span 3"><label>End Time</label><input id="tsEnd" type="time"/></div>
      <div style="grid-column: span 3"><label>Break (mins)</label><input id="tsBreak" type="number" min="0" value="0"/></div>
      <div style="grid-column: span 3"><label>Group</label>
        <select id="tsGroup"></select>
      </div>
      <div style="grid-column: span 3"><label>Day Type</label>
        <select id="tsDay"><option>Weekday</option><option>Saturday</option><option>Sunday</option><option>Public Holiday</option></select>
      </div>
      <div style="grid-column: span 3"><label>Rate (AUD)</label><input id="tsRate" type="number" step="0.01"/></div>
      <div style="grid-column: span 12"><label>Description</label><input id="tsDesc" placeholder="e.g., Assistance with self‑care activities"/></div>
    </div>
    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button class="btn ok" onclick="generateFromTimesheet()">Generate Lines</button>
    </div>
  </div>
</div>

<!-- CLIENT MANAGER MODAL -->
<div id="clientModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="clientTitle">
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 id="clientTitle" style="margin:0">Client Manager</h3>
      <button class="btn bad" onclick="closeClients()">Close</button>
    </div>
    <div class="grid">
      <div style="grid-column: span 6">
        <h4 style="margin:6px 0">Add / Update Client</h4>
        <label>Participant</label><input id="cName"/>
        <label>NDIS Number</label><input id="cNdis"/>
        <label>Bill To</label><input id="cPm" placeholder="Plan Manager / Self / NDIA"/>
        <label>Billing Email</label><input id="cEmail" placeholder="accounts@planmanager.com.au"/>
        <div class="row" style="margin-top:8px">
          <button class="btn ok" onclick="saveClient()">Save Client</button>
          <button class="btn warn" onclick="resetClientForm()">Reset</button>
        </div>
      </div>
      <div style="grid-column: span 6">
        <h4 style="margin:6px 0">Saved Clients</h4>
        <table>
          <thead><tr><th>Participant</th><th>NDIS #</th><th>Bill To</th><th>Email</th><th class="no-print">Use</th><th class="no-print">Del</th></tr></thead>
          <tbody id="clientRows"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- GROUP CODE DATALISTS -->
<datalist id="codes-0107">
  <option value="01_011_0107_1_1">Assistance with self‑care activities – Weekday</option>
  <option value="01_012_0107_1_1">Assistance with self‑care activities – Saturday/Evening</option>
  <option value="01_013_0107_1_1">Assistance with self‑care activities – Sunday</option>
  <option value="01_014_0107_1_1">Assistance with self‑care activities – Public Holiday</option>
</datalist>
<datalist id="codes-0108">
  <option value="02_051_0108_1_1">Activity‑based transport (per km)</option>
  <option value="02_052_0108_1_1">Activity‑based transport (hourly)</option>
</datalist>
<datalist id="codes-0120">
  <option value="01_020_0120_1_1">Household tasks</option>
  <option value="01_021_0120_1_1">House/Yard maintenance</option>
</datalist>
<datalist id="codes-0136">
  <option value="04_104_0136_6_1">Community/social/rec activities</option>
  <option value="04_102_0136_6_1">Group/centre‑based activities – standard</option>
</datalist>
<!-- Empty lists for other approved groups (free entry allowed) -->
<datalist id="codes-0104"></datalist>
<datalist id="codes-0115"></datalist>
<datalist id="codes-0117"></datalist>
<datalist id="codes-0125"></datalist>

<script>
// ===== Constants (personalised from certificate) =====
const APPROVED_GROUPS = [
  {code:'0104', name:'Assist Personal Activities High (High Intensity)'},
  {code:'0107', name:'Assist-Personal Activities'},
  {code:'0108', name:'Assist-Travel/Transport'},
  {code:'0115', name:'Daily Tasks/Shared Living'},
  {code:'0117', name:'Development-Life Skills'},
  {code:'0120', name:'Household Tasks'},
  {code:'0125', name:'Participate Community'},
  {code:'0136', name:'Group/Centre Activities'},
];
const HIGH_INTENSITY_SUBTYPES = [
  'Complex Bowel Care','Enteral feeding (NG/PEG)','Urinary catheter management','Subcutaneous injections','Complex wound management','Severe dysphagia management','Medication management','Disposal of hazardous/infectious waste'
];

// ===== Utilities =====
const $ = (id) => document.getElementById(id);
const AUD = (n) => (isFinite(n)?n:0).toLocaleString('en-AU',{style:'currency',currency:'AUD'});
const todayISO = () => new Date().toISOString().slice(0,10);
const parseFloatSafe = (v)=>{const x=parseFloat(v);return isFinite(x)?x:0};
const escapeHtml = (s)=> (s||'').replace(/[&<>\"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));

// ===== Local Storage Keys =====
const LS_DRAFT = 'hdheed_invoice_draft_v4';
const LS_SEQ   = 'hdheed_invoice_seq_v2';
const LS_CLIENTS = 'hdheed_clients_v1';

function nextInvoiceNumber(){ let n = parseInt(localStorage.getItem(LS_SEQ)||'1099',10) + 1; localStorage.setItem(LS_SEQ,String(n)); return String(n); }

// ===== Items =====
function onGroupChange(sel){
  const tr = sel.closest('tr');
  const codeInput = tr.querySelector('td:nth-child(3) input');
  const listId = 'codes-'+sel.value;
  codeInput.setAttribute('list', listId);
}
function applyDayTypeToCode(tr){
  const group = tr.querySelector('td:nth-child(2) select')?.value;
  const daySel = tr.querySelector('td:nth-child(4) select');
  const codeInput = tr.querySelector('td:nth-child(3) input');
  if(!daySel || !codeInput) return;
  const day = daySel.value; const code = (codeInput.value||'').trim();
  if(group!=='0107') return; // auto-switch codes only for Assist-Personal Activities
  const family = { 'Weekday':'01_011', 'Saturday':'01_012', 'Sunday':'01_013', 'Public Holiday':'01_014' };
  const isSelfCare = code==='' || /^01_01[1-4]_0107_1_1$/.test(code);
  if(isSelfCare){ codeInput.value = `${family[day]||'01_011'}_0107_1_1`; }
}
function addItem(data={}){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input type="date" value="${data.date||todayISO()}" oninput="recalc()"/></td>
    <td>
      <select onchange="onGroupChange(this);recalc()">
        <option value="">—</option>
        ${APPROVED_GROUPS.map(g=>`<option value="${g.code}" ${data.group===g.code?'selected':''}>${g.code}</option>`).join('')}
      </select>
    </td>
    <td><input placeholder="e.g., 01_011_0107_1_1" list="codes-0107" value="${data.code||''}" oninput="recalc()"/></td>
    <td>
      <select oninput="applyDayTypeToCode(this.closest('tr'));recalc()">
        <option ${data.day==='Weekday'?'selected':''}>Weekday</option>
        <option ${data.day==='Saturday'?'selected':''}>Saturday</option>
        <option ${data.day==='Sunday'?'selected':''}>Sunday</option>
        <option ${data.day==='Public Holiday'?'selected':''}>Public Holiday</option>
      </select>
    </td>
    <td><input placeholder="Description" value="${data.desc||''}" oninput="recalc()"/></td>
    <td>
      <select oninput="recalc()">
        <option ${data.unit==='hours'?'selected':''} value="hours">Hours</option>
        <option ${data.unit==='km'?'selected':''} value="km">Km</option>
        <option ${data.unit==='each'?'selected':''} value="each">Each</option>
      </select>
    </td>
    <td class='num'><input type="number" min="0" step="0.25" value="${data.qty||''}" oninput="recalc()"/></td>
    <td class='num'><input type="number" min="0" step="0.01" value="${data.rate||''}" oninput="recalc()"/></td>
    <td class='num'><input type="checkbox" ${ (typeof data.gst==='boolean'?data.gst:false) || !$('gstFreeDefault').checked ? 'checked':'' } onchange="recalc()"/></td>
    <td>
      <select oninput="recalc()">
        <option value="">—</option>
        <option ${data.claim==='Travel'?'selected':''}>Travel</option>
        <option ${data.claim==='Non face-to-face'?'selected':''}>Non face-to-face</option>
        <option ${data.claim==='Cancellation'?'selected':''}>Cancellation</option>
      </select>
    </td>
    <td class='num amount'>$0.00</td>
    <td class='no-print'><button class='btn bad' onclick="this.closest('tr').remove();recalc()">×</button></td>
  `;
  $('itemBody').appendChild(tr);
  // set datalist based on initial or provided group
  const groupSel = tr.querySelector('td:nth-child(2) select');
  if(data.group) groupSel.value=data.group;
  onGroupChange(groupSel);
  // sync code for self-care if day given and no code yet
  if(!data.code && data.day) applyDayTypeToCode(tr);
  recalc();
}
function addCommon(){
  addItem({group:'0107',code:'01_011_0107_1_1',day:'Weekday',desc:'Self‑care weekday',unit:'hours',qty:1,rate:65.09,gst:false});
  addItem({group:'0108',code:'02_052_0108_1_1',day:'Weekday',desc:'Transport (hourly)',unit:'hours',qty:1,rate:60.00,gst:false});
  addItem({group:'0120',code:'01_020_0120_1_1',day:'Weekday',desc:'Household tasks',unit:'hours',qty:1,rate:55.00,gst:false});
}
function clearItems(){ $('itemBody').innerHTML=''; recalc(); }

function recalc(){
  let subtotal=0, gst=0;
  [...$('itemBody').rows].forEach(tr=>{
    const qty=parseFloatSafe(tr.cells[6].querySelector('input').value);
    const rate=parseFloatSafe(tr.cells[7].querySelector('input').value);
    const isGST=tr.cells[8].querySelector('input').checked;
    const amt=qty*rate; subtotal+=amt; if(isGST) gst+=amt*0.10; tr.querySelector('.amount').textContent=AUD(amt);
  });
  $('subtotal').textContent=AUD(subtotal);
  $('gst').textContent=AUD(gst);
  $('grandTotal').textContent=AUD(subtotal+gst);
}

function collect(){
  const items = [...$('itemBody').rows].map(r=>({
    date: r.cells[0].querySelector('input').value,
    group: r.cells[1].querySelector('select').value,
    code: r.cells[2].querySelector('input').value,
    day: r.cells[3].querySelector('select').value,
    desc: r.cells[4].querySelector('input').value,
    unit: r.cells[5].querySelector('select').value,
    qty:  parseFloatSafe(r.cells[6].querySelector('input').value),
    rate: parseFloatSafe(r.cells[7].querySelector('input').value),
    gst:  r.cells[8].querySelector('input').checked,
    claim:r.cells[9].querySelector('select').value
  }));
  return {
    invNumber: $('invNumber').value.trim() || nextInvoiceNumber(),
    invDate: $('invDate').value || todayISO(),
    terms: $('terms').value,
    bizName: $('bizName').value.trim(),
    abn: $('abn').value.trim(),
    email: $('email').value.trim(),
    phone: $('phone').value.trim(),
    address: $('address').value.trim(),
    ndisRegId: $('ndisRegId').value.trim(),
    acn: $('acn').value.trim(),
    accName: $('accName').value.trim(),
    bsb: $('bsb').value.trim(),
    accNumber: $('accNumber').value.trim(),
    pName: $('pName').value.trim(),
    ndisNo: $('ndisNo').value.trim(),
    pmName: $('pmName').value.trim(),
    pmEmail: $('pmEmail').value.trim(),
    gstFreeDefault: $('gstFreeDefault').checked,
    showLogo: $('showLogo').checked,
    notes: $('notes').value,
    items,
    recurrence: $('recurrence').value,
    occurrences: parseInt($('occurrences').value||'1',10),
    recurStart: $('recurStart').value
  };
}

// ===== Drafts & Clients =====
function saveDraft(){ const data=collect(); localStorage.setItem(LS_DRAFT, JSON.stringify(data)); const rec=generateRecurringDrafts(); if(rec.length) localStorage.setItem(LS_DRAFT+'_rec', JSON.stringify(rec)); alert('Draft saved'+(rec.length?` (+${rec.length} recurrences)`:'')); }
function clearDraft(){ if(confirm('Clear saved draft?')){ localStorage.removeItem(LS_DRAFT); localStorage.removeItem(LS_DRAFT+'_rec'); fill({}); }}
function loadNextRecurring(){ const key=LS_DRAFT+'_rec'; const arr=JSON.parse(localStorage.getItem(key)||'[]'); if(!arr.length){alert('No recurring drafts stored.');return;} const next=arr.shift(); localStorage.setItem(key, JSON.stringify(arr)); fill(next); }

function loadClients(){ try{ return JSON.parse(localStorage.getItem(LS_CLIENTS)||'[]'); }catch{return []} }
function saveClients(list){ localStorage.setItem(LS_CLIENTS, JSON.stringify(list)); renderClients(); }
function renderClients(){ const tbody=$('clientRows'); if(!tbody) return; const clients=loadClients(); tbody.innerHTML=clients.map((c,i)=>`<tr><td>${escapeHtml(c.name)}</td><td>${escapeHtml(c.ndis)}</td><td>${escapeHtml(c.pm)}</td><td>${escapeHtml(c.email)}</td><td class='no-print'><button class='btn ok' onclick='useClient(${i})'>Use</button></td><td class='no-print'><button class='btn bad' onclick='delClient(${i})'>Del</button></td></tr>`).join(''); }
function openClients(){ $('clientModal').style.display='flex'; renderClients(); }
function closeClients(){ $('clientModal').style.display='none'; }
function resetClientForm(){ $('cName').value='';$('cNdis').value='';$('cPm').value='';$('cEmail').value=''; }
function saveClient(){ const c={name:$('cName').value.trim(), ndis:$('cNdis').value.trim(), pm:$('cPm').value.trim(), email:$('cEmail').value.trim()}; if(!c.name){alert('Participant name required');return;} const list=loadClients(); const idx=list.findIndex(x=>x.name.toLowerCase()===c.name.toLowerCase()); if(idx>=0) list[idx]=c; else list.push(c); saveClients(list); resetClientForm(); }
function delClient(i){ const list=loadClients(); list.splice(i,1); saveClients(list); }
function useClient(i){ const c=loadClients()[i]; if(!c) return; $('pName').value=c.name; $('ndisNo').value=c.ndis; $('pmName').value=c.pm; $('pmEmail').value=c.email; closeClients(); }
function saveClientFromForm(){ const c={name:$('pName').value.trim(), ndis:$('ndisNo').value.trim(), pm:$('pmName').value.trim(), email:$('pmEmail').value.trim()}; if(!c.name){alert('Enter Participant name first');return;} const list=loadClients(); const idx=list.findIndex(x=>x.name.toLowerCase()===c.name.toLowerCase()); if(idx>=0) list[idx]=c; else list.push(c); saveClients(list); alert('Client saved.'); }

// ===== Timesheet Wizard =====
function openTimesheet(){ $('timesheetModal').style.display='flex'; buildTimesheetGroupOptions(); }
function closeTimesheet(){ $('timesheetModal').style.display='none'; }
function buildTimesheetGroupOptions(){ $('tsGroup').innerHTML = APPROVED_GROUPS.map(g=>`<option value='${g.code}'>${g.code} — ${g.name}</option>`).join(''); }
function generateFromTimesheet(){
  const from = new Date($('tsFrom').value); const to = new Date($('tsTo').value);
  if(!(from&&to) || isNaN(from)||isNaN(to) || from>to){ alert('Please set a valid From/To date range.'); return; }
  const start = $('tsStart').value; const end = $('tsEnd').value; const brk = parseInt($('tsBreak').value||'0',10);
  if(!start||!end){ alert('Start and End time are required.'); return; }
  const rate = parseFloatSafe($('tsRate').value); if(!(rate>0)){ alert('Enter a valid rate.'); return; }
  const group = $('tsGroup').value || '0107';
  const day = $('tsDay').value || 'Weekday';
  const desc = $('tsDesc').value || 'Support as agreed';
  for(let d=new Date(from); d<=to; d.setDate(d.getDate()+1)){
    const qty = (()=>{ const [sh,sm]=start.split(':').map(Number); const [eh,em]=end.split(':').map(Number); const mins=(eh*60+em)-(sh*60+sm)-brk; return Math.max(0, mins/60); })();
    addItem({date:d.toISOString().slice(0,10), group, day, desc, unit:'hours', qty: Number(qty.toFixed(2)), rate, gst:false});
  }
  closeTimesheet();
}

// ===== Preview / Print =====
function validate(){
  const errs=[];
  const abn = $('abn').value.replace(/\s+/g,''); if(!(abn.length===11 && /^\d{11}$/.test(abn))) errs.push('ABN should be 11 digits.');
  const invDate = $('invDate').value; if(!invDate) errs.push('Invoice date is required.');
  const pName = $('pName').value.trim(); if(!pName) errs.push('Participant name is required.');
  const ndis = $('ndisNo').value.replace(/\s+/g,''); if(!(ndis==='' || /^\d{9}$/.test(ndis))) errs.push('NDIS number should be 9 digits (or leave blank).');
  const rows=[...$('itemBody').querySelectorAll('tr')]; if(!rows.length) errs.push('Add at least one line item.');
  rows.forEach((tr,i)=>{
    const date = tr.children[0].querySelector('input').value;
    const code = tr.children[2].querySelector('input').value.trim();
    const qty = parseFloatSafe(tr.children[6].querySelector('input').value);
    const rate = parseFloatSafe(tr.children[7].querySelector('input').value);
    if(!date) errs.push(`Line ${i+1}: service date is required.`);
    if(!code) errs.push(`Line ${i+1}: NDIS support item code is required.`);
    if(!(qty>0)) errs.push(`Line ${i+1}: quantity must be > 0.`);
    if(!(rate>0)) errs.push(`Line ${i+1}: rate must be > 0.`);
    const invDateVal = $('invDate').value; if(invDateVal && date && new Date(invDateVal) < new Date(date)) errs.push(`Line ${i+1}: invoice date should be on/after service date.`);
  });
  if(errs.length){ alert('Please fix these before continuing:\n\n- '+errs.join('\n- ')); return false; }
  return true;
}

function previewInvoice(){
  if(!$('invNumber').value.trim()){ $('invNumber').value = nextInvoiceNumber(); }
  if(!validate()) return;
  recalc();
  const d = collect();
  const due = (()=>{ const dt = new Date(d.invDate||todayISO()); dt.setDate(dt.getDate()+Number(d.terms||14)); return dt.toLocaleDateString('en-AU'); })();
  const rows = d.items.map(x=>`
    <tr>
      <td>${escapeHtml(x.date||'')}</td>
      <td>${escapeHtml(x.group||'')}</td>
      <td>${escapeHtml(x.code||'')}</td>
      <td>${escapeHtml(x.day||'')}</td>
      <td>${escapeHtml(x.desc||'')}</td>
      <td class='num'>${escapeHtml(x.unit||'')}</td>
      <td class='num'>${Number(x.qty||0)}</td>
      <td class='num'>${AUD(Number(x.rate||0))}</td>
      <td class='num'>${x.gst?'10%':''}</td>
      <td>${escapeHtml(x.claim||'')}</td>
      <td class='num'>${AUD((Number(x.qty||0)*Number(x.rate||0)))}</td>
    </tr>`).join('');
  const sub = $('subtotal').textContent; const gst = $('gst').textContent; const tot = $('grandTotal').textContent;
  $('invoice-render').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px">
      <div>
        <div style="font-weight:900;font-size:22px">${escapeHtml(d.bizName||'')}</div>
        <div>ABN: ${escapeHtml(d.abn||'')}${d.acn?` • ACN: ${escapeHtml(d.acn)}`:''}</div>
        <div>NDIS Registration ID: ${escapeHtml(d.ndisRegId||'')}</div>
        ${d.address?`<div>${escapeHtml(d.address)}</div>`:''}
        <div>${escapeHtml(d.email||'')} • ${escapeHtml(d.phone||'')}</div>
      </div>
      ${d.showLogo?`<div style="width:60px;height:60px;border-radius:14px;background:url('hd%20heed.jpg') center/cover no-repeat, conic-gradient(from 160deg,#7c3aed,#10b981,#0ea5e9,#7c3aed)"></div>`:''}
    </div>

    <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-top:16px;border-top:1px solid #e5e7eb;padding-top:10px">
      <div>
        <div style="font-weight:800;font-size:18px">${d.items.some(i=>i.gst)?'Tax Invoice':'Invoice'}</div>
        <div>Invoice No: <strong>${escapeHtml(d.invNumber)}</strong></div>
        <div>Invoice Date: <strong>${new Date(d.invDate||todayISO()).toLocaleDateString('en-AU')}</strong></div>
        <div>Payment Terms: <strong>${d.terms} days (Due ${due})</strong></div>
      </div>
      <div>
        <div style="font-weight:600">Bill To</div>
        <div>${escapeHtml(d.pName||'')}</div>
        ${d.ndisNo?`<div>NDIS No: ${escapeHtml(d.ndisNo)}</div>`:''}
        <div>${escapeHtml(d.pmName||'')}</div>
        <div>${escapeHtml(d.pmEmail||'')}</div>
      </div>
    </div>

    <table style="width:100%;border-collapse:collapse;margin-top:14px">
      <thead>
        <tr style="background:#111827;color:white">
          <th style="text-align:left;padding:10px">Service Date</th>
          <th style="text-align:left;padding:10px">Group</th>
          <th style="text-align:left;padding:10px">NDIS Support Item</th>
          <th style="text-align:left;padding:10px">Day Type</th>
          <th style="text-align:left;padding:10px">Description</th>
          <th style="text-align:right;padding:10px">Unit</th>
          <th style="text-align:right;padding:10px">Qty</th>
          <th style="text-align:right;padding:10px">Rate</th>
          <th style="text-align:right;padding:10px">GST</th>
          <th style="text-align:left;padding:10px">Claim</th>
          <th style="text-align:right;padding:10px">Amount</th>
        </tr>
      </thead>
      <tbody>${rows || `<tr><td colspan='11' style='padding:10px;color:#6b7280'>No items yet.</td></tr>`}</tbody>
      <tfoot>
        <tr><td colspan="10" style="text-align:right;padding:10px;border-top:1px solid #e5e7eb">Subtotal</td><td style="text-align:right;padding:10px;border-top:1px solid #e5e7eb">${sub}</td></tr>
        <tr><td colspan="10" style="text-align:right;padding:10px">GST (10%)</td><td style="text-align:right;padding:10px">${gst}</td></tr>
        <tr><td colspan="10" style="text-align:right;padding:10px;font-weight:900">Total</td><td style="text-align:right;padding:10px;font-weight:900">${tot}</td></tr>
      </tfoot>
    </table>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:14px">
      <div>
        <div style="font-weight:600">Bank Details</div>
        <div>Account Name: ${escapeHtml(d.accName||'')}</div>
        <div>BSB: ${escapeHtml(d.bsb||'')} • Account No: ${escapeHtml(d.accNumber||'')}</div>
        <div>Reference: ${escapeHtml(`Invoice ${d.invNumber} – ${d.pName||''}`)}</div>
      </div>
      <div>
        <div style="font-weight:600">Notes</div>
        <div style="white-space:pre-wrap">${escapeHtml(d.notes||'')}</div>
      </div>
    </div>

    <div style="margin-top:12px;font-size:12px;color:#6b7280">
      <div>Registered classes: ${APPROVED_GROUPS.map(g=>g.code).join(', ')}.</div>
      ${d.items.some(i=>i.gst)?'<div>Includes GST where indicated.</div>':'<div>GST‑free supply: Most NDIS supports are GST‑free when eligibility conditions are met.</div>'}
      <div>For billing queries, contact ${escapeHtml(d.email||'')}.</div>
    </div>
  `;
}
function printInvoice(){ previewInvoice(); window.print(); }

// ===== Export =====
function invoiceRowsForExport(){
  const d = collect();
  const rows = d.items.map(x=>({
    InvoiceNumber: d.invNumber,
    InvoiceDate: d.invDate,
    Participant: d.pName,
    NDISNumber: d.ndisNo,
    BillTo: d.pmName,
    Email: d.pmEmail,
    ServiceDate: x.date,
    Group: x.group,
    SupportItem: x.code,
    DayType: x.day,
    Description: x.desc,
    Unit: x.unit,
    Qty: x.qty,
    Rate: x.rate,
    GST: x.gst? (x.qty*x.rate*0.10).toFixed(2) : '0.00',
    Claim: x.claim || '',
    LineTotal: (x.qty*x.rate).toFixed(2)
  }));
  return rows;
}
function exportCSV(){
  const rows = invoiceRowsForExport();
  if(!rows.length){ alert('No line items to export.'); return; }
  const headers = Object.keys(rows[0]);
  const csv = [headers.join(','), ...rows.map(r=>headers.map(h=>JSON.stringify(r[h]??'')).join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Invoice_${collect().invNumber}.csv`; a.click();
}
function exportXLSX(){
  try{
    if(typeof XLSX==='undefined'){ throw new Error('XLSX library not loaded'); }
    const ws = XLSX.utils.json_to_sheet(invoiceRowsForExport());
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Invoice');
    XLSX.writeFile(wb, `Invoice_${collect().invNumber}.xlsx`);
  }catch(e){ alert('XLSX export unavailable. Falling back to CSV.'); exportCSV(); }
}

// ===== Recurring =====
function generateRecurringDrafts(){
  const d = collect(); if(d.recurrence==='none'||d.occurrences<=1) return [];
  const drafts=[]; let start = d.recurStart ? new Date(d.recurStart) : (d.items[0]?.date? new Date(d.items[0].date): new Date());
  const step = (dt)=>{ const nd=new Date(dt); if(d.recurrence==='weekly') nd.setDate(nd.getDate()+7); if(d.recurrence==='fortnightly') nd.setDate(nd.getDate()+14); if(d.recurrence==='monthly') nd.setMonth(nd.getMonth()+1); return nd; };
  let currentDate = start;
  for(let i=2;i<=d.occurrences;i++){
    currentDate = step(currentDate);
    const copy = JSON.parse(JSON.stringify(d));
    copy.invNumber = nextInvoiceNumber();
    copy.invDate = todayISO();
    copy.items = copy.items.map(x=>({...x, date: currentDate.toISOString().slice(0,10)}));
    drafts.push(copy);
  }
  return drafts;
}

// ===== Init =====
function fill(form){
  $('invNumber').value = form.invNumber || '';
  $('invDate').value = form.invDate || todayISO();
  $('terms').value = form.terms || '14';
  $('bizName').value = form.bizName || 'HD HEED PTY LTD';
  $('abn').value = form.abn || '47665228768';
  $('email').value = form.email || 'info@hdheed.com.au';
  $('phone').value = form.phone || '02 8630 5500';
  $('address').value = form.address || '3 Turner Street, Blacktown NSW 2148';
  $('ndisRegId').value = form.ndisRegId || '4-KUUGCY5';
  $('acn').value = form.acn || '665228768';
  $('accName').value = form.accName || '';
  $('bsb').value = form.bsb || '';
  $('accNumber').value = form.accNumber || '';
  $('pName').value = form.pName || '';
  $('ndisNo').value = form.ndisNo || '';
  $('pmName').value = form.pmName || '';
  $('pmEmail').value = form.pmEmail || '';
  $('gstFreeDefault').checked = (typeof form.gstFreeDefault==='boolean') ? form.gstFreeDefault : true;
  $('showLogo').checked = (typeof form.showLogo==='boolean') ? form.showLogo : true;
  $('notes').value = form.notes || '';
  $('recurrence').value = form.recurrence || 'none';
  $('occurrences').value = form.occurrences || 1;
  $('recurStart').value = form.recurStart || '';
  // classes box
  $('classesBox').innerText = APPROVED_GROUPS.map(g=>`${g.code} — ${g.name}`).join(' | ');
  // items
  clearItems();
  (form.items && form.items.length? form.items : [{}]).forEach(addItem);
  recalc();
}
(function init(){
  const saved = localStorage.getItem(LS_DRAFT);
  if(saved){ try{ fill(JSON.parse(saved)); }catch{ fill({}); } } else { fill({}); }
  // Ensure one empty line
  if(!$('itemBody').children.length){ addItem({}); }
})();
</script>
</body>
</html>
