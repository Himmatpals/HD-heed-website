<!doctype html>
<html lang="en">
<!-- Favicons / App Icons (HD-only) -->
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=3">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=3">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=3">
<link rel="mask-icon" href="/safari-pinned-tab.svg?v=3" color="#512b8a">
<link rel="manifest" href="/site.webmanifest?v=3">
<meta name="theme-color" content="#512b8a">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HD HeeD ‚Äî Because we care, we provide HD care</title>
  <meta name="description" content="Registered NDIS provider in NSW. Start a referral or make an enquiry in minutes. Nursing care, personal care, community participation, respite and more." />
  <meta name="theme-color" content="#2563eb" />
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B7MGZCJNJT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-B7MGZCJNJT');
  </script>
  <link rel="icon" href="images/favicon.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --purple:#512b8a; --accent:#ffc107; --bg:#f6f7fb; --ink:#0f172a; --muted:#64748b;
      --brand:#2563eb; --brand2:#22c55e; --ring:#93c5fd; --danger:#ef4444; --enq:#ff5722;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--ink)}
    a{color:var(--brand);text-decoration:none}
    img{max-width:100%;height:auto;display:block}
    .container{max-width:1120px;margin:0 auto;padding:16px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    a, button { touch-action: manipulation; }

    /* Top contact bar */
    .topbar{background:#0b1220;color:#fff}
    .topbar .inner{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:8px 16px}
    .topbar a{color:#fff;font-weight:700}
    .topbar .small{font-size:13px;color:#cbd5e1}
    .contact-links{display:flex;gap:12px;flex-wrap:wrap}
    .contact-links a{display:inline-flex;gap:6px;align-items:center}

    /* >>> Marquee Ribbon (Right -> Left) <<< */
    .marquee-wrap{ position:sticky; top:0; z-index:70; background:transparent; padding:6px 0; }
    .marquee{ position:relative; overflow:hidden; width:100%; }
    .marquee-track{
      display:flex; gap:28px; align-items:center; white-space:nowrap;
      will-change: transform; animation: marquee 68s linear infinite;
    }
    .marquee-item{
      display:inline-flex; align-items:center; gap:10px;
      background:#ecfeff; color:#075985; border:1px solid #bae6fd;
      padding:8px 14px; border-radius:999px; font-weight:900; box-shadow:0 8px 18px rgba(7,89,133,.15);
    }
    .marquee-dot{width:8px;height:8px;border-radius:50%;background:#22c55e}
    @keyframes marquee { 0%{transform: translateX(100%);} 100%{transform: translateX(-100%);} }
    .marquee:hover .marquee-track{ animation-play-state: paused; }
    @media (max-width: 820px){ .marquee-track{ animation-duration: 22s; } }
    @media (prefers-reduced-motion: reduce){ .marquee-track{ animation: none; } }

    /* Header */
    header.site{position:sticky;top:0;z-index:60;background:#fff;border-bottom:1px solid #e5e7eb}
    header .inner{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 16px}
    .logo{display:flex;gap:10px;align-items:center}
    .logo img{height:44px;width:44px;border-radius:10px;object-fit:cover}
    .nav-links{display:flex;flex-wrap:wrap}
    nav a{margin:0 10px;color:#0f172a;font-weight:700}
    nav a:hover{color:var(--brand)}
    .menu-toggle{display:none;background:#eef2f7;border:1px solid #e5e7eb;border-radius:10px;padding:8px 12px;font-weight:800}
    @media (max-width:820px){
      .menu-toggle{display:inline-block}
      .nav-links{display:none;flex-direction:column;gap:8px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px;position:absolute;top:68px;right:16px}
      .nav-links.open{display:flex}
      nav a{padding:10px 12px;border-radius:8px}
    }

    /* Hero */
    .hero{position:relative;min-height:66vh;border-radius:20px;overflow:hidden;color:#fff;display:grid;place-items:center;margin:16px 0}
    .hero::before{
      content:"";position:absolute;inset:0;background:
        linear-gradient(120deg,rgba(17,24,39,.85),rgba(17,24,39,.85)),
        url('images/hero.jpg') center/cover no-repeat;
    }
    .hero::after{
      content:""; position:absolute; inset:-30%; background:
        radial-gradient(60% 30% at 120% 0%, rgba(255,255,255,.12), transparent 60%);
      animation: sweep 8s ease-in-out infinite; pointer-events:none;
    }
    @keyframes sweep { 0%,100%{transform: translateX(0) translateY(0)} 50%{transform: translateX(-6%) translateY(-2%)} }
    .hero > .content{position:relative;text-align:center;padding:22px; animation: rise .8s ease-out both}
    @keyframes rise { from {opacity:0; transform: translateY(10px)} to {opacity:1; transform:translateY(0)} }
    .hero h1{font-weight:900;font-size:clamp(24px,6vw,44px);margin:6px 0 10px}
    .hero p{color:#e5e7eb;font-size:clamp(14px,3.5vw,18px);margin:0 0 16px}
    .btn{appearance:none;border:none;padding:14px 18px;border-radius:16px;font-weight:900;cursor:pointer;min-height:44px;transition: transform .18s ease, box-shadow .18s ease}
    .btn:active{transform: translateY(1px)}
    .btn-primary{background:var(--accent);color:#1e1b4b;box-shadow:0 8px 24px rgba(0,0,0,.22)}
    .btn-ghost{background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.25)}
    .btn-link{background:transparent;color:var(--brand);padding:0}
    .hero-actions{display:flex;justify-content:center;gap:12px;flex-wrap:wrap}
    .hero-actions .btn{flex:1 1 220px;max-width:320px}
    .enquiry-btn{background:var(--enq);color:#fff;border:none;font-size:1.05rem;padding:16px 22px;box-shadow:0 10px 28px rgba(255,87,34,.35);animation:pulseEnq 1.3s ease-in-out infinite}
    .enquiry-btn:hover{background:#ff7043}
    @keyframes pulseEnq{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .chipbar{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:12px}
    .chip{background:rgba(255,255,255,.14);color:#fff;border:1px solid rgba(255,255,255,.25);padding:8px 12px;border-radius:999px;font-size:13px;animation: fadeIn .8s ease both}
    @keyframes fadeIn { from {opacity:0; transform: translateY(6px)} to {opacity:1; transform: translateY(0)} }

    /* Grid & Cards */
    .grid{display:grid;gap:16px}
    .two{grid-template-columns:repeat(2,minmax(0,1fr))}
    .three{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:980px){.two,.three{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:18px;padding:18px;animation: pop .6s ease both}
    @keyframes pop { from {opacity:0; transform: scale(.98)} to {opacity:1; transform: scale(1)} }
    .badge{display:inline-flex;gap:8px;align-items:center;background:#eaf2ff;color:#1e40af;border:1px solid #bfdbfe;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px}

    .pill{display:inline-flex;gap:8px;align-items:center;padding:12px 14px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;min-height:44px;transition: transform .16s}
    .pill:hover{transform: translateY(-1px)}
    .pill[aria-pressed="true"]{border-color:var(--brand);box-shadow:0 0 0 4px #dbeafe}
    .section-title{font-weight:900;font-size:clamp(18px,4.6vw,28px);margin:16px 0 10px}
    .muted{color:var(--muted)}
    .service-card{transition:transform .25s, box-shadow .25s}
    .service-card:hover{transform:translateY(-4px);box-shadow:0 18px 40px rgba(2,6,23,.12)}
    .service-card h3{margin:6px 0 6px;color:var(--purple)}
    .section-image{width:100%;border-radius:14px;object-fit:cover}

    /* Carousel */
    .carousel{display:grid;grid-template-columns:1fr;gap:14px}
    blockquote{margin:0;padding:16px;background:#fff;border:1px solid #e5e7eb;border-radius:14px}
    .stars{color:#f59e0b}

    /* Accordion */
    .accordion .item{border:1px solid #e5e7eb;border-radius:14px;overflow:hidden}
    .accordion summary{list-style:none;cursor:pointer;padding:16px;font-weight:900;background:#fff}
    .accordion summary::-webkit-details-marker{display:none}
    .accordion .content{padding:0 16px 16px;color:#334155;background:#fcfdff}

    /* Sticky CTA */
    .cta-bar{position:sticky;bottom:10px;z-index:40;margin-top:24px;display:flex;justify-content:center;padding:0 16px}
    .cta-bar .inner{display:flex;gap:10px;background:#0b1220;color:#fff;padding:10px;border-radius:999px;box-shadow:0 12px 40px rgba(2,6,23,.35);width:100%;max-width:760px}
    .cta-bar .btn{flex:1 1 33%}

    /* Footer */
    footer{margin:26px 0 10px;color:#64748b;font-size:13px;text-align:center}

    /* Floating ELLA button + quick chips */
    .floating-referral{
      position:fixed; right:20px; bottom:calc(24px + 2cm); z-index:60;
      display:flex; align-items:center; gap:10px; text-align:left;
      background:var(--accent); color:#1e1b4b; text-decoration:none;
      font-weight:900; padding:14px 16px; border-radius:16px;
      min-width:280px; max-width:460px; line-height:1.25;
      box-shadow:0 16px 40px rgba(0,0,0,.25);
      animation:bob 2.2s ease-in-out infinite;
      border:0; cursor:pointer;
    }
    .floating-referral:hover{ background:#ffda44 }
    .floating-referral .title{ font-size:1rem; display:block }
    .floating-referral .sub{ font-size:.88rem; font-weight:700; opacity:.95; display:block }
    .ella-quickchips{
      position:fixed; right:20px; bottom:calc(24px + 2cm + 68px); z-index:60;
      display:flex; gap:8px; flex-wrap:wrap; max-width:460px;
    }
    .ella-chip{background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-weight:800;cursor:pointer}
    .ella-chip:hover{box-shadow:0 6px 18px rgba(2,6,23,.18)}
    .ella-float-img{
      position:absolute; right:12px; bottom:100%; width:64px; height:64px; 
      border-radius:50%; object-fit:cover; background:#fff;
      box-shadow:0 12px 28px rgba(0,0,0,.28);
      transform: translateY(8px);
      border:2px solid rgba(255,255,255,.9);
      pointer-events:none;
    }

    @keyframes bob { 0%,100%{transform: translateY(0)} 50%{transform: translateY(-4px)} }
    @media (min-width:980px){
      .floating-referral{ right:34px; bottom:calc(34px + 2cm); padding:16px 18px; border-radius:18px }
      .floating-referral .title{ font-size:1.05rem }
      .floating-referral .sub{ font-size:.95rem }
      .ella-quickchips{ right:34px; }
    }
    @media (max-width:480px){
      .floating-referral{ min-width:auto; max-width:85vw; padding:12px 14px }
      .floating-referral .sub{ display:none }
      .ella-quickchips{ max-width:85vw }
    }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      .enquiry-btn,.chip,.hero::after,.card,.floating-referral{animation:none}
    }

    /* Mid-page ELLA callout */
    .ella-callout{display:flex;align-items:center;gap:16px;flex-wrap:wrap;justify-content:space-between;background:#fff;border:1px solid #e5e7eb;border-radius:18px;padding:18px}
    .ella-callout h3{margin:0;font-size:1.25rem}
  </style>
</head>
<body>
  <!-- Top contact bar -->
  <div class="topbar">
    <div class="inner container">
      <div class="small">Because we care, we provide HD care</div>
      <div class="contact-links">
        <a href="tel:0286305500" aria-label="Call 02 8630 5500">üìû 02 8630 5500</a>
        <a href="mailto:info@hdheed.com.au">‚úâÔ∏è info@hdheed.com.au</a>
      </div>
    </div>
  </div>

  <!-- Marquee Ribbon -->
  <div class="marquee-wrap" role="region" aria-label="Registered NDIS Provider ticker">
    <div class="marquee">
      <div class="marquee-track">
        <span class="marquee-item"><span class="marquee-dot" aria-hidden="true"></span> Registered NDIS Provider</span>
        <span class="marquee-item">Clinically led care</span>
        <span class="marquee-item">Person-centred support</span>
        <span class="marquee-item">Serving NSW communities</span>
        <span class="marquee-item">Contact: 02 8630 5500</span>
        <span class="marquee-item">Email: info@hdheed.com.au</span>
        <!-- duplicate for seamless loop -->
        <span class="marquee-item"><span class="marquee-dot" aria-hidden="true"></span> Registered NDIS Provider</span>
        <span class="marquee-item">Clinically led care</span>
        <span class="marquee-item">Person-centred support</span>
        <span class="marquee-item">Serving NSW communities</span>
        <span class="marquee-item">Contact: 02 8630 5500</span>
        <span class="marquee-item">Email: info@hdheed.com.au</span>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header class="site" aria-label="Site header">
    <div class="inner container">
      <div class="logo">
        <img src="images/logo.png" alt="HD HeeD logo"/>
        <div>
          <div style="font-weight:900">HD HeeD</div>
          <div class="muted" style="font-size:13px">NDIS Registered ‚Ä¢ Clinically led ‚Ä¢ Person-centred</div>
        </div>
      </div>
      <button class="menu-toggle" id="menuToggle" aria-expanded="false" aria-controls="navLinks">Menu ‚ò∞</button>
      <nav aria-label="Top navigation">
        <div id="navLinks" class="nav-links">
          <a href="index.html" aria-current="page">Home</a>
          <a href="services.html">Services</a>
          <a href="about.html">About</a>
          <a href="contact.html">Contact</a>
          <a href="blog.html">Blog</a>
           <a href="onlineintakeforms.html">Online intake forms</a>
        </div>
      </nav>
    </div>
  </header>

  <main>
    <!-- HERO -->
    <section class="hero" aria-labelledby="h1">
      <div class="content">
        <img src="images/logo.png" alt="" style="width:72px;height:72px;border-radius:18px;object-fit:cover;opacity:.95"/>
        <h1 id="h1">Get the right help in minutes</h1>
        <p>Make an enquiry, start a referral, or chat with ELLA ‚Äî all with simple ‚ÄúNot sure‚Äù options.</p>
        <div class="hero-actions">
          <a class="btn btn-ghost" href="tel:0286305500" aria-label="Call HD HeeD on 02 8630 5500">Call 02 8630 5500</a>
          <a class="btn enquiry-btn" href="contact.html" aria-label="Make an Enquiry">Make an Enquiry</a>
          <a class="btn btn-primary" href="referral.html">Start referral</a>
          <button id="ella-cta-hero" class="btn btn-primary" aria-label="Start with ELLA">Start with ELLA</button>
        </div>
        <div class="chipbar">
          <span class="chip">Registered NDIS Provider</span>
          <span class="chip">Clinically led care</span>
          <span class="chip">Person-centred</span>
        </div>
      </div>
    </section>

    <!-- MID-PAGE ELLA CALLOUT -->
    <section class="container" aria-label="ELLA quick start">
      <div class="ella-callout">
        <div style="display:flex;gap:12px;align-items:center">
          <img src="images/ella/ella-default.png" alt="" style="width:52px;height:52px;border-radius:12px;border:1px solid #e5e7eb">
          <div>
            <h3>ELLA ‚Äî start care in 60 seconds. No long forms.</h3>
            <div class="muted">Used by participants, carers, coordinators & health professionals.</div>
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-primary" id="ella-cta-mid">Start with ELLA</button>
          <div class="chipbar" style="margin:0">
            <button class="pill" data-ella-role="participant" aria-pressed="false">Participant</button>
            <button class="pill" data-ella-role="carer" aria-pressed="false">Carer</button>
            <button class="pill" data-ella-role="sc" aria-pressed="false">Support Coordinator</button>
            <button class="pill" data-ella-role="hp" aria-pressed="false">Health Professional</button>
          </div>
        </div>
      </div>
    </section>

    <!-- QUICK SELECT + ROUTER + ABOUT -->
    <section class="container" id="router" style="margin-top:12px">
      <div class="grid two">
        <div class="card">
          <div class="badge">Quick selector</div>
          <p class="muted" style="margin:10px 0 8px">Who are you?</p>
          <div class="list" style="display:flex;flex-wrap:wrap;gap:10px">
            <button class="pill" data-role="participant" aria-pressed="false">Participant</button>
            <button class="pill" data-role="carer" aria-pressed="false">Family / Carer</button>
            <button class="pill" data-role="sc" aria-pressed="false">Support Coordinator</button>
            <button class="pill" data-role="hp" aria-pressed="false">Health Professional</button>
          </div>
          <div style="display:flex; gap:10px; margin-top:16px; flex-wrap:wrap">
            <a id="cta-referral" class="btn btn-primary" href="referral.html">Start referral</a>
            <a id="cta-enquiry" class="btn btn-ghost" href="contact.html">Make an enquiry</a>
            <button id="cta-ella-inline" class="btn btn-primary">Start with ELLA</button>
          </div>

          <hr style="border:none;border-top:1px dashed #e5e7eb;margin:16px 0">
          <div class="badge">20-second router</div>
          <p class="muted" style="margin:10px 0 8px">Answer a few taps; we‚Äôll suggest the best path.</p>
          <div id="qroot"></div>
        </div>

        <div class="card">
          <img class="section-image" src="images/about.jpg" alt="Team at HD HeeD providing support">
          <h2 class="section-title" style="margin-top:12px">About HD HeeD</h2>
          <p class="muted" style="text-align:left">
            Founded by experienced disability and aged care professionals, we provide respectful, person-centred support so people can live independently and confidently.
          </p>
          <div class="list" style="gap:8px;flex-wrap:wrap;display:flex">
            <span class="badge">NDIS Registered</span>
            <span class="badge">Clinically led</span>
            <span class="badge">Warm & reliable</span>
          </div>
          <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
            <a class="btn btn-ghost" href="about.html">More about us</a>
            <a class="btn btn-primary" href="services.html">Explore services</a>
          </div>
        </div>
      </div>
    </section>

    <!-- SERVICES -->
    <section class="container" style="margin-top:18px">
      <h2 class="section-title">What we can help with</h2>
      <div class="grid three">
        <div class="card service-card">
          <h3>Nursing care at home</h3>
          <p class="muted">Medication, wound care, chronic condition monitoring, and more ‚Äî delivered at home.</p>
          <a class="btn btn-link" href="nursing-care.html">Nursing care ‚Üí</a>
        </div>
        <div class="card service-card">
          <h3>Personal & daily living</h3>
          <p class="muted">Showering, dressing, grooming, mobility, toileting, and continence care with dignity.</p>
          <a class="btn btn-link" href="personal-care.html">Personal care ‚Üí</a>
        </div>
        <div class="card service-card">
          <h3>Community participation</h3>
          <p class="muted">Support to engage in social, cultural, and recreational activities that enrich life.</p>
          <a class="btn btn-link" href="community-participation.html">Community participation ‚Üí</a>
        </div>
      </div>

      <div class="grid three" style="margin-top:12px">
        <div class="card service-card">
          <h3>Domestic assistance</h3>
          <p class="muted">Cleaning, laundry, and household tasks to keep your space safe and welcoming.</p>
          <a class="btn btn-link" href="domestic-assistance.html">Domestic assistance ‚Üí</a>
        </div>
        <div class="card service-card">
          <h3>Daily living skills</h3>
          <p class="muted">Skill-building for cooking, budgeting, and other life tasks to support independence.</p>
          <a class="btn btn-link" href="daily-living-skills.html">Daily living skills ‚Üí</a>
        </div>
        <div class="card service-card">
          <h3>Respite & carer relief</h3>
          <p class="muted">Short-term support to give primary carers a break while care continues.</p>
          <a class="btn btn-link" href="carer-relief.html" style="margin-left:8px">Carer relief ‚Üí</a>
        </div>
      </div>
    </section>

    <!-- TRUST/CREDENTIALS -->
    <section class="container" style="margin-top:18px">
      <div class="card" style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;justify-content:space-between">
        <div style="display:flex;gap:10px;align-items:center">
          <img src="images/ndis-logo.png" alt="NDIS Registered Provider" style="height:40px"/>
          <img src="images/acnc-logo.png" alt="ACNC Charity Registered" style="height:40px"/>
        </div>
        <div class="muted">Trusted provider ‚Ä¢ Clinically led ‚Ä¢ Person-centred</div>
      </div>
    </section>

    <!-- TESTIMONIALS -->
    <section class="container" style="margin-top:18px">
      <h2 class="section-title">What our clients say</h2>
      <div class="carousel" id="carousel" aria-roledescription="carousel">
        <blockquote>
          <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
          ‚ÄúThe nurse from HD HeeD treated mum‚Äôs wound with so much care. Process was simple and quick.‚Äù
          <div class="muted">‚Äî Family carer</div>
        </blockquote>
        <blockquote hidden>
          <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
          ‚ÄúEasy referral form. They called back within a day and organised personal care supports.‚Äù
          <div class="muted">‚Äî Support coordinator</div>
        </blockquote>
        <blockquote hidden>
          <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
          ‚ÄúRespectful, on time, and they listened to what I wanted.‚Äù
          <div class="muted">‚Äî Participant</div>
        </blockquote>
        <div style="display:flex; gap:8px; margin-top:8px; justify-content:center">
          <button class="btn btn-ghost" id="prev" aria-label="Previous testimonial">‚Äπ</button>
          <button class="btn btn-ghost" id="next" aria-label="Next testimonial">‚Ä∫</button>
        </div>
      </div>
    </section>

    <!-- FAQs (ELLA NUDGE ABOVE) -->
    <section class="container" style="margin-top:18px">
      <div class="card" style="display:flex;align-items:center;gap:12px;justify-content:space-between;flex-wrap:wrap">
        <div><strong>Not sure where to start?</strong> Ask ELLA ‚Äî you can skip any question.</div>
        <button class="btn btn-primary" id="ella-cta-faq">Start with ELLA</button>
      </div>
      <h2 class="section-title" style="margin-top:16px">Quick answers</h2>
      <div class="grid two accordion">
        <details class="item">
          <summary>Who can make an enquiry or referral?</summary>
          <div class="content">Participants, family/carers, support coordinators, and health professionals.</div>
        </details>
        <details class="item">
          <summary>Do I need every detail before I refer?</summary>
          <div class="content">No. Our forms include ‚ÄúNot sure‚Äù everywhere so you can start now and finalise later.</div>
        </details>
        <details class="item">
          <summary>What services do you cover?</summary>
          <div class="content">Personal care, domestic assistance, community participation, and nursing care at home. See the Services page for details.</div>
        </details>
        <details class="item">
          <summary>How soon will someone get back to me?</summary>
          <div class="content">We aim to respond promptly after your submission and organise next steps with you.</div>
        </details>
      </div>
    </section>

    <!-- CONTACT SLICE -->
    <section class="container" style="margin-top:18px">
      <div class="card">
        <div class="grid two" style="align-items:center">
          <div>
            <h2 class="section-title" style="margin-top:0">Prefer to talk?</h2>
            <p class="muted" style="text-align:left">Call or email and we‚Äôll guide you.</p>
            <div style="display:flex; flex-wrap:wrap; gap:10px">
              <a class="btn btn-primary" href="tel:0286305500">Call 02 8630 5500</a>
              <a class="btn btn-ghost" href="mailto:info@hdheed.com.au">info@hdheed.com.au</a>
              <a class="btn btn-primary" href="referral.html">Start referral</a>
              <a class="btn btn-ghost" href="contact.html">Make an enquiry</a>
              <button class="btn btn-primary" id="ella-cta-contact">Start with ELLA</button>
            </div>

            <!-- Quick enquiry (Formspree) -->
            <form id="quickEnquiry" class="grid" style="gap:10px;margin-top:14px;max-width:560px" action="https://formspree.io/f/xvgrkkjn" method="POST">
              <input type="hidden" name="_subject" value="Quick enquiry from HD HeeD home">
              <label class="sr-only" for="qe-msg">Your message</label>
              <textarea id="qe-msg" name="message" placeholder="E.g., wound dressing at home in Parramatta‚Ä¶" required style="width:100%;min-height:110px"></textarea>
              <div class="grid two" style="gap:10px">
                <input id="qe-name" name="name" placeholder="Your name" />
                <input id="qe-email" name="email" placeholder="Your email" type="email" />
              </div>
              <button class="btn btn-primary" type="submit" id="qe-submit">Send quick enquiry</button>
              <div id="qe-status" class="muted" role="status" aria-live="polite"></div>
            </form>
          </div>
          <div>
            <img class="section-image" src="images/contact.jpg" alt="Customer service at HD HeeD">
          </div>
        </div>
      </div>
    </section>

    <!-- Sticky CTA -->
    <div class="cta-bar" aria-hidden="false">
      <div class="inner">
        <a class="btn btn-primary" href="referral.html">Start referral</a>
        <a class="btn btn-ghost" href="contact.html">Enquiry</a>
        <button class="btn btn-primary" id="ella-cta-sticky">Start with ELLA</button>
      </div>
    </div>
  </main>

  <footer>
    ¬© 2025 HD HeeD ‚Ä¢ <a href="privacy.html">Privacy</a> ‚Ä¢ <a href="sitemap.xml">Sitemap</a>
  </footer>

  <!-- Floating ELLA quick-start chips (fixed) -->
  <div class="ella-quickchips" aria-label="ELLA quick start audience chips">
    <button class="ella-chip" data-ella-role="participant">Participant</button>
    <button class="ella-chip" data-ella-role="carer">Carer</button>
    <button class="ella-chip" data-ella-role="sc">Support Coordinator</button>
    <button class="ella-chip" data-ella-role="hp">Health Professional</button>
  </div>

  <!-- Floating ELLA Button -->
  <button id="ella-launch" class="floating-referral" aria-label="Start with ELLA" type="button">
    <img src="images/ella/ella-default.png" alt="Ella" class="ella-float-img" aria-hidden="true">
    <span class="title">üí¨ Start with ELLA</span>
    <span class="sub">Start care in 60 seconds. No long forms.</span>
  </button>

  <script>
    // Mobile menu
    const toggle = document.getElementById('menuToggle');
    const navLinks = document.getElementById('navLinks');
    if (toggle){
      toggle.addEventListener('click', ()=>{
        const open = navLinks.classList.toggle('open');
        toggle.setAttribute('aria-expanded', String(open));
      });
    }

    // Role mapping keeps CTAs relevant (adds role to URL)
    const roleMap = {
      participant:{ref:'referral.html', enq:'contact.html'},
      carer:{ref:'referral.html', enq:'contact.html'},
      sc:{ref:'referral.html', enq:'contact.html'},
      hp:{ref:'referral.html', enq:'contact.html'}
    };
    const setRole = (role)=>{
      document.querySelectorAll("[data-role]").forEach(b=>b.setAttribute("aria-pressed", String(b.dataset.role===role)));
      const ref = document.getElementById("cta-referral");
      const enq = document.getElementById("cta-enquiry");
      if (!ref || !enq) return;
      const p = new URLSearchParams({role});
      ref.href = (roleMap[role]?.ref || "referral.html") + "?" + p.toString();
      enq.href = (roleMap[role]?.enq || "contact.html") + "?" + p.toString();
    };
    document.querySelectorAll("[data-role]").forEach(b=> b.addEventListener("click", ()=> setRole(b.dataset.role)));

    // Router (3 small questions)
    const qroot = document.getElementById("qroot");
    const q = [
      {k:"who", q:"Are you a participant, carer, or professional?", opts:["Participant","Carer","Support coordinator","Health professional"]},
      {k:"urgency", q:"How soon do you need support?", opts:["Urgent (24‚Äì72h)","Soon (1‚Äì2 weeks)","Exploring options"]},
      {k:"info", q:"Do you have details handy?", opts:["Yes","Some","Not sure"]}
    ];
    const answers = {};
    function renderQ(i=0){
      if(!qroot) return;
      if(i>=q.length){ renderResult(); return; }
      const step = q[i];
      qroot.innerHTML = `
        <div class="grid" style="gap:10px">
          <div><strong>${step.q}</strong></div>
          <div class="list" style="display:flex;gap:10px;flex-wrap:wrap">
            ${step.opts.map(o=>`<button class="pill" data-a="${step.k}" data-v="${o}">${o}</button>`).join("")}
          </div>
        </div>`;
      qroot.querySelectorAll("[data-a]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          answers[btn.dataset.a] = btn.dataset.v;
          renderQ(i+1);
        });
      });
    }
    function renderResult(){
      const urgent = (answers.urgency||"").toLowerCase().includes("urgent");
      const infoSome = ["Yes","Some"].includes(answers.info);
      const recommendReferral = urgent || infoSome;
      const params = new URLSearchParams({
        role:(answers.who||"").toLowerCase().replace(" ","_"),
        urgency:answers.urgency||"",
        info:answers.info||""
      }).toString();
      const referUrl = "referral.html?"+params;
      const enqUrl   = "contact.html?"+params;
      qroot.innerHTML = `
        <div class="card" style="background:#f8fafc">
          <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
            <img src="images/logo.png" alt="" style="width:28px;height:28px;border-radius:8px;object-fit:cover"/>
            <strong>We recommend ${recommendReferral? "starting a referral" : "making an enquiry"}.</strong>
          </div>
          <p class="muted">You can still choose either path ‚Äî both include ‚ÄúNot sure‚Äù options.</p>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <a class="btn btn-primary" href="${referUrl}">Go to referral</a>
            <a class="btn btn-ghost" href="${enqUrl}">Make an enquiry</a>
          </div>
        </div>`;
    }
    renderQ(0);

    // Testimonials carousel
    (function(){
      const prev = document.getElementById("prev");
      const next = document.getElementById("next");
      const nodes = Array.from(document.querySelectorAll("#carousel blockquote"));
      if (!nodes.length || !prev || !next) return;
      let i = 0;
      const show = idx => nodes.forEach((n,j)=> n.hidden = j!==idx);
      prev.addEventListener("click", ()=>{ i = (i-1+nodes.length)%nodes.length; show(i); });
      next.addEventListener("click", ()=>{ i = (i+1)%nodes.length; show(i); });
      setInterval(()=>{ i=(i+1)%nodes.length; show(i); }, 6000);
      show(0);
    })();

    // Quick enquiry (Formspree)
    const qeForm = document.getElementById('quickEnquiry');
    const qeStatus = document.getElementById('qe-status');
    if (qeForm){
      qeForm.addEventListener('submit', function(e){
        e.preventDefault();
        const form = e.currentTarget;
        const data = new FormData(form);
        qeStatus.textContent = "Sending‚Ä¶";
        fetch(form.action, { method: "POST", body: data, headers: { "Accept": "application/json" }})
          .then(r => { if (!r.ok) throw new Error("Network"); return r.json(); })
          .then(() => { qeStatus.textContent = "Thanks ‚Äî we‚Äôve received your enquiry."; form.reset(); })
          .catch(() => {
            const body = encodeURIComponent(
              `Quick enquiry from HD HeeD home:\n\nMessage:\n${data.get('message')}\n\nName: ${data.get('name')}\nEmail: ${data.get('email')}`
            );
            window.location.href = `mailto:info@hdheed.com.au?subject=Quick%20enquiry%20from%20HD%20HeeD&body=${body}`;
            qeStatus.textContent = "Opening your email app‚Ä¶";
          });
      });
    }

    // ELLA hero & other CTAs -> open panel
    const openEllaFromBtn = (btn)=> btn && btn.addEventListener('click', ()=> window.ELLA && window.ELLA.open());
    ['ella-cta-hero','ella-cta-mid','cta-ella-inline','ella-cta-faq','ella-cta-contact','ella-cta-sticky']
      .forEach(id => openEllaFromBtn(document.getElementById(id)));

    // Floating quick chips set role + open
    function tapEllaQuick(role){
      try{ sessionStorage.setItem('ella_prefill_role', role); }catch{}
      if (window.ELLA && typeof window.ELLA.open==='function'){ window.ELLA.open(); }
    }
    document.querySelectorAll('[data-ella-role]').forEach(el=>{
      el.addEventListener('click', ()=> tapEllaQuick(el.getAttribute('data-ella-role')));
    });
  </script>

 <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ELLA ‚Äî Voice Intake Assistant | HD HeeD</title>
  <meta name="theme-color" content="#0b0f1a"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet"/>

  <!-- === HD HeeD ‚Ä¢ ELLA (Voice Intake Assistant ‚Ä¢ v3.5) === -->
  <style>
    :root{ --al-ink:#0c1226; --al-bg:#0b0f1a; --al-panel:#10172a; --al-line:#243153; --al-text:#e8edff; --al-accent:#ffc107; }
    /* Greeting */
    #alan-greet{position:fixed;right:18px;bottom:18px;z-index:9999;display:none}
    #alan-greet .card{
      max-width:560px;width:calc(100vw - 36px);background:#0e1428;color:var(--al-text);
      border:1px solid var(--al-line);border-radius:16px;box-shadow:0 24px 90px rgba(0,0,0,.55);
      padding:18px;font-family:Inter,system-ui
    }
    #alan-greet h2{margin:0 0 6px 0;font-size:1.28rem}
    #alan-greet p{margin:0 0 12px 0;opacity:.95;font-size:1rem;line-height:1.5}
    .al-btn{border:0;border-radius:12px;padding:12px 16px;font-weight:900;cursor:pointer}
    .al-btn.primary{background:var(--al-accent);color:#2a2100;box-shadow:0 12px 34px rgba(0,0,0,.35)}
    .al-btn.ghost{background:#121a3a;color:#e7ebff;border:1px solid var(--al-line)}

    /* Panel */
    #alan-panel{position:fixed;right:18px;bottom:18px;z-index:10000;display:none}
    #alan-panel .wrap{
      width:680px; max-width:calc(100vw - 36px); max-height:85vh;
      background:linear-gradient(180deg,#10172a,#0b0f1a);color:var(--al-text);
      border:1px solid var(--al-line);border-radius:18px;box-shadow:0 28px 110px rgba(0,0,0,.6);overflow:hidden;
      font-family:Inter,system-ui;display:flex;flex-direction:column
    }
    @media (min-width:1100px){ #alan-panel .wrap{ width:860px; } }

    .al-head{position:sticky;top:0;z-index:2;display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid var(--al-line);background:#0d1428}
    .al-head .avatar{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#ffcdd2,#ffe0e0);display:grid;place-items:center;color:#5a1b29;font-weight:900}
    .al-head .ttl{font-weight:900}

    .al-body{ display:grid; grid-template-columns:220px 1fr; gap:16px;overflow:auto;min-height:0;padding:16px }
    .al-portrait{position:sticky;top:64px;align-self:start}
    .al-portrait img{ width:100%;height:auto;display:block; border:none;background:transparent;border-radius:16px; filter: drop-shadow(0 18px 36px rgba(0,0,0,.35)); }
    .al-main{display:grid;gap:12px}
    .al-meta{display:flex;align-items:center;gap:10px;font-size:12px;color:#b7c6ff}
    .al-meter{height:8px;background:#101838;border:1px solid var(--al-line);border-radius:999px;overflow:hidden;flex:1}
    .al-meter>div{height:100%;background:linear-gradient(90deg,#ffd95c,#ffe78f);width:0%}
    .al-q{font-size:1.25rem;font-weight:900;line-height:1.4}
    .al-opts{display:grid;gap:10px}
    .al-chip{border:1px solid var(--al-line);background:linear-gradient(180deg,#121a3a,#0f172f);color:#e7ebff;border-radius:12px;padding:14px;text-align:left;cursor:pointer;font-size:1.02rem}
    .al-chip:hover{box-shadow:0 12px 34px rgba(0,0,0,.28)}
    .al-foot{position:sticky;bottom:0;z-index:2;display:flex;gap:8px;align-items:center;justify-content:space-between;border-top:1px dashed var(--al-line);padding:10px;background:#0b1226}
    .al-pill{border:1px solid var(--al-line);background:#0f1937;border-radius:999px;padding:6px 10px;color:#cfe0ff;font-size:12px}
    .al-mic{border:1px solid var(--al-line);background:#101a3a;color:#e7ebff;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer}
    .al-mic.on{background:#13244f}
    .al-close{border:1px solid var(--al-line);background:#121a3a;color:#e7ebff;border-radius:999px;padding:8px 12px;cursor:pointer}

    .al-inlinebox{border:1px solid var(--al-line);background:#0e162e;border-radius:12px;padding:12px;display:grid;gap:8px;margin-top:6px}
    .al-inlinebox input, .al-inlinebox select{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3b68;background:#0f1b3b;color:#e7ebff;font-size:14px}

    .al-endbox{border:1px solid var(--al-line);background:#0e162e;border-radius:12px;padding:12px;display:grid;gap:8px}
    .al-endbox input, .al-endbox textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3b68;background:#0f1b3b;color:#e7ebff;font-size:14px}
    .al-actions{display:flex;gap:8px;flex-wrap:wrap}

    @media (max-width:640px){ .al-body{grid-template-columns:1fr} .al-portrait{position:static;max-width:200px;margin:0 auto} }
  </style>
</head>
<body>

<!-- GREET -->
<div id="alan-greet" aria-live="polite">
  <div class="card">
    <h2>Hi, I‚Äôm <strong id="al-greet-name">ELLA</strong> ‚Äî your intake assistant</h2>
    <p>
      Skip the wait ‚Äî talk to me and I‚Äôll organise help <strong>faster than a phone call</strong>.
      I‚Äôll ask a few short questions and do the admin for you.
    </p>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button id="alan-start" class="al-btn primary" aria-label="Let‚Äôs talk">Let‚Äôs talk</button>
      <button id="alan-hide" class="al-btn ghost" aria-label="Not now">Not now</button>
    </div>
  </div>
</div>

<!-- PANEL -->
<div id="alan-panel" role="dialog" aria-label="Chat with ELLA">
  <div class="wrap">
    <div class="al-head">
      <div class="avatar" id="al-avatar">EL</div>
      <div class="ttl" id="al-title">ELLA ‚Äî Intake Assistant</div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <span class="al-pill">Voice: <span id="al-voice" style="color:#ffe28f">On</span></span>
        <button id="al-close" class="al-close" type="button" aria-label="Close">Close</button>
      </div>
    </div>

    <div class="al-body">
      <!-- Left portrait -->
      <div class="al-portrait">
        <img id="al-portrait-img" src="images/ella/ella-default.png" alt="Ella ‚Äî friendly assistant portrait">
      </div>

      <!-- Right content -->
      <div class="al-main">
        <div class="al-meta">
          <span id="al-step">Step 1/16</span>
          <div class="al-meter" aria-label="Progress"><div id="al-bar"></div></div>
        </div>
        <div id="al-q" class="al-q">‚Ä¶</div>
        <div id="al-opts" class="al-opts"></div>
        <div id="al-system" style="font-size:12px;color:#a8b6e8"></div>

        <!-- End details -->
        <div id="al-end" class="al-endbox" style="display:none">
          <div style="font-weight:900">Optional details to speed things up</div>
          <input id="al-name" placeholder="Your name or initials (optional)">
          <input id="al-email" placeholder="Email (required if no phone)">
          <input id="al-phone" placeholder="Phone (required if no email)">
          <textarea id="al-notes" rows="4" placeholder="Anything else you‚Äôd like us to know (optional)"></textarea>
          <div class="al-actions">
            <button id="al-send" class="al-btn primary" disabled>Send now</button>
            <button id="al-later" class="al-btn ghost">Do later</button>
            <button id="al-download" class="al-btn ghost">Download summary</button>
          </div>
          <div id="al-contact-warning" style="font-size:12px;color:#ffd95c;display:none">Please provide at least an email or a phone number to send now.</div>
        </div>
      </div>
    </div>

    <div class="al-foot">
      <div class="al-pill">Tap ‚ÄúClick to talk‚Äù to speak ‚Ä¢ Or tap a choice</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="al-mic" class="al-mic" aria-pressed="false">üé§ Click to talk</button>
        <button id="al-back" class="al-mic">‚Üê Back</button>
        <button id="al-restart" class="al-mic">‚Üª Restart</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  /* ===== Config ===== */
  const FS_ENDPOINT = "https://formspree.io/f/xvgrkkjn";
  const SITE_EMAIL  = "info@hdheed.com.au";
  const SITE_PHONE  = "02 8630 5500";
  const PREFER_MALE_VOICE = false; // prefer female for ELLA

  /* ===== Portraits ===== */
  const ELLA_IMAGES = {
    default: "images/ella/ella-default.png",
    caller:  "images/ella/ella-caller.png",
    consent: "images/ella/ella-consent.png",
    loc:     "images/ella/ella-location.png",
    service: "images/ella/ella-service.png",
    rostering:"images/ella/ella-rostering.png",
    pref:    "images/ella/ella-preferences.png",
    mgmt:    "images/ella/ella-management.png",
    pm_details:"images/ella/ella-management.png",
    dates:   "images/ella/ella-dates.png",
    hrs:     "images/ella/ella-hours.png",
    risk_beh:"images/ella/ella-risk-beh.png",
    risk_med:"images/ella/ella-risk-med.png",
    risk_int:"images/ella/ella-interpreter.png",
    urgency: "images/ella/ella-urgency.png",
    contact_win:"images/ella/ella-contact-window.png",
    highcare:"images/ella/ella-service.png",
    referrer:"images/ella/ella-caller.png",
    final:   "images/ella/ella-summary.png"
  };

  /* ===== State & DOM ===== */
  const SKEY='hdheed_ella_v35';
  let S = {
    i:0,
    participant_name: null,              // required gate

    caller:null, consent:null,
    // Referrer
    referrer_name: null,
    referrer_org: null,
    referrer_email: null,
    referrer_phone: null,

    suburb:null, postcode:null,

    // Supports (multi-select) + legacy single
    services: [],
    service_cats: [],
    service:null, cat:null, // legacy compatibility (first selection)

    // High-care
    highcare: [],
    highcare_other: null,

    // Plan management
    mgmt:null, pm_name:null, pm_email:null, dates:null,

    hrs:null,
    risks:{beh:null, med:null, int:null},
    interpreter:{language:null},
    pref:{worker:null, gender:null, transport:null, access:null, none:false},
    urgency:null, rostering:null,
    contact_window:null,

    name:null, email:null, phone:null, route:null,
    custom:{}, notes:[]
  };
  try{ const prev=JSON.parse(localStorage.getItem(SKEY)||'null'); if(prev) S=prev; }catch{}
  const save=()=>{ try{ localStorage.setItem(SKEY, JSON.stringify(S)); }catch{} };

  const greet = document.getElementById('alan-greet');
  const greetName = document.getElementById('al-greet-name');
  const startBtn = document.getElementById('alan-start');
  const hideBtn  = document.getElementById('alan-hide');
  const panel = document.getElementById('alan-panel');
  const qEl   = document.getElementById('al-q');
  const optsEl= document.getElementById('al-opts');
  const stepEl= document.getElementById('al-step');
  const barEl = document.getElementById('al-bar');
  const sysEl = document.getElementById('al-system');
  const micBtn= document.getElementById('al-mic');
  const restartBtn = document.getElementById('al-restart');
  const voiceBadge = document.getElementById('al-voice');
  const endBox = document.getElementById('al-end');
  const fName = document.getElementById('al-name');
  const fEmail= document.getElementById('al-email');
  const fPhone= document.getElementById('al-phone');
  const fNotes= document.getElementById('al-notes');
  const btnSend = document.getElementById('al-send');
  const btnLater= document.getElementById('al-later');
  const btnDownload= document.getElementById('al-download');
  const headerTitle = document.getElementById('al-title');
  const avatar = document.getElementById('al-avatar');
  const contactWarn = document.getElementById('al-contact-warning');
  const portraitImg = document.getElementById('al-portrait-img');

  /* ===== Voice (TTS + SR) ===== */
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recog = null, speaking=false, voice=null, assistantName='ELLA';

  function pickVoice(){
    const voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
    function likeFemale(v){ return /female|samantha|victoria|google uk english female|microsoft (aria|zoe|natasha|jenny|lisa|sonia|hazel)/i.test(v.name); }
    function likeMale(v){ return /male|daniel|google uk english male|microsoft (david|mark|guy|george)/i.test(v.name); }
    voice = PREFER_MALE_VOICE ? (voices.find(likeMale)||voices.find(v=>/en/i.test(v.lang))) :
                                (voices.find(likeFemale)||voices.find(v=>/en/i.test(v.lang)));
    headerTitle.textContent = `${assistantName} ‚Äî Intake Assistant`;
    greetName.textContent = assistantName;
    avatar.textContent = assistantName.slice(0,2).toUpperCase();
  }
  if (SR){
    recog = new SR(); recog.lang='en-AU'; recog.interimResults=false; recog.continuous=false;
    recog.onresult = (e)=>{ if (speaking) return; const t=e.results[0][0].transcript; handleSpeech(t); };
    recog.onend = ()=>{ document.getElementById('al-mic').classList.remove('on'); document.getElementById('al-mic').setAttribute('aria-pressed','false'); };
  } else { voiceBadge.textContent='Off'; }

  function speak(text){
    if (!('speechSynthesis' in window)) return;
    const u = new SpeechSynthesisUtterance(String(text));
    if (voice) u.voice = voice;
    u.lang='en-AU';
    u.onstart=()=>{ speaking=true; try{ recog && recog.abort(); }catch{} };
    u.onend=()=>{ speaking=false; };
    window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
  }
  function listen(){
    if (!recog || speaking) return;
    try{
      document.getElementById('al-mic').classList.add('on');
      document.getElementById('al-mic').setAttribute('aria-pressed','true');
      recog.start();
    }catch{}
  }

  /* ===== Flow (dynamic) ===== */
  const NS = (t='Not sure ‚Äî please guide me')=>({k:'NS',t,apply:()=>{}});
  const o = (k,t,apply=()=>{})=>({k,t,apply});

  function flow(){
    const base = [
      {id:'caller', q:"Who am I speaking with today?",
        opts:[ o('A','Participant',()=>S.caller='Participant'),
               o('B','Family / Carer',()=>S.caller='Carer'),
               o('C','Support Coordinator',()=>S.caller='Support Coordinator'),
               o('D','Plan Manager',()=>S.caller='Plan Manager'), NS() ]},

      {id:'consent', q:"May I note verbal consent to collect details and, if needed, contact your Support Coordinator or Plan Manager?",
        opts:[ o('A','Yes',()=>S.consent='Yes'),
               o('B','Not yet',()=>S.consent='Not yet'),
               o('C','Not sure',()=>S.consent='Not sure'),
               o('D','No',()=>S.consent='No'), NS() ]},

      {id:'referrer', q:"Referrer details (name & contact).",
        opts:[ o('A','(typed only)',()=>{}), o('B','(disabled)',()=>{}), o('C','(disabled)',()=>{}), o('D','(disabled)',()=>{}), NS() ]},

      {id:'loc', q:"Which area is support required? Please type suburb and postcode.",
        opts:[ o('A','(typed only)',()=>{}), o('B','(disabled)',()=>{}), o('C','(disabled)',()=>{}), o('D','(disabled)',()=>{}), NS() ]},

      {id:'service', q:"Which supports are required?",
        opts:[ o('A','Personal care',()=>{}),
               o('B','Community participation',()=>{}),
               o('C','Nursing care',()=>{}),
               o('D','Daily living skills',()=>{}), NS() ]},

      {id:'highcare', q:"Any high-care needs? (Select all that apply, then ‚úì Continue)",
        opts:[ o('A','Catheter care',()=>{}),
               o('B','Stoma/ostomy care',()=>{}),
               o('C','Complex wound care',()=>{}),
               o('D','PEG/enteral feeding',()=>{}),
               NS('Other / type below') ]},

      {id:'rostering', q:"What time windows suit you for support visits?",
        opts:[ o('A','Weekday mornings (7‚Äì11am)',()=>S.rostering='Weekday AM'),
               o('B','Weekday afternoons (12‚Äì4pm)',()=>S.rostering='Weekday PM'),
               o('C','Evenings (5‚Äì9pm)',()=>S.rostering='Evenings'),
               o('D','Weekends',()=>S.rostering='Weekends'), NS('Flexible') ]},

      {id:'pref', q:"Any preferences we should know? (You can choose more than one, then press ‚úì Continue)",
        opts:[ o('A','Worker gender preference',()=>{}),
               o('B','Transport required',()=>{}),
               o('C','Keysafe / someone home for access',()=>{}),
               o('D','No preferences',()=>{S.pref.none=true}) ]},

      {id:'mgmt', q:"How is the NDIS plan managed?",
        opts:[ o('A','NDIA-managed',()=>S.mgmt='NDIA-managed'),
               o('B','Plan-managed',()=>S.mgmt='Plan-managed'),
               o('C','Self-managed',()=>S.mgmt='Self-managed'),
               o('D','Not sure',()=>S.mgmt='Not sure'), NS() ]},

      // pm_details inserted conditionally here

      {id:'dates', q:"Do you know the plan dates?",
        opts:[ o('A','Active',()=>S.dates='Active'),
               o('B','Expiring soon',()=>S.dates='Expiring soon'),
               o('C','Not sure',()=>S.dates='Not sure'),
               o('D','Expired',()=>S.dates='Expired'), NS() ]},

      {id:'hrs', q:"Roughly how many support hours per week?",
        opts:[ o('A','2‚Äì4 hrs/week',()=>S.hrs='2‚Äì4'),
               o('B','5‚Äì10 hrs/week',()=>S.hrs='5‚Äì10'),
               o('C','10+ hrs/week',()=>S.hrs='10+'),
               o('D','Not sure',()=>S.hrs='Not sure'), NS() ]},

      {id:'risk_beh', q:"Any behaviours of concern / Behaviour Support Plan?",
        opts:[ o('A','Yes',()=>S.risks.beh=true),
               o('B','No',()=>S.risks.beh=false),
               o('C','Not sure',()=>S.risks.beh=null),
               o('D','Prefer not to say',()=>S.risks.beh=null), NS() ]},

      {id:'risk_med', q:"Any clinical needs (meds / wound care)?",
        opts:[ o('A','Yes',()=>S.risks.med=true),
               o('B','No',()=>S.risks.med=false),
               o('C','Not sure',()=>S.risks.med=null),
               o('D','Prefer not to say',()=>S.risks.med=null), NS() ]},

      {id:'risk_int', q:"Would you like an interpreter?",
        opts:[ o('A','Yes (choose language)',()=>{S.risks.int=true}),
               o('B','No',()=>S.risks.int=false),
               o('C','Not sure',()=>S.risks.int=null),
               o('D','Prefer not to say',()=>S.risks.int=null), NS() ]},

      {id:'urgency', q:"When would you like to start?",
        opts:[ o('A','Urgent (24‚Äì72h)',()=>S.urgency='Urgent'),
               o('B','Soon (1‚Äì2 weeks)',()=>S.urgency='Soon'),
               o('C','Exploring options',()=>S.urgency='Exploring'),
               o('D','Not sure',()=>S.urgency='Not sure'), NS() ]},

      {id:'contact_win', q:"What time window suits you best to be contacted?",
        opts:[ o('A','Morning (9‚Äì12)',()=>S.contact_window='Morning (9‚Äì12)'),
               o('B','Afternoon (12‚Äì4)',()=>S.contact_window='Afternoon (12‚Äì4)'),
               o('C','Evening (4‚Äì7)',()=>S.contact_window='Evening (4‚Äì7)'),
               o('D','Anytime',()=>S.contact_window='Anytime'), NS('Just type your preference') ]},

      {id:'final', q:"Shall I prepare this now as a Referral (A) or a General Enquiry (B)?",
        opts:[ o('A','Referral',()=>S.route='Referral'),
               o('B','Enquiry',()=>S.route='Enquiry'),
               o('C','Review first',()=>S.route='Review'),
               o('D','Save only (no send)',()=>S.route='Save'), NS() ]}
    ];

    const out = [...base];
    const idx = out.findIndex(s => s.id==='mgmt');
    if (S.mgmt === 'Plan-managed'){
      out.splice(idx+1, 0, {
        id:'pm_details',
        q:"Plan-managed selected ‚Äî please add Plan Manager details.",
        opts:[ o('A','(typed only)',()=>{}), o('B','(disabled)',()=>{}), o('C','(disabled)',()=>{}), o('D','(disabled)',()=>{}), NS() ]
      });
    }
    return out;
  }

  /* ===== Labels for typed boxes ===== */
  const CUSTOM_LABELS = {
    caller:"Want to type who you are?",
    consent:"Want to type your consent status?",
    loc:"Want to type your exact suburb and postcode?",
    service:"Want to type a specific support?",
    rostering:"Want to type your exact visit times?",
    pref:"Want to type your preferences?",
    mgmt:"Want to type plan management?",
    dates:"Want to type your exact plan dates?",
    hrs:"Want to type hours per week?",
    risk_beh:"Want to type behaviour details?",
    risk_med:"Want to type clinical needs?",
    risk_int:"Want to type the interpreter language?",
    urgency:"Want to type when to start?",
    contact_win:"Want to type your contact window?"
  };
  const CUSTOM_PLACEHOLDERS = {
    caller:"e.g., Participant / Mum / Support Coordinator Jane",
    consent:"e.g., Yes / Not yet",
    loc:"Suburb, Postcode",
    service:"e.g., Nursing care for meds",
    rostering:"e.g., Tue/Thu 7‚Äì9am",
    pref:"e.g., Female worker, has car",
    mgmt:"e.g., Plan-managed by ABC PM",
    dates:"e.g., 01 Oct 2025 ‚Äì 30 Sep 2026",
    hrs:"e.g., ~6 hrs/week",
    risk_beh:"e.g., BSP in place; triggers loud noise",
    risk_med:"e.g., Webster pack; daily prompting",
    risk_int:"e.g., Arabic",
    urgency:"e.g., After hospital discharge next week",
    contact_win:"e.g., Weekdays after 3pm"
  };

  /* ===== Render helpers ===== */
  function setPortrait(stepId){
    const src = ELLA_IMAGES[stepId] || ELLA_IMAGES.default;
    portraitImg.src = src; portraitImg.alt = "Ella ‚Äî " + (stepId||"assistant");
  }

  function totalStepsCount(){ return flow().length + 1; } // +1 for name gate

  function injectCustomBox(stepId, label, placeholder, onSave){
    const box=document.createElement('div');
    box.className='al-inlinebox';
    const inputId = `al-custom-${stepId}`;
    box.innerHTML = `
      <div style="font-weight:700">${label||'Type your exact preference'}</div>
      <input id="${inputId}" placeholder="${placeholder||'Type here'}" autocomplete="off">
      <button id="al-custom-save" class="al-btn ghost">Save & continue</button>
    `;
    optsEl.appendChild(box);
    box.querySelector('#al-custom-save').onclick=()=>{
      const txt=(box.querySelector('#'+inputId).value||'').trim();
      if(!txt){
        sysEl.textContent='Please type something or choose one of the options.';
        speak('Please type something, or choose one of the options.');
        return; 
      }
      onSave && onSave(txt);
    };
  }

  function injectLocationBox(required){
    const locBox=document.createElement('div');
    locBox.id='al-locbox';
    locBox.className='al-inlinebox';
    locBox.innerHTML = `
      <div style="font-weight:700">Type your suburb and postcode</div>
      <input id="al-suburb" placeholder="Suburb" ${required?'required':''}>
      <input id="al-postcode" placeholder="Postcode" ${required?'required':''}>
      <button id="al-locsave" class="al-btn ghost">Save & continue</button>
    `;
    optsEl.appendChild(locBox);
    locBox.querySelector('#al-locsave').onclick=()=>{
      const sub=locBox.querySelector('#al-suburb').value.trim();
      const pc=locBox.querySelector('#al-postcode').value.trim();
      if (required && (!sub || !pc)){
        sysEl.textContent='Please add both suburb and postcode.'; speak('Please add both suburb and postcode.'); return;
      }
      if (sub) S.suburb=sub; if (pc) S.postcode=pc; save(); sysEl.textContent='Location saved.'; next();
    };
  }

  function injectPlanManagerBox(){
    const box=document.createElement('div');
    box.className='al-inlinebox';
    box.innerHTML = `
      <div style="font-weight:700">Plan Manager details</div>
      <input id="al-pm-name"  placeholder="Plan Manager / Organisation name" required>
      <input id="al-pm-email" placeholder="Plan Manager email" required>
      <button id="al-pm-save" class="al-btn ghost">Save & continue</button>
    `;
    optsEl.appendChild(box);
    document.getElementById('al-pm-save').onclick=()=>{
      const n=(document.getElementById('al-pm-name').value||'').trim();
      const e=(document.getElementById('al-pm-email').value||'').trim();
      if (!n || !/\S+@\S+\.\S+/.test(e)){
        sysEl.textContent='Please enter a name and a valid email.';
        speak('Please enter a name and a valid email.');
        return;
      }
      S.pm_name=n; S.pm_email=e; save(); next();
    };
  }

  function injectReferrerBox(){
    const box = document.createElement('div');
    box.className = 'al-inlinebox';
    box.innerHTML = `
      <div style="font-weight:700">Referrer details</div>
      <input id="al-ref-name"  placeholder="Your name (e.g., Jane Smith) ‚Äî required" required>
      <input id="al-ref-org"   placeholder="Organisation (optional)">
      <input id="al-ref-email" placeholder="Email (required if no phone)">
      <input id="al-ref-phone" placeholder="Phone (required if no email)">
      <button id="al-ref-save" class="al-btn ghost">Save & continue</button>
    `;
    optsEl.appendChild(box);

    document.getElementById('al-ref-save').onclick = ()=>{
      const name  = (document.getElementById('al-ref-name').value||'').trim();
      const org   = (document.getElementById('al-ref-org').value||'').trim();
      const email = (document.getElementById('al-ref-email').value||'').trim();
      const phone = (document.getElementById('al-ref-phone').value||'').trim();

      const emailOk = !email || /\S+@\S+\.\S+/.test(email);
      const phoneOk = !phone || /^\+?[0-9 ()-]{8,}$/.test(phone);

      if (!name){
        sysEl.textContent = 'Please enter your full name.';
        speak('Please enter your full name.');
        return;
      }
      if (!email && !phone){
        sysEl.textContent = 'Please provide at least an email or a phone number.';
        speak('Please provide at least an email or a phone number.');
        return;
      }
      if (!emailOk || !phoneOk){
        sysEl.textContent = 'Please enter a valid email or phone.';
        speak('Please enter a valid email or phone.');
        return;
      }

      S.referrer_name  = name;
      S.referrer_org   = org || null;
      S.referrer_email = email || null;
      S.referrer_phone = phone || null;
      save(); next();
    };
  }

  function showInterpreterBox(){
    const old=document.getElementById('al-intbox'); if (old) old.remove();
    const box=document.createElement('div');
    box.id='al-intbox'; box.className='al-inlinebox';
    box.innerHTML = `
      <div style="font-weight:700">Interpreter language</div>
      <input id="al-int-lang" placeholder="e.g., Arabic, Mandarin, AUSLAN" required>
      <button id="al-int-save" class="al-btn ghost">Save & continue</button>
    `;
    optsEl.appendChild(box);
    document.getElementById('al-int-save').onclick=()=>{
      const lang=document.getElementById('al-int-lang').value.trim();
      if (!lang){ sysEl.textContent='Please enter a language.'; speak('Please enter a language.'); return; }
      S.interpreter.language=lang; S.risks.int=true; save(); sysEl.textContent='Interpreter language saved.'; next();
    };
  }

  function renderPrefChips(){
    optsEl.innerHTML = '';
    const toggles = [
      {k:'A', t:'Worker gender preference', on: !!S.pref.gender},
      {k:'B', t:'Transport required',        on: !!S.pref.transport},
      {k:'C', t:'Keysafe / someone home for access', on: !!S.pref.access},
    ];
    toggles.forEach(tg=>{
      const b = document.createElement('button');
      b.className='al-chip';
      if (tg.on) b.style.borderColor = '#ffd95c';
      b.textContent = `${tg.k}) ${tg.t}`;
      b.addEventListener('click', ()=>{
        if (tg.k==='A') S.pref.gender = S.pref.gender ? null : 'Has preference';
        if (tg.k==='B') S.pref.transport = S.pref.transport ? null : 'Yes';
        if (tg.k==='C') S.pref.access = S.pref.access ? null : 'Ready';
        S.pref.none = false;
        save();
        renderPrefChips();
      });
      optsEl.appendChild(b);
    });
    const noneBtn = document.createElement('button');
    noneBtn.className='al-chip';
    noneBtn.textContent = `D) No preferences`;
    noneBtn.addEventListener('click', ()=>{
      S.pref = {worker:null, gender:null, transport:null, access:null, none:true};
      save(); next();
    });
    optsEl.appendChild(noneBtn);

    const cont = document.createElement('button');
    cont.id = 'al-pref-continue';
    cont.className='al-chip';
    cont.textContent = `‚úì Continue`;
    cont.addEventListener('click', ()=> next());
    optsEl.appendChild(cont);
  }

  function renderHighCareChips(){
    optsEl.innerHTML = '';
    const options = [
      'Catheter care',
      'Stoma/ostomy care',
      'Complex wound care',
      'PEG/enteral feeding',
      'Diabetes management',
      'Tracheostomy care',
      'Ventilation',
      'Behaviours of concern'
    ];
    if (!Array.isArray(S.highcare)) S.highcare = [];

    options.forEach((label, idx)=>{
      const b = document.createElement('button');
      b.className='al-chip';
      const on = S.highcare.includes(label);
      if (on) b.style.borderColor = '#ffd95c';
      b.textContent = String.fromCharCode(65+idx) + ') ' + label;
      b.addEventListener('click', ()=>{
        const i = S.highcare.indexOf(label);
        if (i>=0) S.highcare.splice(i,1); else S.highcare.push(label);
        save(); renderHighCareChips();
      });
      optsEl.appendChild(b);
    });

    const otherBox = document.createElement('div');
    otherBox.className='al-inlinebox';
    otherBox.innerHTML = `
      <div style="font-weight:700">Other high-care need (optional)</div>
      <input id="al-highcare-other" placeholder="e.g., PICC line care">
      <button id="al-highcare-save" class="al-btn ghost">Save & continue</button>
    `;
    optsEl.appendChild(otherBox);

    document.getElementById('al-highcare-save').onclick = ()=>{
      const v=(document.getElementById('al-highcare-other').value||'').trim();
      S.highcare_other = v || null;
      save(); next();
    };

    const cont = document.createElement('button');
    cont.id='al-highcare-continue';
    cont.className='al-chip';
    cont.textContent='‚úì Continue';
    cont.addEventListener('click', ()=> next());
    optsEl.appendChild(cont);
  }

  function renderServiceChips(){
    optsEl.innerHTML = '';

    const options = [
      'Personal care',
      'Community participation',
      'Nursing care',
      'Daily living skills'
    ];
    const catMap = {
      'Personal care': 'Core ‚Äì Assistance with Daily Life',
      'Community participation': 'Core ‚Äì Social & Community Participation',
      'Nursing care': 'Core ‚Äì Community Nursing Care',
      'Daily living skills': 'Capacity ‚Äì Improved Daily Living'
    };
    if (!Array.isArray(S.services)) S.services = [];

    options.forEach((label, idx)=>{
      const b = document.createElement('button');
      b.className = 'al-chip';
      const on = S.services.includes(label);
      if (on) b.style.borderColor = '#ffd95c';
      b.textContent = String.fromCharCode(65+idx) + ') ' + label;
      b.addEventListener('click', ()=>{
        const i = S.services.indexOf(label);
        if (i>=0) S.services.splice(i,1); else S.services.push(label);
        // derive cats, keep legacy first selection
        S.service_cats = Array.from(new Set(S.services.map(s=>catMap[s]).filter(Boolean)));
        S.service = S.services[0] || null;
        S.cat = S.service ? catMap[S.service] : null;
        save(); renderServiceChips();
      });
      optsEl.appendChild(b);
    });

    const cont = document.createElement('button');
    cont.id='al-service-continue';
    cont.className='al-chip';
    cont.textContent='‚úì Continue';
    cont.addEventListener('click', ()=>{
      if (!S.services || S.services.length===0){
        sysEl.textContent = 'Please select at least one support.';
        speak('Please select at least one support.');
        return;
      }
      next();
    });
    optsEl.appendChild(cont);
  }

  /* ===== Name Gate ===== */
  function injectNameGate(){
    stepEl.textContent = 'Step 1/16';
    barEl.style.width = '0%';
    setPortrait('default');
    qEl.textContent = "What is the participant‚Äôs full name?";
    optsEl.innerHTML = '';

    const box = document.createElement('div');
    box.className = 'al-inlinebox';
    box.innerHTML = `
      <div style="font-weight:700">Participant full name (required)</div>
      <input id="al-participant-name" placeholder="e.g., Jane Smith" required autocomplete="name">
      <button id="al-name-save" class="al-btn ghost">Save & continue</button>
    `;
    optsEl.appendChild(box);

    document.getElementById('al-name-save').onclick = ()=>{
      const v = (document.getElementById('al-participant-name').value||'').trim();
      if (!v || v.split(' ').length < 2){
        sysEl.textContent = 'Please enter the full name (first & last).';
        speak('Please enter the full name, first and last.');
        return;
      }
      S.participant_name = v;
      save();
      render();
    };

    speak("What is the participant‚Äôs full name?");
  }

  /* ===== Render ===== */
  function render(){
    // Require participant name first
    if (!S.participant_name){ injectNameGate(); return; }

    const list = flow(), total = list.length;
    const step = list[S.i] || list[total-1];

    stepEl.textContent = `Step ${Math.min(S.i+2, totalStepsCount())}/${totalStepsCount()}`;
    barEl.style.width = Math.round(((S.i+1)/(totalStepsCount()-1))*100) + '%';

    setPortrait(step.id);
    qEl.textContent = step.q;
    optsEl.innerHTML = '';
    sysEl.textContent = '';
    endBox.style.display = 'none';

    // Typed-only & custom-rendered steps
    if (step.id==='loc'){ injectLocationBox(true); speak(step.q); save(); return; }
    if (step.id==='pm_details'){ injectPlanManagerBox(); speak(step.q); save(); return; }
    if (step.id==='referrer'){ injectReferrerBox(); speak(step.q); save(); return; }
    if (step.id==='service'){ renderServiceChips(); speak(step.q); save(); return; }
    if (step.id==='pref'){ renderPrefChips(); speak(step.q); save(); return; }

    // Interpreter language typed capture when step shown
    if (step.id!=='final'){
      if (step.id==='risk_int'){
        injectCustomBox(step.id, CUSTOM_LABELS[step.id], CUSTOM_PLACEHOLDERS[step.id], (val)=>{
          if (val){ S.risks.int = true; S.interpreter.language = val; save(); }
          next();
        });
      } else if (step.id==='highcare'){
        renderHighCareChips();
      } else {
        injectCustomBox(step.id, CUSTOM_LABELS[step.id], CUSTOM_PLACEHOLDERS[step.id], (val)=>{
          if (val){ S.custom[step.id]=val; S.notes.push(`[${step.id}] ${val}`); save(); }
          next();
        });
      }
    }

    // Default chips (exclude custom-render steps)
    if (!['highcare','pref','service'].includes(step.id)){
      step.opts.forEach(opt=>{
        const b = document.createElement('button');
        b.className='al-chip';
        b.textContent = `${opt.k}) ${opt.t}`;
        b.addEventListener('click', ()=> choose(opt));
        optsEl.appendChild(b);
      });
    }

    speak(step.q); save();
  }

  function choose(opt){
    const list = flow();
    const stepId = list[S.i].id;

    // Guard typed-only steps
    if (stepId==='loc' && opt.k==='A'){
      sysEl.textContent='Enter suburb and postcode, then Save & continue.';
      speak('Please enter your suburb and postcode, then press Save and continue.');
      return;
    }
    if (stepId==='pm_details' && opt.k==='A'){
      sysEl.textContent='Type Plan Manager details, then Save & continue.';
      speak('Please type your Plan Manager details, then press Save and continue.');
      return;
    }
    if (stepId==='referrer' && opt.k==='A'){
      sysEl.textContent='Type referrer name and contact, then Save & continue.';
      speak('Please type referrer name and contact, then press Save and continue.');
      return;
    }

    // Multi-select steps advance only via ‚úì Continue
    if (stepId==='service' && ['A','B','C','D'].includes(opt.k)){
      sysEl.textContent='You can select multiple supports, then press ‚úì Continue.';
      speak('You can select multiple supports, then press Continue.');
      return;
    }
    if (stepId==='pref' && ['A','B','C'].includes(opt.k)) return;

    // Interpreter: if "Yes", require language box
    if (stepId==='risk_int' && opt.k==='A'){ showInterpreterBox(); return; }

    // Consent must be yes to proceed
    if (stepId==='consent' && opt.k!=='A'){
      if (typeof opt.apply==='function') opt.apply();
      save();
      sysEl.innerHTML = `We need your consent to continue. Please select <strong>A) Yes</strong> to proceed.`;
      speak('We need your consent to continue. Please select Yes to proceed.');
      return;
    }

    if (typeof opt.apply==='function') opt.apply();
    save();

    if (stepId==='final'){
      renderSummary();
      endBox.style.display='grid';
      validateSendButton();
      return;
    }
    S.i = Math.min(S.i+1, list.length-1);
    render();
  }

  function next(){
    const list = flow();
    if (list[S.i].id==='final'){
      renderSummary(); endBox.style.display='grid'; validateSendButton(); return;
    }
    S.i = Math.min(S.i+1, list.length-1); render();
  }

  function handleSpeech(text){
    if (!text) return;
    const t = text.trim(); const up = t.toUpperCase();
    let pick=null;
    if (['A','B','C','D','NS'].includes(up)) pick=up;
    else if (/participant|client/i.test(t)) pick='A';
    else if (/carer|family/i.test(t)) pick='B';
    else if (/support\s*co(ord(inator)?)?/i.test(t)) pick='C';
    else if (/plan\s*manager|pm\b/i.test(t)) pick='D';
    else if (/not sure|unsure|don.?t know|flexible/i.test(t)) pick='NS';
    else {
      const list = flow();
      if (list[S.i].id==='loc'){ sysEl.textContent='Please type suburb and postcode, then Save & continue.'; return; }
      if (list[S.i].id==='risk_int'){ if (/^[a-zA-Z\s]+$/.test(t) && t.length>2){ S.risks.int=true; S.interpreter.language=t; save(); next(); return; } }
    }
    const list = flow();
    const step = list[S.i];
    const chosen = step.opts.find(x=>x.k===pick);
    if (chosen) choose(chosen); else { sysEl.textContent='Noted. Say A, B, C, D or ‚ÄúNot sure‚Äù, or tap a button.'; }
  }

  function renderSummary(){
    const yn=v=>v===true?'Yes':v===false?'No':(v||'‚Äî');
    const lines = [
      `Participant: ${S.participant_name || '‚Äî'}`,
      `Caller: ${S.caller||'‚Äî'}`,
      `Consent: ${S.consent||'‚Äî'}`,
      `Referrer: ${S.referrer_name || '‚Äî'}${S.referrer_org ? ' ‚Ä¢ '+S.referrer_org : ''} ‚Ä¢ ${S.referrer_email || S.referrer_phone || '‚Äî'}`,
      `Location: ${S.suburb||'‚Äî'} ${S.postcode?('('+S.postcode+')'):''}`,
      `Services: ${(S.services && S.services.length)? S.services.join(', ') : (S.service||'‚Äî')}`,
      `Categories: ${(S.service_cats && S.service_cats.length)? S.service_cats.join(', ') : (S.cat||'‚Äî')}`,
      `High-care: ${(S.highcare && S.highcare.length)? S.highcare.join(', ') : '‚Äî'}${S.highcare_other ? ' ‚Ä¢ Other: '+S.highcare_other : ''}`,
      `Windows (visits): ${S.rostering||'‚Äî'}`,
      `Contact window: ${S.contact_window||S.custom['contact_win']||'‚Äî'}`,
      `Prefs: ${S.pref.gender?'Worker gender; ':''}${S.pref.transport?'Transport; ':''}${S.pref.access?'Access ready; ':''}${S.pref.none?'None':''}`.replace(/; $/,''),

      `Plan Mgmt: ${S.mgmt||'‚Äî'}${S.mgmt==='Plan-managed' ? ` ‚Ä¢ PM: ${S.pm_name||'‚Äî'} (${S.pm_email||'‚Äî'})` : ''} ‚Ä¢ Dates: ${S.dates||'‚Äî'} ‚Ä¢ Hours: ${S.hrs||'‚Äî'}`,
      `Risks: Beh ${yn(S.risks.beh)} ‚Ä¢ Med ${yn(S.risks.med)} ‚Ä¢ Int ${yn(S.risks.int)}`,
      `Interpreter language: ${S.interpreter.language||'‚Äî'}`,
      `Route: ${S.route||'‚Äî'}`
    ];
    qEl.textContent = "Great ‚Äî here‚Äôs a quick summary. Add your contact (email or phone required to send).";
    optsEl.innerHTML = '<div class="al-chip" style="cursor:default;white-space:pre-line">'+lines.join('\n')+'</div>';
    setPortrait('final');
    speak("Thank you. Please add an email or phone so I can send this to our team.");
    fName.value = S.name||''; fEmail.value= S.email||''; fPhone.value= S.phone||''; fNotes.value= (S.notes||[]).join('\n');
  }

  function validateSendButton(){
    const hasContact = (fEmail.value.trim().length>0) || (fPhone.value.trim().length>0);
    const hasConsent = (S.consent === 'Yes');

    btnSend.disabled = !(hasContact && hasConsent);
    contactWarn.style.display = hasContact ? 'none' : 'block';

    if (!hasConsent){
      sysEl.textContent = 'Consent is required to submit. Please Restart and select ‚ÄúYes‚Äù at the consent step.';
    }
  }

  async function submit(){
    if (!((fEmail.value.trim()) || (fPhone.value.trim()))){
      validateSendButton(); speak('Please add an email or phone number before sending.'); return;
    }
    S.name=fName.value.trim()||S.name; S.email=fEmail.value.trim()||S.email; S.phone=fPhone.value.trim()||S.phone; save();

    const payload = {
      _subject:`HD HeeD Website ‚Äì ${S.route||'Enquiry'} via ELLA (voice)`,
      source:"index-ella-v35",

      participant_name: S.participant_name,

      // Referrer
      referrer_name: S.referrer_name,
      referrer_org: S.referrer_org,
      referrer_email: S.referrer_email,
      referrer_phone: S.referrer_phone,

      // Services (multi-select) + legacy
      services: S.services,
      service_cats: S.service_cats,
      service:S.service,
      category:S.cat,

      // High-care + PM
      highcare: S.highcare,
      highcare_other: S.highcare_other,
      plan_mgmt:S.mgmt,
      pm_name: S.pm_name,
      pm_email: S.pm_email,
      plan_dates:S.dates,

      suburb:S.suburb, postcode:S.postcode,
      rostering:S.rostering, contact_window:S.contact_window || S.custom['contact_win'] || '',
      pref_gender:S.pref.gender, pref_transport:S.pref.transport, pref_access:S.pref.access,
      approx_hours_per_week:S.hrs,
      risk_behaviours:S.risks.beh, risk_medical:S.risks.med, risk_interpreter:S.risks.int,
      interpreter_language:S.interpreter.language,

      // submitter contact
      name:S.name, email:S.email, phone:S.phone,

      route:S.route, caller:S.caller, consent:S.consent,
      custom:S.custom, notes:(S.notes||[]).concat(fNotes.value||'').join('\n'),
      timestamp:new Date().toISOString()
    };
    try{
      const r = await fetch(FS_ENDPOINT, { method:"POST", headers:{ "Content-Type":"application/json", "Accept":"application/json" }, body: JSON.stringify(payload) });
      const data = await r.json();
      if (r.ok){ sysEl.innerHTML = `All done ‚Äî we‚Äôll contact you from <a href="mailto:${SITE_EMAIL}" style="color:#ffd95c">${SITE_EMAIL}</a> or ${SITE_PHONE}.`; speak("All done. We‚Äôll contact you shortly. Thank you."); }
      else { throw new Error(data?.error || "Submission failed"); }
    }catch(e){
      sysEl.innerHTML = `Couldn‚Äôt send right now. Please email <a href="mailto:${SITE_EMAIL}" style="color:#ffd95c">${SITE_EMAIL}</a> or call ${SITE_PHONE}. You can download your summary below.`;
      speak("I couldn‚Äôt send right now. You can download your summary and email it to us.");
    }
  }

  /* Intro */
  const INTRO_TEXT = "Hi, I‚Äôm Ella ‚Äî your AI assistant. You don‚Äôt need to be on a long call with our team. Just answer these well-directed multiple-choice questions and our team will be fully prepared when they get in touch with you.";

  function showIntro(){
    stepEl.textContent = 'Intro';
    barEl.style.width = '0%';
    setPortrait('default');
    qEl.textContent = INTRO_TEXT;
    optsEl.innerHTML = '';
    const b = document.createElement('button');
    b.className = 'al-chip';
    b.textContent = 'Let‚Äôs begin';
    b.addEventListener('click', ()=>{ S.i = 0; save(); render(); });
    optsEl.appendChild(b);
    speak(INTRO_TEXT);
  }

  /* Open/Close */
  function openPanel(){
    greet.style.display='none';
    panel.style.display='block';
    if (window.speechSynthesis){ pickVoice(); }
    showIntro();
  }
  function closePanel(){ panel.style.display='none'; try{ window.speechSynthesis.cancel(); }catch{} }

  // Show greet first time per session
  if (!sessionStorage.getItem('ella_greeted_v35')){
    setTimeout(()=>{ greet.style.display='block'; sessionStorage.setItem('ella_greeted_v35','1'); }, 900);
  }

  // Hooks
  startBtn.addEventListener('click', openPanel);
  hideBtn.addEventListener('click', ()=>{ greet.style.display='none'; });

  const ellaLaunch = document.getElementById('ella-launch');
  if (ellaLaunch){
    ellaLaunch.addEventListener('click', (e)=>{
      e.preventDefault();
      if (window.ELLA && typeof window.ELLA.open === 'function') {
        window.ELLA.open();
      } else if (window.ALAN && typeof window.ALAN.open === 'function') {
        window.ALAN.open();
      } else {
        openPanel();
      }
    });
  }

  document.getElementById('al-mic').addEventListener('click', ()=>{ if (!SR){ alert('Voice not supported in this browser. Tap answers instead.'); return; } listen(); });

  const backBtn = document.getElementById('al-back');
  if (backBtn){
    backBtn.addEventListener('click', ()=>{
      const list = flow();
      if (S.i > 0){
        if (list[S.i].id==='final'){ endBox.style.display='none'; }
        S.i = S.i - 1;
        save();
        render();
      }
    });
  }

  restartBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    try{ window.speechSynthesis && window.speechSynthesis.cancel(); }catch{}
    localStorage.removeItem(SKEY);
    S = {
      i:0,
      participant_name: null,

      caller:null, consent:null,
      referrer_name:null, referrer_org:null, referrer_email:null, referrer_phone:null,

      suburb:null, postcode:null,

      services: [], service_cats: [],
      service:null, cat:null,

      highcare:[], highcare_other:null,

      mgmt:null, pm_name:null, pm_email:null, dates:null,

      hrs:null,
      risks:{beh:null, med:null, int:null},
      interpreter:{language:null},
      pref:{worker:null, gender:null, transport:null, access:null, none:false},
      urgency:null, rostering:null, contact_window:null,
      name:null, email:null, phone:null, route:null,
      custom:{}, notes:[]
    };
    save();
    sysEl.textContent = '';
    optsEl.innerHTML = '';
    endBox.style.display='none';
    setPortrait('default');
    showIntro();
  });

  const onContactChange=()=>validateSendButton();
  fEmail.addEventListener('input', onContactChange);
  fPhone.addEventListener('input', onContactChange);
  btnSend.addEventListener('click', submit);
  btnLater.addEventListener('click', ()=>{ sysEl.textContent='Saved. You can close this window ‚Äî we‚Äôll follow up soon.'; speak('Saved. You can close this window.'); });
  btnDownload.addEventListener('click', ()=>{
    const payload = {
      participant_name: S.participant_name,

      // Referrer
      referrer_name: S.referrer_name,
      referrer_org: S.referrer_org,
      referrer_email: S.referrer_email,
      referrer_phone: S.referrer_phone,

      // Services + legacy
      services: S.services,
      service_cats: S.service_cats,
      service:S.service, category:S.cat,

      highcare: S.highcare,
      highcare_other: S.highcare_other,

      plan_mgmt:S.mgmt, pm_name:S.pm_name, pm_email:S.pm_email, plan_dates:S.dates,

      suburb:S.suburb, postcode:S.postcode,
      rostering:S.rostering, contact_window:S.contact_window || S.custom['contact_win'] || '',
      prefs:S.pref, approx_hours_per_week:S.hrs,
      risks:S.risks, interpreter:S.interpreter, urgency:S.urgency,
      name:fName.value||S.name, email:fEmail.value||S.email, phone:fPhone.value||S.phone,
      custom:S.custom, notes:(S.notes||[]).concat(fNotes.value||'').join('\n'),
      timestamp:new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:'hdheed-intake.json'});
    document.body.appendChild(a); a.click(); a.remove();
  });

  if (window.speechSynthesis){ speechSynthesis.onvoiceschanged = pickVoice; }

  // Public openers
  window.ALAN = { open: openPanel }; // backward compatibility
  window.ELLA = { open: openPanel };
})();
</script>

<!-- Close controls (ESC, backdrop) -->
<script>
const panel = document.getElementById('alan-panel');
const closeBtn = document.getElementById('al-close');

function closePanelDirect() { panel.style.display = 'none'; }
function onCloseClick(e) { e.preventDefault(); e.stopPropagation(); closePanelDirect(); }

if (closeBtn) closeBtn.addEventListener('click', onCloseClick);

// ESC to close
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && panel.style.display === 'block') closePanelDirect();
});

// Backdrop click (panel itself is backdrop container)
panel.addEventListener('click', (e) => {
  if (e.target === panel) closePanelDirect();
});
</script>

</body>
</html>
