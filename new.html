<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HD HeeD ‚Äî Outreach + Follow-Up</title>
<meta name="description" content="HD HeeD NDIS coordinator outreach emails and weekly follow-up board." />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />
<style>
  :root{
    /* Light theme (Emails) */
    --brand:#6b46ff; --brand-dark:#4f27ff;
    --ink:#0f172a; --ink-2:#334155; --muted:#64748b; --bg:#f8fafc; --card:#ffffff;
    --ring:rgba(107,70,255,.35); --radius:16px; --shadow:0 10px 30px rgba(15,23,42,.08);
    --alert-red:#ff3333;

    /* Dark theme (Follow-up) */
    --d-ink:#0c1226; --d-bg:#0b0f1a; --d-panel:#10172a; --d-line:#243153; --d-text:#e8edff; --d-muted:#a8b6e8; --d-accent:#ffc107;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#fafaff 0%, #f6f8ff 40%, #f8fafc 100%)}

  /* Shell */
  .shell{max-width:1220px;margin:28px auto;padding:0 16px}
  .head{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .logo{width:48px;height:48px;border-radius:12px;background:radial-gradient(120% 120% at 30% 30%, #9b8cff 0%, var(--brand) 42%, var(--brand-dark) 100%);box-shadow:0 10px 25px rgba(107,70,255,.35), inset 0 0 18px rgba(255,255,255,.36)}
  h1{margin:0;font-weight:900;letter-spacing:-.02em;font-size:clamp(22px,3.4vw,34px);color:var(--ink)}
  .sub{margin-top:4px;color:var(--muted);font-size:.92rem}

  /* Tabs */
  .tabs{display:flex;gap:8px;margin:16px 0}
  .tabbtn{appearance:none;border:1px solid #e5e7eb;background:#fff;color:#1f2a44;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer}
  .tabbtn.active{background:var(--brand);border-color:var(--brand);color:#fff;box-shadow:0 12px 34px rgba(0,0,0,.12)}
  .views{position:relative}
  .view{display:none}
  .view.active{display:block}

  /* Light cards (Emails) */
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;margin-bottom:20px;border:1px solid #eef2ff}
  .eyebrow{font-size:12px;letter-spacing:.16em;text-transform:uppercase;color:var(--muted);font-weight:800;margin-bottom:4px}
  .title{margin:0 0 14px 0;font-size:20px;font-weight:900;letter-spacing:-.01em;color:var(--ink)}
  label{display:block;font-size:12px;font-weight:800;color:var(--ink-2);margin:10px 0 6px}
  input[type="text"], textarea{width:100%;border:1.5px solid #e5e7eb;border-radius:12px;background:#fff;color:var(--ink);padding:12px 14px;font:inherit;box-shadow:inset 0 1px 0 rgba(0,0,0,.02)}
  input[type="text"]:focus, textarea:focus{outline:0;border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
  textarea{min-height:220px;line-height:1.5;white-space:pre-wrap}
  .actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
  .btn{appearance:none;border:1px solid #e5e7eb;background:#0f172a;color:#fff;padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer}
  .btn.brand{background:var(--brand);border-color:var(--brand)}
  .btn.secondary{background:#eef2ff;color:#3b3b63}
  .btn.ghost{background:#f3f4f6;color:#1f2a44}
  .btn:active{transform:translateY(1px)}
  .footer{margin:28px 0 36px;color:var(--muted);font-size:12px}

  /* Light badges */
  .bar{display:flex;flex-wrap:wrap;gap:10px;margin:16px 0 20px}
  .badge{font-size:12px;color:#fff;background:var(--brand);padding:8px 12px;border-radius:999px;font-weight:800;letter-spacing:.02em}

  /* Paper referral alert */
  .paper-referral-alert{background:#fff5f5;border:2px solid var(--alert-red);border-radius:16px;padding:16px 20px;margin:0 0 20px 0;text-align:center;box-shadow:0 4px 12px rgba(255,51,51,.2);animation:pulse 2s infinite}
  .paper-referral-alert h3{color:var(--alert-red);margin:0 0 8px;font-weight:900;font-size:18px}
  .paper-referral-alert p{margin:0 0 12px;color:var(--ink-2)}
  .paper-referral-link{display:inline-block;background:var(--alert-red);color:white !important;padding:12px 24px;border-radius:10px;font-weight:900;text-decoration:none;box-shadow:0 4px 6px rgba(255,51,51,.3);transition:all .2s ease}
  .paper-referral-link:hover{background:#ff1a1a;transform:translateY(-2px);box-shadow:0 6px 12px rgba(255,51,51,.4)}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,51,51,.4)}70%{box-shadow:0 0 0 10px rgba(255,51,51,0)}100%{box-shadow:0 0 0 0 rgba(255,51,51,0)}}

  /* Dark section (Follow-up) */
  .dark{margin-top:26px;background:radial-gradient(1200px 1200px at 80% -200px,#122048 0%,#0b0f1a 42%,#0b0f1a 100%);border:1px solid var(--d-line);border-radius:18px;box-shadow:0 28px 110px rgba(0,0,0,.55);overflow:hidden}
  .head2{display:flex;align-items:center;gap:12px;padding:16px 18px;border-bottom:1px solid var(--d-line);background:linear-gradient(180deg,#0e162f,#0c1329);color:var(--d-text)}
  .title2{font-weight:900;font-size:1.1rem;letter-spacing:.2px}
  .sub2{font-size:.88rem;color:var(--d-muted)}
  .toolbar{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn2{border:1px solid var(--d-line);background:#0f1b3b;color:var(--d-text);border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
  .btn2.primary{background:var(--d-accent);color:#2a2100;border-color:#e0b200;box-shadow:0 12px 34px rgba(0,0,0,.35)}
  .btn2.warn{background:#351616;border-color:#6e1c1c;color:#ffdcdc}
  .btn2.ghost{background:#0f1937}
  .status{font-size:.8rem;color:var(--d-muted)}
  .wrap2{padding:16px}
  .board{border:1px solid var(--d-line);background:#0e162e;border-radius:16px;overflow:auto}
  table{border-collapse:separate;border-spacing:0;width:100%;min-width:1100px}
  th,td{border-bottom:1px solid var(--d-line);border-right:1px solid var(--d-line);padding:10px;vertical-align:top}
  th:first-child,td:first-child{border-left:1px solid var(--d-line)}
  thead th{position:sticky;top:0;background:#0d1428;color:#fff;font-weight:900;font-size:.96rem;z-index:1}
  tbody th{background:linear-gradient(180deg,#101a3c,#0e162f);text-align:left;font-weight:800;white-space:nowrap;min-width:380px}
  .lead{display:flex;flex-direction:column;gap:6px}
  .lead .name{font-weight:900;color:#ffe28f}
  .lead .meta{display:flex;gap:12px;flex-wrap:wrap;font-size:.85rem;color:#cfe0ff}
  .lead .meta a{color:#aee6ff;text-decoration:none;border-bottom:1px dotted rgba(174,230,255,.35);padding-bottom:1px}
  .lead .meta a:hover{color:#fff;border-bottom-color:#fff}
  .cell{background:#0f1b3b;border:1px solid #2a3b68;border-radius:10px;padding:8px;min-height:48px;display:flex;align-items:center;justify-content:space-between;gap:8px;cursor:pointer}
  .cell .preview{flex:1;max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#d8e2ff;opacity:.95}
  .cell .badge{font-size:12px;border:1px solid #35508a;background:#0f254f;color:#cfe0ff;border-radius:999px;padding:4px 8px}
  .cell.empty .badge,.cell.empty .preview{opacity:.65}
  .cell:hover{box-shadow:0 0 0 2px rgba(255,209,64,.25)}
  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,22,.58);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal{width:min(900px,94vw);max-height:85vh;background:linear-gradient(180deg,#10172a,#0b0f1a);border:1px solid var(--d-line);border-radius:16px;box-shadow:0 28px 110px rgba(0,0,0,.6);display:flex;flex-direction:column}
  .modal-head{display:flex;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px solid var(--d-line)}
  .modal-title{font-weight:900;color:var(--d-text)}
  .modal-close{margin-left:auto;border:1px solid var(--d-line);background:#0f1b3b;color:#fff;border-radius:999px;padding:6px 10px;cursor:pointer}
  .modal-body{padding:12px 14px}
  .modal-body textarea{width:100%;min-height:44vh;border:1px solid #2a3b68;border-radius:10px;padding:10px;background:#0f1b3b;color:#e8edff;resize:vertical;font-family:inherit;font-size:1rem}
  .modal-foot{padding:12px 14px;border-top:1px dashed var(--d-line);display:flex;gap:8px;justify-content:flex-end}
  @media print{.toolbar,.modal-backdrop{display:none !important}}
</style>
</head>
<body>
  <div class="shell">
    <div class="head">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>HD HeeD ‚Äî Outreach + Follow-Up</h1>
        <div class="sub">Support Coordinators & Plan Managers ‚Ä¢ Blacktown & Western Sydney</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tabbtn active" data-tab="tab-emails">Emails (1‚Äì4)</button>
      <button class="tabbtn" data-tab="tab-followup">Follow-Up Board</button>
    </div>

    <div class="views">
      <!-- ========== TAB: EMAILS ========== -->
      <section id="tab-emails" class="view active">
        <div class="bar">
          <span class="badge">RN-Led Provider</span>
          <span class="badge">Online Referrals</span>
          <span class="badge">AILR Onboarding</span>
          <span class="badge">Audit-Ready</span>
        </div>

        <!-- Paper referral (Drive link preserved) -->
        <div class="paper-referral-alert">
          <h3>üìÑ Paper-Based Referral Form Available</h3>
          <p>Prefer paper? Download and email the completed copy to info@hdheed.com.au</p>
          <a class="paper-referral-link" target="_blank"
             href="https://drive.google.com/file/d/1Z3EJ2mycLwNAIDXs2fnIfD8H_wxcSdQx/view?usp=drive_link">
            Download Paper Referral Form
          </a>
        </div>

        <!-- Copy all -->
        <div class="card">
          <div class="eyebrow">Bulk tool</div>
          <h2 class="title">Copy All Emails</h2>
          <div class="actions">
            <button class="btn brand" id="btnCopyAll">Copy All (Subjects + Bodies)</button>
          </div>
          <div class="sub" style="color:var(--muted);margin-top:10px">Copies Emails 1‚Äì4 with clear separators.</div>
        </div>

        <!-- Email 1 -->
        <section class="card" id="e1">
          <div class="eyebrow">Email 1</div>
          <h3 class="title">Introduction to HD HeeD</h3>
          <label for="s1">Subject</label>
          <input id="s1" type="text" value="Introducing HD HeeD ‚Äì RN-Led NDIS Provider in Blacktown" />
          <label for="b1">Body</label>
          <textarea id="b1">Hi,

Please let me introduce HD HeeD Pty Ltd, an NDIS-registered provider based in Blacktown. We are an RN-led team, with the skills and systems to deliver safe, professional, and person-centred supports.

We are registered under the following NDIS groups:
‚Ä¢ 0104 ‚Äì High Intensity Daily Personal Activities
‚Ä¢ 0107 ‚Äì Daily Personal Activities
‚Ä¢ 0115 ‚Äì Assistance with Daily Life Tasks in a Group/Shared Living
‚Ä¢ 0117 ‚Äì Development of Daily Living and Life Skills
‚Ä¢ 0120 ‚Äì Household Tasks
‚Ä¢ 0125 ‚Äì Participation in Community, Social and Civic Activities
‚Ä¢ 0136 ‚Äì Group and Centre-Based Activities

At HD HeeD, we keep onboarding simple and organised:
‚Ä¢ Visit our website: https://www.hdheed.com.au
‚Ä¢ Talk directly to our AI assistant Ella
‚Ä¢ Submit a referral using our online referral form or quick referral link: https://www.hdheed.com.au/referral.html
‚Ä¢ Or simply reply to this email / email us at info@hdheed.com.au or ndis@hdheed.com.au

We are here to support you and your participants with a streamlined process, strong clinical expertise, and a person-centred approach.

üëâ Start a referral today: https://www.hdheed.com.au/referral.html

Kind regards,
Mat Syan
Director ‚Äì HD HeeD Pty Ltd
üìû 02 8630 5500 | ‚úâÔ∏è info@hdheed.com.au</textarea>
          <div class="actions">
            <button class="btn brand" data-copy="s1">Copy Subject</button>
            <button class="btn" data-copy="b1">Copy Body</button>
            <button class="btn secondary" data-copy="both" data-s="s1" data-b="b1">Copy Both</button>
          </div>
        </section>

        <!-- Email 2 -->
        <section class="card" id="e2">
          <div class="eyebrow">Email 2</div>
          <h3 class="title">Our RN-Led Strength</h3>
          <label for="s2">Subject</label>
          <input id="s2" type="text" value="Nursing Expertise at the Core of HD HeeD" />
          <label for="b2">Body</label>
          <textarea id="b2">Hi,

At HD HeeD, we are proud to be a group of Registered Nurses who are extremely confident in our skills and experience. This allows us to provide participants with the highest standard of care, especially when it comes to complex health needs.

We deliver this care under registration group 0104 ‚Äì High Intensity Daily Personal Activities. This makes our services not only clinically safe and professional, but also a practical and cost-effective option compared to group 0114 (Community Nursing), which is charged at a much higher rate.

By choosing HD HeeD, your participants receive the benefits of RN-level support within the right NDIS registration group, ensuring both quality and value.

üëâ Start a referral today: https://www.hdheed.com.au/referral.html

Please also find a paper-based referral form attached that you can complete manually and email back to us at info@hdheed.com.au, if that is your preferred method.

You are always welcome to call us directly on 02 8630 5500 to discuss referrals or participant needs further.

Kind regards,
Mat Syan
Director ‚Äì HD HeeD Pty Ltd
üìû 02 8630 5500 | ‚úâÔ∏è info@hdheed.com.au</textarea>
          <div class="actions">
            <button class="btn brand" data-copy="s2">Copy Subject</button>
            <button class="btn" data-copy="b2">Copy Body</button>
            <button class="btn secondary" data-copy="both" data-s="s2" data-b="b2">Copy Both</button>
          </div>
        </section>

        <!-- Email 3 -->
        <section class="card" id="e3">
          <div class="eyebrow">Email 3</div>
          <h3 class="title">AILR System</h3>
          <label for="s3">Subject</label>
          <input id="s3" type="text" value="Meet AILR ‚Äì Advanced Intake & Long-form Registration" />
          <label for="b3">Body</label>
          <textarea id="b3">Hi,

One of our key strengths at HD HeeD is our AILR system ‚Äì Advanced Intake & Long-form Registration.

AILR ensures that most of the participant‚Äôs onboarding is completed online, with only a few signature forms returned manually or via email. This makes the process:
‚Ä¢ Systematic and organised
‚Ä¢ Less paperwork for you and your clients
‚Ä¢ Straightforward, convenient, and time-saving

If a participant needs help, we are more than happy to sit with them and complete the AILR together.

üëâ You can visit and view our online AILR system here: https://www.hdheed.com.au/ailr.html

When you‚Äôre ready to make a referral, you can use our quick online referral form here: https://www.hdheed.com.au/referral.html

For those who prefer, a paper-based referral form can also be emailed back to info@hdheed.com.au. And of course, you‚Äôre always welcome to call us directly on 02 8630 5500.

Kind regards,
Mat Syan
Director ‚Äì HD HeeD Pty Ltd
üìû 02 8630 5500 | ‚úâÔ∏è info@hdheed.com.au</textarea>
          <div class="actions">
            <button class="btn brand" data-copy="s3">Copy Subject</button>
            <button class="btn" data-copy="b3">Copy Body</button>
            <button class="btn secondary" data-copy="both" data-s="s3" data-b="b3">Copy Both</button>
          </div>
        </section>
        <!-- Email 4 -->
        <section class="card" id="e4">
          <div class="eyebrow">Email 4</div>
          <h3 class="title">Easy Online Referrals</h3>
          <label for="s4">Subject</label>
          <input id="s4" type="text" value="Referrals Made Simple with HD HeeD" />
          <label for="b4">Body</label>
          <textarea id="b4">Hi,

At HD HeeD, we understand how valuable your time is. That‚Äôs why we‚Äôve created a quick and hassle-free online referral system to make things easier for you and your participants.

You can submit a referral in just a few minutes using our secure portal:
üëâ https://www.hdheed.com.au/referral.html

The system is streamlined, convenient, and fully audit-ready, ensuring participants are onboarded faster and without unnecessary delays.

Alternatively, we are also attaching a paper-based referral form. You can complete it, scan it, and email it back to us at info@hdheed.com.au if that is your preferred way of making a referral.

Whether you choose online or paper, we‚Äôll make sure the onboarding is handled quickly, professionally, and with minimal hassle.

Kind regards,
Mat Syan
Director ‚Äì HD HeeD Pty Ltd
üìû 02 8630 5500 | ‚úâÔ∏è info@hdheed.com.au</textarea>
          <div class="actions">
            <button class="btn brand" data-copy="s4">Copy Subject</button>
            <button class="btn" data-copy="b4">Copy Body</button>
            <button class="btn secondary" data-copy="both" data-s="s4" data-b="b4">Copy Both</button>
          </div>
        </section>

        <div class="footer">¬© HD HeeD Pty Ltd ‚Ä¢ ABN 47 665 228 768 ‚Ä¢ Blacktown, NSW ‚Ä¢ Phone: 02 8630 5500 ‚Ä¢
          <a href="mailto:info@hdheed.com.au">info@hdheed.com.au</a></div>
      </section>

      <!-- ========== TAB: FOLLOW-UP (Dark) ========== -->
      <section id="tab-followup" class="view">
        <div class="dark">
          <div class="head2">
            <div class="logo" aria-hidden="true" style="width:40px;height:40px"></div>
            <div>
              <div class="title2">HD HeeD ‚Äî NDIS Weekly Follow-Up Board</div>
              <div class="sub2">SCs & Plan Managers ‚Ä¢ Live from Google Sheet (Drive)</div>
            </div>
            <div class="toolbar">
              <button id="btnOpenSheet" class="btn2">Open Follow-Up Sheet</button>
              <button id="btnReloadContacts" class="btn2">‚Üª Reload Contacts</button>
              <label class="btn2 ghost" style="cursor:pointer">Import Contacts (CSV/JSON)
                <input id="importContacts" type="file" accept=".csv,application/json" style="display:none">
              </label>
              <button id="btnRefresh" class="btn2">üîÑ Refresh</button>
              <button id="btnSave" class="btn2 primary">üíæ Save changes</button>
              <span id="status" class="status"></span>
            </div>
          </div>

          <div class="wrap2">
            <div class="board">
              <table id="board">
                <thead>
                  <tr>
                    <th style="width:380px">Lead (SC/PM)</th>
                    <th>Monday</th><th>Tuesday</th><th>Wednesday</th>
                    <th>Thursday</th><th>Friday</th><th>Saturday</th><th>Sunday</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
            <div class="sub2" style="margin-top:8px">Click any day cell to edit. Press <strong>Save changes</strong> to sync.</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div id="modalTitle" class="modal-title">Edit note</div>
        <button id="modalClose" class="modal-close">‚úï Close</button>
      </div>
      <div class="modal-body"><textarea id="modalTextarea" placeholder="Type your note‚Ä¶"></textarea></div>
      <div class="modal-foot"><button id="modalSave" class="btn2 primary">üíæ Apply to cell</button></div>
    </div>
  </div>

  <!-- ======= SCRIPTS ======= -->
  <script>
    /* ---------- Tab switcher ---------- */
    document.querySelectorAll('.tabbtn').forEach(b=>{
      b.addEventListener('click', ()=>{
        document.querySelectorAll('.tabbtn').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
        b.classList.add('active');
        document.getElementById(b.dataset.tab).classList.add('active');
      });
    });

    /* ---------- Utility: clipboard + openers ---------- */
    async function copyText(text){
      try{ await navigator.clipboard.writeText(text); alert('Copied to clipboard'); }
      catch{
        const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove(); alert('Copied to clipboard');
      }
    }
    document.getElementById('btnCopyAll').onclick = ()=>{
      const payload = [
        {n:'Email 1', s:s1.value, b:b1.value},
        {n:'Email 2', s:s2.value, b:b2.value},
        {n:'Email 3', s:s3.value, b:b3.value},
        {n:'Email 4', s:s4.value, b:b4.value},
      ].map(e=>`${e.n} ‚Äî Subject: ${e.s}\n\n${e.b}`)
       .join('\n\n\n------------------------------\n\n');
      copyText(payload);
    };
    document.querySelectorAll('[data-copy]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const kind = btn.dataset.copy;
        if (kind==='both'){ const s=document.getElementById(btn.dataset.s).value; const b=document.getElementById(btn.dataset.b).value; copyText('Subject: '+s+'\n\n'+b); }
        else copyText(document.getElementById(kind).value);
      });
    });

    function openLink(url){
      if (!url) return setStatus("Missing URL.", true);
      if (url.startsWith("mailto:")) { window.location.href = url; }
      else window.open(url, "_blank", "noopener");
    }

    /* ---------- CONFIG (set these two!) ---------- */
    const APPS_SCRIPT_WEBAPP = "PASTE_YOUR_EXEC_URL_HERE"; // e.g. https://script.google.com/macros/s/AKfycb.../exec
    const FOLLOWUP_SHEET_URL = "PASTE_YOUR_SHEET_URL_HERE"; // optional convenience button

    /* ---------- Status helpers ---------- */
    function $(id){ return document.getElementById(id); }
    function setStatus(msg, dim=false){
      const s = $("status"); if (s){ s.textContent = msg||""; s.style.opacity = dim ? "0.7" : "1"; }
    }

    /* ---------- Contacts: dynamic (Drive/Sheet) with fallbacks ---------- */
    let CONTACTS = {};                       // will be populated from API/cache/import
    const LS_CONTACTS = "heed.contacts.dynamic.v1";

    function cacheContacts(map){ try{ localStorage.setItem(LS_CONTACTS, JSON.stringify(map)); }catch{} }
    function readContacts(){ try{ return JSON.parse(localStorage.getItem(LS_CONTACTS)||"{}"); }catch{ return {}; } }

    async function fetchContactsFromAPI(){
      const url = APPS_SCRIPT_WEBAPP + (APPS_SCRIPT_WEBAPP.includes("?") ? "&" : "?") + "mode=contacts";
      const r = await fetch(url); if (!r.ok) throw new Error("Contacts API not available");
      const j = await r.json(); if (!j || !Array.isArray(j.contacts)) throw new Error("Contacts missing");
      const map = {}; j.contacts.forEach(c=>{ if (c?.name) map[c.name] = { email:c.email||"", phone:c.phone||"", website:c.website||"" }; });
      return map;
    }

    async function loadContactsDynamic(){
      setStatus("Loading contacts‚Ä¶");
      try{
        const map = await fetchContactsFromAPI();
        CONTACTS = map; cacheContacts(map);
        setStatus("Contacts loaded from Drive.", true);
        if (document.getElementById("tab-followup").classList.contains("active")) buildTable();
        return;
      }catch(e){
        const cached = readContacts();
        if (Object.keys(cached).length){ CONTACTS = cached; setStatus("Contacts loaded from cache.", true); if (document.getElementById("tab-followup").classList.contains("active")) buildTable(); return; }
        setStatus("Contacts unavailable (API/cache). Import a file.", true);
      }
    }

    // Manual import (CSV/JSON)
    $("importContacts").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0]; if (!f) return;
      try{
        const text = await f.text(); let map = {};
        if (f.type.includes("json") || f.name.endsWith(".json")){
          const j = JSON.parse(text);
          if (Array.isArray(j)) j.forEach(c=>{ if(c?.name) map[c.name] = { email:c.email||"", phone:c.phone||"", website:c.website||"" }; });
          else map = j || {};
        }else{
          // naive CSV parser: name,email,phone,website (header ok)
          const lines = text.trim().split(/\r?\n/);
          let start = 0; if (/name\s*,/i.test(lines[0])) start = 1;
          for (let i=start;i<lines.length;i++){
            const [name,email,phone,website] = lines[i].split(",").map(s=>s?.trim()?.replace(/^"|"$/g,"")||"");
            if (name) map[name] = { email, phone, website };
          }
        }
        if (!Object.keys(map).length) throw new Error("No contacts found in file.");
        CONTACTS = map; cacheContacts(map);
        buildTable(); setStatus("Contacts imported.", true);
      }catch(err){ setStatus("Import failed."); alert(err.message||"Import failed."); }
      e.target.value = "";
    });
    $("btnReloadContacts").addEventListener("click", loadContactsDynamic);
    $("btnOpenSheet").addEventListener("click", ()=> openLink(FOLLOWUP_SHEET_URL));

    /* ---------- Board state ---------- */
    let ROWS = [];              // [["Lead","Mon","Tue",...], ...]
    let edits = new Map();      // key "r_c" => value text
    let activeCellId = null;

    /* ---------- Modal control ---------- */
    const modal = $("modalBackdrop");
    const modalTA = $("modalTextarea");
    function openModal(id, title, initial){
      activeCellId = id;
      $("modalTitle").textContent = title || "Edit note";
      modalTA.value = initial || "";
      modal.style.display = "flex";
      modal.setAttribute("aria-hidden","false");
      setTimeout(()=>modalTA.focus(), 50);
    }
    function closeModal(){ modal.style.display = "none"; modal.setAttribute("aria-hidden","true"); activeCellId = null; }
    $("modalClose").addEventListener("click", closeModal);
    modal.addEventListener("click", (e)=>{ if (e.target===modal) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if (e.key==="Escape" && modal.getAttribute("aria-hidden")==="false") closeModal(); });
    $("modalSave").addEventListener("click", ()=>{
      if (!activeCellId) return;
      const v = modalTA.value || "";
      const el = document.getElementById("cell-"+activeCellId);
      const ta = document.getElementById("ta-"+activeCellId);
      if (ta) ta.value = v;
      if (el){
        const pv = el.querySelector(".preview"); const bd = el.querySelector(".badge");
        if (pv) pv.textContent = v ? v.replace(/\s+/g,' ').trim() : "Empty";
        el.classList.toggle("empty", !v);
        if (bd) bd.textContent = v ? "Filled" : "Empty";
      }
      edits.set(activeCellId, v);
      setStatus("Unsaved changes‚Ä¶");
      closeModal();
    });

    /* ---------- Build & Load ---------- */
    function mail(link){ const a=document.createElement("a"); a.href="mailto:"+link; a.textContent="üìß "+link; return a; }
    function tel(link){ const a=document.createElement("a"); a.href="tel:"+(link||"").replace(/[^0-9+]/g,""); a.textContent="‚òé "+link; return a; }
    function formatLeadCell(name){
      const wrap = document.createElement("div"); wrap.className="lead";
      const nm = document.createElement("div"); nm.className="name"; nm.textContent = name||"‚Äî"; wrap.appendChild(nm);
      const info = CONTACTS[name];
      if (info){
        const meta = document.createElement("div"); meta.className="meta";
        if (info.email) meta.appendChild(mail(info.email));
        if (info.phone) meta.appendChild(tel(info.phone));
        if (info.website){ const w=document.createElement("a"); w.href=info.website; w.target="_blank"; w.rel="noopener"; w.textContent="üåê Website"; meta.appendChild(w); }
        wrap.appendChild(meta);
      }
      return wrap;
    }

    async function loadBoard(){
      try{
        setStatus("Loading board‚Ä¶");
        const r = await fetch(APPS_SCRIPT_WEBAPP, { method:"GET" });
        if (!r.ok) throw new Error("Could not load board. Check exec URL & access (Anyone).");
        const data = await r.json();
        ROWS = data;
        buildTable();
        setStatus("Loaded.", true);
      }catch(err){
        console.error(err); setStatus(err.message || "Load failed.");
        alert(err.message || "Load failed. In Apps Script: Deploy ‚Üí Web app ‚Üí access 'Anyone'.");
      }
    }

    function buildTable(){
      const tb = $("tbody"); if (!tb) return;
      tb.innerHTML = ""; edits.clear();
      for (let r=1; r<ROWS.length; r++){ // skip header
        const row = ROWS[r]; const lead = row[0] || "";
        const tr = document.createElement("tr");

        const th = document.createElement("th"); th.appendChild(formatLeadCell(lead)); tr.appendChild(th);

        for (let c=0; c<7; c++){ // Mon..Sun
          const id = `${r-1}_${c}`;
          const td = document.createElement("td");

          const ta = document.createElement("textarea"); ta.id = "ta-"+id; ta.style.display = "none"; ta.value = row[c+1] || "";

          const cell = document.createElement("div"); cell.className = "cell"; if (!ta.value) cell.classList.add("empty"); cell.id = "cell-"+id;
          const preview = document.createElement("div"); preview.className = "preview"; preview.textContent = ta.value ? ta.value.replace(/\s+/g,' ').trim() : "Empty";
          const badge = document.createElement("span"); badge.className = "badge"; badge.textContent = ta.value ? "Filled" : "Empty";

          cell.appendChild(preview); cell.appendChild(badge);
          cell.addEventListener("click", ()=>{ const day = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][c]; openModal(id, `${lead} ‚Äî ${day}`, ta.value); });

          td.appendChild(cell); td.appendChild(ta); tr.appendChild(td);
        }
        tb.appendChild(tr);
      }
    }

    async function saveBoard(){
      if (edits.size===0){ setStatus("No changes to save.", true); return; }
      try{
        setStatus("Saving‚Ä¶");
        const rows = [];
        edits.forEach((value,key)=>{ const [ri,ci] = key.split("_").map(Number); rows.push({ rowIndex: ri, colIndex: ci, value }); });
        const resp = await fetch(APPS_SCRIPT_WEBAPP, { method:"POST", headers:{ "Content-Type":"text/plain" }, body: JSON.stringify({rows}) });
        const txt = await resp.text(); let ok=null; try{ ok = JSON.parse(txt); }catch{}
        if (!resp.ok || !ok || !ok.ok) throw new Error(`Save failed (status ${resp.status}): ${txt.substring(0,200)}`);
        edits.clear(); setStatus("Saved.", true);
      }catch(err){ console.error(err); setStatus("Save failed."); alert(err.message || "Save failed. Check Web App permissions."); }
    }

    // Buttons
    $("btnRefresh").addEventListener("click", ()=>{ loadContactsDynamic(); loadBoard(); });
    $("btnSave").addEventListener("click", saveBoard);

    // Boot (load contacts first so lead column shows metadata)
    document.addEventListener("DOMContentLoaded", ()=>{
      loadContactsDynamic().then(loadBoard);
    });
  </script>
</body>
</html>
