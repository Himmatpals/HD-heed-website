<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HD HeeD — Master Follow-Up Sequencer (Zoho)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
<style>
  :root{
    --ink:#0b1226; --bg:#f7f9fc; --card:#ffffff; --muted:#6b7280; --line:#e5e7eb;
    --brand:#4f46e5; --brand2:#ec4899; --ok:#16a34a; --warn:#eab308; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
  .wrap{max-width:1280px;margin:24px auto;padding:0 16px}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand2))}
  .title{font-weight:800;font-size:20px}
  .sub{color:var(--muted);font-size:13px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--line);background:#fff;color:#111827;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#111}
  .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .btn.ghost{background:#fff}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 4px 16px rgba(10,20,40,.06)}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  @media (max-width:1100px){.grid{grid-template-columns:1fr}}
  input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font:inherit}
  textarea{min-height:120px;resize:vertical}
  label{font-size:12px;color:var(--muted);font-weight:600}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:#475569;text-transform:uppercase;letter-spacing:.08em;white-space:nowrap;cursor:pointer}
  tr:last-child td{border-bottom:0}
  .small{font-size:12px} .muted{color:var(--muted)} .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;font-weight:700}
  .right{margin-left:auto}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .row-s{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (max-width:720px){.row-s{grid-template-columns:1fr}}
  .tag{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:#fafafa;color:#111827}
  .tag.ok{background:#ecfdf5;border-color:#86efac;color:#065f46}
  .tag.warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
  .tag.danger{background:#fef2f2;border-color:#fecaca;color:#991b1b}
  .progress{height:8px;border-radius:6px;background:#eef2ff;overflow:hidden}
  .progress > span{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2))}
  .copybox{background:#0f172a;color:#e2e8f0;border-radius:10px;padding:10px}
  .copybox pre{margin:0;white-space:pre-wrap;word-break:break-word}
  .sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
</style>
</head>
<body>
<div class="wrap">
  <header class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">HD HeeD — Master Follow-Up Sequencer</div>
        <div class="sub">7–10 step email sequences • progress tracking • Zoho one-click compose</div>
      </div>
    </div>
    <div class="toolbar">
      <button id="export-json" class="btn">Export JSON</button>
      <label class="btn" for="import-json">Import JSON</label>
      <input id="import-json" type="file" class="sr-only" accept="application/json">
      <button id="export-csv" class="btn">Export CSV</button>
      <label class="btn" for="import-csv">Import CSV</label>
      <input id="import-csv" type="file" class="sr-only" accept=".csv,text/csv">
      <button id="reset" class="btn danger">Reset Local</button>
    </div>
  </header>

  <!-- Settings -->
  <section class="card">
    <h2>Settings</h2>
    <div class="hr"></div>
    <div class="row-s">
      <div>
        <label for="seq-len">Sequence length (7–10)</label>
        <select id="seq-len">
          <option>7</option><option>8</option><option>9</option><option>10</option>
        </select>
      </div>
      <div>
        <label for="default-gap">Default gap between emails (days)</label>
        <input id="default-gap" type="number" min="1" max="14" value="3">
      </div>
    </div>
    <div class="row-s" style="margin-top:8px">
      <div>
        <label for="zoho-domain">Zoho Domain</label>
        <select id="zoho-domain">
          <option value="mail.zoho.com">mail.zoho.com</option>
          <option value="mail.zoho.eu">mail.zoho.eu</option>
          <option value="mail.zoho.in">mail.zoho.in</option>
        </select>
      </div>
      <div>
        <label for="from-name">From name (shown to recipients)</label>
        <input id="from-name" placeholder="HD HeeD">
      </div>
    </div>
    <div class="row-s" style="margin-top:8px">
      <div>
        <label for="initials">Your initials (for notes)</label>
        <input id="initials" placeholder="HS">
      </div>
      <div>
        <label for="business-hour">Target send time (HH:MM)</label>
        <input id="business-hour" type="time" value="09:00">
      </div>
    </div>
    <div class="small muted" style="margin-top:6px">
      “Send Next” opens Zoho compose in a new tab with To/Subject/Body prefilled. You can increase/reduce the sequence length anytime — templates adjust instantly.
    </div>
  </section>

  <div class="grid" style="margin-top:16px">
    <!-- Templates editor -->
    <section class="card" id="templates-card">
      <div class="row">
        <h2>Templates</h2>
        <span class="pill" id="pill-len">7 steps</span>
        <span class="right small muted">Use {{Name}} and {{Company}} placeholders</span>
      </div>
      <div class="hr"></div>
      <div id="tpl-box"></div>
      <div class="row" style="margin-top:8px">
        <button id="save-templates" class="btn primary">Save Templates</button>
      </div>
    </section>

    <!-- Contacts & pipeline -->
    <section class="card">
      <div class="row">
        <h2>Contacts</h2>
        <span class="right row">
          <input id="search" placeholder="Search name/email/company…">
          <select id="filter-status">
            <option value="">All statuses</option>
            <option value="Active">Active</option>
            <option value="Paused">Paused</option>
            <option value="Completed">Completed</option>
          </select>
          <button id="add-contact" class="btn ok">+ Add Contact</button>
        </span>
      </div>
      <div class="hr"></div>

      <div class="row">
        <div class="pill">Due Today: <span id="due-count">0</span></div>
        <button id="view-due" class="btn ghost">Show Due List</button>
      </div>

      <table id="tbl" style="margin-top:10px">
        <thead>
          <tr>
            <th data-sort="name">Name / Company</th>
            <th data-sort="email">Email</th>
            <th data-sort="status">Status</th>
            <th data-sort="last">Last Sent</th>
            <th data-sort="next">Next (step / due)</th>
            <th data-sort="progress">Progress</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

      <template id="row-tpl">
        <tr data-id="">
          <td>
            <div><strong class="c-name"></strong></div>
            <div class="small muted c-company"></div>
            <div class="small">
              <button class="btn btn-notes">Notes</button>
              <span class="small muted">(<span class="notes-count">0</span>)</span>
            </div>
          </td>
          <td class="c-email mono"></td>
          <td><span class="tag c-status">Active</span></td>
          <td class="c-last mono small">—</td>
          <td>
            <div class="c-next mono small">Email 1</div>
            <div class="small muted c-due">—</div>
          </td>
          <td style="min-width:160px">
            <div class="progress"><span class="c-prog" style="width:0%"></span></div>
            <div class="small muted c-prog-label"></div>
          </td>
          <td>
            <div class="toolbar">
              <button class="btn btn-preview">Preview</button>
              <button class="btn primary btn-send">Send Next</button>
              <button class="btn ok btn-mark">Mark Sent</button>
              <button class="btn danger btn-del">Delete</button>
            </div>
          </td>
        </tr>
      </template>
    </section>
  </div>

  <!-- Preview panel -->
  <section class="card" id="preview" style="display:none;margin-top:16px">
    <div class="row">
      <h2>Next Email Preview</h2>
      <span class="right"><button id="pv-close" class="btn">Close</button></span>
    </div>
    <div class="hr"></div>
    <div class="row-s">
      <div><label>Subject</label><input id="pv-subj" readonly></div>
      <div><label>To</label><input id="pv-to" readonly></div>
    </div>
    <div style="margin-top:8px">
      <label>Body</label>
      <div class="copybox"><pre id="pv-body"></pre></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="pv-copy" class="btn primary">Copy Body</button>
      <button id="pv-send" class="btn ok">Send Next (Zoho)</button>
    </div>
  </section>

  <!-- Add/Edit Contact -->
  <section class="card" id="editor" style="display:none;margin-top:16px">
    <div class="row">
      <h2 id="ed-title">Add Contact</h2>
      <span class="right"><button id="ed-cancel" class="btn">Cancel</button></span>
    </div>
    <div class="hr"></div>
    <div class="row-s">
      <div><label>Name</label><input id="ed-name"></div>
      <div><label>Email</label><input id="ed-email"></div>
    </div>
    <div class="row-s" style="margin-top:8px">
      <div><label>Company</label><input id="ed-company"></div>
      <div><label>Initials (default)</label><input id="ed-initials" placeholder="HS"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="ed-save" class="btn primary">Save</button>
    </div>
  </section>

  <!-- Notes -->
  <section class="card" id="notes" style="display:none;margin-top:16px">
    <div class="row">
      <h2>Notes — <span id="notes-for">Contact</span></h2>
      <span class="right"><button id="notes-close" class="btn">Close</button></span>
    </div>
    <div class="hr"></div>
    <div id="notes-list"></div>
    <div class="row" style="margin-top:8px">
      <input id="note-text" placeholder="Add note (e.g., ‘HS sent Email 1 — no reply’)">
      <button id="note-add" class="btn primary">Add Note</button>
    </div>
  </section>
</div>

<script>
/* =================== PERSISTENCE & STATE =================== */
const LS = {
  contacts: "hdheed_master_contacts_v1",
  templates: "hdheed_master_templates_v1",
  settings: "hdheed_master_settings_v1"
};
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const rid = ()=>Math.random().toString(36).slice(2,10);
const nowISO = ()=>new Date().toISOString();
const fmt = d=>d? new Date(d).toLocaleString(): "—";
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

function lsGet(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } }
function lsSet(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

const state = {
  contacts: lsGet(LS.contacts, []),
  templates: lsGet(LS.templates, null),
  settings: lsGet(LS.settings, {
    seqLen: 7,
    defaultGap: 3,
    zohoDomain: "mail.zoho.com",
    fromName: "HD HeeD",
    initials: "HS",
    businessTime: "09:00",
    sortKey: "name",
    sortDir: 1
  }),
  filter: "",
  filterStatus: ""
};

/* ===== Initial 4 templates (replace with your exact current 4 if you want) ===== */
const BASE4 = [
  { step:1, subject:"Welcome to HD HeeD — getting supports started", body:
`Hi {{Name}},

Thank you for connecting with HD HeeD. We provide RN-led NDIS supports (personal care, nursing, wound/stoma, bowel programs, medication administration and more). If helpful, I can outline simple next steps to get started.

Would you prefer a quick call or an email summary?

Kind regards,
Team HD HeeD
hdheed.com.au • 02 8630 5500` },
  { step:2, subject:"Just checking in — any questions I can help with?", body:
`Hi {{Name}},

Just following up my last email to see if you had any questions or needed anything from us. We’re ready to help whenever you are.

Warm regards,
Team HD HeeD` },
  { step:3, subject:"Short resource to help you plan first visits", body:
`Hi {{Name}},

Sharing a brief checklist families/support coordinators find useful to make first visits smooth (consents, goals, meds, equipment). Happy to tailor it if you share a few details.

Best,
Team HD HeeD` },
  { step:4, subject:"Quick reminder — we can line up supports quickly", body:
`Hi {{Name}},

We can organise visits quickly (often within a week). If you’d like, send a brief overview (or referral/plan) and I’ll propose options and timeframes.

Thanks,
Team HD HeeD` },
];
function ensureTemplates(){
  if(!state.templates){
    // start with 7 using base4 then generic
    const out = [];
    for(let i=1;i<=7;i++){
      const base = BASE4.find(b=>b.step===i);
      out.push({ id:rid(), step:i, active:true,
        subject: base?base.subject:`Email ${i}`,
        body: base?base.body:`Hi {{Name}},\n\n...\n\nTeam HD HeeD`
      });
    }
    state.templates = out;
    lsSet(LS.templates, state.templates);
  }
}

/* =================== SETTINGS UI =================== */
function initSettings(){
  $("#seq-len").value = String(state.settings.seqLen);
  $("#default-gap").value = String(state.settings.defaultGap);
  $("#zoho-domain").value = state.settings.zohoDomain;
  $("#from-name").value = state.settings.fromName;
  $("#initials").value = state.settings.initials;
  $("#business-hour").value = state.settings.businessTime;
  $("#pill-len").textContent = `${state.settings.seqLen} steps`;

  $("#seq-len").addEventListener("change", e=>{
    const n = clamp(parseInt(e.target.value,10),7,10);
    state.settings.seqLen = n; lsSet(LS.settings, state.settings);
    // grow/shrink templates
    if(state.templates.length < n){
      for(let s=state.templates.length+1; s<=n; s++){
        state.templates.push({ id:rid(), step:s, active:true, subject:`Email ${s}`, body:`Hi {{Name}},\n\n...\n\nTeam HD HeeD` });
      }
    }else if(state.templates.length > n){
      state.templates = state.templates.slice(0,n);
    }
    lsSet(LS.templates, state.templates);
    $("#pill-len").textContent = `${n} steps`;
    renderTemplates();
    renderContacts();
  });
  $("#default-gap").addEventListener("change", e=>{
    state.settings.defaultGap = clamp(parseInt(e.target.value,10)||3,1,14);
    lsSet(LS.settings, state.settings);
    renderContacts();
  });
  $("#zoho-domain").addEventListener("change", e=>{
    state.settings.zohoDomain = e.target.value; lsSet(LS.settings, state.settings);
  });
  $("#from-name").addEventListener("change", e=>{
    state.settings.fromName = e.target.value.trim()||"HD HeeD"; lsSet(LS.settings, state.settings);
  });
  $("#initials").addEventListener("change", e=>{
    state.settings.initials = e.target.value.trim()||"HS"; lsSet(LS.settings, state.settings);
  });
  $("#business-hour").addEventListener("change", e=>{
    state.settings.businessTime = e.target.value || "09:00"; lsSet(LS.settings, state.settings);
  });
}

/* =================== TEMPLATE UI =================== */
function renderTemplates(){
  const box = $("#tpl-box"); box.innerHTML = "";
  state.templates.sort((a,b)=>a.step-b.step).forEach(t=>{
    const div = document.createElement("div");
    div.className = "card"; div.style.margin="8px 0";
    div.innerHTML = `
      <div class="row">
        <strong>Email ${t.step}</strong>
        <span class="right small">
          <label class="row" style="gap:6px">
            <input type="checkbox" data-id="${t.id}" data-k="active" ${t.active!==false?"checked":""}> Active
          </label>
        </span>
      </div>
      <div class="row-s" style="margin-top:8px">
        <div><label>Subject</label><input data-id="${t.id}" data-k="subject" value="${escapeHtml(t.subject||"")}"></div>
        <div><label>Internal step</label><input readonly value="${t.step}" class="mono"></div>
      </div>
      <div style="margin-top:8px">
        <label>Body</label>
        <textarea data-id="${t.id}" data-k="body">${escapeHtml(t.body||"")}</textarea>
      </div>
    `;
    box.appendChild(div);
  });
}
function saveTemplates(){
  const map = Object.fromEntries(state.templates.map(t=>[t.id,t]));
  $$("#tpl-box [data-id]").forEach(el=>{
    const id = el.dataset.id, k = el.dataset.k;
    if(!map[id]) return;
    if(el.type==="checkbox"){ map[id][k] = el.checked; }
    else { map[id][k] = el.value; }
  });
  lsSet(LS.templates, state.templates);
  alert("Templates saved.");
}

/* =================== CONTACTS CORE =================== */
function nextStepFor(c){
  if((c.status||"Active")==="Completed") return 0;
  const last = c.lastSent||0, N = state.settings.seqLen;
  for(let s=last+1; s<=N; s++){
    const tpl = state.templates.find(t=>t.step===s);
    if(tpl && tpl.active!==false) return s;
  }
  return 0;
}
function dueDateFor(c){
  // If nothing sent yet: today at business time
  const gap = state.settings.defaultGap;
  const [hh,mm] = (state.settings.businessTime||"09:00").split(":").map(x=>parseInt(x,10)||0);
  const d = new Date();
  if(!c.lastSentAt){ d.setHours(hh,mm,0,0); return d; }
  const base = new Date(c.lastSentAt);
  base.setDate(base.getDate()+gap);
  base.setHours(hh,mm,0,0);
  return base;
}
function progressPct(c){
  const N = state.settings.seqLen;
  const done = Math.min(c.lastSent||0, N);
  return Math.round((done/N)*100);
}

/* =================== CONTACTS UI =================== */
function renderContacts(){
  // due today count
  const today = new Date();
  today.setHours(23,59,59,999);
  const due = state.contacts.filter(c=>{
    if((c.status||"Active")!=="Active") return false;
    const step = nextStepFor(c);
    if(!step) return false;
    return dueDateFor(c) <= today;
  });
  $("#due-count").textContent = String(due.length);

  // filter + sort
  const rows = state.contacts
    .filter(c=>{
      if(state.filter){
        const k = `${c.name||""} ${c.email||""} ${c.company||""}`.toLowerCase();
        if(!k.includes(state.filter)) return false;
      }
      if(state.filterStatus){
        if((c.status||"Active")!==state.filterStatus) return false;
      }
      return true;
    })
    .sort(bySort(state.settings.sortKey, state.settings.sortDir));

  const tbody = $("#rows"); tbody.innerHTML = "";
  rows.forEach(c=> tbody.appendChild(rowFor(c)));

  // sortable headers
  $$("#tbl th[data-sort]").forEach(th=>{
    th.onclick = ()=>{
      const key = th.dataset.sort;
      if(state.settings.sortKey===key){ state.settings.sortDir *= -1; } else { state.settings.sortKey = key; state.settings.sortDir = 1; }
      lsSet(LS.settings, state.settings);
      renderContacts();
    };
  });
}
function bySort(key, dir){
  return (a,b)=>{
    const v = (k,obj)=>{
      if(k==="name") return (obj.name||"").toLowerCase();
      if(k==="email") return (obj.email||"").toLowerCase();
      if(k==="status") return (obj.status||"");
      if(k==="last") return obj.lastSentAt||"";
      if(k==="next") return nextStepFor(obj)||999;
      if(k==="progress") return progressPct(obj);
      return (obj.name||"");
    };
    const va = v(key,a), vb = v(key,b);
    if(va<vb) return -1*dir;
    if(va>vb) return 1*dir;
    return 0;
  };
}
function rowFor(c){
  const tpl = $("#row-tpl").content.cloneNode(true);
  const tr = tpl.querySelector("tr");
  tr.dataset.id = c.id;
  $(".c-name",tr).textContent = c.name || "—";
  $(".c-company",tr).textContent = c.company || "";
  $(".c-email",tr).textContent = c.email || "—";

  const status = c.status||"Active";
  const st = $(".c-status",tr); st.textContent = status;
  st.className = "tag c-status " + (status==="Paused"?"warn":status==="Completed"?"ok":"");

  $(".c-last",tr).textContent = c.lastSent? `Email ${c.lastSent} @ ${fmt(c.lastSentAt)}` : "—";

  const next = nextStepFor(c);
  $(".c-next",tr).textContent = next? `Email ${next}` : "Done";
  $(".c-due",tr).textContent = next? `Due: ${fmt(dueDateFor(c))}` : "—";

  const pct = progressPct(c);
  $(".c-prog",tr).style.width = pct+"%";
  $(".c-prog-label",tr).textContent = `${pct}% (${c.lastSent||0}/${state.settings.seqLen})`;

  $(".notes-count",tr).textContent = String(c.notes?.length||0);

  $(".btn-notes",tr).onclick = ()=>openNotes(c.id);
  $(".btn-preview",tr).onclick = ()=>openPreview(c.id);
  $(".btn-send",tr).onclick = ()=>sendNext(c.id);
  $(".btn-mark",tr).onclick = ()=>markSent(c.id);
  $(".btn-del",tr).onclick = ()=>delContact(c.id);

  return tr;
}

/* =================== EDITOR, NOTES, PREVIEW =================== */
function openEditor(contact){
  $("#editor").style.display = "";
  $("#ed-title").textContent = contact? "Edit Contact":"Add Contact";
  $("#ed-name").value = contact?.name || "";
  $("#ed-email").value = contact?.email || "";
  $("#ed-company").value = contact?.company || "";
  $("#ed-initials").value = state.settings.initials || "HS";
  $("#editor").dataset.id = contact?.id || "";
  $("#ed-name").focus();
}
function saveContact(){
  const id = $("#editor").dataset.id || "";
  const obj = {
    id: id || rid(),
    name: $("#ed-name").value.trim(),
    email: $("#ed-email").value.trim(),
    company: $("#ed-company").value.trim()
  };
  const ini = $("#ed-initials").value.trim();
  if(ini){ state.settings.initials = ini; lsSet(LS.settings, state.settings); }
  if(id){
    const i = state.contacts.findIndex(x=>x.id===id);
    if(i>=0) state.contacts[i] = {...state.contacts[i], ...obj};
  }else{
    state.contacts.push({ ...obj, status:"Active", lastSent:0, lastSentAt:"", notes:[] });
  }
  lsSet(LS.contacts, state.contacts);
  $("#editor").style.display="none";
  renderContacts();
}

let NOTES_ID = "";
function openNotes(id){
  const c = state.contacts.find(x=>x.id===id); if(!c) return;
  NOTES_ID = id;
  $("#notes-for").textContent = c.name || c.email || "Contact";
  const box = $("#notes-list"); box.innerHTML = "";
  (c.notes||[]).forEach(n=>{
    const div = document.createElement("div");
    div.style.marginBottom = "8px";
    div.innerHTML = `
      <div class="small muted">${new Date(n.at).toLocaleString()} — <strong>${escapeHtml(n.by||"")}</strong></div>
      <div>${escapeHtml(n.text||"")}</div>`;
    box.appendChild(div);
  });
  if(!c.notes?.length) box.innerHTML = `<div class="small muted">No notes yet.</div>`;
  $("#note-text").value = "";
  $("#notes").style.display = "";
}
function addNote(){
  const t = $("#note-text").value.trim(); if(!t) return;
  const c = state.contacts.find(x=>x.id===NOTES_ID); if(!c) return;
  c.notes = c.notes || [];
  c.notes.push({ at: nowISO(), by:(state.settings.initials||"User"), text: t });
  lsSet(LS.contacts, state.contacts);
  openNotes(NOTES_ID);
}

function buildEmail(c, step){
  const tpl = state.templates.find(t=>t.step===step);
  const name = c.name || "there";
  const company = c.company || "";
  const subject = (tpl?.subject||"").replaceAll("{{Name}}", name).replaceAll("{{Company}}", company);
  const body = (tpl?.body||"").replaceAll("{{Name}}", name).replaceAll("{{Company}}", company);
  return { subject, body };
}
function openPreview(id){
  const c = state.contacts.find(x=>x.id===id); if(!c) return;
  const step = nextStepFor(c); if(!step) return alert("Sequence complete.");
  const { subject, body } = buildEmail(c, step);
  $("#preview").dataset.id = id;
  $("#pv-subj").value = subject||"(no subject)";
  $("#pv-to").value = c.email||"";
  $("#pv-body").textContent = body||"";
  $("#preview").style.display = "";
}
function sendFromPreview(){
  const id = $("#preview").dataset.id; if(!id) return;
  sendNext(id);
}
function sendNext(id){
  const c = state.contacts.find(x=>x.id===id); if(!c) return;
  const step = nextStepFor(c); if(!step) return alert("Sequence complete.");
  const { subject, body } = buildEmail(c, step);
  const dom = state.settings.zohoDomain || "mail.zoho.com";
  // Open Zoho Mail compose in new tab:
  const url = `https://${dom}/zm/#compose?to=${encodeURIComponent(c.email||"")}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.open(url, "_blank");
}

/* =================== MARK, DELETE, DUE LIST =================== */
function markSent(id){
  const c = state.contacts.find(x=>x.id===id); if(!c) return;
  const step = nextStepFor(c);
  if(!step){ alert("Sequence complete."); return; }
  c.lastSent = step;
  c.lastSentAt = nowISO();
  if(step>=state.settings.seqLen) c.status = "Completed";
  lsSet(LS.contacts, state.contacts);
  // auto note
  const by = state.settings.initials||"User";
  (c.notes = c.notes||[]).push({ at: nowISO(), by, text:`Marked Email ${step} as sent.` });
  lsSet(LS.contacts, state.contacts);
  renderContacts();
}
function delContact(id){
  if(!confirm("Delete this contact?")) return;
  state.contacts = state.contacts.filter(x=>x.id!==id);
  lsSet(LS.contacts, state.contacts);
  renderContacts();
}

/* =================== IMPORT/EXPORT =================== */
function exportJSON(){
  const blob = new Blob([JSON.stringify({contacts:state.contacts,templates:state.templates,settings:state.settings},null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `hdheed-followups-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}
async function importJSONFile(file){
  const text = await file.text();
  const data = JSON.parse(text);
  if(!confirm("Import will overwrite local data. Continue?")) return;
  if(data.contacts) state.contacts = data.contacts;
  if(data.templates) state.templates = data.templates;
  if(data.settings) state.settings = {...state.settings, ...data.settings};
  lsSet(LS.contacts, state.contacts); lsSet(LS.templates, state.templates); lsSet(LS.settings, state.settings);
  location.reload();
}
function exportCSV(){
  // contacts only (for spreadsheets)
  const headers = ["id","name","email","company","status","lastSent","lastSentAt","notesCount"];
  const rows = state.contacts.map(c=>[
    c.id, q(c.name), q(c.email), q(c.company), c.status||"Active", c.lastSent||0, c.lastSentAt||"", (c.notes||[]).length
  ]);
  const csv = [headers.join(","), ...rows.map(r=>r.join(","))].join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `hdheed-contacts-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  function q(s){ const t = (s??"").toString().replace(/"/g,'""'); return `"${t}"`; }
}
async function importCSVFile(file){
  const text = await file.text();
  const lines = text.split(/\r?\n/).filter(Boolean);
  if(lines.length<2) return alert("CSV has no data");
  const hdr = lines[0].split(",");
  const rows = lines.slice(1).map(l=>parseCSVLine(l));
  rows.forEach(r=>{
    const obj = Object.fromEntries(hdr.map((h,i)=>[h.trim(), r[i]??""]));
    // upsert by email (or id if provided)
    const id = obj.id || rid();
    const idx = obj.email? state.contacts.findIndex(x=>x.email===obj.email) : -1;
    const c = {
      id,
      name: obj.name||"",
      email: obj.email||"",
      company: obj.company||"",
      status: obj.status||"Active",
      lastSent: Number(obj.lastSent||0),
      lastSentAt: obj.lastSentAt||"",
      notes: []
    };
    if(idx>=0) state.contacts[idx] = {...state.contacts[idx], ...c};
    else state.contacts.push(c);
  });
  lsSet(LS.contacts, state.contacts);
  renderContacts();
}
function parseCSVLine(line){
  const out=[]; let cur="", inq=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='"' && line[i+1]==='"'){ cur+='"'; i++; continue; }
    if(ch==='"'){ inq=!inq; continue; }
    if(ch===',' && !inq){ out.push(cur); cur=""; continue; }
    cur+=ch;
  }
  out.push(cur); return out;
}

/* =================== HELPERS =================== */
function escapeHtml(s=""){return s.replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));}

/* =================== INIT =================== */
function init(){
  ensureTemplates();
  initSettings();
  renderTemplates();
  renderContacts();

  $("#save-templates").onclick = saveTemplates;

  $("#search").oninput = e=>{ state.filter = e.target.value.toLowerCase(); renderContacts(); };
  $("#filter-status").onchange = e=>{ state.filterStatus = e.target.value; renderContacts(); };

  $("#add-contact").onclick = ()=>openEditor();
  $("#ed-cancel").onclick = ()=>$("#editor").style.display="none";
  $("#ed-save").onclick = ()=>saveContact();

  $("#note-add").onclick = ()=>addNote();
  $("#notes-close").onclick = ()=>$("#notes").style.display="none";

  $("#pv-copy").onclick = ()=>navigator.clipboard.writeText($("#pv-body").textContent||"");
  $("#pv-send").onclick = ()=>sendFromPreview();
  $("#pv-close").onclick = ()=>$("#preview").style.display="none";

  $("#export-json").onclick = exportJSON;
  $("#import-json").onchange = e=>{ const f=e.target.files?.[0]; if(f) importJSONFile(f); };
  $("#export-csv").onclick = exportCSV;
  $("#import-csv").onchange = e=>{ const f=e.target.files?.[0]; if(f) importCSVFile(f); };
  $("#reset").onclick = ()=>{ if(confirm("Reset ALL local data?")){ localStorage.removeItem(LS.contacts); localStorage.removeItem(LS.templates); localStorage.removeItem(LS.settings); location.reload(); }};

  // shortcuts
  document.addEventListener("keydown",(e)=>{
    if(e.key==="/"){ e.preventDefault(); $("#search").focus(); }
    if(e.key.toLowerCase()==="n"){ openEditor(); }
  });

  // Due list quick view
  $("#view-due").onclick = ()=>{
    const today = new Date(); today.setHours(23,59,59,999);
    const due = state.contacts.filter(c=> (c.status||"Active")==="Active" && nextStepFor(c) && dueDateFor(c)<=today );
    if(!due.length){ alert("No contacts due today."); return; }
    const msg = due.map(c=>`• ${c.name||c.email||"Contact"} — Next: Email ${nextStepFor(c)} (Due ${fmt(dueDateFor(c))})`).join("\n");
    alert(`Due today:\n\n${msg}`);
  };
}
document.addEventListener("DOMContentLoaded", init);

---

# hdheed-sequencer.html — Part 2/2 (START)

```html
/***** END OF SCRIPT IN PART 1 — NOTHING TO EDIT BELOW THIS LINE *****/
</script>

<!-- Footer Help -->
<div class="wrap" style="margin-bottom:40px">
  <section class="card" style="margin-top:16px">
    <h2>How to Use</h2>
    <div class="hr"></div>
    <ol class="small" style="line-height:1.6">
      <li><strong>Set sequence length:</strong> Choose 7–10 and edit subjects/bodies (use {{Name}} / {{Company}}). Click <em>Save Templates</em>.</li>
      <li><strong>Add contacts:</strong> Name/email/company are optional. The app tracks last sent, next step, next due.</li>
      <li><strong>Send next:</strong> Click <em>Send Next</em> — Zoho compose opens with To/Subject/Body prefilled. Press <em>Send</em> in Zoho.</li>
      <li><strong>Mark sent:</strong> After sending, click <em>Mark Sent</em> (records timestamp, updates progress, auto-adds a note).</li>
      <li><strong>Due list:</strong> Use <em>Due Today</em> to see who’s ready based on your default gap and target time.</li>
      <li><strong>Import/Export:</strong> Use JSON for full backup/restore, CSV for spreadsheets. You can also paste your current 4 templates into step 1–4.</li>
    </ol>
    <div class="small muted">This version uses localStorage for persistence (zero backend). If you want multi-user shared data, we can wire a Google Sheet or Zoho Creator endpoint later with the same data model.</div>
  </section>

  <footer class="small muted" style="text-align:center;margin:24px 0 0">
    HD HeeD • “Because we care, we provide HD care.” • v1.0
  </footer>
</div>

</body>
</html>
