<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HD HeeD — Emails + Follow-ups (Zoho-ready)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
<style>
  :root{
    --ink:#0c1226; --bg:#f6f8fc; --card:#fff; --muted:#6b7280; --line:#e5e7eb;
    --brand:#4f46e5; --brand2:#ec4899; --ok:#16a34a; --warn:#eab308; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2))}
  .title{font-weight:800;font-size:20px}
  .sub{color:var(--muted);font-size:13px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--line);background:#fff;color:#111827;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#111}
  .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width: 1020px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 4px 14px rgba(10,20,40,.05)}
  .card h2{margin:0 0 8px 0;font-size:16px;font-weight:800}
  .hr{height:1px;background:var(--line);margin:12px 0}
  input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font:inherit}
  textarea{min-height:120px;resize:vertical}
  label{font-size:12px;color:var(--muted);font-weight:600}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  th{font-size:12px;color:#475569;text-transform:uppercase;letter-spacing:.08em}
  tr:last-child td{border-bottom:0}
  .tag{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:#fafafa;color:#111827}
  .tag.ok{background:#ecfdf5;border-color:#86efac;color:#065f46}
  .tag.warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
  .muted{color:var(--muted)} .small{font-size:12px} .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .row-s{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (max-width:720px){.row-s{grid-template-columns:1fr}}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;font-weight:700}
  .right{margin-left:auto}
  .copy-box{background:#0f172a;color:#e2e8f0;border-radius:10px;padding:10px}
  .copy-box pre{margin:0;white-space:pre-wrap;word-break:break-word}
</style>
</head>
<body>
<div class="wrap">
  <header class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">HD HeeD — Emails + Follow-ups (Zoho)</div>
        <div class="sub">Single page: templates + tracking • Next-in-sequence • Send via Zoho</div>
      </div>
    </div>
    <div class="toolbar">
      <button id="export" class="btn">Export JSON</button>
      <label class="btn" for="import">Import JSON</label>
      <input id="import" type="file" class="sr-only" style="display:none" accept="application/json">
      <button id="reset" class="btn danger">Reset Local</button>
    </div>
  </header>

  <section class="card">
    <h2>Sending Mode</h2>
    <div class="hr"></div>
    <div class="row-s">
      <div>
        <label for="send-mode">Choose how “Email” works</label>
        <select id="send-mode">
          <option value="zoho-compose">Open Zoho Compose (prefilled)</option>
          <option value="zoho-webhook">Send via Zoho (Webhook server-side)</option>
          <option value="mailto">Open default mail app (mailto:)</option>
        </select>
      </div>
      <div>
        <label for="zoho-domain">Zoho domain</label>
        <select id="zoho-domain">
          <option value="mail.zoho.com">mail.zoho.com</option>
          <option value="mail.zoho.eu">mail.zoho.eu</option>
          <option value="mail.zoho.in">mail.zoho.in</option>
        </select>
      </div>
    </div>
    <div class="row-s" style="margin-top:8px">
      <div>
        <label for="from-name">From name (shown to recipients)</label>
        <input id="from-name" placeholder="HD HeeD">
      </div>
      <div>
        <label for="webhook-url">Zoho Flow Webhook URL (for server-side send)</label>
        <input id="webhook-url" placeholder="https://flow.zoho.com/.../hook/xxxxxxxx">
      </div>
    </div>
    <div class="small muted" style="margin-top:6px">
      Tip: For true “send-as <strong>info@hdheed.com.au</strong>” directly from the page, use a <strong>Zoho Flow</strong> webhook that calls Zoho Mail “Send mail” on your behalf. No credentials in the browser.
    </div>
  </section>

  <div class="grid">
    <!-- Templates (combines /emails.html) -->
    <section class="card" id="templates">
      <div class="row">
        <h2>Email Templates</h2>
        <span class="pill" id="seq-pill">4 steps</span>
        <span class="right small muted">Use {{Name}} and {{Company}}</span>
      </div>
      <div class="hr"></div>

      <div class="row-s">
        <div>
          <label for="seq-len">Sequence length (start with 4, add more later)</label>
          <select id="seq-len">
            <option>4</option><option>5</option><option>6</option><option>7</option><option>8</option>
          </select>
        </div>
        <div>
          <label for="initials">Your initials (for notes)</label>
          <input id="initials" placeholder="HS">
        </div>
      </div>

      <div id="tpl-box" style="margin-top:8px"></div>

      <div class="row" style="margin-top:8px">
        <button id="save-templates" class="btn primary">Save Templates</button>
      </div>
    </section>

    <!-- Follow-up tracker (combines /followup.html) -->
    <section class="card" id="contacts-card">
      <div class="row">
        <h2>Contacts & Sequence</h2>
        <span class="right row">
          <input id="search" placeholder="Search name/email/company…">
          <button id="add-contact" class="btn ok">+ Add Contact</button>
        </span>
      </div>
      <div class="hr"></div>
      <div class="small muted">Add up to 20+ contacts. “Email” auto-picks the next template in the sequence.</div>

      <table style="margin-top:8px">
        <thead>
          <tr>
            <th>Name / Company</th>
            <th>Email</th>
            <th>Status</th>
            <th>Last Sent</th>
            <th>Next Email</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

      <template id="row-tpl">
        <tr data-id="">
          <td>
            <div><strong class="c-name"></strong></div>
            <div class="small muted c-company"></div>
            <div class="small">
              <button class="btn btn-notes">Notes</button>
              <span class="small muted">(<span class="notes-count">0</span>)</span>
            </div>
          </td>
          <td class="c-email mono"></td>
          <td><span class="tag c-status">Active</span></td>
          <td><div class="c-last mono small">—</div></td>
          <td><span class="tag warn c-next">Email 1</span></td>
          <td>
            <div class="toolbar">
              <button class="btn btn-preview">Preview</button>
              <button class="btn primary btn-email">Email</button>
              <button class="btn ok btn-mark">Mark Sent</button>
              <button class="btn danger btn-del">Delete</button>
            </div>
          </td>
        </tr>
      </template>
    </section>
  </div>

  <!-- Preview panel -->
  <section class="card" id="preview" style="display:none;margin-top:16px">
    <div class="row">
      <h2>Next Email Preview</h2>
      <span class="right"><button id="pv-close" class="btn">Close</button></span>
    </div>
    <div class="hr"></div>
    <div class="row-s">
      <div>
        <label>Subject</label>
        <input id="pv-subj" readonly>
      </div>
      <div>
        <label>To</label>
        <input id="pv-to" readonly>
      </div>
    </div>
    <div style="margin-top:8px">
      <label>Body</label>
      <div class="copy-box"><pre id="pv-body"></pre></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="pv-copy" class="btn primary">Copy Body</button>
      <button id="pv-send" class="btn ok">Email (using current mode)</button>
    </div>
  </section>

  <!-- Add contact editor -->
  <section class="card" id="editor" style="display:none;margin-top:16px">
    <div class="row">
      <h2 id="ed-title">Add Contact</h2>
      <span class="right"><button id="ed-cancel" class="btn">Cancel</button></span>
    </div>
    <div class="hr"></div>
    <div class="row-s">
      <div><label>Name</label><input id="ed-name"></div>
      <div><label>Email</label><input id="ed-email"></div>
    </div>
    <div class="row-s" style="margin-top:8px">
      <div><label>Company</label><input id="ed-company"></div>
      <div><label>Initials (default)</label><input id="ed-initials" placeholder="HS"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="ed-save" class="btn primary">Save</button>
    </div>
  </section>

  <!-- Notes panel -->
  <section class="card" id="notes" style="display:none;margin-top:16px">
    <div class="row">
      <h2>Notes — <span id="notes-for">Contact</span></h2>
      <span class="right"><button id="notes-close" class="btn">Close</button></span>
    </div>
    <div class="hr"></div>
    <div id="notes-list"></div>
    <div class="row" style="margin-top:8px">
      <input id="note-text" placeholder="Add note (e.g., ‘HS sent Email 1 — no reply’)">
      <button id="note-add" class="btn primary">Add Note</button>
    </div>
  </section>
</div>

<script>
/* =================== STORAGE & STATE =================== */
const LS = {
  contacts: "hdheed_fx_contacts_v1",
  templates: "hdheed_fx_templates_v1",
  settings: "hdheed_fx_settings_v1",
};

function lsGet(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } }
function lsSet(k, v){ localStorage.setItem(k, JSON.stringify(v)); }

const state = {
  contacts: lsGet(LS.contacts, []),
  templates: lsGet(LS.templates, null),
  settings: lsGet(LS.settings, {
    seqLen: 4,
    sendMode: "zoho-compose",
    zohoDomain: "mail.zoho.com",
    webhookUrl: "",
    fromName: "HD HeeD",
    initials: "HS"
  }),
  filter: ""
};

/* ===== Default 4 templates from your current emails.html (replace with your content) ===== */
const DEFAULT_4 = [
  { step:1, subject:"Welcome to HD HeeD — getting supports started", body:
`Hi {{Name}},

Thank you for connecting with HD HeeD. We provide RN-led NDIS supports (personal care, nursing, wound/stoma, bowel programs, medication administration and more). If helpful, I can outline simple next steps to get started.

Would you prefer a quick call or an email summary?

Kind regards,
Team HD HeeD
hdheed.com.au • 02 8630 5500` },
  { step:2, subject:"Just checking in — any questions I can help with?", body:
`Hi {{Name}},

Just following up my last email to see if you had any questions or needed anything from us. We’re ready to help whenever you are.

Warm regards,
Team HD HeeD` },
  { step:3, subject:"Short resource to help you plan first visits", body:
`Hi {{Name}},

Sharing a brief checklist families/support coordinators find useful to make first visits smooth (consents, goals, meds, equipment). Happy to tailor it if you share a few details.

Best,
Team HD HeeD` },
  { step:4, subject:"Quick reminder — we can line up supports quickly", body:
`Hi {{Name}},

We can organise visits quickly (often within a week). If you’d like, send a brief overview (or referral/plan) and I’ll propose options and timeframes.

Thanks,
Team HD HeeD` },
];

/* Build initial templates if none saved */
function ensureTemplates(){
  if(!state.templates){
    state.templates = DEFAULT_4.map(t => ({ id:rid(), active:true, ...t }));
    lsSet(LS.templates, state.templates);
  }
}

/* =================== UTIL =================== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const rid = ()=>Math.random().toString(36).slice(2,10);
const nowISO = ()=>new Date().toISOString();
const fmt = d=>d? new Date(d).toLocaleString(): "—";
function escapeHtml(s=""){return s.replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));}

/* =================== INIT UI =================== */
document.addEventListener("DOMContentLoaded", () => {
  ensureTemplates();
  // settings
  $("#seq-len").value = String(state.settings.seqLen);
  $("#send-mode").value = state.settings.sendMode;
  $("#zoho-domain").value = state.settings.zohoDomain;
  $("#webhook-url").value = state.settings.webhookUrl;
  $("#from-name").value = state.settings.fromName;
  $("#initials").value = state.settings.initials;
  updateSeqPill();

  renderTemplates();
  renderContacts();

  // binds
  $("#save-templates").addEventListener("click", saveTemplatesFromUI);
  $("#seq-len").addEventListener("change", onSeqLenChange);
  $("#send-mode").addEventListener("change", e=>{state.settings.sendMode=e.target.value; saveSettings();});
  $("#zoho-domain").addEventListener("change", e=>{state.settings.zohoDomain=e.target.value; saveSettings();});
  $("#webhook-url").addEventListener("change", e=>{state.settings.webhookUrl=e.target.value.trim(); saveSettings();});
  $("#from-name").addEventListener("change", e=>{state.settings.fromName=e.target.value.trim(); saveSettings();});
  $("#initials").addEventListener("change", e=>{state.settings.initials=e.target.value.trim(); saveSettings();});

  $("#add-contact").addEventListener("click", ()=>openEditor());
  $("#ed-cancel").addEventListener("click", ()=>$("#editor").style.display="none");
  $("#ed-save").addEventListener("click", saveContactFromEditor);

  $("#search").addEventListener("input", e=>{ state.filter = e.target.value.toLowerCase(); renderContacts(); });

  $("#pv-close").addEventListener("click", ()=>$("#preview").style.display="none");
  $("#pv-copy").addEventListener("click", ()=>navigator.clipboard.writeText($("#pv-body").textContent||""));
  $("#pv-send").addEventListener("click", sendFromPreview);

  $("#export").addEventListener("click", exportJSON);
  $("#import").addEventListener("change", importJSON);
  $("#reset").addEventListener("click", ()=>{ if(confirm("Reset all local data?")){ localStorage.removeItem(LS.contacts); localStorage.removeItem(LS.templates); localStorage.removeItem(LS.settings); location.reload(); }});
});

/* =================== SETTINGS =================== */
function saveSettings(){ lsSet(LS.settings, state.settings); }
function onSeqLenChange(e){
  const n = parseInt(e.target.value,10);
  state.settings.seqLen = n; saveSettings();
  // grow/shrink templates
  if(state.templates.length < n){
    const start = state.templates.length + 1;
    for(let step=start; step<=n; step++){
      state.templates.push({ id:rid(), step, active:true, subject:`Email ${step}`, body:`Hi {{Name}},\n\n...\n\nTeam HD HeeD` });
    }
  }else if(state.templates.length > n){
    state.templates = state.templates.slice(0, n);
  }
  lsSet(LS.templates, state.templates);
  updateSeqPill();
  renderTemplates();
}
function updateSeqPill(){ $("#seq-pill").textContent = `${state.settings.seqLen} steps`; }

/* =================== TEMPLATES UI =================== */
function renderTemplates(){
  const box = $("#tpl-box"); box.innerHTML = "";
  state.templates.sort((a,b)=>a.step-b.step).forEach(t=>{
    const div = document.createElement("div");
    div.className = "card"; div.style.margin="8px 0";
    div.innerHTML = `
      <div class="row">
        <strong>Email ${t.step}</strong>
        <span class="right small">
          <label class="row" style="gap:6px">
            <input type="checkbox" data-id="${t.id}" data-k="active" ${t.active!==false?"checked":""}> Active
          </label>
        </span>
      </div>
      <div class="row-s" style="margin-top:8px">
        <div><label>Subject</label><input data-id="${t.id}" data-k="subject" value="${escapeHtml(t.subject||"")}"></div>
        <div><label>Internal step</label><input readonly value="${t.step}" class="mono"></div>
      </div>
      <div style="margin-top:8px">
        <label>Body</label>
        <textarea data-id="${t.id}" data-k="body">${escapeHtml(t.body||"")}</textarea>
      </div>
    `;
    box.appendChild(div);
  });
}
function saveTemplatesFromUI(){
  const map = Object.fromEntries(state.templates.map(t=>[t.id,t]));
  $$("#tpl-box [data-id]").forEach(el=>{
    const id = el.dataset.id, k = el.dataset.k;
    if(!map[id]) return;
    if(el.type==="checkbox"){ map[id][k] = el.checked; }
    else { map[id][k] = el.value; }
  });
  lsSet(LS.templates, state.templates);
  alert("Templates saved.");
}

/* =================== CONTACTS =================== */
function renderContacts(){
  const tbody = $("#rows"); tbody.innerHTML = "";
  state.contacts
    .filter(c=>{
      if(!state.filter) return true;
      const k = `${c.name||""} ${c.email||""} ${c.company||""}`.toLowerCase();
      return k.includes(state.filter);
    })
    .sort((a,b)=>(a.name||"").localeCompare(b.name||""))
    .forEach(c=> tbody.appendChild(renderRow(c)));
}
function renderRow(c){
  const tpl = $("#row-tpl").content.cloneNode(true);
  const tr = tpl.querySelector("tr");
  tr.dataset.id = c.id;
  $(".c-name",tr).textContent = c.name || "—";
  $(".c-company",tr).textContent = c.company || "";
  $(".c-email",tr).textContent = c.email || "—";
  const status = c.status || "Active";
  const statusEl = $(".c-status",tr);
  statusEl.textContent = status;
  statusEl.className = "tag c-status " + (status==="Completed"?"ok":status==="Paused"?"warn":"");
  $(".c-last",tr).textContent = c.lastSent? `Email ${c.lastSent} @ ${fmt(c.lastSentAt)}` : "—";
  const next = nextEmail(c);
  $(".c-next",tr).textContent = next? `Email ${next}` : "Done";
  $(".c-next",tr).className = "tag " + (next? "warn c-next":"ok c-next");
  $(".notes-count",tr).textContent = String(c.notes?.length||0);

  $(".btn-notes",tr).addEventListener("click", ()=>openNotes(c.id));
  $(".btn-preview",tr).addEventListener("click", ()=>preview(c.id));
  $(".btn-email",tr).addEventListener("click", ()=>sendNext(c.id));
  $(".btn-mark",tr).addEventListener("click", ()=>markSent(c.id));
  $(".btn-del",tr).addEventListener("click", ()=>delContact(c.id));

  return tr;
}
function nextEmail(c){
  if((c.status||"Active")==="Completed") return 0;
  const last = c.lastSent||0, N = state.settings.seqLen;
  for(let s=last+1; s<=N; s++){
    const t = state.templates.find(x=>x.step===s);
    if(t && t.active!==false) return s;
  }
  return 0;
}
function openEditor(contact){
  $("#editor").style.display = "";
  $("#ed-title").textContent = contact? "Edit Contact":"Add Contact";
  $("#ed-name").value = contact?.name || "";
  $("#ed-email").value = contact?.email || "";
  $("#ed-company").value = contact?.company || "";
  $("#ed-initials").value = state.settings.initials || "";
  $("#editor").dataset.id = contact?.id || "";
  $("#ed-name").focus();
}
function saveContactFromEditor(){
  const id = $("#editor").dataset.id || "";
  const obj = {
    id: id || rid(),
    name: $("#ed-name").value.trim(),
    email: $("#ed-email").value.trim(),
    company: $("#ed-company").value.trim(),
  };
  const initials = $("#ed-initials").value.trim();
  if(initials){ state.settings.initials = initials; saveSettings(); }
  if(id){
    const i = state.contacts.findIndex(x=>x.id===id);
    if(i>=0) state.contacts[i] = {...state.contacts[i], ...obj};
  }else{
    state.contacts.push({ ...obj, status:"Active", lastSent:0, lastSentAt:"", notes:[] });
  }
  lsSet(LS.contacts, state.contacts);
  $("#editor").style.display="none";
  renderContacts();
}
function markSent(id){
  const c = state.contacts.find(x=>x.id===id); if(!c) return;
  const step = nextEmail(c);
  if(!step){ alert("Sequence complete."); return; }
  c.lastSent = step; c.lastSentAt = nowISO();
  if(step>=state.settings.seqLen) c.status = "Completed";
  lsSet(LS.contacts, state.contacts);
  // auto note
  addNoteInternal(c.id, `${state.settings.initials||"User"} marked Email ${step} as sent.`);
  renderContacts();
}
function delContact(id){
  if(!confirm("Delete this contact?")) return;
  state.contacts = state.contacts.filter(x=>x.id!==id);
  lsSet(LS.contacts, state.contacts);
  renderContacts();
}

/* =================== PREVIEW / SEND =================== */
function buildEmail(c, step){
  const tpl = state.templates.find(t=>t.step===step);
  const name = c.name || "there";
  const company = c.company || "";
  const subject = (tpl?.subject||"").replaceAll("{{Name}}", name).replaceAll("{{Company}}", company);
  const body = (tpl?.body||"").replaceAll("{{Name}}", name).replaceAll("{{Company}}", company);
  return { subject, body };
}
function preview(id){
  const c = state.contacts.find(x=>x.id===id); if(!c) return;
  const step = nextEmail(c); if(!step) return alert("Sequence complete.");
  const {subject, body} = buildEmail(c, step);
  $("#pv-subj").value = subject||"(no subject)";
  $("#pv-to").value = c.email||"";
  $("#pv-body").textContent = body||"";
  $("#preview").dataset.id = id;
  $("#preview").style.display = "";
}
function sendFromPreview(){
  const id = $("#preview").dataset.id; if(!id) return;
  sendNext(id);
}
function sendNext(id){
  const c = state.contacts.find(x=>x.id===id); if(!c) return;
  const step = nextEmail(c); if(!step) return alert("Sequence complete.");
  const {subject, body} = buildEmail(c, step);
  const mode = state.settings.sendMode;

  if(mode==="mailto"){
    const url = `mailto:${encodeURIComponent(c.email||"")}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = url;
    return;
  }
  if(mode==="zoho-compose"){
    // Opens Zoho webmail compose with prefilled to/subject/body
    // Works best when user is logged into Zoho Mail in the browser.
    const dom = state.settings.zohoDomain;
    const url = `https://${dom}/zm/#compose?to=${encodeURIComponent(c.email||"")}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.open(url, "_blank");
    return;
  }
  if(mode==="zoho-webhook"){
    const hook = state.settings.webhookUrl;
    if(!hook){ alert("Add Zoho Flow Webhook URL in Sending Mode section."); return; }
    fetch(hook, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        to: c.email||"",
        subject,
        body,
        fromName: state.settings.fromName || "HD HeeD",
        // EXTRA context (handy in Flow): 
        contact: { id:c.id, name:c.name||"", company:c.company||"" },
        step
      })
    }).then(r=>{
      if(!r.ok) throw new Error("Webhook failed");
      return r.text();
    }).then(()=>{
      alert("Sent via Zoho webhook.");
    }).catch(e=>{
      alert("Send failed: " + e.message);
    });
    return;
  }
}
/* =================== NOTES =================== */
let NOTES_ID = "";
function openNotes(id){
  const c = state.contacts.find(x=>x.id===id); if(!c) return;
  NOTES_ID = id;
  $("#notes-for").textContent = c.name || c.email || "Contact";
  const box = $("#notes-list"); box.innerHTML = "";
  (c.notes||[]).forEach(n=>{
    const div = document.createElement("div");
    div.style.marginBottom = "8px";
    div.innerHTML = `
      <div class="small muted">${new Date(n.at).toLocaleString()} — <strong>${escapeHtml(n.by||"")}</strong></div>
      <div>${escapeHtml(n.text||"")}</div>
    `;
    box.appendChild(div);
  });
  if(!c.notes?.length){ box.innerHTML = `<div class="small muted">No notes yet.</div>`; }
  $("#note-text").value = "";
  $("#notes").style.display = "";
}
function addNote(){
  const t = $("#note-text").value.trim(); if(!t) return;
  addNoteInternal(NOTES_ID, t);
  openNotes(NOTES_ID);
}
function addNoteInternal(id, text){
  const c = state.contacts.find(x=>x.id===id); if(!c) return;
  c.notes = c.notes || [];
  c.notes.push({ at: nowISO(), by: (state.settings.initials||"User"), text });
  lsSet(LS.contacts, state.contacts);
}
$("#notes-close")?.addEventListener("click", ()=>$("#notes").style.display="none");

/* =================== IMPORT / EXPORT =================== */
function exportJSON(){
  const blob = new Blob([JSON.stringify({contacts:state.contacts, templates:state.templates, settings:state.settings},null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `hdheed-followups-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}
async function importJSON(e){
  const f = e.target.files?.[0]; if(!f) return;
  const text = await f.text();
  const data = JSON.parse(text);
  if(!confirm("Import will overwrite current local data. Continue?")) return;
  if(data.contacts) state.contacts = data.contacts;
  if(data.templates) state.templates = data.templates;
  if(data.settings) state.settings = data.settings;
  lsSet(LS.contacts, state.contacts); lsSet(LS.templates, state.templates); lsSet(LS.settings, state.settings);
  location.reload();
}

/* =================== KEYBOARD SHORTCUTS =================== */
document.addEventListener("keydown", (e)=>{
  if(e.key==="/"){ e.preventDefault(); $("#search").focus(); }
  if(e.key.toLowerCase()==="n"){ openEditor(); }
});

/* =================== END =================== */
</script>

<!-- Footer help -->
<div class="wrap">
  <section class="card" style="margin-top:16px">
    <h2>How to Use</h2>
    <div class="hr"></div>
    <ol class="small" style="line-height:1.6">
      <li><strong>Templates:</strong> Your first 4 emails are preloaded. Edit them, then increase “Sequence length” to add steps 5–8. Click <em>Save Templates</em>.</li>
      <li><strong>Contacts:</strong> Add name/email/company (optional). The table shows <em>Last Sent</em> and auto-suggests the <em>Next Email</em>.</li>
      <li><strong>Email:</strong> Set <em>Sending Mode</em>:
        <ul>
          <li><em>Open Zoho Compose</em>: opens Zoho webmail with to/subject/body prefilled.</li>
          <li><em>Zoho Webhook</em>: sends via Zoho Flow (server-side) as <strong>info@hdheed.com.au</strong>.</li>
          <li><em>mailto:</em> opens your default mail client.</li>
        </ul>
      </li>
      <li><strong>After sending</strong> click <em>Mark Sent</em> (auto-adds a note with your initials).</li>
      <li><strong>Notes:</strong> Use <em>Notes</em> to log team comments (timestamped).</li>
      <li><strong>Backup:</strong> Use <em>Export/Import JSON</em> to save/restore.</li>
    </ol>
    <div class="small muted">Everything saves locally in your browser. If multiple staff share this page, set up Zoho Flow webhook to send from <strong>info@hdheed.com.au</strong> and (optionally) later we can add Google Sheet sync so everyone sees the same data.</div>
  </section>

  <footer class="small muted" style="text-align:center;margin:24px 0 40px">
    HD HeeD • “Because we care, we provide HD care.” • v1.0
  </footer>
</div>

</body>
</html>
