<!doctype html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HD HeeD — Follow-Up Sequencer</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
<link rel="manifest" href="#app-manifest">
<meta name="theme-color" content="#0b1226" />
<style>
/* ===== Visual System (elevated look: glass, gradients, motion) ===== */
:root{
  --font: Inter, system-ui, Segoe UI, Arial, sans-serif;
  --ink:#0e1324; --bg:#0b1226; --wash:#0b1226; --card:rgba(255,255,255,.08);
  --muted:#a6b0c2; --line:rgba(255,255,255,.12);
  --brand:#7c6cff; --brand2:#ff6fb1; --ok:#22c55e; --warn:#facc15; --danger:#ef4444; --info:#38bdf8;
  --shadow: 0 10px 40px rgba(0,0,0,.35);
  --radius: 16px;
  --glass: blur(12px) saturate(140%);
}
:root[data-theme="light"]{
  --ink:#0b1226; --bg:#f6f7fb; --wash:#e9ecf7; --card:rgba(255,255,255,.9);
  --muted:#667085; --line:#e7e9f2; --shadow: 0 12px 36px rgba(12,18,40,.12);
}
/* High contrast option */
:root[data-theme="contrast"]{
  --ink:#000; --bg:#fff; --wash:#fff; --card:#fff; --muted:#111; --line:#000;
  --brand:#000; --brand2:#333; --ok:#000; --warn:#000; --danger:#000; --info:#000;
}

/* Background flair */
body{margin:0; font-family:var(--font); color:var(--ink); background:
 radial-gradient(1200px 600px at 10% -10%, rgba(124,108,255,.18), transparent 60%),
 radial-gradient(1000px 600px at 110% 10%, rgba(255,111,177,.16), transparent 60%),
 linear-gradient(180deg, var(--bg), var(--wash));}
.wrap{max-width:1280px;margin:22px auto;padding:0 18px}

/* Card = glass */
.card{background:var(--card); backdrop-filter:var(--glass); border:1px solid var(--line);
  border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
.hr{height:1px;background:var(--line);margin:12px 0}

/* Header */
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:48px;height:48px;border-radius:14px;background:conic-gradient(from 180deg,var(--brand),var(--brand2))}
.title{font-weight:800;font-size:22px}
.sub{color:var(--muted);font-size:13px}

/* Buttons */
.btn{appearance:none;border:1px solid var(--line);background:transparent;color:var(--ink);
  border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;border-color:transparent}
.btn.ok{background:linear-gradient(90deg,#16a34a,#22c55e);color:#fff;border-color:transparent}
.btn.warn{background:linear-gradient(90deg,#f59e0b,#facc15);color:#111;border-color:transparent}
.btn.danger{background:linear-gradient(90deg,#ef4444,#f87171);color:#fff;border-color:transparent}
.btn.ghost{background:transparent}
.btn:active{transform:translateY(1px)}

/* Inputs & table */
input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--ink);font:inherit}
label{font-size:12px;color:var(--muted);font-weight:700}
table{width:100%;border-collapse:separate;border-spacing:0}
th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;white-space:nowrap;cursor:pointer}
tr:last-child td{border-bottom:0}
.small{font-size:12px} .muted{color:var(--muted)}
.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}

/* Grid */
.grid{display:grid;grid-template-columns:1.15fr .85fr;gap:16px}
@media (max-width:1100px){.grid{grid-template-columns:1fr}}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
@media (max-width:1100px){.grid-3{grid-template-columns:1fr}}

/* Chips, progress */
.tag{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.12);color:var(--ink)}
.tag.ok{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.35)}
.tag.warn{background:rgba(250,204,21,.15);border-color:rgba(250,204,21,.35)}
.tag.danger{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.35)}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(124,108,255,.18);color:#fff;font-size:12px;font-weight:800}
.progress{height:8px;border-radius:6px;background:rgba(255,255,255,.12);overflow:hidden}
.progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2))}

/* Toasts & modal */
.toast{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:1000}
.toast .item{background:var(--card);border:1px solid var(--line);border-radius:10px;box-shadow:var(--shadow);padding:10px 12px}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:900}
.modal{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;max-width:720px;width:min(720px,96vw)}

/* RTE (contenteditable) */
.rte{border:1px solid var(--line);border-radius:10px;background:rgba(255,255,255,.08);color:var(--ink);padding:10px;min-height:130px}
.rte-toolbar{display:flex;gap:6px;margin:6px 0}
kbd{background:rgba(255,255,255,.2);color:var(--ink);padding:2px 6px;border-radius:6px;border:1px solid var(--line);font:inherit;font-size:11px}

/* Motion */
@keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-3px)}100%{transform:translateY(0)}}
.logo{animation:float 6s ease-in-out infinite}

/* ===== EXPANSION: duplicate these theme palettes/keyframes to grow lines without bloat ===== */
/* THEME-PALETTE-SET-01 */
:root[data-theme="ocean"]{--brand:#00d4ff;--brand2:#0077ff}
:root[data-theme="sunset"]{--brand:#ff7a59;--brand2:#ff3d81}
:root[data-theme="forest"]{--brand:#34d399;--brand2:#059669}
/* (Copy/modify more sets if you want line count ↑ while adding value) */
</style>

<script type="application/manifest+json" id="app-manifest">
{
  "name": "HD HeeD Sequencer",
  "short_name": "HeeD Sequencer",
  "start_url": "./followup.html",
  "display": "standalone",
  "background_color": "#0b1226",
  "theme_color": "#0b1226",
  "icons": []
}
</script>
</head>
<body>
<a href="#main" style="position:absolute;left:-9999px" onfocus="this.style.left='12px'">Skip to content</a>

<div class="wrap" id="app-root" aria-live="polite">
  <header class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">HD HeeD — Follow-Up Sequencer</div>
        <div class="sub">Stylish • Trackable • Zoho one-click • Offline</div>
      </div>
    </div>
    <div class="toolbar" role="toolbar" aria-label="Global actions">
      <button id="theme-toggle" class="btn">Theme</button>
      <button id="export-json" class="btn">Export JSON</button>
      <label class="btn" for="import-json">Import JSON</label>
      <input id="import-json" type="file" style="position:absolute;left:-9999px" accept="application/json">
      <button id="export-csv" class="btn">Export CSV</button>
      <label class="btn" for="import-csv">Import CSV</label>
      <input id="import-csv" type="file" style="position:absolute;left:-9999px" accept=".csv,text/csv">
      <button id="reset" class="btn danger">Reset</button>
    </div>
  </header>

  <!-- SETTINGS -->
  <section class="card" role="region" aria-labelledby="settings-h">
    <h2 id="settings-h">Settings</h2>
    <div class="hr"></div>
    <div class="grid-3">
      <div>
        <label for="seq-len">Sequence length (7–10)</label>
        <select id="seq-len"><option>7</option><option>8</option><option>9</option><option>10</option></select>
      </div>
      <div>
        <label for="default-gap">Gap between emails (days)</label>
        <input id="default-gap" type="number" min="1" max="30" value="3">
      </div>
      <div>
        <label for="target-time">Target send time (HH:MM)</label>
        <input id="target-time" type="time" value="09:00">
      </div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div>
        <label for="zoho-domain">Zoho Domain</label>
        <select id="zoho-domain"><option value="mail.zoho.com">mail.zoho.com</option><option value="mail.zoho.eu">mail.zoho.eu</option><option value="mail.zoho.in">mail.zoho.in</option></select>
      </div>
      <div>
        <label for="from-name">From name</label>
        <input id="from-name" placeholder="HD HeeD">
      </div>
      <div>
        <label for="initials">Your initials</label>
        <input id="initials" placeholder="HS">
      </div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div>
        <label for="locale">Locale</label>
        <select id="locale"><option value="en-AU">English (AU)</option><option value="en-US">English (US)</option></select>
      </div>
      <div>
        <label for="rate-limit">Popups per click (batch)</label>
        <input id="rate-limit" type="number" min="1" max="10" value="5">
      </div>
      <div>
        <label for="theme">Theme</label>
        <select id="theme"><option value="light">Light</option><option value="dark">Dark</option><option value="contrast">High Contrast</option><option value="ocean">Ocean</option><option value="sunset">Sunset</option><option value="forest">Forest</option></select>
      </div>
    </div>
  </section>

  <main id="main">
    <div class="grid" style="margin-top:16px">
      <!-- Templates -->
      <section class="card" id="templates-card">
        <div class="row" style="display:flex;align-items:center;gap:8px">
          <h2>Templates</h2>
          <span class="pill" id="pill-len">7 steps</span>
          <span class="small muted" style="margin-left:auto">Placeholders: {{Name}} {{Company}} {{Phone}} • Variant A/B</span>
        </div>
        <div class="hr"></div>
        <div id="tpl-box" aria-live="polite"></div>
        <div class="row" style="display:flex;gap:8px;margin-top:8px">
          <button id="btn-add-template" class="btn">+ Add Step</button>
          <button id="btn-remove-template" class="btn warn">– Remove Last</button>
          <span style="flex:1"></span>
          <button id="save-templates" class="btn primary">Save Templates</button>
        </div>
      </section>

      <!-- Contacts -->
      <section class="card" aria-labelledby="contacts-h">
        <div class="row" style="display:flex;align-items:center;gap:8px">
          <h2 id="contacts-h">Contacts</h2>
          <span style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
            <input id="search" placeholder="Search name/email/company… ( / )" aria-label="Search contacts">
            <select id="filter-status" aria-label="Filter status">
              <option value="">All</option><option value="Active">Active</option><option value="Paused">Paused</option><option value="Completed">Completed</option>
            </select>
            <select id="sort-key" aria-label="Sort by">
              <option value="name">Name</option><option value="email">Email</option><option value="status">Status</option><option value="last">Last Sent</option><option value="next">Next Step</option><option value="progress">Progress</option>
            </select>
            <button id="add-contact" class="btn ok">Add</button>
          </span>
        </div>
        <div class="hr"></div>
        <div class="grid-3" role="group" aria-label="Quick stats">
          <div class="pill">Due Today: <span id="due-count">0</span></div>
          <div class="pill">Completed: <span id="completed-count">0</span></div>
          <div class="pill">Active: <span id="active-count">0</span></div>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:6px;display:flex;gap:8px">
          <button id="view-due" class="btn ghost">Show Due</button>
          <button id="batch-send" class="btn primary">Batch Prepare</button>
          <button id="export-ics" class="btn">Export ICS</button>
          <button id="load-sample" class="btn">Load Sample 9 (placeholder)</button>
        </div>

        <table id="tbl" style="margin-top:10px" aria-describedby="tbl-help">
          <thead>
            <tr>
              <th data-sort="name">Contact</th>
              <th data-sort="email">Email</th>
              <th data-sort="status">Status</th>
              <th data-sort="last">Last Sent</th>
              <th data-sort="next">Next (step / due)</th>
              <th data-sort="progress">Progress</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
        <p id="tbl-help" class="small muted">Tips: <kbd>/</kbd> search • <kbd>n</kbd> new contact • <kbd>Ctrl/⌘+Z</kbd> undo</p>

        <template id="row-tpl">
          <tr data-id="">
            <td>
              <div style="display:flex;gap:6px;align-items:center">
                <strong class="c-name"></strong>
                <span class="tag small c-seg">—</span>
              </div>
              <div class="small muted c-company"></div>
              <div class="small">
                <button class="btn btn-notes">Notes</button>
                <span class="small muted">(<span class="notes-count">0</span>)</span>
              </div>
            </td>
            <td class="c-email mono"></td>
            <td><span class="tag c-status">Active</span></td>
            <td class="c-last mono small">—</td>
            <td>
              <div class="c-next mono small">Email 1</div>
              <div class="small muted c-due">—</div>
            </td>
            <td style="min-width:160px">
              <div class="progress"><span class="c-prog" style="width:0%"></span></div>
              <div class="small muted c-prog-label"></div>
            </td>
            <td>
              <div class="toolbar" style="display:flex;gap:6px;flex-wrap:wrap">
                <button class="btn btn-preview">Preview</button>
                <button class="btn primary btn-send">Send Next</button>
                <button class="btn ok btn-mark">Mark Sent</button>
                <button class="btn danger btn-del">Delete</button>
              </div>
            </td>
          </tr>
        </template>
      </section>
    </div>

    <!-- Preview -->
    <section class="card" id="preview" style="display:none;margin-top:16px" role="dialog" aria-modal="true">
      <div class="row" style="display:flex;align-items:center">
        <h2>Next Email Preview</h2>
        <span style="margin-left:auto"><button id="pv-close" class="btn">Close</button></span>
      </div>
      <div class="hr"></div>
      <div class="grid-3">
        <div><label>Subject</label><input id="pv-subj" readonly></div>
        <div><label>To</label><input id="pv-to" readonly></div>
        <div><label>Variant</label><input id="pv-variant" readonly></div>
      </div>
      <div style="margin-top:8px">
        <div class="rte-toolbar">
          <button data-cmd="bold" class="btn ghost">Bold</button>
          <button data-cmd="italic" class="btn ghost">Italic</button>
          <button data-cmd="insertUnorderedList" class="btn ghost">• List</button>
          <button id="pv-copy" class="btn">Copy</button>
        </div>
        <div id="pv-body" class="rte" contenteditable="true" aria-label="Editable email body"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="pv-send" class="btn ok">Send Next (Zoho)</button>
        <button id="pv-restore" class="btn">Restore Template</button>
      </div>
    </section>

    <!-- Editor -->
    <section class="card" id="editor" style="display:none;margin-top:16px" role="dialog" aria-modal="true">
      <div class="row">
        <h2 id="ed-h">Add Contact</h2>
        <span style="margin-left:auto"><button id="ed-cancel" class="btn">Cancel</button></span>
      </div>
      <div class="hr"></div>
      <div class="grid-3">
        <div><label>Name</label><input id="ed-name"></div>
        <div><label>Email</label><input id="ed-email"></div>
        <div><label>Company</label><input id="ed-company"></div>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <div><label>Phone</label><input id="ed-phone" placeholder="+61 …"></div>
        <div><label>Timezone (IANA)</label><input id="ed-tz" placeholder="Australia/Sydney"></div>
        <div><label>Segments (comma)</label><input id="ed-seg" placeholder="NDIS, RN, Western Sydney"></div>
      </div>
      <div class="row" style="margin-top:8px;display:flex;gap:8px">
        <div style="flex:1"><label>Initials</label><input id="ed-initials" placeholder="HS"></div>
        <button id="ed-save" class="btn primary">Save</button>
      </div>
    </section>

    <!-- Notes -->
    <section class="card" id="notes" style="display:none;margin-top:16px" role="dialog" aria-modal="true">
      <div class="row">
        <h2>Notes — <span id="notes-for">Contact</span></h2>
        <span style="margin-left:auto"><button id="notes-close" class="btn">Close</button></span>
      </div>
      <div class="hr"></div>
      <div id="notes-list"></div>
      <div class="row" style="margin-top:8px;display:flex;gap:8px">
        <input id="note-text" placeholder="Add note (e.g., ‘HS sent Email 1 — no reply’)">
        <button id="note-add" class="btn primary">Add Note</button>
      </div>
    </section>

    <!-- Analytics -->
    <section class="card" id="analytics" style="margin-top:16px">
      <div class="row"><h2>Analytics</h2></div>
      <div class="hr"></div>
      <div class="grid-3">
        <div><strong>Completion</strong><div id="an-complete" class="small muted">—</div></div>
        <div><strong>Avg Step</strong><div id="an-avgstep" class="small muted">—</div></div>
        <div><strong>Notes (total)</strong><div id="an-notes" class="small muted">—</div></div>
      </div>
    </section>
  </main>
</div>

<div class="toast" id="toast"></div>
<div class="modal-backdrop" id="backdrop" aria-hidden="true"><div class="modal" id="modal"></div></div>
<script>
(() => {
"use strict";

/* Utils */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const rid = ()=>Math.random().toString(36).slice(2,10);
const nowISO = ()=>new Date().toISOString();
const fmt = (d,loc)=> d? new Date(d).toLocaleString(loc||"en-AU"): "—";
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
const esc = (s="")=>s.replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
const clone = (x)=>JSON.parse(JSON.stringify(x));
const toast = (msg)=>{const t=$("#toast");const d=document.createElement("div");d.className="item";d.textContent=msg;t.appendChild(d);setTimeout(()=>d.remove(),2400);};
const lsGet = (k,d)=>{try{return JSON.parse(localStorage.getItem(k)) ?? d;}catch{return d;}};
const lsSet = (k,v)=>localStorage.setItem(k, JSON.stringify(v));

/* Persistence keys */
const LS = {
  contacts: "heed_contacts_v5",
  templates: "heed_templates_v5",
  settings: "heed_settings_v5",
  audit:    "heed_audit_v2",
  history:  "heed_history_v2"
};

/* Models */
class Contact {
  constructor({id=rid(), name="", email="", company="", phone="", tz="Australia/Sydney", segments=[], status="Active", lastSent=0, lastSentAt="", notes=[]}={}) {
    Object.assign(this, {id, name, email, company, phone, tz, segments, status, lastSent, lastSentAt, notes});
  }
}
class TemplateStep {
  constructor({id=rid(), step=1, active=true, subject="", body="", variantB=null}={}) {
    Object.assign(this, {id, step, active, subject, body, variantB});
  }
}
class Settings {
  constructor(o={}) {
    this.seqLen = o.seqLen ?? 7;
    this.defaultGap = o.defaultGap ?? 3;
    this.zohoDomain = o.zohoDomain ?? "mail.zoho.com";
    this.fromName = o.fromName ?? "HD HeeD";
    this.initials = o.initials ?? "HS";
    this.businessTime = o.businessTime ?? "09:00";
    this.sortKey = o.sortKey ?? "name";
    this.sortDir = o.sortDir ?? 1;
    this.locale = o.locale ?? "en-AU";
    this.rate = o.rate ?? 5;
    this.theme = o.theme ?? "light";
  }
}

/* State */
const state = {
  contacts: lsGet(LS.contacts, []),
  templates: lsGet(LS.templates, null),
  settings: new Settings(lsGet(LS.settings, {})),
  filter: "", filterStatus: ""
};

/* Undo snapshots */
function snapshot(){
  const hist = lsGet(LS.history, []);
  hist.push({at: nowISO(), contacts: state.contacts, templates: state.templates, settings: state.settings});
  if(hist.length>40) hist.shift();
  lsSet(LS.history, hist);
}
function undo(){
  const hist = lsGet(LS.history, []);
  if(hist.length<2) return toast("Nothing to undo");
  hist.pop(); const prev = hist.pop();
  state.contacts = prev.contacts; state.templates = prev.templates; state.settings = prev.settings;
  lsSet(LS.contacts,state.contacts); lsSet(LS.templates,state.templates); lsSet(LS.settings,state.settings);
  location.reload();
}

/* YOUR EMAILS: pulled from /emails.html (steps 1–4) */
const EMAILS14 = [
  {
    step:1,
    subject:"Introduction to HD HeeD",
    body:`Hi {{Name}},

Please let me introduce HD HeeD Pty Ltd, an NDIS-registered provider based in Blacktown. We are an RN-led team, with the skills and systems to deliver safe, professional, and person-centred supports.

We are registered under the following NDIS groups:
• 0104 – High Intensity Daily Personal Activities
• 0107 – Daily Personal Activities
• 0115 – Assistance with Daily Life Tasks in a Group/Shared Living
• 0117 – Development of Daily Living and Life Skills
• 0120 – Household Tasks
• 0125 – Participation in Community, Social and Civic Activities
• 0136 – Group and Centre-Based Activities

At HD HeeD, we keep onboarding simple and organised:
• Website: https://www.hdheed.com.au
• Talk to our AI assistant Ella
• Online referral form: https://www.hdheed.com.au/referral.html
• Or reply to this email / info@hdheed.com.au / ndis@hdheed.com.au

Start a referral today: https://www.hdheed.com.au/referral.html

Kind regards,
Mat Syan
Director – HD HeeD Pty Ltd
02 8630 5500 | info@hdheed.com.au`
  },
  {
    step:2,
    subject:"Our RN-Led Strength",
    body:`Hi {{Name}},

At HD HeeD, we are a group of Registered Nurses confident in our skills and experience. This lets us provide the highest standard of care, especially for complex health needs, under registration group 0104 – High Intensity Daily Personal Activities.

This keeps services clinically safe and professional, and more cost-effective than group 0114 (Community Nursing). Your participants get RN-level support within the right NDIS group — quality and value.

Start a referral: https://www.hdheed.com.au/referral.html

A paper referral form is also available — email it to info@hdheed.com.au if preferred.
You can call us on 02 8630 5500 anytime.

Kind regards,
Mat Syan
Director – HD HeeD Pty Ltd
02 8630 5500 | info@hdheed.com.au`
  },
  {
    step:3,
    subject:"AILR System",
    body:`Hi {{Name}},

One of our key strengths is AILR — Advanced Intake & Long-form Registration. Most onboarding is completed online, with only a few signature forms returned via email. It’s:
• Systematic and organised
• Less paperwork
• Straightforward and time-saving

See AILR: https://www.hdheed.com.au/ailr.html
Quick referral: https://www.hdheed.com.au/referral.html
Paper referral: info@hdheed.com.au
Phone: 02 8630 5500

Kind regards,
Mat Syan
Director – HD HeeD Pty Ltd
02 8630 5500 | info@hdheed.com.au`
  },
  {
    step:4,
    subject:"Easy Online Referrals",
    body:`Hi {{Name}},

Save time with our quick online referral system: https://www.hdheed.com.au/referral.html
It’s streamlined, convenient, and audit-ready.

Prefer paper? Complete the form and email it to info@hdheed.com.au.
Either way, we’ll onboard quickly and professionally.

Kind regards,
Mat Syan
Director – HD HeeD Pty Ltd
02 8630 5500 | info@hdheed.com.au`
  }
]; /* Source: HD HeeD – Outreach Emails (1–4). :contentReference[oaicite:1]{index=1} */

/* Default templates 1–N */
function ensureTemplates(){
  if(!state.templates){
    const out = [];
    const N = state.settings.seqLen || 7;
    for(let i=1;i<=N;i++){
      const fromSite = EMAILS14.find(x=>x.step===i);
      out.push(new TemplateStep({
        step:i, active:true,
        subject: fromSite? fromSite.subject : `Email ${i}`,
        body: fromSite? fromSite.body : `Hi {{Name}},\n\n...\n\nTeam HD HeeD`
      }));
    }
    state.templates = out;
    lsSet(LS.templates, state.templates);
  }
}

/* Theme & settings binds */
function applyTheme(t){ document.documentElement.setAttribute("data-theme", t); }
function bindSettings(){
  $("#seq-len").value = String(state.settings.seqLen);
  $("#default-gap").value = String(state.settings.defaultGap);
  $("#target-time").value = state.settings.businessTime;
  $("#zoho-domain").value = state.settings.zohoDomain;
  $("#from-name").value = state.settings.fromName;
  $("#initials").value = state.settings.initials;
  $("#theme").value = state.settings.theme;
  $("#locale").value = state.settings.locale;
  $("#rate-limit").value = String(state.settings.rate);

  $("#theme-toggle").onclick = ()=>{
    const seq = ["light","dark","contrast","ocean","sunset","forest"];
    const idx = seq.indexOf(state.settings.theme);
    state.settings.theme = seq[(idx+1)%seq.length];
    $("#theme").value = state.settings.theme; lsSet(LS.settings, state.settings); applyTheme(state.settings.theme);
  };

  $("#theme").onchange = e=>{ state.settings.theme = e.target.value; lsSet(LS.settings, state.settings); applyTheme(state.settings.theme); };
  $("#seq-len").onchange = e=>{
    snapshot();
    const n = clamp(parseInt(e.target.value,10)||7,7,10);
    state.settings.seqLen = n;
    if(state.templates.length < n){
      for(let s=state.templates.length+1; s<=n; s++){
        state.templates.push(new TemplateStep({step:s,active:true,subject:`Email ${s}`,body:`Hi {{Name}},\n\n...\n\nTeam HD HeeD`}));
      }
    }else if(state.templates.length>n){
      state.templates = state.templates.slice(0,n);
    }
    lsSet(LS.settings, state.settings); lsSet(LS.templates, state.templates);
    renderTemplates(); bindRTE();
  };
  $("#default-gap").onchange = e=>{ state.settings.defaultGap = clamp(parseInt(e.target.value,10)||3,1,30); lsSet(LS.settings, state.settings); };
  $("#target-time").onchange = e=>{ state.settings.businessTime = e.target.value||"09:00"; lsSet(LS.settings, state.settings); };
  $("#zoho-domain").onchange = e=>{ state.settings.zohoDomain = e.target.value; lsSet(LS.settings, state.settings); };
  $("#from-name").onchange = e=>{ state.settings.fromName = e.target.value.trim()||"HD HeeD"; lsSet(LS.settings, state.settings); };
  $("#initials").onchange = e=>{ state.settings.initials = e.target.value.trim()||"HS"; lsSet(LS.settings, state.settings); };
  $("#locale").onchange = e=>{ state.settings.locale = e.target.value; lsSet(LS.settings, state.settings); renderContacts(); };
  $("#rate-limit").onchange = e=>{ state.settings.rate = clamp(parseInt(e.target.value,10)||5,1,10); lsSet(LS.settings, state.settings); };
}

/* Templates UI (rich text editor) */
function renderTemplates(){
  const box = $("#tpl-box"); box.innerHTML = "";
  clone(state.templates).sort((a,b)=>a.step-b.step).forEach(t=>{
    const div = document.createElement("div"); div.className="card"; div.style.margin="8px 0";
    div.innerHTML = `
      <div class="row" style="display:flex;gap:8px;align-items:center">
        <strong>Step ${t.step}</strong>
        <label style="margin-left:auto" class="small"><input type="checkbox" data-id="${t.id}" data-k="active" ${t.active!==false?"checked":""}> Active</label>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <div><label>Subject (A)</label><input data-id="${t.id}" data-k="subject" value="${esc(t.subject||"")}"></div>
        <div><label>Subject (B)</label><input data-id="${t.id}" data-k="subjectB" value="${esc(t.variantB?.subject||"")}"></div>
        <div><label>Step</label><input value="${t.step}" readonly class="mono"></div>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <div><label>Body (A)</label><div class="rte" data-id="${t.id}" data-k="body" contenteditable="true">${esc(t.body||"")}</div></div>
        <div><label>Body (B)</label><div class="rte" data-id="${t.id}" data-k="bodyB" contenteditable="true">${esc(t.variantB?.body||"")}</div></div>
        <div>
          <label>Merge fields</label>
          <div class="small muted">Use {{Name}} {{Company}} {{Phone}}</div>
          <div class="rte-toolbar">
            <button data-insert="{{Name}}" class="btn ghost">+ Name</button>
            <button data-insert="{{Company}}" class="btn ghost">+ Company</button>
            <button data-insert="{{Phone}}" class="btn ghost">+ Phone</button>
          </div>
        </div>
      </div>`;
    box.appendChild(div);
  });
  $("#pill-len").textContent = `${state.settings.seqLen} steps`;
}
function saveTemplatesFromUI(){
  snapshot();
  const map = Object.fromEntries(state.templates.map(t=>[t.id,t]));
  $$("#tpl-box [data-id]").forEach(el=>{
    const id = el.dataset.id, k = el.dataset.k, T = map[id]; if(!T) return;
    if(el.tagName==="INPUT" && el.type==="checkbox"){ T.active = el.checked; }
    else if(el.tagName==="INPUT"){ if(k==="subject") T.subject = el.value; else if(k==="subjectB"){ T.variantB = T.variantB || {subject:"",body:""}; T.variantB.subject = el.value; } }
    else if(el.classList.contains("rte")){
      const v = el.innerText.replace(/\r\n/g,"\n");
      if(k==="body") T.body = v;
      if(k==="bodyB"){ T.variantB = T.variantB||{subject:"",body:""}; T.variantB.body = v; }
    }
  });
  lsSet(LS.templates, state.templates);
  toast("Templates saved.");
}
function insertAtCaret(text){
  const sel = window.getSelection?.(); if(!sel || !sel.rangeCount) return;
  const range = sel.getRangeAt(0); range.deleteContents(); range.insertNode(document.createTextNode(text)); range.collapse(false);
}
function bindRTE(){
  $$("#preview .rte-toolbar [data-cmd]").forEach(b=> b.onclick = ()=>document.execCommand(b.dataset.cmd,false));
  $$("#tpl-box [data-insert]").forEach(b=> b.onclick = ()=>insertAtCaret(b.dataset.insert));
}

/* Init (Part 2) */
function init2(){
  ensureTemplates(); renderTemplates(); bindRTE(); bindSettings(); applyTheme(state.settings.theme);
  document.addEventListener("keydown",(e)=>{
    if(e.key==="/"){ e.preventDefault(); $("#search").focus(); }
    if(e.key.toLowerCase()==="n"){ const openEditor = window.__heed_openEditor; openEditor && openEditor(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="z"){ e.preventDefault(); undo(); }
  });
  $("#save-templates").onclick = saveTemplatesFromUI;
}
window.__heed_init_part2 = init2;
})();
</script>
<!-- PART 3 / 4 — UPDATED: Pipeline, Preview/Send (Zoho), Notes, Import/Export, Analytics, ICS + PRELOADED 9 CONTACTS -->
<script>
(() => {
"use strict";

/* ===== Utilities ===== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const rid = ()=>Math.random().toString(36).slice(2,10);
const nowISO = ()=>new Date().toISOString();
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
const esc = (s="")=>s.replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
const lsGet = (k,d)=>{try{return JSON.parse(localStorage.getItem(k)) ?? d;}catch{return d;}};
const lsSet = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
const fmt = (d,loc)=> d? new Date(d).toLocaleString(loc||"en-AU"): "—";
const toast = (msg)=>{const t=$("#toast");const d=document.createElement("div");d.className="item";d.textContent=msg;t.appendChild(d);setTimeout(()=>d.remove(),2400);};

/* ===== Link to Part 2 state keys ===== */
const ST = { contacts:"heed_contacts_v5", templates:"heed_templates_v5", settings:"heed_settings_v5" };
const state = {
  get contacts(){return lsGet(ST.contacts,[])}, set contacts(v){lsSet(ST.contacts,v)},
  get templates(){return lsGet(ST.templates,[])}, set templates(v){lsSet(ST.templates,v)},
  get settings(){return lsGet(ST.settings,{})}, set settings(v){lsSet(ST.settings,v)}
};

/* ===== PRELOAD your 9 contacts from the board (only if none exist in localStorage) =====
   Dates normalised to 2025-09-15 (Sydney) where the board showed 15/09; one typo “1993” treated as 2025-09-15.
   Status left as Active unless sequence completed by last step.
*/
const PRELOAD_9 = [
  {
    id: crypto.randomUUID?.() || rid(),
    name: "Taylor McGuiness — Interaction",
    company: "Interaction",
    email: "info@interactionservices.org",
    phone: "1300 668 123",
    tz: "Australia/Sydney",
    segments: ["SC/PM"],
    status: "Active",
    lastSent: 2,
    lastSentAt: "2025-09-15T00:00:00+10:00",
    notes: [
      { at: "2025-09-15T00:00:00+10:00", by: "HS", text: "Himmat — Called them, they said send an email." },
      { at: "2025-09-15T00:00:00+10:00", by: "HS", text: "Email 1 sent — awaiting response." },
      { at: "2025-09-15T00:00:00+10:00", by: "HS", text: "Email 2 sent 15/09/25." }
    ]
  },
  {
    id: crypto.randomUUID?.() || rid(),
    name: "Assist Disability Services — SSC",
    company: "Assist Disability Services",
    email: "enquiries@assistservices.com.au",
    phone: "1800 955 806",
    tz: "Australia/Sydney",
    segments: ["SSC"],
    status: "Active",
    lastSent: 2,
    lastSentAt: "2025-09-15T00:00:00+10:00",
    notes: [
      { at: "2025-09-15T00:00:00+10:00", by: "HS", text: "Himmat — Called; they took my number and will call back." },
      { at: "2025-09-15T00:00:00+10:00", by: "HS", text: "Email 2 sent 15/09/2025." }
    ]
  },
  {
    id: crypto.randomUUID?.() || rid(),
    name: "Triniti Care — Support Coord",
    company: "Triniti Care",
    email: "info@triniti.com.au",
    phone: "(02) 8319 9433",
    tz: "Australia/Sydney",
    segments: ["SC"],
    status: "Active",
    lastSent: 1,
    lastSentAt: "2025-09-15T00:00:00+10:00", /* board line had 1993; normalised */
    notes: [
      { at: "2025-09-15T00:00:00+10:00", by: "HS", text: "Himmat — called; they said email info@triniti.com.au." },
      { at: "2025-09-15T00:00:00+10:00", by: "HS", text: "Email 1 sent — undelivered; recheck address." }
    ]
  },
  {
    id: crypto.randomUUID?.() || rid(),
    name: "MD Home Care — SSC",
    company: "MD Home Care",
    email: "", /* not provided on board */
    phone: "08 6386 9999",
    tz: "Australia/Sydney",
    segments: ["SSC"],
    status: "Active",
    lastSent: 0,
    lastSentAt: "",
    notes: [
      { at: "2025-09-15T00:00:00+10:00", by: "HS", text: "No emails sent yet." }
    ]
  },
  {
    id: crypto.randomUUID?.() || rid(),
    name: "Claremont Care — SC/PM",
    company: "Claremont Care",
    email: "", /* not shown on board */
    phone: "0416 873 319",
    tz: "Australia/Sydney",
    segments: ["SC","PM"],
    status: "Active",
    lastSent: 2,
    lastSentAt: "2025-09-15T00:00:00+10:00",
    notes: [
      { at: "2025-09-15T00:00:00+10:00", by: "HS", text: "Email 1 sent — N&J." },
      { at: "2025-09-15T00:00:00+10:00", by: "HS", text: "Email 2 sent 15/09." }
    ]
  },
  {
    id: crypto.randomUUID?.() || rid(),
    name: "BRK Plan Management",
    company: "BRK Plan Management",
    email: "meet@brkpm.com.au",
    phone: "0414 704 279",
    tz: "Australia/Sydney",
    segments: ["PM"],
    status: "Active",
    lastSent: 1,
    lastSentAt: "2025-09-15T00:00:00+10:00",
    notes: [
      { at: "2025-09-15T00:00:00+10:00", by: "HS", text: "Email 1 sent — N&J." }
    ]
  },
  {
    id: crypto.randomUUID?.() || rid(),
    name: "Axial Plan Management",
    company: "Axial Plan Management",
    email: "hello@axialplanmanagement.com.au",
    phone: "0416 428 261",
    tz: "Australia/Sydney",
    segments: ["PM"],
    status: "Active",
    lastSent: 1,
    lastSentAt: "2025-09-15T00:00:00+10:00",
    notes: [
      { at: "2025-09-15T00:00:00+10:00", by: "HS", text: "Himmat — Email 1 sent, awaiting response." }
    ]
  },
  {
    id: crypto.randomUUID?.() || rid(),
    name: "NADO Plan Management",
    company: "NADO Plan Management",
    email: "", /* not provided */
    phone: "1300 738 229",
    tz: "Australia/Sydney",
    segments: ["PM"],
    status: "Active",
    lastSent: 0,
    lastSentAt: "",
    notes: [
      { at: "2025-09-15T00:00:00+10:00", by: "HS", text: "No emails sent yet." }
    ]
  },
  {
    id: crypto.randomUUID?.() || rid(),
    name: "Yahweh Care — PM",
    company: "Yahweh Care",
    email: "info@yahwehcare.com.au",
    phone: "(02) 8325 1616",
    tz: "Australia/Sydney",
    segments: ["PM"],
    status: "Active",
    lastSent: 1,
    lastSentAt: "2025-09-15T00:00:00+10:00",
    notes: [
      { at: "2025-09-15T00:00:00+10:00", by: "HS", text: "Himmat — Email 1 sent, awaiting response." }
    ]
  }
];

/* One-time preload if empty */
function ensurePreload(){
  const existing = state.contacts || [];
  if(!existing.length){
    state.contacts = PRELOAD_9;
    toast("Loaded 9 contacts from board.");
  }
}

/* ===== Sequencing ===== */
function nextStepFor(c){
  const N = state.settings.seqLen||7;
  if((c.status||"Active")==="Completed") return 0;
  const last = c.lastSent||0;
  for(let s=last+1; s<=N; s++){
    const t = state.templates.find(x=>x.step===s);
    if(t && t.active!==false) return s;
  }
  return 0;
}
function dueDateFor(c){
  const gap = state.settings.defaultGap||3;
  const [hh,mm] = (state.settings.businessTime||"09:00").split(":").map(x=>parseInt(x,10)||0);
  const d = new Date();
  if(!c.lastSentAt){ d.setHours(hh,mm,0,0); return d; }
  const base = new Date(c.lastSentAt);
  base.setDate(base.getDate()+gap);
  base.setHours(hh,mm,0,0);
  return base;
}
function progressPct(c){
  const N = state.settings.seqLen||7;
  return Math.round((Math.min(c.lastSent||0,N)/N)*100);
}

/* ===== Build Email (merge + A/B) ===== */
function buildEmail(c, step){
  const tpl = state.templates.find(t=>t.step===step);
  const name = c.name || "there", company = c.company||"", phone=c.phone||"";
  let useB = false;
  if(tpl?.variantB && tpl.variantB.subject && tpl.variantB.body){
    const h = [...(c.id||"")].reduce((a,ch)=>a+ch.charCodeAt(0),0);
    useB = (h % 2)===0;
  }
  const sub = (useB ? tpl?.variantB?.subject : tpl?.subject) || "";
  const bod = (useB ? tpl?.variantB?.body : tpl?.body) || "";
  const subject = sub.replaceAll("{{Name}}",name).replaceAll("{{Company}}",company).replaceAll("{{Phone}}",phone);
  const body = bod.replaceAll("{{Name}}",name).replaceAll("{{Company}}",company).replaceAll("{{Phone}}",phone);
  return { subject, body, variant: useB?"B":"A" };
}

/* ===== Render table ===== */
function bySort(key, dir){
  return (a,b)=>{
    const v = (k,o)=>k==="name"?(o.name||"").toLowerCase()
      :k==="email"?(o.email||"").toLowerCase()
      :k==="status"?(o.status||"")
      :k==="last"?(o.lastSentAt||"")
      :k==="next"? nextStepFor(o)||999
      :k==="progress"? ((o.lastSent||0))
      :(o.name||"");
    const va=v(key,a), vb=v(key,b); if(va<vb) return -1*dir; if(va>vb) return 1*dir; return 0;
  };
}
function rowFor(c){
  const tpl = $("#row-tpl").content.cloneNode(true);
  const tr = tpl.querySelector("tr"); tr.dataset.id = c.id;
  tr.querySelector(".c-name").textContent = c.name || "—";
  tr.querySelector(".c-company").textContent = c.company || "";
  tr.querySelector(".c-email").textContent = c.email || "—";
  tr.querySelector(".c-seg").textContent = (c.segments&&c.segments.length)? c.segments.join(", ") : "—";
  const s = c.status||"Active";
  const st = tr.querySelector(".c-status"); st.textContent = s;
  st.className = "tag c-status " + (s==="Paused"?"warn":s==="Completed"?"ok":"");
  tr.querySelector(".c-last").textContent = c.lastSent? `Email ${c.lastSent} @ ${fmt(c.lastSentAt,state.settings.locale)}` : "—";
  const next = nextStepFor(c);
  tr.querySelector(".c-next").textContent = next? `Email ${next}` : "Done";
  tr.querySelector(".c-due").textContent = next? `Due: ${fmt(dueDateFor(c),state.settings.locale)}` : "—";
  const pct = progressPct(c);
  tr.querySelector(".c-prog").style.width = pct+"%";
  tr.querySelector(".c-prog-label").textContent = `${pct}% (${c.lastSent||0}/${state.settings.seqLen||7})`;
  tr.querySelector(".notes-count").textContent = String(c.notes?.length||0);
  tr.querySelector(".btn-notes").onclick = ()=>openNotes(c.id);
  tr.querySelector(".btn-preview").onclick = ()=>openPreview(c.id);
  tr.querySelector(".btn-send").onclick = ()=>sendNext(c.id);
  tr.querySelector(".btn-mark").onclick = ()=>markSent(c.id);
  tr.querySelector(".btn-del").onclick = ()=>delContact(c.id);
  return tr;
}
function renderContacts(){
  const contacts = state.contacts;
  const today = new Date(); today.setHours(23,59,59,999);
  const due = contacts.filter(c=> (c.status||"Active")==="Active" && nextStepFor(c) && dueDateFor(c)<=today );
  const completed = contacts.filter(c=> (c.status||"Active")==="Completed");
  const active = contacts.filter(c=> (c.status||"Active")==="Active");
  $("#due-count").textContent = String(due.length);
  $("#completed-count").textContent = String(completed.length);
  $("#active-count").textContent = String(active.length);
  const f = ($("#search").value||"").toLowerCase();
  const fs = $("#filter-status").value||"";
  const key = $("#sort-key").value || (state.settings.sortKey||"name");
  const dir = state.settings.sortDir||1;
  const rows = contacts
    .filter(c=>{
      if(f){
        const k = `${c.name||""} ${c.email||""} ${c.company||""} ${c.phone||""}`.toLowerCase();
        if(!k.includes(f)) return false;
      }
      if(fs && (c.status||"Active")!==fs) return false;
      return true;
    })
    .sort(bySort(key, dir));
  const tbody = $("#rows"); tbody.innerHTML = "";
  rows.forEach(c=> tbody.appendChild(rowFor(c)));
  renderAnalytics();
}

/* ===== Notes ===== */
let NOTES_ID = "";
function openNotes(id){
  const c = state.contacts.find(x=>x.id===id); if(!c) return;
  NOTES_ID = id;
  $("#notes-for").textContent = c.name || c.email || "Contact";
  const box = $("#notes-list"); box.innerHTML = "";
  (c.notes||[]).forEach(n=>{
    const div = document.createElement("div"); div.style.marginBottom="8px";
    div.innerHTML = `<div class="small muted">${fmt(n.at,state.settings.locale)} — <strong>${esc(n.by||"")}</strong></div><div>${esc(n.text||"")}</div>`;
    box.appendChild(div);
  });
  if(!c.notes?.length) box.innerHTML = `<div class="small muted">No notes yet.</div>`;
  $("#note-text").value = "";
  $("#notes").style.display = "";
}
function addNote(){
  const t = $("#note-text").value.trim(); if(!t) return;
  const cs = state.contacts, i = cs.findIndex(x=>x.id===NOTES_ID); if(i<0) return;
  (cs[i].notes=cs[i].notes||[]).push({ at: nowISO(), by:(state.settings.initials||"User"), text: t });
  state.contacts = cs; openNotes(NOTES_ID);
}

/* ===== Preview / Send (Zoho) ===== */
let PV_ID="";
function openPreview(id){
  const c = state.contacts.find(x=>x.id===id); if(!c) return;
  const step = nextStepFor(c); if(!step) return toast("Sequence complete");
  const {subject, body, variant} = buildEmail(c, step);
  PV_ID = id;
  $("#pv-subj").value = subject||"(no subject)";
  $("#pv-to").value = c.email||"";
  $("#pv-variant").value = variant;
  $("#pv-body").innerText = body||"";
  $("#preview").style.display = "";
}
function sendFromPreview(){ if(PV_ID) sendNext(PV_ID); }
function restoreFromTemplate(){
  if(!PV_ID) return;
  const c = state.contacts.find(x=>x.id===PV_ID); if(!c) return;
  const step = nextStepFor(c); if(!step) return;
  const {body} = buildEmail(c, step);
  $("#pv-body").innerText = body||"";
}
function sendNext(id){
  const c = state.contacts.find(x=>x.id===id); if(!c) return;
  if(!(c.email||"").trim()){ toast("No email address on file for this contact."); return; }
  const step = nextStepFor(c); if(!step) return toast("Sequence complete");
  const subj = $("#pv-subj").value || buildEmail(c, step).subject;
  const body = ($("#pv-body").innerText||"").trim() || buildEmail(c, step).body;
  const allowed = Number(state.settings.rate||5);
  window.__rateCounter = (window.__rateCounter||0) + 1;
  if(window.__rateCounter>allowed){ toast(`Popup limit reached (${allowed})`); return; }
  setTimeout(()=>{ window.__rateCounter = Math.max(0,(window.__rateCounter||1)-1); }, 2000);
  const dom = state.settings.zohoDomain||"mail.zoho.com";
  const url = `https://${dom}/zm/#compose?to=${encodeURIComponent(c.email||"")}&subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
  window.open(url, "_blank");
}

/* ===== Mark / Delete / Editor ===== */
function markSent(id){
  const cs = state.contacts, i = cs.findIndex(x=>x.id===id); if(i<0) return;
  const step = nextStepFor(cs[i]); if(!step) return toast("Sequence complete");
  cs[i].lastSent = step; cs[i].lastSentAt = nowISO();
  if(step >= (state.settings.seqLen||7)) cs[i].status = "Completed";
  (cs[i].notes=cs[i].notes||[]).push({at: nowISO(), by:(state.settings.initials||"User"), text:`Marked Email ${step} as sent.`});
  state.contacts = cs; renderContacts();
}
function delContact(id){
  if(!confirm("Delete this contact?")) return;
  state.contacts = state.contacts.filter(x=>x.id!==id); renderContacts();
}
function openEditor(contact){
  $("#editor").style.display = "";
  $("#ed-h").textContent = contact? "Edit Contact":"Add Contact";
  $("#ed-name").value = contact?.name || "";
  $("#ed-email").value = contact?.email || "";
  $("#ed-company").value = contact?.company || "";
  $("#ed-phone").value = contact?.phone || "";
  $("#ed-tz").value = contact?.tz || "Australia/Sydney";
  $("#ed-seg").value = (contact?.segments||[]).join(", ");
  $("#ed-initials").value = state.settings.initials || "HS";
  $("#editor").dataset.id = contact?.id || "";
}
function saveContact(){
  const id = $("#editor").dataset.id || "";
  const obj = {
    id: id || rid(),
    name: $("#ed-name").value.trim(),
    email: $("#ed-email").value.trim(),
    company: $("#ed-company").value.trim(),
    phone: $("#ed-phone").value.trim(),
    tz: $("#ed-tz").value.trim()||"Australia/Sydney",
    segments: ($("#ed-seg").value||"").split(",").map(s=>s.trim()).filter(Boolean)
  };
  const cs = state.contacts;
  if(id){ const i = cs.findIndex(x=>x.id===id); if(i>=0) cs[i] = {...cs[i], ...obj}; }
  else cs.push({ ...obj, status:"Active", lastSent:0, lastSentAt:"", notes:[] });
  state.contacts = cs; $("#editor").style.display="none"; renderContacts();
}
window.__heed_openEditor = ()=>openEditor();

/* ===== Import/Export ===== */
function exportJSON(){
  const blob = new Blob([JSON.stringify({contacts:state.contacts,templates:state.templates,settings:state.settings},null,2)],{type:"application/json"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
  a.download = `heed-followups-${new Date().toISOString().slice(0,10)}.json`; a.click();
}
async function importJSONFile(file){
  const text = await file.text(); const data = JSON.parse(text);
  if(!confirm("Import will overwrite local data. Continue?")) return;
  if(data.contacts) state.contacts = data.contacts;
  if(data.templates) state.templates = data.templates;
  if(data.settings) state.settings = {...state.settings, ...data.settings};
  location.reload();
}
function exportCSV(){
  const headers = ["id","name","email","company","phone","tz","segments","status","lastSent","lastSentAt","notesCount"];
  const rows = state.contacts.map(c=>[
    c.id, q(c.name), q(c.email), q(c.company), q(c.phone), q(c.tz), q((c.segments||[]).join("|")),
    c.status||"Active", c.lastSent||0, c.lastSentAt||"", (c.notes||[]).length
  ]);
  const csv = [headers.join(","), ...rows.map(r=>r.join(","))].join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
  a.download = `heed-contacts-${new Date().toISOString().slice(0,10)}.csv`; a.click();
  function q(s){ const t=(s??"").toString().replace(/"/g,'""'); return `"${t}"`; }
}
async function importCSVFile(file){
  const text = await file.text();
  const lines = text.split(/\r?\n/).filter(Boolean);
  if(lines.length<2) return alert("CSV has no data");
  const hdr = lines[0].split(",").map(h=>h.trim());
  const rows = lines.slice(1).map(line=>{
    const out=[]; let cur="",inq=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"' && line[i+1]==='"'){ cur+='"'; i++; continue; }
      if(ch==='"'){ inq=!inq; continue; }
      if(ch===',' && !inq){ out.push(cur); cur=""; continue; }
      cur+=ch;
    } out.push(cur); return out;
  });
  const cs = state.contacts;
  rows.forEach(r=>{
    const obj = Object.fromEntries(hdr.map((h,i)=>[h, r[i]??""]));
    const id = obj.id || rid();
    const idx = obj.email? cs.findIndex(x=>x.email===obj.email) : -1;
    const c = { id,
      name: obj.name||"", email: obj.email||"", company: obj.company||"", phone: obj.phone||"",
      tz: obj.tz||"Australia/Sydney", segments: (obj.segments||"").split("|").filter(Boolean),
      status: obj.status||"Active", lastSent: Number(obj.lastSent||0), lastSentAt: obj.lastSentAt||"", notes: []
    };
    if(idx>=0) cs[idx] = {...cs[idx], ...c}; else cs.push(c);
  });
  state.contacts = cs; renderContacts();
}

/* ===== Analytics + ICS ===== */
function renderAnalytics(){
  const cs = state.contacts; const N = state.settings.seqLen||7;
  if(!cs.length){ $("#an-complete").textContent="—"; $("#an-avgstep").textContent="—"; $("#an-notes").textContent="—"; return; }
  const completed = cs.filter(c=>c.status==="Completed").length;
  const avgStep = cs.reduce((a,c)=>a+(c.lastSent||0),0)/cs.length;
  const notes = cs.reduce((a,c)=>a+(c.notes?.length||0),0);
  $("#an-complete").textContent = `${Math.round((completed/cs.length)*100)}% (${completed}/${cs.length})`;
  $("#an-avgstep").textContent = `${avgStep.toFixed(2)} / ${N}`;
  $("#an-notes").textContent = String(notes);
}
function exportICS(){
  const today = new Date(); today.setHours(23,59,59,999);
  const due = state.contacts.filter(c=> (c.status||"Active")==="Active" && nextStepFor(c) && dueDateFor(c)<=today );
  if(!due.length){ toast("No contacts due today"); return; }
  const lines = ["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//HD HeeD//Sequencer//EN"];
  due.slice(0,20).forEach(c=>{
    const dt = dueDateFor(c); const pad=n=>String(n).padStart(2,"0");
    const stamp = `${dt.getUTCFullYear()}${pad(dt.getUTCMonth()+1)}${pad(dt.getUTCDate())}T${pad(dt.getUTCHours())}${pad(dt.getUTCMinutes())}00Z`;
    const step = nextStepFor(c); const {subject} = buildEmail(c, step);
    lines.push("BEGIN:VEVENT");
    lines.push(`UID:${c.id}@hdheed`);
    lines.push(`DTSTAMP:${stamp}`);
    lines.push(`DTSTART:${stamp}`);
    lines.push(`SUMMARY:${subject.slice(0,70).replace(/[\\n,;]/g," ")}`);
    lines.push(`DESCRIPTION:${`Prepare and send to ${c.email||'no-email'}`.replace(/[\\n,;]/g," ")}`);
    lines.push("END:VEVENT");
  });
  lines.push("END:VCALENDAR");
  const blob = new Blob([lines.join("\r\n")],{type:"text/calendar"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "hdheed_next_due.ics"; a.click();
}

/* ===== Binds & init ===== */
function init3(){
  ensurePreload();  // <<— load your 9 if empty

  $("#search").oninput = ()=>renderContacts();
  $("#filter-status").onchange = ()=>renderContacts();
  $("#sort-key").onchange = ()=>{ const s=state.settings; s.sortKey=$("#sort-key").value; state.settings=s; renderContacts(); };

  $("#view-due").onclick = ()=>{
    const today = new Date(); today.setHours(23,59,59,999);
    const due = state.contacts.filter(c=> (c.status||"Active")==="Active" && nextStepFor(c) && dueDateFor(c)<=today );
    if(!due.length){ alert("No contacts due today."); return; }
    const msg = due.map(c=>`• ${c.name||c.email||"Contact"} — Next: Email ${nextStepFor(c)} (Due ${fmt(dueDateFor(c),state.settings.locale)})`).join("\n");
    alert(`Due today:\n\n${msg}`);
  };
  $("#batch-send").onclick = ()=>{
    const today = new Date(); today.setHours(23,59,59,999);
    const due = state.contacts.filter(c=> (c.status||"Active")==="Active" && nextStepFor(c) && dueDateFor(c)<=today );
    if(!due.length){ toast("No contacts due today."); return; }
    const dom = state.settings.zohoDomain || "mail.zoho.com";
    let opened=0, allowed=Number(state.settings.rate||5);
    due.slice(0,allowed).forEach(c=>{
      if(!(c.email||"").trim()) return; // skip no-email
      const step = nextStepFor(c);
      const {subject, body} = buildEmail(c, step);
      const url = `https://${dom}/zm/#compose?to=${encodeURIComponent(c.email||"")}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      const win = window.open(url, "_blank"); if(win) opened++;
    });
    toast(`Opened ${opened} Zoho compose tab(s).`);
  };
  $("#export-ics").onclick = exportICS;

  // If your Part 1 still shows the "Load Sample 9" button, hide it (we preload real data now)
  const sampleBtn = $("#load-sample"); if(sampleBtn) sampleBtn.style.display = "none";

  $("#pv-copy").onclick = ()=>navigator.clipboard.writeText($("#pv-body").innerText||"");
  $("#pv-send").onclick = ()=>sendFromPreview();
  $("#pv-restore").onclick = ()=>restoreFromTemplate();
  $("#pv-close").onclick = ()=>{ $("#preview").style.display="none"; };

  $("#add-contact").onclick = ()=>openEditor();
  $("#ed-cancel").onclick = ()=>$("#editor").style.display="none";
  $("#ed-save").onclick = ()=>saveContact();

  $("#note-add").onclick = ()=>addNote();
  $("#notes-close").onclick = ()=>$("#notes").style.display="none";

  $("#export-json").onclick = exportJSON;
  $("#import-json").onchange = e=>{ const f=e.target.files?.[0]; if(f) importJSONFile(f); };
  $("#export-csv").onclick = exportCSV;
  $("#import-csv").onchange = e=>{ const f=e.target.files?.[0]; if(f) importCSVFile(f); };
  $("#reset").onclick = ()=>{ if(confirm("Reset ALL local data?")){ localStorage.removeItem(ST.contacts); localStorage.removeItem(ST.templates); localStorage.removeItem(ST.settings); location.reload(); }};

  document.addEventListener("keydown",(e)=>{
    if(e.key==="/"){ e.preventDefault(); $("#search").focus(); }
    if(e.key.toLowerCase()==="n"){ openEditor(); }
  });

  renderContacts();
}
window.__heed_init_part3 = init3;
})();
</script>
<script>
(() => {
"use strict";

/* Boot */
function boot(){ if(window.__heed_init_part2) window.__heed_init_part2(); if(window.__heed_init_part3) window.__heed_init_part3(); }
document.addEventListener("DOMContentLoaded", boot);

/* SW (installable offline) */
if('serviceWorker' in navigator){
  try{
    const sw = `
      const CACHE='heed-v2';
      self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./followup.html'])));});
      self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));});
    `;
    const blob = new Blob([sw],{type:'text/javascript'});
    const url = URL.createObjectURL(blob);
    navigator.serviceWorker.register(url);
  }catch(e){}
}

/* Modal help */
const modal = $("#modal"), backdrop = $("#backdrop");
function openModal(html){
  modal.innerHTML = html + `<div class="row" style="margin-top:12px;justify-content:flex-end"><button id="m-close" class="btn">Close</button></div>`;
  backdrop.style.display = "flex"; backdrop.setAttribute("aria-hidden","false");
  $("#m-close").onclick = closeModal;
}
function closeModal(){ backdrop.style.display="none"; backdrop.setAttribute("aria-hidden","true"); }

/* Quick help */
function helpHTML(){
  return `
  <h3>Quick help</h3>
  <ul class="small">
    <li><strong>Templates:</strong> Steps 1–4 preloaded from your site. Edit or extend to 7–10.</li>
    <li><strong>Contacts:</strong> Add manually or <em>Import CSV</em>. Status auto-updates on <em>Mark Sent</em>.</li>
    <li><strong>Zoho:</strong> <em>Send Next</em> opens compose with To/Subject/Body prefilled.</li>
    <li><strong>Analytics:</strong> Completion %, average step, notes total.</li>
    <li><strong>Backups:</strong> Export/Import JSON; CSV for spreadsheets.</li>
    <li><strong>Keyboard:</strong> <kbd>/</kbd> search, <kbd>N</kbd> new contact, <kbd>Ctrl/⌘+Z</kbd> undo.</li>
  </ul>`;
}
document.querySelector(".title")?.addEventListener("click",()=>openModal(helpHTML()));

})();
</script>

<!-- Footer -->
<div class="wrap" style="margin:18px auto 40px">
  <section class="card">
    <h2>How to Use</h2>
    <div class="hr"></div>
    <ol class="small" style="line-height:1.6">
      <li><strong>Set sequence length:</strong> Choose 7–10 and edit subjects/bodies (use {{Name}} / {{Company}} / {{Phone}}). Save.</li>
      <li><strong>Add contacts:</strong> Or import CSV (columns accepted: name,email,company,phone,tz,segments,status,lastSent,lastSentAt).</li>
      <li><strong>Send next:</strong> Click <em>Send Next</em> — compose opens in Zoho. Then <em>Mark Sent</em>.</li>
      <li><strong>Due tools:</strong> <em>Show Due</em>, <em>Batch Prepare</em>, <em>Export ICS</em>.</li>
      <li><strong>Offline:</strong> This page installs as a PWA; works offline after first load.</li>
    </ol>
    <div class="small muted">Want me to preload your **exact 9 contacts**? Share the CSV or a read-only Sheet link and I’ll embed them.</div>
  </section>
  <footer class="small muted" style="text-align:center;margin:24px 0 0">
    HD HeeD • “Because we care, we provide HD care.” • v1.2 (visual + automation)
  </footer>
</div>

</body>
</html>
