<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HD HeeD — Follow-Up Sequencer</title>
  <meta name="theme-color" content="#0b1226" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --font: Inter, system-ui, Segoe UI, Arial, sans-serif;
      --ink:#0f1224; --bg:#080c1a; --wash:#0d1330; --card:rgba(255,255,255,.08);
      --muted:#a7b0c7; --line:rgba(255,255,255,.14);
      --brand:#7b6dff; --brand2:#ff6fb1; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --info:#38bdf8;
      --radius:16px; --shadow:0 14px 44px rgba(0,0,0,.35); --glass: blur(12px) saturate(140%);
    }
    :root[data-theme="light"]{
      --ink:#0b1226; --bg:#f6f7fb; --wash:#e9ecf7; --card:rgba(255,255,255,.9);
      --muted:#667085; --line:#e7e9f2; --shadow: 0 12px 36px rgba(12,18,40,.12);
    }
    body{
      margin:0; font-family:var(--font); color:var(--ink);
      background:
        radial-gradient(1100px 600px at -10% -10%, rgba(124,108,255,.18), transparent 60%),
        radial-gradient(1000px 600px at 110% 10%, rgba(255,111,177,.16), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--wash));
    }
    .wrap{max-width:1288px;margin:22px auto;padding:0 18px}
    .card{background:var(--card); backdrop-filter:var(--glass); border:1px solid var(--line);
      border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:48px;height:48px;border-radius:14px;
      background:conic-gradient(from 180deg,var(--brand),var(--brand2)); animation:float 6s ease-in-out infinite}
    .title{font-weight:800;font-size:22px}
    .sub{color:var(--muted);font-size:13px}
    .btn{appearance:none;border:1px solid var(--line);background:transparent;color:var(--ink);
      border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:.15s transform, .15s box-shadow}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;border-color:transparent}
    .btn.ok{background:linear-gradient(90deg,#16a34a,#22c55e);color:#fff;border-color:transparent}
    .btn.warn{background:linear-gradient(90deg,#f59e0b,#facc15);color:#111;border-color:transparent}
    .btn.danger{background:linear-gradient(90deg,#ef4444,#f87171);color:#fff;border-color:transparent}
    .btn.ghost{background:transparent}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--ink);font:inherit}
    label{font-size:12px;color:var(--muted);font-weight:700}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;white-space:nowrap;cursor:pointer}
    tr:last-child td{border-bottom:0}
    .small{font-size:12px} .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:16px}
    @media (max-width:1100px){.grid{grid-template-columns:1fr}}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    @media (max-width:1100px){.grid-3{grid-template-columns:1fr}}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(124,108,255,.18);color:#fff;font-size:12px;font-weight:800}
    .tag{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.12);color:var(--ink)}
    .tag.ok{background:rgba(34,197,94,.15);border-color:rgba(34,197,94,.35)}
    .tag.warn{background:rgba(250,204,21,.15);border-color:rgba(250,204,21,.35)}
    .progress{height:8px;border-radius:6px;background:rgba(255,255,255,.12);overflow:hidden}
    .progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2))}
    .rte{border:1px solid var(--line);border-radius:10px;background:rgba(255,255,255,.08);color:var(--ink);padding:10px;min-height:130px}
    .rte-toolbar{display:flex;gap:6px;margin:6px 0}
    .toast{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:1000}
    .toast .item{background:var(--card);border:1px solid var(--line);border-radius:10px;box-shadow:var(--shadow);padding:10px 12px}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:900}
    .modal{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;max-width:720px;width:min(720px,96vw)}
    @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-3px)}100%{transform:translateY(0)}}
  </style>
</head>
<body>
<a href="#main" style="position:absolute;left:-9999px" onfocus="this.style.left='12px'">Skip to content</a>

<div class="wrap" id="app-root" aria-live="polite">
  <header class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">HD HeeD — Follow-Up Sequencer</div>
        <div class="sub">Superfast daily follow-ups • Zoho 1-click • Offline</div>
      </div>
    </div>
    <div class="toolbar" role="toolbar" aria-label="Global actions">
      <button id="theme-toggle" class="btn">Theme</button>
      <button id="export-json" class="btn">Export JSON</button>
      <label class="btn" for="import-json">Import JSON</label>
      <input id="import-json" type="file" style="position:absolute;left:-9999px" accept="application/json">
      <button id="export-csv" class="btn">Export CSV</button>
      <label class="btn" for="import-csv">Import CSV</label>
      <input id="import-csv" type="file" style="position:absolute;left:-9999px" accept=".csv,text/csv">
      <button id="reset" class="btn danger">Reset</button>
    </div>
  </header>

  <!-- SETTINGS -->
  <section class="card" role="region" aria-labelledby="settings-h">
    <h2 id="settings-h">Settings</h2>
    <div class="hr"></div>
    <div class="grid-3">
      <div>
        <label for="seq-len">Sequence length (7–10)</label>
        <select id="seq-len"><option>7</option><option>8</option><option>9</option><option>10</option></select>
      </div>
      <div>
        <label for="default-gap">Gap between emails (days)</label>
        <input id="default-gap" type="number" min="1" max="30" value="3">
      </div>
      <div>
        <label for="target-time">Target send time (HH:MM)</label>
        <input id="target-time" type="time" value="09:00">
      </div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div>
        <label for="from-name">From name</label>
        <input id="from-name" placeholder="HD HeeD">
      </div>
      <div>
        <label for="initials">Your initials</label>
        <input id="initials" placeholder="HS">
      </div>
      <div>
        <label for="theme">Theme</label>
        <select id="theme">
          <option value="light">Light</option><option value="dark">Dark</option>
          <option value="contrast">High Contrast</option>
        </select>
      </div>
    </div>
  </section>

  <main id="main">
    <div class="grid" style="margin-top:16px">
      <!-- Templates -->
      <section class="card" id="templates-card">
        <div class="row" style="display:flex;align-items:center;gap:8px">
          <h2>Templates</h2>
          <span class="pill" id="pill-len">7 steps</span>
          <span class="small muted" style="margin-left:auto">Placeholders: {{Name}} {{Company}} {{Phone}} • Variant A/B</span>
        </div>
        <div class="hr"></div>
        <div id="tpl-box" aria-live="polite"></div>
        <div class="row" style="display:flex;gap:8px;margin-top:8px">
          <button id="btn-add-template" class="btn">+ Add Step</button>
          <button id="btn-remove-template" class="btn warn">– Remove Last</button>
          <span style="flex:1"></span>
          <button id="save-templates" class="btn primary">Save Templates</button>
        </div>
      </section>

      <!-- Contacts -->
      <section class="card" aria-labelledby="contacts-h">
        <div class="row" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <h2 id="contacts-h" style="margin:0">Contacts</h2>
          <span style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
            <input id="search" placeholder="Search name/email/company… ( / )" aria-label="Search contacts">
            <select id="filter-status" aria-label="Filter status">
              <option value="">All</option><option value="Active">Active</option><option value="Paused">Paused</option><option value="Completed">Completed</option>
            </select>
            <select id="sort-key" aria-label="Sort by">
              <option value="name">Name</option><option value="email">Email</option><option value="status">Status</option><option value="last">Last Sent</option><option value="next">Next Step</option><option value="progress">Progress</option>
            </select>
            <button id="add-contact" class="btn ok">Add</button>
          </span>
        </div>
        <div class="hr"></div>
        <div class="grid-3" role="group" aria-label="Quick stats">
          <div class="pill">Due Today: <span id="due-count">0</span></div>
          <div class="pill">Completed: <span id="completed-count">0</span></div>
          <div class="pill">Active: <span id="active-count">0</span></div>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:6px;display:flex;gap:8px">
          <button id="view-due" class="btn ghost">Show Due</button>
          <button id="batch-send" class="btn primary">Batch Prepare</button>
          <button id="export-ics" class="btn">Export ICS</button>
        </div>

        <table id="tbl" style="margin-top:10px" aria-describedby="tbl-help">
          <thead>
            <tr>
              <th data-sort="name">Contact</th>
              <th data-sort="email">Email</th>
              <th data-sort="status">Status</th>
              <th data-sort="last">Last Sent</th>
              <th data-sort="next">Next (step / due)</th>
              <th data-sort="progress">Progress</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
        <p id="tbl-help" class="small muted">Tips: <kbd>/</kbd> search • <kbd>n</kbd> new contact • <kbd>Ctrl/⌘+Z</kbd> undo</p>

        <template id="row-tpl">
          <tr data-id="">
            <td>
              <div style="display:flex;gap:6px;align-items:center">
                <strong class="c-name"></strong>
                <span class="tag small c-seg">—</span>
              </div>
              <div class="small muted c-company"></div>
              <div class="small">
                <button class="btn btn-notes">Notes</button>
                <span class="small muted">(<span class="notes-count">0</span>)</span>
              </div>
            </td>
            <td class="c-email mono"></td>
            <td><span class="tag c-status">Active</span></td>
            <td class="c-last mono small">—</td>
            <td>
              <div class="c-next mono small">Email 1</div>
              <div class="small muted c-due">—</div>
            </td>
            <td style="min-width:160px">
              <div class="progress"><span class="c-prog" style="width:0%"></span></div>
              <div class="small muted c-prog-label"></div>
            </td>
            <td>
              <div class="toolbar" style="display:flex;gap:6px;flex-wrap:wrap">
                <button class="btn btn-preview">Preview</button>
                <button class="btn primary btn-send">Send Next</button>
                <button class="btn ok btn-mark">Mark Sent</button>
                <button class="btn danger btn-del">Delete</button>
              </div>
            </td>
          </tr>
        </template>
      </section>
    </div>

    <!-- PREVIEW -->
    <section class="card" id="preview" style="display:none;margin-top:16px" role="dialog" aria-modal="true">
      <div class="row" style="display:flex;align-items:center">
        <h2>Next Email Preview</h2>
        <span style="margin-left:auto"><button id="pv-close" class="btn">Close</button></span>
      </div>
      <div class="hr"></div>
      <div class="grid-3">
        <div><label>Subject</label><input id="pv-subj" readonly></div>
        <div><label>To</label><input id="pv-to" readonly></div>
        <div><label>Variant</label><input id="pv-variant" readonly></div>
      </div>
      <div style="margin-top:8px">
        <div class="rte-toolbar">
          <button data-cmd="bold" class="btn ghost">Bold</button>
          <button data-cmd="italic" class="btn ghost">Italic</button>
          <button data-cmd="insertUnorderedList" class="btn ghost">• List</button>
          <button id="pv-copy" class="btn">Copy</button>
        </div>
        <div id="pv-body" class="rte" contenteditable="true" aria-label="Editable email body"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="pv-send" class="btn ok">Send Next (Zoho)</button>
        <button id="pv-restore" class="btn">Restore Template</button>
      </div>
    </section>

    <!-- EDITOR -->
    <section class="card" id="editor" style="display:none;margin-top:16px" role="dialog" aria-modal="true">
      <div class="row">
        <h2 id="ed-h">Add Contact</h2>
        <span style="margin-left:auto"><button id="ed-cancel" class="btn">Cancel</button></span>
      </div>
      <div class="hr"></div>
      <div class="grid-3">
        <div><label>Name</label><input id="ed-name"></div>
        <div><label>Email</label><input id="ed-email"></div>
        <div><label>Company</label><input id="ed-company"></div>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <div><label>Phone</label><input id="ed-phone" placeholder="+61 …"></div>
        <div><label>Timezone (IANA)</label><input id="ed-tz" placeholder="Australia/Sydney"></div>
        <div><label>Segments (comma)</label><input id="ed-seg" placeholder="NDIS, RN, Western Sydney"></div>
      </div>
      <div class="row" style="margin-top:8px;display:flex;gap:8px">
        <div style="flex:1"><label>Initials</label><input id="ed-initials" placeholder="HS"></div>
        <button id="ed-save" class="btn primary">Save</button>
      </div>
    </section>

    <!-- NOTES -->
    <section class="card" id="notes" style="display:none;margin-top:16px" role="dialog" aria-modal="true">
      <div class="row">
        <h2>Notes — <span id="notes-for">Contact</span></h2>
        <span style="margin-left:auto"><button id="notes-close" class="btn">Close</button></span>
      </div>
      <div class="hr"></div>
      <div id="notes-list"></div>
      <div class="row" style="margin-top:8px;display:flex;gap:8px">
        <input id="note-text" placeholder="Add note (e.g., ‘HS sent Email 1 — no reply’)">
        <button id="note-add" class="btn primary">Add Note</button>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section class="card" id="analytics" style="margin-top:16px">
      <div class="row"><h2>Analytics</h2></div>
      <div class="hr"></div>
      <div class="grid-3">
        <div><strong>Completion</strong><div id="an-complete" class="small muted">—</div></div>
        <div><strong>Avg Step</strong><div id="an-avgstep" class="small muted">—</div></div>
        <div><strong>Notes (total)</strong><div id="an-notes" class="small muted">—</div></div>
      </div>
    </section>

    <!-- TODAY DOCK (sticky) -->
    <section id="today-dock" class="card" style="position:sticky;bottom:12px;margin-top:12px">
      <div style="display:flex;align-items:center;gap:8px">
        <h2 style="margin:0">Today’s Queue</h2>
        <span class="pill">Due: <span id="dock-due">0</span></span>
        <button id="dock-send-all" class="btn primary" style="margin-left:auto">Send All</button>
      </div>
      <div class="hr"></div>
      <div id="dock-list" class="small"></div>
    </section>

    <!-- NEXT 7 DAYS -->
    <section class="card" id="calendar" style="margin-top:12px">
      <h2 style="margin:0">Next 7 Days</h2>
      <div class="hr"></div>
      <div id="week" class="small"></div>
    </section>
  </main>
</div>

<div class="toast" id="toast"></div>
<div class="modal-backdrop" id="backdrop" aria-hidden="true"><div class="modal" id="modal"></div></div>
<script>
(() => {
"use strict";

/* ===== Utils ===== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const rid = ()=>Math.random().toString(36).slice(2,10);
const nowISO = ()=>new Date().toISOString();
const fmt = (d,loc)=> d? new Date(d).toLocaleString(loc||"en-AU"): "—";
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
const esc = (s="")=>s.replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
const clone = (x)=>JSON.parse(JSON.stringify(x));
const toast = (msg)=>{const t=$("#toast");const d=document.createElement("div");d.className="item";d.textContent=msg;t.appendChild(d);setTimeout(()=>d.remove(),2400);};
const lsGet = (k,d)=>{try{return JSON.parse(localStorage.getItem(k)) ?? d;}catch{return d;}};
const lsSet = (k,v)=>localStorage.setItem(k, JSON.stringify(v));

/* ===== Persistence keys ===== */
const LS = { contacts:"heed_contacts_v6", templates:"heed_templates_v6", settings:"heed_settings_v6", history:"heed_history_v3" };

/* ===== Models ===== */
class Contact {
  constructor({id=rid(), name="", email="", company="", phone="", tz="Australia/Sydney", segments=[], status="Active", lastSent=0, lastSentAt="", notes=[]}={}) {
    Object.assign(this, {id, name, email, company, phone, tz, segments, status, lastSent, lastSentAt, notes});
  }
}
class TemplateStep {
  constructor({id=rid(), step=1, active=true, subject="", body="", variantB=null}={}) {
    Object.assign(this, {id, step, active, subject, body, variantB});
  }
}
class Settings {
  constructor(o={}) {
    this.seqLen = o.seqLen ?? 7;
    this.defaultGap = o.defaultGap ?? 3;
    this.fromName = o.fromName ?? "HD HeeD";
    this.initials = o.initials ?? "HS";
    this.businessTime = o.businessTime ?? "09:00";
    this.sortKey = o.sortKey ?? "name";
    this.sortDir = o.sortDir ?? 1;
    this.locale = o.locale ?? "en-AU";
    this.theme = o.theme ?? "light";
    this.rate = o.rate ?? 5;
  }
}

/* ===== State ===== */
const state = {
  contacts: lsGet(LS.contacts, []),
  templates: lsGet(LS.templates, null),
  settings: new Settings(lsGet(LS.settings, {}))
};

/* ===== Undo (light) ===== */
function snapshot(){
  const hist = lsGet(LS.history, []);
  hist.push({at: nowISO(), contacts: state.contacts, templates: state.templates, settings: state.settings});
  if(hist.length>40) hist.shift();
  lsSet(LS.history, hist);
}

/* ===== Your first 4 emails (from your site) ===== */
const EMAILS14 = [
  { step:1, subject:"Introduction to HD HeeD",
    body:`Hi {{Name}},

Please let me introduce HD HeeD Pty Ltd, an NDIS-registered provider based in Blacktown. We are an RN-led team, with the skills and systems to deliver safe, professional, and person-centred supports.

We are registered under the following NDIS groups:
• 0104 – High Intensity Daily Personal Activities
• 0107 – Daily Personal Activities
• 0115 – Assistance with Daily Life Tasks in a Group/Shared Living
• 0117 – Development of Daily Living and Life Skills
• 0120 – Household Tasks
• 0125 – Participation in Community, Social and Civic Activities
• 0136 – Group and Centre-Based Activities

At HD HeeD, we keep onboarding simple and organised:
• Website: https://www.hdheed.com.au
• Talk to our AI assistant Ella
• Online referral form: https://www.hdheed.com.au/referral.html
• Or reply to this email / info@hdheed.com.au / ndis@hdheed.com.au

Start a referral today: https://www.hdheed.com.au/referral.html

Kind regards,
Mat Syan
Director – HD HeeD Pty Ltd
02 8630 5500 | info@hdheed.com.au`},
  { step:2, subject:"Our RN-Led Strength",
    body:`Hi {{Name}},

At HD HeeD, we are a group of Registered Nurses confident in our skills and experience. This lets us provide the highest standard of care, especially for complex health needs, under registration group 0104 – High Intensity Daily Personal Activities.

This keeps services clinically safe and professional, and more cost-effective than group 0114 (Community Nursing). Your participants get RN-level support within the right NDIS group — quality and value.

Start a referral: https://www.hdheed.com.au/referral.html

A paper referral form is also available — email it to info@hdheed.com.au if preferred.
You can call us on 02 8630 5500 anytime.

Kind regards,
Mat Syan
Director – HD HeeD Pty Ltd
02 8630 5500 | info@hdheed.com.au`},
  { step:3, subject:"AILR System",
    body:`Hi {{Name}},

One of our key strengths is AILR — Advanced Intake & Long-form Registration. Most onboarding is completed online, with only a few signature forms returned via email. It’s:
• Systematic and organised
• Less paperwork
• Straightforward and time-saving

See AILR: https://www.hdheed.com.au/ailr.html
Quick referral: https://www.hdheed.com.au/referral.html
Paper referral: info@hdheed.com.au
Phone: 02 8630 5500

Kind regards,
Mat Syan
Director – HD HeeD Pty Ltd
02 8630 5500 | info@hdheed.com.au`},
  { step:4, subject:"Easy Online Referrals",
    body:`Hi {{Name}},

Save time with our quick online referral system: https://www.hdheed.com.au/referral.html
It’s streamlined, convenient, and audit-ready.

Prefer paper? Complete the form and email it to info@hdheed.com.au.
Either way, we’ll onboard quickly and professionally.

Kind regards,
Mat Syan
Director – HD HeeD Pty Ltd
02 8630 5500 | info@hdheed.com.au`}
];

/* ===== Ensure templates 1–N exist ===== */
function ensureTemplates(){
  if(!state.templates){
    const out = [];
    const N = state.settings.seqLen || 7;
    for(let i=1;i<=N;i++){
      const fromSite = EMAILS14.find(x=>x.step===i);
      out.push(new TemplateStep({
        step:i, active:true,
        subject: fromSite? fromSite.subject : `Email ${i}`,
        body: fromSite? fromSite.body : `Hi {{Name}},\n\n...\n\nTeam HD HeeD`
      }));
    }
    state.templates = out;
    lsSet(LS.templates, state.templates);
  }
}

/* ===== Preload 9 contacts (board) if storage is empty ===== */
const PRELOAD_9 = [
  { name:"Taylor McGuiness — Interaction", company:"Interaction", email:"info@interactionservices.org", phone:"1300 668 123", segments:["SC/PM"], status:"Active", lastSent:2, lastSentAt:"2025-09-15T00:00:00+10:00", notes:[
    {at:"2025-09-15T00:00:00+10:00",by:"HS",text:"Himmat — Called them, they said send an email."},
    {at:"2025-09-15T00:00:00+10:00",by:"HS",text:"Email 1 sent — awaiting response."},
    {at:"2025-09-15T00:00:00+10:00",by:"HS",text:"Email 2 sent 15/09/25."}
  ]},
  { name:"Assist Disability Services — SSC", company:"Assist Disability Services", email:"enquiries@assistservices.com.au", phone:"1800 955 806", segments:["SSC"], status:"Active", lastSent:2, lastSentAt:"2025-09-15T00:00:00+10:00", notes:[
    {at:"2025-09-15T00:00:00+10:00",by:"HS",text:"Himmat — Called; they took my number and will call back."},
    {at:"2025-09-15T00:00:00+10:00",by:"HS",text:"Email 2 sent 15/09/2025."}
  ]},
  { name:"Triniti Care — Support Coord", company:"Triniti Care", email:"info@triniti.com.au", phone:"(02) 8319 9433", segments:["SC"], status:"Active", lastSent:1, lastSentAt:"2025-09-15T00:00:00+10:00", notes:[
    {at:"2025-09-15T00:00:00+10:00",by:"HS",text:"Himmat — called; they said email info@triniti.com.au."},
    {at:"2025-09-15T00:00:00+10:00",by:"HS",text:"Email 1 sent — undelivered; recheck address."}
  ]},
  { name:"MD Home Care — SSC", company:"MD Home Care", email:"", phone:"08 6386 9999", segments:["SSC"], status:"Active", lastSent:0, lastSentAt:"", notes:[
    {at:"2025-09-15T00:00:00+10:00",by:"HS",text:"No emails sent yet."}
  ]},
  { name:"Claremont Care — SC/PM", company:"Claremont Care", email:"", phone:"0416 873 319", segments:["SC","PM"], status:"Active", lastSent:2, lastSentAt:"2025-09-15T00:00:00+10:00", notes:[
    {at:"2025-09-15T00:00:00+10:00",by:"HS",text:"Email 1 sent — N&J."},
    {at:"2025-09-15T00:00:00+10:00",by:"HS",text:"Email 2 sent 15/09."}
  ]},
  { name:"BRK Plan Management", company:"BRK Plan Management", email:"meet@brkpm.com.au", phone:"0414 704 279", segments:["PM"], status:"Active", lastSent:1, lastSentAt:"2025-09-15T00:00:00+10:00", notes:[
    {at:"2025-09-15T00:00:00+10:00",by:"HS",text:"Email 1 sent — N&J."}
  ]},
  { name:"Axial Plan Management", company:"Axial Plan Management", email:"hello@axialplanmanagement.com.au", phone:"0416 428 261", segments:["PM"], status:"Active", lastSent:1, lastSentAt:"2025-09-15T00:00:00+10:00", notes:[
    {at:"2025-09-15T00:00:00+10:00",by:"HS",text:"Himmat — Email 1 sent, awaiting response."}
  ]},
  { name:"NADO Plan Management", company:"NADO Plan Management", email:"", phone:"1300 738 229", segments:["PM"], status:"Active", lastSent:0, lastSentAt:"", notes:[
    {at:"2025-09-15T00:00:00+10:00",by:"HS",text:"No emails sent yet."}
  ]},
  { name:"Yahweh Care — PM", company:"Yahweh Care", email:"info@yahwehcare.com.au", phone:"(02) 8325 1616", segments:["PM"], status:"Active", lastSent:1, lastSentAt:"2025-09-15T00:00:00+10:00", notes:[
    {at:"2025-09-15T00:00:00+10:00",by:"HS",text:"Himmat — Email 1 sent, awaiting response."}
  ]}
];

function preloadIfEmpty(){
  if(!(state.contacts||[]).length){
    state.contacts = PRELOAD_9.map(c => new Contact({ id: rid(), ...c }));
    lsSet(LS.contacts, state.contacts);
    toast("Loaded 9 contacts from board.");
  }
}

/* ===== Theme & setting bindings ===== */
function applyTheme(t){ document.documentElement.setAttribute("data-theme", t); }
function bindSettings(){
  $("#seq-len").value = String(state.settings.seqLen);
  $("#default-gap").value = String(state.settings.defaultGap);
  $("#target-time").value = state.settings.businessTime;
  $("#from-name").value = state.settings.fromName;
  $("#initials").value = state.settings.initials;
  $("#theme").value = state.settings.theme;

  $("#theme-toggle").onclick = ()=>{
    const seq = ["light","dark","contrast"];
    const idx = seq.indexOf(state.settings.theme);
    state.settings.theme = seq[(idx+1)%seq.length];
    $("#theme").value = state.settings.theme; lsSet(LS.settings, state.settings); applyTheme(state.settings.theme);
  };

  $("#theme").onchange = e=>{ state.settings.theme = e.target.value; lsSet(LS.settings, state.settings); applyTheme(state.settings.theme); };
  $("#seq-len").onchange = e=>{
    snapshot();
    const n = clamp(parseInt(e.target.value,10)||7,7,10);
    state.settings.seqLen = n;
    if(state.templates.length < n){
      for(let s=state.templates.length+1; s<=n; s++){
        state.templates.push(new TemplateStep({step:s,active:true,subject:`Email ${s}`,body:`Hi {{Name}},\n\n...\n\nTeam HD HeeD`}));
      }
    }else if(state.templates.length>n){
      state.templates = state.templates.slice(0,n);
    }
    lsSet(LS.settings, state.settings); lsSet(LS.templates, state.templates);
    renderTemplates(); bindRTE();
  };
  $("#default-gap").onchange = e=>{ state.settings.defaultGap = clamp(parseInt(e.target.value,10)||3,1,30); lsSet(LS.settings, state.settings); };
  $("#target-time").onchange = e=>{ state.settings.businessTime = e.target.value||"09:00"; lsSet(LS.settings, state.settings); };
  $("#from-name").onchange = e=>{ state.settings.fromName = e.target.value.trim()||"HD HeeD"; lsSet(LS.settings, state.settings); };
  $("#initials").onchange = e=>{ state.settings.initials = e.target.value.trim()||"HS"; lsSet(LS.settings, state.settings); };
}

/* ===== Templates UI (rich) ===== */
function renderTemplates(){
  const box = $("#tpl-box"); box.innerHTML = "";
  clone(state.templates).sort((a,b)=>a.step-b.step).forEach(t=>{
    const div = document.createElement("div"); div.className="card"; div.style.margin="8px 0";
    div.innerHTML = `
      <div class="row" style="display:flex;gap:8px;align-items:center">
        <strong>Step ${t.step}</strong>
        <label style="margin-left:auto" class="small"><input type="checkbox" data-id="${t.id}" data-k="active" ${t.active!==false?"checked":""}> Active</label>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <div><label>Subject (A)</label><input data-id="${t.id}" data-k="subject" value="${esc(t.subject||"")}"></div>
        <div><label>Subject (B)</label><input data-id="${t.id}" data-k="subjectB" value="${esc(t.variantB?.subject||"")}"></div>
        <div><label>Step</label><input value="${t.step}" readonly class="mono"></div>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <div><label>Body (A)</label><div class="rte" data-id="${t.id}" data-k="body" contenteditable="true">${esc(t.body||"")}</div></div>
        <div><label>Body (B)</label><div class="rte" data-id="${t.id}" data-k="bodyB" contenteditable="true">${esc(t.variantB?.body||"")}</div></div>
        <div>
          <label>Merge fields</label>
          <div class="small muted">Use {{Name}} {{Company}} {{Phone}}</div>
          <div class="rte-toolbar">
            <button data-insert="{{Name}}" class="btn ghost">+ Name</button>
            <button data-insert="{{Company}}" class="btn ghost">+ Company</button>
            <button data-insert="{{Phone}}" class="btn ghost">+ Phone</button>
          </div>
        </div>
      </div>`;
    box.appendChild(div);
  });
  $("#pill-len").textContent = `${state.settings.seqLen} steps`;
}
function saveTemplatesFromUI(){
  snapshot();
  const map = Object.fromEntries(state.templates.map(t=>[t.id,t]));
  $$("#tpl-box [data-id]").forEach(el=>{
    const id = el.dataset.id, k = el.dataset.k, T = map[id]; if(!T) return;
    if(el.tagName==="INPUT" && el.type==="checkbox"){ T.active = el.checked; }
    else if(el.tagName==="INPUT"){ if(k==="subject") T.subject = el.value; else if(k==="subjectB"){ T.variantB = T.variantB || {subject:"",body:""}; T.variantB.subject = el.value; } }
    else if(el.classList.contains("rte")){
      const v = el.innerText.replace(/\r\n/g,"\n");
      if(k==="body") T.body = v;
      if(k==="bodyB"){ T.variantB = T.variantB||{subject:"",body:""}; T.variantB.body = v; }
    }
  });
  lsSet(LS.templates, state.templates);
  toast("Templates saved.");
}
function insertAtCaret(text){
  const sel = window.getSelection?.(); if(!sel || !sel.rangeCount) return;
  const range = sel.getRangeAt(0); range.deleteContents(); range.insertNode(document.createTextNode(text)); range.collapse(false);
}
function bindRTE(){
  $$("#preview .rte-toolbar [data-cmd]").forEach(b=> b.onclick = ()=>document.execCommand(b.dataset.cmd,false));
  $$("#tpl-box [data-insert]").forEach(b=> b.onclick = ()=>insertAtCaret(b.dataset.insert));
}

/* ===== Init part ===== */
function init2(){
  ensureTemplates(); renderTemplates(); bindRTE(); bindSettings(); applyTheme(state.settings.theme);
  document.addEventListener("keydown",(e)=>{
    if(e.key==="/"){ e.preventDefault(); $("#search").focus(); }
    if(e.key.toLowerCase()==="n"){ const openEditor = window.__heed_openEditor; openEditor && openEditor(); }
  });
  $("#save-templates").onclick = saveTemplatesFromUI;
  $("#btn-add-template").onclick = ()=>{
    const next = (state.templates[state.templates.length-1]?.step||0)+1;
    if(next>10) return toast("Max 10 steps");
    state.templates.push(new TemplateStep({step:next,active:true,subject:`Email ${next}`,body:`Hi {{Name}},\n\n...\n\nTeam HD HeeD`}));
    lsSet(LS.templates,state.templates); renderTemplates(); bindRTE();
  };
  $("#btn-remove-template").onclick = ()=>{
    if(state.templates.length<=7) return toast("Min 7 steps");
    state.templates.pop(); lsSet(LS.templates,state.templates); renderTemplates(); bindRTE();
  };
}
window.__heed_init_part2 = init2;

/* expose state (read-only) for other parts */
window.__heed_state = state;
window.__heed_keys = LS;
})();
</script>
<script>
(() => {
"use strict";

const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const state = window.__heed_state;
const LS = window.__heed_keys;
const lsSet = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
const nowISO = ()=>new Date().toISOString();
const fmt = (d,loc)=> d? new Date(d).toLocaleString(loc||"en-AU"): "—";
const esc = (s="")=>s.replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
const toast = (msg)=>{const t=$("#toast");const d=document.createElement("div");d.className="item";d.textContent=msg;t.appendChild(d);setTimeout(()=>d.remove(),2400);};
const rid = ()=>Math.random().toString(36).slice(2,10);

/* === (All functions defined above this cut remain as you pasted) === */

/* === Import/Export (continued) === */
async function importJSONFile(file){
  const text = await file.text(); const data = JSON.parse(text);
  if(!confirm("Import will overwrite local data. Continue?")) return;
  if(data.contacts) state.contacts = data.contacts;
  if(data.templates) state.templates = data.templates;
  if(data.settings) state.settings = {...state.settings, ...data.settings};
  lsSet(LS.contacts,state.contacts); lsSet(LS.templates,state.templates); lsSet(LS.settings,state.settings);
  location.reload();
}
function exportJSON(){
  const blob = new Blob([JSON.stringify({contacts:state.contacts,templates:state.templates,settings:state.settings},null,2)],{type:"application/json"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
  a.download = `heed-followups-${new Date().toISOString().slice(0,10)}.json`; a.click();
}
function exportCSV(){
  const headers = ["id","name","email","company","phone","tz","segments","status","lastSent","lastSentAt","notesCount"];
  const rows = (state.contacts||[]).map(c=>[
    q(c.id), q(c.name), q(c.email), q(c.company), q(c.phone), q(c.tz), q((c.segments||[]).join("|")),
    q(c.status||"Active"), q(c.lastSent||0), q(c.lastSentAt||""), q((c.notes||[]).length)
  ]);
  const csv = [headers.join(","), ...rows.map(r=>r.join(","))].join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
  a.download = `heed-contacts-${new Date().toISOString().slice(0,10)}.csv`; a.click();
  function q(s){ const t=(s??"").toString().replace(/"/g,'""'); return `"${t}"`; }
}
async function importCSVFile(file){
  const text = await file.text();
  const lines = text.split(/\r?\n/).filter(Boolean);
  if(lines.length<2) return alert("CSV has no data");
  const hdr = lines[0].split(",").map(h=>h.trim());
  const rows = lines.slice(1).map(line=>{
    const out=[]; let cur="",inq=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"' && line[i+1]==='"'){ cur+='"'; i++; continue; }
      if(ch==='"'){ inq=!inq; continue; }
      if(ch===',' && !inq){ out.push(cur); cur=""; continue; }
      cur+=ch;
    } out.push(cur); return out;
  });
  const cs = state.contacts||[];
  rows.forEach(r=>{
    const obj = Object.fromEntries(hdr.map((h,i)=>[h, r[i]??""]));
    const id = obj.id || rid();
    const idx = obj.email? cs.findIndex(x=>x.email===obj.email) : -1;
    const c = {
      id,
      name: obj.name||"", email: obj.email||"", company: obj.company||"", phone: obj.phone||"",
      tz: obj.tz||"Australia/Sydney", segments: (obj.segments||"").split("|").filter(Boolean),
      status: obj.status||"Active", lastSent: Number(obj.lastSent||0), lastSentAt: obj.lastSentAt||"",
      notes: (obj.notesCount? []:[])
    };
    if(idx>=0) cs[idx] = {...cs[idx], ...c}; else cs.push(c);
  });
  state.contacts = cs; lsSet(LS.contacts, cs); renderContacts();
}

/* === Analytics === */
function renderAnalytics(){
  const cs = state.contacts||[]; const N = state.settings.seqLen||7;
  if(!cs.length){ $("#an-complete").textContent="—"; $("#an-avgstep").textContent="—"; $("#an-notes").textContent="—"; return; }
  const completed = cs.filter(c=>c.status==="Completed").length;
  const avgStep = cs.reduce((a,c)=>a+(c.lastSent||0),0)/cs.length;
  const notes = cs.reduce((a,c)=>a+(c.notes?.length||0),0);
  $("#an-complete").textContent = `${Math.round((completed/cs.length)*100)}% (${completed}/${cs.length})`;
  $("#an-avgstep").textContent = `${avgStep.toFixed(2)} / ${N}`;
  $("#an-notes").textContent = String(notes);
}

/* === Today Dock === */
function renderTodayDock(){
  const box = $("#dock-list"); if(!box) return;
  const today = new Date(); today.setHours(23,59,59,999);
  const due = (state.contacts||[]).filter(c=> (c.status||"Active")==="Active" && nextStepFor(c) && dueDateFor(c)<=today );
  $("#dock-due").textContent = String(due.length);
  box.innerHTML = "";
  due.slice(0,30).forEach(c=>{
    const step = nextStepFor(c);
    const row = document.createElement("div");
    row.style.display="grid"; row.style.gridTemplateColumns="1fr auto auto"; row.style.gap="6px"; row.style.margin="6px 0";
    row.innerHTML = `
      <div><strong>${esc(c.name||c.email||"Contact")}</strong>
        <div class="muted small">Next: Email ${step} • Due ${fmt(dueDateFor(c),state.settings.locale)}</div></div>
      <button class="btn btn-preview">Preview</button>
      <button class="btn primary btn-send">Send</button>`;
    row.querySelector(".btn-preview").onclick = ()=>openPreview(c.id);
    row.querySelector(".btn-send").onclick = ()=>sendNext(c.id);
    box.appendChild(row);
  });
}

/* === Next 7 Days === */
function renderWeek(){
  const box=$("#week"); if(!box) return; box.innerHTML="";
  for(let i=0;i<7;i++){
    const d=new Date(); d.setDate(d.getDate()+i); d.setHours(23,59,59,999);
    const list=(state.contacts||[]).filter(c=> (c.status||"Active")==="Active" && nextStepFor(c) && dueDateFor(c).toDateString()===d.toDateString());
    const div=document.createElement("div"); div.style.margin="6px 0";
    div.innerHTML = `<strong>${d.toLocaleDateString(state.settings.locale||"en-AU",{weekday:"short",month:"short",day:"numeric"})}</strong> — ${list.length} due`;
    box.appendChild(div);
  }
}

/* === ICS Export === */
function exportICS(){
  const today = new Date(); today.setHours(23,59,59,999);
  const due = state.contacts.filter(c=> (c.status||"Active")==="Active" && nextStepFor(c) && dueDateFor(c)<=today );
  if(!due.length){ toast("No contacts due today"); return; }
  const lines = ["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//HD HeeD//Sequencer//EN"];
  due.slice(0,50).forEach(c=>{
    const dt = dueDateFor(c); const pad=n=>String(n).padStart(2,"0");
    const stamp = `${dt.getUTCFullYear()}${pad(dt.getUTCMonth()+1)}${pad(dt.getUTCDate())}T${pad(dt.getUTCHours())}${pad(dt.getUTCMinutes())}00Z`;
    const step = nextStepFor(c); const {subject} = buildEmail(c, step);
    lines.push("BEGIN:VEVENT");
    lines.push(`UID:${c.id}@hdheed`);
    lines.push(`DTSTAMP:${stamp}`);
    lines.push(`DTSTART:${stamp}`);
    lines.push(`SUMMARY:${subject.slice(0,70).replace(/[\\n,;]/g," ")}`);
    lines.push(`DESCRIPTION:${`Prepare and send to ${c.email||'no-email'}`.replace(/[\\n,;]/g," ")}`);
    lines.push("END:VEVENT");
  });
  lines.push("END:VCALENDAR");
  const blob = new Blob([lines.join("\r\n")],{type:"text/calendar"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "hdheed_next_due.ics"; a.click();
}
/* === Batch Prepare (open mailto: one-by-one) === */
function batchPrepare(){
  const today = new Date(); today.setHours(23,59,59,999);
  const due = (state.contacts||[]).filter(c=> (c.status||"Active")==="Active" && nextStepFor(c) && dueDateFor(c)<=today );
  if(!due.length){ toast("No contacts due today."); return; }

  let opened = 0;
  // open max N sequentially (browsers may block too many tabs)
  const maxOpen = Math.min(10, due.length);
  (function openNext(i){
    if(i>=maxOpen) return toast(`Opened ${opened} compose window(s).`);
    const c = due[i]; if(!c || !(c.email||"").trim()) return openNext(i+1);
    const step = nextStepFor(c);
    const {subject, body} = buildEmail(c, step);
    const ml = `mailto:${encodeURIComponent(c.email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    // Use _self to let handler take over quickly
    window.open(ml, "_self");
    opened++;
    setTimeout(()=>openNext(i+1), 350); // small delay to avoid handler spam
  })(0);
}

/* === Event bindings & init === */
function bindUI(){
  $("#search").oninput = ()=>renderContacts();
  $("#filter-status").onchange = ()=>renderContacts();
  $("#sort-key").onchange = ()=>{ const s=state.settings; s.sortKey=$("#sort-key").value; lsSet(LS.settings,s); renderContacts(); };

  $("#view-due").onclick = ()=>{
    const today = new Date(); today.setHours(23,59,59,999);
    const due = (state.contacts||[]).filter(c=> (c.status||"Active")==="Active" && nextStepFor(c) && dueDateFor(c)<=today );
    if(!due.length){ alert("No contacts due today."); return; }
    const msg = due.map(c=>`• ${c.name||c.email||"Contact"} — Next: Email ${nextStepFor(c)} (Due ${fmt(dueDateFor(c),state.settings.locale)})`).join("\n");
    alert(`Due today:\n\n${msg}`);
  };
  $("#batch-send").onclick = batchPrepare;
  $("#export-ics").onclick = exportICS;

  $("#pv-copy").onclick = ()=>navigator.clipboard.writeText($("#pv-body").innerText||"");
  $("#pv-send").onclick = ()=>sendFromPreview();
  $("#pv-restore").onclick = ()=>restoreFromTemplate();
  $("#pv-close").onclick = ()=>{ $("#preview").style.display="none"; };

  $("#add-contact").onclick = ()=>window.__heed_openEditor && window.__heed_openEditor();
  $("#ed-cancel").onclick = ()=>$("#editor").style.display="none";
  $("#ed-save").onclick = ()=>saveContact();

  $("#note-add").onclick = ()=>addNote();
  $("#notes-close").onclick = ()=>$("#notes").style.display="none";

  $("#export-json").onclick = exportJSON;
  $("#import-json").onchange = e=>{ const f=e.target.files?.[0]; if(f) importJSONFile(f); };
  $("#export-csv").onclick = exportCSV;
  $("#import-csv").onchange = e=>{ const f=e.target.files?.[0]; if(f) importCSVFile(f); };
  $("#reset").onclick = ()=>{ if(confirm("Reset ALL local data?")){ localStorage.removeItem(LS.contacts); localStorage.removeItem(LS.templates); localStorage.removeItem(LS.settings); localStorage.removeItem(LS.history); location.reload(); }};

  $("#dock-send-all").onclick = batchPrepare;

  document.addEventListener("keydown",(e)=>{
    if(e.key==="/"){ e.preventDefault(); $("#search").focus(); }
    if(e.key.toLowerCase()==="n"){ const openEditor = window.__heed_openEditor; openEditor && openEditor(); }
  });
}

function init4(){
  // ensure settings exist (from earlier parts)
  if(!state.settings) state.settings = { seqLen:7, defaultGap:3, businessTime:"09:00", sortKey:"name", sortDir:1, locale:"en-AU", theme:"light", initials:"HS", rate:5 };
  bindUI();
  renderContacts();
}

/* === PWA-lite (optional, no external files) === */
if("serviceWorker" in navigator){
  // Very tiny inline SW for offline caching of this single HTML
  const swBlob = new Blob([`
self.addEventListener('install', e=>{
  e.waitUntil(caches.open('heed-v1').then(c=>c.addAll(['./'])));
});
self.addEventListener('fetch', e=>{
  e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
});`], {type:"text/javascript"});
  const swURL = URL.createObjectURL(swBlob);
  navigator.serviceWorker.register(swURL).catch(()=>{});
}

/* === Boot === */
document.addEventListener("DOMContentLoaded", init4);

})();
</script>
</body>
</html>
