<!doctype html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HD HeeD — Follow-Up Sequencer (Zoho, 7–10 steps)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
<link rel="manifest" href="#app-manifest" crossorigin="use-credentials">
<meta name="theme-color" content="#111827">

<style>
/* ====== Base & Theme System ====== */
:root{
  --font: Inter, system-ui, Segoe UI, Arial, sans-serif;
  --ink:#0b1226; --bg:#f7f9fc; --card:#ffffff; --muted:#667085; --line:#e5e7eb;
  --brand:#4f46e5; --brand2:#ec4899; --ok:#16a34a; --warn:#eab308; --danger:#ef4444; --info:#0ea5e9;
  --shadow: 0 6px 22px rgba(10,20,40,.08);
  --radius: 14px;
  --kbd:#111827; --kbd-bg:#e5e7eb;
}
:root[data-theme="dark"]{
  --ink:#e5e7eb; --bg:#0b1226; --card:#0f172a; --muted:#94a3b8; --line:#1e293b;
  --brand:#8b5cf6; --brand2:#f472b6; --ok:#22c55e; --warn:#facc15; --danger:#ef4444; --info:#38bdf8;
  --shadow: 0 8px 28px rgba(0,0,0,.35);
  --kbd:#e5e7eb; --kbd-bg:#334155;
}
:root[data-theme="contrast"]{
  --ink:#000; --bg:#fff; --card:#fff; --muted:#111; --line:#000;
  --brand:#000; --brand2:#333; --ok:#000; --warn:#000; --danger:#000; --info:#000;
}
/* Typography & layout */
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:var(--font)}
a{color:var(--brand);text-decoration:none}
a:focus{outline:2px solid var(--brand2);border-radius:6px}
.wrap{max-width:1280px;margin:20px auto;padding:0 16px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand2))}
.title{font-weight:800;font-size:20px}
.sub{color:var(--muted);font-size:13px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
.hr{height:1px;background:var(--line);margin:12px 0}

/* Buttons */
.btn{appearance:none;border:1px solid var(--line);background:#fff;color:#111827;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
:root[data-theme="dark"] .btn{background:#0b1226;color:var(--ink)}
.btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
.btn.warn{background:var(--warn);border-color:var(--warn);color:#111}
.btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
.btn.ghost{background:transparent}

/* Inputs */
input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:#111827;font:inherit}
:root[data-theme="dark"] input,:root[data-theme="dark"] textarea,:root[data-theme="dark"] select{background:#0b1226;color:var(--ink);border-color:#1e293b}
label{font-size:12px;color:var(--muted);font-weight:600}
.small{font-size:12px} .muted{color:var(--muted)} .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}

/* Table */
table{width:100%;border-collapse:separate;border-spacing:0}
th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
th{font-size:12px;color:#475569;text-transform:uppercase;letter-spacing:.08em;white-space:nowrap;cursor:pointer}
:root[data-theme="dark"] th{color:#cbd5e1}
tr:last-child td{border-bottom:0}

/* Tags, progress */
.tag{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:#fafafa;color:#111827}
:root[data-theme="dark"] .tag{background:#0b1226;color:var(--ink)}
.tag.ok{background:#ecfdf5;border-color:#86efac;color:#065f46}
.tag.warn{background:#fffbeb;border-color:#fde68a;color:#92400e}
.tag.danger{background:#fef2f2;border-color:#fecaca;color:#991b1b}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px;font-weight:700}
.progress{height:8px;border-radius:6px;background:#eaeaf3;overflow:hidden}
.progress > span{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2))}

/* Grid helpers */
.grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
@media (max-width:1100px){.grid{grid-template-columns:1fr}}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
@media (max-width:1100px){.grid-3{grid-template-columns:1fr}}

/* Toasts & modals */
.toast{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:1000}
.toast .item{background:var(--card);border:1px solid var(--line);border-radius:10px;box-shadow:var(--shadow);padding:10px 12px}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:900}
.modal{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;max-width:680px;width:min(680px,96vw)}

/* RTE (contenteditable) */
.rte{border:1px solid var(--line);border-radius:10px;background:#fff;color:#111827;padding:8px 10px;min-height:120px}
:root[data-theme="dark"] .rte{background:#0b1226;color:var(--ink)}
.rte-toolbar{display:flex;gap:6px;margin-bottom:6px}
.rte-toolbar button{font-size:12px;padding:6px 10px}

/* Keyboard hint */
kbd{background:var(--kbd-bg);color:var(--kbd);padding:2px 6px;border-radius:6px;border:1px solid var(--line);font:inherit;font-size:11px}

/* Animations */
@keyframes pop{0%{transform:scale(.98);opacity:.5}100%{transform:scale(1);opacity:1}}
.card, .modal{animation:pop .14s ease-out}

/* Icon font (simple map via data-icon attr) */
.i{font:inherit}
.i::before{content:attr(data-icon); display:inline-block; width:1.2em; text-align:center; margin-right:.25em}
</style>

<!-- PWA Manifest (in-page, linked via fragment URL) -->
<script type="application/manifest+json" id="app-manifest">
{
  "name": "HD HeeD Sequencer",
  "short_name": "HeeD Sequencer",
  "start_url": "./followup.html",
  "display": "standalone",
  "background_color": "#0b1226",
  "theme_color": "#111827",
  "icons": []
}
</script>
</head>

<body>
<a href="#main" class="small" style="position:absolute;left:-9999px" onfocus="this.style.left='8px'">Skip to content</a>
<div class="wrap" id="app-root" aria-live="polite">
  <header class="header" role="banner">
    <div class="brand" aria-label="Brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">HD HeeD — Follow-Up Sequencer</div>
        <div class="sub">Professional sequences • tracking • Zoho one-click • offline</div>
      </div>
    </div>
    <div class="toolbar" role="toolbar" aria-label="Global actions">
      <button id="theme-toggle" class="btn" title="Toggle theme"><span class="i" data-icon="🌗"></span>Theme</button>
      <button id="export-json" class="btn"><span class="i" data-icon="💾"></span>Export JSON</button>
      <label class="btn" for="import-json"><span class="i" data-icon="📂"></span>Import JSON</label>
      <input id="import-json" type="file" class="sr-only" style="position:absolute;left:-9999px" accept="application/json">
      <button id="export-csv" class="btn"><span class="i" data-icon="📤"></span>Export CSV</button>
      <label class="btn" for="import-csv"><span class="i" data-icon="📥"></span>Import CSV</label>
      <input id="import-csv" type="file" class="sr-only" style="position:absolute;left:-9999px" accept=".csv,text/csv">
      <button id="reset" class="btn danger"><span class="i" data-icon="♻️"></span>Reset Local</button>
    </div>
  </header>

  <!-- SETTINGS -->
  <section class="card" role="region" aria-labelledby="settings-h">
    <h2 id="settings-h">Settings</h2>
    <div class="hr"></div>
    <div class="grid-3">
      <div>
        <label for="seq-len">Sequence length (7–10)</label>
        <select id="seq-len" aria-describedby="seq-help"><option>7</option><option>8</option><option>9</option><option>10</option></select>
        <div id="seq-help" class="small muted">Adjust anytime; templates adapt.</div>
      </div>
      <div>
        <label for="default-gap">Gap between emails (days)</label>
        <input id="default-gap" type="number" min="1" max="30" value="3">
      </div>
      <div>
        <label for="target-time">Target send time (HH:MM)</label>
        <input id="target-time" type="time" value="09:00">
      </div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div>
        <label for="zoho-domain">Zoho Domain</label>
        <select id="zoho-domain"><option value="mail.zoho.com">mail.zoho.com</option><option value="mail.zoho.eu">mail.zoho.eu</option><option value="mail.zoho.in">mail.zoho.in</option></select>
      </div>
      <div>
        <label for="from-name">From name</label>
        <input id="from-name" placeholder="HD HeeD">
      </div>
      <div>
        <label for="initials">Your initials (notes)</label>
        <input id="initials" placeholder="HS">
      </div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div>
        <label for="locale">Locale</label>
        <select id="locale"><option value="en-AU">English (AU)</option><option value="en-US">English (US)</option></select>
      </div>
      <div>
        <label for="rate-limit">Popup rate (per click)</label>
        <input id="rate-limit" type="number" min="1" max="10" value="5">
      </div>
      <div>
        <label for="theme">Theme</label>
        <select id="theme"><option value="light">Light</option><option value="dark">Dark</option><option value="contrast">High Contrast</option></select>
      </div>
    </div>
  </section>

  <main id="main">
    <div class="grid" style="margin-top:16px">
      <!-- Templates editor -->
      <section class="card" id="templates-card" aria-labelledby="tpl-h">
        <div class="row">
          <h2 id="tpl-h">Templates</h2>
          <span class="pill" id="pill-len">7 steps</span>
          <span class="right small muted">Placeholders: {{Name}} {{Company}} {{Phone}} • Variant A/B</span>
        </div>
        <div class="hr"></div>
        <div id="tpl-box" aria-live="polite"></div>
        <div class="row" style="margin-top:8px">
          <button id="btn-add-template" class="btn">+ Add Step</button>
          <button id="btn-remove-template" class="btn warn">– Remove Last</button>
          <span class="right"></span>
          <button id="save-templates" class="btn primary">Save Templates</button>
        </div>
      </section>

      <!-- Contacts & pipeline -->
      <section class="card" aria-labelledby="contacts-h">
        <div class="row">
          <h2 id="contacts-h">Contacts</h2>
          <span class="right row">
            <input id="search" placeholder="Search name/email/company… ( / )" aria-label="Search contacts">
            <select id="filter-status" aria-label="Filter status"><option value="">All</option><option value="Active">Active</option><option value="Paused">Paused</option><option value="Completed">Completed</option></select>
            <select id="sort-key" aria-label="Sort by">
              <option value="name">Name</option><option value="email">Email</option><option value="status">Status</option><option value="last">Last Sent</option><option value="next">Next Step</option><option value="progress">Progress</option>
            </select>
            <button id="add-contact" class="btn ok"><span class="i" data-icon="➕"></span>Add</button>
          </span>
        </div>
        <div class="hr"></div>

        <div class="grid-3" role="group" aria-label="Quick stats">
          <div class="pill">Due Today: <span id="due-count">0</span></div>
          <div class="pill">Completed: <span id="completed-count">0</span></div>
          <div class="pill">Active: <span id="active-count">0</span></div>
        </div>

        <div class="row" style="justify-content:flex-end;margin-top:6px">
          <button id="view-due" class="btn ghost">Show Due</button>
          <button id="batch-send" class="btn primary">Batch Prepare</button>
          <button id="export-ics" class="btn">Export ICS (next due)</button>
        </div>

        <table id="tbl" style="margin-top:10px" aria-describedby="tbl-help">
          <caption class="sr-only">Follow-up pipeline table</caption>
          <thead>
            <tr>
              <th data-sort="name">Contact</th>
              <th data-sort="email">Email</th>
              <th data-sort="status">Status</th>
              <th data-sort="last">Last Sent</th>
              <th data-sort="next">Next (step / due)</th>
              <th data-sort="progress">Progress</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
        <p id="tbl-help" class="small muted">Tip: <kbd>/</kbd> focus search • <kbd>n</kbd> new contact</p>

        <template id="row-tpl">
          <tr data-id="">
            <td>
              <div class="row" style="gap:6px">
                <strong class="c-name"></strong>
                <span class="tag small c-seg">—</span>
              </div>
              <div class="small muted c-company"></div>
              <div class="small">
                <button class="btn btn-notes">Notes</button>
                <span class="small muted">(<span class="notes-count">0</span>)</span>
              </div>
            </td>
            <td class="c-email mono"></td>
            <td><span class="tag c-status">Active</span></td>
            <td class="c-last mono small">—</td>
            <td>
              <div class="c-next mono small">Email 1</div>
              <div class="small muted c-due">—</div>
            </td>
            <td style="min-width:160px">
              <div class="progress"><span class="c-prog" style="width:0%"></span></div>
              <div class="small muted c-prog-label"></div>
            </td>
            <td>
              <div class="toolbar">
                <button class="btn btn-preview">Preview</button>
                <button class="btn primary btn-send">Send Next</button>
                <button class="btn ok btn-mark">Mark Sent</button>
                <button class="btn danger btn-del">Delete</button>
              </div>
            </td>
          </tr>
        </template>
      </section>
    </div>

    <!-- Preview -->
    <section class="card" id="preview" style="display:none;margin-top:16px" aria-labelledby="pv-h" role="dialog" aria-modal="true">
      <div class="row">
        <h2 id="pv-h">Next Email Preview</h2>
        <span class="right"><button id="pv-close" class="btn">Close</button></span>
      </div>
      <div class="hr"></div>
      <div class="grid-3">
        <div><label>Subject</label><input id="pv-subj" readonly></div>
        <div><label>To</label><input id="pv-to" readonly></div>
        <div><label>Variant</label><input id="pv-variant" readonly></div>
      </div>
      <div style="margin-top:8px">
        <div class="rte-toolbar">
          <button data-cmd="bold" class="btn ghost">Bold</button>
          <button data-cmd="italic" class="btn ghost">Italic</button>
          <button data-cmd="insertUnorderedList" class="btn ghost">• List</button>
          <button id="pv-copy" class="btn"><span class="i" data-icon="📋"></span>Copy</button>
        </div>
        <div id="pv-body" class="rte" contenteditable="true" aria-label="Editable email body"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="pv-send" class="btn ok">Send Next (Zoho)</button>
        <button id="pv-restore" class="btn">Restore Template</button>
      </div>
    </section>

    <!-- Editor -->
    <section class="card" id="editor" style="display:none;margin-top:16px" aria-labelledby="ed-h" role="dialog" aria-modal="true">
      <div class="row">
        <h2 id="ed-h">Add Contact</h2>
        <span class="right"><button id="ed-cancel" class="btn">Cancel</button></span>
      </div>
      <div class="hr"></div>
      <div class="grid-3">
        <div><label>Name</label><input id="ed-name"></div>
        <div><label>Email</label><input id="ed-email"></div>
        <div><label>Company</label><input id="ed-company"></div>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <div><label>Phone</label><input id="ed-phone" placeholder="+61 …"></div>
        <div><label>Timezone (IANA)</label><input id="ed-tz" placeholder="Australia/Sydney"></div>
        <div><label>Segments (comma)</label><input id="ed-seg" placeholder="NDIS, RN, Western Sydney"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div style="flex:1 1 auto"><label>Initials (default)</label><input id="ed-initials" placeholder="HS"></div>
        <div><button id="ed-save" class="btn primary">Save</button></div>
      </div>
    </section>

    <!-- Notes -->
    <section class="card" id="notes" style="display:none;margin-top:16px" aria-labelledby="nt-h" role="dialog" aria-modal="true">
      <div class="row">
        <h2 id="nt-h">Notes — <span id="notes-for">Contact</span></h2>
        <span class="right"><button id="notes-close" class="btn">Close</button></span>
      </div>
      <div class="hr"></div>
      <div id="notes-list" aria-live="polite"></div>
      <div class="row" style="margin-top:8px">
        <input id="note-text" placeholder="Add note (e.g., ‘HS sent Email 1 — no reply’)">
        <button id="note-add" class="btn primary">Add Note</button>
      </div>
    </section>

    <!-- Analytics -->
    <section class="card" id="analytics" style="margin-top:16px" aria-labelledby="an-h">
      <div class="row"><h2 id="an-h">Analytics</h2></div>
      <div class="hr"></div>
      <div class="grid-3">
        <div><strong>Completion</strong><div id="an-complete" class="small muted">—</div></div>
        <div><strong>Avg Step</strong><div id="an-avgstep" class="small muted">—</div></div>
        <div><strong>Notes (total)</strong><div id="an-notes" class="small muted">—</div></div>
      </div>
    </section>
  </main>
</div>

<div class="toast" id="toast" aria-live="assertive"></div>
<div class="modal-backdrop" id="backdrop" aria-hidden="true"><div class="modal" id="modal"></div></div>
<script>
(() => {
  "use strict";

/* ===== Utilities ===== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const rid = ()=>Math.random().toString(36).slice(2,10);
const nowISO = ()=>new Date().toISOString();
const fmt = (d,loc)=> d? new Date(d).toLocaleString(loc||"en-AU"): "—";
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
const esc = (s="")=>s.replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
const clone = (x)=>JSON.parse(JSON.stringify(x));
const toast = (msg)=>{const t=$("#toast");const d=document.createElement("div");d.className="item";d.textContent=msg;t.appendChild(d);setTimeout(()=>d.remove(),2500);};
const focusTrap = (panel)=>{panel.setAttribute("tabindex","-1");panel.focus();};

/* ===== Persistence & Audit ===== */
const LS = {
  contacts: "heed_contacts_v4",
  templates: "heed_templates_v4",
  settings: "heed_settings_v4",
  audit:    "heed_audit_v1",
  history:  "heed_history_v1"
};
const lsGet = (k,d)=>{try{return JSON.parse(localStorage.getItem(k)) ?? d;}catch{return d;}};
const lsSet = (k,v)=>localStorage.setItem(k, JSON.stringify(v));

function audit(event, payload){
  const logs = lsGet(LS.audit, []);
  logs.push({ id:rid(), at:nowISO(), event, payload });
  lsSet(LS.audit, logs);
}
function snapshot(){
  const snap = {
    at: nowISO(),
    contacts: lsGet(LS.contacts, []),
    templates: lsGet(LS.templates, []),
    settings: lsGet(LS.settings, {})
  };
  const hist = lsGet(LS.history, []);
  hist.push(snap);
  if(hist.length>30) hist.shift(); // cap history
  lsSet(LS.history, hist);
}
function undo(){
  const hist = lsGet(LS.history, []);
  if(hist.length<2) return toast("Nothing to undo");
  hist.pop(); // current
  const prev = hist.pop(); // previous
  lsSet(LS.contacts, prev.contacts); lsSet(LS.templates, prev.templates); lsSet(LS.settings, prev.settings);
  lsSet(LS.history, hist);
  location.reload();
}

/* ===== Models ===== */
class Contact {
  constructor({id=rid(), name="", email="", company="", phone="", tz="Australia/Sydney", segments=[], status="Active", lastSent=0, lastSentAt="", notes=[]}={}) {
    Object.assign(this, {id, name, email, company, phone, tz, segments, status, lastSent, lastSentAt, notes});
  }
}
class TemplateStep {
  constructor({id=rid(), step=1, active=true, subject="", body="", variantB=null}={}) {
    Object.assign(this, {id, step, active, subject, body, variantB});
  }
}
class Settings {
  constructor(o={}) {
    this.seqLen = o.seqLen ?? 7;
    this.defaultGap = o.defaultGap ?? 3;
    this.zohoDomain = o.zohoDomain ?? "mail.zoho.com";
    this.fromName = o.fromName ?? "HD HeeD";
    this.initials = o.initials ?? "HS";
    this.businessTime = o.businessTime ?? "09:00";
    this.sortKey = o.sortKey ?? "name";
    this.sortDir = o.sortDir ?? 1;
    this.locale = o.locale ?? "en-AU";
    this.rate = o.rate ?? 5;
    this.theme = o.theme ?? "light";
  }
}

/* ===== State ===== */
const state = {
  contacts: lsGet(LS.contacts, []),
  templates: lsGet(LS.templates, null),
  settings: new Settings(lsGet(LS.settings, {})),
  filter: "", filterStatus: ""
};

/* ===== Defaults (first 4 steps pulled from your idea) ===== */
const BASE4 = [
  { step:1, subject:"Welcome to HD HeeD — getting supports started", body:
`Hi {{Name}},

Thank you for connecting with HD HeeD. We provide RN-led NDIS supports (personal care, nursing, wound/stoma, bowel programs, medication administration and more). If helpful, I can outline simple next steps to get started.

Would you prefer a quick call or an email summary?

Kind regards,
Team HD HeeD
hdheed.com.au • 02 8630 5500` },
  { step:2, subject:"Just checking in — any questions I can help with?", body:
`Hi {{Name}},

Just following up my last email to see if you had any questions or needed anything from us. We’re ready to help whenever you are.

Warm regards,
Team HD HeeD` },
  { step:3, subject:"Short resource to help you plan first visits", body:
`Hi {{Name}},

Sharing a brief checklist families/support coordinators find useful to make first visits smooth (consents, goals, meds, equipment). Happy to tailor it if you share a few details.

Best,
Team HD HeeD` },
  { step:4, subject:"Quick reminder — we can line up supports quickly", body:
`Hi {{Name}},

We can organise visits quickly (often within a week). If you’d like, send a brief overview (or referral/plan) and I’ll propose options and timeframes.

Thanks,
Team HD HeeD` },
];

function ensureTemplates(){
  if(!state.templates){
    const out=[], N = state.settings.seqLen||7;
    for(let i=1;i<=N;i++){
      const base = BASE4.find(b=>b.step===i);
      out.push(new TemplateStep({ step:i, active:true,
        subject: base?base.subject:`Email ${i}`,
        body: base?base.body:`Hi {{Name}},\n\n...\n\nTeam HD HeeD`
      }));
    }
    state.templates = out;
    lsSet(LS.templates, state.templates);
  }
}

/* ===== Theme + Locale ===== */
function applyTheme(th){ document.documentElement.setAttribute("data-theme", th); }
applyTheme(state.settings.theme);

/* ===== Template Editor (with RTE) ===== */
function renderTemplates(){
  const box = $("#tpl-box"); box.innerHTML = "";
  clone(state.templates).sort((a,b)=>a.step-b.step).forEach(t=>{
    const div = document.createElement("div"); div.className="card"; div.style.margin="8px 0";
    div.innerHTML = `
      <div class="row">
        <strong>Step ${t.step}</strong>
        <span class="right small">
          <label class="row" style="gap:6px">
            <input type="checkbox" data-id="${t.id}" data-k="active" ${t.active!==false?"checked":""}> Active
          </label>
        </span>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <div><label>Subject (A)</label><input data-id="${t.id}" data-k="subject" value="${esc(t.subject||"")}"></div>
        <div><label>Subject (B)</label><input data-id="${t.id}" data-k="subjectB" value="${esc(t.variantB?.subject||"")}"></div>
        <div><label>Step</label><input value="${t.step}" readonly class="mono"></div>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <div>
          <label>Body (A)</label>
          <div class="rte" data-id="${t.id}" data-k="body" contenteditable="true">${esc(t.body||"")}</div>
        </div>
        <div>
          <label>Body (B)</label>
          <div class="rte" data-id="${t.id}" data-k="bodyB" contenteditable="true">${esc(t.variantB?.body||"")}</div>
        </div>
        <div>
          <label>Merge fields</label>
          <div class="small muted">Use {{Name}} {{Company}} {{Phone}}</div>
          <div class="rte-toolbar">
            <button data-insert="{{Name}}" class="btn ghost">+ Name</button>
            <button data-insert="{{Company}}" class="btn ghost">+ Company</button>
            <button data-insert="{{Phone}}" class="btn ghost">+ Phone</button>
          </div>
        </div>
      </div>`;
    box.appendChild(div);
  });
  $("#pill-len").textContent = `${state.settings.seqLen} steps`;
}

function saveTemplatesFromUI(){
  snapshot();
  const map = Object.fromEntries(state.templates.map(t=>[t.id,t]));
  $$("#tpl-box [data-id]").forEach(el=>{
    const id = el.dataset.id, k = el.dataset.k, T = map[id]; if(!T) return;
    if(el.tagName==="INPUT" && el.type==="checkbox"){ T.active = el.checked; }
    else if(el.tagName==="INPUT"){ if(k==="subject") T.subject = el.value; else if(k==="subjectB"){ T.variantB = T.variantB||{subject:"",body:""}; T.variantB.subject = el.value; } }
    else if(el.classList.contains("rte")){
      const v = el.innerText.replace(/\r\n/g,"\n");
      if(k==="body") T.body = v;
      if(k==="bodyB"){ T.variantB = T.variantB||{subject:"",body:""}; T.variantB.body = v; }
    }
  });
  lsSet(LS.templates, state.templates);
  audit("templates.save",{count: state.templates.length});
  toast("Templates saved.");
}

function insertAtCaret(text){
  const sel = window.getSelection?.(); if(!sel || !sel.rangeCount) return;
  const range = sel.getRangeAt(0); range.deleteContents();
  range.insertNode(document.createTextNode(text));
  range.collapse(false);
}

function bindRTE(){
  // bold/italic/list in preview panel
  $$("#preview .rte-toolbar [data-cmd]").forEach(b=> b.onclick = ()=>document.execCommand(b.dataset.cmd,false));
  // merge field buttons in templates
  $$("#tpl-box [data-insert]").forEach(b=> b.onclick = ()=>insertAtCaret(b.dataset.insert));
}

/* ===== Settings bindings ===== */
function bindSettings(){
  $("#seq-len").value = String(state.settings.seqLen);
  $("#default-gap").value = String(state.settings.defaultGap);
  $("#target-time").value = state.settings.businessTime;
  $("#zoho-domain").value = state.settings.zohoDomain;
  $("#from-name").value = state.settings.fromName;
  $("#initials").value = state.settings.initials;
  $("#theme").value = state.settings.theme;
  $("#locale").value = state.settings.locale;
  $("#rate-limit").value = String(state.settings.rate);

  $("#theme-toggle").onclick = ()=>{
    const seq = ["light","dark","contrast"];
    const idx = seq.indexOf(state.settings.theme);
    state.settings.theme = seq[(idx+1)%seq.length];
    $("#theme").value = state.settings.theme;
    lsSet(LS.settings, state.settings); applyTheme(state.settings.theme);
  };

  $("#theme").onchange = e=>{ state.settings.theme = e.target.value; lsSet(LS.settings, state.settings); applyTheme(state.settings.theme); };
  $("#seq-len").onchange = e=>{
    snapshot();
    const n = clamp(parseInt(e.target.value,10)||7,7,10);
    state.settings.seqLen = n;
    if(state.templates.length < n){
      for(let s=state.templates.length+1; s<=n; s++){
        state.templates.push(new TemplateStep({step:s,active:true,subject:`Email ${s}`,body:`Hi {{Name}},\n\n...\n\nTeam HD HeeD`}));
      }
    }else if(state.templates.length>n){
      state.templates = state.templates.slice(0,n);
    }
    lsSet(LS.settings, state.settings); lsSet(LS.templates, state.templates);
    renderTemplates(); bindRTE();
  };
  $("#default-gap").onchange = e=>{ state.settings.defaultGap = clamp(parseInt(e.target.value,10)||3,1,30); lsSet(LS.settings, state.settings); };
  $("#target-time").onchange = e=>{ state.settings.businessTime = e.target.value||"09:00"; lsSet(LS.settings, state.settings); };
  $("#zoho-domain").onchange = e=>{ state.settings.zohoDomain = e.target.value; lsSet(LS.settings, state.settings); };
  $("#from-name").onchange = e=>{ state.settings.fromName = e.target.value.trim()||"HD HeeD"; lsSet(LS.settings, state.settings); };
  $("#initials").onchange = e=>{ state.settings.initials = e.target.value.trim()||"HS"; lsSet(LS.settings, state.settings); };
  $("#locale").onchange = e=>{ state.settings.locale = e.target.value; lsSet(LS.settings, state.settings); renderContacts(); };
  $("#rate-limit").onchange = e=>{ state.settings.rate = clamp(parseInt(e.target.value,10)||5,1,10); lsSet(LS.settings, state.settings); };
}

/* ===== Init (Part 2) ===== */
window.__heed_init_part2 = function initPart2(){
  ensureTemplates();
  renderTemplates(); bindRTE(); bindSettings();
  // keyboard shortcuts
  document.addEventListener("keydown",(e)=>{
    if(e.key==="/"){ e.preventDefault(); $("#search").focus(); }
    if(e.key.toLowerCase()==="n"){ const openEditor = window.__heed_openEditor; openEditor && openEditor(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="z"){ e.preventDefault(); undo(); }
  });
};
})();
</script>
<script>
(() => {
"use strict";

/* ===== Utils reused ===== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const rid = ()=>Math.random().toString(36).slice(2,10);
const nowISO = ()=>new Date().toISOString();
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
const esc = (s="")=>s.replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
const lsGet = (k,d)=>{try{return JSON.parse(localStorage.getItem(k)) ?? d;}catch{return d;}};
const lsSet = (k,v)=>localStorage.setItem(k, JSON.stringify(v));
const fmt = (d,loc)=> d? new Date(d).toLocaleString(loc||"en-AU"): "—";
const toast = (msg)=>{const t=$("#toast");const d=document.createElement("div");d.className="item";d.textContent=msg;t.appendChild(d);setTimeout(()=>d.remove(),2500);};

/* ===== Link to Part 2 state ===== */
const ST = {
  contactsKey: "heed_contacts_v4",
  templatesKey: "heed_templates_v4",
  settingsKey: "heed_settings_v4",
  auditKey: "heed_audit_v1"
};
const state = {
  get contacts(){return lsGet(ST.contactsKey,[])},
  set contacts(v){lsSet(ST.contactsKey,v)},
  get templates(){return lsGet(ST.templatesKey,[])},
  set templates(v){lsSet(ST.templatesKey,v)},
  get settings(){return lsGet(ST.settingsKey,{})},
  set settings(v){lsSet(ST.settingsKey,v)}
};
function audit(event,payload){ const logs=lsGet(ST.auditKey,[]); logs.push({id:rid(),at:nowISO(),event,payload}); lsSet(ST.auditKey,logs); }

/* ===== Core sequencing ===== */
function nextStepFor(c){
  const N = state.settings.seqLen||7;
  if((c.status||"Active")==="Completed") return 0;
  const last = c.lastSent||0;
  for(let s=last+1; s<=N; s++){
    const t = state.templates.find(x=>x.step===s);
    if(t && t.active!==false) return s;
  }
  return 0;
}
function dueDateFor(c){
  const gap = state.settings.defaultGap||3;
  const [hh,mm] = (state.settings.businessTime||"09:00").split(":").map(x=>parseInt(x,10)||0);
  const d = new Date();
  if(!c.lastSentAt){ d.setHours(hh,mm,0,0); return d; }
  const base = new Date(c.lastSentAt);
  base.setDate(base.getDate()+gap);
  base.setHours(hh,mm,0,0);
  return base;
}
function progressPct(c){
  const N = state.settings.seqLen||7;
  return Math.round((Math.min(c.lastSent||0,N)/N)*100);
}

/* ===== Merge & Build ===== */
function buildEmail(c, step){
  const tpl = state.templates.find(t=>t.step===step);
  const name = c.name || "there", company = c.company||"", phone=c.phone||"";
  let useB = false;
  if(tpl?.variantB && tpl.variantB.subject && tpl.variantB.body){
    const h = [...c.id].reduce((a,ch)=>a+ch.charCodeAt(0),0);
    useB = (h % 2)===0;
  }
  const sub = (useB ? tpl?.variantB?.subject : tpl?.subject) || "";
  const bod = (useB ? tpl?.variantB?.body : tpl?.body) || "";
  const subject = sub.replaceAll("{{Name}}",name).replaceAll("{{Company}}",company).replaceAll("{{Phone}}",phone);
  const body = bod.replaceAll("{{Name}}",name).replaceAll("{{Company}}",company).replaceAll("{{Phone}}",phone);
  return { subject, body, variant: useB?"B":"A" };
}

/* ===== Render table ===== */
function bySort(key, dir){
  return (a,b)=>{
    const v = (k,o)=>k==="name"?(o.name||"").toLowerCase()
      :k==="email"?(o.email||"").toLowerCase()
      :k==="status"?(o.status||"")
      :k==="last"?(o.lastSentAt||"")
      :k==="next"? nextStepFor(o)||999
      :k==="progress"? ((o.lastSent||0))
      :(o.name||"");
    const va=v(key,a), vb=v(key,b);
    if(va<vb) return -1*dir; if(va>vb) return 1*dir; return 0;
  };
}
function renderContacts(){
  const contacts = state.contacts;
  // stats
  const today = new Date(); today.setHours(23,59,59,999);
  const due = contacts.filter(c=> (c.status||"Active")==="Active" && nextStepFor(c) && dueDateFor(c)<=today );
  const completed = contacts.filter(c=> (c.status||"Active")==="Completed");
  const active = contacts.filter(c=> (c.status||"Active")==="Active");
  $("#due-count").textContent = String(due.length);
  $("#completed-count").textContent = String(completed.length);
  $("#active-count").textContent = String(active.length);

  // filter
  const f = ($("#search").value||"").toLowerCase();
  const fs = $("#filter-status").value||"";
  const key = $("#sort-key").value || (state.settings.sortKey||"name");
  const dir = state.settings.sortDir||1;

  const rows = contacts
    .filter(c=>{
      if(f){
        const k = `${c.name||""} ${c.email||""} ${c.company||""} ${c.phone||""}`.toLowerCase();
        if(!k.includes(f)) return false;
      }
      if(fs && (c.status||"Active")!==fs) return false;
      return true;
    })
    .sort(bySort(key, dir));

  const tbody = $("#rows"); tbody.innerHTML = "";
  rows.forEach(c=> tbody.appendChild(rowFor(c)));
  renderAnalytics();
}
function rowFor(c){
  const tpl = $("#row-tpl").content.cloneNode(true);
  const tr = tpl.querySelector("tr"); tr.dataset.id = c.id;
  $(".c-name",tr).textContent = c.name || "—";
  $(".c-company",tr).textContent = c.company || "";
  $(".c-email",tr).textContent = c.email || "—";
  $(".c-seg",tr).textContent = (c.segments&&c.segments[0])? c.segments[0] : "—";

  const s = c.status||"Active";
  const st = $(".c-status",tr); st.textContent = s;
  st.className = "tag c-status " + (s==="Paused"?"warn":s==="Completed"?"ok":"");

  $(".c-last",tr).textContent = c.lastSent? `Email ${c.lastSent} @ ${fmt(c.lastSentAt,state.settings.locale)}` : "—";
  const next = nextStepFor(c);
  $(".c-next",tr).textContent = next? `Email ${next}` : "Done";
  $(".c-due",tr).textContent = next? `Due: ${fmt(dueDateFor(c),state.settings.locale)}` : "—";

  const pct = progressPct(c);
  $(".c-prog",tr).style.width = pct+"%";
  $(".c-prog-label",tr).textContent = `${pct}% (${c.lastSent||0}/${state.settings.seqLen||7})`;

  $(".notes-count",tr).textContent = String(c.notes?.length||0);

  $(".btn-notes",tr).onclick = ()=>openNotes(c.id);
  $(".btn-preview",tr).onclick = ()=>openPreview(c.id);
  $(".btn-send",tr).onclick = ()=>sendNext(c.id);
  $(".btn-mark",tr).onclick = ()=>markSent(c.id);
  $(".btn-del",tr).onclick = ()=>delContact(c.id);
  return tr;
}

/* ===== Notes ===== */
let NOTES_ID = "";
function openNotes(id){
  const c = state.contacts.find(x=>x.id===id); if(!c) return;
  NOTES_ID = id;
  $("#notes-for").textContent = c.name || c.email || "Contact";
  const box = $("#notes-list"); box.innerHTML = "";
  (c.notes||[]).forEach(n=>{
    const div = document.createElement("div"); div.style.marginBottom="8px";
    div.innerHTML = `<div class="small muted">${fmt(n.at,state.settings.locale)} — <strong>${esc(n.by||"")}</strong></div><div>${esc(n.text||"")}</div>`;
    box.appendChild(div);
  });
  if(!c.notes?.length) box.innerHTML = `<div class="small muted">No notes yet.</div>`;
  $("#note-text").value = "";
  $("#notes").style.display = "";
  $("#notes").focus();
}
function addNote(){
  const t = $("#note-text").value.trim(); if(!t) return;
  const c = state.contacts.find(x=>x.id===NOTES_ID); if(!c) return;
  (c.notes=c.notes||[]).push({ at: nowISO(), by:(state.settings.initials||"User"), text: t });
  lsSet(ST.contactsKey, state.contacts);
  openNotes(NOTES_ID);
  audit("note.add",{contact:NOTES_ID});
}
window.__heed_openNotes = openNotes;

/* ===== Preview & Send ===== */
let PV_ID="";
function openPreview(id){
  const c = state.contacts.find(x=>x.id===id); if(!c) return;
  const step = nextStepFor(c); if(!step) return toast("Sequence complete");
  const {subject, body, variant} = buildEmail(c, step);
  PV_ID = id;
  $("#pv-subj").value = subject||"(no subject)";
  $("#pv-to").value = c.email||"";
  $("#pv-variant").value = variant;
  $("#pv-body").innerText = body||"";
  $("#preview").style.display = "";
  $("#preview").focus();
}
function sendFromPreview(){ if(PV_ID) sendNext(PV_ID); }
function restoreFromTemplate(){
  if(!PV_ID) return;
  const c = state.contacts.find(x=>x.id===PV_ID); if(!c) return;
  const step = nextStepFor(c); if(!step) return;
  const {body} = buildEmail(c, step);
  $("#pv-body").innerText = body||"";
}
function sendNext(id){
  const c = state.contacts.find(x=>x.id===id); if(!c) return;
  const step = nextStepFor(c); if(!step) return toast("Sequence complete");
  const subj = $("#pv-subj").value || buildEmail(c, step).subject;
  const body = ($("#pv-body").innerText||"").trim() || buildEmail(c, step).body;

  // rate limiter (avoid opening too many compose windows)
  const allowed = Number(state.settings.rate||5);
  window.__rateCounter = (window.__rateCounter||0) + 1;
  if(window.__rateCounter>allowed){ toast(`Popup limit reached (${allowed}). Try again.`); return; }
  setTimeout(()=>{ window.__rateCounter = Math.max(0,(window.__rateCounter||1)-1); }, 2000);

  const dom = state.settings.zohoDomain||"mail.zoho.com";
  const url = `https://${dom}/zm/#compose?to=${encodeURIComponent(c.email||"")}&subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
  window.open(url, "_blank");
  audit("send.compose",{contact:id, step});
}

/* ===== Mark / Delete / Editor ===== */
function markSent(id){
  const cs = state.contacts;
  const i = cs.findIndex(x=>x.id===id); if(i<0) return;
  const step = nextStepFor(cs[i]); if(!step) return toast("Sequence complete");
  cs[i].lastSent = step; cs[i].lastSentAt = nowISO();
  if(step >= (state.settings.seqLen||7)) cs[i].status = "Completed";
  (cs[i].notes=cs[i].notes||[]).push({at: nowISO(), by: (state.settings.initials||"User"), text:`Marked Email ${step} as sent.`});
  state.contacts = cs; renderContacts(); audit("send.mark",{contact:id,step});
}
function delContact(id){
  if(!confirm("Delete this contact?")) return;
  const cs = state.contacts.filter(x=>x.id!==id);
  state.contacts = cs; renderContacts(); audit("contact.delete",{contact:id});
}
function openEditor(contact){
  $("#editor").style.display = "";
  $("#ed-h").textContent = contact? "Edit Contact":"Add Contact";
  $("#ed-name").value = contact?.name || "";
  $("#ed-email").value = contact?.email || "";
  $("#ed-company").value = contact?.company || "";
  $("#ed-phone").value = contact?.phone || "";
  $("#ed-tz").value = contact?.tz || "Australia/Sydney";
  $("#ed-seg").value = (contact?.segments||[]).join(", ");
  $("#ed-initials").value = state.settings.initials || "HS";
  $("#editor").dataset.id = contact?.id || "";
}
function saveContact(){
  const id = $("#editor").dataset.id || "";
  const obj = {
    id: id || rid(),
    name: $("#ed-name").value.trim(),
    email: $("#ed-email").value.trim(),
    company: $("#ed-company").value.trim(),
    phone: $("#ed-phone").value.trim(),
    tz: $("#ed-tz").value.trim()||"Australia/Sydney",
    segments: ($("#ed-seg").value||"").split(",").map(s=>s.trim()).filter(Boolean)
  };
  if($("#ed-initials").value.trim()){ const s = state.settings; s.initials = $("#ed-initials").value.trim(); state.settings = s; }
  const cs = state.contacts;
  if(id){ const i = cs.findIndex(x=>x.id===id); if(i>=0) cs[i] = {...cs[i], ...obj}; }
  else cs.push({ ...new Object(obj), status:"Active", lastSent:0, lastSentAt:"", notes:[] });
  state.contacts = cs; $("#editor").style.display="none"; renderContacts(); audit("contact.save",{id: obj.id});
}
window.__heed_openEditor = ()=>openEditor();

/* ===== Import/Export ===== */
function exportJSON(){
  const blob = new Blob([JSON.stringify({contacts:state.contacts,templates:state.templates,settings:state.settings},null,2)],{type:"application/json"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
  a.download = `heed-followups-${new Date().toISOString().slice(0,10)}.json`; a.click();
}
async function importJSONFile(file){
  const text = await file.text(); const data = JSON.parse(text);
  if(!confirm("Import will overwrite local data. Continue?")) return;
  if(data.contacts) state.contacts = data.contacts;
  if(data.templates) state.templates = data.templates;
  if(data.settings) state.settings = {...state.settings, ...data.settings};
  location.reload();
}
function exportCSV(){
  const headers = ["id","name","email","company","phone","tz","segments","status","lastSent","lastSentAt","notesCount"];
  const rows = state.contacts.map(c=>[
    c.id, q(c.name), q(c.email), q(c.company), q(c.phone), q(c.tz), q((c.segments||[]).join("|")),
    c.status||"Active", c.lastSent||0, c.lastSentAt||"", (c.notes||[]).length
  ]);
  const csv = [headers.join(","), ...rows.map(r=>r.join(","))].join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
  a.download = `heed-contacts-${new Date().toISOString().slice(0,10)}.csv`; a.click();
  function q(s){ const t=(s??"").toString().replace(/"/g,'""'); return `"${t}"`; }
}
async function importCSVFile(file){
  const text = await file.text();
  const lines = text.split(/\r?\n/).filter(Boolean);
  if(lines.length<2) return alert("CSV has no data");
  const hdr = lines[0].split(",").map(h=>h.trim());
  const rows = lines.slice(1).map(line=>{
    const out=[]; let cur="",inq=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"' && line[i+1]==='"'){ cur+='"'; i++; continue; }
      if(ch==='"'){ inq=!inq; continue; }
      if(ch===',' && !inq){ out.push(cur); cur=""; continue; }
      cur+=ch;
    } out.push(cur); return out;
  });
  const cs = state.contacts;
  rows.forEach(r=>{
    const obj = Object.fromEntries(hdr.map((h,i)=>[h, r[i]??""]));
    const id = obj.id || rid();
    const idx = obj.email? cs.findIndex(x=>x.email===obj.email) : -1;
    const c = { id,
      name: obj.name||"", email: obj.email||"", company: obj.company||"", phone: obj.phone||"",
      tz: obj.tz||"Australia/Sydney", segments: (obj.segments||"").split("|").filter(Boolean),
      status: obj.status||"Active", lastSent: Number(obj.lastSent||0), lastSentAt: obj.lastSentAt||"", notes: []
    };
    if(idx>=0) cs[idx] = {...cs[idx], ...c}; else cs.push(c);
  });
  state.contacts = cs; renderContacts();
}

/* ===== Analytics ===== */
function renderAnalytics(){
  const cs = state.contacts; const N = state.settings.seqLen||7;
  if(!cs.length){ $("#an-complete").textContent="—"; $("#an-avgstep").textContent="—"; $("#an-notes").textContent="—"; return; }
  const completed = cs.filter(c=>c.status==="Completed").length;
  const avgStep = cs.reduce((a,c)=>a+(c.lastSent||0),0)/cs.length;
  const notes = cs.reduce((a,c)=>a+(c.notes?.length||0),0);
  $("#an-complete").textContent = `${Math.round((completed/cs.length)*100)}% (${completed}/${cs.length})`;
  $("#an-avgstep").textContent = `${avgStep.toFixed(2)} / ${N}`;
  $("#an-notes").textContent = String(notes);
}

/* ===== ICS (next due batch) ===== */
function exportICS(){
  const today = new Date(); today.setHours(23,59,59,999);
  const due = state.contacts.filter(c=> (c.status||"Active")==="Active" && nextStepFor(c) && dueDateFor(c)<=today );
  if(!due.length){ toast("No contacts due today"); return; }
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "Australia/Sydney";
  const escICS = s=>s.replace(/\\n/g,"\\n").replace(/,/g,"\\,").replace(/;/g,"\\;");
  const lines = ["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//HD HeeD//Sequencer//EN"];
  due.slice(0,20).forEach(c=>{
    const dt = dueDateFor(c);
    const pad = n=>String(n).padStart(2,"0");
    const stamp = `${dt.getUTCFullYear()}${pad(dt.getUTCMonth()+1)}${pad(dt.getUTCDate())}T${pad(dt.getUTCHours())}${pad(dt.getUTCMinutes())}00Z`;
    const step = nextStepFor(c);
    const {subject} = buildEmail(c, step);
    lines.push("BEGIN:VEVENT");
    lines.push(`UID:${c.id}@hdheed`);
    lines.push(`DTSTAMP:${stamp}`);
    lines.push(`DTSTART:${stamp}`);
    lines.push(`SUMMARY:${escICS(`Email ${step} to ${c.name||c.email||"Contact"} — ${subject.slice(0,70)}`)}`);
    lines.push(`DESCRIPTION:${escICS(`Prepare and send via ZohoCompose to ${c.email}`)}`);
    lines.push("END:VEVENT");
  });
  lines.push("END:VCALENDAR");
  const ics = lines.join("\r\n");
  const blob = new Blob([ics],{type:"text/calendar"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "hdheed_next_due.ics"; a.click();
}

/* ===== Init (Part 3) ===== */
window.__heed_init_part3 = function initPart3(){
  // bindings
  $("#search").oninput = ()=>renderContacts();
  $("#filter-status").onchange = ()=>renderContacts();
  $("#sort-key").onchange = ()=>{ const s=state.settings; s.sortKey=$("#sort-key").value; state.settings=s; renderContacts(); };

  $("#view-due").onclick = ()=>{
    const today = new Date(); today.setHours(23,59,59,999);
    const due = state.contacts.filter(c=> (c.status||"Active")==="Active" && nextStepFor(c) && dueDateFor(c)<=today );
    if(!due.length){ alert("No contacts due today."); return; }
    const msg = due.map(c=>`• ${c.name||c.email||"Contact"} — Next: Email ${nextStepFor(c)} (Due ${fmt(dueDateFor(c),state.settings.locale)})`).join("\n");
    alert(`Due today:\n\n${msg}`);
  };
  $("#batch-send").onclick = ()=>{
    const today = new Date(); today.setHours(23,59,59,999);
    const due = state.contacts.filter(c=> (c.status||"Active")==="Active" && nextStepFor(c) && dueDateFor(c)<=today );
    if(!due.length){ toast("No contacts due today."); return; }
    const dom = state.settings.zohoDomain || "mail.zoho.com";
    let opened=0, allowed=Number(state.settings.rate||5);
    due.slice(0,allowed).forEach(c=>{
      const step = nextStepFor(c);
      const {subject, body} = buildEmail(c, step);
      const url = `https://${dom}/zm/#compose?to=${encodeURIComponent(c.email||"")}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      const win = window.open(url, "_blank"); if(win) opened++;
    });
    toast(`Opened ${opened} Zoho compose tabs (browser may limit).`);
  };
  $("#export-ics").onclick = exportICS;

  $("#pv-copy").onclick = ()=>navigator.clipboard.writeText($("#pv-body").innerText||"");
  $("#pv-send").onclick = ()=>sendFromPreview();
  $("#pv-restore").onclick = ()=>restoreFromTemplate();
  $("#pv-close").onclick = ()=>{ $("#preview").style.display="none"; };

  $("#add-contact").onclick = ()=>openEditor();
  $("#ed-cancel").onclick = ()=>$("#editor").style.display="none";
  $("#ed-save").onclick = ()=>saveContact();

  $("#note-add").onclick = ()=>addNote();
  $("#notes-close").onclick = ()=>$("#notes").style.display="none";

  $("#export-json").onclick = exportJSON;
  $("#import-json").onchange = e=>{ const f=e.target.files?.[0]; if(f) importJSONFile(f); };
  $("#export-csv").onclick = exportCSV;
  $("#import-csv").onchange = e=>{ const f=e.target.files?.[0]; if(f) importCSVFile(f); };

  // shortcuts
  document.addEventListener("keydown",(e)=>{
    if(e.key==="/"){ e.preventDefault(); $("#search").focus(); }
    if(e.key.toLowerCase()==="n"){ openEditor(); }
  });

  renderContacts();
};
})();
</script>
<script>
(() => {
"use strict";

/* ===== Boot sequence that stitches Parts 2 & 3 ===== */
function boot(){
  if(window.__heed_init_part2) window.__heed_init_part2();
  if(window.__heed_init_part3) window.__heed_init_part3();
}
document.addEventListener("DOMContentLoaded", boot);

/* ===== Simple SW registration with inline blob ===== */
if('serviceWorker' in navigator){
  try{
    const swCode = `
      const CACHE='heed-v1';
      self.addEventListener('install',e=>{
        e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./followup.html'])));
      });
      self.addEventListener('fetch',e=>{
        e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
      });
    `;
    const blob = new Blob([swCode],{type:'text/javascript'});
    const url = URL.createObjectURL(blob);
    navigator.serviceWorker.register(url);
  }catch(e){}
}

/* ===== Little help modal ===== */
const modal = $("#modal"), backdrop = $("#backdrop");
function openModal(html){
  modal.innerHTML = html + `<div class="row" style="margin-top:12px;justify-content:flex-end"><button id="m-close" class="btn">Close</button></div>`;
  backdrop.style.display = "flex"; backdrop.setAttribute("aria-hidden","false");
  modal.focus();
  $("#m-close").onclick = closeModal;
}
function closeModal(){ backdrop.style.display="none"; backdrop.setAttribute("aria-hidden","true"); }
backdrop.addEventListener("click", e=>{ if(e.target===backdrop) closeModal(); });

/* ===== Help content ===== */
function helpHTML(){
  return `
  <h3>Quick help</h3>
  <ul class="small">
    <li><strong>Templates:</strong> Edit subjects/bodies. Use {{Name}}, {{Company}}, {{Phone}}. Optionally fill Variant B for A/B.</li>
    <li><strong>Contacts:</strong> Add name/email/company/phone/timezone/segments. Status auto-updates on <em>Mark Sent</em>.</li>
    <li><strong>Send Next:</strong> Opens Zoho compose (prefilled). Use <em>Batch Prepare</em> for due contacts.</li>
    <li><strong>Analytics:</strong> Completion %, average step, total notes.</li>
    <li><strong>Backup:</strong> Export JSON/CSV; Import to restore/merge.</li>
    <li><strong>Keyboard:</strong> <kbd>/</kbd> search, <kbd>N</kbd> new contact, <kbd>Ctrl/⌘+Z</kbd> undo (local).</li>
  </ul>`;
}

/* ===== Global minor actions ===== */
document.addEventListener("keydown",(e)=>{
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="/"){ e.preventDefault(); openModal(helpHTML()); }
});
document.querySelector(".title")?.addEventListener("click",()=>openModal(helpHTML()));

/* ===== Expose for console debugging (optional) ===== */
window.__heed_debug = {
  getState: ()=>({contacts:localStorage.getItem("heed_contacts_v4"),templates:localStorage.getItem("heed_templates_v4"),settings:localStorage.getItem("heed_settings_v4")}),
  clearAll: ()=>{localStorage.removeItem("heed_contacts_v4");localStorage.removeItem("heed_templates_v4");localStorage.removeItem("heed_settings_v4");localStorage.removeItem("heed_audit_v1");localStorage.removeItem("heed_history_v1");},
};
})();
</script>

<!-- Footer -->
<div class="wrap" style="margin-bottom:40px">
  <section class="card" style="margin-top:16px">
    <h2>How to Use</h2>
    <div class="hr"></div>
    <ol class="small" style="line-height:1.6">
      <li><strong>Set sequence length:</strong> Choose 7–10 and edit subjects/bodies (use {{Name}} / {{Company}} / {{Phone}}). Click <em>Save Templates</em>.</li>
      <li><strong>Add contacts:</strong> Name/email/company/phone/timezone/segments supported. Track last sent, next step, next due.</li>
      <li><strong>Send next:</strong> Click <em>Send Next</em> — Zoho compose opens with To/Subject/Body prefilled. Press <em>Send</em>.</li>
      <li><strong>Mark sent:</strong> After sending, click <em>Mark Sent</em> (timestamped note + progress).</li>
      <li><strong>Due tools:</strong> <em>Show Due</em>, <em>Batch Prepare</em>, and <em>Export ICS</em> for calendar reminders.</li>
      <li><strong>Backup:</strong> JSON (<em>full</em>) and CSV (<em>contacts</em>).</li>
      <li><strong>Offline:</strong> install as PWA; works without network once cached.</li>
    </ol>
    <div class="small muted">Publish this as <code>followup.html</code> on your site. If you want **server-side sending as info@hdheed.com.au**, we can add a Zoho Flow webhook version next.</div>
  </section>
  <footer class="small muted" style="text-align:center;margin:24px 0 0">
    HD HeeD • “Because we care, we provide HD care.” • v1.1 (master features)
  </footer>
</div>

</body>
</html>
