<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Try our Extremely Interactive Referral | HD HeeD</title>
  <meta name="description" content="Ultra-interactive NDIS referral for HD HeeD. Works on GitHub Pages. All questions optional with 'Not sure' options."/>
  <style>
    :root{--bg:#0b1220;--ink:#0b1220;--card:#fff;--muted:#6b7280;--ring:#93c5fd;--brand:#2563eb;--brand2:#22c55e;--danger:#ef4444}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,#0b1220,#111827 60%);color:#e5e7eb;display:flex;justify-content:center;padding:24px}
    .shell{width:100%;max-width:1100px}
    .card{background:var(--card);color:var(--ink);border-radius:22px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.45)}
    header{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:20px 22px;border-bottom:1px solid #e5e7eb}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(160deg,var(--brand),var(--brand2));box-shadow:inset 0 0 18px rgba(255,255,255,.25)}
    .title{font-weight:800;letter-spacing:.2px}
    .subtitle{color:#64748b;font-size:.92rem}
    .progress{height:10px;background:#eef2f7;border-radius:999px;overflow:hidden;width:320px}
    .progress>div{height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--brand2))}
    main{display:grid;grid-template-columns:280px 1fr;min-height:760px}
    @media (max-width:920px){main{grid-template-columns:1fr}}
    nav{background:#f8fafc;border-right:1px solid #e5e7eb;padding:18px;display:flex;flex-direction:column;gap:8px}
    .step-link{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:12px;cursor:pointer;color:#111827;text-decoration:none;border:1px solid transparent}
    .step-link.active{background:#eaf2ff;border-color:#dbeafe}.step-link.done .dot{background:var(--brand2)}
    .dot{width:10px;height:10px;border-radius:50%;background:#cbd5e1}.badge{margin-left:auto;font-size:.75rem;color:#475569}
    .pane{padding:24px 24px 28px}.block{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:18px;margin-bottom:16px}
    h2{margin:.25rem 0 .5rem 0}.muted{color:#6b7280}
    .grid{display:grid;gap:14px}.two{grid-template-columns:repeat(2,minmax(0,1fr))}.three{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:720px){.two,.three{grid-template-columns:1fr}}
    label{font-weight:700;font-size:.95rem;color:#111827}
    input,select,textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #e5e7eb;outline:none;background:#fff}
    input:focus,select:focus,textarea:focus{box-shadow:0 0 0 4px var(--ring)} textarea{min-height:110px}
    .yn3{display:grid;grid-template-columns:1fr 1fr 1fr;background:#f1f5f9;border-radius:12px;overflow:hidden}
    .yn3 button{appearance:none;padding:10px 12px;border:none;background:transparent;cursor:pointer;font-weight:700}
    .yn3 button[aria-pressed="true"]{background:#e0ecff}
    .btn-row{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
    .btn{appearance:none;border:none;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    .primary{background:var(--brand);color:#fff}.ghost{background:#eef2f7}.danger{background:var(--danger);color:#fff}
    .hint{font-size:.85rem;color:#64748b}
    .review{background:#fcfcfd;border:1px dashed #cbd5e1;border-radius:14px;padding:16px}
    pre{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px;max-height:280px;overflow:auto}
    .toast{position:fixed;inset:auto 20px 20px auto;background:#111827;color:#fff;padding:12px 14px;border-radius:12px;opacity:0;pointer-events:none;transition:.2s;box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <div class="shell">
    <div class="card" role="form" aria-labelledby="form-title">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <div id="form-title" class="title">Try our Extremely Interactive Referral</div>
            <div class="subtitle">Everything is optional. Choose <strong>Not sure</strong> any time — we’ll discuss later.</div>
          </div>
        </div>
        <div class="progress" aria-label="Progress"><div id="bar"></div></div>
      </header>
      <main>
        <nav id="steps"></nav>
        <section class="pane" id="pane"></section>
      </main>
    </div>
  </div>

  <!-- Hidden native form post (no branding shown) -->
  <form id="silentPost" action="https://formspree.io/f/xvgrkkjn" method="POST" enctype="multipart/form-data" style="display:none;">
    <input type="hidden" name="_subject" value="">
    <input type="hidden" name="_redirect" value="https://himmatpals.github.io/hd-heed-website/thankyou.html">
    <input type="text" name="_gotcha" value="">
  </form>

  <div class="toast" id="toast">Saved</div>

  <script>
    // === CONFIG ===
    const AUTOSAVE_KEY  = "hdheed_referral_final_v1";

    // === STATE / UTIL ===
    const state = JSON.parse(localStorage.getItem(AUTOSAVE_KEY) || "{}");
    const $ = (s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const save = ()=>{ localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(state)); flash("Saved"); };
    const flash = (m)=>{ const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1200); };

    // === WIZARD STEPS ===
    const Steps = [
      {id:"consent",     label:"Consent",              render:rConsent},
      {id:"referrer",    label:"Person Making Referral",render:rReferrer},
      {id:"participant", label:"Participant Details",  render:rParticipant},
      {id:"carer",       label:"Primary Carer (NOK)",  render:rCarer},
      {id:"safety",      label:"Safety & Risks",       render:rSafety},
      {id:"supports",    label:"Supports",             render:rSupports},
      {id:"funding",     label:"Funding & Plan",       render:rFunding},
      {id:"goals",       label:"NDIS Goals",           render:rGoals},
      {id:"review",      label:"Review & Consent",     render:rReview},
      {id:"submit",      label:"Submit",               render:rSubmit},
    ];
    let current = 0;

    // === NAV ===
    function init(){ renderNav(); go(0); }
    function renderNav(){
      const nav=$("#steps"); nav.innerHTML="";
      Steps.forEach((s,i)=>{ const a=document.createElement("a");
        a.className="step-link"; a.innerHTML=`<span class="dot"></span><span>${i+1}. ${s.label}</span><span class="badge" id="b-${s.id}"></span>`;
        a.href="#"; a.onclick=e=>{e.preventDefault(); go(i)}; nav.appendChild(a);
      });
    }
    function setActive(){
      $$(".step-link").forEach((el,i)=>{ el.classList.toggle("active",i===current); el.classList.toggle("done",i<current); });
      $("#bar").style.width = Math.round((current)/(Steps.length-1)*100)+"%";
    }
    function go(i){ current=Math.max(0,Math.min(Steps.length-1,i)); setActive(); const pane=$("#pane"); pane.innerHTML=""; Steps[current].render(pane); window.scrollTo({top:0,behavior:"smooth"}); }

    // === FIELD HELPERS ===
    function input(id,label,o={}){const{type="text",placeholder="",hint=""}=o; const v = state[id]??"";
      return `<div><label for="${id}">${label}</label>
      <input id="${id}" name="${id}" type="${type}" placeholder="${placeholder}" value="${v??""}"/>
      ${hint?`<div class="hint">${hint}</div>`:""}</div>`}
    function select(id,label,opts){const v=state[id]??""; return `<div><label for="${id}">${label}</label>
      <select id="${id}">${["<option value=''>Not sure / discuss later</option>",...opts.map(x=>`<option ${v===x?"selected":""}>${x}</option>`)].join("")}</select></div>`}
    function yn3(id,label){const v=state[id]; return `<div><label>${label}</label>
      <div class="yn3"><button type="button" data-yn3="${id}" data-v="yes" aria-pressed="${v==='yes'}">Yes</button>
      <button type="button" data-yn3="${id}" data-v="no" aria-pressed="${v==='no'}">No</button>
      <button type="button" data-yn3="${id}" data-v="unsure" aria-pressed="${v==='unsure'}">Not sure</button></div></div>`}
    function bindModel(root){ $$("input,select,textarea",root).forEach(el=>{const k=el.id;if(!k)return; el.value=state[k]??""; el.addEventListener("input",()=>{ state[k]=el.type==="checkbox"?el.checked:el.value; save(); }); el.addEventListener("change",()=>{ state[k]=el.type==="checkbox"?el.checked:el.value; save(); }); }); }
    function bindYN3(root){ $$("[data-yn3]",root).forEach(btn=>btn.addEventListener("click",()=>{const k=btn.dataset.yn3; state[k]=btn.dataset.v; save(); $$(`[data-yn3='${k}']`,root).forEach(b=>b.setAttribute("aria-pressed", String(b===btn))); })); }

    // === RENDERS ===
    function rConsent(p){ p.innerHTML = `<div class="block">
      <h2>Consent</h2>
      ${yn3("consent","Has the Participant or Primary Carer consented to this referral?")}
      <div class="hint">If you're not sure, choose <strong>Not sure</strong>. We can discuss consent before we proceed.</div>
      <div class="btn-row"><button class="btn primary" id="next">Next</button></div></div>`;
      $("#next",p).onclick=e=>{e.preventDefault(); go(1)}; bindYN3(p);
    }

    function rReferrer(p){ p.innerHTML = `<div class="block">
      <h2>Person Making Referral</h2>
      ${input("referrer_name","Full Name")}
      ${input("relationship","Relationship to Participant")}
      <div class="grid two">${input("phone","Phone",{type:"tel"})}${input("mobile","Mobile",{type:"tel"})}</div>
      ${input("email","Email",{type:"email",hint:"We'll send a confirmation"})}
      <div class="btn-row"><button class="btn ghost" id="back">Back</button><button class="btn primary" id="next">Next</button></div></div>`;
      $("#back",p).onclick=e=>{e.preventDefault(); go(0)}; $("#next",p).onclick=e=>{e.preventDefault(); go(2)};
      bindModel(p);
    }

    function rParticipant(p){
      p.innerHTML = `<div class="block"><h2>Participant Details</h2>
        <div class="grid two">${input("participant_fname","First Name")}${input("participant_lname","Last Name")}</div>
        <div class="grid two">${input("title","Title")}${input("dob","Date of Birth",{type:"date"})}</div>
        <div class="grid two">${input("ndis_number","NDIS Number")}${input("marital_status","Marital Status")}</div>
        <div class="grid two"><div><label>Gender</label>
          <div class="yn3"><button type="button" data-yn3="gender" data-v="male" aria-pressed="${state.gender==='male'}">Male</button>
          <button type="button" data-yn3="gender" data-v="female" aria-pressed="${state.gender==='female'}">Female</button>
          <button type="button" data-yn3="gender" data-v="unsure" aria-pressed="${state.gender==='unsure'}">Not sure</button></div></div>
          ${input("language","Language")}</div>
        <div class="grid two">${input("street","Street Address")}${input("suburb","Suburb")}</div>
        <div class="grid three">${input("city","City")}${input("postcode","Postcode",{hint:"4-digit"})}${input("home_phone","Home Phone",{type:"tel"})}</div>
        <div class="grid two">${input("participant_mobile","Mobile",{type:"tel"})}${input("participant_email","Email",{type:"email"})}</div>
        ${yn3("interpreter","Is Interpreter Required?")}
        ${input("interpreter_type","If yes, which language / type?")}
        <div class="btn-row"><button class="btn ghost" id="back">Back</button><button class="btn primary" id="next">Next</button></div></div>`;
      $("#back",p).onclick=e=>{e.preventDefault(); go(1)}; $("#next",p).onclick=e=>{e.preventDefault(); go(3)};
      bindModel(p); bindYN3(p);
    }

    function rCarer(p){
      p.innerHTML = `<div class="block"><h2>Primary Carer (Next of Kin)</h2>
        <div class="grid two">${input("carer_fname","First Name")}${input("carer_lname","Last Name")}</div>
        ${input("carer_relationship","Relationship")}
        <div class="grid two">${input("carer_street","Street Address")}${input("carer_suburb","Suburb")}</div>
        <div class="grid three">${input("carer_city","City")}${input("carer_postcode","Postcode")}${input("carer_home","Home Phone",{type:"tel"})}</div>
        <div class="grid two">${input("carer_mobile","Mobile",{type:"tel"})}${input("carer_email","Email",{type:"email"})}</div>
        ${yn3("custody","Shared Care / Custody Arrangement?")}
        <div class="btn-row"><button class="btn ghost" id="back">Back</button><button class="btn primary" id="next">Next</button></div></div>`;
      $("#back",p).onclick=e=>{e.preventDefault(); go(2)}; $("#next",p).onclick=e=>{e.preventDefault(); go(4)};
      bindModel(p); bindYN3(p);
    }

    function rSafety(p){
      p.innerHTML = `<div class="block"><h2>Safety & Immediate Risks</h2>
        ${yn3("recent_fall","Has the participant had a recent fall?")}
        ${yn3("wound","Is there a wound / post-op site requiring care?")}
        ${yn3("uncontrolled_pain","Uncontrolled pain?")}
        ${yn3("pressure_risk","At risk of pressure injury?")}
        ${yn3("behaviour_risk","Any behaviours of concern?")}
        ${input("risk_notes","Risk details (optional)",{placeholder:"Brief notes, dates, locations…"})}
        <div class="btn-row"><button class="btn ghost" id="back">Back</button><button class="btn primary" id="next">Next</button></div></div>`;
      $("#back",p).onclick=e=>{e.preventDefault(); go(3)}; $("#next",p).onclick=e=>{e.preventDefault(); go(5)};
      bindModel(p); bindYN3(p);
    }

    function rSupports(p){
      p.innerHTML = `<div class="block"><h2>Support from HD HeeD</h2>
        ${input("key_area","Key Area of Support Requested",{placeholder:"e.g., Community nursing; wound care; personal care; medication support"})}
        ${yn3("allergies","Any allergies?")}
        ${input("allergy_list","If yes, list allergies")}
        <div class="btn-row"><button class="btn ghost" id="back">Back</button><button class="btn primary" id="next">Next</button></div></div>`;
      $("#back",p).onclick=e=>{e.preventDefault(); go(4)}; $("#next",p).onclick=e=>{e.preventDefault(); go(6)};
      bindModel(p); bindYN3(p);
    }

    function rFunding(p){
      p.innerHTML = `<div class="block"><h2>Funding & Plan</h2>
        <div><label>How is your NDIS plan managed?</label>
          <div class="yn3">
            <button type="button" data-yn3="plan_managed" data-v="ndia"   aria-pressed="${state.plan_managed==='ndia'}">NDIA Managed</button>
            <button type="button" data-yn3="plan_managed" data-v="plan"   aria-pressed="${state.plan_managed==='plan'}">Plan Managed</button>
            <button type="button" data-yn3="plan_managed" data-v="self"   aria-pressed="${state.plan_managed==='self'}">Self Managed</button>
          </div>
        </div>
        ${input("funding_area","Funding Support Area")}
        ${input("postcode_lookup","Postcode/Suburb for Service Location")}
        <div class="btn-row"><button class="btn ghost" id="back">Back</button><button class="btn primary" id="next">Next</button></div></div>`;
      $("#back",p).onclick=e=>{e.preventDefault(); go(5)}; $("#next",p).onclick=e=>{e.preventDefault(); go(7)};
      bindModel(p); bindYN3(p);
    }

    function rGoals(p){
      const cat=`<option value="">Not sure / discuss later</option><option value="core">Core</option><option value="capacity">Capacity Building</option><option value="capital">Capital</option>`;
      p.innerHTML = `<div class="block"><h2>NDIS Goals</h2>
        <div class="grid two">${input("goal1","Goal 1")}${input("goal1_service","Goal 1 - Service Requested")}</div>
        <label>Support Category<select id="goal1_category">${cat}</select></label>
        <div class="grid two">${input("goal2","Goal 2")}${input("goal2_service","Goal 2 - Service Requested")}</div>
        <label>Support Category<select id="goal2_category">${cat}</select></label>
        <div class="grid two">${input("goal3","Goal 3")}${input("goal3_service","Goal 3 - Service Requested")}</div>
        <label>Support Category<select id="goal3_category">${cat}</select></label>
        <div class="grid two">${input("goal4","Goal 4")}${input("goal4_service","Goal 4 - Service Requested")}</div>
        <label>Support Category<select id="goal4_category">${cat}</select></label>
        ${input("current_services","Current Services Accessed")}
        ${input("previous_services","Previous Services Accessed")}
        <div class="btn-row"><button class="btn ghost" id="back">Back</button><button class="btn primary" id="next">Next</button></div></div>`;
      $("#back",p).onclick=e=>{e.preventDefault(); go(6)}; $("#next",p).onclick=e=>{e.preventDefault(); go(8)};
      bindModel(p);
    }

    function rReview(p){
      p.innerHTML = `<div class="block"><h2>Review & Final Consent</h2>
        <div class="review"><h3>Summary</h3><pre>${buildSummary()}</pre></div>
        <div><label><input id="referral_consent" type="checkbox" ${state.referral_consent?"checked":""}/> I confirm the person being referred has consented OR I selected "Not sure" and would like HD HeeD to discuss consent with me.</label></div>
        <div class="btn-row"><button class="btn ghost" id="back">Back</button><button class="btn primary" id="next">Looks good</button></div></div>`;
      $("#back",p).onclick=e=>{e.preventDefault(); go(7)};
      $("#next",p).onclick=e=>{e.preventDefault(); state.referral_consent = $("#referral_consent").checked; go(9); };
      bindModel(p);
    }

    function rSubmit(p){
      p.innerHTML = `<div class="block"><h2>Submit Referral</h2>
        <p class="muted">Submit online now, or download a formatted copy and email later. Nothing is mandatory.</p>
        <div class="btn-row">
          <button class="btn primary" id="submitOnline">Submit online</button>
          <button class="btn ghost" id="download">Download formatted report</button>
          <button class="btn danger" id="reset">Reset form</button>
        </div>
        <div class="hint" style="margin-top:10px">After submission, you'll be redirected to our thank-you page.</div>
        <div class="review" style="margin-top:12px"><h3>Preview</h3><pre>${buildSummary()}</pre></div></div>`;
      $("#submitOnline",p).onclick=submitOnline;
      $("#download",p).onclick=downloadReportHTML;
      $("#reset",p).onclick=()=>{ if(confirm("Clear all answers?")){ localStorage.removeItem(AUTOSAVE_KEY); location.reload(); } };
    }

    // === SUMMARY & SUBMIT ===
    function ynu(k){ return state[k]==="yes"?"Yes": state[k]==="no"?"No": state[k]==="unsure"?"Not sure": (state[k]||""); }
    function buildSummary(){
      const L=[];
      L.push(`Consent: ${ynu("consent")}`,"");
      L.push(`Referrer: ${state.referrer_name||""} (${state.relationship||""})`);
      L.push(`Contact: ${state.email||""}  Phone: ${state.phone||""}  Mobile: ${state.mobile||""}`,"");
      L.push(`Participant: ${state.participant_fname||""} ${state.participant_lname||""}  DOB: ${state.dob||""}  Title: ${state.title||""}`);
      L.push(`NDIS: ${state.ndis_number||""}  Gender: ${ynu("gender")}  Marital: ${state.marital_status||""}`);
      L.push(`Address: ${state.street||""}, ${state.suburb||""}, ${state.city||""} ${state.postcode||""}`);
      L.push(`Phone: ${state.home_phone||""}  Mobile: ${state.participant_mobile||""}  Email: ${state.participant_email||""}`);
      L.push(`Language: ${state.language||""}  Interpreter: ${ynu("interpreter")}  Type: ${state.interpreter_type||""}`,"");
      L.push(`Carer: ${state.carer_fname||""} ${state.carer_lname||""} (${state.carer_relationship||""})  Carer email: ${state.carer_email||""}`);
      L.push(`Custody/shared: ${ynu("custody")}`,"");
      L.push(`Safety – Fall:${ynu("recent_fall")}  Wound:${ynu("wound")}  Pain:${ynu("uncontrolled_pain")}  Pressure:${ynu("pressure_risk")}  Behaviour:${ynu("behaviour_risk")}`);
      if(state.risk_notes) L.push("Risk notes: "+state.risk_notes);
      L.push("");
      if(state.key_area) L.push("Key area: "+state.key_area);
      if(state.allergies) L.push("Allergies: "+ynu("allergies")+" "+(state.allergy_list||""));
      L.push("");
      L.push(`Plan managed: ${ynu("plan_managed")}  Funding notes: ${state.funding_area||""}`);
      if(state.postcode_lookup) L.push("Service location: "+state.postcode_lookup);
      L.push("");
      ["1","2","3","4"].forEach(n=>{
        if(state["goal"+n] || state["goal"+n+"_service"] || state["goal"+n+"_category"]){
          L.push(`Goal ${n}: ${state["goal"+n]||""} — ${state["goal"+n+"_service"]||""}  [${state["goal"+n+"_category"]||""}]`);
        }
      });
      if(state.current_services) L.push("Current services: "+state.current_services);
      if(state.previous_services) L.push("Previous services: "+state.previous_services);
      L.push("",`Final consent box ticked: ${state.referral_consent? "Yes":"No"}`);
      return L.join("\n");
    }

    // Hidden native form post (more reliable, no branding shown)
    function submitOnline(){
      const form = document.getElementById('silentPost');
      if(!form){ alert("Submit form not found."); return; }

      // Clean previously added dynamic inputs
      Array.from(form.querySelectorAll('input[name]:not([type=hidden]), textarea, select'))
           .forEach(el => el.remove());

      // Helper to add hidden inputs
      const add = (name, value) => {
        const i = document.createElement('input');
        i.type = 'hidden';
        i.name = name;
        i.value = value == null ? '' : String(value);
        form.appendChild(i);
      };

      form.querySelector('input[name="_subject"]').value =
        "New NDIS Referral – " + (state.participant_fname||"") + " " + (state.participant_lname||"");

      // Preserve your original field names
      const names=[
        "consent","referrer_name","relationship","phone","mobile","email",
        "participant_fname","participant_lname","title","dob","ndis_number","gender","marital_status",
        "street","suburb","city","postcode","home_phone","participant_mobile","participant_email",
        "language","interpreter","interpreter_type",
        "carer_fname","carer_lname","carer_relationship","carer_street","carer_suburb","carer_city","carer_postcode","carer_home","carer_mobile","carer_email","custody",
        "key_area",
        "goal1","goal1_service","goal1_category",
        "goal2","goal2_service","goal2_category",
        "goal3","goal3_service","goal3_category",
        "goal4","goal4_service","goal4_category",
        "current_services","previous_services","funding_area",
        "plan_managed","postcode_lookup","referral_consent"
      ];
      names.forEach(n=> add(n, state[n]));

      // Add readable summary
      add("summary", buildSummary());

      form.submit();
    }

    // Download a polished, sectioned HTML report (print to PDF if needed)
    function downloadReportHTML(){
      const esc = s => (s||"").toString().replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
      const ynuText = k => state[k]==="yes"?"Yes": state[k]==="no"?"No": state[k]==="unsure"?"Not sure": (state[k]||"");
      const sect = (title, rows) => `
        <section style="margin:18px 0;">
          <h2 style="margin:0 0 8px 0;border-bottom:1px solid #e5e7eb;padding-bottom:6px;color:#0f172a;">${esc(title)}</h2>
          <table style="width:100%;border-collapse:collapse;font:14px system-ui,Segoe UI,Roboto,Arial;">
            ${rows.map(([k,v])=>`
              <tr>
                <td style="padding:8px;border-bottom:1px solid #eee;color:#334155;width:32%">${esc(k)}</td>
                <td style="padding:8px;border-bottom:1px solid #eee;color:#0f172a">${esc(v)}</td>
              </tr>`).join('')}
          </table>
        </section>`;

      const html = `<!doctype html>
      <html><head><meta charset="utf-8"><title>HD HeeD Referral – ${esc(state.participant_fname||"")} ${esc(state.participant_lname||"")}</title></head>
      <body style="margin:0;background:#f6f7fb;padding:24px;">
      <div style="max-width:900px;margin:auto;background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:20px;">
        <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <h1 style="margin:0;color:#0f172a;font:600 20px system-ui,Segoe UI,Roboto,Arial;">HD HeeD – Referral Summary</h1>
          <div style="color:#64748b;font:13px system-ui;">Generated ${new Date().toLocaleString()}</div>
        </header>

        ${sect("Consent", [
          ["Consent status", ynuText("consent")],
          ["Final consent box", state.referral_consent ? "Ticked" : "Not ticked"]
        ])}

        ${sect("Person Making Referral", [
          ["Full name", state.referrer_name||""],
          ["Relationship", state.relationship||""],
          ["Email", state.email||""],
          ["Phone", state.phone||""],
          ["Mobile", state.mobile||""]
        ])}

        ${sect("Participant Details", [
          ["Name", (state.participant_fname||"")+" "+(state.participant_lname||"")],
          ["Title", state.title||""],
          ["DOB", state.dob||""],
          ["NDIS number", state.ndis_number||""],
          ["Gender", ynuText("gender")],
          ["Marital status", state.marital_status||""],
          ["Address", [state.street, state.suburb, state.city, state.postcode].filter(Boolean).join(", ")],
          ["Home phone", state.home_phone||""],
          ["Mobile", state.participant_mobile||""],
          ["Email", state.participant_email||""],
          ["Language", state.language||""],
          ["Interpreter required", ynuText("interpreter")],
          ["Interpreter type", state.interpreter_type||""]
        ])}

        ${sect("Primary Carer (NOK)", [
          ["Name", (state.carer_fname||"")+" "+(state.carer_lname||"")],
          ["Relationship", state.carer_relationship||""],
          ["Address", [state.carer_street, state.carer_suburb, state.carer_city, state.carer_postcode].filter(Boolean).join(", ")],
          ["Home phone", state.carer_home||""],
          ["Mobile", state.carer_mobile||""],
          ["Email", state.carer_email||""],
          ["Shared care / custody", ynuText("custody")]
        ])}

        ${sect("Safety & Risks", [
          ["Recent fall", ynuText("recent_fall")],
          ["Wound / post-op", ynuText("wound")],
          ["Uncontrolled pain", ynuText("uncontrolled_pain")],
          ["Pressure injury risk", ynuText("pressure_risk")],
          ["Behaviours of concern", ynuText("behaviour_risk")],
          ["Risk notes", state.risk_notes||""]
        ])}

        ${sect("Supports", [
          ["Key area of support", state.key_area||""],
          ["Allergies", ynuText("allergies") + (state.allergy_list? " – " + state.allergy_list : "")]
        ])}

        ${sect("Funding & Plan", [
          ["Plan management", ynuText("plan_managed")],
          ["Funding support area", state.funding_area||""],
          ["Service location", state.postcode_lookup||""]
        ])}

        ${sect("NDIS Goals", [
          ["Goal 1", (state.goal1||"") + (state.goal1_service? " — " + state.goal1_service : "") + (state.goal1_category? " ["+state.goal1_category+"]" : "")],
          ["Goal 2", (state.goal2||"") + (state.goal2_service? " — " + state.goal2_service : "") + (state.goal2_category? " ["+state.goal2_category+"]" : "")],
          ["Goal 3", (state.goal3||"") + (state.goal3_service? " — " + state.goal3_service : "") + (state.goal3_category? " ["+state.goal3_category+"]" : "")],
          ["Goal 4", (state.goal4||"") + (state.goal4_service? " — " + state.goal4_service : "") + (state.goal4_category? " ["+state.goal4_category+"]" : "")]
        ])}

        <footer style="margin-top:16px;color:#64748b;font:13px system-ui;">© HD HeeD</footer>
      </div></body></html>`;

      const blob = new Blob([html], {type:"text/html"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `HDHeeD_Referral_${Date.now()}.html`;
      a.click();
    }

    init();
  </script>
</body>
</html>
